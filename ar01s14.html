<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>14. &#20249;&#20276;&#31995;&#32479;</title><link rel="stylesheet" href="styles.css" type="text/css"><meta name="generator" content="DocBook XSL-NS Stylesheets V1.75.2"><link rel="home" href="index.html" title="Linux&#20869;&#26680;&#23398;&#20064;&#21644;&#30740;&#31350;&#21450;&#23884;&#20837;&#24335;(ARM)&#23398;&#20064;&#21644;&#30740;&#31350;&#30340;&#24320;&#25918;&#25991;&#26723;"><link rel="up" href="index.html" title="Linux&#20869;&#26680;&#23398;&#20064;&#21644;&#30740;&#31350;&#21450;&#23884;&#20837;&#24335;(ARM)&#23398;&#20064;&#21644;&#30740;&#31350;&#30340;&#24320;&#25918;&#25991;&#26723;"><link rel="prev" href="ar01s13.html" title="13. &#20869;&#23384;&#31649;&#29702;"><link rel="next" href="ar01s15.html" title="15. IO&#35774;&#22791;&#31649;&#29702;"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">14. &#20249;&#20276;&#31995;&#32479;</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ar01s13.html">&#19978;&#19968;&#39029;</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="ar01s15.html">&#19979;&#19968;&#39029;</a></td></tr></table><hr></div><div class="sect1" title="14. &#20249;&#20276;&#31995;&#32479;"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp81044556"></a>14. &#20249;&#20276;&#31995;&#32479;</h2></div></div></div>
&#26412;&#25991;&#22522;&#20110;&#20869;&#26680;3.0.1&#29256;&#26412;&#12290;
<div class="sect2" title="14.1. &#21021;&#22987;&#21270;zone"><div class="titlepage"><div><div><h3 class="title"><a name="idp81142372"></a>14.1. &#21021;&#22987;&#21270;zone</h3></div></div></div>
<pre class="programlisting">
start_kernel-&gt;start_arch-&gt;paging_init-&gt;bootmem_init-&gt;arm_bootmem_free-&gt;free_area_init_node
-&gt;free_area_init_core--&gt;set_pageblock_order
                     |-&gt;setup_usemap
                     `-&gt;init_currently_empty_zone-&gt;zone_init_free_lists
</pre>
&#30001;&#20110;&#20249;&#20276;&#31995;&#32479;&#22522;&#20110;Bootmem&#26426;&#21046;&#26469;&#20998;&#37197;&#19968;&#20123;&#24517;&#39035;&#30340;&#25968;&#25454;&#32467;&#26500;&#65292;&#24182;&#19988;&#20174;Bootmem&#36890;&#36807;&#20301;&#22270;&#31649;&#29702;&#30340;&#39029;&#38754;&#20013;&#25509;&#31649;&#25152;&#26377;&#31354;&#38386;&#26410;&#20998;&#37197;&#30340;&#20869;&#23384;&#65292;&#25152;&#20197;&#20249;&#20276;&#31995;&#32479;&#30340;&#21021;&#22987;&#21270;&#30456;&#20851;&#30340;&#21160;&#20316;&#37117;&#26159;&#24314;&#31435;&#22312;Bootmem&#26426;&#21046;&#19978;&#30340;&#12290;&#22312;Bootmem&#21021;&#22987;&#21270;&#30340;&#26202;&#20123;&#26102;&#20505;&#20250;&#35843;&#29992;free_area_init_node&#26469;&#23545;&#25152;&#26377;&#20869;&#23384;&#21306;&#23545;&#24212;&#30340;struct zone&#32467;&#26500;&#20307;&#36827;&#34892;&#21021;&#22987;&#21270;&#65292;&#20854;&#20013;&#21253;&#25324;&#20851;&#38190;&#30340;&#20249;&#20276;&#31995;&#32479;&#30340;&#26680;&#24515;&#65306;free_area&#32467;&#26500;&#20307;&#12290;
<pre class="programlisting">
include/linux/mmzone.h
#ifndef CONFIG_FORCE_MAX_ZONEORDER
#define MAX_ORDER 11
#else
#define MAX_ORDER CONFIG_FORCE_MAX_ZONEORDER
#endif
#define MAX_ORDER_NR_PAGES (1 &lt;&lt; (MAX_ORDER - 1))

struct zone {
	/* Fields commonly accessed by the page allocator */

	/* zone watermarks, access with *_wmark_pages(zone) macros */
	unsigned long watermark[NR_WMARK];
......
	spinlock_t		lock;
	struct free_area	free_area[MAX_ORDER];
......
	unsigned long		pages_scanned;	   /* since last reclaim */
	unsigned long		flags;		   /* zone flags, see below */

	/* Zone statistics */
	atomic_long_t		vm_stat[NR_VM_ZONE_STAT_ITEMS];
.....
} ____cacheline_internodealigned_in_smp;
</pre>
MAX_ORDER&#30340;&#20540;&#21487;&#20197;&#36890;&#36807;&#23450;&#20041;CONFIG_FORCE_MAX_ZONEORDER&#26469;&#35774;&#32622;&#65292;&#21542;&#21017;&#40664;&#35748;&#20540;&#20026;11&#65292;&#23427;&#30340;&#26377;&#25928;&#21462;&#20540;&#33539;&#22260;&#20026;[11,&#65292;64]&#65292;&#19981;&#21516;&#30340;&#20307;&#31995;&#26550;&#26500;&#65292;&#20854;&#40664;&#35748;&#20540;&#21487;&#33021;&#19981;&#21516;&#12290;&#23427;&#26159;&#20869;&#23384;&#22359;&#30340;&#38454;&#25968;&#65292;&#20915;&#23450;&#20102;free_area&#30340;&#20010;&#25968;&#65292;&#23427;&#20063;&#20915;&#23450;&#20102;&#20249;&#20276;&#31995;&#32479;&#20013;&#65292;&#26368;&#22823;&#20869;&#23384;&#22359;&#30340;&#39029;&#38754;&#25968;&#65306;2<sup>order-1</sup>&#65292;&#20063;&#21363;MAX_ORDER_NR_PAGES&#12290;free_area&#30340;&#19979;&#26631;&#19982;&#35813;&#38142;&#34920;&#20013;&#30340;&#20869;&#23384;&#22359;&#22823;&#23567;&#23384;&#22312;2&#30340;&#38454;&#30340;&#20851;&#31995;&#12290;&#20249;&#20276;&#31995;&#32479;&#23545;&#20110;free_area&#30340;&#32452;&#32455;&#22914;&#19979;&#22270;&#25152;&#31034;&#65306;
<div class="figure"><a name="idp81145468"></a><p class="title"><b>&#22270; 75. free_area&#32452;&#32455;&#22270;</b></p><div class="figure-contents"><div><img src="images/buddy/free_area.gif" alt="free_area&#32452;&#32455;&#22270;"></div></div></div><br class="figure-break">
nr_free&#25351;&#23450;&#20102;&#24403;&#21069;&#38454;&#30340;&#20869;&#23384;&#38142;&#34920;&#20013;&#31354;&#38386;&#39029;&#22359;&#30340;&#25968;&#30446;&#65292;&#23545;&#20110;0&#38454;&#20869;&#23384;&#21306;&#36880;&#39029;&#35745;&#31639;&#65292;&#23545;1&#38454;&#20869;&#23384;&#21306;&#35745;&#31639;&#21452;&#39029;&#30340;&#25968;&#30446;&#65292;&#20381;&#27425;&#31867;&#25512;&#12290;
<pre class="programlisting">
struct free_area {
	struct list_head	free_list[MIGRATE_TYPES];
	unsigned long		nr_free;
};
</pre>
<p>&#20026;&#20102;&#20943;&#23569;&#20869;&#23384;&#30862;&#29255;&#30340;&#20135;&#29983;&#65292;&#27599;&#19968;&#20010;free_area&#21448;&#20998;&#25104;&#20102;MIGRATE_TYPES&#20010;&#19981;&#21516;&#30340;&#38142;&#34920;&#12290;&#20869;&#26680;&#30862;&#29255;&#30340;&#20135;&#29983;&#22312;&#20110;&#19968;&#20010;&#23567;&#30340;&#20869;&#23384;&#22359;&#19968;&#26086;&#34987;&#20998;&#37197;&#20986;&#21435;&#65292;&#37027;&#20040;&#21407;&#26469;&#30340;&#22823;&#30340;&#20869;&#23384;&#22359;&#23601;&#35201;&#20998;&#35010;&#65292;&#21487;&#20379;&#20351;&#29992;&#30340;&#22823;&#20869;&#23384;&#22359;&#23601;&#35201;&#20943;&#23569;&#65292;&#32780;&#22823;&#20869;&#23384;&#24635;&#26159;&#33021;&#28385;&#36275;&#32473;&#31867;&#20869;&#23384;&#22359;&#30340;&#20998;&#37197;&#65292;&#32780;&#23567;&#20869;&#23384;&#22359;&#21364;&#19981;&#33021;&#65292;&#25152;&#20197;&#20249;&#20276;&#31995;&#32479;&#30340;&#39318;&#35201;&#30446;&#26631;&#23601;&#26159;&#21487;&#33021;&#30340;&#24773;&#20917;&#19979;&#23613;&#37327;&#20445;&#35777;&#22823;&#20869;&#23384;&#22359;&#30340;&#20010;&#25968;&#12290;&#21453;&#30862;&#29255;&#30340;&#24037;&#20316;&#21407;&#29702;&#26159;&#20160;&#20040;&#65311;
	</p>	
	<p>
&#20869;&#26680;&#23558;&#24050;&#20998;&#37197;&#39029;&#25110;&#20998;&#20026;&#22914;&#19979;3&#31181;&#19981;&#21516;&#31867;&#22411;&#65306;
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">&#19981;&#21487;&#31227;&#21160;&#39029;&#65306;&#22312;&#20869;&#23384;&#20013;&#26377;&#22266;&#23450;&#20301;&#32622;&#65292;&#19981;&#33021;&#31227;&#21160;&#21040;&#20854;&#20182;&#22320;&#26041;&#12290;&#20869;&#24515;&#20869;&#26680;&#20998;&#37197;&#30340;&#22823;&#22810;&#25968;&#20869;&#23384;&#23646;&#20110;&#35813;&#31867;&#22411;&#12290;</li><li class="listitem">&#21487;&#22238;&#25910;&#39029;&#65306;&#19981;&#33021;&#30452;&#25509;&#31227;&#21160;&#65292;&#20294;&#26159;&#21487;&#20197;&#21024;&#38500;&#65292;&#20854;&#20869;&#23481;&#21487;&#20197;&#20174;&#26576;&#20123;&#28304;&#37325;&#26032;&#29983;&#25104;&#12290;&#20363;&#22914;&#65292;&#26144;&#23556;&#33258;&#25991;&#20214;&#30340;&#25968;&#25454;&#23646;&#20110;&#35813;&#31867;&#22411;&#12290;kswapd&#23432;&#25252;&#20140;&#22478;&#20250;&#26681;&#25454;&#21487;&#22238;&#25910;&#39029;&#35775;&#38382;&#30340;&#39057;&#32321;&#31243;&#24230;&#65292;&#21608;&#26399;&#24615;&#37322;&#25918;&#27492;&#31867;&#20869;&#23384;&#12290;</li><li class="listitem">&#21487;&#31227;&#21160;&#39029;&#65292;&#21487;&#20197;&#38543;&#24847;&#22320;&#31227;&#21160;&#12290;&#23646;&#20110;&#29992;&#25143;&#31354;&#38388;&#24212;&#29992;&#31243;&#24207;&#30340;&#39029;&#23646;&#20110;&#35813;&#31867;&#22411;&#12290;&#23427;&#20204;&#26159;&#36890;&#36807;&#39029;&#34920;&#26144;&#23556;&#30340;&#12290;&#22914;&#26524;&#23427;&#20204;&#22797;&#21046;&#21040;&#26032;&#20301;&#32622;&#65292;&#39029;&#34920;&#39033;&#21487;&#20197;&#30456;&#24212;&#22320;&#26356;&#26032;&#65292;&#24212;&#29992;&#31243;&#24207;&#19981;&#20250;&#27880;&#24847;&#21040;&#20219;&#20309;&#20107;&#24773;&#12290;</li></ul></div><p>
</p><pre class="programlisting">
#define MIGRATE_UNMOVABLE     0 /* &#19981;&#21487;&#31227;&#21160;&#39029;&#38754; */
#define MIGRATE_RECLAIMABLE   1 /* &#21487;&#22238;&#25910;&#39029;&#38754; */
#define MIGRATE_MOVABLE       2 /* &#21487;&#31227;&#21160;&#39029;&#38754; */
#define MIGRATE_PCPTYPES      3 /* the number of types on the pcp lists */
#define MIGRATE_RESERVE       3 /* &#20445;&#30041;&#39029;&#38754; */
#define MIGRATE_ISOLATE       4 /* can't allocate from here */
#define MIGRATE_TYPES         5
</pre><p>
&#20869;&#26680;&#20351;&#29992;&#30340;&#21453;&#30862;&#29255;&#25216;&#26415;&#65292;&#21363;&#22522;&#20110;&#23558;&#20855;&#26377;&#30456;&#21516;&#21487;&#31227;&#21160;&#24615;&#30340;&#39029;&#20998;&#32452;&#30340;&#24605;&#24819;&#65292;&#36825;&#26679;&#30862;&#29255;&#38598;&#20013;&#22312;&#19981;&#21487;&#31227;&#21160;&#39029;&#30340;&#20869;&#23384;&#22359;&#19978;&#65292;&#32780;&#19981;&#20250;&#25193;&#25955;&#12290;&#21478;&#22806;&#65292;&#22914;&#26524;&#20174;&#20855;&#26377;&#21487;&#31227;&#21160;&#24615;&#30340;&#39029;&#38754;&#20998;&#37197;&#20869;&#23384;&#22833;&#36133;&#65292;&#32039;&#24613;&#24773;&#20917;&#19979;&#21487;&#20197;&#20174;&#20445;&#30041;&#39029;&#38754;&#20998;&#37197;&#12290;MIGRATE_ISOLATE&#29992;&#20110;&#25193;&#26376;NUMA&#33410;&#28857;&#31227;&#21160;&#29289;&#29702;&#20869;&#23384;&#39029;&#12290;
</p><pre class="programlisting">
#define for_each_migratetype_order(order, type) \
	for (order = 0; order &lt; MAX_ORDER; order++) \
		for (type = 0; type &lt; MIGRATE_TYPES; type++)
		
static void __meminit zone_init_free_lists(struct zone *zone)
{
	int order, t;
	for_each_migratetype_order(order, t) {
		INIT_LIST_HEAD(&amp;zone-&gt;free_area[order].free_list[t]);
		zone-&gt;free_area[order].nr_free = 0;
	}
}
</pre><p>
&#21021;&#22987;&#21270;&#21487;&#20998;&#37197;&#20869;&#23384;&#21306;&#30340;&#31649;&#29702;&#38142;&#34920;&#25968;&#32452;free_area&#30340;&#20989;&#25968;&#65292;&#38750;&#24120;&#31616;&#21333;&#65292;&#24182;&#19988;&#23545;&#20110;&#36941;&#21382;&#35813;&#25968;&#32452;&#20197;&#21450;&#20854;&#20013;&#30340;&#25152;&#26377;&#38142;&#34920;&#25552;&#20379;&#20102;&#19968;&#20010;&#31616;&#20415;&#30340;&#23439;for_each_migratetype_order&#12290;
</p>
<div class="sect3" title="14.1.1. setup_usemap"><div class="titlepage"><div><div><h4 class="title"><a name="idp81151252"></a>14.1.1. setup_usemap</h4></div></div></div>

</div>
</div>
<div class="sect2" title="14.2. &#25910;&#38598;&#31354;&#38386;&#20869;&#23384;"><div class="titlepage"><div><div><h3 class="title"><a name="idp81151676"></a>14.2. &#25910;&#38598;&#31354;&#38386;&#20869;&#23384;</h3></div></div></div>
<pre class="programlisting">
start_kernel-&gt;mm_init-&gt;mem_init--&gt;free_unused_memmap
                               |-&gt;free_all_bootmem-&gt;free_all_bootmem_core
                               |-&gt;free_highpages (CONFIG_HIGHMEM)
                               |-&gt;for_each_bank-&gt;PageReserved
                               `-&gt;for_each_memblock-&gt;printk(KERN_INFO "Memory:")
</pre>
free_all_bootmem&#29992;&#26469;&#37322;&#25918;&#24403;&#21069;Bootmem&#26426;&#21046;&#31649;&#29702;&#30340;&#24403;&#21069;&#20869;&#23384;&#21306;zone&#20013;&#30340;node_bootmem_map&#26410;&#26631;&#35760;&#20026;1&#30340;&#39029;&#38754;&#65292;&#21363;&#23558;&#35813;&#39029;&#38754;&#23545;&#24212;&#30340;struct page&#20013;&#30340;flags&#28165;0&#65292;&#23545;&#35813;&#39029;&#38754;&#30340;&#24341;&#29992;&#35745;&#25968;_count&#20063;&#34987;&#28165;0&#12290;
<pre class="programlisting">
/*
 * This function checks whether a page is free &amp;&amp; is the buddy
 * we can do coalesce a page and its buddy if
 * (a) the buddy is not in a hole &amp;&amp;
 * (b) the buddy is in the buddy system &amp;&amp;
 * (c) a page and its buddy have the same order &amp;&amp;
 * (d) a page and its buddy are in the same zone.
 *
 * For recording whether a page is in the buddy system, we set -&gt;_mapcount -2.
 * Setting, clearing, and testing _mapcount -2 is serialized by zone-&gt;lock.
 *
 * For recording page's order, we use page_private(page).
 */
static inline int page_is_buddy(struct page *page, struct page *buddy,
								int order)
{
	if (!pfn_valid_within(page_to_pfn(buddy)))
		return 0;

	if (page_zone_id(page) != page_zone_id(buddy))
		return 0;

	if (PageBuddy(buddy) &amp;&amp; page_order(buddy) == order) {
		VM_BUG_ON(page_count(buddy) != 0);
		return 1;
	}
	return 0;
}
</pre>
</div>
<div class="sect2" title="14.3. vmalloc"><div class="titlepage"><div><div><h3 class="title"><a name="idp81154108"></a>14.3. vmalloc</h3></div></div></div>
vmalloc&#19982;kmalloc&#21644;&#20249;&#20276;&#31995;&#32479;&#30340;&#20851;&#31995;&#22914;&#19979;&#22270;&#25152;&#31034;&#65306;
<div class="figure"><a name="idp81154588"></a><p class="title"><b>&#22270; 76. vmalloc&#21644;kmalloc&#65292;&#20249;&#20276;&#31995;&#32479;&#20851;&#31995;&#22270;</b></p><div class="figure-contents"><div><img src="images/buddy/vmalloc.gif" alt="vmalloc&#21644;kmalloc&#65292;&#20249;&#20276;&#31995;&#32479;&#20851;&#31995;&#22270;"></div></div></div><br class="figure-break">
<pre class="programlisting">
struct vm_struct {
	struct vm_struct	*next;
	void			*addr;
	unsigned long		size;
	unsigned long		flags;
	struct page		**pages;
	unsigned int		nr_pages;
	phys_addr_t		phys_addr;
	void			*caller;
};
</pre>
vmalloc&#29992;&#26469;&#20998;&#37197;&#29289;&#29702;&#19978;&#19981;&#36830;&#32493;&#30340;&#39029;&#38754;&#20869;&#23384;&#65292;&#20351;&#20854;&#22312;&#36923;&#36753;&#22320;&#22336;&#19978;&#19968;&#33268;&#12290;vm_struct&#26159;&#20854;&#26680;&#24515;&#32467;&#26500;&#65292;pages&#26159;&#19968;&#20010;&#25968;&#32452;&#25351;&#38024;&#65292;&#25968;&#32452;&#30340;&#20803;&#32032;&#25351;&#21521;&#20998;&#37197;&#30340;&#31163;&#25955;&#30340;&#29289;&#29702;&#39029;&#24103;&#23545;&#24212;&#30340;struct page	*&#32467;&#26500;&#12290;
<pre class="programlisting">
static void *__vmalloc_area_node(struct vm_struct *area, gfp_t gfp_mask,
				 pgprot_t prot, int node, void *caller)
{
	......
	nr_pages = (area-&gt;size - PAGE_SIZE) &gt;&gt; PAGE_SHIFT;
	array_size = (nr_pages * sizeof(struct page *));

	area-&gt;nr_pages = nr_pages;
	/* Please note that the recursion is strictly bounded. */
	if (array_size &gt; PAGE_SIZE) {
		pages = __vmalloc_node(array_size, 1, nested_gfp|__GFP_HIGHMEM,
				PAGE_KERNEL, node, caller);
		area-&gt;flags |= VM_VPAGES;
	} else {
		pages = kmalloc_node(array_size, nested_gfp, node);
	}
	area-&gt;pages = pages;
	......	
</pre>
vmalloc&#30340;&#26680;&#24515;&#20989;&#25968;&#20026;__vmalloc_area_node&#65292;&#20854;&#20013;&#23558;&#26681;&#25454;&#20998;&#37197;&#30340;&#39029;&#38754;&#22823;&#23567;&#65292;&#22914;&#26524;pages&#25351;&#21521;&#30340;&#25968;&#32452;&#22823;&#23567;&#36229;&#36807;&#19968;&#20010;&#39029;&#38754;&#22823;&#23567;&#65292;&#21017;&#36890;&#36807;__vmalloc_node&#36882;&#24402;&#35843;&#29992;&#26412;&#20989;&#25968;&#26469;&#20998;&#37197;&#25351;&#38024;&#25968;&#32452;&#65292;&#21542;&#21017;&#23558;&#36890;&#36807;kmalloc&#31995;&#32479;&#20013;&#30340;kmalloc_node&#20989;&#25968;&#26469;&#20998;&#37197;&#12290;&#32780;&#38024;&#23545;&#39029;&#38754;&#30340;&#20998;&#37197;&#22343;&#26159;&#36890;&#36807;&#20249;&#20276;&#31995;&#32479;&#26469;&#23454;&#29616;&#30340;&#65306;
<pre class="programlisting">
	for (i = 0; i &lt; area-&gt;nr_pages; i++) {
		struct page *page;
		gfp_t tmp_mask = gfp_mask | __GFP_NOWARN;

		if (node &lt; 0)
			page = alloc_page(tmp_mask);
		else
			page = alloc_pages_node(node, tmp_mask, order);

		if (unlikely(!page)) {
			/* Successfully allocated i pages, free them in __vunmap() */
			area-&gt;nr_pages = i;
			goto fail;
		}
		area-&gt;pages[i] = page;
	}
</pre>
alloc_page&#21644;alloc_pages_node&#22343;&#26159;&#20249;&#20276;&#31995;&#32479;&#25552;&#20379;&#30340;&#25509;&#21475;&#20989;&#25968;&#65292;&#30001;&#27492;&#21487;&#20197;&#30475;&#20986;vmalloc&#21644;kmalloc&#65292;&#20249;&#20276;&#31995;&#32479;&#20851;&#31995;&#22270;&#30340;&#30001;&#26469;&#12290;
<div class="sect3" title="14.3.1. &#39029;&#34920;&#26144;&#23556;"><div class="titlepage"><div><div><h4 class="title"><a name="idp81158132"></a>14.3.1. &#39029;&#34920;&#26144;&#23556;</h4></div></div></div>

</div>
<span class="emphasis"><em>&#26412;&#25991;&#27491;&#22312;&#26356;&#26032;&#20013;......</em></span>
</div>
</div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ar01s13.html">&#19978;&#19968;&#39029;</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="ar01s15.html">&#19979;&#19968;&#39029;</a></td></tr><tr><td width="40%" align="left" valign="top">13. &#20869;&#23384;&#31649;&#29702; </td><td width="20%" align="center"><a accesskey="h" href="index.html">&#36215;&#22987;&#39029;</a></td><td width="40%" align="right" valign="top"> 15. IO&#35774;&#22791;&#31649;&#29702;</td></tr></table></div></body></html>
