<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>8. &#20869;&#26680;&#21152;&#36733;</title><link rel="stylesheet" href="styles.css" type="text/css"><meta name="generator" content="DocBook XSL-NS Stylesheets V1.75.2"><link rel="home" href="index.html" title="Linux&#20869;&#26680;&#23398;&#20064;&#21644;&#30740;&#31350;&#21450;&#23884;&#20837;&#24335;(ARM)&#23398;&#20064;&#21644;&#30740;&#31350;&#30340;&#24320;&#25918;&#25991;&#26723;"><link rel="up" href="index.html" title="Linux&#20869;&#26680;&#23398;&#20064;&#21644;&#30740;&#31350;&#21450;&#23884;&#20837;&#24335;(ARM)&#23398;&#20064;&#21644;&#30740;&#31350;&#30340;&#24320;&#25918;&#25991;&#26723;"><link rel="prev" href="ar01s07.html" title="7. zImage&#30340;&#29983;&#25104;&#21644;&#21152;&#36733;"><link rel="next" href="ar01s09.html" title="9. &#20869;&#26680;&#21021;&#22987;&#21270;"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">8. &#20869;&#26680;&#21152;&#36733;</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ar01s07.html">&#19978;&#19968;&#39029;</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="ar01s09.html">&#19979;&#19968;&#39029;</a></td></tr></table><hr></div><div class="sect1" title="8. &#20869;&#26680;&#21152;&#36733;"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp80413108"></a>8. &#20869;&#26680;&#21152;&#36733;</h2></div></div></div>
<div class="sect2" title="8.1. head.S"><div class="titlepage"><div><div><h3 class="title"><a name="idp80537340"></a>8.1. head.S</h3></div></div></div>
	<p>
&#36825;&#37324;&#30340;head.S&#26159;&#30495;&#27491;&#20869;&#26680;&#21551;&#21160;&#30340;&#20195;&#30721;&#65292;&#22914;&#26524;&#26159;&#36890;&#36807;Image&#32780;&#38750;&#21387;&#32553;&#36807;&#30340;zImage&#65292;&#37027;&#20040;&#23427;&#23601;&#34987;&#23433;&#25490;&#22312;Image&#30340;&#38646;&#22320;&#22336;&#22788;&#12290;head.S&#20301;&#20110;arch/arm/kernel/&#19979;&#12290;&#22914;&#26524;&#35201;&#20102;&#35299;&#20869;&#26680;&#25991;&#20214;&#26159;&#22914;&#20309;&#32452;&#32455;&#30340;&#12290;&#23427;&#26159;&#30001;vmlinux ELF&#25991;&#20214;&#32463;&#36807;objcopy&#21435;&#25481;ELF&#22836;&#31561;&#20449;&#24687;&#30340;&#21407;&#22987;&#20108;&#36827;&#21046;&#25991;&#20214;&#12290;&#32780;vmlinux&#25991;&#20214;&#21448;&#26159;&#26681;&#25454;arch/arm/kernel/vmlinux.lds&#33050;&#26412;&#38142;&#25509;&#32780;&#25104;&#65306;
</p><pre class="programlisting">
OUTPUT_ARCH(arm)
ENTRY(stext)
jiffies = jiffies_64;
SECTIONS
{
 . = 0xC0000000 + 0x00008000;
 .text.head : {
  _stext = .;
  _sinittext = .;
  *(.text.head)
 }
 .init : { /* Init code and data                */
   *(.init.text) *(.cpuinit.text) *(.meminit.text)
......
</pre><p>	
&#21487;&#20197;&#30475;&#21040;&#20869;&#26680;&#30340;&#36215;&#22987;&#22320;&#22336;&#20301;&#20110;0xC0000000 + 0x00008000&#65292;&#20063;&#21363;&#36890;&#24120;&#30340;3G&#34394;&#25311;&#22320;&#22336;&#30340;0x8000&#20559;&#31227;&#22788;&#12290;ENTRY(stext)&#25351;&#26126;&#20102;&#31243;&#24207;&#30340;&#20837;&#21475;&#28857;&#23376;&#31243;&#24207;&#21517;&#65292;&#24320;&#22987;&#30340;&#27573;&#21517;&#20026;.text.head&#65292;&#32780;head.S&#20013;&#23601;&#26377;&#21517;&#20026;.text.head&#30340;&#27573;&#65292;&#24182;&#19988;&#22312;&#38142;&#25509;&#20013;&#19982;&#23427;&#23545;&#24212;&#30340;&#30446;&#26631;&#25991;&#20214;.o&#34987;&#23433;&#25490;&#22312;&#31532;&#19968;&#20010;&#65292;&#24182;&#19988;&#23427;&#20301;&#20110;ENTRY(stext)&#23376;&#31243;&#24207;&#20013;&#12290;
</p><pre class="programlisting">
	.section ".text.head", "ax"
ENTRY(stext)
	msr	cpsr_c, #PSR_F_BIT | PSR_I_BIT | SVC_MODE @ ensure svc mode
						@ and irqs disabled
	mrc	p15, 0, r9, c0, c0		@ get processor id
	bl	__lookup_processor_type		@ r5=procinfo r9=cpuid
	movs	r10, r5				@ invalid processor (r5=0)?
	beq	__error_p			@ yes, error 'p'
	bl	__lookup_machine_type		@ r5=machinfo
	movs	r8, r5				@ invalid machine (r5=0)?
	beq	__error_a			@ yes, error 'a'
	bl	__vet_atags
	bl	__create_page_tables	
</pre><p>
&#22312;zImage&#35299;&#21387;&#21518;&#30340;&#26368;&#21518;&#36339;&#36716;&#25351;&#20196;&#23433;&#25490;&#20102;&#19977;&#20010;&#21442;&#25968;&#65292;&#24182;&#36339;&#36716;&#21040;&#27492;&#22788;.text.hea&#27573;&#30340;&#31532;&#19968;&#34892;&#20195;&#30721;&#36827;&#34892;&#25191;&#34892;&#12290;&#27880;&#24847;&#27492;&#26102;&#24037;&#20316;&#22312;&#23454;&#27169;&#24335;&#65292;&#24182;&#19988;&#36215;&#22987;&#22320;&#22336;&#20026;0x50008000&#12290;&#39318;&#20808;msr&#25351;&#20196;&#30830;&#20445;&#36827;&#20837;&#29305;&#26435;&#27169;&#24335;&#24182;&#20851;&#20013;&#26029;&#12290;
&#25509;&#30528;&#36890;&#36807;&#21327;&#22788;&#29702;&#22120;CP15&#33719;&#21462;&#22788;&#29702;&#22120;ID&#23384;&#20837;r9&#65292;&#24182;&#36890;&#36807;__lookup_processor_type&#23547;&#25214;CPU&#31867;&#22411;&#26597;&#25214;&#26426;&#22120;&#20449;&#24687;&#12290;
</p>
</div>
<div class="sect2" title="8.2. &#26816;&#26597;&#22788;&#29702;&#22120;&#31867;&#22411;"><div class="titlepage"><div><div><h3 class="title"><a name="idp80538668"></a>8.2. &#26816;&#26597;&#22788;&#29702;&#22120;&#31867;&#22411;</h3></div></div></div>
<p>
__lookup_processor_type&#34987;&#23450;&#20041;&#22312;head-common.S&#20013;&#12290;
</p><pre class="programlisting">
/*	r9 = cpuid
 * Returns:
 *	r3, r4, r6 corrupted
 *	r5 = proc_info pointer in physical address space
 *	r9 = cpuid (preserved)
 */
__lookup_processor_type:
	adr	r3, 3f
	ldmda	r3, {r5 - r7}
	sub	r3, r3, r7			@ get offset between virt&amp;phys
	add	r5, r5, r3			@ convert virt addresses to
	add	r6, r6, r3			@ physical address space
1:	ldmia	r5, {r3, r4}			@ value, mask
	and	r4, r4, r9			@ mask wanted bits
	teq	r3, r4
	beq	2f
	add	r5, r5, #PROC_INFO_SZ		@ sizeof(proc_info_list)
	cmp	r5, r6
	blo	1b
	mov	r5, #0				@ unknown processor
2:	mov	pc, lr
ENDPROC(__lookup_processor_type)
......
	.long	__proc_info_begin
	.long	__proc_info_end
3:	.long	.
	.long	__arch_info_begin
	.long	__arch_info_end
</pre><p>
&#23376;&#31243;&#24207;&#22788;&#29702;&#21069;&#65292;r9&#20013;&#23384;&#25918;&#20102;&#20174;&#21327;&#22788;&#29702;&#22120;CP15&#33719;&#21462;&#30340;&#23492;&#23384;&#22120;C0&#30340;&#20540;&#65292;&#20854;&#20013;&#21253;&#21547;&#20102;&#22788;&#29702;&#22120;ID&#65292;&#36890;&#36807;&#25513;&#30721;&#21487;&#20197;&#35745;&#31639;&#20986;ID&#12290;&#22788;&#29702;&#36807;&#31243;&#20013;&#23558;&#21344;&#29992;r3,r4&#21644;r6&#23492;&#23384;&#22120;&#12290;__lookup_processor_type &#20989;&#25968;&#20027;&#35201;&#26159;&#26681;&#25454;&#20174;cpu&#20013;&#33719;&#24471;&#30340;CPU ID&#21644;&#31995;&#32479;&#20013;&#30340;proc_info&#36827;&#34892;&#21305;&#37197;&#65292;&#23558;&#21305;&#37197;&#21040;&#30340;proc_info_list&#30340;&#22522;&#22320;&#22336;&#23384;&#21040;r5&#20013;, 0&#34920;&#31034;&#27809;&#26377;&#25214;&#21040;&#23545;&#24212;&#30340;CPU&#31867;&#22411;&#12290;
&#30001;&#20110;&#24403;&#21069;MMU&#20851;&#38381;&#65292;&#36816;&#34892;&#22312;&#23454;&#27169;&#24335;&#65292;&#25152;&#20197;&#19981;&#33021;&#20351;&#29992;&#32477;&#23545;&#22320;&#22336;&#26469;&#30452;&#25509;&#25805;&#20316;proc_info_list&#38142;&#34920;&#65292;&#38656;&#35201;&#36827;&#34892;&#22320;&#22336;&#30340;&#35843;&#25972;&#12290;adr r3,3f&#26159;&#23558;&#21518;&#38754;&#26631;&#31614;&#20026;3&#30340;&#22320;&#22336;&#23384;&#20648;&#21040;r3&#12290;&#23545;&#24212;&#30340;&#21453;&#27719;&#32534;&#20195;&#30721;&#22914;&#19979;&#65306;
</p><pre class="programlisting">
......
c0008344:       c0021e88        .word   0xc0021e88
c0008348:       c0021ebc        .word   0xc0021ebc
c000834c:       c000834c        .word   0xc000834c
c0008350:       c0021ebc        .word   0xc0021ebc
c0008354:       c0021ef0        .word   0xc0021ef0
</pre><p>
&#26174;&#28982;&#26631;&#31614;3&#23545;&#24212;c000834c&#22320;&#22336;&#65292;&#25509;&#19979;&#26469;&#30340;ldmda&#23558;0xc0021e88&#65292;0xc0021ebc&#21644;0xc0008344&#23545;&#24212;&#30340;&#20540;&#20998;&#21035;&#21152;&#36733;&#21040;r5-r7&#65292;&#20063;&#21363;&#27492;&#26102;r7&#20026;0xc000834c&#65292;r5&#21644;r6&#20998;&#21035;&#23545;&#24212;&#20102;__proc_info_begin&#21644;__proc_info_end&#20195;&#34920;&#30340;&#22320;&#22336;&#12290;sub	r3, r3, r7&#26159;&#38750;&#24120;&#20851;&#38190;&#30340;&#19968;&#21477;&#65292;r3&#27492;&#26102;&#23384;&#20648;&#30340;&#26159;&#23454;&#38469;&#30340;&#29289;&#29702;&#22320;&#22336;&#65292;&#32780;r7&#21017;&#26159;&#26631;&#31614;3&#25152;&#22312;&#34394;&#25311;&#22320;&#22336;0xc000834c&#12290;sub&#24471;&#21040;&#20102;&#34394;&#25311;&#22320;&#22336;&#19982;&#29289;&#29702;&#22320;&#22336;&#20043;&#38388;&#30340;&#24046;&#20540;&#65292;&#28982;&#21518;&#20351;&#29992;&#23427;&#26469;&#35843;&#25972;&#25152;&#26377;r5&#21644;r6&#30340;&#34394;&#25311;&#22320;&#22336;&#21040;&#29289;&#29702;&#22320;&#22336;&#12290;&#20063;&#21363;&#35843;&#25972;&#21518;r5&#21644;r6&#20998;&#21035;&#23545;&#24212;&#20102;__proc_info_begin&#21644;__proc_info_end&#30340;&#23454;&#38469;&#21152;&#36733;&#22320;&#22336;&#12290;&#20026;&#20102;&#29702;&#35299;ldmia&#35821;&#21477;&#65292;&#35201;&#39318;&#20808;&#20998;&#26512;&#19968;&#19979;__proc_info_begin&#21644;__proc_info_end&#21253;&#21547;&#30340;&#20869;&#23481;&#12290;
</p><pre class="programlisting">
  __proc_info_begin = .;
   *(.proc.info.init)
  __proc_info_end = .;
</pre><p>
&#25152;&#26377;&#30340;CPU&#31867;&#22411;&#22343;&#34987;__proc_info_begin&#21644;__proc_info_end&#31526;&#21495;&#24341;&#29992;&#21040;vmlinux&#20013;&#65292;&#23427;&#20204;&#22312;vmlinux.lds&#20013;&#23450;&#20041;&#12290;&#26174;&#28982;&#25152;&#26377;&#30340;.proc.info.init&#27573;&#34987;&#24341;&#29992;&#21040;&#36825;&#37324;&#65292;&#23427;&#20204;&#22343;&#22312;arch/arm/mm/proc-xxx.S&#20013;&#23450;&#20041;&#12290;&#32780;xxx&#26159;&#30001;&#20869;&#26680;.config&#20013;&#30340;CONFIG_CPU_XXX&#20915;&#23450;&#30340;&#12290;&#26597;&#30475;&#35813;&#25991;&#20214;&#22841;&#19979;&#30340;Makefile&#21487;&#20197;&#24471;&#21040;&#65306;
</p><pre class="programlisting">
......
obj-$(CONFIG_CPU_V6)            += proc-v6.o
obj-$(CONFIG_CPU_V7)            += proc-v7.o
......
</pre><p>
S3C6410&#23450;&#20041;&#20102;CONFIG_CPU_V6&#65292;&#25152;&#20197;&#26597;&#30475;proc-v6.S&#20013;&#30340;.proc.info.init&#27573;&#30340;&#23450;&#20041;&#65306;
</p><pre class="programlisting">
        .section ".proc.info.init", #alloc, #execinstr

        /*
         * Match any ARMv6 processor core.
         */
        .type   __v6_proc_info, #object
__v6_proc_info:
        .long   0x0007b000
        .long   0x0007f000
        .long   PMD_TYPE_SECT | \
                PMD_SECT_BUFFERABLE | \
                PMD_SECT_CACHEABLE | \
                PMD_SECT_AP_WRITE | \
                PMD_SECT_AP_READ
        ......
        .size   __v6_proc_info, . - __v6_proc_info
</pre><p>
&#23427;&#23545;&#24212;&#21040;&#32467;&#26500;&#20307;struct proc_info_list&#65292;&#23450;&#20041;&#22312;arch/arm/include/asm/procinfo.h&#20013;&#65306;
</p><pre class="programlisting">
struct proc_info_list {
        unsigned int            cpu_val;
        unsigned int            cpu_mask;
        unsigned long           __cpu_mm_mmu_flags;     /* used by head.S */
        unsigned long           __cpu_io_mmu_flags;     /* used by head.S */
        unsigned long           __cpu_flush;            /* used by head.S */
        const char              *arch_name;
        const char              *elf_name;
        unsigned int            elf_hwcap;
        const char              *cpu_name;
        struct processor        *proc;
        struct cpu_tlb_fns      *tlb;
        struct cpu_user_fns     *user;
        struct cpu_cache_fns    *cache;
};
</pre><p>
&#21040;&#20102;&#36825;&#37324;ldmia	r5, {r3, r4}&#36825;&#21477;&#23601;&#26159;&#23558;__v6_proc_info&#20013;&#30340;0x0007b000&#21644;0x0007f000&#20998;&#21035;&#21152;&#36733;&#21040;r3&#21644;r4&#65292;&#20998;&#21035;&#20195;&#34920;&#20102;ID&#21644;&#25513;&#30721;&#12290;and	r4, r4, r9&#29992;&#25513;&#30721;&#26469;&#35745;&#31639;&#20986;ID&#65292;&#24182;&#36890;&#36807;teq	r3, r4&#36827;&#34892;&#27604;&#36739;&#12290;&#19968;&#26086;&#21305;&#37197;&#23601;&#36890;&#36807;beq	2f&#36339;&#36716;&#21040;&#21518;&#38754;&#30340;&#26631;&#31614;2&#65292;&#36825;&#37324;&#26159;&#19968;&#20010;&#36820;&#22238;&#35821;&#21477;mov	pc, lr&#12290;&#22914;&#26524;&#27809;&#26377;&#25214;&#21040;&#65292;&#37027;&#20040;r5&#20013;&#30340;&#20540;&#32622;0&#12290;&#36820;&#22238;&#21518;&#30340;&#25351;&#20196;&#20026;movs	r10, r5	&#21644;beq	__error_p&#21028;&#26029;r5&#26159;&#21542;&#20026;0&#65292;&#22914;&#26524;&#26159;&#35828;&#26126;&#26159;&#26080;&#25928;&#30340;processor type&#65292;&#36339;&#36716;&#21040;__error_p&#36827;&#34892;&#20986;&#38169;&#22788;&#29702;&#12290;
</p>
</div>
<div class="sect2" title="8.3. &#26816;&#26597;&#26426;&#22120;&#31867;&#22411;"><div class="titlepage"><div><div><h3 class="title"><a name="mach_type"></a>8.3. &#26816;&#26597;&#26426;&#22120;&#31867;&#22411;</h3></div></div></div>
<p>
__lookup_machine_type&#21033;&#29992;bootloader&#20256;&#36827;&#26469;&#30340;&#21442;&#25968;&#20381;&#27425;&#26597;&#35810;&#32467;&#26500;&#34920;&#39033;struct machine_desc xxx&#65292;
&#36825;&#20010;&#34920;&#39033;&#26159;&#22312;&#32534;&#35793;&#38454;&#27573;&#23558;#define MACHINE_START(_type,_name)&#23439;&#23450;&#20041;&#30340;&#32467;&#26500;&#20307;struct machine_desc&#20301;&#20110;__arch_info_begin&#21644;__arch_info_end&#21253;&#21547;&#30340;.arch.info.init&#27573;&#12290;
</p><pre class="programlisting">
  __arch_info_begin = .;
   *(.arch.info.init)
  __arch_info_end = .;
</pre><p>
&#23545;&#24212;&#30340;.arch.info.init&#27573;&#23450;&#20041;&#22312;arch/arm/include/asm/mach/arch.h&#20013;&#12290;
</p><pre class="programlisting">
/*
 * Set of macros to define architecture features.  This is built into
 * a table by the linker.
 */
#define MACHINE_START(_type,_name)                      \
static const struct machine_desc __mach_desc_##_type    \
 __used                                                 \
 __attribute__((__section__(".arch.info.init"))) = {    \
        .nr             = MACH_TYPE_##_type,            \
        .name           = _name,
#define MACHINE_END                             \
};
</pre><p>	
struct machine_desc&#21017;&#34987;&#23450;&#20041;&#22312;&#30456;&#21516;&#25991;&#20214;&#20013;:
</p><pre class="programlisting">
struct machine_desc {
        /*
         * Note! The first four elements are used
         * by assembler code in head.S, head-common.S
         */
        unsigned int            nr;             /* architecture number  */
        unsigned int            phys_io;        /* start of physical io */
        unsigned int            io_pg_offst;    /* byte offset for io 
                                                * page tabe entry      */
        const char              *name;          /* architecture name    */
        unsigned long           boot_params;    /* tagged list          */
				......
};
</pre><p>
&#23454;&#38469;&#30340;&#26426;&#22120;&#26550;&#26500;&#21017;&#20301;&#20110;arch/arm/mach-xxx/mach-smdkxxx.c&#20013;&#65292;&#23545;&#20110;s3c6410&#20301;&#20110;arch/arm/mach-s3c6410/mach-smdk6410.c&#20013;&#65306;
</p><pre class="programlisting">
MACHINE_START(SMDK6410, "SMDK6410")
        /* Maintainer: Ben Dooks &lt;ben@fluff.org&gt; */
        .phys_io        = S3C_PA_UART &amp; 0xfff00000,
        .io_pg_offst    = (((u32)S3C_VA_UART) &gt;&gt; 18) &amp; 0xfffc,
        .boot_params    = S3C64XX_PA_SDRAM + 0x100, 

        .init_irq       = s3c6410_init_irq,
        .map_io         = smdk6410_map_io,
        .init_machine   = smdk6410_machine_init,
        .timer          = &amp;s3c64xx_timer,
MACHINE_END 
</pre><p>
&#25193;&#23637;&#24320;&#21518;&#30340;&#26426;&#22120;&#26550;&#26500;&#32467;&#26500;&#20307;&#22914;&#19979;&#65292;&#23427;&#25551;&#36848;&#20102;&#22522;&#26412;&#30340;&#26426;&#22120;&#21442;&#25968;&#65306;&#29289;&#29702;io&#65292;&#21551;&#21160;&#21442;&#25968;&#65292;&#21021;&#22987;&#21270;&#20989;&#25968;&#21644;&#26102;&#38047;&#31561;&#12290;
</p><pre class="programlisting">
static const struct machine_desc __mach_desc_SMDK6410
	__used
	__attribute__((__section__("arch.info.init"))) = 
	{
		/* include/asm-arm/mach-types.h: 
		#define MACH_TYPE_SMDK6410             1626 */
			.nr = MACH_TYPE_SMDK6410,
			.name = "SMDK6410",
	
		/* Maintainer: Ben Dooks &lt;ben@fluff.org&gt; */
		.phys_io        = S3C_PA_UART &amp; 0xfff00000,
		.io_pg_offst    = (((u32)S3C_VA_UART) &gt;&gt; 18) &amp; 0xfffc,
		.boot_params    = S3C64XX_PA_SDRAM + 0x100, 
		
		.init_irq       = s3c6410_init_irq,
		.map_io         = smdk6410_map_io,
		.init_machine   = smdk6410_machine_init,
		.timer          = &amp;s3c64xx_timer,		
  }
};
</pre><p>
__lookup_processor_type&#30340;&#26597;&#35810;&#30340;&#32467;&#26500;&#20026;struct proc_info_list
&#26426;&#22120;&#31867;&#22411;&#30830;&#23450;&#21518;&#21363;&#24320;&#22987;&#35299;&#26512;&#65288;__vet_atags&#65289;&#20869;&#26680;&#21442;&#25968;&#21015;&#34920;&#65292;&#21028;&#26029;&#31532;&#19968;&#20010;&#21442;&#25968;&#31867;&#22411;&#26159;&#19981;&#26159;ATAG_CORE&#12290;&#20869;&#26680;&#21442;&#25968;&#21015;&#34920;&#19968;&#33324;&#25918;&#22312;&#20869;&#26680;&#21069;&#38754;16K&#22320;&#22336;&#31354;&#38388;&#22788;&#12290;&#21015;&#34920;&#30340;&#34920;&#39033;&#30001;struct tag&#26500;&#25104;&#65292;&#27599;&#20010;struct tag&#26377;&#24120;&#35265;&#30340;&#20197;&#19979;&#31867;&#22411;&#65306;ATAG_CORE&#12289;ATAG_MEM&#12289;ATAG_CMDLINE&#12289;ATAG_RAMDISK&#12289;ATAG_INITRD&#31561;&#12290;
</p><pre class="programlisting">
3:    .long       .
       .long       __arch_info_begin
       .long       __arch_info_end

       .type       __lookup_machine_type, %function
__lookup_machine_type:
       adr  r3, 3b
       ldmia      r3, {r4, r5, r6}
       sub  r3, r3, r4                    
       add r5, r5, r3                     
       add r6, r6, r3                     
1:     ldr   r3, [r5, #MACHINFO_TYPE] 
       teq  r3, r1                          
       beq 2f                         
       add r5, r5, #SIZEOF_MACHINE_DESC
       cmp r5, r6
       blo  1b
       mov r5, #0                      
2:    mov pc, lr//&#36820;&#22238;
</pre><p>
adr  r3, 3b&#23558;&#20302;&#22320;&#22336;&#22788;&#26631;&#31614;3&#30340;&#22320;&#22336;&#21152;&#36733;&#21040;r3&#65292;&#28982;&#21518;&#36890;&#36807;ldmia&#20998;&#21035;&#23558;__arch_info_begin&#21644;__arch_info_end&#30340;&#22320;&#22336;&#21152;&#36733;&#21040;r5&#21644;r6&#65292;r4&#21017;&#21152;&#36733;&#20102;&#26631;&#31614;3&#23545;&#24212;&#30340;&#34394;&#25311;&#22320;&#22336;&#65292;&#25509;&#19979;&#26469;&#35843;&#25972;r5&#21644;r6&#30340;&#34394;&#25311;&#22320;&#22336;&#21040;&#29289;&#29702;&#22320;&#22336;&#12290;MACHINFO_TYPE&#22312;arch/arm/kernel/asm-offset.c&#20013;&#23450;&#20041;&#65306;
</p><pre class="programlisting">
  DEFINE(MACHINFO_TYPE,         offsetof(struct machine_desc, nr));
</pre><p>
ldr r3,[r5, #MACHINFO_TYPE]&#21462;&#20986;struct machine_desc&#20013;&#30340;nr(architecture number)&#35013;&#36733;&#21040;r3&#20013;&#12290;&#22312;zImage&#35299;&#21387;&#21518;&#30340;&#26368;&#21518;&#36339;&#36716;&#25351;&#20196;&#23433;&#25490;&#20102;&#19977;&#20010;&#21442;&#25968;&#65292;&#20854;&#20013;r1&#35760;&#24405;&#20102;Bootloader&#20256;&#36882;&#26469;&#30340;&#26550;&#26500;&#32534;&#21495;&#65292;&#23427;&#22312;Bootloader&#20013;&#30340;
include/configs/smdk6410.h&#23450;&#20041;&#65306;
</p><pre class="programlisting">
#define MACH_TYPE		1626
</pre><p>
&#26174;&#28982;&#36825;&#37324;&#30340;MACH_TYPE&#21644;MACH_TYPE_SMDK6410&#26159;&#19968;&#33268;&#30340;&#12290; teq  r3, r1&#21644;beq 2f&#23558;&#21305;&#37197;&#25104;&#21151;&#65292;&#33509;&#26597;&#25214;&#23436;&#25972;&#20010;__arch_inf&#34920;&#39033;&#22343;&#26410;&#21305;&#37197;&#65292;r5&#23558;&#34987;&#32622;0&#65292;mov pc, lr&#36820;&#22238;&#21040;&#35843;&#29992;&#20989;&#25968;&#30340;&#19979;&#19968;&#26465;&#25351;&#20196;&#65292;__error_a&#36827;&#34892;&#20986;&#38169;&#25805;&#20316;&#12290;
</p>
</div>
<div class="sect2" title="8.4. &#21019;&#24314;&#20869;&#26680;&#27573;&#39029;&#34920;"><div class="titlepage"><div><div><h3 class="title"><a name="idp80556452"></a>8.4. &#21019;&#24314;&#20869;&#26680;&#27573;&#39029;&#34920;</h3></div></div></div>
<p>
&#36890;&#36807;&#21069;&#38754;&#30340;&#20004;&#27493;,&#25105;&#20204;&#24050;&#32463;&#30830;&#23450;&#20102;processor type &#21644; machine type.
&#27492;&#26102;,&#19968;&#20123;&#29305;&#23450;&#23492;&#23384;&#22120;&#30340;&#20540;&#22914;&#19979;&#25152;&#31034;:
</p><pre class="programlisting">
r8 = machine info       (struct machine_desc&#30340;&#22522;&#22320;&#22336;)
r9 = cpu id             (&#36890;&#36807;cp15&#21327;&#22788;&#29702;&#22120;&#33719;&#24471;&#30340;cpu id)
r10 = procinfo          (struct proc_info_list&#30340;&#22522;&#22320;&#22336;)
</pre><p>
&#25509;&#19979;&#26469;&#35843;&#29992;__create_page_tables&#21019;&#24314;&#39029;&#34920;&#12290;&#22240;&#20026;&#35201;&#20351;&#33021;MMU&#36827;&#34892;&#34394;&#25311;&#20869;&#23384;&#31649;&#29702;&#65292;&#22240;&#27492;&#24517;&#39035;&#21019;&#24314;&#26144;&#23556;&#29992;&#30340;&#39029;&#34920;&#12290;&#39029;&#34920;&#23601;&#26159;&#19968;&#20010;&#22320;&#22336;&#36716;&#25442;&#22120;&#65292;&#20445;&#35777;&#35775;&#38382;&#34394;&#25311;&#22320;&#22336;&#26102;&#33021;&#20174;&#29289;&#29702;&#22320;&#22336;&#37324;&#21462;&#21040;&#27491;&#30830;&#20195;&#30721;&#12290;&#19982;Bootloader&#31867;&#20284;&#65292;&#36825;&#37324;&#20351;&#29992;&#30340;&#26159;arm&#30340;L1&#20027;&#39029;&#34920;&#65292;L1&#20027;&#39029;&#34920;&#20063;&#31216;&#20026;&#27573;&#39029;&#34920;(section page table)
L1 &#20027;&#39029;&#34920;&#23558;4 GB &#30340;&#22320;&#22336;&#31354;&#38388;&#20998;&#25104;&#33509;&#24178;&#20010;1 MB&#30340;&#27573;(section),&#22240;&#27492;L1&#39029;&#34920;&#21253;&#21547;4096&#20010;&#39029;&#34920;&#39033;(section entry). &#27599;&#20010;&#39029;&#34920;&#39033;&#26159;32 bits(4 bytes)&#12290;__create_page_tables&#26159;&#19968;&#20010;&#27604;&#36739;&#22797;&#26434;&#30340;&#20989;&#25968;&#65292;&#25509;&#19979;&#26469;&#19968;&#19968;&#20998;&#26512;&#65306;
</p><pre class="programlisting">
	/*
	#define KERNEL_RAM_PADDR	(PHYS_OFFSET + TEXT_OFFSET)
	.macro	pgtbl, rd
	ldr	\rd, =(KERNEL_RAM_PADDR - 0x4000)
	.endm */
	
	pgtbl	r4				@ page table address
</pre><p>
pgtbl&#23439;&#29992;&#26469;&#30830;&#23450;&#39029;&#34920;&#30340;&#36215;&#22987;&#20301;&#32622;&#65292;&#21363;&#22312;&#20869;&#26680;&#25152;&#22312;&#31354;&#38388;&#30340;&#21069;16K&#22788;&#12290;PHYS_OFFSET&#23450;&#20041;&#22312;arch/arm/mach-s3c6400/include/mach/memory.h&#20013;&#65292;&#24182;&#36890;&#36807;.config&#20013;&#23450;&#20041;CONFIG_ARCH_S3C64XX&#22312;&#32534;&#35793;&#26102;&#21253;&#21547;&#36827;&#26469;&#12290;
</p><pre class="programlisting">
#define PHYS_OFFSET     	UL(0x50000000)
</pre><p>
TEXT_OFFSET&#21017;&#36890;&#36807;arch/arm/Makefile&#23450;&#20041;&#12290;&#20195;&#30721;&#27573;&#30340;&#20559;&#31227;&#24635;&#26159;&#20301;&#20110;&#20869;&#26680;&#38236;&#20687;&#24320;&#22987;&#30340;32K&#22788;&#12290;
</p><pre class="programlisting">
textofs-y       := 0x00008000
# The byte offset of the kernel image in RAM from the start of RAM.
TEXT_OFFSET := $(textofs-y)
</pre><p>
KERNEL_RAM_PADDR&#23450;&#20041;&#20102;&#20869;&#26680;&#38236;&#20687;&#25152;&#22312;&#30340;&#29289;&#29702;&#22320;&#22336;&#65292;&#20063;&#21363;0x50000000 + 0x00008000&#65292;&#36825;&#19982;RAM&#30340;I/O&#22320;&#22336;0x50008000&#26159;&#19968;&#33268;&#30340;&#12290;&#39029;&#34920;&#30340;&#22320;&#22336;&#20301;&#20110;&#20869;&#26680;&#38236;&#20687;&#22320;&#22336;&#30340;&#20302;&#22320;&#22336;&#20559;&#31227;&#30340;16K&#65288;0x4000&#65289;&#31354;&#38388;&#20869;&#12290;
</p><pre class="programlisting">
       mov r0, r4
       mov r3, #0
       add r6, r0, #0x4000
1:    str   r3, [r0], #4
       str   r3, [r0], #4
       str   r3, [r0], #4
       str   r3, [r0], #4
       teq  r0, r6
       bne  1b
</pre><p>
r0&#20174;r4&#24471;&#21040;&#39029;&#34920;&#30340;&#24320;&#22987;&#22320;&#22336;0x50004000&#65292;r6&#21017;&#26159;&#39029;&#34920;&#32467;&#26463;&#22320;&#22336;0x50008000&#12290;&#25509;&#19979;&#26469;&#30340;str&#21629;&#20196;&#28165;&#31354;&#39029;&#34920;&#39033;&#65292;&#39029;&#34920;&#39033;&#20849;&#26377;16K/4 = 4K&#39033;&#65292;&#27599;&#39033;&#22235;&#20010;&#23383;&#33410;&#12290;&#39029;&#34920;&#25152;&#22312;&#30340;&#29289;&#29702;&#22320;&#22336;&#31354;&#38388;&#20026;[0x50004000, 0x50008000)&#12290;&#20197;&#19978;&#25351;&#20196;&#21021;&#22987;&#21270;&#39029;&#34920;&#20026;0&#12290;
</p><pre class="programlisting">
	/*
	arch/arm/kernel/asm-offsets.c
	DEFINE(PROCINFO_MM_MMUFLAGS,	offsetof(struct proc_info_list, __cpu_mm_mmu_flags));
	*/
	/*
	 // __cpu_mm_mmu_flags
  .long   PMD_TYPE_SECT | \
        PMD_SECT_BUFFERABLE | \
        PMD_SECT_CACHEABLE | \
        PMD_SECT_AP_WRITE | \
        PMD_SECT_AP_READ
	*/
	ldr	r7, [r10, #PROCINFO_MM_MMUFLAGS] @ mm_mmuflags
</pre><p>
&#19978;&#38754;&#30340;&#25351;&#20196;&#20174;proc_info_list&#32467;&#26500;&#20013;&#30340;__cpu_mm_mmu_flags&#22788;&#33719;&#21462;MMU&#30340;FLAGS&#20449;&#24687;&#65292;&#27880;&#24847;&#21040;PMD&#24320;&#22836;&#30340;&#23439;&#22343;&#23450;&#20041;&#22312;arm/include/asm/pgtable-hwdef.h&#20013;&#65292;&#21487;&#20197;&#24471;&#21040;__cpu_mm_mmu_flags&#30340;&#20540;&#23545;&#24212;(2 &lt;&lt; 0) | (1 &lt;&lt; 2) | (1 &lt;&lt; 3) | (1 &lt;&lt; 10) | (1 &lt;&lt; 11)&#65292;&#36825;&#37324;&#20026;0xc0e&#65292;&#27880;&#24847;&#21040;bootloader&#20013;&#20026;0xc1e&#65292;&#23454;&#38469;&#19978;bit4&#22312;&#27573;&#20998;&#39029;&#20013;&#19981;&#36215;&#20316;&#29992;&#12290;
</p><pre class="programlisting">
/*
 * Hardware page table definitions.
 *
 * + Level 1 descriptor (PMD)
 *   - common
 */
#define PMD_TYPE_MASK           (3 &lt;&lt; 0)
#define PMD_TYPE_FAULT          (0 &lt;&lt; 0)
#define PMD_TYPE_TABLE          (1 &lt;&lt; 0)
#define PMD_TYPE_SECT           (2 &lt;&lt; 0)
#define PMD_BIT4                (1 &lt;&lt; 4)
#define PMD_DOMAIN(x)           ((x) &lt;&lt; 5)
#define PMD_PROTECTION          (1 &lt;&lt; 9)        /* v5 */

/* - section */
#define PMD_SECT_BUFFERABLE     (1 &lt;&lt; 2)
#define PMD_SECT_CACHEABLE      (1 &lt;&lt; 3)
#define PMD_SECT_AP_WRITE       (1 &lt;&lt; 10)
#define PMD_SECT_AP_READ        (1 &lt;&lt; 11)
</pre><p>
&#25509;&#19979;&#26469;&#30340;&#25351;&#20196;&#22635;&#20805;&#24403;&#21069;&#20869;&#26680;&#20351;&#29992;&#30340;&#34394;&#25311;&#22320;&#22336;&#23545;&#24212;&#30340;&#39029;&#34920;&#12290;mov&#21644;orr&#25351;&#20196;&#26159;&#20026;&#20102;&#24471;&#21040;&#24403;&#21069;&#25351;&#20196;&#30340;&#29289;&#29702;&#22320;&#22336;&#22312;1M&#22788;&#30340;&#22522;&#22320;&#22336;&#65292;&#26174;&#28982;&#36825;&#37324;&#24212;&#35813;&#20026;0x50000000&#65292;orr&#25351;&#20196;&#36824;&#23558;&#35813;&#20540;&#19982;r7&#25110;&#36816;&#31639;&#65292;&#26159;&#20026;&#20102;&#21152;&#19978;__cpu_mm_mmu_flags&#65292;&#27492;&#26102;r3&#30340;&#20540;&#20026;0x50000c0e&#12290;str&#25351;&#20196;&#21017;&#26159;&#23558;&#35813;&#34920;&#39033;&#23384;&#20648;&#21040;&#20197;r4&#20026;&#36215;&#22987;&#22320;&#22336;&#30340;&#39029;&#34920;&#20013;&#12290;&#32034;&#24341;&#20540;&#20026;r6 * 4&#65292;&#20063;&#21363;0x500 * 4&#65292;&#36825;&#37324;&#20026;0x1400&#65292;&#36825;&#37324;&#20056;&#20197;4&#30340;&#21407;&#22240;&#26159;&#30001;&#20110;&#20869;&#23384;&#22320;&#22336;&#32534;&#30721;&#26159;&#25353;&#23383;&#33410;&#20026;&#21333;&#20301;&#65292;&#32780;&#39029;&#34920;&#39033;&#20026;4&#23383;&#33410;&#12290;&#26368;&#32456;&#30340;&#32467;&#26524;&#26159;RAM[r4 + r6 * 4] = r3&#65292;&#20063;&#21363;&#39029;&#34920;&#20013;&#32034;&#24341;&#20026;0x1400&#30340;&#39029;&#34920;&#39033;&#30340;&#20540;&#20026;0x50000c0e&#12290;&#30475;&#36215;&#26469;&#22914;&#19979;&#22270;&#25152;&#31034;&#65306;
</p><pre class="programlisting">
       mov r6, pc, lsr #20        
       orr r3, r7, r6, lsl #20 
       str r3, [r4, r6, lsl #2]
</pre><p>	
&#20026;&#20869;&#26680;&#21019;&#24314;1M&#30340;&#26144;&#23556;&#31354;&#38388;&#65292;&#36825;&#37324;&#26159;&#25353;&#29031;1&#65306;1&#19968;&#33268;&#26144;&#23556;&#65292;&#21363;&#20195;&#30721;&#30340;&#22522;&#22320;&#22336;(&#39640;12bit)&#23545;&#24212;&#30456;&#21516;&#30340;&#29289;&#29702;&#22359;&#22320;&#22336;&#12290;&#36825;&#31181;&#26144;&#23556;&#20851;&#31995;&#21482;&#26159;&#22312;&#21551;&#21160;&#38454;&#27573;&#20351;&#29992;,&#23427;&#19982;bootloader&#20013;&#30340;head.S&#30340;&#27573;&#39029;&#34920;&#23454;&#29616;&#31867;&#20284;&#65292;&#22312;&#36339;&#36827;start_kernel&#21518;&#20250;&#34987;paging_init()&#31227;&#38500;&#12290;&#36825;&#31181;&#26144;&#23556;&#21487;&#20197;&#30452;&#25509;&#21033;&#29992;&#24403;&#21069;&#22320;&#22336;&#30340;&#39640;12bit&#20316;&#20026;&#22522;&#22320;&#22336;&#65292;&#36825;&#31181;&#26041;&#24335;&#24456;&#24039;&#22937;&#65292;&#22240;&#20026;&#24403;&#21069;&#30340;pc&#20381;&#28982;&#22312;1M&#31354;&#38388;&#20869;&#65292;&#22240;&#27492;&#39640;12bit(&#27573;&#22522;&#22320;&#22336;)&#22312;1M&#31354;&#38388;&#20869;&#37117;&#26159;&#30456;&#21516;&#30340;&#12290;
</p><pre class="programlisting">
#define KERNEL_RAM_VADDR	(PAGE_OFFSET + TEXT_OFFSET) // head.S
#define PAGE_OFFSET       UL(CONFIG_PAGE_OFFSET)			// .config CONFIG_PAGE_OFFSET=0xc0000000
</pre><p>
</p><pre class="programlisting">
#define KERNEL_START	KERNEL_RAM_VADDR
#define KERNEL_END	_end
	/*
	 * Now setup the pagetables for our kernel direct
	 * mapped region.
	 */
	add	r0, r4,  #(KERNEL_START &amp; 0xff000000) &gt;&gt; 18
	str	r3, [r0, #(KERNEL_START &amp; 0x00f00000) &gt;&gt; 18]!
	ldr	r6, =(KERNEL_END - 1)
	add	r0, r0, #4
	add	r6, r4, r6, lsr #18
</pre><p>
&#26681;&#25454;KERNEL_START&#21644;KERNEL_END&#35745;&#31639;&#20869;&#26680;&#34394;&#25311;&#22320;&#22336;&#31354;&#38388;&#23545;&#24212;&#30340;&#39029;&#34920;&#30340;&#24320;&#22987;&#22320;&#22336;&#21644;&#32467;&#26463;&#22320;&#22336;&#24182;&#20998;&#21035;&#23384;&#20837;r3&#21644;r6&#12290;KERNEL_START&#30340;&#20540;&#20026;0xc0008000&#65292;
(KERNEL_START &amp; 0xff000000) &gt;&gt; 18&#30340;&#32467;&#26524;&#20026;KERNEL_START&#25152;&#22312;1M&#20869;&#23384;&#21306;&#22495;&#23545;&#24212;&#30340;&#39029;&#32034;&#24341;&#65292;&#30456;&#24403;&#20110;&#21491;&#31227;20&#20301;&#28982;&#21518;&#20056;&#20197;4&#65292;&#32467;&#26524;&#20026;0x3000&#12290;(KERNEL_START &amp; 0x00f00000) &gt;&gt; 18&#30340;&#32467;&#26524;&#20026;0&#65292;str&#35821;&#21477;&#23558;r3&#30340;&#25351;0x50000c0e&#23384;&#20648;&#21040;RAM[r4 + 0x3000]&#22788;&#65292;&#20063;&#21363;&#34394;&#25311;&#22320;&#22336;0xc0008000&#24320;&#22987;&#30340;1M&#22320;&#22336;&#23558;&#36890;&#36807;&#39029;&#34920;r4 + 0x3000&#26469;&#36827;&#34892;&#36716;&#25442;&#12290;&#20869;&#26680;&#30340;&#32467;&#26463;&#22320;&#22336;&#20301;&#20026;_end - 1, &#36825;&#37324;&#20943;1&#30340;&#21407;&#22240;&#26159;&#22240;&#20026;_end&#26159;location counter&#65292;&#23427;&#30340;&#22320;&#22336;&#26159;&#20869;&#26680;&#38236;&#20687;&#21518;&#38754;&#30340;&#19968;&#20010;byte&#30340;&#22320;&#22336;&#12290;r6&#30340;&#20540;&#20174;pc&#20013;&#21462;&#21040;&#65292;&#25152;&#20197;&#26159;&#29289;&#29702;&#22320;&#22336;&#12290;add	r0, r0, #4&#35843;&#33410;&#21040;&#19979;&#19968;&#39029;&#34920;&#39033;&#30340;&#22320;&#22336;&#65292;&#25509;&#19979;&#26469;&#30340;add&#23558;r6&#35013;&#20837;&#20869;&#26680;&#38236;&#20687;&#32467;&#26463;&#22320;&#22336;&#25152;&#22312;&#30340;1M&#31354;&#38388;&#25152;&#23545;&#24212;&#30340;&#39029;&#34920;&#20687;&#23545;&#24212;&#30340;&#22320;&#22336;&#12290;&#25509;&#19979;&#26469;&#30340;&#20195;&#30721;&#23558;&#22635;&#20805;&#25152;&#26377;&#30340;&#39029;&#34920;&#12290;&#24182;&#20197;&#26159;&#21542;&#22635;&#20805;&#21040;r6&#20316;&#20026;&#32467;&#26463;&#26465;&#20214;&#12290;
</p><pre class="programlisting">	
1:	cmp	r0, r6
	add	r3, r3, #1 &lt;&lt; 20
	strls	r3, [r0], #4
	bls	1b
</pre><p>
&#32039;&#25509;&#30528;&#23558;r0&#35774;&#32622;&#20026;RAM&#31532;1M&#34394;&#25311;&#22320;&#22336;&#30340;&#39029;&#34920;&#39033;&#22320;&#22336;&#65292;&#20063;&#21363;0x50004000 + (0xc0000000 &gt;&gt; 18)&#20026;0x50007000&#12290; r7&#20013;&#23384;&#20648;&#30340;&#26159;mmu flags&#65292;&#36923;&#36753;&#25110;&#19978;RAM&#30340;&#36215;&#22987;&#29289;&#29702;&#22320;&#22336;0x50000000&#65292;&#24471;&#21040;RAM&#31532;1MB&#39029;&#34920;&#39033;&#30340;&#20540;0x50000c0e&#23384;&#20837;r6&#65292;&#25509;&#30528;&#23558;&#35813;&#20540;&#23384;&#20837;0x50007000&#12290;
</p><pre class="programlisting">
	/*
	 * Then map first 1MB of ram in case it contains our boot params.
	 */
	add	r0, r4, #PAGE_OFFSET &gt;&gt; 18
	orr	r6, r7, #(PHYS_OFFSET &amp; 0xff000000)
	.if	(PHYS_OFFSET &amp; 0x00f00000)
	orr	r6, r6, #(PHYS_OFFSET &amp; 0x00f00000)
	.endif
	str	r6, [r0]
	......	
	mov	pc, lr
ENDPROC(__create_page_tables)	
</pre><p>	
&#26368;&#32456;&#30340;&#39029;&#34920;&#30475;&#36215;&#26469;&#22914;&#19979;&#25152;&#31034;&#65306;
</p><div class="figure"><a name="idp80568236"></a><p class="title"><b>&#22270; 45. &#20869;&#26680;&#21551;&#21160;&#38454;&#27573;&#30340;&#27573;&#39029;&#34920;</b></p><div class="figure-contents"><div><img src="images/page_table.gif" alt="&#20869;&#26680;&#21551;&#21160;&#38454;&#27573;&#30340;&#27573;&#39029;&#34920;"></div></div></div><p><br class="figure-break">	

</p>
</div>
<div class="sect2" title="8.5. &#20351;&#33021;MMU"><div class="titlepage"><div><div><h3 class="title"><a name="idp80568748"></a>8.5. &#20351;&#33021;MMU</h3></div></div></div>
<p>
&#25509;&#19979;&#26469;&#30475;stext&#23376;&#31243;&#24207;&#30340;&#21518;&#21322;&#37096;&#20998;&#12290;
</p><pre class="programlisting">
	/*
	 * The following calls CPU specific code in a position independent
	 * manner.  See arch/arm/mm/proc-*.S for details.  r10 = base of
	 * xxx_proc_info structure selected by __lookup_machine_type
	 * above.  On return, the CPU will be ready for the MMU to be
	 * turned on, and r0 will hold the CPU control register value.
	 */
	ldr	r13, __switch_data		@ address to jump to after
						@ mmu has been enabled
	adr	lr, __enable_mmu		@ return (PIC) address
	add	pc, r10, #PROCINFO_INITFUNC
ENDPROC(stext)
</pre><p>
&#24403; __create_page_tables &#36820;&#22238;&#20043;&#21518;&#65292;&#27492;&#26102;&#19968;&#20123;&#29305;&#23450;&#23492;&#23384;&#22120;&#30340;&#20540;&#22914;&#19979;&#25152;&#31034;:
</p><pre class="programlisting">
r4 = pgtbl              (page table &#30340;&#29289;&#29702;&#22522;&#22320;&#22336;)
r8 = machine info       (struct machine_desc&#30340;&#22522;&#22320;&#22336;)
r9 = cpu id             (&#36890;&#36807;cp15&#21327;&#22788;&#29702;&#22120;&#33719;&#24471;&#30340;cpu id)
r10 = procinfo          (struct proc_info_list&#30340;&#22522;&#22320;&#22336;)
</pre><p>
__switch_data&#34987;&#29992;&#26469;&#22312;&#20351;&#33021;MMU&#21518;&#30340;&#36339;&#36716;&#22320;&#22336;&#65292;lr&#35774;&#32622;&#20026;__enable_mmu&#30340;&#22320;&#22336;&#12290;r10&#23384;&#20648;&#30340;&#26159;procinfo&#30340;&#22522;&#22320;&#22336;, PROCINFO_INITFUNC&#26159;&#22312; arch/arm/kernel/asm-offset.c&#20013;&#23450;&#20041;&#65306;
</p><pre class="programlisting">
 DEFINE(PROCINFO_INITFUNC,     offsetof(struct proc_info_list, __cpu_flush));
</pre><p>	
__cpu_flush&#22312;proc-v6.S&#20013;&#34987;&#23450;&#20041;&#20026;__v6_setup&#65292;&#25152;&#20197;&#36825;&#37324;add pc, r10, #PROCINFO_INITFUNC&#23558;&#36339;&#36716;&#21040;__v6_setup&#20989;&#25968;&#12290;
</p><pre class="programlisting">
__v6_proc_info:
        ......
        .long   PMD_TYPE_SECT | \
                PMD_SECT_XN | \
                PMD_SECT_AP_WRITE | \
                PMD_SECT_AP_READ
        b       __v6_setup
        .long   cpu_arch_name
        .long   cpu_elf_name
        .long   HWCAP_SWP|HWCAP_HALF|HWCAP_THUMB|HWCAP_FAST_MULT|HWCAP_EDSP|HWCAP_JAVA
        .long   cpu_v6_name
        .long   v6_processor_functions
        .long   v6wbi_tlb_fns
        .long   v6_user_fns
        .long   v6_cache_fns
        .size   __v6_proc_info, . - __v6_proc_info
</pre><p>	
&#39318;&#20808;&#28165;&#38500;(invalidate)Instruction Cache &#21644; Data Cache&#65292;&#28982;&#21518;&#28165;&#38500;Write Buffer&#12290;&#22914;&#26524;&#26377;&#37197;&#32622;&#20102;MMU,&#21017;&#38656;&#35201;&#28165;&#38500;Instruction TLB &#21644;Data TLB&#65288;Translation lookaside buffer<sup>[<a name="idp80570764" href="#ftn.idp80570764" class="footnote">5</a>]</sup>&#65289;&#12290;c2&#26159;&#30340;&#26159;&#39029;&#34920;&#30340;&#22522;&#22320;&#22336;(Translation Table Base)&#65292;&#21363;&#19968;&#32423;&#26144;&#23556;&#25551;&#36848;&#31526;&#34920;&#30340;&#29289;&#29702;&#22320;&#22336;&#65292;&#23558;&#20854;&#28165;0&#12290;&#23558;r4&#20013;&#23384;&#20648;&#30340;&#26159;&#39029;&#34920;&#30340;&#22522;&#22320;&#22336;0x50004000&#25110;&#19978;TTB_FLAGS&#23384;&#20837;&#22522;&#22336;&#23492;&#23384;&#22120;c2&#12290;
</p><pre class="programlisting">
__v6_setup:
				......
        mov     r0, #0
        mcr     p15, 0, r0, c7, c14, 0          @ clean+invalidate D cache
        mcr     p15, 0, r0, c7, c5, 0           @ invalidate I cache
        mcr     p15, 0, r0, c7, c15, 0          @ clean+invalidate cache
        mcr     p15, 0, r0, c7, c10, 4          @ drain write buffer
#ifdef CONFIG_MMU
        mcr     p15, 0, r0, c8, c7, 0           @ invalidate I + D TLBs
        mcr     p15, 0, r0, c2, c0, 2           @ TTB control register
        orr     r4, r4, #TTB_FLAGS
        mcr     p15, 0, r4, c2, c0, 1           @ load TTB1
#endif /* CONFIG_MMU */
</pre><p>
&#25509;&#30528;&#23558;v6_crval&#35013;&#20837;r5&#65292;&#36825;&#37324;&#29992;&#30340;&#37117;&#26159;&#30456;&#23545;&#20110;pc&#30340;&#22320;&#22336;&#12290;ldmia&#23558;clear=0x01e0fb7f&#21644;mmuset=0x00c0387d&#20998;&#21035;&#35013;&#20837;r5&#21644;r6&#12290;&#28982;&#21518;&#26681;&#25454;&#25511;&#21046;&#23492;&#23384;&#22120;c1&#20013;&#30340;&#20540;&#39318;&#20808;&#28165;&#38500;clear&#25351;&#23450;&#37027;&#20123;&#20301;&#65292;&#28982;&#21518;&#20877;&#25110;&#19978;mmuset&#25351;&#23450;&#30340;&#20301;&#24182;&#20316;&#20026;&#36820;&#22238;&#20540;&#25918;&#20837;r0&#23492;&#23384;&#22120;&#12290;
</p><pre class="programlisting">
        adr     r5, v6_crval
        ldmia   r5, {r5, r6}
        mrc     p15, 0, r0, c1, c0, 0           @ read control register
        bic     r0, r0, r5                      @ clear bits them
        orr     r0, r0, r6                      @ set them
        mov     pc, lr                          @ return to head.S:__ret

        /*
         *         V X F   I D LR
         * .... ...E PUI. .T.T 4RVI ZFRS BLDP WCAM
         * rrrr rrrx xxx0 0101 xxxx xxxx x111 xxxx &lt; forced
         *         0 110       0011 1.00 .111 1101 &lt; we want
         */
        .type   v6_crval, #object
v6_crval:
        crval   clear=0x01e0fb7f, mmuset=0x00c0387d, ucset=0x00c0187c
</pre><p>
&#30001;&#20110;&#27492;&#26102;lr&#20013;&#26159;__enable_mmu&#30340;&#20837;&#21475;&#22320;&#22336;&#65292;&#25152;&#20197;&#25509;&#30528;&#35843;&#29992;__enable_mmu&#12290;&#22914;&#26524;&#22312;.config&#20013;&#37197;&#32622;&#20102;CONFIG_ALIGNMENT_TRAP&#37027;&#20040;&#23558;&#36890;&#36807;&#35774;&#32622;CP15&#21327;&#22788;&#29702;&#22120;&#30340;&#25511;&#21046;&#23492;&#23384;&#22120;c1&#20013;&#30340;bit1&#26469;&#20351;&#33021;&#22320;&#22336;&#23545;&#40784;&#26816;&#26597;&#12290;&#36825;&#20123;&#26631;&#24535;&#20301;&#22312;arch/arm/include/asm/system.h&#20013;&#34987;&#23450;&#20041;&#65306;
</p><pre class="programlisting">
/*
 * CR1 bits (CP#15 CR1)
 */
#define CR_M    (1 &lt;&lt; 0)        /* MMU enable                           */
#define CR_A    (1 &lt;&lt; 1)        /* Alignment abort enable               */
#define CR_C    (1 &lt;&lt; 2)        /* Dcache enable                        */
#define CR_W    (1 &lt;&lt; 3)        /* Write buffer enable                  */
#define CR_P    (1 &lt;&lt; 4)        /* 32-bit exception handler             */
......
</pre><p>
&#25509;&#19979;&#26469;&#26681;&#25454;CONFIG_CPU_DCACHE_DISABLE&#65292;CONFIG_CPU_ICACHE_DISABLE&#21644;CONFIG_CPU_BPREDICT_DISABLE&#37197;&#32622;&#26469;&#31105;&#27490;D/I Cache&#21644;&#31105;&#27490;&#36339;&#36716;&#39044;&#27979;&#21151;&#33021;&#12290;
</p><pre class="programlisting">
__enable_mmu:
#ifdef CONFIG_ALIGNMENT_TRAP
	orr	r0, r0, #CR_A
#else
	bic	r0, r0, #CR_A
#endif
#ifdef CONFIG_CPU_DCACHE_DISABLE
	bic	r0, r0, #CR_C
#endif
#ifdef CONFIG_CPU_BPREDICT_DISABLE
	bic	r0, r0, #CR_Z
#endif
#ifdef CONFIG_CPU_ICACHE_DISABLE
	bic	r0, r0, #CR_I
#endif
</pre><p>	
CP15&#20013;&#30340;&#23492;&#23384;&#22120;c3&#23450;&#20041;&#20102;ARM&#22788;&#29702;&#22120;&#30340;16&#20010;&#22495;&#30340;&#35775;&#38382;&#26435;&#38480;&#12290;&#35774;&#32622;domain&#21442;&#25968;&#21040;r5&#65292;&#24182;&#23384;&#20648;&#21040;c3&#12290;&#23427;&#29992;&#26469;&#36827;&#34892;&#35775;&#38382;&#25511;&#21046;&#12290;c3&#29992;&#26469;&#25511;&#21046;&#23545;&#26576;&#20010;&#22495;&#30340;&#35775;&#38382;&#26435;&#38480;&#65292;&#23427;&#21487;&#20197;&#21516;&#26102;&#25552;&#20379;16&#20010;&#22495;&#30340;&#26435;&#38480;&#26816;&#26597;&#65292;&#27599;&#20010;&#22495;&#30340;&#26435;&#38480;&#20351;&#29992;2&#20301;&#34920;&#31034;&#65292;&#24403;&#21069;&#25903;&#25345;DOMAIN_NOACCESS:&#31105;&#27490;&#35775;&#38382;&#65292;DOMAIN_CLIENT&#35775;&#38382;&#26102;&#26816;&#26597;TLB&#39033;&#30340;P&#20301;&#65292;DOMAIN_MANAGER&#65306;&#35775;&#38382;&#26159;&#19981;&#26816;&#26597;P&#20301;&#12290;DOMAIN_KERNEL&#21644;DOMAIN_TABLE&#36825;&#37324;&#20026;0&#65292;&#32780;DOMAIN_USER&#21644;DOMAIN_IO&#20026;2&#65292;&#25152;&#20197;&#23427;&#20204;&#20998;&#21035;&#20351;&#29992;&#20102;&#31532;0&#21644;2&#20010;&#22495;&#26435;&#38480;&#20301;&#12290;&#27880;&#24847;&#21040;mcr p15, 0, r4, c2, c0, 2 &#19982;__v6_setup&#20013;&#30340;mcr p15, 0, r4, c2, c0, 1&#30340;&#19981;&#21516;&#12290;&#26368;&#21518;&#30340;&#25805;&#20316;&#25968;&#25351;&#26126;&#20102;&#24403;&#21069;&#25805;&#20316;&#30340;&#26159;Translation Table Base Register 0&#36824;&#26159;1&#12290;&#21482;&#26159;Register 0&#20026;&#26222;&#36890;&#36827;&#31243;&#25152;&#29992;&#65292;&#32780;Register 1&#21017;&#20026;&#25805;&#20316;&#31995;&#32479;&#21644;I/O&#22320;&#22336;&#35775;&#38382;&#25152;&#29992;&#12290;
</p><pre class="programlisting">
/*
	From arch/arm/include/asm/domain.h
	#ifndef CONFIG_IO_36
	#define DOMAIN_KERNEL   0
	#define DOMAIN_TABLE    0
	#define DOMAIN_USER     1
	#define DOMAIN_IO       2
	#else
	#define DOMAIN_KERNEL   2
	#define DOMAIN_TABLE    2
	#define DOMAIN_USER     1
	#define DOMAIN_IO       0
	#endif
	
	// Domain types	 
	#define DOMAIN_NOACCESS 0
	#define DOMAIN_CLIENT   1
	#define DOMAIN_MANAGER  3
	
	#define domain_val(dom,type)    ((type) &lt;&lt; (2*(dom)))
*/
	mov	r5, #(domain_val(DOMAIN_USER, DOMAIN_MANAGER) | \
		      domain_val(DOMAIN_KERNEL, DOMAIN_MANAGER) | \
		      domain_val(DOMAIN_TABLE, DOMAIN_MANAGER) | \
		      domain_val(DOMAIN_IO, DOMAIN_CLIENT))
	mcr	p15, 0, r5, c3, c0, 0		@ load domain access register
	mcr	p15, 0, r4, c2, c0, 0		@ load page table pointer
	b	__turn_mmu_on
ENDPROC(__enable_mmu)
</pre><p>
&#22312;&#19968;&#20123;&#21015;&#30340;&#20934;&#22791;&#24037;&#20316;&#20197;&#21518;&#65292;__enable_mmu&#30495;&#27491;&#20351;&#33021;MMU&#12290;&#39318;&#20808;.align 5&#30830;&#20445;&#25351;&#20196;&#23545;&#40784;&#20110;32&#12290;r0&#26159;cp15&#25511;&#21046;&#23492;&#23384;&#22120;&#30340;&#20869;&#23481;, r13&#23384;&#20648;&#20102;MMU&#20351;&#33021;&#21518;&#38656;&#35201;&#36339;&#36716;&#30340;&#34394;&#25311;&#22320;&#22336;(&#22240;&#20026;&#23436;&#25104;&#21518;mmu&#24050;&#32463;&#25171;&#24320;&#20102;,&#22343;&#20026;&#34394;&#25311;&#22320;&#22336;&#20102;)&#65292;&#20063;&#21363;__switch_data&#12290;&#20889;cp15&#30340;&#25511;&#21046;&#23492;&#23384;&#22120;c1, &#25171;&#24320;mmu&#65292;&#21516;&#26102;&#20250;&#25171;&#24320;cache&#31561;(&#26681;&#25454;r0&#30456;&#24212;&#30340;&#37197;&#32622;)&#12290;&#35835;&#21462;id&#23492;&#23384;&#22120;&#12290;&#20004;&#20010;mov	r3, r3&#30340;nop&#25805;&#20316;&#26159;&#38750;&#24120;&#37325;&#35201;&#30340;,&#22240;&#20026;&#22312;&#25171;&#24320;mmu&#21518;,&#35201;&#31561;&#21040;3&#20010;cycle&#20043;&#21518;&#25165;&#20250;&#29983;&#25928;&#65292;&#36825;&#21644;arm&#30340;&#27969;&#27700;&#32447;&#26377;&#20851;&#31995;&#12290;&#22240;&#32780;,&#22312;&#25171;&#24320;mmu&#25805;&#20316;&#20043;&#21518;&#30340;&#21152;&#20102;&#20004;&#20010;nop&#25805;&#20316;&#12290;&#31532;&#19968;&#20010;mov	r0, r0&#20063;&#26159;&#30456;&#21516;&#30340;&#36947;&#29702;&#12290;
</p><pre class="programlisting">
	.align	5
__turn_mmu_on:
	mov	r0, r0
	mcr	p15, 0, r0, c1, c0, 0		@ write control reg
	mrc	p15, 0, r3, c0, c0, 0		@ read id reg
	mov	r3, r3
	mov	r3, r3
	mov	pc, r13
ENDPROC(__turn_mmu_on)
</pre><p>	
&#22312;arch/arm/kernel/head-common.S&#20013;&#23450;&#20041;&#20102;__switch_data&#12290;&#39318;&#20808;&#23450;&#20041;&#20102;&#19968;&#20123;&#22320;&#22336;&#21442;&#25968;&#12290;&#20854;&#20013;__mmap_switched&#26159;&#19968;&#20010;&#26631;&#31614;&#65292;&#23558;&#36339;&#36716;&#21040;&#23427;&#30452;&#25509;&#25191;&#34892;&#12290;
</p><pre class="programlisting">
	.type	__switch_data, %object
__switch_data:
	.long	__mmap_switched
	.long	__data_loc			 @ r4
	.long	__data_start		 @ r5
	.long	__bss_start			 @ r6
	.long	_end				     @ r7
	.long	processor_id		 @ r4
	.long	__machine_arch_type	@ r5
	.long	__atags_pointer			@ r6
	.long	cr_alignment			  @ r7
	.long	init_thread_union + THREAD_START_SP @ sp
</pre><p>
&#27492;&#22788;&#30340;&#20195;&#30721;&#22343;&#22312;MMU&#24320;&#21551;&#30340;&#29366;&#24577;&#19979;&#25191;&#34892;&#65292;&#21487;&#20197;&#20351;&#29992;&#32477;&#23545;&#22320;&#22336;&#65292;&#25152;&#20197;&#26159;&#19981;&#26159;&#20301;&#32622;&#26080;&#20851;&#20195;&#30721;(PIC)&#12290;__switch_data + 4&#30340;&#22320;&#22336;&#26159;__data_loc&#25152;&#22312;&#30340;&#22320;&#22336;&#12290;ldmia&#25351;&#20196;&#23558;&#20174;r3&#22320;&#22336;&#24320;&#22987;&#20998;&#21035;&#21462;&#20986;__data_loc&#31561;&#21040;r4-r7&#12290;&#36825;&#20960;&#20010;&#31526;&#21495;&#22343;&#22312;arch/arm/kernel/vmlinux.lds.S &#20013;&#23450;&#20041;&#12290;__data_loc &#26159;&#25968;&#25454;&#23384;&#25918;&#30340;&#20301;&#32622;,__data_start &#26159;&#25968;&#25454;&#24320;&#22987;&#30340;&#20301;&#32622;&#65292;&#36890;&#24120;&#23427;&#20204;&#30456;&#31561;&#65307;__bss_start &#26159;bss&#24320;&#22987;&#30340;&#20301;&#32622;&#65307; _end &#26159;bss&#32467;&#26463;&#30340;&#20301;&#32622;, &#20063;&#26159;&#20869;&#26680;&#32467;&#26463;&#30340;&#20301;&#32622;&#12290;&#21453;&#27719;&#32534;&#30340;&#32467;&#26524;&#22914;&#19979;&#25152;&#31034;&#65306;
</p><pre class="programlisting">
c0008124 &lt;__switch_data&gt;:
c0008124:       c000814c        .word   0xc000814c @__mmap_switched
c0008128:       c04ac000        .word   0xc04ac000 @ r4
c000812c:       c04ac000        .word   0xc04ac000 @ r5
c0008130:       c04e1c20        .word   0xc04e1c20 @ r6
c0008134:       c052fc2e        .word   0xc052fc2e @ r7
c0008138:       c04e2148        .word   0xc04e2148 @ r4
c000813c:       c04e2114        .word   0xc04e2114 @ r5
c0008140:       c00241bc        .word   0xc00241bc @ r6
c0008144:       c04b0760        .word   0xc04b0760 @ r7
c0008148:       c04adff8        .word   0xc04adff8 @ sp(r13)
</pre><p>
&#25509;&#30528;&#27604;&#36739;&#27604;&#36739;__data_loc&#21644;__data_start&#30340;&#20540;&#65292;&#22914;&#26524;&#19981;&#30456;&#31561;,&#21017;&#38656;&#35201;&#25644;&#36816;&#25968;&#25454;&#20174;__data_loc&#23558;&#25968;&#25454;&#25644;&#21040;__data_start&#12290;&#20854;&#20013;__bss_start&#26159;bss&#30340;&#24320;&#22987;&#30340;&#20301;&#32622;&#65292;&#21516;&#26102;&#23427;&#25351;&#26126;&#20102;data &#32467;&#26463;&#30340;&#20301;&#32622;,&#22240;&#32780;&#29992;&#20854;&#20316;&#20026;&#21028;&#26029;&#25968;&#25454;&#26159;&#21542;&#25644;&#36816;&#23436;&#25104;&#12290;&#20986;&#29616;&#19981;&#31561;&#30340;&#24773;&#20917;&#38656;&#35201;&#20102;&#35299;vmlinux.lds&#20013;&#30340;.data &#27573;&#21518;&#38754;&#30340;AT(__data_loc) &#30340;&#24847;&#24605;&#12290;AT(__data_loc)&#35828;&#26126;&#36825;&#37096;&#20998;&#30340;&#20869;&#23481;&#26159;&#22312;__data_loc&#20013;&#23384;&#20648;&#30340;(&#35201;&#27880;&#24847;,&#20648;&#23384;&#30340;&#20301;&#32622;&#21644;&#38142;&#25509;&#30340;&#20301;&#32622;&#26159;&#21487;&#20197;&#19981;&#30456;&#21516;&#30340;).
</p><pre class="programlisting">
/*
 * The following fragment of code is executed with the MMU on in MMU mode,
 * and uses absolute addresses; this is not position independent.
 *
 *  r0  = cp#15 control register
 *  r1  = machine ID
 *  r2  = atags pointer
 *  r9  = processor ID
 */
__mmap_switched:
	adr	r3, __switch_data + 4

	ldmia	r3!, {r4, r5, r6, r7}
	cmp	r4, r5				@ Copy data segment if needed
1:	cmpne	r5, r6
	ldrne	fp, [r4], #4
	strne	fp, [r5], #4
	bne	1b
</pre><p>	
&#28165;&#38500; bss &#27573;&#30340;&#20869;&#23481;,&#23558;&#20854;&#37117;&#32622;&#25104;0&#65292;&#36825;&#37324;&#20351;&#29992; _end &#26469;&#21028;&#26029; bss &#30340;&#32467;&#26463;&#20301;&#32622;&#12290;
</p><pre class="programlisting">
	mov	fp, #0				@ Clear BSS (and zero fp)
1:	cmp	r6, r7
	strcc	fp, [r6],#4
	bcc	1b
</pre><p>	
&#27880;&#24847;&#21040;&#19978;&#38754;&#30340;ldmia&#25351;&#20196;&#20013;&#30340;"!"&#21495;&#65292;&#25152;&#20197;r3&#24050;&#32463;&#25351;&#21521;&#20102;processor_id&#25152;&#22312;&#30340;&#22320;&#22336;&#12290;&#36825;&#37324;&#30340;ldmia&#23558;processor_id&#31561;&#20998;&#21035;&#21152;&#36733;&#21040;r4-r7&#21644;sp&#20013;&#12290;
</p><pre class="programlisting">
	ldmia	r3, {r4, r5, r6, r7, sp}
	str	r9, [r4]			@ Save processor ID
	str	r1, [r5]			@ Save machine type
	str	r2, [r6]			@ Save atags pointer
	bic	r4, r0, #CR_A			@ Clear 'A' bit
	stmia	r7, {r0, r4}		@ Save control register values
	b	start_kernel
ENDPROC(__mmap_switched)
</pre><p>	
processor_id &#21644; __machine_arch_type &#36825;&#20004;&#20010;&#21464;&#37327;&#26159;&#22312; arch/arm/kernel/setup.c &#20013;&#23450;&#20041;&#30340;&#12290;&#23558;r9&#20013;&#23384;&#25918;&#30340; processor id&#36171;&#20540;&#32473;&#21464;&#37327; processor_id&#65292;&#23558;r1&#20013;&#23384;&#25918;&#30340; machine type&#36171;&#20540;&#32473;&#21464;&#37327; __machine_arch_type&#12290;zImage&#35299;&#21387;&#23436;&#27605;&#21518;&#36890;&#36807;r2&#20256;&#36882;Uboot&#20256;&#36882;&#32473;&#20869;&#26680;&#21442;&#25968;&#38142;&#34920;&#30340;&#39318;&#22320;&#22336;&#65292;&#36825;&#37324;&#34987;&#36171;&#20540;&#32473;&#20102;__atags_pointer&#12290;&#25509;&#19979;&#26469;&#28165;&#38500;r0&#20013;&#30340;CR_A &#20301;&#24182;&#23558;&#20540;&#23384;&#21040;r4&#20013;&#65292;&#24182;&#23558;&#23427;&#20204;&#20998;&#21035;&#20445;&#23384;&#21040;cr_alignment&#21644;cr_no_alignment&#20013;&#65292;&#23427;&#26159;&#22312; arch/arm/kernel/entry-armv.S &#20013;&#23450;&#20041;&#30340;&#12290;
</p><pre class="programlisting">
......
cr_alignment:
        .space  4
cr_no_alignment:
        .space  4
......  
</pre><p>
&#21040;&#36825;&#37324;&#23601;&#24320;&#22987;&#36339;&#36716;&#21040;&#20869;&#26680;&#30340;C&#35821;&#35328;&#20195;&#30721;start_kernel&#20989;&#25968;&#20013;&#21435;&#25191;&#34892;&#20102;&#65292;&#36827;&#20837;&#20102;Linux&#31995;&#32479;&#30340;&#26032;&#32426;&#20803;&#12290;
</p>
</div>
<div class="sect2" title="8.6. 0&#21495;&#36827;&#31243;"><div class="titlepage"><div><div><h3 class="title"><a name="idp80587668"></a>8.6. 0&#21495;&#36827;&#31243;</h3></div></div></div>
<p>
init_thread_union&#26159;init&#36827;&#31243;&#30340;&#22522;&#22320;&#22336;&#65292;&#22312;arch/arm/kernel/init_task.c&#20013;&#23450;&#20041;&#12290;
</p><pre class="programlisting">
include/linux/shed.h 
union thread_union {
     struct thread_info thread_union;
     unsigned long stack[THREAD_SIZE/sizeof(long)];
};
</pre><p>
&#36827;&#31243;&#26632;&#36890;&#24120;&#21644;thread_info&#32467;&#26500;&#19968;&#21516;&#20445;&#23384;&#22312;&#19968;&#20010;&#21517;&#20026;thread_union&#30340;&#32852;&#21512;&#20307;&#20013;&#65292;&#30001;&#20110;struct thread_info&#32467;&#26500;&#20307;&#22823;&#23567;&#23567;&#20110;THREAD_SIZE(8K)&#65292;&#25152;&#20197;&#23427;&#30340;&#22823;&#23567;&#23601;&#26159;8K&#12290;thread_info&#20445;&#23384;&#20102;&#29305;&#23450;&#20110;&#20307;&#31995;&#26550;&#26500;&#30340;&#27719;&#32534;&#35821;&#35328;&#20195;&#30721;&#38656;&#35201;&#35775;&#38382;&#30340;&#37027;&#37096;&#20998;&#36827;&#31243;&#25968;&#25454;&#12290;&#23613;&#31649;&#35813;&#32467;&#26500;&#30340;&#23450;&#20041;&#22240;&#19981;&#21516;&#30340;&#22788;&#29702;&#22120;&#32780;&#19981;&#21516;&#65292;&#20294;&#26159;&#23427;&#20204;&#30340;&#21151;&#33021;&#31867;&#20284;&#65292;ARM&#26550;&#26500;&#20195;&#30721;&#22914;&#19979;&#65306;
</p><pre class="programlisting">
arch/arm/include/asm/thread_info.h
struct thread_info {
        unsigned long           flags;          /* low level flags */
        int                     preempt_count;  /* 0 =&gt; preemptable, &lt;0 =&gt; bug */
        mm_segment_t            addr_limit;     /* address limit */
        struct task_struct      *task;          /* main task structure */
        struct exec_domain      *exec_domain;   /* execution domain */
        __u32                   cpu;            /* cpu */
        __u32                   cpu_domain;     /* cpu domain */
        struct cpu_context_save cpu_context;    /* cpu context */
        __u32                   syscall;        /* syscall number */
        __u8                    used_cp[16];    /* thread used copro */
        unsigned long           tp_value;
        struct crunch_state     crunchstate;
        union fp_state          fpstate __attribute__((aligned(8)));
        union vfp_state         vfpstate;
#ifdef CONFIG_ARM_THUMBEE
        unsigned long           thumbee_state;  /* ThumbEE Handler Base register */
#endif
        struct restart_block    restart_block;
};
</pre><p>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">task&#26159;&#25351;&#21521;&#36827;&#31243;task_struct&#30340;&#25351;&#38024;&#12290;</li><li class="listitem">flags&#20445;&#23384;&#21508;&#31181;&#29305;&#23450;&#20110;&#36827;&#31243;&#30340;&#26631;&#24535;&#65292;&#27604;&#22914;TIF_SIGPENDING&#65292;TIF_NEED_RESCHED&#12290;</li><li class="listitem">cpu&#35828;&#26126;&#20102;&#36827;&#31243;&#27491;&#22312;&#20854;&#19978;&#25191;&#34892;&#30340;CPU&#25968;&#30446;&#12290;</li><li class="listitem">preempt_count&#26159;&#23454;&#29616;&#20869;&#26680;&#25250;&#21344;&#25152;&#38656;&#30340;&#35745;&#25968;&#22120;&#12290;</li><li class="listitem">restart_block&#29992;&#20110;&#23454;&#29616;&#20449;&#21495;&#26426;&#21046;&#12290;</li></ul></div><p>
</p><pre class="programlisting">
arch/arm/include/asm/thread_info.h
#define INIT_THREAD_INFO(tsk)                                           \
{                                                                       \
        .task           = &amp;tsk,                                         \
        .exec_domain    = &amp;default_exec_domain,                         \
        .flags          = 0,                                            \
        .preempt_count  = 1,                                            \
        .addr_limit     = KERNEL_DS,                                    \
        .cpu_domain     = domain_val(DOMAIN_USER, DOMAIN_MANAGER) |     \
                          domain_val(DOMAIN_KERNEL, DOMAIN_MANAGER) |   \
                          domain_val(DOMAIN_IO, DOMAIN_CLIENT),         \
        .restart_block  = {                                             \
                .fn     = do_no_restart_syscall,                        \
        },                                                              \
}

union thread_union init_thread_union
        __attribute__((__section__(".data.init_task"))) =
                { INIT_THREAD_INFO(init_task) };

/*
 * Initial task structure.
 * All other task structs will be allocated on slabs in fork.c
 */
struct task_struct init_task = INIT_TASK(init_task);
</pre><p>
INIT_TASK&#23439;&#29992;&#26469;&#23450;&#20041;&#31532;&#19968;&#20010;task_struct&#36827;&#31243;&#32467;&#26500;init_task&#12290;&#23427;&#34987;&#21629;&#21517;&#20026;swapper&#65292;&#24403;&#26102;&#21364;&#26080;&#27861;&#20174;&#29992;&#25143;&#31354;&#38388;&#30475;&#21040;&#23427;&#65292;&#22240;&#20026;0&#21495;&#36827;&#31243;&#22312;proc&#31995;&#32479;&#19979;&#26159;&#30475;&#19981;&#21040;&#30340;&#65292;&#20294;&#26159;&#23545;&#20110;&#36827;&#31243;1&#31561;&#36827;&#31243;&#21487;&#20197;&#36890;&#36807;/proc/1/comm&#26597;&#30475;&#36827;&#31243;&#21517;&#12290;
</p><pre class="programlisting">
include/linux/init_task.h
#define INIT_TASK(tsk)  \
{                                                                       \
        .state          = 0,                                            \
        .stack          = &amp;init_thread_info,                            \
        .usage          = ATOMIC_INIT(2),                               \
        .flags          = PF_KTHREAD,                                   \
        .lock_depth     = -1,                                           \
        .prio           = MAX_PRIO-20,                                  \
        .static_prio    = MAX_PRIO-20,                                  \
        .normal_prio    = MAX_PRIO-20,                                  \
        .policy         = SCHED_NORMAL,                                 \
        .cpus_allowed   = CPU_MASK_ALL,                                 \
        .mm             = NULL,                                         \
        .active_mm      = &amp;init_mm,    																	\
......
        .comm           = "swapper",                                    \
......
</pre><p>
&#23545;&#29031; vmlnux.lds.S&#65292;&#21487;&#20197;&#30693;&#36947;init_task&#26159;&#23384;&#25918;&#22312;.data&#27573;&#30340;&#24320;&#22987;8k, &#24182;&#19988;&#26159;THREAD_SIZE(8k)&#23545;&#40784;&#30340;&#12290;
</p><pre class="programlisting">
......
. = ALIGN(8192);
 __data_loc = .;
 .data : AT(__data_loc) {
  __data_start = .; /* address in memory */
  /*
                 * first, the init task union, aligned
                 * to an 8192 byte boundary.
                 */
  *(.data.init_task)
......
</pre><p>
&#20869;&#26680;&#22312;&#20174;&#27719;&#32534;&#35821;&#35328;&#36339;&#21040;c&#35821;&#35328;&#20195;&#30721;&#20013;&#26102;&#65292;&#20854;&#26632;&#30340;&#26632;&#39030;&#23601;&#26159;&#22312;arch/arm/kernel/head-common.S&#20013;&#23450;&#20041;&#30340;__switch_data&#35774;&#32622;&#12290;&#26174;&#28982;sp&#30340;&#20540;&#20026;init_thread_union + THREAD_START_SP&#12290;THREAD_START_SP&#23450;&#20041;&#22312;arch/arm/include/asm/thread_info.h&#20013;&#12290;
</p><div class="figure"><a name="idp80596148"></a><p class="title"><b>&#22270; 46. &#20869;&#26680;&#26632;&#21644;thread_info&#24067;&#23616;</b></p><div class="figure-contents"><div><img src="images/init_task.gif" alt="&#20869;&#26680;&#26632;&#21644;thread_info&#24067;&#23616;"></div></div></div><p><br class="figure-break">
</p><pre class="programlisting">
#define THREAD_SIZE_ORDER       1
#define THREAD_SIZE             8192
#define THREAD_START_SP         (THREAD_SIZE - 8)
</pre><p>
INIT_TASK&#23439;&#23450;&#20041;&#22312;include/linux/init_task.h&#20013;&#65292;&#32780;init_task&#23601;&#26159;0&#21495;&#36827;&#31243;&#65292;&#23427;&#20174;&#36816;&#34892;&#24403;&#21069;head.S&#20013;&#30340;&#31532;&#19968;&#26465;&#25351;&#20196;&#24320;&#22987;&#23601;&#23384;&#22312;&#20102;&#65292;&#21482;&#26159;&#29616;&#22312;&#25226;&#23427;&#24403;&#20570;&#19968;&#20010;&#20869;&#26680;&#32447;&#31243;&#65292;&#20197;&#20415;&#23558;&#26469;&#30340;&#35843;&#24230;&#12290;&#23427;&#20855;&#26377;&#20197;&#19979;&#29305;&#28857;&#65306;
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">&#36827;&#31243;0&#26159;&#25152;&#26377;&#20854;&#20182;&#36827;&#31243;&#30340;&#31062;&#20808;, &#20063;&#31216;&#20316;idle&#36827;&#31243;&#25110;swapper&#36827;&#31243;.</li><li class="listitem">&#36827;&#31243;0&#26159;&#22312;&#31995;&#32479;&#21021;&#22987;&#21270;&#26102;&#30001;kernel&#33258;&#36523;&#20174;&#26080;&#21040;&#26377;&#21019;&#24314;.</li><li class="listitem">&#36827;&#31243;0&#30340;&#25968;&#25454;&#25104;&#21592;&#22823;&#37096;&#20998;&#26159;&#38745;&#24577;&#23450;&#20041;&#30340;&#65292;&#21363;&#30001;&#39044;&#20808;&#23450;&#20041;&#22909;&#30340;INIT_TASK, INIT_MM&#31561;&#23439;&#21021;&#22987;&#21270;.init_mm&#31561;&#32467;&#26500;&#20307;&#23450;&#20041;&#22312;include/linux/init_task.h&#20869;&#65292;&#20026;init_task&#25104;&#21592;&#30340;&#21021;&#22987;&#20540;,&#20998;&#21035;&#30001;&#23545;&#24212;&#30340;&#21021;&#22987;&#21270;&#23439;&#22914;INIT_MM&#31561;&#21021;&#22987;&#21270;&#12290;</li></ul></div><p>
&#36825;&#20010;vmlinux&#21487;&#25191;&#34892;ELF&#25991;&#20214;&#30340;&#27573;&#20998;&#37197;&#22914;&#19979;&#25152;&#31034;&#65292;&#20854;&#20013;&#26632;&#20301;&#20110;.data&#24320;&#22987;&#30340;8K&#21306;&#22495;&#20869;&#65292;&#32780;SP&#21017;&#25351;&#21521;0xc04adff8&#65292;&#22312;&#21387;&#26632;&#30340;&#36807;&#31243;&#20013;&#23427;&#19981;&#26029;&#21521;&#20302;&#22320;&#22336;&#22788;&#22686;&#38271;&#12290;
</p><pre class="programlisting">
Section Headers:
  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al
  [ 0]                   NULL            00000000 000000 000000 00      0   0  0
  [ 1] .text.head        PROGBITS        c0008000 008000 000240 00  AX  0   0 32
  [ 2] .init             PROGBITS        c0008240 008240 024dc0 00 WAX  0   0 32
  [ 3] .text             PROGBITS        c002d000 02d000 465d00 00  AX  0   0 32
  [ 4] .text.init        PROGBITS        c0492d00 492d00 000080 00  AX  0   0  4
  [ 5] .builtin_fw       PROGBITS        c0493000 493000 000018 00   A  0   0  4
  [ 6] __ksymtab         PROGBITS        c0493018 493018 0055a8 00   A  0   0  4
  [ 7] __ksymtab_gpl     PROGBITS        c04985c0 4985c0 002300 00   A  0   0  4
  [ 8] __ksymtab_strings PROGBITS        c049a8c0 49a8c0 010877 00   A  0   0  1
  [ 9] __param           PROGBITS        c04ab138 4ab138 000ec8 00   A  0   0  4
  [10] .data             PROGBITS        c04ac000 4ac000 035a60 00  WA  0   0 32
  [11] .init.rodata      PROGBITS        c04e1a60 4e1a60 000100 00  WA  0   0  4
  [12] .bss              NOBITS          c04e1b60 4e1b60 04e48e 00  WA  0   0 32
</pre><p>
</p>	
</div>
<div class="footnotes"><br><hr width="100" align="left"><div class="footnote"><p><sup>[<a name="ftn.idp80570764" href="#idp80570764" class="para">5</a>] </sup>&#39029;&#34920;&#30340;&#23454;&#29616;&#23545;&#34394;&#25311;&#20869;&#23384;&#31995;&#32479;&#25928;&#29575;&#26159;&#26497;&#20026;&#20851;&#38190;&#30340;&#12290;&#20363;&#22914;&#25226;&#19968;&#20010;&#23492;&#23384;&#22120;&#30340;&#20869;&#23481;&#22797;&#21046;&#21040;&#21478;&#19968;&#20010;&#23492;&#23384;&#22120;&#20013;&#30340;&#19968;&#26465;&#25351;&#20196;&#65292;&#22312;&#19981;&#20351;&#29992;&#20998;&#39029;&#26102;&#65292;&#21482;&#38656;&#35775;&#38382;&#20869;&#23384;&#19968;&#27425;&#21462;&#25351;&#20196;&#65292;&#32780;&#22312;&#20351;&#29992;&#20998;&#39029;&#26102;&#38656;&#35201;&#39069;&#22806;&#30340;&#20869;&#23384;&#35775;&#38382;&#21435;&#35835;&#21462;&#39029;&#34920;&#12290;&#32780;&#31995;&#32479;&#30340;&#36816;&#34892;&#36895;&#24230;&#19968;&#33324;&#26159;&#34987;cpu&#20174;&#20869;&#23384;&#20013;&#21462;&#24471;&#25351;&#20196;&#21644;&#25968;&#25454;&#30340;&#36895;&#29575;&#38480;&#21046;&#30340;&#65292;&#22914;&#26524;&#22312;&#27599;&#27425;&#35775;&#38382;&#20869;&#23384;&#26102;&#37117;&#35201;&#35775;&#38382;&#20004;&#27425;&#20869;&#23384;&#20250;&#20351;&#31995;&#32479;&#24615;&#33021;&#38477;&#20302;&#19977;&#20998;&#20043;&#20108;&#12290;&#23545;&#36825;&#20010;&#38382;&#39064;&#30340;&#35299;&#20915;&#65292;&#26377;&#20154;&#25552;&#20986;&#20102;&#19968;&#20010;&#35299;&#20915;&#26041;&#26696;&#65292;&#36825;&#20010;&#26041;&#26696;&#22522;&#20110;&#36825;&#26679;&#30340;&#35266;&#23519;&#65306;&#22823;&#37096;&#20998;&#31243;&#24207;&#20542;&#21521;&#20110;&#23545;&#36739;&#23569;&#30340;&#39029;&#38754;&#36827;&#34892;&#22823;&#37327;&#30340;&#35775;&#38382;&#12290;&#22240;&#27492;&#65292;&#21482;&#26377;&#19968;&#23567;&#37096;&#20998;&#39029;&#34920;&#39033;&#32463;&#24120;&#34987;&#29992;&#21040;&#65292;&#20854;&#23427;&#30340;&#24456;&#23569;&#34987;&#20351;&#29992;&#12290;&#37319;&#21462;&#30340;&#35299;&#20915;&#21150;&#27861;&#26159;&#20026;&#35745;&#31639;&#26426;&#35013;&#22791;&#19968;&#20010;&#19981;&#38656;&#35201;&#32463;&#36807;&#39029;&#34920;&#23601;&#33021;&#25226;&#34394;&#25311;&#22320;&#22336;&#26144;&#23556;&#25104;&#29289;&#29702;&#22320;&#22336;&#30340;&#23567;&#30340;&#30828;&#20214;&#35774;&#22791;&#65292;&#36825;&#20010;&#35774;&#22791;&#21483;&#20570;TLB(&#32763;&#35793;&#21518;&#25588;&#23384;&#20648;&#22120;&#65292;Translation Lookside Buffer), &#26377;&#26102;&#20063;&#21483;&#20570;&#30456;&#32852;&#23384;&#20648;&#22120;(associative memory)&#65292;&#23427;&#36890;&#24120;&#22312;MMU&#20869;&#37096;&#12290;</p></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ar01s07.html">&#19978;&#19968;&#39029;</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="ar01s09.html">&#19979;&#19968;&#39029;</a></td></tr><tr><td width="40%" align="left" valign="top">7. zImage&#30340;&#29983;&#25104;&#21644;&#21152;&#36733; </td><td width="20%" align="center"><a accesskey="h" href="index.html">&#36215;&#22987;&#39029;</a></td><td width="40%" align="right" valign="top"> 9. &#20869;&#26680;&#21021;&#22987;&#21270;</td></tr></table></div></body></html>
