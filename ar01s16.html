<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>16. &#20013;&#26029;&#22788;&#29702;</title><link rel="stylesheet" href="styles.css" type="text/css"><meta name="generator" content="DocBook XSL-NS Stylesheets V1.75.2"><link rel="home" href="index.html" title="Linux&#20869;&#26680;&#23398;&#20064;&#21644;&#30740;&#31350;&#21450;&#23884;&#20837;&#24335;(ARM)&#23398;&#20064;&#21644;&#30740;&#31350;&#30340;&#24320;&#25918;&#25991;&#26723;"><link rel="up" href="index.html" title="Linux&#20869;&#26680;&#23398;&#20064;&#21644;&#30740;&#31350;&#21450;&#23884;&#20837;&#24335;(ARM)&#23398;&#20064;&#21644;&#30740;&#31350;&#30340;&#24320;&#25918;&#25991;&#26723;"><link rel="prev" href="ar01s15.html" title="15. IO&#35774;&#22791;&#31649;&#29702;"><link rel="next" href="ar01s17.html" title="17. &#20869;&#26680;&#21442;&#25968;&#35299;&#26512;"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">16. &#20013;&#26029;&#22788;&#29702;</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ar01s15.html">&#19978;&#19968;&#39029;</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="ar01s17.html">&#19979;&#19968;&#39029;</a></td></tr></table><hr></div><div class="sect1" title="16. &#20013;&#26029;&#22788;&#29702;"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp81207388"></a>16. &#20013;&#26029;&#22788;&#29702;</h2></div></div></div>
<div class="sect2" title="16.1. &#27010;&#36848;"><div class="titlepage"><div><div><h3 class="title"><a name="idp81207764"></a>16.1. &#27010;&#36848;</h3></div></div></div>
&#23545;&#20110;&#20013;&#26029;&#21644;&#24322;&#24120;&#30340;&#23450;&#20041;&#22312;ULK&#20013;&#30340;&#31532;4&#31456;&#20013;&#32473;&#20104;&#20102;&#38750;&#24120;&#26126;&#30830;&#30340;&#23450;&#20041;&#12290;&#20013;&#26029;&#36890;&#24120;&#20998;&#20026;&#21516;&#27493;&#20013;&#26029;&#21644;&#24322;&#27493;&#20013;&#26029;&#65306;
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">&#21516;&#27493;&#20013;&#26029;&#26159;&#20826;&#25351;&#20196;&#25191;&#34892;&#26102;&#30001;CPU&#25511;&#21046;&#21333;&#20803;&#20135;&#29983;&#30340;&#65292;&#20043;&#25152;&#20197;&#31216;&#20026;&#21516;&#27493;&#65292;&#26159;&#22240;&#20026;&#21482;&#26377;&#22312;&#19968;&#26465;&#25351;&#20196;&#20013;&#27490;&#25191;&#34892;&#21518;CPU&#25165;&#20250;&#21457;&#20986;&#20013;&#26029;&#12290;</li><li class="listitem">&#24322;&#27493;&#20013;&#26029;&#26159;&#30001;&#20854;&#20182;&#30828;&#20214;&#35774;&#22791;&#20381;&#29031;CPU&#26102;&#38047;&#20449;&#21495;&#38543;&#26426;&#20135;&#29983;&#30340;&#12290;</li></ul></div>
&#22312;Intel&#24494;&#22788;&#29702;&#22120;&#25163;&#20876;&#20013;&#65292;&#25226;&#21516;&#27493;&#20013;&#26029;&#31216;&#20026;&#24322;&#24120;(Exception)&#65292;&#32780;&#24322;&#27493;&#20013;&#26029;&#34987;&#31216;&#20026;&#20013;&#26029;(Interrupt)&#12290;Linux ARM&#20869;&#26680;&#23545;&#21516;&#27493;&#21644;&#24322;&#27493;&#20013;&#26029;&#20316;&#20102;&#21516;&#19968;&#22788;&#29702;&#65292;&#23427;&#20204;&#34987;&#23450;&#20041;&#22312;&#20013;&#26029;&#21521;&#37327;&#34920;&#20013;&#65306;
<pre class="programlisting">
arch/arm/kernel/entry-armv.S
__vectors_start:
	swi	SYS_ERROR0  
	b	vector_und + stubs_offset
	ldr	pc, .LCvswi + stubs_offset
	b	vector_pabt + stubs_offset
	b	vector_dabt + stubs_offset
	b	vector_addrexcptn + stubs_offset
	b	vector_irq + stubs_offset
	b	vector_fiq + stubs_offset
</pre>
<p>
&#20013;&#26029;&#21521;&#37327;&#34920;&#20013;&#25351;&#23450;&#20102;&#21508;&#24322;&#24120;&#20013;&#26029;&#21450;&#20854;&#22788;&#29702;&#31243;&#24207;&#30340;&#23545;&#24212;&#20851;&#31995;.&#23427;&#36890;&#24120;&#23384;&#25918;&#22312;&#23384;&#20648;&#22320;&#22336;&#30340;&#20302;&#31471;&#12290;&#22312;ARM &#20307;&#31995;&#20013;&#65292;&#24322;&#24120;&#20013;&#26029;&#21521;&#37327;&#34920;&#30340;&#22823;&#23567;&#20026;32&#23383;&#33410;&#12290;&#20854;&#20013;&#27599;&#20010;&#24322;&#24120;&#20013;&#26029;&#21344;&#25454;4&#20010;&#23383;&#33410;&#22823;&#23567;,&#20445;&#30041;&#20102;4&#20010;&#23383;&#33410;&#31354;&#38388;&#12290;&#27599;&#20010;&#24322;&#24120;&#20013;&#26029;&#23545;&#24212;&#30340;&#20013;&#26029;&#21521;&#37327;&#34920;&#30340;4&#20010;&#23383;&#33410;&#30340;&#31354;&#38388;&#20013;&#23384;&#25918;&#20102;<span class="emphasis"><em>&#19968;&#20010;&#36339;&#36716;&#25351;&#20196;</em></span>&#25110;&#32773;<span class="emphasis"><em>&#19968;&#20010;&#21521;pc&#23492;&#23384;&#22120;&#20013;&#36171;&#20540;&#30340;&#25968;&#25454;&#35775;&#38382;&#25351;&#20196;</em></span>&#12290;&#36890;&#36807;&#36825;&#20004;&#31181;&#25351;&#20196;&#65292;&#31243;&#24207;&#23558;&#36339;&#36716;&#21040;&#30456;&#24212;&#30340;&#24322;&#24120;&#20013;&#26029;&#22788;&#29702;&#31243;&#24207;&#22788;&#25191;&#34892;&#12290;
</p>
<p>
&#24403;&#20960;&#20010;&#24322;&#24120;&#20013;&#26029;&#21516;&#26102;&#21457;&#29983;&#26102;&#65292;&#23601;&#24517;&#39035;&#25353;&#29031;&#19968;&#23450;&#30340;&#27425;&#24207;&#26469;&#22788;&#29702;&#36825;&#20123;&#24322;&#24120;&#20013;&#26029;&#12290;&#22312;ARM&#20013;&#36890;&#36807;&#32473;&#21508;&#24322;&#24120;&#20013;&#26029;&#36171;&#20104;&#19968;&#23450;&#30340;&#20248;&#20808;&#32423;&#26469;&#23454;&#29616;&#36825;&#31181;&#22788;&#29702;&#27425;&#24207;&#12290;&#24403;&#28982;&#26377;&#20123;&#24322;&#24120;&#20013;&#26029;&#26159;&#19981;&#21487;&#33021;&#21516;&#26102;&#21457;&#29983;&#30340;&#65292;&#22914;&#25351;&#20196;&#39044;&#21462;&#20013;&#27490;&#24322;&#24120;&#20013;&#26029;&#21644;&#36719;&#20214;&#20013;&#26029;(SWI)&#26159;&#30001;&#21516;&#19968;&#26465;&#25351;&#20196;&#30340;&#25191;&#34892;&#35302;&#21457;&#30340;&#65292;&#20182;&#20204;&#26159;&#19981;&#21487;&#33021;&#21516;&#26102;&#21457;&#29983;&#30340;&#12290;&#22788;&#29702;&#22120;&#25191;&#34892;&#26576;&#20010;&#29305;&#23450;&#30340;&#24322;&#24120;&#20013;&#26029;&#30340;&#36807;&#31243;&#20013;&#65292;&#31216;&#20026;&#22788;&#29702;&#22120;&#22788;&#20110;&#29305;&#23450;&#30340;&#20013;&#26029;&#27169;&#24335;&#12290;&#21508;&#24322;&#24120;&#20013;&#26029;&#30340;&#20013;&#26029;&#21521;&#37327;&#22320;&#22336;&#20197;&#21450;&#20013;&#26029;&#30340;&#22788;&#29702;&#20248;&#20808;&#32423;&#22914;&#19979;&#34920;&#25152;&#31034;&#12290;
</p><div class="table"><a name="idp81211740"></a><p class="title"><b>&#34920; 26. &#20013;&#26029;&#21521;&#37327;&#34920;</b></p><div class="table-contents">
<table summary="&#20013;&#26029;&#21521;&#37327;&#34920;" border="1"><colgroup><col><col><col><col></colgroup><thead><tr><th>&#20013;&#26029;&#21521;&#37327;&#34920;&#22320;&#22336;</th><th>&#20013;&#26029;&#31867;&#22411;</th><th>CPU&#22788;&#29702;&#20013;&#26029;&#30340;&#27169;&#24335;</th><th>&#20248;&#20808;&#32423;(6 &#26368;&#20302;)</th><th>&#35828;&#26126;</th></tr></thead><tbody><tr><td>0x00</td><td>&#22797;&#20301;(Reset)</td><td>&#29305;&#26435;&#27169;&#24335;(SVC)</td><td>1</td><td>&#24403;&#22788;&#29702;&#22120;&#22797;&#20301;&#30005;&#24179;&#26377;&#25928;&#26102;&#20135;&#29983;&#22797;&#20301;&#20013;&#26029;&#12290;</td></tr><tr><td>0x04</td><td>&#26410;&#23450;&#20041;&#30340;&#25351;&#20196;(Undefined instructions)</td><td>&#26410;&#23450;&#20041;&#25351;&#20196;&#20013;&#27490;&#27169;&#24335;(Und)</td><td>6</td><td>&#24403;CPU&#25110;&#32773;&#21327;&#22788;&#29702;&#22120;&#36935;&#21040;&#26080;&#27861;&#22788;&#29702;&#30340;&#25351;&#20196;&#26102;&#65292;&#20135;&#29983;&#26410;&#23450;&#20041;&#25351;&#20196;&#24322;&#24120;&#12290;</td></tr><tr><td>0x08</td><td>&#36719;&#20214;&#20013;&#26029;(SWI)</td><td>&#29305;&#26435;&#27169;&#24335;(SVC)</td><td>6</td><td>swi&#25351;&#20196;&#20135;&#29983;&#65292;&#29992;&#20110;&#29992;&#25143;&#27169;&#24335;&#19979;&#30340;&#31995;&#32479;&#35843;&#29992;&#12290;</td></tr><tr><td>0x0c</td><td>&#25351;&#20196;&#39044;&#21462;&#32456;&#27490;(Prefetch Abort)</td><td>&#20013;&#27490;&#27169;&#24335;(Abt)</td><td>5</td><td>&#35775;&#38382;&#25351;&#20196;&#22320;&#22336;&#24322;&#24120;</td></tr><tr><td>0x10</td><td>&#25968;&#25454;&#35775;&#38382;&#32456;&#27490;(Data Abort)</td><td>&#20013;&#27490;&#27169;&#24335;(Abt)</td><td>2</td><td>&#35775;&#38382;&#25968;&#25454;&#31354;&#38388;&#24322;&#24120;</td></tr><tr><td>0x14</td><td>&#39044;&#30041;</td><td> </td><td> </td><td class="auto-generated"> </td></tr><tr><td>0x18</td><td>&#22806;&#37096;&#20013;&#26029;&#35831;&#27714;(IRQ)</td><td>&#22806;&#37096;&#20013;&#26029;&#27169;&#24335;(IRQ)</td><td>4</td><td>&#24403;IRQ&#35831;&#27714;&#24341;&#33050;&#26377;&#25928;&#65292;&#19988;CPSR&#20013;&#30340;I&#20301;&#20026;0&#65292;&#20135;&#29983;IRQ&#24322;&#24120;</td></tr><tr><td>0x1c</td><td>&#24555;&#36895;&#32456;&#31471;&#35831;&#27714;(FIQ)</td><td>&#24555;&#36895;&#20013;&#26029;&#27169;&#24335;(FIQ)</td><td>3</td><td>&#24403;FIR&#35831;&#27714;&#24341;&#33050;&#26377;&#25928;&#65292;&#19988;CPSR&#20013;&#30340;F&#20301;&#20026;0&#65292;&#20135;&#29983;FIQ&#24322;&#24120;</td></tr></tbody></table>
</div></div><p><br class="table-break">
ARM&#20013;&#65292;&#26159;&#21542;&#25903;&#25345;IRQ&#21644;FIQ&#20013;&#26029;&#36824;&#19982;CP15&#25511;&#21046;&#23492;&#23384;&#22120;&#20013;&#30340;&#20013;&#26029;&#25511;&#21046;&#20301;&#26377;&#20851;&#12290;&#21478;&#22806;&#20013;&#26029;&#21521;&#37327;&#30340;&#22320;&#22336;&#30001;&#22522;&#22336;+Exception_Vector_Address&#20915;&#23450;&#65292;&#32780;&#22522;&#22320;&#21017;&#26377;CPSR&#30340;&#31532;13&#20301;CR_V&#20915;&#23450;&#26159;0&#36824;&#26159;0xffff0000&#12290;
</p>
</div>
<div class="sect2" title="16.2. CPU&#22788;&#29702;"><div class="titlepage"><div><div><h3 class="title"><a name="idp81211868"></a>16.2. CPU&#22788;&#29702;</h3></div></div></div>
<p>
&#20013;&#26029;&#21457;&#29983;&#26102;&#65292;&#22312;&#30828;&#20214;&#23618;&#38754;ARM CPU&#20250;&#33258;&#21160;&#20570;&#20197;&#19979;&#24037;&#20316;&#65306;1&#12290;&#23558;&#20445;&#23384;&#30340;SPSR&#31227;&#21040;&#21457;&#29983;&#20013;&#26029;&#30340;&#27169;&#24335;&#19979;&#30340;CPSR&#20013;&#65292;R14&#31227;&#20837;&#21040;PC&#20013;&#12290;&#36825;&#21487;&#20197;&#36890;&#36807;&#65306;
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">&#21547;S&#30340;&#25968;&#25454;&#22788;&#29702;&#25351;&#20196;&#65292;&#23558;&#30446;&#26631;&#23492;&#23384;&#22120;&#25351;&#23450;&#20026;PC&#12290;</li><li class="listitem">&#36890;&#36807;LDM&#25351;&#20196;</li></ul></div><p>
</p>
<p>
<span class="emphasis"><em>1.</em></span>&#39318;&#20808;&#23558;&#20013;&#26029;&#22788;&#29702;&#27169;&#24335;&#30340;R14&#23492;&#23384;&#22120;&#20445;&#23384;&#20026;&#24403;&#21069;&#27169;&#24335;&#30340;&#19979;&#19968;&#26465;&#25351;&#20196;<sup>[<a name="idp81223284" href="#ftn.idp81223284" class="footnote">10</a>]</sup>&#12290;&#25509;&#30528;&#23558;&#24403;&#21069;&#27169;&#24335;&#30340;CPSR&#20445;&#23384;&#21040;&#20013;&#26029;&#22788;&#29702;&#27169;&#24335;&#30340;SPSR&#20013;&#12290;
</p><pre class="programlisting">
R14_&lt;exception_mode&gt; = return link
SPSR_&lt;exception_mode&gt; = CPSR
</pre><p>
<span class="emphasis"><em>2.</em></span>&#35774;&#32622;CPSR&#30340;&#27169;&#24335;&#25511;&#21046;&#20301;M[4:0]&#21040;&#20013;&#26029;&#22788;&#29702;&#27169;&#24335;&#65292;&#21516;&#26102;&#35774;&#32622;&#25351;&#20196;&#38598;T&#26631;&#24535;&#20301;&#20026;0&#65292;&#30830;&#20445;&#22788;&#29702;&#20013;&#26029;&#30340;&#25351;&#20196;&#24037;&#20316;&#22312;ARM&#25351;&#20196;&#38598;&#19979;&#12290;
</p><pre class="programlisting">
CPSR[4:0] = exception mode number
CPSR[5] = 0 /* Execute in ARM state */
</pre><p>
<span class="emphasis"><em>3.</em></span>&#26681;&#25454;&#21457;&#29983;&#30340;&#20013;&#26029;&#65292;&#26469;&#23631;&#34109;&#25481;&#35813;&#20013;&#26029;&#12290;&#22914;&#26524;&#26159;Reset/FIQ&#20013;&#26029;&#65292;&#21017;&#23631;&#34109;F&#24555;&#36895;&#20013;&#26029;&#20301;&#12290;&#25509;&#30528;&#23631;&#34109;I&#20013;&#26029;&#20301;&#12290;
</p><pre class="programlisting">
if &lt;exception_mode&gt; == Reset or FIQ then
    CPSR[6] = 1 /* Disable fast interrupts */
/* else CPSR[6] is unchanged */

CPSR[7] = 1 /* Disable normal interrupts */
</pre><p>
&#22914;&#26524;&#19981;&#26159;&#26410;&#23450;&#20041;&#25351;&#20196;&#25110;&#32773;&#36719;&#20013;&#26029;&#65292;&#37027;&#20040;&#23631;&#34109;&#25481;A&#26631;&#24535;&#20301;&#12290;&#25509;&#30528;&#25335;&#36125;&#21327;&#22788;&#29702;&#22120;Secure Control Register bit[25]&#23383;&#33410;&#24207;&#20301;CP15_reg1_EEbit&#21040;E&#26631;&#24535;&#20301;&#12290;
</p><pre class="programlisting">
if &lt;exception_mode&gt; != UNDEF or SWI then
    CPSR[8] = 1 /* Disable imprecise aborts (v6 only) */
/* else CPSR[8] is unchanged */

CPSR[9] = CP15_reg1_EEbit /* Endianness on exception entry */
</pre><p>
<span class="emphasis"><em>4.</em></span>&#23558;PC&#25351;&#21521;&#20013;&#26029;&#21521;&#37327;&#20837;&#21475;&#12290;
</p><pre class="programlisting">
PC = exception vector address
</pre><p>
</p>
<p>
&#20013;&#26029;&#22788;&#29702;&#36807;&#31243;&#24635;&#32467;&#22914;&#19979;&#65306;
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">&#23558;&#38142;&#25509;&#23492;&#23384;&#22120;LR_mode(R14)&#35774;&#32622;&#25104;&#36820;&#22238;&#22320;&#22336;&#65292;R14&#20174;R15(pc)&#20013;&#24471;&#21040;&#19979;&#19968;&#26465;&#23558;&#35201;&#25191;&#34892;&#30340;&#25351;&#20196;&#22320;&#22336;&#12290;</li><li class="listitem">&#20445;&#23384;&#22788;&#29702;&#22120;&#24403;&#21069;&#29366;&#24577;&#65292;&#20013;&#26029;&#23631;&#34109;&#20301;&#20197;&#21450;&#21508;&#26465;&#20214;&#26631;&#24535;&#20301;&#12290;</li><li class="listitem">&#35774;&#32622;&#24403;&#21069;&#31243;&#24207;cpsr&#20013;&#30456;&#24212;&#30340;&#20301;&#65306;&#35774;&#32622;&#25511;&#21046;&#20301;&#65292;&#20351;&#22788;&#29702;&#22120;&#36827;&#20837;&#30456;&#24212;&#30340;&#25191;&#34892;&#27169;&#24335;&#65307;&#35774;&#32622;&#30340;F&#20301;&#65292;&#31105;&#27490;FIQ&#65307;&#35774;&#32622;I&#20301;&#65292;&#31105;&#27490;IRQ&#20013;&#26029;&#12290;</li><li class="listitem">&#23558;&#31243;&#24207;&#35745;&#25968;&#22120;&#20540;pc&#35774;&#32622;&#25104;&#35813;&#20013;&#26029;&#30340;&#20013;&#26029;&#21521;&#37327;&#22320;&#22336;&#65292;&#20174;&#32780;&#36339;&#36716;&#21040;&#30456;&#24212;&#30340;&#20013;&#26029;&#22788;&#29702;&#31243;&#24207;&#22788;&#25191;&#34892;&#12290;</li></ul></div><p>
&#20851;&#20110;&#23427;&#20204;&#30340;&#35814;&#32454;&#20266;&#20195;&#30721;&#25551;&#36848;&#65292;&#35831;&#21442;&#32771;ARM1176JZF-S R0P7 Technical Reference Manual.pdf&#30340;P155&#12290;
</p>
<p>
&#24403;&#19968;&#20010;&#20013;&#26029;&#24322;&#24120;&#22788;&#29702;&#21518;&#65292;&#23558;&#25191;&#34892;&#20197;&#19979;&#25805;&#20316;&#20197;&#20174;&#20013;&#26029;&#24322;&#24120;&#22788;&#29702;&#31243;&#24207;&#20013;&#36820;&#22238;&#65306;
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">&#20174;&#30456;&#24212;&#27169;&#24335;&#30340;spsr&#23492;&#23384;&#22120;&#20013;&#24674;&#22797;cpsr&#23492;&#23384;&#22120;&#20869;&#23481;&#12290;</li><li class="listitem">&#20174;&#30456;&#24212;&#27169;&#24335;&#30340;&#38142;&#25509;&#23492;&#23384;&#22120;lr&#20013;&#24674;&#22797;pc&#23492;&#23384;&#22120;&#20197;&#20351;&#31243;&#24207;&#20174;&#20013;&#26029;&#22788;&#37325;&#26032;&#25191;&#34892;&#12290;</li></ul></div><p> 
&#22914;&#26524;&#22312;&#36827;&#20837;&#20013;&#26029;&#26102;&#27809;&#26377;&#20351;&#29992;&#26632;&#31354;&#38388;&#26469;&#23384;&#20648;&#26222;&#36890;&#23492;&#23384;&#22120;&#25968;&#25454;&#65292;&#21017;&#21482;&#38656;&#25191;&#34892;&#20197;&#19978;&#20004;&#27493;&#21363;&#21487;&#12290;&#22914;&#26524;&#20351;&#29992;&#20102;&#26632;&#26469;&#23384;&#20648;&#26222;&#36890;&#23492;&#23384;&#22120;&#25968;&#25454;&#65292;&#21017;&#38656;&#35201;&#36827;&#34892;&#30456;&#21453;&#30340;&#20986;&#26632;&#25351;&#20196;&#65292;&#36890;&#20135;&#22914;&#20197;&#19979;&#25351;&#20196;&#37325;&#26032;&#21152;&#36733;&#36825;&#20123;&#25968;&#25454;&#65306;
</p><pre class="programlisting">
ldmfd sp!,{r0-r12, pc}^
</pre><p>
&#20197;&#19978;&#25351;&#20196;&#23558;&#20174;&#22534;&#26632;&#23492;&#23384;&#22120;&#25152;&#25351;&#30340;&#26632;&#31354;&#38388;&#24674;&#22797;r0-r12&#23492;&#23384;&#22120;&#30340;&#25968;&#25454;&#65292;&#24182;&#20174;lr&#23492;&#23384;&#22120;&#24674;&#22797;pc&#23492;&#23384;&#22120;&#65292;&#20174;spsr_mod&#20013;&#24674;&#22797;cpsr&#23492;&#23384;&#22120;&#12290;
</p>
</div>
<div class="sect2" title="16.3. &#20013;&#26029;&#21521;&#37327;"><div class="titlepage"><div><div><h3 class="title"><a name="irq_vector"></a>16.3. &#20013;&#26029;&#21521;&#37327;</h3></div></div></div>
<div class="figure"><a name="idp81231468"></a><p class="title"><b>&#22270; 83. IRQ&#20013;&#26029;&#22788;&#29702;&#27969;&#31243;</b></p><div class="figure-contents"><div><img src="images/irq_flow.gif" alt="IRQ&#20013;&#26029;&#22788;&#29702;&#27969;&#31243;"></div></div></div><br class="figure-break">
&#22914;&#19978;&#22270;&#25152;&#31034;&#65292;&#20174;&#30828;&#20214;&#21457;&#29983;&#20013;&#26029;&#65292;&#39318;&#20808;&#30001;ARM CPU&#36827;&#34892;&#22788;&#29702;&#65292;&#26368;&#32456;pc&#25351;&#38024;&#23558;&#36339;&#36716;&#21040;&#20013;&#26029;&#21521;&#37327;vector_irq&#20013;&#32487;&#32493;&#25191;&#34892;&#65292;&#28982;&#21518;&#26681;&#25454;&#24403;&#21069;&#30340;&#20013;&#26029;&#21644;&#25152;&#22788;&#30340;&#24037;&#20316;&#27169;&#24335;&#20998;&#21035;&#35843;&#29992;__irq_usr&#65292;__irq_svc&#21644;irq_invalid&#12290;&#26368;&#32456;&#30340;&#22788;&#29702;&#22343;&#30001;&#32479;&#19968;&#30340;&#25509;&#21475;&#20989;&#25968;asm_do_IRQ&#26469;&#22788;&#29702;&#12290;
<p>
&#25152;&#26377;&#21517;&#20026;vector_xxx&#30340;&#20013;&#26029;&#21521;&#37327;&#24182;&#19981;&#26159;&#30452;&#25509;&#23450;&#20041;&#65292;&#32780;&#26159;&#36890;&#36807;&#21517;&#20026;vector_stub&#30340;&#23439;&#26469;&#23436;&#25104;&#12290;&#23427;&#26377;&#19977;&#20010;&#21442;&#25968;&#65292;name&#34920;&#31034;&#23450;&#20041;&#30340;&#20013;&#26029;&#21521;&#37327;&#21517;&#65307;mode&#21017;&#25351;&#26126;CPU&#22788;&#29702;&#35813;&#20013;&#26029;&#25152;&#22788;&#30340;&#27169;&#24335;&#65307;correction&#21017;&#29992;&#26469;&#23545;&#36820;&#22238;pc&#30340;lr&#23492;&#23384;&#22120;&#36827;&#34892;&#20462;&#27491;&#65292;&#19981;&#21516;&#30340;&#20013;&#26029;&#31867;&#22411;lr&#20013;&#23384;&#20648;&#30340;&#30340;&#25351;&#20196;&#21487;&#33021;&#24182;&#38750;&#30456;&#23545;&#20110;&#24403;&#21069;pc&#30340;&#19979;&#19968;&#26465;&#25351;&#20196;&#12290;
</p><div class="table"><a name="idp81232668"></a><p class="title"><b>&#34920; 27. &#20013;&#26029;&#38142;&#25509;&#23492;&#23384;&#22120;</b></p><div class="table-contents">
<table summary="&#20013;&#26029;&#38142;&#25509;&#23492;&#23384;&#22120;" border="1"><colgroup><col><col><col></colgroup><thead><tr><th>&#20013;&#26029;&#31867;&#22411;</th><th>lr</th><th>spsr</th></tr></thead><tbody><tr><td>&#22797;&#20301;(Reset)</td><td>&#19981;&#30830;&#23450;</td><td>&#19981;&#30830;&#23450;</td></tr><tr><td>&#26410;&#23450;&#20041;&#25351;&#20196;(Und)</td><td>Undefined Instruction + 4</td><td>cpsr</td></tr><tr><td>&#36719;&#20013;&#26029;(swi)</td><td>swi Instruction + 4</td><td>cpsr</td></tr><tr><td>&#25351;&#20196;&#39044;&#21462;&#32456;&#27490;(Prefetch Abort)</td><td>Aborted Instruction + 4</td><td>cpsr</td></tr><tr><td>&#25968;&#25454;&#35775;&#38382;&#32456;&#27490;(Data Abort)</td><td>Aborted Instruction + 8</td><td>cpsr</td></tr><tr><td>&#22806;&#37096;&#20013;&#26029;&#35831;&#27714;(IRQ)</td><td>Next instruction + 4</td><td>cpsr</td></tr><tr><td>&#24555;&#36895;&#32456;&#31471;&#35831;&#27714;(FIQ)</td><td>Next instruction + 4</td><td>cpsr</td></tr></tbody></table>
</div></div><p><br class="table-break">
&#31995;&#32479;&#36890;&#36807;vector_stub&#23450;&#20041;&#20102;vector_irq&#65292;vector_dabt&#65292;vector_pabt&#21644;vector_und&#21521;&#37327;&#12290;&#23427;&#20204;&#30340;&#26368;&#21518;&#19968;&#20010;&#21442;&#25968;&#26681;&#25454;&#19978;&#34920;&#20013;&#30340;lr&#23492;&#23384;&#22120;&#20540;&#29992;&#26469;&#23545;&#36820;&#22238;&#26102;&#30340;pc&#36827;&#34892;&#20462;&#27491;&#12290;
</p><pre class="programlisting">
	vector_stub	irq, IRQ_MODE, 4
	vector_stub	dabt, ABT_MODE, 8
	vector_stub	pabt, ABT_MODE, 4
	vector_stub	und, UND_MODE
</pre><p>
&#20294;&#26159;vector_fiq&#21644;vector_swi&#24182;&#27809;&#26377;&#30452;&#25509;&#36890;&#36807;vector_stub&#36827;&#34892;&#23450;&#20041;&#65292;&#36825;&#26159;&#30001;&#20110;&#36825;&#31867;&#20013;&#26029;&#30340;&#29305;&#27530;&#24615;&#20915;&#23450;&#30340;&#65292;&#21518;&#38754;&#23558;&#20250;&#36827;&#19968;&#27493;&#20998;&#26512;&#23427;&#20204;&#12290;
</p><pre class="programlisting">
	.macro	vector_stub, name, mode, correction=0
	.align	5

vector_\name:
	.if \correction
	sub	lr, lr, #\correction
	.endif
</pre><p>
&#39318;&#20808;&#26681;&#25454;correction&#30340;&#20540;&#20462;&#27491;&#36820;&#22238;&#22320;&#22336;lr&#12290;&#27880;&#24847;&#21462;&#25968;&#25454;&#24322;&#24120;&#26102;&#65292;lr&#23384;&#25918;&#30340;&#26159;&#35813;&#26465;&#24322;&#24120;&#25351;&#20196;&#21152;8&#65292;&#22312;&#20013;&#26029;&#22788;&#29702;&#21518;&#24212;&#35813;&#37325;&#26032;&#36827;&#34892;&#21462;&#25968;&#25454;&#65292;&#25152;&#20197;&#20462;&#27491;&#20540;&#20026;8&#65292;&#20854;&#20182;&#27169;&#24335;&#20381;&#27425;&#31867;&#25512;&#12290;
</p><pre class="programlisting">
	@
	@ Save r0, lr_&lt;exception&gt; (parent PC) and spsr_&lt;exception&gt;
	@ (parent CPSR)
	@
	stmia	sp, {r0, lr}		@ save r0, lr
	mrs	lr, spsr
	str	lr, [sp, #8]		@ save spsr
</pre><p>
&#20445;&#23384;r0&#65292;&#24403;&#21069;&#27169;&#24335;&#30340;lr&#65292;spsr&#23492;&#23384;&#22120;&#21040;&#22788;&#29702;&#20013;&#26029;&#30340;&#26632;&#20013;&#65292;&#27604;&#22914;IRQ&#30340;&#22534;&#26632;&#12290;&#21478;&#22806;lr&#27492;&#26102;&#20445;&#23384;&#20102;&#21018;&#21018;&#36827;&#20837;&#26102;&#30340;spsr_mod&#20540;&#65292;&#20063;&#21363;&#21457;&#29983;&#20013;&#26029;&#30340;&#27169;&#24335;&#30340;cpsr&#30340;&#20540;&#12290;
</p><pre class="programlisting">
	@
	@ Prepare for SVC32 mode.  IRQs remain disabled.
	@
	mrs	r0, cpsr
	eor	r0, r0, #(\mode ^ SVC_MODE)
	msr	spsr_cxsf, r0
</pre><p>
&#39318;&#20808;&#35835;&#21462;cpsr&#21040;r0&#65292;&#28982;&#21518;&#36923;&#36753;&#24322;&#25110;&#25351;&#20196;eor&#23558;&#20256;&#20837;&#30340;&#27169;&#24335;&#24322;&#25110;SVC_MODE&#65292;&#24182;&#26681;&#25454;&#32467;&#26524;&#26469;&#25805;&#20316;spsr&#23492;&#23384;&#22120;&#20013;&#30340;C,X,S&#21644;F&#20301;&#12290;&#36825;&#20010;&#25805;&#20316;&#23558;&#21487;&#20197;&#39564;&#35777;&#24403;&#21069;&#27169;&#24335;&#26159;&#22312;&#36866;&#24403;&#30340;&#20013;&#26029;&#27169;&#24335;&#19979;&#26469;&#22788;&#29702;&#23545;&#24212;&#30340;&#20013;&#26029;&#65292;&#25509;&#30528;&#20999;&#25442;&#21040;&#20013;&#26029;&#22788;&#29702;&#30340;ISP&#24037;&#20316;&#29366;&#24577;&#22312;SVC&#19979;&#27169;&#24335;&#19979;&#12290;&#29702;&#35770;&#19978;&#23558;&#65292;&#27492;&#26102;cpsr&#30340;&#27169;&#24335;&#20301;&#24212;&#35813;&#23545;&#24212;&#21040;mode&#20256;&#36882;&#27169;&#24335;&#20301;&#65292;&#21478;&#22806;&#24322;&#25110;&#36816;&#31639;&#26159;&#21487;&#20197;&#20132;&#25442;&#20301;&#32622;&#30340;&#65292;&#20063;&#21363;A^B^C&#31561;&#20215;&#20110;A^C^B&#12290;&#25152;&#20197;&#36825;&#37324;&#30340;r0^(mode^SVC_MODE)&#31561;&#20215;&#20110;r0^mode^SVC_MODE&#65292;&#30001;&#20110;r0&#30340;&#20302;5&#20301;&#27169;&#24335;&#20301;&#19982;mode&#30456;&#21516;&#65292;&#25152;&#20197;r0^mode&#30340;&#36816;&#31639;&#32467;&#26524;&#30340;&#20302;5&#20301;&#20840;&#34987;&#28165;&#38646;&#65292;&#28982;&#21518;&#20877;^SVC_MODE&#65292;&#20063;&#21363;&#20302;5&#20301;&#34987;&#35774;&#32622;&#20026;SVC_MODE&#65292;&#20854;&#23427;&#20301;&#20445;&#25345;&#19981;&#21464;&#12290;eor&#36825;&#34892;&#25351;&#20196;&#30456;&#24403;&#20110;&#20197;&#19979;&#25351;&#20196;&#65292;&#20294;&#26159;&#35813;&#25351;&#20196;&#26080;&#24418;&#20013;&#26816;&#26597;&#20102;mode&#21442;&#25968;&#30340;&#27491;&#30830;&#24615;&#12290;IRQ&#20013;&#26029;&#22788;&#29702;&#26102;&#30340;cpsr&#21644;spsr&#23492;&#23384;&#22120;&#30340;&#27169;&#24335;&#20301;&#22914;&#19979;&#25152;&#31034;&#65292;&#26174;&#28982;cpsr&#20013;&#30340;I&#20301;&#26159;&#23631;&#34109;&#25481;&#30340;&#65306;
</p><pre class="programlisting">
	and	r0, r0, #0xffffffe0 @~SVC_MODE
	orr	r0, r0, #SVC_MODE

    31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10  9  8  7  6  5  4  3  2  1  0
     N  Z  C  V  Q        J              |  E  G  |       CV           E  A  I  F  T M4 M3 M2 M1 M0
cpsr 0  1  1  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  1  1  0  0  1  0  0  1  1
spsr 0  1  1  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  1  0  0  0  1  0  0  1  1	
</pre><p>
msr&#25351;&#20196;&#25913;&#21464;&#20102;spsr&#23492;&#23384;&#22120;&#30340;&#27169;&#24335;&#20301;&#65292;&#36825;&#20026;&#25509;&#19979;&#26469;&#30340;&#27169;&#24335;&#20999;&#25442;&#20570;&#20934;&#22791;&#12290;
</p><pre class="programlisting">
	@
	@ the branch table must immediately follow this code
	@
	and	lr, lr, #0x0f
	mov	r0, sp
	ldr	lr, [pc, lr, lsl #2]
	movs	pc, lr			@ branch to handler in SVC mode
ENDPROC(vector_\name)
	.endm
</pre><p>
&#39318;&#20808;&#25552;&#21462;&#21457;&#29983;&#20013;&#26029;&#30340;&#27169;&#24335;&#65292;&#26174;&#28982;&#21482;&#38656;&#25552;&#21462;&#26368;&#21518;&#22235;&#20301;&#21363;&#21487;&#12290;&#28982;&#21518;ldr&#26681;&#25454;&#36825;&#21518;&#22235;&#20301;&#30830;&#23450;&#35843;&#29992;&#19981;&#21516;&#30340;&#20013;&#26029;&#22788;&#29702;&#23376;&#31243;&#24207;&#12290;&#36339;&#36716;&#30340;&#22522;&#20934;&#22320;&#22336;&#20026;&#24403;&#21069;pc&#65292;&#22240;&#20026;ARMv4&#26159;&#19977;&#32423;&#27969;&#27700;&#32447;&#32467;&#26500;&#30340;&#65292;&#23427;&#24635;&#26159;&#25351;&#21521;&#24403;&#21069;&#25351;&#20196;&#30340;&#19979;&#20004;&#26465;&#25351;&#20196;&#30340;&#22320;&#22336;&#65292;&#23613;&#31649;&#20197;&#21518;&#29256;&#26412;&#30340;&#25351;&#20196;&#27969;&#27700;&#32447;&#25193;&#23637;&#20026;5&#32423;&#21644;8&#32423;&#65292;&#20294;&#26159;&#36825;&#19968;&#29305;&#24615;&#19968;&#30452;&#34987;&#20860;&#23481;&#22788;&#29702;&#65292;&#20063;&#21363;pc(excute)= pc(fetch) + 8&#65292;&#20854;&#20013;&#65306;pc(fetch)&#65306;&#24403;&#21069;&#27491;&#22312;&#25191;&#34892;&#30340;&#25351;&#20196;&#65292;&#23601;&#26159;&#20043;&#21069;&#21462;&#35813;&#25351;&#20196;&#26102;&#20505;&#30340;PC&#30340;&#20540;&#65307;pc(execute)&#65306;&#24403;&#21069;&#25351;&#20196;&#25191;&#34892;&#30340;&#35745;&#31639;&#20013;&#65292;&#22914;&#26524;&#29992;&#21040;pc&#65292;&#21017;&#27492;&#26102;pc&#30340;&#20540;&#12290;
&#12290;&#36339;&#36716;&#22686;&#21152;&#30340;&#25351;&#20196;&#22320;&#22336;&#30001;&#27169;&#24335;&#21518;&#22235;&#20301;&#20056;&#20197;4&#20915;&#23450;&#12290;&#25509;&#30528;&#27880;&#24847;r0&#20445;&#23384;&#20102;&#22534;&#26632;&#22320;&#22336;&#12290;&#26368;&#37325;&#35201;&#30340;&#19968;&#28857;&#26159;movs&#25351;&#20196;&#65292;&#23427;&#30340;&#20316;&#29992;&#20043;&#19968;&#26159;&#36339;&#36716;&#21040;&#23545;&#24212;&#30340;&#20013;&#26029;&#22788;&#29702;&#23376;&#31243;&#24207;&#20013;&#65292;&#20294;&#26159;&#27880;&#24847;&#21040;s&#26631;&#24535;&#65292;&#22914;&#26524;&#25351;&#23450;&#20102;&#35813;&#26631;&#24535;&#65292;&#24182;&#19988;&#30446;&#26631;&#23492;&#23384;&#22120;&#26159;pc&#65292;&#37027;&#20040;spsr&#23492;&#23384;&#22120;&#30340;&#20869;&#23481;&#23558;&#34987;&#22797;&#21046;&#21040;cpsr&#20013;&#65292;&#25152;&#20197;&#36825;&#26465;&#25351;&#20196;&#21516;&#26102;&#23436;&#25104;&#20102;&#27169;&#24335;&#20999;&#25442;&#12290;
</p><div class="figure"><a name="idp81244916"></a><p class="title"><b>&#22270; 84. IRQ&#20013;&#26029;&#22788;&#29702;&#36339;&#36716;&#31034;&#24847;&#22270;</b></p><div class="figure-contents"><div><img src="images/inter_irq.gif" alt="IRQ&#20013;&#26029;&#22788;&#29702;&#36339;&#36716;&#31034;&#24847;&#22270;"></div></div></div><p><br class="figure-break">
</p><pre class="programlisting">
arch/arm/include/asm/ptrace.h
#define USR_MODE        0x00000010
#define FIQ_MODE        0x00000011
#define IRQ_MODE        0x00000012
#define SVC_MODE        0x00000013
#define ABT_MODE        0x00000017

 1    0    0    0    0     User &#27169;&#24335;
 1    0    0    0    1     FIQ &#27169;&#24335;
 1    0    0    1    0     IRQ &#27169;&#24335;
 1    0    0    1    1     SVC &#27169;&#24335;
 1    0    1    1    1     ABT &#27169;&#24335;
 1    1    0    1    1     UND &#27169;&#24335;
</pre><p>
&#22914;&#26524;&#36827;&#20837;&#20013;&#26029;&#21069;&#26159;usr&#65292;&#21017;&#21462;&#20986;pc + 4*0&#30340;&#20869;&#23481;&#65292;&#21363;__irq_usr&#65292;&#22914;&#26524;&#36827;&#20837;&#20013;&#26029;&#21069;&#26159;svc&#65292;&#21017;&#21462;&#20986;PC + 4 * 3&#30340;&#20869;&#23481;&#65292;&#21363;__irq_svc&#12290;movs&#29992;&#26469;&#23454;&#29616;&#30495;&#27491;&#30340;&#36339;&#36716;&#65292;&#24182;&#24433;&#21709;&#26631;&#24535;&#20301;&#12290;
</p><pre class="programlisting">
	vector_stub	irq, IRQ_MODE, 4
	.long	__irq_usr			@  0  (USR_26 / USR_32)
	.long	__irq_invalid			@  1  (FIQ_26 / FIQ_32)
	.long	__irq_invalid			@  2  (IRQ_26 / IRQ_32)
	.long	__irq_svc			@  3  (SVC_26 / SVC_32)	
</pre><p>
&#21453;&#32534;&#35793;&#21518;&#30340;&#27719;&#32534;&#20195;&#30721;&#22914;&#19979;&#12290;&#27880;&#24847;&#22312;ldr&#25351;&#20196;&#20013;&#65292;pc&#23454;&#38469;&#30340;&#20540;&#24050;&#32463;&#25351;&#21521;&#20102;c000eb4c&#22320;&#22336;&#12290;
</p><pre class="programlisting">
c000eb3c:       e20ee00f        and     lr, lr, #15     ; 0xf
c000eb40:       e1a0000d        mov     r0, sp
c000eb44:       e79fe10e        ldr     lr, [pc, lr, lsl #2]
c000eb48:       e1b0f00e        movs    pc, lr
c000eb4c:       c002dc40        .word   0xc002dc40
c000eb50:       c002d9e0        .word   0xc002d9e0
c000eb54:       c002d9e0        .word   0xc002d9e0
c000eb58:       c002da80        .word   0xc002da80
</pre><p>
&#22312;&#27492;&#26102;&#65292;CPU&#24037;&#20316;&#20110;svc&#27169;&#24335;&#65292;&#20063;&#21363;&#20869;&#26680;&#20195;&#30721;&#24037;&#20316;&#30340;&#27169;&#24335;&#65292;&#25152;&#20197;&#36825;&#37324;&#23558;&#20511;&#29992;&#24403;&#21069;&#36827;&#31243;&#30340;&#22534;&#26632;&#65292;&#24403;&#21069;&#36827;&#31243;&#21487;&#20197;&#26159;&#20869;&#26680;&#32447;&#31243;&#20063;&#21487;&#20197;&#26159;&#29992;&#25143;&#36827;&#31243;&#65292;&#20294;&#26159;&#21482;&#35201;&#26159;&#22312;&#35813;&#36827;&#31243;&#36816;&#34892;&#26102;&#21457;&#29983;&#30340;&#20013;&#26029;&#65292;&#20869;&#26680;&#37117;&#23558;&#20511;&#29992;&#23427;&#30340;&#22534;&#26632;&#12290;&#20851;&#20110;&#36827;&#31243;&#22534;&#26632;&#30340;&#21021;&#22987;&#21270;&#35265;<a class="xref" href="ar01s08.html#zero_task">&#31532; 8.6 &#33410; &#8220;0&#21495;&#36827;&#31243;&#8221;</a>&#21644;<a class="xref" href="ar01s11.html#cpu_init" title="11.2. cpu_init">&#31532; 11.2 &#33410; &#8220;cpu_init&#8221;</a>&#20197;&#21450;&#36827;&#31243;&#21019;&#24314;&#31456;&#33410;&#12290;&#22312;&#36827;&#20837;&#20998;&#25903;&#22788;&#29702;&#20043;&#21069;&#65292;&#27492;&#26102;&#30340;&#22534;&#26632;&#22914;&#19979;&#25152;&#31034;&#65292;&#27880;&#24847;&#21040;&#20013;&#26029;&#22788;&#29702;&#20250;&#21516;&#26102;&#20351;&#29992;&#20004;&#20010;&#27169;&#24335;&#30340;&#22534;&#26632;&#65292;&#19968;&#20010;&#26159;&#20013;&#26029;&#23545;&#24212;&#30340;&#27169;&#24335;&#30340;&#22534;&#26632;&#65292;&#19968;&#20010;&#26159;SVC&#27169;&#24335;&#30340;&#22534;&#26632;&#12290;
</p><div class="figure"><a name="idp81249084"></a><p class="title"><b>&#22270; 85. &#20013;&#26029;&#20013;&#30340;&#22534;&#26632;</b></p><div class="figure-contents"><div><img src="images/int_stack.gif" alt="&#20013;&#26029;&#20013;&#30340;&#22534;&#26632;"></div></div></div><p><br class="figure-break">
</p>
<div class="sect3" title="16.3.1. __irq_usr"><div class="titlepage"><div><div><h4 class="title"><a name="idp81249644"></a>16.3.1. __irq_usr</h4></div></div></div>
&#27880;&#24847;&#29992;&#25143;&#27169;&#24335;&#21457;&#29983;&#20013;&#26029;&#26102;&#30340;&#22788;&#29702;&#65292;&#39318;&#20808;&#20351;&#29992;IRQ/ABT&#31561;&#20013;&#26029;&#27169;&#24335;&#30340;&#20013;&#26029;&#20445;&#23384;&#20013;&#26029;&#26102;&#30340;r0,lr&#21644;cpsr&#65292;&#22240;&#20026;&#20511;&#29992;SVC&#27169;&#24335;&#30340;&#36827;&#34892;ISP&#22788;&#29702;&#65292;&#25152;&#20197;&#20445;&#23384;&#25152;&#26377;SVC&#27169;&#24335;&#23492;&#23384;&#22120;&#21040;SVC&#22534;&#26632;&#65292;&#26368;&#21518;&#25165;&#21435;&#35843;&#29992;ISP&#12290;
<pre class="programlisting">
  .align 5
__irq_usr:
	usr_entry
	......
</pre>
&#27880;&#24847;align&#35821;&#21477;&#65292;&#20013;&#26029;&#22788;&#29702;&#31243;&#24207;&#30340;&#20837;&#21475;&#37117;&#26159;32&#20301;&#23545;&#40784;&#30340;&#12290;__irq_usr&#22312;&#22788;&#29702;&#30340;&#24320;&#22987;&#39318;&#20808;&#35843;&#29992;usr_entry&#23439;&#65292;&#23427;&#26159;&#19968;&#20010;&#38750;&#24120;&#36890;&#29992;&#30340;&#23439;&#23450;&#20041;&#65292;&#29992;&#26469;&#21021;&#22987;&#21270;&#22312;&#29992;&#25143;&#27169;&#24335;&#19979;&#21457;&#29983;&#20013;&#26029;&#22788;&#29702;&#26102;&#30340;&#22534;&#26632;&#65292;&#24182;&#20445;&#23384;&#25152;&#26377;SVC&#24577;&#30340;&#23492;&#23384;&#22120;&#21040;&#22534;&#26632;&#12290;
<pre class="programlisting">
arch/arm/include/asm/ptrace.h
struct pt_regs {
        long uregs[18];
};
#define ARM_cpsr        uregs[16]
#define ARM_pc          uregs[15]
#define ARM_lr          uregs[14]
#define ARM_sp          uregs[13]
#define ARM_ip          uregs[12]
#define ARM_fp          uregs[11]
#define ARM_r10         uregs[10]
  ......
#define ARM_r0          uregs[0]
#define ARM_ORIG_r0     uregs[17]
</pre>
&#30001;&#20110;&#24403;&#21069;&#26159;svc&#27169;&#24335;&#65292;&#25152;&#20197;&#36825;&#37324;&#20351;&#29992;&#30340;&#26159;&#20869;&#26680;0&#32447;&#31243;&#26632;&#12290;S_FRAME_SIZE&#34987;&#23450;&#20041;&#20026;sizeof(struct pt_regs)&#30340;&#22823;&#23567;&#12290;&#25152;&#20197;&#36825;&#37324;&#23581;&#35797;&#22312;&#22534;&#26632;&#19978;&#20998;&#37197;&#19968;&#20010;struct pt_regs&#32467;&#26500;&#20307;&#30340;&#31354;&#38388;&#65292;&#29992;&#23427;&#23384;&#20648;&#21457;&#29983;&#20013;&#26029;&#26102;&#29992;&#25143;&#27169;&#24335;&#19979;&#30340;&#25152;&#26377;&#23492;&#23384;&#22120;&#12290;
<pre class="programlisting">
	.macro	usr_entry
	sub	sp, sp, #S_FRAME_SIZE
	stmib	sp, {r1 - r12}
</pre>
S_PC&#34987;&#23450;&#20041;&#20026;offsetof(struct pt_regs, ARM_pc)&#65292;&#25152;&#20197;&#36825;&#37324;&#36890;&#36807;add&#25351;&#20196;&#23558;r0&#25351;&#21521;ARM_pc&#12290;&#27492;&#26102;ARM &#25152;&#26377;&#23492;&#23384;&#22120;
<pre class="programlisting">
	ldmia	r0, {r1 - r3}
	add	r0, sp, #S_PC		@ here for interlock avoidance
	mov	r4, #-1			@  ""  ""     ""        ""

	str	r1, [sp]		@ save the "real" r0 copied
					@ from the exception stack
</pre>
stmia&#23558;svc&#27169;&#24335;&#19979;&#30340;&#23492;&#23384;&#22120;r2-r4&#20445;&#23384;&#21040;ARM_pc&#65292;ARM_cpsr&#21644;ARM_ORIG_r0&#65292;&#26174;&#28982;ARM_ORIG_r0&#20445;&#23384;&#20102;-1&#36825;&#20010;&#24120;&#37327;&#12290;stmdb&#25351;&#20196;&#30340;^&#26631;&#24535;&#34920;&#31034;&#23384;&#20648;&#21457;&#29983;&#20013;&#26029;&#30340;&#27169;&#24335;&#19979;&#30340;sp,lr&#23492;&#23384;&#22120;&#21040;ARM_sp&#21644;ARM_lr&#20013;&#12290;
<pre class="programlisting">
	@
	@ We are now ready to fill in the remaining blanks on the stack:
	@
	@  r2 - lr_&lt;exception&gt;, already fixed up for correct return/restart
	@  r3 - spsr_&lt;exception&gt;
	@  r4 - orig_r0 (see pt_regs definition in ptrace.h)
	@
	@ Also, separately save sp_usr and lr_usr
	@
	stmia	r0, {r2 - r4}
	stmdb	r0, {sp, lr}^
</pre>
&#20197;&#19978;&#30340;&#25351;&#20196;&#30340;&#20316;&#29992;&#21487;&#20197;&#24635;&#32467;&#22914;&#19979;&#65292;&#20854;&#20013;&#23558;&#26222;&#36890;&#23492;&#23384;&#22120;r1&#21040;r12&#20445;&#23384;&#21040;ARM_r1- ARM_r12&#65292;&#36825;&#30456;&#24403;&#20110;&#25226;&#21457;&#29983;&#20013;&#26029;&#26102;&#30340;&#23492;&#23384;&#22120;r1-r12&#36827;&#34892;&#20102;&#20445;&#23384;&#12290;&#25509;&#19979;&#26469;&#20445;&#23384;&#20013;&#26029;&#21457;&#29983;&#26102;&#30340;r0&#65292;lr_irq&#21644;spsr_irq&#20445;&#23384;&#21040;r1-r3&#65292;r4&#36171;&#20540;&#20026;-1&#65292;&#23427;&#20204;&#25509;&#19979;&#26469;&#23558;&#34987;&#20351;&#29992;&#12290;&#25509;&#19979;&#26469;&#20445;&#23384;r0&#21040;ARM_r0&#65292;lr_irq&#65292;spsr_irq&#21644;-1&#21040;ARM_pc ARM_cpsr ARM_ORIG_R0&#65292;&#27880;&#24847;&#21040;stmdb&#25351;&#20196;&#20013;&#30340;"^"&#65292;&#23427;&#20445;&#23384;sp_usr&#21644;lr_usr&#20998;&#21035;&#21040;ARM_sp&#21644;ARM_lr&#65292;&#26174;&#28982;&#36825;&#37324;&#23558;&#25152;&#26377;&#20013;&#26029;&#21457;&#29983;&#26102;&#30340;&#23492;&#23384;&#22120;&#37117;&#36827;&#34892;&#20102;&#20445;&#23384;&#12290;
<pre class="programlisting">
stmib  sp, {r1 - r12}		// r1- r12 =&gt; ARM_r1- ARM_r12
ldmia  r0, {r1 - r3}		// r0 lr_mod spsr_mod =&gt; r1_svc-r3_svc
mov    r4, #-1 			// r4 =&gt; -1
str    r1, [sp]			// r0 =&gt; ARM_r0
stmia  r0, {r2 - r4}		// lr_mod spsr_mod -1 =&gt; ARM_pc ARM_cpsr ARM_ORIG_R0
stmdb  r0, {sp, lr}^		// sp_mod lr_mod =&gt; ARM_sp ARM_lr
</pre>
<div class="figure"><a name="idp81255204"></a><p class="title"><b>&#22270; 86. &#20445;&#23384;&#20013;&#26029;&#22534;&#26632;</b></p><div class="figure-contents"><div><img src="images/int_stack1.gif" alt="&#20445;&#23384;&#20013;&#26029;&#22534;&#26632;"></div></div></div><br class="figure-break">
alignment_trap&#22312;&#37197;&#32622;CONFIG_ALIGNMENT_TRAP&#26102;&#26377;&#25928;&#65292;&#22914;&#26524;&#24320;&#21551;&#20102;&#35813;&#36873;&#39033;&#65292;&#20013;&#26029;&#22788;&#29702;&#20013;&#23558;&#25903;&#25345;&#23545;&#40784;&#36319;&#36394;&#12290;
<pre class="programlisting">
arch/arm/kernel/entry-header.S
        .macro  alignment_trap, rtemp
#ifdef CONFIG_ALIGNMENT_TRAP
        ldr     \rtemp, .LCcralign
        ldr     \rtemp, [\rtemp]
        mcr     p15, 0, \rtemp, c1, c0
#endif
        .endm

arch/arm/kernel/entry-armv.S
.LCcralign:
        .word   cr_alignment
</pre>
zero_fp&#29992;&#26469;&#35774;&#32622;fp&#26632;&#24103;&#23492;&#23384;&#22120;&#20026;0&#65292;&#23427;&#22312;&#37197;&#32622;CONFIG_FRAME_POINTER&#26102;&#25165;&#26377;&#25928;&#12290;
<pre class="programlisting">
arch/arm/kernel/entry-header.S
        .macro  zero_fp
#ifdef CONFIG_FRAME_POINTER
        mov     fp, #0
#endif
        .endm
</pre>
CONFIG_FRAME_POINTER&#30340;&#37197;&#32622;&#26377;&#21033;&#20110;&#36861;&#36394;&#20869;&#26680;&#30340;&#20989;&#25968;&#35843;&#29992;&#12290;
<pre class="programlisting">
	@
	@ Enable the alignment trap while in kernel mode
	@
	alignment_trap r0

	@
	@ Clear FP to mark the first stack frame
	@
	zero_fp
	.endm
</pre>

<pre class="programlisting">
	kuser_cmpxchg_check
</pre>
kuser_cmpxchg_check&#20197;&#21518;&#20877;&#35828;&#12290;
<pre class="programlisting">
#ifdef CONFIG_TRACE_IRQFLAGS
	bl	trace_hardirqs_off
#endif
	get_thread_info tsk
</pre>
get_thread_info&#23439;&#29992;&#26469;&#26681;&#25454;&#24403;&#21069;&#30340;sp&#20540;&#65292;&#36890;&#36807;lsr&#21644;lsl&#20998;&#21035;&#21491;&#31227;&#24038;&#31227;13&#20301;&#65292;&#30456;&#24403;&#20110;&#23545;sp&#21521;&#19979;&#22278;&#25972;&#21040;8K&#23545;&#40784;&#12290;&#36825;&#37324;&#20063;&#23601;&#26159;thread_info&#25152;&#22312;&#30340;&#22320;&#22336;&#12290;
<pre class="programlisting">
arch/arm/kernel/entry-header.S
  .macro  get_thread_info, rd
  mov     \rd, sp, lsr #13
  mov     \rd, \rd, lsl #13
  .endm
  
why	.req	r8		@ Linux syscall (!= 0) 
tsk .req    r9              @ current thread_info
</pre>
TI_PREEMPT&#34987;&#23450;&#20041;&#20026;offsetof(struct thread_info, preempt_count)&#65292;&#26174;&#28982;&#36890;&#36807;tsk&#23601;&#21487;&#20197;&#24456;&#23481;&#26131;&#24471;&#21040;&#36827;&#31243;preempt_count&#25104;&#21592;&#30340;&#22320;&#22336;&#20102;&#12290;
<pre class="programlisting">	
#ifdef CONFIG_PREEMPT
	ldr	r8, [tsk, #TI_PREEMPT]		@ get preempt count
	add	r7, r8, #1			@ increment it
	str	r7, [tsk, #TI_PREEMPT]
#endif
</pre>
add&#25351;&#20196;&#23558;preempt_count&#21152;1&#65292;str&#37325;&#26032;&#23384;&#20648;&#22238;preempt_count&#12290;&#26174;&#28982;&#22312;&#22788;&#29702;&#20013;&#26029;&#30340;&#26102;&#20505;&#65292;&#24403;&#21069;&#30340;&#20869;&#26680;&#32447;&#31243;&#26159;&#19981;&#33021;&#34987;&#25250;&#21344;&#30340;&#12290;
<pre class="programlisting">	
	irq_handler
</pre>
&#36825;&#37324;&#26159;&#22788;&#29702;&#20013;&#26029;&#30340;&#23454;&#38469;&#23376;&#31243;&#24207;&#12290;&#25509;&#19979;&#26469;&#23558;r8&#20013;&#35760;&#24405;&#30340;&#21407;preempt_count&#20540;&#24674;&#22797;&#12290;teq&#29992;&#26469;&#27604;&#36739;r0&#21644;r7&#65292;&#20063;&#21363;&#26816;&#26597;&#36827;&#20837;&#20013;&#26029;&#22788;&#29702;&#30340;irq_handler&#20043;&#21069;&#30340;preempt_count&#21644;&#20043;&#21518;&#30340;preempt_count&#26159;&#21542;&#26377;&#25913;&#21464;&#65292;&#22914;&#26524;&#26377;&#65292;&#37027;&#20040;&#23558;&#22320;&#22336;
<pre class="programlisting">
#ifdef CONFIG_PREEMPT
	ldr	r0, [tsk, #TI_PREEMPT]
	str	r8, [tsk, #TI_PREEMPT]
	teq	r0, r7
	strne	r0, [r0, -r0]
#endif
#ifdef CONFIG_TRACE_IRQFLAGS
	bl	trace_hardirqs_on
#endif
</pre>
why&#34987;&#23450;&#20041;&#20026;r8&#23492;&#23384;&#22120;&#65292;&#25152;&#20197;r8&#34987;&#28165;&#38646;&#65292;&#28982;&#21518;&#36339;&#36716;&#21040;ret_to_user&#36820;&#22238;&#21040;&#29992;&#25143;&#31354;&#38388;&#12290;
<pre class="programlisting">
	mov	why, #0
	b	ret_to_user
ENDPROC(__irq_usr)
</pre>
</div>
<div class="sect3" title="16.3.2. irq_handler"><div class="titlepage"><div><div><h4 class="title"><a name="idp81261772"></a>16.3.2. irq_handler</h4></div></div></div>
irq_handler&#26159;&#30495;&#27491;&#30340;IRQ&#20013;&#26029;&#22788;&#29702;&#20837;&#21475;&#65292;&#22312;&#20013;&#26029;&#22788;&#29702;&#20013;&#38656;&#35201;&#39044;&#30041;r7&#65292;r8&#21644;r9&#23492;&#23384;&#22120;&#12290;&#23427;&#20204;&#34987;&#29992;&#26469;&#22788;&#29702;&#20869;&#26680;&#25250;&#21344;&#12290;
<pre class="programlisting">
arch/arm/mach-s3c6400/include/mach/entry-macro.S
        .macro  get_irqnr_preamble, base, tmp
        ldr     \base, =S3C_VA_VIC0
        .endm
</pre>	
get_irqnr_preamble&#29992;&#26469;&#33719;&#21462;&#20013;&#26029;&#29366;&#24577;&#23492;&#23384;&#22120;&#22522;&#22320;&#22336;&#65292;&#23427;&#29305;&#23450;&#20110;CPU&#65292;&#25152;&#20197;&#34987;&#23450;&#20041;&#22312;mach-xxx&#20013;&#12290;&#36825;&#37324;&#23558;&#20013;&#26029;&#25511;&#21046;&#22120;&#30340;VIC0 &#29366;&#24577;&#23492;&#23384;&#22120;&#30340;&#22320;&#22336;S3C_VA_VIC0&#23384;&#20648;&#21040;r5&#12290;
<pre class="programlisting">
arch/arm/mach-s3c6400/include/mach/entry-macro.S
.macro  get_irqnr_and_base, irqnr, irqstat, base, tmp

@ check the vic0
mov     \irqnr, # S3C_IRQ_OFFSET + 31
ldr     \irqstat, [ \base, # VIC_IRQ_STATUS ]
teq     \irqstat, #0

@ otherwise try vic1
addeq   \tmp, \base, #(S3C_VA_VIC1 - S3C_VA_VIC0)
addeq   \irqnr, \irqnr, #32
ldreq   \irqstat, [ \tmp, # VIC_IRQ_STATUS ]
teqeq   \irqstat, #0

clzne   \irqstat, \irqstat
subne   \irqnr, \irqnr, \irqstat
.endm
</pre>
&#20026;&#20102;&#26356;&#28145;&#20837;&#30340;&#29702;&#35299;&#36825;&#27573;&#20195;&#30721;&#65292;&#32473;&#20986;&#23545;&#24212;&#30340;&#21453;&#27719;&#32534;&#31243;&#24207;&#65306;
<pre class="programlisting">
/*  e3a0533d        mov     r5, #-201326592 ; 0xf4000000&#12288;*/
288:       e3a0003f        mov     r0, #63 ; 0x3f
28c:       e5956000        ldr     r6, [r5]
290:       e3360000        teq     r6, #0  ; 0x0
294:       0285e801        addeq   lr, r5, #65536  ; 0x10000
298:       02800020        addeq   r0, r0, #32     ; 0x20
29c:       059e6000        ldreq   r6, [lr]
2a0:       03360000        teqeq   r6, #0  ; 0x0
2a4:       116f6f16        clzne   r6, r6
2a8:       10400006        subne   r0, r0, r6
</pre>
get_irqnr_and_base&#29992;&#26469;&#33719;&#21462;&#20013;&#26029;&#21495;&#65292;&#23545;&#20110;S3C6410&#26469;&#35828;&#65292;&#20013;&#26029;&#25511;&#21046;&#22120;&#30001;2&#20010;VIC&#32452;&#25104;&#65292;&#25152;&#20197;&#35835;&#21462;&#26102;&#39318;&#20808;&#35835;&#21462;vic0&#65292;&#35835;&#21462;&#22833;&#36133;&#21017;&#20877;&#35835;&#21462;vic1&#12290;S3C_IRQ_OFFSET&#34987;&#23450;&#20041;&#20026;32&#26159;&#20026;&#20102;&#32473;ISA&#35774;&#22791;&#39044;&#30041;&#20013;&#26029;&#21495;&#65292;&#35813;&#31867;&#35774;&#22791;&#30340;&#20013;&#26029;&#21495;&#35201;&#27714;&#24635;&#26159;&#20174;0&#24320;&#22987;&#65292;&#23613;&#31649;&#22810;&#25968;&#26102;&#20505;&#23427;&#20204;&#34987;&#28120;&#27760;&#19981;&#20877;&#20351;&#29992;&#12290;&#25152;&#20197;&#33719;&#21462;&#30340;&#20013;&#26029;&#21495;&#30340;&#33539;&#22260;&#22312;32 ~ 96&#20043;&#38388;&#12290;
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">288&#65306;&#39318;&#20808;&#23558;r0&#36171;&#20104;&#20013;&#26029;&#21495;63&#65292;&#26174;&#28982;&#20854;&#20013;&#21253;&#21547;&#20102;S3C_IRQ_OFFSET&#20559;&#31227;&#12290;</li><li class="listitem">28c&#65306;&#27492;&#26102;r5&#20013;&#23384;&#25918;&#30340;&#26159;VIC0&#30340;&#29366;&#24577;&#23492;&#23384;&#22120;&#22320;&#22336;&#65292;&#25152;&#20197;ldr&#23558;VIC0&#30340;&#29366;&#24577;&#23492;&#23384;&#22120;&#20540;&#23384;&#20837;r6&#12290;</li><li class="listitem">290&#65306;&#35813;&#34892;&#21028;&#26029;r6&#30340;&#20540;&#26159;&#21542;&#20026;0&#65292;&#22914;&#26524;&#20026;0&#65292;&#21017;&#32487;&#32493;&#26816;&#27979;VIC1&#30340;&#29366;&#24577;&#23492;&#23384;&#22120;&#20540;&#65292;&#21542;&#21017;&#30452;&#25509;&#25191;&#34892;2a4&#25351;&#20196;&#12290;</li><li class="listitem">294&#65306;&#26681;&#25454;r5&#20013;&#30340;VIC0&#29366;&#24577;&#23492;&#23384;&#22120;&#22320;&#22336;&#65292;&#21521;&#39640;&#22320;&#22336;&#20559;&#31227;0x10000&#65292;&#33719;&#21462;VIC1&#30340;&#29366;&#24577;&#23492;&#23384;&#22120;&#22320;&#22336;&#12290;</li><li class="listitem">298&#65306;&#27492;&#26102;&#26356;&#25913;r0&#30340;&#20540;63+32&#65292;&#20063;&#21363;95&#12290;&#36825;&#26159;VIC1&#23545;&#24212;&#30340;&#20013;&#26029;&#21495;&#30340;&#26368;&#22823;&#20559;&#31227;&#20540;&#12290;</li><li class="listitem">29c-2a0&#19982;28c-290&#21151;&#33021;&#19968;&#33268;&#65292;&#21482;&#26159;&#38024;&#23545;VIC1&#30340;&#29366;&#24577;&#23492;&#23384;&#22120;&#25805;&#20316;&#12290;</li><li class="listitem">2a4&#65306;clz&#65288;Count leading zeros&#65289;&#25351;&#20196;&#29992;&#26469;&#35745;&#31639;&#20174;&#39640;&#20301;&#24320;&#22987;&#30340;0&#30340;&#20010;&#25968;&#65292;&#24182;&#23384;&#25918;&#21040;r6&#65292;&#26174;&#28982;&#23427;&#30340;&#29992;&#24847;&#26159;&#35201;&#26681;&#25454;&#20013;&#26029;&#29366;&#24577;&#23492;&#23384;&#22120;&#30340;&#20540;&#24471;&#21040;&#20013;&#26029;&#21495;&#12290;</li><li class="listitem">2a8&#65306;&#30001;&#20110;clz&#33719;&#21462;&#30340;&#26159;&#39640;&#20301;0&#30340;&#20010;&#25968;&#65292;&#20294;&#26159;&#29366;&#24577;&#23492;&#23384;&#22120;&#30340;&#20302;&#20301;&#23545;&#24212;&#23567;&#30340;&#20013;&#26029;&#21495;&#65292;&#25152;&#20197;&#20351;&#29992;r0&#20943;&#21435;r6&#65292;&#27492;&#26102;&#24471;&#21040;&#21547;S3C_IRQ_OFFSET&#30340;&#20013;&#26029;&#21495;&#12290;</li></ul></div>
&#65288;&#27880;&#24847;&#21040;&#36825;&#37324;&#38656;&#35201;&#20445;&#35777;r7&#65292;r8&#21644;r9&#19981;&#34987;&#25913;&#21160;&#65292;&#23427;&#26159;&#36890;&#36807;asm_do_IRQ&#30340;asmlinkage&#22768;&#26126;&#20445;&#35777;&#30340;&#12290;&#65311;&#65289;
<pre class="programlisting">
/*
 * Interrupt handling.  Preserves r7, r8, r9
 */
	.macro	irq_handler
	get_irqnr_preamble r5, lr
1:	get_irqnr_and_base r0, r6, r5, lr
	movne	r1, sp
	@
	@ routine called with r0 = irq number, r1 = struct pt_regs *
	@
	adrne	lr, 1b
	bne	asm_do_IRQ

	.endm
</pre>
</div>
<div class="sect3" title="16.3.3. asm_do_IRQ"><div class="titlepage"><div><div><h4 class="title"><a name="idp81268772"></a>16.3.3. asm_do_IRQ</h4></div></div></div>
asm_do_IRQ&#26159;ARM&#22788;&#29702;&#30828;&#20214;&#20013;&#26029;&#30340;&#26680;&#24515;&#20989;&#25968;&#65292;&#31532;&#19968;&#20010;&#21442;&#25968;&#25351;&#23450;&#20102;&#30828;&#20013;&#26029;&#30340;&#20013;&#26029;&#21495;&#65292;&#31532;&#20108;&#20010;&#21442;&#25968;&#26159;&#23492;&#23384;&#22120;&#22791;&#20221;&#32452;&#25104;&#30340;&#19968;&#20010;&#32467;&#26500;&#20307;&#65292;&#20445;&#23384;&#20102;&#20013;&#26029;&#21457;&#29983;&#26102;&#30340;&#27169;&#24335;&#23545;&#24212;&#30340;&#23492;&#23384;&#22120;&#30340;&#20540;&#65292;&#22312;&#20013;&#26029;&#36820;&#22238;&#26102;&#20351;&#29992;&#12290;
<pre class="programlisting">
asmlinkage void __exception asm_do_IRQ(unsigned int irq, struct pt_regs *regs)
{
    struct pt_regs *old_regs = set_irq_regs(regs);

    irq_enter();

    if (irq &gt;= NR_IRQS)
            handle_bad_irq(irq, &amp;bad_irq_desc);
    else
            generic_handle_irq(irq);

    /* AT91 specific workaround */
    irq_finish(irq);

    irq_exit();
    set_irq_regs(old_regs);
}
</pre>
<div class="figure"><a name="idp81269220"></a><p class="title"><b>&#22270; 87. asm_do_IRQ&#27969;&#31243;&#22270;</b></p><div class="figure-contents"><div><img src="images/int_do_irq.gif" alt="asm_do_IRQ&#27969;&#31243;&#22270;"></div></div></div><br class="figure-break">
&#36825;&#37324;&#19981;&#23545;generic_handle_irq&#22810;&#20570;&#35299;&#37322;&#65292;&#22312;&#20013;&#26029;&#26381;&#21153;&#31243;&#24207;&#22788;&#29702;&#20013;&#23558;&#23545;&#23427;&#21078;&#26512;&#12290;&#36825;&#37324;&#20851;&#24515;&#19968;&#19979;&#21478;&#22806;&#20004;&#20010;&#38750;&#24120;&#37325;&#35201;&#30340;&#23567;&#20989;&#25968;irq_enter&#21644;irq_exit&#12290;
<pre class="programlisting">
/*
 * Enter irq context (on NO_HZ, update jiffies):
 */
#define __irq_enter()					\
	do {						\
		rcu_irq_enter();			\
		account_system_vtime(current);		\
		add_preempt_count(HARDIRQ_OFFSET);	\
		trace_hardirq_enter();			\
	} while (0)

kernel/softirq.c
void irq_enter(void)
{
  int cpu = smp_processor_id();

  if(idle_cpu(cpu) &amp;&amp; !in_interrupt())
  {
    __irq_enter();
    tick_check_idle(cpu);
  }
  else
    __irq_enter();
}
</pre>

<pre class="programlisting">
/*
 * Exit irq context without processing softirqs:
 */
#define __irq_exit()					\
	do {						\
		trace_hardirq_exit();			\
		account_system_vtime(current);		\
		sub_preempt_count(HARDIRQ_OFFSET);	\
		rcu_irq_exit();				\
	} while (0)

kernel/softirq.c	
void irq_exit(void)
{
  account_system_vtime(current);
  trace_hardirq_exit();
  sub_preempt_count(IRQ_EXIT_OFFSET);
  if(!in_interrupt() &amp;&amp; local_softirq_pending())
   invoke_softirq();

#ifdef CONFIG_NO_HZ 
  /* Make sure that timer wheel updates are propagated */
  if (!in_interrupt() &amp;&amp; idle_cpu(smp_processor_id()) &amp;&amp; !need_resched())
          tick_nohz_stop_sched_tick(0);
  rcu_irq_exit();
#endif
  preempt_enable_no_resched();
}	
</pre>
rcu_irq_enter&#21644;rcu_irq_exit&#19982;CONFIG_PREEMPT_RCU&#26377;&#20851;&#65292;&#36825;&#37324;&#19981;&#20851;&#24515;&#23427;&#20204;&#12290;&#20540;&#24471;&#27880;&#24847;&#30340;&#26159;add_preempt_count&#21644;sub_preempt_count&#20989;&#25968;&#65292;&#23427;&#29992;&#26469;&#22686;&#21152;&#24403;&#21069;&#36827;&#31243;preempt_count&#20013;&#30340;&#30828;&#20214;&#35745;&#25968;&#22120;&#12290;
</div>
<div class="sect3" title="16.3.4. ret_to_user"><div class="titlepage"><div><div><h4 class="title"><a name="idp81272996"></a>16.3.4. ret_to_user</h4></div></div></div>
ret_to_user&#29992;&#26469;&#36820;&#22238;&#21040;&#29992;&#25143;&#27169;&#24335;&#12290;&#35843;&#29992;&#27969;&#31243;&#22914;&#19979;&#22270;&#25152;&#31034;&#65306;
<div class="figure"><a name="idp81273420"></a><p class="title"><b>&#22270; 88. ret_to_user&#27969;&#31243;</b></p><div class="figure-contents"><div><img src="images/int_retuser.gif" alt="ret_to_user&#27969;&#31243;"></div></div></div><br class="figure-break">
<pre class="programlisting">
arch/arm/kernel/entry-common.S
/*
 * "slow" syscall return path.  "why" tells us if this was a real syscall.
 */
ENTRY(ret_to_user)
ret_slow_syscall:
        disable_irq                             @ disable interrupts
        ldr     r1, [tsk, #TI_FLAGS]
        tst     r1, #_TIF_WORK_MASK
        bne     work_pending
</pre>
disable_irq&#29992;&#26469;&#31105;IRQ&#20013;&#26029;&#12290;&#22914;&#26524;&#19981;&#23567;&#20110;ARMv6&#29256;&#26412;&#65292;&#21017;&#30452;&#25509;&#20351;&#29992;cpsid&#35774;&#32622;I&#26631;&#24535;&#20301;&#12290;
<pre class="programlisting">
arch/arm/asm/assembler.h
#if __LINUX_ARM_ARCH__ &gt;= 6
        .macro  disable_irq
        cpsid   i
        .endm

        .macro  enable_irq
        cpsie   i
        .endm
#else
        ......
#endif
</pre>
r1&#39318;&#20808;&#33719;&#21462;thread_info&#20013;&#30340;flags&#25104;&#21592;&#65292;&#28982;&#21518;&#27979;&#35797;_TIF_WORK_MASK&#25513;&#30721;&#20915;&#23450;&#30340;&#26631;&#24535;&#20301;&#65292;&#26174;&#28982;&#23427;&#27979;&#35797;TIF_SIGPENDING&#21644;TIF_NEED_RESCHED&#26631;&#24535;&#20301;&#12290;
<pre class="programlisting">
arch/arm/include/asm/thread_info.h
/*
 * thread information flags:
 *  TIF_SIGPENDING      - signal pending
 *  TIF_NEED_RESCHED    - rescheduling necessary
...... 
 */
#define TIF_SIGPENDING          0
#define TIF_NEED_RESCHED        1
......
#define _TIF_SIGPENDING         (1 &lt;&lt; TIF_SIGPENDING)
#define _TIF_NEED_RESCHED       (1 &lt;&lt; TIF_NEED_RESCHED)
......

#define _TIF_WORK_MASK          0x000000ff

kernel/asm-offsets.c
DEFINE(TI_FLAGS,		offsetof(struct thread_info, flags));
</pre>
&#22914;&#26524;&#36825;&#20004;&#20010;&#26631;&#24535;&#26377;&#26631;&#35760;&#21017;&#36339;&#36716;&#21040;work_pending&#25191;&#34892;&#12290;&#22312;&#35813;&#23376;&#31243;&#24207;&#20013;&#39318;&#20808;&#27979;&#35797;_TIF_NEED_RESCHED&#26631;&#24535;&#65292;&#22914;&#26524;&#35774;&#32622;&#21017;&#36339;&#36716;&#21040;work_resched&#25191;&#34892;&#35843;&#24230;&#31243;&#24207;&#20837;&#21475;schedule&#65292;&#25191;&#34892;&#23436;&#21518;&#23558;&#36820;&#22238;&#32487;&#32493;&#25191;&#34892;no_work_pending&#65292;&#26174;&#28982;&#27809;&#26377;&#21344;&#29992;CPU&#30340;&#36827;&#31243;&#22914;&#26524;&#25509;&#25910;&#21040;&#20449;&#21495;&#21017;&#35774;&#32622;&#36827;&#31243;&#30340;_TIF_SIGPENDING&#26631;&#24535;&#65292;&#24182;&#22312;&#19979;&#27425;&#35843;&#24230;&#26102;&#25165;&#33021;&#34987;&#22788;&#29702;;&#27979;&#35797;_TIF_SIGPENDING&#26631;&#24535;&#65292;&#22914;&#26524;&#27809;&#26377;&#35774;&#32622;&#35813;&#26631;&#24535;&#21017;&#36339;&#36716;&#21040;no_work_pending&#65292;&#21542;&#21017;&#23558;r0&#25351;&#21521;sp&#65292;r2&#21017;&#20445;&#23384;&#31995;&#32479;&#35843;&#29992;&#21495;&#65292;&#28982;&#21518;&#36339;&#36716;&#21040;do_notify_resume&#25191;&#34892;&#65292;&#25191;&#34892;&#23436;&#27605;&#21518;&#36820;&#22238;&#32487;&#32493;&#25191;&#34892;ret_slow_syscall&#12290;
<pre class="programlisting">
work_pending:
        tst     r1, #_TIF_NEED_RESCHED
        bne     work_resched
        tst     r1, #_TIF_SIGPENDING
        beq     no_work_pending
        mov     r0, sp                          @ 'regs'
        mov     r2, why                         @ 'syscall'
        bl      do_notify_resume
        b       ret_slow_syscall                @ Check work again

work_resched:
        bl      schedule
</pre>
do_notify_resume&#29992;&#26469;&#22788;&#29702;&#38459;&#22622;&#22312;&#24403;&#21069;&#36827;&#31243;&#32467;&#26500;&#20013;&#30340;blocked&#20449;&#21495;&#12290;
<pre class="programlisting">
arch/arm/kernel/signal.c
asmlinkage void
do_notify_resume(struct pt_regs *regs, unsigned int thread_flags, int syscall)
{
        if (thread_flags &amp; _TIF_SIGPENDING)
                do_signal(&amp;current-&gt;blocked, regs, syscall);
}
</pre>
&#20294;&#26159;&#22914;&#26524;&#19981;&#26159;&#22312;&#29992;&#25143;&#31354;&#38388;&#21457;&#29983;&#30340;&#20013;&#26029;&#65292;&#26159;&#19981;&#20250;&#22788;&#29702;&#36827;&#31243;&#20449;&#21495;&#30340;&#65292;do_signal&#20013;&#23558;&#26681;&#25454;&#20445;&#23384;&#30340;ARM_cpsr&#23492;&#23384;&#22120;&#27169;&#24335;&#26469;&#21028;&#26029;&#65292;&#23427;&#35760;&#24405;&#20013;&#26029;&#21457;&#29983;&#26102;&#30340;CPSR&#23492;&#23384;&#22120;&#20449;&#24687;&#12290;
<pre class="programlisting">
arch/arm/include/asm/ptrace.h
#define user_mode(regs) \
        (((regs)-&gt;ARM_cpsr &amp; 0xf) == 0)

arch/arm/kernel/signal.c
static int do_signal(sigset_t *oldset, struct pt_regs *regs, int syscall)
{
	if(!user_mode(regs))
		return 0;
	......
}
</pre>
arch_ret_to_user&#30001;&#29305;&#23450;CPU&#23450;&#20041;&#65292;S3C6410&#20013;&#35813;&#23439;&#20026;&#31354;&#12290;
<pre class="programlisting">
no_work_pending:
        /* perform architecture specific actions before user return */
        arch_ret_to_user r1, lr

        @ slow_restore_user_regs
        ldr     r1, [sp, #S_PSR]                @ get calling cpsr
        ldr     lr, [sp, #S_PC]!                @ get pc
        msr     spsr_cxsf, r1                   @ save in spsr_svc
        ldmdb   sp, {r0 - lr}^                  @ get calling r0 - lr
        mov     r0, r0
        add     sp, sp, #S_FRAME_SIZE - S_PC
        movs    pc, lr                          @ return &amp; move spsr_svc into cpsr
ENDPROC(ret_to_user)
</pre>
&#26368;&#21518;&#24674;&#22797;&#29992;&#25143;&#27169;&#24335;&#20013;&#30340;&#23492;&#23384;&#22120;&#21644;SVC&#27169;&#24335;&#19979;&#30340;sp&#23492;&#23384;&#22120;&#12290;movs&#25351;&#20196;&#23454;&#29616;SVC&#27169;&#24335;&#21521;&#29992;&#25143;&#27169;&#24335;&#30340;&#20999;&#25442;&#12290;
</div>
</div>
<div class="sect2" title="16.4. __irq_svc"><div class="titlepage"><div><div><h3 class="title"><a name="idp81280300"></a>16.4. __irq_svc</h3></div></div></div>
__irq_svc&#22788;&#29702;SVC&#27169;&#24335;&#19979;&#21457;&#29983;&#30340;&#20013;&#26029;&#12290;
<pre class="programlisting">
	.align	5
__irq_svc:
	svc_entry
</pre>
&#19982;usr_entry&#31867;&#20284;&#65292;&#36825;&#37324;&#30340;svc_entry&#29992;&#26469;&#20445;&#23384;svc&#27169;&#24335;&#19979;&#30340;&#23492;&#23384;&#22120;&#12290;
<pre class="programlisting">
	.macro	svc_entry, stack_hole=0
	sub	sp, sp, #(S_FRAME_SIZE + \stack_hole)
 SPFIX(	tst	sp, #4		)
 SPFIX(	bicne	sp, sp, #4	)
	stmib	sp, {r1 - r12}

	ldmia	r0, {r1 - r3}
	add	r5, sp, #S_SP		@ here for interlock avoidance
	mov	r4, #-1			@  ""  ""      ""       ""
	add	r0, sp, #(S_FRAME_SIZE + \stack_hole)
 SPFIX(	addne	r0, r0, #4	)
	str	r1, [sp]		@ save the "real" r0 copied
					@ from the exception stack

	mov	r1, lr

	@
	@ We are now ready to fill in the remaining blanks on the stack:
	@
	@  r0 - sp_svc
	@  r1 - lr_svc
	@  r2 - lr_&lt;exception&gt;, already fixed up for correct return/restart
	@  r3 - spsr_&lt;exception&gt;
	@  r4 - orig_r0 (see pt_regs definition in ptrace.h)
	@
	stmia	r5, {r0 - r4}
	.endm
</pre>
&#25509;&#19979;&#26469;&#30340;&#22788;&#29702;&#19982;__irq_usr&#31867;&#20284;&#65292;&#30452;&#25509;&#35843;&#29992;irq_handler&#65292;&#20294;&#26159;&#36820;&#22238;&#26102;&#26080;&#38656;&#35843;&#29992;ret_to_user&#65292;&#32780;&#26159;&#30452;&#25509;&#24674;&#22797;SVC&#27169;&#24335;&#30340;&#23492;&#23384;&#22120;&#21363;&#21487;&#12290;
<pre class="programlisting">
#ifdef CONFIG_TRACE_IRQFLAGS
	bl	trace_hardirqs_off
#endif
#ifdef CONFIG_PREEMPT
	get_thread_info tsk
	ldr	r8, [tsk, #TI_PREEMPT]		@ get preempt count
	add	r7, r8, #1			@ increment it
	str	r7, [tsk, #TI_PREEMPT]
#endif

	irq_handler
</pre>	
&#20294;&#26159;&#27880;&#24847;&#21040;&#36825;&#37324;&#30340;svc_preempt&#25805;&#20316;&#65292;&#39318;&#20808;&#24674;&#22797;&#24403;&#21069;&#36827;&#31243;&#30340;preempt_count&#21040;r8&#20013;&#65292;&#26174;&#28982;&#22312;&#36827;&#20837;&#26102;&#65292;&#23427;&#34987;&#21152;&#20102;1&#65292;&#36825;&#37324;&#23581;&#35797;&#23558;&#23427;&#19982;0&#27604;&#36739;&#65292;&#22914;&#26524;&#20026;0&#65292;&#37027;&#20040;&#35828;&#26126;&#27809;&#26377;&#31105;&#27490;&#20869;&#26680;&#25250;&#21344;&#65292;&#27492;&#26102;&#32487;&#32493;&#27979;&#35797;&#26631;&#24535;&#20301;&#26159;&#21542;&#26377;_TIF_NEED_RESCHED&#65292;&#22914;&#26524;&#26377;&#21017;&#36339;&#36716;&#21040;svc_preempt&#25191;&#34892;&#35843;&#24230;&#12290;&#25152;&#20197;&#21482;&#26377;&#22312;&#20013;&#26029;&#20013;&#23545;preempt_count&#36827;&#34892;&#20102;&#28165;0&#22788;&#29702;&#24182;&#19988;&#35774;&#32622;&#20102;_TIF_NEED_RESCHED&#65292;&#25165;&#26377;&#21487;&#33021;&#25191;&#34892;&#35843;&#24230;&#65292;
<pre class="programlisting">
#ifdef CONFIG_PREEMPT
	str	r8, [tsk, #TI_PREEMPT]		@ restore preempt count
	ldr	r0, [tsk, #TI_FLAGS]		@ get flags
	teq	r8, #0				@ if preempt count != 0
	movne	r0, #0				@ force flags to 0
	tst	r0, #_TIF_NEED_RESCHED
	blne	svc_preempt
#endif
	ldr	r0, [sp, #S_PSR]		@ irqs are already disabled
	msr	spsr_cxsf, r0
#ifdef CONFIG_TRACE_IRQFLAGS
	tst	r0, #PSR_I_BIT
	bleq	trace_hardirqs_on
#endif
	ldmia	sp, {r0 - pc}^			@ load r0 - pc, cpsr
ENDPROC(__irq_svc)
</pre>
preempt_schedule_irq&#26159;&#19968;&#20010;&#38750;&#24120;&#37325;&#35201;&#30340;&#35843;&#24230;&#20989;&#25968;&#65292;&#21482;&#26377;&#22312;&#35813;&#20989;&#25968;&#20013;&#28165;&#38500;&#20102;_TIF_NEED_RESCHED&#26631;&#35760;&#25165;&#20250;&#32467;&#26463;&#24490;&#29615;&#12290;
<pre class="programlisting">
#ifdef CONFIG_PREEMPT
svc_preempt:
        mov     r8, lr
1:      bl      preempt_schedule_irq            @ irq en/disable is done inside
        ldr     r0, [tsk, #TI_FLAGS]            @ get new tasks TI_FLAGS
        tst     r0, #_TIF_NEED_RESCHED
        moveq   pc, r8                          @ go again
        b       1b
#endif
</pre>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">&#39318;&#20808;&#27979;&#35797;&#24403;&#21069;&#36827;&#31243;&#30340;preempt_count&#26159;&#21542;&#20026;0&#65292;&#21478;&#22806;&#23601;&#26159;&#20445;&#35777;&#26159;&#22312;&#20013;&#26029;&#20869;&#35843;&#29992;&#30340;&#65292;&#21542;&#21017;&#23601;&#26159;BUG&#12290;</li><li class="listitem">&#28155;&#21152;PREEMPT_ACTIVE&#26631;&#35760;&#65292;&#20351;&#33021;&#20013;&#26029;&#12290;</li><li class="listitem">&#35843;&#29992;schedule&#23454;&#26102;&#35843;&#24230;&#12290;</li></ul></div>
<pre class="programlisting">
asmlinkage void __sched preempt_schedule_irq(void)
{
	struct thread_info *ti = current_thread_info();

	/* Catch callers which need to be fixed */
	BUG_ON(ti-&gt;preempt_count || !irqs_disabled());

	do {
		add_preempt_count(PREEMPT_ACTIVE);
		local_irq_enable();
		schedule();
		local_irq_disable();
		sub_preempt_count(PREEMPT_ACTIVE);

		/*
		 * Check again in case we missed a preemption opportunity
		 * between schedule and now.
		 */
		barrier();
	} while (unlikely(test_thread_flag(TIF_NEED_RESCHED)));
}
</pre>
&#26174;&#28982;&#26080;&#35770;&#26159;&#36820;&#22238;&#29992;&#25143;&#24577;&#36824;&#26159;&#36820;&#22238;&#20869;&#26680;&#24577;&#65292;&#37117;&#26377;&#21487;&#33021;&#26816;&#26597; TIF_NEED_RESCHED &#30340;&#29366;&#24577;&#65307;&#36820;&#22238;&#26680;&#24515;&#24577;&#26102;&#65292;&#21482;&#35201;preempt_count&#20026; 0&#65292;&#21363;&#24403;&#21069;&#36827;&#31243;&#30446;&#21069;&#20801;&#35768;&#25250;&#21344;&#65292;&#23601;&#20250;&#26681;&#25454; TIF_NEED_RESCHED &#29366;&#24577;&#36873;&#25321;&#35843;&#29992;schedule()&#12290;&#22240;&#20026;&#33267;&#23569;&#26102;&#38047;&#20013;&#26029;&#26159;&#19981;&#26029;&#21457;&#29983;&#30340;&#65292;&#22240;&#27492;&#65292;&#21482;&#35201;&#26377;&#36827;&#31243;&#35774;&#32622;&#20102; TIF_NEED_RESCHED &#26631;&#24535;&#65292;&#24403;&#21069;&#36827;&#31243;&#39532;&#19978;&#23601;&#26377;&#21487;&#33021;&#34987;&#25250;&#21344;&#65292;&#32780;&#26080;&#35770;&#23427;&#26159;&#21542;&#24895;&#24847;&#25918;&#24323; cpu&#65292;&#21363;&#20351;&#26159;&#26680;&#24515;&#36827;&#31243;&#20063;&#26159;&#22914;&#27492;&#12290;&#20851;&#20110;&#26102;&#38047;&#20013;&#26029;&#22788;&#29702;&#21442;&#32771;<a class="xref" href="ar01s18.html#time_intr">&#31532; 18.10 &#33410; &#8220;&#26102;&#38047;&#20013;&#26029;&#22788;&#29702;&#8221;</a>&#12290;&#20851;&#20110;&#36827;&#31243;&#35843;&#24230;&#30340;&#28145;&#20837;&#20171;&#32461;&#22312;&#29420;&#31435;&#31456;&#33410;&#20013;&#36827;&#34892;&#12290;
</div>
<div class="sect2" title="16.5. &#20013;&#26029;&#31034;&#20363;"><div class="titlepage"><div><div><h3 class="title"><a name="idp81287844"></a>16.5. &#20013;&#26029;&#31034;&#20363;</h3></div></div></div>
<p>
</p><pre class="programlisting">
arch/arm/plat-s3c64xx/devs.c
#define DM9000_ETH_IRQ_EINT0 	IRQ_EINT(7)

static struct resource dm9000_resources_cs1[] = {
    [0] = {
        .start  = S3C64XX_VA_DM9000,
        .end    = S3C64XX_VA_DM9000 + S3C64XX_SZ_DM9000 - 1,
        .flags  = IORESOURCE_MEM,
    },
    [1] = {
        .start  = (DM9000_ETH_IRQ_EINT0),
        .end    = (DM9000_ETH_IRQ_EINT0),
        .flags  = IORESOURCE_IRQ,
    },
};

static struct dm9000_plat_data dm9000_setup_cs1 = {
    .flags          = DM9000_PLATF_16BITONLY
};

struct platform_device s3c_device_dm9000_cs1 = {
    .name           = "dm9000_con201",
    .id             = 0,
    .num_resources  = ARRAY_SIZE(dm9000_resources_cs1),
    .resource       = dm9000_resources_cs1,
    .dev            = {
        .platform_data = &amp;dm9000_setup_cs1,
    }
};
</pre><p>
&#20960;&#20046;&#25152;&#26377;&#30340;&#22806;&#35774;&#39537;&#21160;&#37117;&#34987;&#32479;&#19968;&#23450;&#20041;&#25104;struct platform_device&#32467;&#26500;&#20307;&#65292;&#24182;&#24418;&#25104;&#20102;&#19968;&#20010;&#21517;&#20026;smdk6410_devices&#30340;&#25968;&#32452;&#65306;
</p><pre class="programlisting">
arch/arm/mach-s3c6410/mach-smdk6410.c
static struct platform_device *smdk6410_devices[] __initdata = {
	......
	&amp;s3c_device_dm9000_cs1,
	......
	&amp;gpio_button_device,
};
</pre><p>
&#36825;&#20010;&#25968;&#32452;&#22312;&#31995;&#32479;&#35843;&#29992;smdk6410_machine_init&#26102;&#34987;&#35843;&#29992;&#65292;&#25152;&#26377;&#25968;&#32452;&#20013;&#30340;&#35774;&#22791;&#22343;&#22312;&#27492;&#26102;&#27880;&#20876;&#12290;
</p><pre class="programlisting">
static void __init smdk6410_machine_init(void)
{
  ......
	platform_add_devices(smdk6410_devices, ARRAY_SIZE(smdk6410_devices));
	......	
}
</pre><p>
&#32780;smdk6410_machine_init&#36890;&#36807;init_machine&#25104;&#21592;&#34987;&#35843;&#29992;&#12290;
</p><pre class="programlisting">
MACHINE_START(SMDK6410, "SMDK6410")
	/* Maintainer: Ben Dooks &lt;ben@fluff.org&gt; */
	.phys_io	= S3C_PA_UART &amp; 0xfff00000,
	.io_pg_offst	= (((u32)S3C_VA_UART) &gt;&gt; 18) &amp; 0xfffc,
	.boot_params	= S3C64XX_PA_SDRAM + 0x100,

	.init_irq	= s3c6410_init_irq,
	.map_io		= smdk6410_map_io,
	.init_machine	= smdk6410_machine_init,
	.timer		= &amp;s3c64xx_timer,
MACHINE_END
</pre><p>
init_machine&#21017;&#22312;customize_machine&#20013;&#34987;&#24341;&#29992;&#12290;&#23427;&#34987;&#22768;&#26126;&#20026;arch_initcall&#31867;&#22411;&#12290;
</p><pre class="programlisting">
arch/arm/kernel/setup.c
static int __init customize_machine(void)
{
	/* customizes platform devices, or adds new ones */
	if (init_machine)
		init_machine();
	return 0;
}
arch_initcall(customize_machine);
</pre><p>
&#22312;&#38750;&#27169;&#22359;&#32534;&#35793;&#26102;&#65292;&#23427;&#34987;&#22914;&#19979;&#23450;&#20041;&#65292;&#26174;&#28982;&#23427;&#34987;&#23433;&#25918;&#22312;&#38142;&#25509;&#25991;&#20214;&#30340;.initcall3.init&#27573;&#20013;&#12290;
</p><pre class="programlisting">
#define __define_initcall(level,fn,id) \
        static initcall_t __initcall_##fn##id __used \
        __attribute__((__section__(".initcall" level ".init"))) = fn

#define arch_initcall(fn)               __define_initcall("3",fn,3)
</pre><p>
&#26174;&#28982;&#35813;&#27573;&#34987;__initcall_start&#21644;__initcall_end&#24341;&#29992;&#12290;
</p><pre class="programlisting">
arch/arm/kernel/vmlinux.lds
  __initcall_start = .;
   *(.initcallearly.init) __early_initcall_end = .; *(.initcall0.init) *(.initcall0s.init) *(.initcall1.init) 
   *(.initcall1s.init) *(.initcall2.init) *(.initcall2s.init) *(.initcall3.init) *(.initcall3s.init) *(.initcall4.init) 
   *(.initcall4s.init) *(.initcall5.init) *(.initcall5s.init) *(.initcallrootfs.init) *(.initcall6.init) *(.initcall6s.init) 
   *(.initcall7.init) *(.initcall7s.init)
  __initcall_end = .;
</pre><p>
&#23427;&#20204;&#22312;&#31995;&#32479;&#21021;&#22987;&#21270;&#30340;&#26102;&#36890;&#36807;do_initcalls&#35843;&#29992;&#12290;
</p><pre class="programlisting">
init/main.c
static void __init do_initcalls(void)
{
	initcall_t *call;

	for (call = __early_initcall_end; call &lt; __initcall_end; call++)
		do_one_initcall(*call);

	/* Make sure there is no pending stuff from the initcall sequence */
	flush_scheduled_work();
}
</pre><p>
&#19968;&#20010;&#23436;&#25972;&#30340;&#35843;&#29992;&#22914;&#19979;&#25152;&#31034;&#65292;&#33267;&#27492;&#20851;&#20110;&#31995;&#32479;&#21551;&#21160;&#26102;&#35774;&#22791;&#30340;&#27880;&#20876;&#24050;&#32463;&#19968;&#30446;&#20102;&#28982;&#12290;
</p><pre class="programlisting">
start_kernel-&gt;reset_init-&gt;kernel_init-&gt;do_basic_setup-&gt;do_initcalls-&gt;customize_machine-&gt;platform_add_devices
</pre><p>
</p><div class="figure"><a name="idp81295164"></a><p class="title"><b>&#22270; 89. &#32593;&#21345;&#20013;&#26029;&#31034;&#20363;</b></p><div class="figure-contents"><div><img src="images/int_calls.gif" alt="&#32593;&#21345;&#20013;&#26029;&#31034;&#20363;"></div></div></div><p><br class="figure-break">
</p>
</div>
<div class="sect2" title="16.6. &#20013;&#26029;&#25511;&#21046;&#22120;"><div class="titlepage"><div><div><h3 class="title"><a name="idp81288788"></a>16.6. &#20013;&#26029;&#25511;&#21046;&#22120;</h3></div></div></div>
S3C6410X &#20869;&#30340;&#20013;&#26029;&#25511;&#21046;&#22120;&#30001;2 &#20010; VIC(&#30690;&#37327;&#20013;&#26029;&#25511;&#21046;&#22120;&#65292;ARM PrimeCell PL192)&#21644;2 &#20010;TZIC(TrustZone &#20013;&#26029;&#25511;&#21046;&#22120;&#65292;SP890)&#32452;&#25104;&#12290;&#20004;&#20010;&#30690;&#37327;&#20013;&#26029;&#25511;&#21046;&#22120;&#21644;&#20004;&#20010;TrustZone &#20013;&#26029;&#25511;&#21046;&#22120;&#38142;&#25509;&#22312;&#19968;&#36215;&#25903;
&#25345;64 &#20301;&#20013;&#26029;&#28304;&#12290;PL120&#20316;&#20026;ARM&#25480;&#26435;&#30340;SoC&#29255;&#20869;&#20013;&#26029;&#25511;&#21046;&#22120;&#65292;&#36890;&#36807;AHB&#24635;&#32447;&#19982;CPU&#26680;&#30456;&#36830;&#12290;&#32780;&#25511;&#21046;&#30005;&#36335;&#34987;&#21629;&#20196;&#20026;VIC Port&#65292;CPU&#26680;&#21644;VIC&#36890;&#36807;&#23427;&#36827;&#34892;&#30828;&#20214;&#25511;&#21046;&#12290;
<div class="figure"><a name="idp81296588"></a><p class="title"><b>&#22270; 90. PL192 VIC&#21644;&#22788;&#29702;&#22120;VIC&#31471;&#21475;&#30340;&#36830;&#25509;</b></p><div class="figure-contents"><div><img src="images/int_vic.gif" alt="PL192 VIC&#21644;&#22788;&#29702;&#22120;VIC&#31471;&#21475;&#30340;&#36830;&#25509;"></div></div></div><br class="figure-break">
&#19968;&#20010;&#20013;&#26029;&#25511;&#21046;&#22120;&#29992;&#26469;&#22788;&#29702;&#22810;&#20010;&#20013;&#26029;&#28304;&#65292;&#36890;&#24120;&#21253;&#21547;&#20197;&#19979;&#20960;&#20010;&#29305;&#24615;&#65306;
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">&#20026;&#27599;&#20010;&#20013;&#26029;&#28304;&#20998;&#37197;&#19968;&#20010;&#20013;&#26029;&#35831;&#27714;&#36755;&#20837;&#31471;&#21475;&#12290;&#20026;&#27599;&#20010;&#20013;&#26029;&#35831;&#27714;&#20998;&#37197;&#19968;&#20010;&#20013;&#26029;&#35831;&#27714;&#36755;&#20986;&#31471;&#21475;&#65292;&#20197;&#33021;&#36830;&#25509;&#21040;&#22788;&#29702;&#22120;&#30340;VIC&#31471;&#21475;&#12290;</li><li class="listitem">&#21487;&#20197;&#29992;&#36719;&#20214;&#23631;&#34109;&#25481;&#20219;&#24847;&#21046;&#23450;&#30340;&#20013;&#26029;&#28304;&#30340;&#20013;&#26029;&#12290;</li><li class="listitem">&#21487;&#20197;&#20026;&#27599;&#20010;&#20013;&#26029;&#35774;&#32622;&#20248;&#20808;&#32423;&#12290;
</li></ul></div>
&#36890;&#24120;&#36719;&#20214;&#36824;&#38656;&#35201;&#20570;&#20197;&#19979;&#20107;&#24773;&#65306;
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">&#30830;&#23450;&#35831;&#27714;&#26381;&#21153;&#30340;&#20013;&#26029;&#28304;&#12290;</li><li class="listitem">&#30830;&#23450;&#20013;&#26029;&#22788;&#29702;&#31243;&#24207;&#30340;&#22320;&#22336;&#12290;</li></ul></div>
&#20294;&#26159;PL120&#21521;&#37327;&#20013;&#26029;&#25511;&#21046;&#22120;&#22312;&#30828;&#20214;&#19978;&#65292;&#25226;&#19978;&#36848;&#25152;&#26377;&#21151;&#33021;&#37117;&#23454;&#29616;&#20102;&#65292;&#23427;&#21487;&#20197;&#25552;&#20379;&#24403;&#21069;&#26368;&#39640;&#20248;&#20808;&#32423;&#30340;&#20013;&#26029;&#30340;ISR&#30340;&#36215;&#22987;&#22320;&#22336;&#21644;&#21521;&#37327;&#22320;&#22336;&#12290;&#22788;&#29702;&#22120;&#21487;&#20197;&#36890;&#36807;VICVECTADDROUT[31:0]&#36825;&#20010;&#31471;&#21475;&#33719;&#21462;&#24403;&#21069;&#20013;&#26029;&#30340;ISR&#65292;&#19981;&#29992;&#21521;&#20197;&#21069;&#65288;&#27604;&#22914;ARM9&#65289;&#37027;&#26679;&#65292;&#37319;&#29992;0x00000018&#25110;&#32773;0xffff0018&#30340;&#31574;&#30053;&#20102;&#12290;&#20294;&#26159;&#22788;&#29702;&#22120;&#30340;VIC&#31471;&#21475;&#19981;&#25903;&#25345;&#35835; FIQ &#30340;&#21521;&#37327;&#22320;&#22336;&#12290;&#25152;&#20197;Linux&#20381;&#28982;&#20351;&#29992;&#32769;&#30340;&#26041;&#24335;&#26469;&#30830;&#23450;ISR&#22320;&#22336;&#65292;&#20197;&#20445;&#25345;&#21521;&#21518;&#20860;&#23481;&#24615;&#12290;
<div class="figure"><a name="idp81299676"></a><p class="title"><b>&#22270; 91. VIC&#20013;&#26029;&#22788;&#29702;&#26102;&#24207;&#31034;&#20363;</b></p><div class="figure-contents">
<div><img src="images/int_vic_time.gif" alt="VIC&#20013;&#26029;&#22788;&#29702;&#26102;&#24207;&#31034;&#20363;"></div></div></div><br class="figure-break">
&#35813;&#22270;&#35299;&#37322;&#20102;&#22788;&#29702;&#22120;&#21644;VIC&#20043;&#38388;&#22522;&#26412;&#30340;&#25569;&#25163;&#26426;&#21046;&#65306;&#25152;&#26377;&#20107;&#20214;&#22343;&#22312;HCLK&#19978;&#21319;&#27839;&#34987;&#35302;&#21457;&#12290;IRQACK&#26159;&#30001;&#22788;&#29702;&#22120;&#21457;&#20986;&#30340;&#20449;&#21495;&#65292;&#29992;&#26469;&#21578;&#35785;VIC&#65306;&#25105;&#24819;&#35835;&#21462;&#26576;&#26576;&#20013;&#26029;&#30340;&#20013;&#26029;&#22788;&#29702;&#31243;&#24207;&#30340;&#22320;&#22336;&#65288;IRQADDR&#65289;&#12290;IRQADDRV&#26159;&#30001;VIC&#21457;&#20986;&#30340;&#20449;&#21495;&#65292;&#21578;&#35785;&#22788;&#29702;&#22120;&#65306;ISR&#30340;&#22320;&#22336;&#24050;&#32463;&#21457;&#36865;&#65292;&#32780;&#19988;&#26377;&#25928;&#65292;&#20320;&#23601;&#25918;&#24515;&#30340;&#35835;&#21543;&#12290;IRQACK&#21644;IRQADDRV&#22312;VIC&#21644;&#22788;&#29702;&#22120;&#20043;&#38388;&#23454;&#29616;&#20102;&#19968;&#20010;&#22235;&#27425;&#25569;&#25163;&#30340;&#26426;&#21046;&#12290;
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">IRQC&#22312;B1&#33267;B2&#36825;&#20010;&#26102;&#38047;&#21608;&#26399;&#20869;&#21457;&#29983;&#65292;&#28982;&#21518;&#31561;&#24453;HCLK&#30340;&#19978;&#21319;B2&#27839;&#35302;&#21457;PL192 VIC&#35774;&#32622;&#22788;&#29702;&#22120;&#30340;nIRQ&#20026;&#20302;&#12290;</li><li class="listitem">&#22788;&#29702;&#22120;&#24471;&#30693;nIRQ&#20026;&#20302;&#65292;&#24182;&#21021;&#22987;&#21270;&#19968;&#20010;&#20013;&#26029;&#24207;&#21015;&#12290;&#32422;1&#20010;HCLK&#21608;&#26399;&#21518;&#65292;IRQARRR&#34987;&#25918;&#20837;ISR&#22320;&#22336;&#12290;</li><li class="listitem">&#22312;B3&#21644;B4&#20043;&#38388;&#65292;&#22788;&#29702;&#22120;&#21028;&#26029;&#26469;&#30340;&#36825;&#20010;&#20013;&#26029;&#26159;&#19981;&#26159;IRQ&#65292;&#22914;&#26524;&#26159;&#21017;&#21457;&#36865;IRQACK &#39640;&#30005;&#24179;&#20449;&#21495;&#12290;</li><li class="listitem">&#22312;B3&#21644;B4&#36825;&#20010;&#21608;&#26399;&#20869;&#65292;&#21448;&#21457;&#29983;&#19968;&#20010;&#26356;&#39640;&#20248;&#20808;&#32423;&#30340;&#20013;&#26029;IRQB&#12290;</li><li class="listitem">&#22312;B5&#65292;PL192 VIC&#24471;&#21040;IRQACK&#39640;&#30005;&#24179;&#20449;&#21495;&#65292;&#24847;&#21619;&#30528;CPU&#21578;&#35785;&#23427;&#20934;&#22791;&#21435;&#35835;IRQADDR&#20102;&#65292;&#35831;&#23558;&#21457;&#29983;&#20013;&#26029;&#30340;&#21521;&#37327;&#22320;&#22336;&#25918;&#22312;IRQADDR&#12290;VIC&#20250;&#21028;&#26029;IRQC&#21644;IRQB&#24182;&#20915;&#23450;&#23558;&#20248;&#20808;&#32423;&#39640;&#30340;ISP&#22320;&#22336;&#25918;&#21040;IRQADDR&#20013;&#12290;</li><li class="listitem">VIC&#26356;&#26032;&#23436;IRQADRR&#21518;&#36890;&#36807;&#23558;IRQADDRV&#21464;&#20026;&#39640;&#30005;&#24179;&#21578;&#30693;CPU&#24050;&#32463;&#25918;&#32622;&#23436;&#27605;&#65292;&#35831;&#22788;&#29702;&#12290;IRQADDRV&#22312;&#22788;&#29702;&#22120;&#35835;&#21462;ISR&#22320;&#22336;&#20043;&#21069;&#19968;&#30452;&#20445;&#25345;&#39640;&#30005;&#24179;&#65292;&#27492;&#26399;&#38388;&#23631;&#34109;&#20013;&#26029;&#12290;</li><li class="listitem">&#22312;B8&#22788;&#65292;&#22788;&#29702;&#22120;&#35835;&#21462;IRQADDR&#30340;&#20540;&#65292;&#27491;&#30830;&#35835;&#21462;&#21518;&#65292;&#23601;&#23558;IRQACK&#32622;&#20302;&#65292;&#27492;&#26102;&#23427;&#30340;&#20351;&#21629;&#24050;&#32463;&#23436;&#25104;&#20102;&#12290;</li><li class="listitem">&#24403;VIC&#21457;&#29616;IRQACK&#26159;&#20302;&#30005;&#24179;&#30340;&#26102;&#20505;&#65292;&#23427;&#23558;IRQADDRV&#32622;&#20302;&#65292;&#22914;&#26524;&#27809;&#26377;&#26356;&#39640;&#20248;&#20808;&#32423;&#30340;&#20013;&#26029;&#65292;&#23427;&#20063;&#25226;nIRQ&#32622;&#39640;&#12290;</li><li class="listitem">&#24403;&#22788;&#29702;&#22120;&#24471;&#30693;IRQADDRV&#26159;&#20302;&#30005;&#24179;&#30340;&#26102;&#20505;&#65292;&#23427;&#23601;&#30693;&#36947;&#23427;&#21448;&#21487;&#20197;&#26816;&#27979;nIRQ&#20102;&#65292;&#25152;&#20197;&#22914;&#26524;VIC&#35201;&#20572;&#19968;&#27573;&#26102;&#38388;&#20877;&#23558;nIRQ&#32622;&#39640;&#30340;&#26102;&#20505;&#65292;&#24517;&#39035;&#20445;&#35777;IRQADDRV&#26159;&#39640;&#30005;&#24179;&#65292;&#19981;&#28982;&#65292;&#22788;&#29702;&#22120;&#23601;&#19968;&#30452;&#26816;&#27979;&#21040;&#26377;&#20013;&#26029;&#65292;&#20854;&#23454;&#26159;&#20013;&#26029;&#28304;&#21457;&#20986;&#30340;&#21516;&#19968;&#27425;&#20013;&#26029;&#12290;
</li></ul></div>
PL192 VIC&#26159;&#19981;&#25903;&#25345;&#24555;&#36895;&#20013;&#26029;&#30340;&#65292;&#25152;&#26377;&#30340;&#24555;&#36895;&#20013;&#26029;&#20808;&#21040;VCI1&#65292;&#21448;&#36890;&#36807;VIC0&#65292;&#26469;&#21040;&#20102;TZIC0&#65292;&#26368;&#32456;&#37117;&#30001;TZIC0&#19968;&#20010;&#20010;&#30340;&#21457;&#36865;&#21040;ARM1176&#20102;&#12290;
<div class="figure"><a name="idp81304500"></a><p class="title"><b>&#22270; 92. S3C5410&#20013;&#26029;&#25511;&#21046;&#22120;</b></p><div class="figure-contents"><div><img src="images/int_tzic.gif" alt="S3C5410&#20013;&#26029;&#25511;&#21046;&#22120;"></div></div></div><br class="figure-break">
</div>
<div class="sect2" title="16.7. &#20013;&#26029;&#25511;&#21046;&#23492;&#23384;&#22120;"><div class="titlepage"><div><div><h3 class="title"><a name="idp81305172"></a>16.7. &#20013;&#26029;&#25511;&#21046;&#23492;&#23384;&#22120;</h3></div></div></div>
VIC0&#30340;&#22522;&#22336;&#26159;0x71200000&#65292;VIC1&#30340;&#22522;&#22336;&#26159;0x71300000&#12290;&#25511;&#21046;&#23492;&#23384;&#22120;&#22320;&#22336; = &#20559;&#31227;&#22320;&#22336; + VICn&#22522;&#22336;&#12290;
<div class="sect3" title="16.7.1. &#20013;&#26029;&#29366;&#24577;&#23492;&#23384;&#22120;"><div class="titlepage"><div><div><h4 class="title"><a name="idp81305668"></a>16.7.1. &#20013;&#26029;&#29366;&#24577;&#23492;&#23384;&#22120;</h4></div></div></div>
&#22312;&#20351;&#33021;&#20013;&#26029;&#65292;&#24182;&#24320;&#25918;&#35813;&#20013;&#26029;&#23631;&#34109;&#20301;&#26102;&#65292;&#36890;&#36807;&#35835;&#21462;&#20013;&#26029;&#29366;&#24577;&#23492;&#23384;&#22120;&#30340;&#20540;&#26469;&#33719;&#21462;&#21457;&#29983;&#20013;&#26029;&#30340;&#20013;&#26029;&#21495;&#12290;
<pre class="programlisting">
&#23492;&#23384;&#22120;            &#22320;&#22336;    &#35835;/&#20889;         &#25551;&#36848;           &#22797;&#20301;&#20540;
VIC0IRQSTATUS 0x7120_0000 &#35835;    IRQ &#29366;&#24577;&#23492;&#23384;&#22120;(VIC0) 0x0000_0000
VIC1IRQSTATUS 0x7130_0000 &#35835;    IRQ &#29366;&#24577;&#23492;&#23384;&#22120;(VIC1) 0x0000_0000

VIC0FIQSTATUS 0x7120_0004 &#35835;    FIQ &#29366;&#24577;&#23492;&#23384;&#22120;(VIC0) 0x0000_0000
VIC1FIQSTATUS 0x7130_0004 &#35835;    FIQ &#29366;&#24577;&#23492;&#23384;&#22120;(VIC1) 0x0000_0000
</pre>
&#27599;&#20010;&#20013;&#26029;&#28304;&#37117;&#23545;&#24212;&#23492;&#23384;&#22120;&#20869;&#30340;&#19968;&#20010;&#20301;&#65292;&#25152;&#20197;64&#20010;&#20013;&#26029;&#28304;&#20998;&#21035;&#23545;&#24212;&#21040;VIC0&#21644;VIC1&#12290;
<pre class="programlisting">
&#21517;&#31216;          &#20301;                      &#25551;&#36848;                                       &#22797;&#20301;&#20540;
F/IRQStatus [31:0] &#22312;&#23631;&#34109;&#20043;&#21518;&#65292;&#36890;&#36807;VICxINTENABLE &#21644;VICxINTSELECT &#23492;&#23384;&#22120;&#26174;&#31034;         0
                               &#20013;&#26029;&#30340;&#29366;&#24577;
                               0=&#20013;&#26029;&#19981;&#34987;&#28608;&#27963;&#65288;&#22797;&#20301;&#65289;
                               1=&#20013;&#26029;&#34987;&#28608;&#27963;                             
</pre>
&#36890;&#24120;&#22312;Linux&#20195;&#30721;&#20013;&#36890;&#36807;get_irqnr_and_base&#27719;&#32534;&#20195;&#30721;&#26469;&#35835;&#21462;&#35813;&#23492;&#23384;&#22120;&#20197;&#33719;&#21462;&#20013;&#26029;&#21495;&#12290;
<pre class="programlisting">
arch/arm/mach-s3c6400/include/mach/entry-macro.S
.macro  get_irqnr_and_base, irqnr, irqstat, base, tmp

@ check the vic0
mov     \irqnr, # S3C_IRQ_OFFSET + 31
ldr     \irqstat, [ \base, # VIC_IRQ_STATUS ]
teq     \irqstat, #0
.....
</pre>
</div>
<div class="sect3" title="16.7.2. &#31867;&#22411;&#36873;&#25321;&#23492;&#23384;&#22120;"><div class="titlepage"><div><div><h4 class="title"><a name="idp81308420"></a>16.7.2. &#31867;&#22411;&#36873;&#25321;&#23492;&#23384;&#22120;</h4></div></div></div>
<pre class="programlisting">
&#23492;&#23384;&#22120;            &#22320;&#22336;    &#35835;/&#20889;         &#25551;&#36848;           &#22797;&#20301;&#20540;
VIC0INTSELECT 0x7120_000C &#35835;/&#20889; &#20013;&#26029;&#36873;&#25321;&#23492;&#23384;&#22120;(VIC0) 0x0000_0000
VIC1INTSELECT 0x7130_000C &#35835;/&#20889; &#20013;&#26029;&#36873;&#25321;&#23492;&#23384;&#22120;(VIC1) 0x0000_0000
</pre>
&#20013;&#26029;&#36873;&#25321;&#23492;&#23384;&#22120;&#20915;&#23450;&#35813;&#20013;&#26029;&#30340;&#31867;&#22411;&#65292;&#36890;&#24120;&#35774;&#32622;&#20026;IRQ&#12290;&#27599;&#20010;&#20013;&#26029;&#28304;&#37117;&#23545;&#24212;&#19968;&#20010;&#23492;&#23384;&#22120;&#20301;&#12290;
<pre class="programlisting">
&#21517;&#31216;         &#20301;            &#25551;&#36848;                         &#22797;&#20301;&#20540;
IntSelect [31:0]    &#20026;&#20013;&#26029;&#35831;&#27714;&#36873;&#25321;&#20013;&#26029;&#30340;&#29366;&#24577;
                      0=IRQ &#20013;&#26029;&#65288;&#22797;&#20301;&#65289;
                      1=FIQ &#20013;&#26029;                         0x0
</pre>
</div>
<div class="sect3" title="16.7.3. &#20351;&#33021;&#31105;&#27490;&#23492;&#23384;&#22120;"><div class="titlepage"><div><div><h4 class="title"><a name="idp81310060"></a>16.7.3. &#20351;&#33021;&#31105;&#27490;&#23492;&#23384;&#22120;</h4></div></div></div>
<pre class="programlisting">
&#23492;&#23384;&#22120;            &#22320;&#22336;    &#35835;/&#20889;         &#25551;&#36848;             &#22797;&#20301;&#20540;
VIC0INTENABLE 0x7120_0010 &#35835;/&#20889; &#20013;&#26029;&#20351;&#33021;&#23492;&#23384;&#22120;(VIC0)    0x0000_0000
VIC1INTENABLE 0x7130_0010 &#35835;/&#20889; &#20013;&#26029;&#20351;&#33021;&#23492;&#23384;&#22120;(VIC1)    0x0000_0000

VIC0INTENCLEAR 0x7120_0014 &#20889;   &#20013;&#26029;&#20351;&#33021;&#28165;&#38500;&#23492;&#23384;&#22120;(VIC0)   -
VIC1INTENCLEAR 0x7130_0014 &#20889;   &#20013;&#26029;&#20351;&#33021;&#28165;&#38500;&#23492;&#23384;&#22120;(VIC1)   -
</pre>
<pre class="programlisting">
&#21517;&#31216;         &#20301;                &#25551;&#36848;                      &#22797;&#20301;&#20540;
IntEnable [31:0] &#20351;&#33021;&#20013;&#26029;&#35831;&#27714;&#65292;&#20801;&#35768;&#20013;&#26029;&#21040;&#36798;&#22788;&#29702;&#22120;
                 &#35835;&#65306;0=&#20013;&#26029;&#31105;&#27490;&#65288;&#22797;&#20301;&#65289;
                     1=&#20013;&#26029;&#20351;&#33021;                 
                 VICINTENCLEAR &#23492;&#23384;&#22120;&#29992;&#26469;&#28165;&#38500;&#20013;&#26029;&#20351;&#33021;&#12290;    0x0
                 &#20889;&#65306;0=&#27809;&#26377;&#24433;&#21709; 1=&#20013;&#26029;&#20351;&#33021; 
</pre>
&#20013;&#26029;&#20351;&#33021;&#21482;&#33021;&#29992;&#35813;&#23492;&#23384;&#22120;&#35774;&#32622;&#12290;&#20294;&#26159;&#20013;&#26029;&#31105;&#27490;&#24182;&#19981;&#26159;&#36890;&#36807;&#20889;&#35813;&#23492;&#23384;&#22120;&#20026;0&#65292;&#32780;&#26159;&#36890;&#36807;VICINTENCLEAR&#65292;&#27880;&#24847;&#23427;&#26159;&#21482;&#20889;&#30340;&#12290;
<pre class="programlisting">
&#21517;&#31216;               &#20301;                &#25551;&#36848;                      &#22797;&#20301;&#20540;
IntEnable Clear [31:0] &#22312;VICINTENABLE &#23492;&#23384;&#22120;&#20869;&#28165;&#38500;&#30456;&#24212;&#30340;&#20301;
                       0=&#27809;&#26377;&#24433;&#21709;&#65288;&#22797;&#20301;&#65289;
                       1=&#22312;VICINTENABLE &#23492;&#23384;&#22120;&#20869;&#20013;&#26029;disabled     -                       
</pre>
</div>
<div class="sect3" title="16.7.4. &#36719;&#20214;&#20013;&#26029;&#23492;&#23384;&#22120;"><div class="titlepage"><div><div><h4 class="title"><a name="idp81312732"></a>16.7.4. &#36719;&#20214;&#20013;&#26029;&#23492;&#23384;&#22120;</h4></div></div></div>
&#36719;&#20214;&#20013;&#26029;&#20351;&#33021;&#23492;&#23384;&#22120;&#65306;
<pre class="programlisting">
&#23492;&#23384;&#22120;            &#22320;&#22336;    &#35835;/&#20889;         &#25551;&#36848;             &#22797;&#20301;&#20540;
VIC0SOFTINT 0x7120_0018   &#35835;/&#20889;     &#36719;&#20214;&#20013;&#26029;&#23492;&#23384;&#22120;(VIC0) 0x0000_0000
VIC1SOFTINT 0x7130_0018   &#35835;/&#20889;     &#36719;&#20214;&#20013;&#26029;&#23492;&#23384;&#22120;(VIC1) 0x0000_0000
</pre>
<pre class="programlisting">
&#21517;&#31216;         &#20301;                      &#25551;&#36848;                              &#22797;&#20301;&#20540;
IntEnable [31:0] &#22312;&#20013;&#26029;&#23631;&#34109;&#20043;&#21069;&#35774;&#32622;HIGH &#20301;&#23545;&#36873;&#25321;&#30340;&#28304;&#20135;&#29983;&#36719;&#20214;&#20013;&#26029;         0x0
                 &#35835;&#65306;0=&#36719;&#20214;&#20013;&#26029;&#19981;&#34987;&#28608;&#27963;&#65288;&#22797;&#20301;&#65289;
                     1=&#36719;&#20214;&#20013;&#26029;&#34987;&#28608;&#27963;
                 &#20889;&#65306;0=&#27809;&#26377;&#24433;&#21709;
                 1=&#36719;&#20214;&#20013;&#26029;&#20351;&#33021;
</pre>
&#36719;&#20214;&#20013;&#26029;&#28165;&#38500;&#23492;&#23384;&#22120;&#65306;
<pre class="programlisting">
&#23492;&#23384;&#22120;            &#22320;&#22336;         &#35835;/&#20889;         &#25551;&#36848;                &#22797;&#20301;&#20540;
VIC0SOFTINTENCLEAR 0x7120_001C &#20889;    &#36719;&#20214;&#20013;&#26029;&#28165;&#38500;&#23492;&#23384;&#22120;(VIC0)   -
VIC1SOFTINTENCLEAR 0x7130_001C &#20889;    &#36719;&#20214;&#20013;&#26029;&#28165;&#38500;&#23492;&#23384;&#22120;(VIC1)   -
</pre>

<pre class="programlisting">
&#21517;&#31216;             &#20301;              &#25551;&#36848;                    &#22797;&#20301;&#20540;
SoftInt Clear [31:0] &#22312;VICSOFTINT &#23492;&#23384;&#22120;&#20869;&#28165;&#38500;&#30456;&#24212;&#30340;&#20301;
                     0=&#27809;&#26377;&#24433;&#21709;&#65288;&#22797;&#20301;&#65289;
                     1=&#22312;VICSOFTINT &#23492;&#23384;&#22120;&#20869;&#20013;&#26029;disabled   -
</pre>
</div>
<div class="sect3" title="16.7.5. &#20445;&#25252;&#20351;&#33021;&#23492;&#23384;&#22120;"><div class="titlepage"><div><div><h4 class="title"><a name="idp81315724"></a>16.7.5. &#20445;&#25252;&#20351;&#33021;&#23492;&#23384;&#22120;</h4></div></div></div>
&#24403;&#20445;&#25252;&#27169;&#24335;&#20351;&#33021;&#26102;&#65292;&#21482;&#26377;&#29305;&#26435;&#27169;&#24335;&#21487;&#20197;&#35775;&#38382;&#65288;&#36827;&#34892;&#35835;&#21644;&#20889;&#65289;&#20013;&#26029;&#25511;&#21046;&#23492;&#23384;&#22120;&#12290;&#24403;&#20445;&#25252;&#27169;&#24335;&#31105;&#27490;&#26102;&#65292;&#29992;&#25143;&#27169;&#24335;&#21644;&#29305;&#26435;&#27169;&#24335;&#37117;&#21487;&#20197;&#35775;&#38382;&#23492;&#23384;&#22120;&#12290;
&#24403;&#20445;&#25252;&#27169;&#24335;&#31105;&#27490;&#26102;&#65292;&#36825;&#20010;&#23492;&#23384;&#22120;&#21482;&#33021;&#22312;&#29305;&#26435;&#27169;&#24335;&#19979;&#34987;&#35775;&#38382;&#12290;
<pre class="programlisting">
&#23492;&#23384;&#22120;            &#22320;&#22336;     &#35835;/&#20889;         &#25551;&#36848;             &#22797;&#20301;&#20540;
VIC0PROTECTION 0x7120_0020 &#35835;/&#20889; &#20445;&#25252;&#20351;&#33021;&#23492;&#23384;&#22120;(VIC0) 0x0000_0000
VIC1PROTECTION 0x7130_0020 &#35835;/&#20889; &#20445;&#25252;&#20351;&#33021;&#23492;&#23384;&#22120;(VIC1) 0x0000_0000
</pre>
<pre class="programlisting">
&#21517;&#31216;        &#20301;                &#25551;&#36848;              &#22797;&#20301;&#20540;
Reserved  [31:1]  &#20445;&#30041;&#65292;&#20316;&#20026;0 &#35835;&#21462;&#65292;&#19981;&#35201;&#20462;&#25913;     0x0
IntEnable [0]     &#20351;&#33021;&#25110;&#31105;&#27490;&#20445;&#25252;&#23492;&#23384;&#22120;&#35775;&#38382;&#65306;     0x0
                  0=&#20445;&#25252;&#27169;&#24335;&#31105;&#27490;&#65288;&#22797;&#20301;&#65289;
                  1=&#20445;&#25252;&#27169;&#24335;&#20351;&#33021;
</pre>
</div>
<div class="sect3" title="16.7.6. &#30690;&#37327;&#20248;&#20808;&#23492;&#23384;&#22120;"><div class="titlepage"><div><div><h4 class="title"><a name="idp81317564"></a>16.7.6. &#30690;&#37327;&#20248;&#20808;&#23492;&#23384;&#22120;</h4></div></div></div>
&#27599;&#20010;VIC&#25317;&#26377;32&#20010;&#20248;&#20808;&#32423;&#23492;&#23384;&#22120;&#65292;&#20998;&#21035;&#23545;&#24212;&#20013;&#26029;0-31&#30340;&#20248;&#20808;&#32423;&#12290;
<pre class="programlisting">
&#23492;&#23384;&#22120;                         &#22320;&#22336;             &#35835;/&#20889;         &#25551;&#36848;                &#22797;&#20301;&#20540;
VIC0VECTPRIORITY[31:0] 0x7120_0200~0x7120_027C  &#35835;/&#20889; &#30690;&#37327;&#20248;&#20808;[31:0]&#23492;&#23384;&#22120;(VIC0) 0x0000_000F
VIC1 VECTPRIORITY[31:0] 0x7130_0200~0x7130_027C &#35835;/&#20889; &#30690;&#37327;&#20248;&#20808;[31:0]&#23492;&#23384;&#22120;(VIC1) 0x0000_000F
</pre>

<pre class="programlisting">
&#21517;&#31216;        &#20301;                &#25551;&#36848;                                  &#22797;&#20301;&#20540;
Reserved   [31:4] &#20445;&#30041;&#65292;&#20316;&#20026;0 &#35835;&#21462;&#65292;&#19981;&#35201;&#20462;&#25913;                         0x0
VectorAddr [3:0]  &#36873;&#25321;&#30690;&#37327;&#20013;&#26029;&#20248;&#20808;&#32423;&#12290;&#21487;&#20197;&#36873;&#25321;16 &#36827;&#21046;&#25968;0~15 &#33539;&#22260;
                  &#20869;&#30340;&#20219;&#20309;&#19968;&#20010;&#30690;&#37327;&#20013;&#26029;&#20248;&#20808;&#32423;&#20540;&#36816;&#34892;&#23492;&#23384;&#22120;&#12290;           0x0000_0000
</pre>
</div>
</div>
<div class="sect2" title="16.8. Linux&#20869;&#26680;&#20013;&#26029;&#25277;&#35937;"><div class="titlepage"><div><div><h3 class="title"><a name="idp81319404"></a>16.8. Linux&#20869;&#26680;&#20013;&#26029;&#25277;&#35937;</h3></div></div></div>
Linux&#23545;&#20013;&#26029;&#22788;&#29702;&#36827;&#34892;&#20102;&#20960;&#20010;&#23618;&#27425;&#30340;&#25277;&#35937;&#65306;&#33455;&#29255;&#32423;&#20013;&#26029;&#22788;&#29702;&#22120;&#65292;&#20013;&#26029;&#22788;&#29702;&#22120;&#30340;&#30005;&#27969;&#22788;&#29702;&#21644;&#39640;&#23618;&#30340;ISR&#12290;&#36825;&#26679;Linux&#23601;&#21487;&#20197;&#23631;&#34109;&#19981;&#21516;&#20307;&#31995;&#26550;&#26500;&#30340;&#20013;&#26029;&#25511;&#21046;&#22120;&#33455;&#29255;&#23454;&#29616;&#30340;&#19981;&#21516;&#65292;&#32780;&#25552;&#20379;&#32479;&#19968;&#30340;&#25509;&#21475;&#12290;&#36825;&#19977;&#20010;&#23618;&#27425;&#30340;&#25277;&#35937;&#20449;&#24687;&#21448;&#36890;&#36807;&#25351;&#38024;&#24341;&#29992;&#30340;&#24418;&#24335;&#34987;&#38598;&#20013;&#23553;&#35013;&#22312;&#20102;&#19968;&#20010;&#21517;&#20026;irq_desc&#30340;&#32467;&#26500;&#20307;&#20869;&#12290;IRQ&#30456;&#20851;&#30340;&#31649;&#29702;&#20449;&#24687;&#34987;&#23450;&#20041;&#25104;&#35813;&#32467;&#26500;&#20307;&#31867;&#22411;&#30340;&#19968;&#20010;&#20840;&#23616;&#25968;&#32452;&#65292;&#27599;&#20010;&#25968;&#32452;&#32034;&#24341;&#23545;&#24212;&#19968;&#20010;IRQ&#21495;&#12290;&#23427;&#26159;Linux&#20013;&#26029;&#23376;&#31995;&#32479;&#30340;&#26680;&#24515;&#25968;&#25454;&#32467;&#26500;&#12290;
<pre class="programlisting">
kernel/irq/handle.c
int nr_irqs = NR_IRQS;
EXPORT_SYMBOL_GPL(nr_irqs);

struct irq_desc irq_desc[NR_IRQS] __cacheline_aligned_in_smp = {
	[0 ... NR_IRQS-1] = {
		.status = IRQ_DISABLED,
		.chip = &amp;no_irq_chip,
		.handle_irq = handle_bad_irq,
		.depth = 1,
		.lock = __SPIN_LOCK_UNLOCKED(irq_desc-&gt;lock),
#ifdef CONFIG_SMP
		.affinity = CPU_MASK_ALL
#endif
	}
};
</pre>
&#30001;&#20110;&#19981;&#21516;&#30340;&#20013;&#26029;&#25511;&#21046;&#22120;&#25903;&#25345;&#19981;&#21516;&#30340;&#20013;&#26029;&#20010;&#25968;&#65292;&#25152;&#20197;NR_IRQS&#34987;&#23450;&#20041;&#22312;arch/arm/&#20307;&#31995;&#26550;&#26500;&#30456;&#20851;&#30340;&#25991;&#20214;&#22841;&#19979;&#12290;&#21478;&#22806;&#27880;&#24847;&#21040;&#40664;&#35748;&#20540;&#12290;&#20026;&#20102;&#29702;&#35299;&#36825;&#20123;&#40664;&#35748;&#20540;&#30340;&#20316;&#29992;&#65292;&#24517;&#35201;&#27604;struct irq_desc&#21508;&#25104;&#21592;&#36827;&#34892;&#20998;&#26512;&#65306;
<pre class="programlisting">
struct irq_desc {
	unsigned int		irq;
	irq_flow_handler_t	handle_irq;
	struct irq_chip		*chip;
	struct msi_desc		*msi_desc;
	void			*handler_data;
	void			*chip_data;
	struct irqaction	*action;	/* IRQ action list */
	unsigned int		status;		/* IRQ status */

	unsigned int		depth;		/* nested irq disables */
	unsigned int		wake_depth;	/* nested wake enables */
	unsigned int		irq_count;	/* For detecting broken IRQs */
	unsigned int		irqs_unhandled;
	unsigned long		last_unhandled;	/* Aging timer for unhandled count */
	spinlock_t		lock;
......
	const char		*name;
} ____cacheline_internodealigned_in_smp;
</pre>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">handle_irq&#26159;&#20010;&#20989;&#25968;&#25351;&#38024;&#65292;&#23427;&#29992;&#26469;&#23454;&#29616;&#20013;&#26029;&#22788;&#29702;&#22120;&#30340;&#30005;&#27969;&#22788;&#29702;&#12290;&#30005;&#27969;&#22788;&#29702;&#20998;&#20026;&#36793;&#27839;&#36339;&#21464;&#22788;&#29702;&#21644;&#30005;&#24179;&#22788;&#29702;&#12290;</li><li class="listitem">chip&#26159;&#23545;&#20013;&#26029;&#22788;&#29702;&#22120;&#33455;&#29255;&#21151;&#33021;&#30340;&#23553;&#35013;&#65306;&#20013;&#26029;&#20351;&#33021;&#20989;&#25968;&#65292;&#23631;&#34109;&#20989;&#25968;&#65292;&#30830;&#35748;&#20989;&#25968;&#31561;&#12290;</li><li class="listitem">handler_data&#25351;&#21521;ISR&#22788;&#29702;&#31243;&#24207;&#25152;&#38656;&#30340;&#20219;&#24847;&#25968;&#25454;&#32467;&#26500;&#20307;&#12290;</li><li class="listitem">chip_data&#25351;&#21521;&#19982;chip&#25805;&#20316;&#30456;&#20851;&#30340;&#20219;&#24847;&#32467;&#26500;&#20307;&#65292;&#27604;&#22914;&#20013;&#26029;&#22788;&#29702;&#22120;&#25511;&#21046;&#23492;&#23384;&#22120;&#30340;&#22522;&#22320;&#22336;&#12290;</li><li class="listitem">action&#25552;&#20379;&#20102;ISR&#38656;&#35201;&#25805;&#20316;&#30340;&#19968;&#20010;&#20989;&#25968;&#38142;&#34920;&#65292;&#20013;&#26029;&#21457;&#29983;&#30340;&#30446;&#30340;&#23601;&#26159;&#35201;&#25191;&#34892;&#36825;&#20123;&#21160;&#20316;&#38142;&#34920;&#20013;&#30340;&#20989;&#25968;&#12290;</li><li class="listitem">status&#25351;&#26126;&#20102;&#24403;&#21069;&#20013;&#26029;&#30340;&#29366;&#24577;&#65306;&#20351;&#33021;&#65292;&#31105;&#27490;&#65292;&#35774;&#22791;&#20849;&#20139;&#31561;&#12290;</li><li class="listitem">depth&#26159;&#19968;&#20010;&#20869;&#26680;&#20013;&#26029;&#25351;&#31034;&#35745;&#25968;&#22120;&#65292;&#34987;&#21021;&#22987;&#21270;&#20026;1&#65292;&#24403;&#20869;&#26680;&#35843;&#29992;setup_irq&#21551;&#29992;&#20013;&#26029;&#26102;&#20943;1&#65292;&#32780;&#35843;&#29992;disable_irq&#26102;&#34987;&#21152;1&#12290;&#36890;&#36807;&#35813;&#20540;&#22788;&#29702;&#20013;&#26029;&#31105;&#29992;&#23884;&#22871;&#12290;</li><li class="listitem">name&#21017;&#26159;&#22312;&#23433;&#35013;handle_irq&#26102;&#20256;&#36882;&#32473;__set_irq_handler&#30340;&#26368;&#21518;&#19968;&#20010;&#21442;&#25968;&#65292;&#21487;&#20197;&#20026;NULL&#12290;&#36890;&#36807;/proc/interrupts&#26597;&#30475;&#23427;&#12290;&#29992;&#26469;&#25551;&#36848;&#30005;&#27969;&#22788;&#29702;&#30340;&#21517;&#31216;&#12290;</li><li class="listitem">lock&#29992;&#26469;&#22312;SMP&#19978;&#36827;&#34892;&#23545;&#24403;&#21069;irq_desc&#30340;&#38145;&#23450;&#12290;</li><li class="listitem">irq_count&#65292;irqs_unhandled&#21644;last_unhandled&#23383;&#27573;&#20379;&#32479;&#35745;&#20449;&#24687;&#12290;&#23427;&#20204;&#22343;&#22312;note_interrupt&#20989;&#25968;&#20013;&#34987;&#32479;&#35745;&#12290;</li></ul></div>
<div class="sect3" title="16.8.1. &#20013;&#26029;&#33455;&#29255;&#25277;&#35937;"><div class="titlepage"><div><div><h4 class="title"><a name="idp81322292"></a>16.8.1. &#20013;&#26029;&#33455;&#29255;&#25277;&#35937;</h4></div></div></div>
<pre class="programlisting">
include/linux/irq.h
struct irq_chip {
	const char	*name;
	unsigned int	(*startup)(unsigned int irq);
	void		(*shutdown)(unsigned int irq);
	void		(*enable)(unsigned int irq);
	void		(*disable)(unsigned int irq);

	void		(*ack)(unsigned int irq);
	void		(*mask)(unsigned int irq);
	void		(*mask_ack)(unsigned int irq);
	void		(*unmask)(unsigned int irq);
	void		(*eoi)(unsigned int irq);
......
	int		(*set_type)(unsigned int irq, unsigned int flow_type);
......
};
</pre>
&#33455;&#29255;&#32423;&#20013;&#26029;&#22788;&#29702;&#22120;&#34987;&#23553;&#35013;&#22312;&#21517;&#20026;irq_chip&#30340;&#32467;&#26500;&#20307;&#20013;&#65306;
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">name&#29992;&#20110;&#26631;&#35782;&#20013;&#26029;&#25511;&#21046;&#22120;&#65292;&#27604;&#22914;&#8220;VIC&#8221;&#12290;</li><li class="listitem">startup&#25351;&#21521;&#19968;&#20010;&#20989;&#25968;&#65292;&#29992;&#20110;&#31532;&#19968;&#27425;&#20351;&#33021;&#21442;&#25968;&#25351;&#23450;&#30340;irq&#20013;&#26029;&#21495;&#23545;&#24212;&#30340;&#30828;&#20214;&#23492;&#23384;&#22120;&#12290;&#22914;&#26524;&#19981;&#25552;&#20379;&#65292;&#21017;&#31995;&#32479;&#30452;&#25509;&#23433;&#35013;&#40664;&#35748;&#20989;&#25968;default_startup&#65292;&#23427;&#30452;&#25509;&#35843;&#29992;enable&#20989;&#25968;&#25351;&#38024;&#25351;&#21521;&#30340;&#20989;&#25968;&#12290;</li><li class="listitem">disable/enable&#20989;&#25968;&#29992;&#20110;&#31105;&#27490;/&#20351;&#33021;&#20013;&#26029;&#65292;&#20063;&#21363;&#25511;&#21046;&#20013;&#26029;&#20351;&#33021;&#31105;&#27490;&#23492;&#23384;&#22120;&#12290;</li><li class="listitem">ack&#29992;&#20110;CPU&#23545;&#20013;&#26029;&#25511;&#21046;&#22120;&#30340;&#30830;&#35748;&#65292;&#36890;&#24120;&#30452;&#25509;&#35843;&#29992;mask&#20989;&#25968;&#31105;&#27490;&#35813;&#20013;&#26029;&#21363;&#21487;&#12290;</li><li class="listitem">mask&#29992;&#20110;&#35774;&#32622;&#23631;&#34109;&#20301;&#65292;&#22914;&#26524;&#30828;&#20214;&#27809;&#26377;&#23631;&#34109;&#23492;&#23384;&#22120;&#65292;&#37027;&#20040;&#23601;&#30452;&#25509;&#25805;&#20316;&#31105;&#27490;&#23492;&#23384;&#22120;&#12290;</li><li class="listitem">unmask&#19982;mask&#30456;&#21453;&#65292;&#29992;&#20110;&#28165;&#38500;&#23631;&#34109;&#20301;&#65292;&#22914;&#26524;&#30828;&#20214;&#27809;&#26377;&#23631;&#34109;&#23492;&#23384;&#22120;&#65292;&#37027;&#20040;&#23601;&#30452;&#25509;&#25805;&#20316;&#31105;&#27490;&#23492;&#23384;&#22120;&#12290;</li><li class="listitem">set_type&#35774;&#32622;IRQ&#30340;&#30005;&#27969;&#31867;&#22411;&#12290;&#35813;&#26041;&#27861;&#20027;&#35201;&#22312;ARM&#65292;PowerPC&#31561;&#20351;&#29992;&#12290;&#36890;&#24120;&#21482;&#26377;irq_desc&#22312;&#27880;&#20876;action&#26102;&#65292;&#26631;&#35760;&#26377;IRQF_TRIGGER_MASK&#25165;&#20250;&#35843;&#29992;&#35813;&#20989;&#25968;&#37325;&#26032;&#35774;&#32622;&#35302;&#21457;&#31867;&#22411;&#12290;</li></ul></div>
<pre class="programlisting">
static struct irq_chip vic_chip = {
	.name	= "VIC",
	.ack	= vic_mask_irq,
	.mask	= vic_mask_irq,
	.unmask	= vic_unmask_irq,
};
</pre>
vic_init&#35843;&#29992;set_irq_chip&#20026;&#27599;&#20010;&#20013;&#26029;&#21495;&#35774;&#32622;chip&#20026;vic_chip&#12290;&#23427;&#21482;&#23454;&#29616;&#20102;&#20004;&#20010;&#20989;&#25968;&#65292;vic_mask_irq&#26082;&#26159;&#23545;&#20013;&#26029;&#31105;&#27490;&#23492;&#23384;&#22120;&#30340;&#25805;&#20316;&#65292;vic_unmask_irq&#21017;&#26159;&#23545;&#20013;&#26029;&#20351;&#33021;&#23492;&#23384;&#22120;&#30340;&#25805;&#20316;&#12290;
</div>
<div class="sect3" title="16.8.2. &#20013;&#26029;&#30005;&#27969;&#22788;&#29702;"><div class="titlepage"><div><div><h4 class="title"><a name="idp81330380"></a>16.8.2. &#20013;&#26029;&#30005;&#27969;&#22788;&#29702;</h4></div></div></div>
&#23613;&#31649;&#20013;&#26029;&#30005;&#27969;&#22788;&#29702;&#21644;&#30828;&#20214;&#24687;&#24687;&#30456;&#20851;&#65292;Linux&#20381;&#28982;&#25552;&#20379;&#20102;&#39640;&#23618;&#27425;&#30340;&#23553;&#35013;&#26469;&#32479;&#19968;&#22788;&#29702;&#36825;&#20123;&#19981;&#21516;&#65306;&#36793;&#27839;&#35302;&#21457;&#21644;&#30005;&#24179;&#35302;&#21457;&#12290;&#36825;&#20004;&#31867;&#20989;&#25968;&#37117;&#34987;&#23553;&#35013;&#25104;&#22914;&#19979;&#30340;&#24418;&#24335;&#65292;&#21442;&#25968;&#21253;&#25324;&#19968;&#20010;IRQ&#21495;&#21644;&#19968;&#20010;&#25351;&#21521;&#36127;&#36131;&#35813;&#20013;&#26029;&#30340;irq_desc&#12290;
<pre class="programlisting">
typedef	void (*irq_flow_handler_t)(unsigned int irq,
					    struct irq_desc *desc);
</pre>
&#20174;&#27969;&#31243;&#22270;&#20013;&#21487;&#20197;&#30475;&#20986;&#30495;&#27491;&#30340;&#20013;&#26029;&#21160;&#20316;&#22312;handle_IRQ_event&#20013;&#34987;&#25191;&#34892;&#12290;
<div class="figure"><a name="idp81331500"></a><p class="title"><b>&#22270; 93. &#30005;&#27969;&#22788;&#29702;&#27969;&#31243;</b></p><div class="figure-contents"><div><img src="images/int_handle.gif" alt="&#30005;&#27969;&#22788;&#29702;&#27969;&#31243;"></div>
</div></div><br class="figure-break">
&#24403;&#21069;&#30828;&#20214;&#22823;&#22810;&#25968;&#37319;&#29992;&#36793;&#27839;&#35302;&#21457;&#20013;&#26029;&#65292;&#34987;&#23553;&#35013;&#22312;handle_edge_irq&#22788;&#29702;&#20989;&#25968;&#20013;&#12290;&#22312;&#22788;&#29702;&#36793;&#27839;&#35302;&#21457;&#30340;IRQ&#26102;&#26080;&#38656;&#20013;&#26029;&#65292;&#36825;&#19982;&#30005;&#24179;&#35302;&#21457;&#19981;&#21516;&#12290;&#36825;&#23545;SMP&#31995;&#32479;&#26377;&#19968;&#20010;&#37325;&#35201;&#30340;&#24433;&#21709;&#65306;&#24403;&#22312;&#19968;&#20010;CPU&#19978;&#22788;&#29702;&#19968;&#20010;IRQ&#26102;&#65292;&#21478;&#19968;&#20010;&#21516;&#26679;IRQ&#21495;&#30340;&#20013;&#26029;&#21487;&#20197;&#20986;&#29616;&#22312;&#21478;&#19968;&#20010;CPU&#19978;&#12290;&#20294;&#26159;&#36825;&#31181;&#24773;&#20917;&#24212;&#35813;&#36991;&#20813;&#65306;&#20013;&#26029;&#21160;&#20316;&#21487;&#33021;&#23545;&#24212;&#30528;&#21516;&#19968;&#20010;&#21464;&#37327;&#65292;&#23427;&#20204;&#19981;&#24212;&#35813;&#34987;&#21516;&#26102;&#35775;&#38382;&#12290;handle_edge_irq&#30340;&#24320;&#22987;&#39318;&#20808;&#21028;&#26029;IRQ_INPROGRESS&#26631;&#24535;&#20301;&#65292;&#22914;&#26524;&#35813;&#26631;&#24535;&#20301;&#23384;&#22312;&#24847;&#21619;&#30528;&#35813;&#20013;&#26029;&#24050;&#32463;&#22312;&#21478;&#22806;&#30340;CPU&#19978;&#34987;&#22788;&#29702;&#65292;&#21017;&#35774;&#32622;IRQ_PENDING|IRQ_MASKED&#26631;&#24535;&#65292;&#36825;&#24847;&#21619;&#30528;&#20869;&#26680;&#23558;&#22312;&#31245;&#21518;&#22788;&#29702;&#35813;&#20013;&#26029;&#65292;&#21478;&#22806;&#35843;&#29992;mask_ack_irq&#26469;&#20020;&#26102;&#31105;&#27490;&#35813;&#20013;&#26029;&#12290;
<pre class="programlisting">
	if (unlikely((desc-&gt;status &amp; (IRQ_INPROGRESS | IRQ_DISABLED)) ||
		    !desc-&gt;action)) {
		desc-&gt;status |= (IRQ_PENDING | IRQ_MASKED);
		mask_ack_irq(desc, irq);
		goto out_unlock;
	}
</pre>
handle_edge_irq&#20013;&#25552;&#20379;&#20102;&#19968;&#20010;&#26816;&#27979;IRQ_PENDING | IRQ_MASKED&#30340;&#24490;&#29615;&#65292;&#36825;&#24847;&#21619;&#30528;&#31532;&#19968;&#20010;CPU&#23558;&#22312;&#31245;&#21518;&#26102;&#20505;&#22788;&#29702;&#35813;&#20013;&#26029;&#65292;&#24182;&#22312;&#22788;&#29702;&#21069;&#35843;&#29992;unmask&#26469;&#25171;&#24320;&#20013;&#26029;&#65292;&#20197;&#20415;&#20854;&#23427;CPU&#21487;&#20197;&#22788;&#29702;&#32039;&#25509;&#30340;&#20013;&#26029;&#12290;
<pre class="programlisting">
	do {
	......
		if (unlikely((desc-&gt;status &amp;
			       (IRQ_PENDING | IRQ_MASKED | IRQ_DISABLED)) ==
			      (IRQ_PENDING | IRQ_MASKED))) {
			desc-&gt;chip-&gt;unmask(irq);
			desc-&gt;status &amp;= ~IRQ_MASKED;
		}

		desc-&gt;status &amp;= ~IRQ_PENDING;
		spin_unlock(&amp;desc-&gt;lock);
		action_ret = handle_IRQ_event(irq, action);
......
	} while ((desc-&gt;status &amp; (IRQ_PENDING | IRQ_DISABLED)) == IRQ_PENDING);
</pre>
&#19982;&#36793;&#27839;&#35302;&#21457;&#30456;&#27604;&#65292;&#30005;&#24179;&#35302;&#21457;&#35201;&#31616;&#21333;&#65292;&#30001;&#20110;&#19968;&#24320;&#22987;&#23601;&#23631;&#34109;&#20013;&#26029;&#65292;&#25152;&#20197;SMP&#26102;&#19981;&#23384;&#22312;&#20013;&#26029;&#20877;&#27425;&#34987;&#22788;&#29702;&#30340;&#21487;&#33021;&#12290;mask_ack_irq&#23436;&#25104;&#20102;&#20013;&#26029;&#23631;&#34109;&#30340;&#36807;&#31243;&#12290;
<pre class="programlisting">
	spin_lock(&amp;desc-&gt;lock);
	mask_ack_irq(desc, irq);
	
	if (unlikely(desc-&gt;status &amp; IRQ_INPROGRESS))
	goto out_unlock;
	
	desc-&gt;status |= IRQ_INPROGRESS;
	spin_unlock(&amp;desc-&gt;lock);
</pre>
&#22312;SMP&#19978;&#65292;&#20854;&#23427;&#30340;CPU&#20381;&#28982;&#21487;&#33021;&#22312;&#24403;&#21069;CPU&#35843;&#29992;mask_ack_irq&#20043;&#21069;&#25509;&#25910;&#21040;&#30456;&#21516;&#30340;&#20013;&#26029;&#20174;&#32780;&#36827;&#20837;&#35813;&#20989;&#25968;&#65292;&#25152;&#20197;&#22312;&#22788;&#29702;&#20043;&#21069;&#39318;&#20808;&#26816;&#26597;IRQ_INPROGRESS&#65292;&#22914;&#26524;&#26377;&#21017;&#30452;&#25509;&#25918;&#24323;&#26412;&#27425;&#20013;&#26029;&#30340;&#22788;&#29702;&#12290;
<pre class="programlisting">
	action_ret = handle_IRQ_event(irq, action);
	if (!noirqdebug)
		note_interrupt(irq, desc, action_ret);

	spin_lock(&amp;desc-&gt;lock);
	desc-&gt;status &amp;= ~IRQ_INPROGRESS;
	if (!(desc-&gt;status &amp; IRQ_DISABLED) &amp;&amp; desc-&gt;chip-&gt;unmask)
		desc-&gt;chip-&gt;unmask(irq);
</pre>
&#22312;&#22788;&#29702;&#23436;&#21518;&#35843;&#29992;unmask&#26469;&#20351;&#33021;&#20013;&#26029;&#12290;&#26412;&#36136;&#19978;&#20869;&#26680;&#23545;&#30005;&#27969;&#22788;&#29702;&#30340;&#23553;&#35013;&#23601;&#26159;&#23545;irq_chip&#20013;&#30340;&#20989;&#25968;&#36827;&#34892;&#35843;&#29992;&#30340;&#36807;&#31243;&#12290;&#21478;&#22806;&#20869;&#26680;&#25552;&#20379;&#20102;&#19968;&#20010;handle_bad_irq&#20989;&#25968;&#20197;&#25552;&#20379;&#40664;&#35748;&#22788;&#29702;&#12290;&#20869;&#26680;&#23553;&#35013;&#20102;set_irq_handler&#20989;&#25968;&#26469;&#20026;&#20013;&#26029;&#21495;&#27880;&#20876;&#30005;&#27969;&#22788;&#29702;&#20989;&#25968;&#12290;
</div>
<div class="sect3" title="16.8.3. &#20013;&#26029;ISR"><div class="titlepage"><div><div><h4 class="title"><a name="idp81336228"></a>16.8.3. &#20013;&#26029;ISR</h4></div></div></div>
&#36825;&#37324;&#30340;ISR&#26159;&#25351;&#20013;&#26029;&#26368;&#39640;&#23618;&#30340;&#21160;&#20316;&#65292;&#36825;&#26159;&#27880;&#20876;&#24182;&#22788;&#29702;&#35813;&#20013;&#26029;&#30340;&#26412;&#36136;&#65292;&#27604;&#22914;&#25509;&#25910;&#25968;&#25454;&#65292;&#25511;&#21046;&#21478;&#22806;&#30340;&#23376;&#31995;&#32479;(&#20363;&#22914;&#26102;&#38388;&#23376;&#31995;&#32479;)&#31561;&#12290;&#20013;&#26029;&#22788;&#29702;&#31243;&#24207;&#34987;&#23553;&#35013;&#22312;&#21517;&#20026;irqaction&#30340;&#25968;&#25454;&#32467;&#26500;&#20013;&#65306;
<pre class="programlisting">
struct irqaction {
	irq_handler_t handler;
	unsigned long flags;
	cpumask_t mask;
	const char *name;
	void *dev_id;
	struct irqaction *next;
	int irq;
	struct proc_dir_entry *dir;
};
</pre>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">&#35813;&#32467;&#26500;&#20307;&#30340;&#26680;&#24515;&#25104;&#21592;&#20026;handler&#65292;&#20063;&#21363;&#20013;&#26029;&#22788;&#29702;&#20989;&#25968;&#12290;</li><li class="listitem">name&#21644;dev_id&#21807;&#19968;&#26631;&#31034;&#19968;&#20010;&#20013;&#26029;&#22788;&#29702;&#31243;&#24207;&#12290;name&#25551;&#36848;&#35774;&#22791;&#21517;&#65292;&#32780;dev_id&#26159;&#19968;&#20010;&#25351;&#21521;&#25152;&#26377;&#20869;&#26680;&#25968;&#25454;&#32467;&#26500;&#20013;&#21807;&#19968;&#26631;&#31034;&#20102;&#35813;&#35774;&#22791;&#30340;&#25968;&#25454;&#32467;&#26500;&#23454;&#20363;&#65292;&#27604;&#22914;&#32593;&#21345;&#30340;net_device&#23454;&#20363;&#65292;&#23427;&#20204;&#22343;&#22312;&#39537;&#21160;&#20013;&#27880;&#20876;&#20013;&#26029;&#26102;&#34987;&#35774;&#32622;&#12290;</li><li class="listitem">flags&#26631;&#24535;&#36890;&#36807;&#20301;&#22270;&#25551;&#36848;IRQ&#30340;&#29305;&#24615;:IRQF_SHARED&#34920;&#31034;&#26377;&#22810;&#20010;&#35774;&#22791;&#20849;&#20139;&#35813;IRQ&#30005;&#36335;&#65307;IRQF_DISABLE&#34920;&#31034;&#35813;IRQ&#30340;&#22788;&#29702;&#31243;&#24207;&#24517;&#39035;&#22312;&#26187;&#20013;&#20013;&#26029;&#30340;&#24773;&#20917;&#19979;&#25191;&#34892;&#65307;IRQF_TIMER&#34920;&#31034;&#26102;&#38047;&#20013;&#26029;&#12290;</li><li class="listitem">next&#23558;&#25152;&#26377;&#30340;&#23545;&#24212;&#21040;&#35813;IRQ&#21495;&#30340;&#22788;&#29702;&#31243;&#24207;&#38142;&#25509;&#25104;&#20026;&#19968;&#20010;&#38142;&#34920;&#12290;&#22312;&#21457;&#29983;&#19968;&#20010;&#20849;&#20139;&#20013;&#26029;&#26102;&#65292;&#20869;&#26680;&#25195;&#25551;&#35813;&#38142;&#34920;&#25214;&#20986;&#20013;&#26029;&#23454;&#38469;&#19978;&#30340;&#26469;&#28304;&#35774;&#22791;&#65306;&#26174;&#28982;&#20849;&#20139;&#20013;&#26029;&#20250;&#24433;&#21709;&#20013;&#26029;&#30340;&#21709;&#24212;&#36895;&#24230;&#12290;</li><li class="listitem">dir&#25351;&#26126;proc&#31995;&#32479;&#23545;&#20013;&#26029;&#23376;&#31995;&#32479;&#30340;&#26597;&#35810;&#36335;&#24452;&#12290;</li></ul></div>
<div class="figure"><a name="idp81339452"></a><p class="title"><b>&#22270; 94. &#20013;&#26029;&#25277;&#35937;&#25968;&#25454;&#32467;&#26500;&#20851;&#31995;</b></p><div class="figure-contents"><div><img src="images/int_chain.gif" alt="&#20013;&#26029;&#25277;&#35937;&#25968;&#25454;&#32467;&#26500;&#20851;&#31995;"></div></div></div><br class="figure-break">
&#22312;handle_IRQ_event&#20013;&#23545;action&#38142;&#34920;&#36827;&#34892;&#24490;&#29615;&#22788;&#29702;&#65292;&#21478;&#22806;&#27880;&#24847;&#20013;&#26029;ISR&#24212;&#35813;&#23613;&#21487;&#33021;&#24555;&#36895;&#30340;&#22788;&#29702;&#65292;&#24182;&#19988;&#19981;&#21487;&#30561;&#30496;&#65292;&#38459;&#22622;&#20197;&#21450;&#36827;&#34892;&#35843;&#24230;&#12290;
<pre class="programlisting">
	do {
		ret = action-&gt;handler(irq, action-&gt;dev_id);
		if (ret == IRQ_HANDLED)
			status |= action-&gt;flags;
		retval |= ret;
		action = action-&gt;next;
	} while (action);
</pre>
</div>
</div>
<div class="sect2" title="16.9. Linux&#20869;&#26680;&#20013;&#26029;&#27880;&#20876;"><div class="titlepage"><div><div><h3 class="title"><a name="idp81340956"></a>16.9. Linux&#20869;&#26680;&#20013;&#26029;&#27880;&#20876;</h3></div></div></div>
&#22312;S3C6410&#30340;&#26495;&#32423;&#21021;&#22987;&#21270;&#25104;&#21592;&#23450;&#20041;&#20013;&#27880;&#24847;&#21040;&#20854;&#20013;&#30340;init_irq&#20989;&#25968;&#12290;&#20869;&#26680;&#23545;&#20013;&#26029;&#25511;&#21046;&#22120;&#30340;&#21021;&#22987;&#21270;&#23601;&#20301;&#20110;&#20854;&#20013;&#12290;&#36825;&#37324;&#23601;&#26159;s3c6410_init_irq&#20989;&#25968;&#12290;
<pre class="programlisting">
MACHINE_START(SMDK6410, "SMDK6410")
......
	.init_irq	= s3c6410_init_irq,
......
MACHINE_END
</pre>
&#35813;&#20989;&#25968;&#34987;&#23450;&#20041;&#22312;&#26680;&#24515;&#25991;&#20214;cpu.c&#20013;&#65292;&#21487;&#20197;&#30475;&#21040;&#23427;&#30340;&#37325;&#35201;&#24615;&#12290;&#21478;&#22806;&#23427;&#21482;&#26159;&#23545;s3c64xx_init_irq&#30340;&#23553;&#35013;&#65292;&#25152;&#20197;s3c64xx_init_irq&#23545;64xx&#31995;&#21015;&#30340;CPU&#20855;&#26377;&#36890;&#29992;&#24615;&#12290;
<pre class="programlisting">
arch/arm/mach-s3c6410/cpu.c
void __init s3c6410_init_irq(void)
{
	/* VIC0 is missing IRQ7, VIC1 is fully populated. */
	s3c64xx_init_irq(~0 &amp; ~(1 &lt;&lt; 7), ~0);
}
</pre>
<div class="figure"><a name="idp81342564"></a><p class="title"><b>&#22270; 95. &#20013;&#26029;&#21021;&#22987;&#21270;&#27969;&#31243;</b></p><div class="figure-contents"><div><img src="images/int_init.gif" alt="&#20013;&#26029;&#21021;&#22987;&#21270;&#27969;&#31243;"></div></div></div><br class="figure-break">
&#25509;&#19979;&#26469;&#23558;&#20381;&#25454;&#35813;&#27969;&#31243;&#20998;&#26512;&#20013;&#26029;&#30340;&#21021;&#22987;&#21270;&#65292;&#26412;&#36136;&#19978;&#21487;&#20197;&#20998;&#20026;&#20004;&#20010;&#38454;&#27573;&#65306;&#21021;&#22987;&#21270;&#20013;&#26029;&#25511;&#21046;&#22120;VIC&#65307;&#27880;&#20876;&#20013;&#26029;&#22788;&#29702;&#31243;&#24207;&#12290;
<div class="sect3" title="16.9.1. &#21021;&#22987;&#21270;&#20013;&#26029;&#25511;&#21046;&#22120;VIC"><div class="titlepage"><div><div><h4 class="title"><a name="idp81343364"></a>16.9.1. &#21021;&#22987;&#21270;&#20013;&#26029;&#25511;&#21046;&#22120;VIC</h4></div></div></div>
&#27880;&#24847;&#21040;s3c64xx_init_irq&#30340;&#20004;&#20010;&#21442;&#25968;&#65292;&#23427;&#20204;&#26159;VIC0&#21644;VIC1&#20013;&#26029;&#20351;&#33021;&#30340;&#25513;&#30721;&#65292;S3C6410&#30340;VIC0&#24182;&#27809;&#26377;&#25552;&#20379;IRQ7&#65292;&#25152;&#20197;s3c6410_init_irq&#22312;&#35843;&#29992;&#35813;&#20989;&#25968;&#26102;&#65292;&#20256;&#36882;&#30340;&#31532;&#19968;&#20010;&#21442;&#25968;&#23631;&#34109;&#25481;&#20102;&#31532;7&#20301;&#12290;
<pre class="programlisting">
void __init s3c64xx_init_irq(u32 vic0_valid, u32 vic1_valid)
{
	int uart, irq;

	/* initialise the pair of VICs */
	vic_init(S3C_VA_VIC0, S3C_VIC0_BASE, vic0_valid);
	vic_init(S3C_VA_VIC1, S3C_VIC1_BASE, vic1_valid);
......
</pre>
&#23545;&#20110;&#35813;&#37096;&#20998;&#20195;&#30721;&#38656;&#35201;&#21442;&#32771;VIC&#30340;&#25511;&#21046;&#23492;&#23384;&#22120;&#21644;&#23545;&#24212;&#30340;&#21151;&#33021;&#12290;ARM Linux&#20351;&#29992;&#21040;&#30340;VIC&#23492;&#23384;&#22120;&#23450;&#20041;&#22914;&#19979;&#65306;
<pre class="programlisting">
arch/arm/include/asm/hardware/vic.h
#define VIC_IRQ_STATUS                  0x00
#define VIC_FIQ_STATUS                  0x04
#define VIC_RAW_STATUS                  0x08
#define VIC_INT_SELECT                  0x0c    /* 1 = FIQ, 0 = IRQ */
#define VIC_INT_ENABLE                  0x10    /* 1 = enable, 0 = disable */
#define VIC_INT_ENABLE_CLEAR            0x14
#define VIC_INT_SOFT                    0x18
#define VIC_INT_SOFT_CLEAR              0x1c
#define VIC_PROTECT                     0x20
#define VIC_PL190_VECT_ADDR             0x30    /* PL190 only */
#define VIC_PL190_DEF_VECT_ADDR         0x34    /* PL190 only */
......
</pre>
&#27880;&#24847;&#20197;&#19978;&#30340;&#23450;&#20041;&#21482;&#26159;&#30456;&#23545;&#20110;VIC&#22522;&#22320;&#22336;&#30340;&#20559;&#31227;&#65292;&#25152;&#20197;&#22312;&#25805;&#20316;&#23427;&#20204;&#30340;&#26102;&#20505;&#36824;&#35201;&#21152;&#19978;&#34394;&#22320;&#22336;S3C_VA_VIC0&#25110;&#32773;S3C_VA_VIC1&#12290;
<pre class="programlisting">
void __init vic_init(void __iomem *base, unsigned int irq_start,
		     u32 vic_sources);
</pre>
vic_init&#26377;&#19977;&#20010;&#21442;&#25968;&#65292;&#35299;&#37322;&#22914;&#19979;&#65306;
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">base&#65292;&#26159;VIC&#30340;&#34394;&#22320;&#22336;&#65292;&#26174;&#28982;&#23427;&#34987;&#26144;&#23556;&#24102;VIC&#30340;&#29289;&#29702;&#22320;&#22336;0x71200000&#25110;&#32773;0x71300000&#12290;</li><li class="listitem">irq_start&#65292;&#25351;&#26126;&#30340;&#36215;&#22987;&#20013;&#26029;&#21495;&#65306;&#23545;&#20110;VIC0&#26469;&#35828;&#23601;&#26159;0&#65292;&#23545;&#20110;VIC1&#26469;&#35828;32&#12290;</li><li class="listitem">vic_sources&#65292;&#26159;&#25513;&#30721;&#20301;&#65292;&#32622;1&#30340;&#20301;&#20854;&#23545;&#24212;&#30340;&#20013;&#26029;&#21495;&#22343;&#25509;&#25910;&#22806;&#37096;&#20013;&#26029;&#35831;&#27714;&#12290;</li></ul></div>
vic_init&#20027;&#35201;&#23436;&#25104;&#20102;&#20197;&#19979;&#24037;&#20316;&#65306;
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">&#35774;&#32622;VIC0INTSELECT&#25110;VIC1INTSELECT&#20026;&#20840;0&#65306;&#36873;&#25321;&#25152;&#26377;&#30340;&#20013;&#26029;&#31867;&#22411;&#20026;IRQ&#12290;</li><li class="listitem">&#35774;&#32622;&#20351;&#33021;&#31105;&#27490;&#23492;&#23384;&#22120;VIC0INTENABLE&#25110;VIC1INTENABLE&#20026;&#20840;0&#65292;&#21516;&#26102;&#20889;&#31105;&#27490;&#23492;&#23384;&#22120;
VIC0INTENCLEAR&#25110;VIC1INTENCLEAR&#20026;&#20840;1&#65292;&#31105;&#27490;&#25152;&#26377;&#30340;&#20013;&#26029;&#12290;</li><li class="listitem">&#28165;&#38500;&#20013;&#26029;&#29366;&#24577;&#23492;&#23384;&#22120;&#20026;&#20840;0&#12290;</li><li class="listitem">&#35774;&#32622;VIC&#27979;&#35797;&#23492;&#23384;&#22120;VICITCR(&#23427;&#30340;&#20559;&#31227;&#20026;0x300)&#20026;0&#65292;&#20063;&#21363;&#35774;&#32622;&#20026;&#27491;&#24120;&#27169;&#24335;&#12290;</li><li class="listitem">&#31105;&#27490;&#25152;&#26377;&#36719;&#20214;&#20013;&#26029;&#12290;</li><li class="listitem">&#35774;&#32622;&#20248;&#20808;&#32423;&#23492;&#23384;&#22120;&#65292;&#36825;&#37324;&#21482;&#35774;&#32622;&#26368;&#20302;&#30340;16&#20010;&#20013;&#26029;&#28304;&#30340;&#20248;&#20808;&#32423;&#20026;0-15&#65292;&#25968;&#20540;&#36234;&#22823;&#20248;&#20808;&#32423;&#36234;&#20302;&#65292;&#24182;&#19988;&#22312;Linux&#23454;&#38469;&#22788;&#29702;&#20013;&#26029;&#29366;&#24577;&#23492;&#23384;&#22120;&#26102;&#20248;&#20808;&#22788;&#29702;VIC0&#30340;&#20013;&#26029;&#12290;</li><li class="listitem">&#35843;&#29992;set_irq_chip&#20026;&#27599;&#19968;&#20010;&#20013;&#26029;&#21495;&#23433;&#35013;VIC&#20013;&#26029;&#25511;&#21046;&#22120;&#30340;&#25277;&#35937;vic_chip&#12290;</li><li class="listitem">&#35843;&#29992;set_irq_chip_data&#20026;&#27599;&#19968;&#20010;&#20013;&#26029;&#21495;&#23433;&#35013;chip_data&#65292;&#36825;&#37324;&#23601;&#26159;VIC&#23492;&#23384;&#22120;&#30340;&#34394;&#25311;&#22522;&#22320;&#22336;&#12290;&#23427;&#24120;&#34987;&#29992;&#22312;vic_chip&#23553;&#35013;&#30340;&#20989;&#25968;&#25351;&#38024;&#20013;&#12290;</li><li class="listitem">&#26681;&#25454;vic_sources&#25552;&#20379;&#30340;&#25513;&#30721;&#65292;&#25152;&#26377;&#20351;&#33021;&#30340;&#20013;&#26029;&#21495;&#37117;&#38656;&#23433;&#35013;&#30005;&#27969;&#22788;&#29702;&#20989;&#25968;handle_irq&#12290;&#36825;&#37324;&#23433;&#35013;&#30340;&#26159;handle_level_irq&#12290;</li><li class="listitem">&#26681;&#25454;vic_sources&#25552;&#20379;&#30340;&#25513;&#30721;&#65292;&#36890;&#36807;set_irq_flags&#35774;&#32622;&#25152;&#26377;&#20351;&#33021;&#30340;&#20013;&#26029;&#21495;&#30340;&#29366;&#24577;status&#20026;IRQF_VALID | IRQF_PROBE&#12290;</li></ul></div>
vic_init&#35843;&#29992;set_irq_chip&#20026;&#27599;&#20010;&#20013;&#26029;&#21495;&#35774;&#32622;chip&#20026;vic_chip&#12290;&#23427;&#21482;&#23454;&#29616;&#20102;&#20004;&#20010;&#20989;&#25968;&#65292;vic_mask_irq&#26082;&#26159;&#23545;&#20013;&#26029;&#31105;&#27490;&#23492;&#23384;&#22120;&#30340;&#25805;&#20316;&#65292;vic_unmask_irq&#21017;&#26159;&#23545;&#20013;&#26029;&#20351;&#33021;&#23492;&#23384;&#22120;&#30340;&#25805;&#20316;&#12290;
<pre class="programlisting">
	for (i = 0; i &lt; 32; i++) {
		unsigned int irq = irq_start + i;

		set_irq_chip(irq, &amp;vic_chip);
		set_irq_chip_data(irq, base);

		if (vic_sources &amp; (1 &lt;&lt; i)) {
			set_irq_handler(irq, handle_level_irq);
			set_irq_flags(irq, IRQF_VALID | IRQF_PROBE);
		}
	}
</pre>
vic_init&#20013;&#30340;&#20851;&#38190;&#20195;&#30721;&#22914;&#19978;&#25152;&#31034;&#65292;&#23427;&#20026;&#27599;&#19968;&#20010;&#20013;&#26029;&#37117;&#21021;&#22987;&#21270;irq_chip&#20026;vic_chip&#65292;&#24182;&#23433;&#35013;&#22788;&#20445;&#30041;&#24847;&#22806;&#30340;&#25152;&#26377;&#20013;&#26029;&#21495;&#30340;&#30005;&#27969;&#22788;&#29702;&#20989;&#25968;&#20026;handle_level_irq&#65292;&#21478;&#22806;IRQF_VALID&#24847;&#21619;&#30528;&#35813;&#20013;&#26029;&#21487;&#20197;&#34987;&#27880;&#20876;action&#22788;&#29702;&#20989;&#25968;&#65292;IRQF_PROBE&#21017;&#34920;&#31034;&#23427;&#38656;&#35201;&#22312;setup_irq&#26102;&#35843;&#29992;&#20351;&#33021;&#20989;&#25968;startup&#12290;
<pre class="programlisting">
set_irq_chip(irq, &amp;vic_chip);

static struct irq_chip vic_chip = {
	.name	= "VIC",
	.ack	= vic_mask_irq,
	.mask	= vic_mask_irq,
	.unmask	= vic_unmask_irq,
};
</pre>
</div>
<div class="sect3" title="16.9.2. &#27880;&#20876;&#30005;&#27969;&#22788;&#29702;&#20989;&#25968;"><div class="titlepage"><div><div><h4 class="title"><a name="idp81352548"></a>16.9.2. &#27880;&#20876;&#30005;&#27969;&#22788;&#29702;&#20989;&#25968;</h4></div></div></div>
s3c64xx_init_irq&#30340;&#26368;&#21518;&#37096;&#20998;&#26356;&#25913;&#26102;&#38047;&#20013;&#26029;&#30340;irq_chip&#20026;s3c_irq_timer&#65292;&#24182;&#19988;&#35774;&#32622;IRQF_VALID&#26631;&#24535;&#20301;&#65292;&#20063;&#21363;IRQ_NOREQUEST&#26631;&#24535;&#12290;
<pre class="programlisting">
......
  set_irq_chained_handler(IRQ_TIMER0_VIC, s3c_irq_demux_timer0);
	set_irq_chained_handler(IRQ_TIMER1_VIC, s3c_irq_demux_timer1);
	set_irq_chained_handler(IRQ_TIMER2_VIC, s3c_irq_demux_timer2);
	set_irq_chained_handler(IRQ_TIMER3_VIC, s3c_irq_demux_timer3);
	set_irq_chained_handler(IRQ_TIMER4_VIC, s3c_irq_demux_timer4);

	for (irq = IRQ_TIMER0; irq &lt;= IRQ_TIMER4; irq++) {
		set_irq_chip(irq, &amp;s3c_irq_timer);
		set_irq_handler(irq, handle_level_irq);
		set_irq_flags(irq, IRQF_VALID);
	}
......
}
</pre>
&#22312;vic_init&#20013;&#27880;&#20876;&#20013;&#26029;&#22788;&#29702;&#20989;&#25968;&#30340;&#20989;&#25968;&#26159;set_irq_chained_handler&#65292;&#25152;&#35859;chained&#65292;&#26159;&#34987;&#38142;&#38145;&#20303;&#30340;&#65292;&#20063;&#21363;&#36825;&#20010;&#20013;&#26029;&#21482;&#22312;&#20869;&#26680;&#20869;&#37096;&#20351;&#29992;&#65292;&#19981;&#21487;&#34987;&#22806;&#37096;&#39537;&#21160;&#36890;&#36807;request_irq&#28155;&#21152;&#26032;&#30340;ISR&#21160;&#20316;&#35831;&#27714;&#12290;&#23545;&#20110;&#26102;&#38047;&#20989;&#25968;&#26174;&#28982;&#38656;&#35201;&#20351;&#29992;&#35813;&#20989;&#25968;&#22788;&#29702;&#12290;
<pre class="programlisting">
static inline void
set_irq_chained_handler(unsigned int irq,
			irq_flow_handler_t handle)
{
	__set_irq_handler(irq, handle, 1, NULL);
}
</pre>
&#19982;&#35813;&#20989;&#25968;&#30456;&#23545;&#24212;&#30340;&#26159;set_irq_handler&#65292;&#23427;&#23545;&#20110;&#22806;&#35774;&#26469;&#35828;&#26356;&#21152;&#36890;&#29992;&#65292;&#20043;&#38388;&#30340;&#21306;&#21035;&#20165;&#20165;&#22312;&#20110;&#31532;&#19977;&#20010;&#21442;&#25968;&#30340;&#21306;&#21035;&#12290;
<pre class="programlisting">
static inline void
set_irq_handler(unsigned int irq, irq_flow_handler_t handle)
{
	__set_irq_handler(irq, handle, 0, NULL);
}
</pre>
__set_irq_handler&#26159;&#30005;&#27969;&#22788;&#29702;&#31243;&#24207;&#30340;&#26680;&#24515;&#27880;&#20876;&#20989;&#25968;&#65292;&#31532;&#19968;&#20010;&#21442;&#25968;&#25351;&#23450;&#20013;&#26029;&#21495;&#65292;handle&#25351;&#23450;&#20102;&#30005;&#27969;&#22788;&#29702;&#20989;&#25968;&#65292;is_chained&#21017;&#25351;&#26126;&#26159;&#21542;&#31105;&#27490;&#22806;&#37096;&#39537;&#21160;&#28155;&#21152;&#26032;ISR&#21160;&#20316;&#21040;&#35813;&#20013;&#26029;&#21495;&#65307;name&#26159;&#23545;&#35813;&#20013;&#26029;&#30005;&#27969;&#22788;&#29702;&#31243;&#24207;&#30340;&#25551;&#36848;&#65292;&#21487;&#20197;&#20026;NULL&#12290;
<pre class="programlisting">
void
__set_irq_handler(unsigned int irq, irq_flow_handler_t handle, int is_chained,
		  const char *name)
{
	......
	if (handle != handle_bad_irq &amp;&amp; is_chained) {
		desc-&gt;status &amp;= ~IRQ_DISABLED;
		desc-&gt;status |= IRQ_NOREQUEST | IRQ_NOPROBE;
		desc-&gt;depth = 0;
		desc-&gt;chip-&gt;startup(irq);
	}
	......
}
</pre>
&#36825;&#20010;&#20989;&#25968;&#30340;&#20851;&#38190;&#28857;&#22312;&#20110;&#23545;is_chained&#30340;&#22788;&#29702;&#65292;&#22914;&#26524;&#35813;&#20013;&#26029;&#21495;&#34987;&#20869;&#26680;&#38145;&#23450;&#65292;&#21017;&#35201;&#28155;&#21152;IRQ_NOREQUEST | IRQ_NOPROBE&#26631;&#24535;&#65292;&#24182;&#19988;&#35843;&#29992;startup&#21551;&#29992;&#20013;&#26029;&#12290;<br>
&#38500;&#20102;&#20197;&#19978;&#20004;&#20010;&#23545;__set_irq_handler&#23553;&#35013;&#30340;&#20989;&#25968;&#22806;&#65292;&#20869;&#26680;&#36824;&#25552;&#20379;&#20102;&#26356;&#39640;&#23618;&#30340;&#20989;&#25968;&#26469;&#21516;&#26102;&#27880;&#20876;irq_chip&#21644;&#30005;&#27969;&#22788;&#29702;&#20989;&#25968;&#65306;
<pre class="programlisting">
kernel/irq/chip.c
set_irq_chip_and_handler(unsigned int irq, struct irq_chip *chip,
			 irq_flow_handler_t handle);
			 
void set_irq_chip_and_handler_name(unsigned int irq, struct irq_chip *chip,
			      irq_flow_handler_t handle, const char *name);
</pre>
&#20294;&#26159;&#23427;&#20204;&#24182;&#19981;&#25903;&#25345;&#20869;&#26680;&#38145;&#23450;&#65292;&#25152;&#20197;&#22312;vic_init&#20013;&#20998;&#24320;&#35843;&#29992;&#20102;set_irq_chained_handler&#21644;set_irq_chip&#12290;&#32780;&#27809;&#26377;&#30452;&#25509;&#35843;&#29992;&#19978;&#38754;&#20004;&#20010;&#20989;&#25968;&#12290;&#21478;&#22806;&#19968;&#20010;&#20196;&#20154;&#36855;&#24785;&#30340;&#22320;&#26041;&#26159;&#36825;&#37324;&#26082;&#27809;&#26377;&#20351;&#29992;&#36793;&#27839;&#35302;&#21457;&#30005;&#27969;&#22788;&#29702;&#20989;&#25968;&#65292;&#20063;&#27809;&#26377;&#20351;&#29992;&#30005;&#24179;&#35302;&#21457;&#22788;&#29702;&#20989;&#25968;&#65292;&#32780;&#26159;&#19968;&#20010;&#33258;&#23450;&#20041;&#30340;&#20989;&#25968;&#65292;&#36825;&#37324;&#23601;&#28041;&#21450;&#21040;&#20102;&#20108;&#32423;&#20013;&#26029;&#12290;&#23427;&#30475;&#36215;&#26469;&#24456;&#20687;&#19968;&#20010;&#26641;&#24418;&#32467;&#26500;&#65306;
<pre class="programlisting">
             |----&#20108;&#32423;&#20013;&#26029;1
&#19968;&#32423;&#20013;&#26029;&#21495;---|----&#20108;&#32423;&#20013;&#26029;2
             |----&#20108;&#32423;&#20013;&#26029;3
             |----&#20108;&#32423;&#20013;&#26029;4
             ......
</pre>
&#26681;&#25454;IRQ_TIMERx_VIC&#23439;&#30340;&#23450;&#20041;&#65292;&#21487;&#20197;&#24471;&#20986;&#23427;&#20204;&#30340;&#20013;&#26029;&#21495;&#20998;&#21035;&#20026;&#65306;55&#65292;56&#65292;57&#65292;59&#21644;60&#12290;&#22312;&#24213;&#23618;&#27719;&#32534;&#36890;&#36807;get_irqnr_and_base&#33719;&#21462;&#20013;&#26029;&#21495;&#26102;&#65292;&#28155;&#21152;&#20102;&#20013;&#26029;&#21495;&#30340;&#20559;&#31227;&#37327;S3C_IRQ_OFFSET&#65292;&#23427;&#30340;&#20540;&#34987;&#23450;&#20041;&#20026;32&#12290;&#20013;&#26029;&#21495;&#30340;&#33539;&#22260;&#22312;32 ~ 96 &#20043;&#38388;&#65292;&#25152;&#20197;&#23454;&#38469;&#19978;&#23427;&#20204;&#23545;&#24212;23&#65292;24&#65292;25&#21644;27&#65292;28&#21495;&#20013;&#26029;&#12290;
<pre class="programlisting">
#define S3C_IRQ_OFFSET	(32)
#define S3C_IRQ(x)	((x) + S3C_IRQ_OFFSET)
#define S3C_VIC0_BASE	S3C_IRQ(0)
#define S3C64XX_IRQ_VIC0(x)	(S3C_VIC0_BASE + (x))

#define IRQ_TIMER0_VIC		S3C64XX_IRQ_VIC0(23)
#define IRQ_TIMER1_VIC		S3C64XX_IRQ_VIC0(24)
#define IRQ_TIMER2_VIC		S3C64XX_IRQ_VIC0(25)
#define IRQ_WDT			S3C64XX_IRQ_VIC0(26)
#define IRQ_TIMER3_VIC		S3C64XX_IRQ_VIC0(27)
#define IRQ_TIMER4_VIC		S3C64XX_IRQ_VIC0(28)
</pre>
s3c_irq_demux_timer0&#34987;&#27880;&#20876;&#20026;&#19968;&#32423;&#20013;&#26029;&#22788;&#29702;&#20989;&#25968;&#65292;&#26174;&#28982;&#23427;&#21482;&#26159;&#23545;s3c_irq_demux_timer&#30340;&#31616;&#21333;&#23553;&#35013;&#65292;&#20540;&#24471;&#27880;&#24847;&#30340;&#26159;&#36825;&#20010;&#20989;&#25968;&#30340;&#20004;&#20010;&#21442;&#25968;&#12290;
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">base_irq&#65292;&#23427;&#24182;&#19981;&#20256;&#36882;&#32473;&#30495;&#27491;&#30340;&#22788;&#29702;&#20989;&#25968;&#12290;</li><li class="listitem">sub_irq&#65292;&#20108;&#32423;&#20013;&#26029;&#21495;&#65292;&#23427;&#34987;&#29992;&#26469;&#20316;&#20026;&#30495;&#27491;&#30340;&#20013;&#26029;&#21495;&#20256;&#36882;&#32473;generic_handle_irq&#12290;</li></ul></div>
generic_handle_irq&#22312;&#36825;&#37324;&#20805;&#24403;&#20102;&#20108;&#32423;&#20013;&#26029;&#22788;&#29702;&#20989;&#25968;&#12290;&#36825;&#37324;&#30340;IRQ_TIMER0&#26174;&#28982;&#19981;&#22312;32~96&#33539;&#22260;&#20869;&#65292;&#25152;&#20197;&#34987;&#36873;&#20316;&#20108;&#32423;&#20013;&#26029;&#21495;&#12290;&#20294;&#26159;&#36825;&#37324;&#30340;&#20108;&#32423;&#20013;&#26029;&#21482;&#26377;&#19968;&#20010;&#12290;&#22312;GPIO&#25511;&#21046;&#20013;&#65292;&#23558;&#26681;&#25454;GPIO&#30340;&#20013;&#26029;&#24748;&#20572;&#23492;&#23384;&#22120;&#26469;&#21306;&#20998;&#30495;&#27491;&#30340;&#20013;&#26029;&#28304;&#65292;&#20174;&#32780;&#36798;&#21040;&#19968;&#20010;&#19968;&#32423;&#20013;&#26029;&#65292;&#22810;&#20010;&#20108;&#32423;&#20013;&#26029;&#30340;&#30446;&#30340;&#12290;
<pre class="programlisting">
#define S3C64XX_TIMER_IRQ(x)	S3C_IRQ(64 + (x))
#define IRQ_TIMER0		S3C64XX_TIMER_IRQ(0)
......

static void s3c_irq_demux_timer0(unsigned int irq, struct irq_desc *desc)
{
	s3c_irq_demux_timer(irq, IRQ_TIMER0);
}

static void s3c_irq_demux_timer(unsigned int base_irq, unsigned int sub_irq)
{
	generic_handle_irq(sub_irq);
}
</pre>
</div>
<div class="sect3" title="16.9.3. &#27880;&#20876;IRQ&#21160;&#20316;"><div class="titlepage"><div><div><h4 class="title"><a name="idp81352676"></a>16.9.3. &#27880;&#20876;IRQ&#21160;&#20316;</h4></div></div></div>
&#20869;&#26680;&#25552;&#20379;&#20102;NR_IRQS&#20010;&#20013;&#26029;&#25551;&#36848;irq_desc&#32467;&#26500;&#25104;&#21592;&#65292;&#32780;&#22312;&#30456;&#24212;&#30340;&#20307;&#31995;&#26550;&#26500;&#20195;&#30721;&#19979;&#23545;&#23427;&#20204;&#36827;&#34892;&#20102;&#21021;&#22987;&#21270;&#65292;&#27604;&#22914;&#23433;&#35013;irq_chip&#65292;&#35774;&#32622;&#26631;&#24535;&#20301;&#65292;&#27880;&#20876;&#20869;&#26680;&#38145;&#23450;(&#20445;&#30041;&#20351;&#29992;)&#30340;&#20013;&#26029;&#21495;&#30340;&#30005;&#27969;&#22788;&#29702;&#20989;&#25968;&#65306;&#27604;&#22914;&#26102;&#38047;&#20013;&#26029;&#12290;&#20294;&#26159;&#26368;&#32456;&#30446;&#30340;&#26159;&#22312;&#20013;&#26029;&#35302;&#21457;&#26102;&#25191;&#34892;&#30456;&#24212;&#30340;&#21160;&#20316;&#12290;&#20869;&#26680;&#25552;&#20379;&#20102;&#19968;&#20010;&#26680;&#24515;&#20989;&#25968;&#29992;&#26469;&#27880;&#20876;&#20013;&#26029;&#21160;&#20316;setup_irq&#12290;
<pre class="programlisting">
kernel/irq/manage.c
int setup_irq(unsigned int irq, struct irqaction *act)
{
	struct irq_desc *desc = irq_to_desc(irq);
	return __setup_irq(irq, desc, act);
}
</pre>
&#31995;&#32479;&#20013;&#30340;&#26680;&#24515;&#35774;&#22791;&#65292;&#27604;&#22914;&#26102;&#38047;&#31995;&#32479;&#65292;&#30001;&#20110;&#19982;&#23427;&#30456;&#20851;&#30340;&#20013;&#26029;&#22312;&#25972;&#20010;&#31995;&#32479;&#36816;&#34892;&#26399;&#20869;&#37117;&#38656;&#35201;&#20351;&#33021;&#65292;&#32780;&#19981;&#38656;&#35201;&#37322;&#25918;&#30456;&#20851;&#30340;&#20013;&#26029;&#36164;&#28304;&#65292;&#21487;&#20197;&#36890;&#36807;&#35813;&#20989;&#25968;&#30452;&#25509;&#27880;&#20876;&#20013;&#26029;&#22788;&#29702;&#20989;&#25968;&#65292;&#36825;&#37324;&#38656;&#35201;&#23450;&#20041;&#19968;&#20010;irqaction&#32467;&#26500;&#20307;&#12290;
<pre class="programlisting">
arch/arm/plat-s3c/time.c
static struct irqaction s3c2410_timer_irq = {
	.name		= "S3C2410 Timer Tick",
	.flags		= IRQF_DISABLED | IRQF_TIMER | IRQF_IRQPOLL,
	.handler	= s3c2410_timer_interrupt,
};

static void __init s3c64xx_timer_init(void)
{
	s3c64xx_timer_setup();
	setup_irq(IRQ_TIMER4, &amp;s3c2410_timer_irq);
}
</pre>
&#32780;&#23545;&#20110;&#22823;&#22810;&#25968;&#22806;&#35774;&#65292;&#21487;&#20197;&#22312;&#20854;&#20572;&#27490;&#24037;&#20316;&#26102;&#37322;&#25918;&#30456;&#20851;&#30340;&#20013;&#26029;&#36164;&#28304;&#65292;&#31995;&#32479;&#25552;&#20379;&#20102;&#26356;&#39640;&#23618;&#30340;&#20013;&#26029;&#27880;&#20876;&#20989;&#25968;&#30340;&#23553;&#35013;request_irq&#12290;
<pre class="programlisting">
typedef irqreturn_t (*irq_handler_t)(int, void *);

kernel/irq/manage.c
int request_irq(unsigned int irq, irq_handler_t handler,
		unsigned long irqflags, const char *devname, void *dev_id);
</pre>
&#27880;&#24847;&#21040;handler&#21442;&#25968;&#26159;&#19968;&#20010;&#20989;&#25968;&#25351;&#38024;&#65292;&#23427;&#30340;&#31532;&#20108;&#20010;&#21442;&#25968;&#36890;&#24120;&#30001;&#36825;&#37324;&#30340;dev_id&#25552;&#20379;&#65292;&#36890;&#24120;&#23427;&#26159;&#25351;&#21521;&#27880;&#20876;&#35813;&#20013;&#26029;&#30340;&#35774;&#22791;&#30340;&#25351;&#38024;&#65292;&#23427;&#34987;&#20256;&#36882;&#32473;handler&#12290;request_irq&#20250;&#21160;&#24577;&#20998;&#37197;&#19968;&#20010;irqaction&#32467;&#26500;&#20307;&#65292;&#24182;&#23558;&#21442;&#25968;&#36171;&#20540;&#32473;&#35813;&#32467;&#26500;&#20307;&#30456;&#24212;&#30340;&#25104;&#21592;&#65306;
<pre class="programlisting">
	action = kmalloc(sizeof(struct irqaction), GFP_ATOMIC);
	......

	action-&gt;handler = handler;
	action-&gt;flags = irqflags;
	cpus_clear(action-&gt;mask);
	action-&gt;name = devname;
	action-&gt;next = NULL;
	action-&gt;dev_id = dev_id;
</pre>
&#19968;&#20010;&#20856;&#22411;&#30340;&#31034;&#20363;&#26159;DM9000&#32593;&#21345;&#30340;&#24320;&#21551;&#20989;&#25968;&#65292;&#20854;&#20013;dm9000_interrupt&#22312;&#20013;&#26029;&#26102;&#29992;&#26469;&#25509;&#25910;&#32593;&#21345;&#25910;&#21040;&#30340;&#25968;&#25454;&#12290;
<pre class="programlisting">
static int dm9000_open(struct net_device *dev)
{
    board_info_t *db = (board_info_t *) dev-&gt;priv;
    
    if (request_irq(dev-&gt;irq, &amp;dm9000_interrupt, DM9000_IRQ_FLAGS, dev-&gt;name, dev))
            return -EAGAIN;
......
</pre>
&#19982;request_irq&#30456;&#23545;&#24212;&#65292;&#31995;&#32479;&#25552;&#20379;&#20102;&#20013;&#26029;&#36164;&#28304;&#30340;&#37322;&#25918;&#20989;&#25968;free_irq&#65292;dev_id&#22312;&#36825;&#37324;&#36215;&#21040;&#20102;ID&#30340;&#20316;&#29992;&#65292;&#26174;&#28982;&#22312;Linux&#20869;&#26680;&#20013;&#22914;&#26524;&#19968;&#20010;&#35774;&#22791;&#35201;&#27880;&#20876;&#22810;&#20010;&#20013;&#26029;&#65292;&#38656;&#35201;&#22312;&#35843;&#29992;request_irq&#26102;&#25552;&#20379;&#19981;&#21516;&#30340;dev_id&#65292;&#21542;&#21017;&#22312;&#37322;&#25918;&#26102;&#23558;&#20986;&#29616;&#40635;&#28902;&#65292;&#27604;&#22914;&#20004;&#27425;&#19981;&#28165;&#26224;&#30340;free_irq&#23558;&#35753;&#20998;&#26512;&#20195;&#30721;&#30340;&#20154;&#20135;&#29983;&#30097;&#38382;&#65306;free_irq&#20351;&#29992;dev_id&#36827;&#34892;&#26597;&#25214;&#65292;&#24182;&#22312;&#31532;&#19968;&#27425;&#21305;&#37197;&#21518;&#37322;&#25918;irqaction&#32467;&#26500;&#24182;&#36864;&#20986;&#12290;
<pre class="programlisting">
void free_irq(unsigned int irq, void *dev_id);
</pre>
</div>
</div>
<div class="sect2" title="16.10. &#36719;&#20013;&#26029;"><div class="titlepage"><div><div><h3 class="title"><a name="idp81366644"></a>16.10. &#36719;&#20013;&#26029;</h3></div></div></div>
<div class="sect3" title="16.10.1. &#36719;&#20013;&#26029;&#27010;&#36848;"><div class="titlepage"><div><div><h4 class="title"><a name="idp81367004"></a>16.10.1. &#36719;&#20013;&#26029;&#27010;&#36848;</h4></div></div></div>
<p>&#20869;&#26680;&#24341;&#20837;&#36719;&#20013;&#26029;&#20197;&#24310;&#26399;&#25191;&#34892;&#20219;&#21153;&#12290;&#30001;&#20110;&#26159;&#23436;&#20840;&#30001;&#36719;&#20214;&#23454;&#29616;&#65292;&#25152;&#20197;&#34987;&#31216;&#20026;&#36719;&#20013;&#26029;&#12290;&#30828;&#20214;&#20013;&#26029;&#30340;ISR&#20013;&#21487;&#33021;&#21253;&#22909;&#22810;&#20010;&#26381;&#21153;&#20363;&#31243;&#65292;&#23427;&#20204;&#20043;&#38388;&#26159;&#20018;&#34892;&#25191;&#34892;&#30340;&#65292;&#24182;&#19988;&#36890;&#24120;&#22312;&#19968;&#20010;&#20013;&#26029;&#30340;&#22788;&#29702;&#31243;&#24207;&#32467;&#26463;&#21069;&#65292;&#19981;&#24212;&#35813;&#20877;&#27425;&#20986;&#29616;&#36825;&#20010;&#20013;&#26029;&#65292;&#30456;&#21453;&#65292;&#21487;&#24310;&#36831;&#20013;&#26029;&#21487;&#20197;&#22312;&#24320;&#20013;&#26029;&#30340;&#24773;&#20917;&#19979;&#25191;&#34892;&#12290;&#25226;&#21487;&#24310;&#36831;&#20013;&#26029;&#20174;&#20013;&#26029;&#22788;&#29702;&#31243;&#24207;&#20013;&#25277;&#20986;&#26469;&#26377;&#21161;&#20110;&#20351;&#20869;&#26680;&#20445;&#25345;&#36739;&#30701;&#30340;&#21709;&#24212;&#26102;&#38388;&#12290;</p>
<p>
Linux2.6&#36890;&#36807;&#20004;&#31181;&#38750;&#32039;&#36843;&#12289;&#21487;&#20013;&#26029;&#30340;&#20869;&#26680;&#20989;&#25968;&#65306;&#25152;&#35859;&#30340;&#21487;&#24310;&#36831;&#20989;&#25968;(&#21253;&#21547;&#36719;&#20013;&#26029;&#21644;tasklets)&#21644;&#36890;&#36807;&#24037;&#20316;&#38431;&#21015;&#26469;&#25191;&#34892;&#30340;&#20989;&#25968;&#12290;tasklet&#26159;&#22312;&#36719;&#20013;&#26029;&#20043;&#19978;&#23454;&#29616;&#30340;&#12290;&#20107;&#23454;&#19978;&#65292;&#20986;&#29616;&#22312;&#20869;&#26680;&#20195;&#30721;&#27719;&#24635;&#30340;&#26415;&#35821;&#8220;&#36719;&#20013;&#26029;(softirq)&#8221;&#24120;&#24120;&#34920;&#31034;&#21487;&#24310;&#36831;&#20989;&#25968;&#30340;&#25152;&#26377;&#31181;&#31867;&#12290;&#21478;&#22806;&#19968;&#31181;&#34987;&#24191;&#27867;&#20351;&#29992;&#30340;&#26415;&#35821;&#26159;"&#20013;&#26029;&#19978;&#19979;&#25991;"&#65306;&#34920;&#31034;&#20869;&#26680;&#24403;&#21069;&#27491;&#22312;&#25191;&#34892;&#19968;&#20010;&#20013;&#26029;&#22788;&#29702;&#31243;&#24207;&#25110;&#19968;&#20010;&#21487;&#24310;&#36831;&#30340;&#20989;&#25968;&#12290;
</p>
<p>
&#36719;&#20013;&#26029;&#30340;&#20998;&#37197;&#26159;&#38745;&#24577;&#30340;(&#32534;&#35793;&#26102;&#23450;&#20041;)&#65292;&#32780;tasklet&#30340;&#20998;&#37197;&#21644;&#21021;&#22987;&#21270;&#21487;&#20197;&#22312;&#36816;&#34892;&#26102;&#36827;&#34892;(&#27604;&#22914;&#23433;&#35013;&#19968;&#20010;&#20869;&#26680;&#27169;&#22359;)&#12290;&#36719;&#20013;&#26029;(&#21363;&#20351;&#26159;&#21516;&#19968;&#31867;&#22411;&#30340;&#36719;&#20013;&#26029;)&#21487;&#20197;&#24182;&#21457;&#22320;&#36816;&#34892;&#22312;&#22810;&#20010;CPU&#19978;&#12290;&#22240;&#27492;&#65292;&#36719;&#20013;&#26029;&#26159;&#21487;&#37325;&#20837;&#20989;&#25968;&#65292;&#32780;&#19988;&#24517;&#39035;&#26126;&#30830;&#22320;&#20351;&#29992;&#33258;&#26059;&#38145;&#20445;&#25252;&#20854;&#25968;&#25454;&#32467;&#26500;&#12290;tasklet&#19981;&#24517;&#25285;&#24515;&#36825;&#20123;&#38382;&#39064;&#65292;&#22240;&#20026;&#20869;&#26680;&#23545;tasklet&#30340;&#25191;&#34892;&#36827;&#34892;&#20102;&#26356;&#21152;&#20005;&#26684;&#30340;&#25511;&#21046;&#12290;&#30456;&#21516;&#31867;&#22411;&#30340;tasklet&#24635;&#26159;&#34987;&#20018;&#34892;&#22320;&#25191;&#34892;&#65292;&#25442;&#21477;&#35805;&#35828;&#65306;&#19981;&#33021;&#22312;&#20004;&#20010;CPU&#19978;&#21516;&#26102;&#36816;&#34892;&#30456;&#21516;&#31867;&#22411;&#30340;tasklet&#12290;&#20294;&#26159;&#65292;&#31867;&#22411;&#19981;&#21516;&#30340;tasklet&#21487;&#20197;&#22312;&#20960;&#20010;CPU&#19978;&#24182;&#21457;&#36827;&#34892;&#12290;tasklet&#30340;&#20018;&#34892;&#21270;&#20351;&#24471;tasklet&#20989;&#25968;&#19981;&#24517;&#26159;&#21487;&#37325;&#20837;&#30340;&#65292;&#22240;&#27492;&#31616;&#21270;&#20102;&#35774;&#22791;&#39537;&#21160;&#31243;&#24207;&#24320;&#21457;&#32773;&#30340;&#24037;&#20316;&#12290;
</p>
<p>
&#19968;&#33324;&#32780;&#35328;&#65292;&#22312;&#21487;&#24310;&#36831;&#20989;&#25968;&#19978;&#21487;&#20197;&#25191;&#34892;&#22235;&#31181;&#25805;&#20316;&#65306;
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">&#21021;&#22987;&#21270;(initialization): &#23450;&#20041;&#19968;&#20010;&#26032;&#30340;&#21487;&#24310;&#36831;&#20989;&#25968;&#65292;&#36825;&#20010;&#25805;&#20316;&#36890;&#24120;&#22312;&#20869;&#26680;&#33258;&#36523;&#21021;&#22987;&#21270;&#25110;&#21152;&#36733;&#27169;&#22359;&#26102;&#36827;&#34892;&#12290;</li><li class="listitem">&#28608;&#27963;(activation)&#65306;&#26631;&#35760;&#19968;&#20010;&#21487;&#24310;&#36831;&#20989;&#25968;&#20026;"&#25346;&#36215;"(&#22312;&#21487;&#24310;&#36831;&#20989;&#25968;&#30340;&#19979;&#19968;&#36718;&#35843;&#24230;&#20013;&#25191;&#34892;)&#12290;&#28608;&#27963;&#21487;&#20197;&#22312;&#20219;&#20309;&#26102;&#20505;&#36827;&#34892;(&#21363;&#20351;&#27491;&#22312;&#22788;&#29702;&#20013;&#26029;)&#12290;</li><li class="listitem">&#23631;&#34109;(masking)&#65306;&#26377;&#36873;&#25321;&#22320;&#23631;&#34109;&#19968;&#20010;&#21487;&#24310;&#36831;&#20989;&#25968;&#65292;&#36825;&#26679;&#21363;&#20351;&#23427;&#34987;&#28608;&#27963;&#65292;&#20869;&#26680;&#20063;&#19981;&#25191;&#34892;&#23427;&#12290;</li><li class="listitem">&#25191;&#34892;(execution)&#65306;&#25191;&#34892;&#19968;&#20010;&#25346;&#36215;&#30340;&#21487;&#24310;&#36831;&#20989;&#25968;&#21644;&#21516;&#31867;&#22411;&#30340;&#20854;&#20182;&#25152;&#26377;&#25346;&#36215;&#30340;&#21487;&#24310;&#36831;&#20989;&#25968;&#65307;&#25191;&#34892;&#26159;&#22312;&#29305;&#23450;&#30340;&#26102;&#38388;&#36827;&#34892;&#30340;&#12290;</li></ul></div><p>
&#28608;&#27963;&#21644;&#25191;&#34892;&#19981;&#30693;&#20309;&#25925;&#24635;&#26159;&#25414;&#32465;&#22312;&#19968;&#36215;&#65306;&#30001;&#32473;&#23450;CPU&#28608;&#27963;&#30340;&#19968;&#20010;&#21487;&#24310;&#36831;&#20989;&#25968;&#24517;&#39035;&#22312;&#21516;&#19968;&#20010;CPU&#19978;&#25191;&#34892;&#12290;&#27809;&#26377;&#20160;&#20040;&#26126;&#26174;&#30340;&#29702;&#30001;&#35828;&#26126;&#36825;&#26465;&#35268;&#21017;&#23545;&#31995;&#32479;&#24615;&#33021;&#26159;&#26377;&#30410;&#30340;&#12290;&#21487;&#25226;&#24310;&#36831;&#20989;&#25968;&#32465;&#23450;&#22312;&#28608;&#27963;CPU&#19978;&#20174;&#29702;&#35770;&#19978;&#35828;&#21487;&#20197;&#26356;&#22909;&#22320;&#21033;&#29992;CPU&#30340;&#30828;&#20214;&#39640;&#36895;&#32531;&#23384;&#12290;&#27605;&#31455;&#65292;&#21487;&#20197;&#24819;&#35937;&#65292;&#28608;&#27963;&#30340;&#20869;&#26680;&#32447;&#31243;&#35775;&#38382;&#30340;&#19968;&#20123;&#25968;&#25454;&#32467;&#26500;&#65292;&#21487;&#24310;&#36831;&#20989;&#25968;&#20063;&#21487;&#33021;&#20250;&#20351;&#29992;&#12290;&#28982;&#32780;&#65292;&#24403;&#21487;&#24310;&#36831;&#20989;&#25968;&#36816;&#34892;&#26102;&#65292;&#22240;&#20026;&#20182;&#30340;&#25191;&#34892;&#21487;&#20197;&#24310;&#36831;&#19968;&#27573;&#26102;&#38388;&#65292;&#22240;&#27492;&#30456;&#20851;&#21578;&#35785;&#32531;&#23384;&#34892;&#24456;&#21487;&#33021;&#23601;&#19981;&#20877;&#39640;&#36895;&#32531;&#23384;&#20013;&#20102;&#12290;&#27492;&#22806;&#65292;&#25226;&#19968;&#20010;&#20989;&#25968;&#32465;&#23450;&#22312;&#19968;&#20010;CPU&#19978;&#24635;&#26159;&#19968;&#31181;&#26377;&#28508;&#22312;"&#21361;&#38505;&#30340;"&#25805;&#20316;&#65292;&#19968;&#20010;CPU&#21487;&#33021;&#24537;&#27515;&#32780;&#20854;&#20182;CPU&#21448;&#21487;&#33021;&#26080;&#25152;&#20107;&#20107;&#12290;
</p>
</div>
<div class="sect3" title="16.10.2. &#36719;&#20013;&#26029;&#25968;&#25454;&#32467;&#26500;"><div class="titlepage"><div><div><h4 class="title"><a name="idp81372460"></a>16.10.2. &#36719;&#20013;&#26029;&#25968;&#25454;&#32467;&#26500;</h4></div></div></div>
<p>
&#36719;&#20013;&#26029;&#26426;&#21046;&#30340;&#26680;&#24515;&#37096;&#20998;&#26159;&#19968;&#20010;&#34920;&#65292;&#21253;&#21547;NR_SOFTIRQS&#20010;softirq_action&#31867;&#22411;&#30340;&#25968;&#25454;&#39033;&#12290;&#35813;&#25968;&#25454;&#32467;&#26500;&#38750;&#24120;&#31616;&#21333;&#65306;
</p><pre class="programlisting">
include/linux/interrupt.h
struct softirq_action
{
   void (*action)(struct softirq_action *);
};
</pre><p>
action&#26159;&#19968;&#20010;&#25351;&#21521;&#22788;&#29702;&#24403;&#21069;&#31867;&#22411;&#30340;&#20989;&#25968;&#30340;&#25351;&#38024;&#65292;&#24403;&#36719;&#20013;&#26029;&#21457;&#29983;&#26102;&#30001;&#20869;&#26680;&#25191;&#34892;&#35813;&#22788;&#29702;&#31243;&#24207;&#20363;&#31243;&#12290;&#24403;&#21069;&#25903;&#25345;&#30340;&#25152;&#26377;&#36719;&#20013;&#26029;&#31867;&#22411;&#22914;&#19979;&#25152;&#31034;&#65292;NR_SOFTIRQS&#35760;&#24405;&#26368;&#22823;&#25968;&#30446;&#12290;&#36890;&#36807;&#23427;&#22768;&#26126;NR_SOFTIRQS&#20010;softirq_action&#12290;
</p><pre class="programlisting">
include/linux/interrupt.h
enum
{
        HI_SOFTIRQ=0,
        TIMER_SOFTIRQ,
        NET_TX_SOFTIRQ,
        NET_RX_SOFTIRQ,
        BLOCK_SOFTIRQ,
        TASKLET_SOFTIRQ,
        SCHED_SOFTIRQ,
#ifdef CONFIG_HIGH_RES_TIMERS
        HRTIMER_SOFTIRQ,
#endif
        RCU_SOFTIRQ,    /* Preferable RCU should always be the last softirq */

        NR_SOFTIRQS
};
</pre><p>
&#36719;&#20013;&#26029;&#31867;&#22411;&#20013;&#65292;
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">HI_SOFTIRQ&#23545;&#24212;&#39640;&#20248;&#20808;&#32423;tasket&#65292;TASKLET_SOFTIRQ&#29992;&#26469;&#23454;&#29616;&#24120;&#35268;tasklet&#12290;</li><li class="listitem">NET_TX_SOFTIRQ&#21644;NET_RX_SOFTIRQ&#29992;&#20110;&#32593;&#32476;&#30340;&#21457;&#36865;&#21644;&#25509;&#25910;&#25805;&#20316;&#12290;</li><li class="listitem">BLOCK_SOFTIRQ&#29992;&#20110;&#22359;&#35774;&#22791;&#12290;</li><li class="listitem">SCHED_SOFTIRQ&#21017;&#29992;&#20110;&#35843;&#24230;&#22120;&#65292;&#23454;&#29616;SMP&#31995;&#32479;&#19978;&#21608;&#26399;&#24615;&#30340;&#36127;&#36733;&#24179;&#34913;&#12290;</li><li class="listitem">RCU_SOFTIRQ&#29992;&#20110;Read-Copy-Update&#38145;&#26426;&#21046;&#12290;</li><li class="listitem">TIMER_SOFTIRQ&#21017;&#29992;&#20110;&#36719;&#20214;&#26102;&#38047;&#12290;</li><li class="listitem">HRTIMER_SOFTIRQ&#22312;&#21551;&#29992;&#39640;&#20998;&#36776;&#29575;&#23450;&#26102;&#22120;&#26102;&#34987;&#24320;&#21551;&#12290;</li></ul></div><p>
&#36719;&#20013;&#26029;&#30340;&#32534;&#21495;&#24418;&#25104;&#20102;&#19968;&#20010;&#20248;&#20808;&#39034;&#24207;&#65292;&#36825;&#24182;&#19981;&#24433;&#21709;&#21508;&#20010;&#22788;&#29702;&#31243;&#24207;&#25191;&#34892;&#30340;&#39057;&#29575;&#21644;&#23427;&#20204;&#30456;&#23545;&#20110;&#20854;&#20182;&#31995;&#32479;&#27963;&#21160;&#30340;&#20248;&#20808;&#32423;&#65292;&#20294;&#23450;&#20041;&#20102;&#22810;&#20010;&#36719;&#20013;&#26029;&#21516;&#26102;&#27963;&#21160;&#25110;&#24453;&#20915;&#26102;&#22788;&#29702;&#20363;&#31243;&#25191;&#34892;&#30340;&#27425;&#24207;&#12290;
</p><pre class="programlisting">
kernel/softirq.c
static struct softirq_action softirq_vec[NR_SOFTIRQS] __cacheline_aligned_in_smp;
</pre><p>
&#36719;&#20013;&#26029;&#24517;&#39035;&#27880;&#20876;&#65292;&#28982;&#21518;&#20869;&#26680;&#25165;&#33021;&#25191;&#34892;&#36719;&#20013;&#26029;&#12290;open_softirq&#20989;&#25968;&#29992;&#20110;&#35813;&#30446;&#30340;&#12290;&#23427;&#22312;softirq_vec&#34920;&#20013;&#25351;&#23450;&#30340;&#20301;&#32622;&#20889;&#20837;&#26032;&#30340;&#36719;&#20013;&#26029;&#22788;&#29702;&#20989;&#25968;&#12290;
</p><pre class="programlisting">
kernel/softirq.c
void open_softirq(int nr, void (*action)(struct softirq_action *))
{
  softirq_vec[nr].action = action;
}
</pre><p>
&#21478;&#19968;&#20010;&#20851;&#38190;&#30340;&#23383;&#27573;&#26159;&#24403;&#21069;&#36827;&#31243;&#30340;preempt_count&#23383;&#27573;&#65292;&#22312;&#20869;&#26680;&#21516;&#27493;&#20013;&#26377;&#35814;&#32454;&#25551;&#36848;&#65292;&#23427;&#30340;b[15:8]&#20301;&#29992;&#26469;&#34920;&#31034;&#36719;&#20013;&#26029;&#35745;&#25968;&#22120;&#12290;&#23427;&#34920;&#31034;&#21487;&#24310;&#36831;&#20989;&#25968;&#34987;&#31105;&#29992;&#30340;&#31243;&#24230;(&#20026;0&#34920;&#31034;&#21487;&#24310;&#36831;&#20989;&#25968;&#22788;&#20110;&#28608;&#27963;&#29366;&#24577;)&#12290;
</p>
<p>
&#23454;&#29616;&#36719;&#20013;&#26029;&#30340;&#26368;&#21518;&#19968;&#20010;&#20851;&#38190;&#30340;&#25968;&#25454;&#32467;&#26500;&#26159;&#27599;&#20010;CPU&#37117;&#26377;&#30340;32&#20301;&#25513;&#30721;(&#25551;&#36848;&#25346;&#36215;&#30340;&#36719;&#20013;&#26029;)&#65292;&#23427;&#23384;&#25918;&#22312;irq_cpustat_t&#32467;&#26500;&#20307;&#30340;__softirq_pending&#25104;&#21592;&#20013;&#12290;&#35813;&#32467;&#26500;&#20307;&#26159;&#19982;&#20307;&#31995;&#26550;&#26500;&#30456;&#20851;&#30340;&#65292;&#20294;__softirq_pending&#30340;&#22823;&#23567;&#24212;&#35813;&#19982;NR_CPUS&#20445;&#25345;&#19968;&#33268;&#65292;&#25165;&#33021;&#23558;&#25513;&#30721;&#20301;&#21644;&#27599;&#20010;&#36719;&#20013;&#26029;&#21521;&#37327;&#19968;&#19968;&#23545;&#24212;&#12290;
</p><pre class="programlisting">
arch/arm/include/asm/hardirq.h
typedef struct {
	unsigned int __softirq_pending;
	unsigned int local_timer_irqs;
} ____cacheline_aligned irq_cpustat_t;

irq_cpustat_t irq_stat[NR_CPUS] ____cacheline_aligned;
EXPORT_SYMBOL(irq_stat);
</pre><p>
&#20026;&#20102;&#33719;&#21462;&#21644;&#35774;&#32622;&#20026;&#25513;&#30721;&#30340;&#20540;&#65292;&#20869;&#26680;&#20351;&#29992;&#23439;local_softirq_pending&#65292;&#23427;&#36873;&#25321;&#26412;&#22320;CPU&#30340;&#36719;&#20013;&#26029;&#20301;&#25513;&#30721;&#12290;
</p><pre class="programlisting">
#define __IRQ_STAT(cpu, member)	(irq_stat[cpu].member)

/* arch independent irq_stat fields */
#define local_softirq_pending() \
	__IRQ_STAT(smp_processor_id(), __softirq_pending)
</pre><p>
</p>
</div>
<div class="sect3" title="16.10.3. &#36719;&#20013;&#26029;&#22788;&#29702;"><div class="titlepage"><div><div><h4 class="title"><a name="idp81380092"></a>16.10.3. &#36719;&#20013;&#26029;&#22788;&#29702;</h4></div></div></div>
<p>
</p><pre class="programlisting">
void open_softirq(int nr, void (*action)(struct softirq_action *))
{
	softirq_vec[nr].action = action;
}
</pre><p>
open_softirq&#29992;&#26469;&#20026;&#19981;&#21516;&#31867;&#22411;&#30340;&#36719;&#20013;&#26029;&#21021;&#22987;&#21270;&#22788;&#29702;&#20989;&#25968;&#12290;&#23427;&#30340;&#31532;&#19968;&#20010;&#21442;&#25968;&#20026;&#36719;&#20013;&#26029;&#31867;&#22411;&#65292;&#31532;&#20108;&#20010;&#21017;&#20026;&#22788;&#29702;&#20989;&#25968;&#12290;&#23427;&#23553;&#35013;&#20102;&#23545;softirq_vec&#25968;&#32452;&#30340;&#21021;&#22987;&#21270;&#12290;
</p>
<p>
raise_softirq&#29992;&#20110;&#28608;&#27963;&#36719;&#20013;&#26029;&#12290;&#23427;&#30340;&#21442;&#25968;&#21363;&#26159;&#38656;&#35201;&#28608;&#27963;&#36719;&#20013;&#26029;&#30340;&#31867;&#22411;&#12290;
</p><pre class="programlisting">
void raise_softirq(unsigned int nr)
{
	unsigned long flags;

	local_irq_save(flags);
	raise_softirq_irqoff(nr);
	local_irq_restore(flags);
}
</pre><p>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">local_irq_save&#31105;&#29992;&#26412;&#22320;&#20013;&#26029;&#12290;</li><li class="listitem">__raise_softirq_irqoff&#25226;&#36719;&#20013;&#26029;&#26631;&#35760;&#20026;&#25346;&#36215;&#29366;&#24577;&#65292;&#36825;&#26159;&#36890;&#36807;&#35774;&#32622;&#26412;&#22320;CPU&#30340;&#36719;&#20013;&#26029;&#25513;&#30721;&#20013;&#19982;&#19979;&#26631;nr&#30456;&#20851;&#30340;&#20301;&#26469;&#23454;&#29616;&#30340;&#12290;</li><li class="listitem">&#22914;&#26524;in_interrupt&#36820;&#22238;1&#65292;&#21017;&#24674;&#22797;&#20013;&#26029;&#24182;&#36820;&#22238;&#12290;</li><li class="listitem">&#21542;&#21017;&#65292;&#23601;&#21435;&#35843;&#29992;wakeup_softirqd&#20197;&#21796;&#37266;&#26412;&#22320;CPU&#30340;ksoftirqd&#20869;&#26680;&#32447;&#31243;&#12290;</li><li class="listitem">&#24674;&#22797;&#20013;&#26029;&#26631;&#24535;&#20301;&#24182;&#36820;&#22238;&#65306;&#20294;&#36825;&#24182;&#19981;&#24847;&#21619;&#30528;&#24320;&#21551;&#20013;&#26029;&#12290;</li></ul></div><p>
raise_softirq_irqoff&#20989;&#25968;&#24517;&#39035;&#22312;&#20851;&#20013;&#26029;&#20013;&#25191;&#34892;&#65292;&#25152;&#20197;&#24517;&#39035;&#25191;&#34892;&#30340;&#23613;&#37327;&#24555;&#12290;
</p><pre class="programlisting">
#define or_softirq_pending(x)  (local_softirq_pending() |= (x))
#define __raise_softirq_irqoff(nr) do { or_softirq_pending(1UL &lt;&lt; (nr)); } while (0)

inline void raise_softirq_irqoff(unsigned int nr)
{
	__raise_softirq_irqoff(nr);

	if (!in_interrupt())
		wakeup_softirqd();
}
</pre><p>
&#22914;&#19978;&#25152;&#36848;&#65292;&#22914;&#26524;&#24403;&#21069;&#26159;&#22312;&#20013;&#26029;&#20013;(&#24182;&#19988;&#22823;&#22810;&#25968;&#24773;&#20917;&#37117;&#26159;&#65292;&#27604;&#22914;&#21796;&#37266;&#26102;&#38047;&#36719;&#20013;&#26029;)&#65292;&#37027;&#20040;&#38500;&#20102;&#35774;&#32622;CPU&#30340;&#36719;&#20013;&#26029;&#25513;&#30721;&#20197;&#22806;&#65292;&#20284;&#20046;&#19981;&#33021;&#20570;&#20219;&#20309;&#20107;&#24773;&#65292;&#37027;&#20040;&#36825;&#20123;&#25513;&#30721;&#26159;&#22312;&#20309;&#26102;&#34987;&#26816;&#26597;&#30340;&#21602;&#65311;&#26816;&#27979;&#28857;&#36890;&#24120;&#22914;&#19979;&#65306;
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">&#24403;&#20869;&#26680;&#35843;&#29992;local_bh_enable&#20989;&#25968;&#28608;&#27963;&#26412;&#22320;CPU&#30340;&#36719;&#20013;&#26029;&#26102;&#12290;</li><li class="listitem">&#24403;do_IRQ&#23436;&#25104;&#20102;&#20013;&#26029;ISR&#30340;&#21021;&#22987;&#26102;&#25110;&#32773;&#35843;&#29992;irq_exit&#23439;&#26102;&#12290;</li><li class="listitem">&#22914;&#26524;&#31995;&#32479;&#20351;&#29992;APIC&#65292;&#21017;&#22312;&#20013;&#26029;&#22788;&#29702;&#20989;&#25968;&#23436;&#25104;&#26412;&#22320;&#23450;&#26102;&#22120;&#20013;&#26029;&#26102;&#12290;</li><li class="listitem">&#22312;SMP&#31995;&#32479;&#20013;&#65292;&#24403;CPU&#22788;&#29702;&#23436;&#34987;CALL_FUNCTION_VECTOR&#22788;&#29702;&#22120;&#38388;&#20013;&#26029;&#25152;&#35302;&#21457;&#30340;&#20989;&#25968;&#26102;&#12290;</li><li class="listitem">&#24403;&#19968;&#20010;&#29305;&#27530;&#30340;ksoftirqd/n&#20869;&#26680;&#32447;&#31243;&#34987;&#21796;&#37266;&#26102;&#12290;</li></ul></div><p>
</p>
</div>
<div class="sect3" title="16.10.4. do_softirq"><div class="titlepage"><div><div><h4 class="title"><a name="idp81386556"></a>16.10.4. do_softirq</h4></div></div></div>
<pre class="programlisting">
asmlinkage void do_softirq(void)
{
  __u32 pending;
  unsigned long flags;

  if (in_interrupt())
          return;

  local_irq_save(flags);
  pending = local_softirq_pending();
  if (pending)
         __do_softirq();
  local_irq_restore(flags);
}
</pre>
&#22914;&#26524;&#22312;&#19968;&#20123;&#29305;&#27530;&#30340;&#30417;&#27979;&#28857;(local_softirq_pending()&#19981;&#20026;0)&#26816;&#27979;&#21040;&#25346;&#36215;&#30340;&#36719;&#20013;&#26029;&#25513;&#30721;&#34987;&#32622;&#20301;&#65292;&#20869;&#26680;&#23601;&#35843;&#29992;do_softirq&#26469;&#22788;&#29702;&#20182;&#20204;&#12290;&#36825;&#20010;&#20989;&#25968;&#25191;&#34892;&#20102;&#22914;&#19979;&#30340;&#25805;&#20316;&#65306;
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">in_interrupt&#21028;&#26029;&#24403;&#21069;&#36827;&#31243;&#30340;preempt_count&#23383;&#27573;&#30340;&#30828;&#20013;&#26029;&#21644;&#36719;&#20013;&#26029;&#35745;&#31639;&#22120;&#26159;&#21542;&#20026;&#26377;&#20540;&#65292;&#22914;&#26524;&#26159;&#21017;&#30452;&#25509;&#36820;&#22238;&#12290;&#36825;&#31181;&#24773;&#20917;&#35828;&#26126;&#35201;&#20040;&#22312;&#20013;&#26029;&#19978;&#19979;&#25991;&#20013;&#35843;&#29992;&#20102;do_softirq&#65292;&#35201;&#20040;&#24403;&#21069;&#31105;&#29992;&#36719;&#20013;&#26029;&#12290;</li><li class="listitem">&#31105;&#20013;&#26029;&#24182;&#20445;&#23384;&#24403;&#21069;&#30340;IF&#26631;&#24535;&#20301;&#12290;</li><li class="listitem">&#36890;&#36807;local_softirq_pending&#26597;&#30475;&#26159;&#21542;&#26377;&#25346;&#36215;&#30340;&#36719;&#20013;&#26029;&#65292;&#22914;&#26524;&#26377;&#35843;&#29992;__do_softirq&#12290;</li><li class="listitem">&#24674;&#22797;IF&#26631;&#24535;&#24182;&#36820;&#22238;&#12290;</li></ul></div>
__do_softirq&#20989;&#25968;&#35835;&#21462;&#26412;&#22320;CPU&#30340;&#36719;&#20013;&#26029;&#25513;&#30721;&#24182;&#25191;&#34892;&#19982;&#27599;&#20010;&#20301;&#32622;&#20301;&#30456;&#20851;&#30340;&#21487;&#24310;&#36831;&#20989;&#25968;&#12290;&#30001;&#20110;&#27491;&#22312;&#25191;&#34892;&#19968;&#20010;&#36719;&#20013;&#26029;&#20989;&#25968;&#26102;&#21487;&#33021;&#20986;&#29616;&#26032;&#25346;&#36215;&#30340;&#36719;&#20013;&#26029;&#65292;&#25152;&#20197;&#20026;&#20102;&#20445;&#35777;&#21487;&#24310;&#36831;&#20989;&#25968;&#30340;&#20302;&#24310;&#36831;&#24615;&#65292;__do_softirq&#19968;&#33268;&#36816;&#34892;&#21040;&#25191;&#34892;&#23436;&#25152;&#26377;&#25346;&#36215;&#30340;&#36719;&#20013;&#26029;&#12290;&#20294;&#26159;&#65292;&#36825;&#31181;&#26426;&#21046;&#21487;&#33021;&#36843;&#20351;__do_softirq&#36816;&#34892;&#24456;&#38271;&#19968;&#27573;&#26102;&#38388;&#65292;&#22240;&#32780;&#22823;&#22823;&#24310;&#36831;&#29992;&#25143;&#24577;&#36827;&#31243;&#30340;&#25191;&#34892;&#12290;&#22240;&#27492;&#65292;&#35813;&#20989;&#25968;&#21046;&#20316;&#22266;&#23450;&#27425;&#25968;MAX_SOFTIRQ_RESTART&#30340;&#24490;&#29615;&#65292;&#28982;&#21518;&#23601;&#36820;&#22238;&#12290;&#22914;&#26524;&#36824;&#26377;&#20854;&#20313;&#25346;&#36215;&#30340;&#36719;&#20013;&#26029;&#65292;&#37027;&#20040;&#19979;&#38754;&#25551;&#36848;&#30340;ksoftirqd&#23558;&#20250;&#22312;&#39044;&#26399;&#30340;&#26102;&#38388;&#20869;&#22788;&#29702;&#23427;&#20204;&#12290;
<pre class="programlisting">
#define MAX_SOFTIRQ_RESTART 10

asmlinkage void __do_softirq(void)
{
        struct softirq_action *h;
        __u32 pending;
        int max_restart = MAX_SOFTIRQ_RESTART;
        int cpu;

        pending = local_softirq_pending();
        account_system_vtime(current);

        __local_bh_disable((unsigned long)__builtin_return_address(0));
        trace_softirq_enter();

        cpu = smp_processor_id();
</pre>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">&#39318;&#20808;&#21021;&#22987;&#21270;&#24490;&#29615;&#35745;&#25968;&#22120;max_restart&#20026;10&#12290;</li><li class="listitem">&#25226;&#26412;&#22320;CPU&#36719;&#20013;&#26029;&#30340;&#20301;&#25513;&#30721;&#22797;&#21046;&#21040;&#23616;&#37096;&#21464;&#37327;pending&#20013;&#12290;</li><li class="listitem">&#35843;&#29992;__local_bh_disable&#22686;&#21152;&#36719;&#20013;&#26029;&#30340;&#35745;&#25968;&#20540;&#12290;&#36825;&#20445;&#35777;&#19981;&#20250;&#23884;&#22871;&#25191;&#34892;__do_softirq&#12290;&#22240;&#20026;&#22312;&#36827;&#20837;&#35813;&#20989;&#25968;&#21069;&#20250;&#21028;&#26029;&#26159;&#21542;&#22312;&#20013;&#26029;&#20013;&#12290;&#23613;&#31649;&#36890;&#36807;do_softirq&#35843;&#29992;&#30340;__do_softirq&#26159;&#22312;&#31105;&#20013;&#26029;&#20013;&#25191;&#34892;&#30340;&#65292;&#20294;&#26159;&#22312;&#21028;&#26029;&#20013;&#26029;&#20043;&#21518;&#21644;&#25509;&#19979;&#26469;&#25191;&#34892;local_irq_save&#25351;&#20196;&#20043;&#38388;&#20381;&#28982;&#21487;&#33021;&#20013;&#26029;&#65292;&#24182;&#19988;&#22312;&#35843;&#29992;do_IRQ&#22788;&#29702;&#23436;&#20013;&#26029;&#20043;&#21518;&#20934;&#22791;&#32467;&#26463;&#26102;&#36890;&#36807;irq_exit&#20063;&#23558;&#21796;&#37266;invoke_softirq&#65292;&#23427;&#26159;&#23545;__do_softirq&#30340;&#23439;&#23450;&#20041;&#12290;&#20026;&#20102;&#20445;&#35777;&#21487;&#24310;&#36831;&#20989;&#25968;&#30340;&#20018;&#34892;&#25191;&#34892;&#65292;&#24517;&#39035;&#22312;&#20989;&#25968;&#30340;&#24320;&#22987;&#31105;&#29992;&#21487;&#24310;&#36831;&#20989;&#25968;&#12290;&#21478;&#22806;&#21487;&#24310;&#36831;&#20989;&#25968;&#20063;&#26159;&#22312;&#24320;&#20013;&#26029;&#26102;&#25191;&#34892;&#30340;&#65292;&#27492;&#26102;&#20063;&#20250;&#21457;&#29983;&#30828;&#20013;&#26029;&#24182;&#27880;&#20876;&#26032;&#30340;&#36719;&#20013;&#26029;&#12290;</li></ul></div>
<pre class="programlisting">
static inline void __local_bh_disable(unsigned long ip)
{
  add_preempt_count(SOFTIRQ_OFFSET);
  barrier();
}
</pre>
&#27880;&#24847;&#21040;irq_exit&#20013;&#23545;invoke_softirq&#30340;&#35843;&#29992;&#12290;&#26174;&#28982;&#21482;&#26377;&#23450;&#20041;__ARCH_IRQ_EXIT_IRQS_DISABLED&#26102;&#25165;&#20250;&#35843;&#29992;__do_softirq&#12290;&#23545;&#20110;ARM&#21363;&#20026;&#35813;&#20989;&#25968;&#12290;
<pre class="programlisting">
#ifdef __ARCH_IRQ_EXIT_IRQS_DISABLED
# define invoke_softirq()       __do_softirq()
#else
# define invoke_softirq()       do_softirq()
#endif

void irq_exit(void)
{
        account_system_vtime(current);
        trace_hardirq_exit();
        sub_preempt_count(IRQ_EXIT_OFFSET);
        if (!in_interrupt() &amp;&amp; local_softirq_pending())
                invoke_softirq();

#ifdef CONFIG_NO_HZ 
        /* Make sure that timer wheel updates are propagated */
        if (!in_interrupt() &amp;&amp; idle_cpu(smp_processor_id()) &amp;&amp; !need_resched())
                tick_nohz_stop_sched_tick(0);
        rcu_irq_exit();
#endif
        preempt_enable_no_resched();
}
</pre>
&#25509;&#19979;&#26469;&#32487;&#32493;&#20998;&#26512;__do_softirq&#20013;&#23545;&#24310;&#36831;&#20989;&#25968;&#30340;&#24490;&#29615;&#22788;&#29702;&#65306;
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">set_softirq_pending&#28165;&#26970;&#26412;&#22320;CPU&#30340;&#36719;&#20013;&#26029;&#25513;&#30721;&#65292;&#19968;&#36793;&#28608;&#27963;&#26032;&#30340;&#36719;&#20013;&#26029;&#12290;</li><li class="listitem">&#25191;&#34892;local_irq_enable&#28608;&#27963;&#26412;&#22320;&#20013;&#26029;&#12290;</li><li class="listitem">&#26681;&#25454;pending&#20013;&#30340;&#25513;&#30721;&#20301;&#25191;&#34892;&#23545;&#24212;&#30340;&#36719;&#20013;&#26029;&#22788;&#29702;&#20989;&#25968;</li><li class="listitem">&#22914;&#26524;&#22312;&#36719;&#20013;&#26029;&#22788;&#29702;&#20989;&#25968;&#20013;&#25913;&#21464;&#20102;preempt_count&#20540;&#23558;&#25253;&#38169;&#12290;</li></ul></div>
<pre class="programlisting">
restart:
	/* Reset the pending bitmask before enabling irqs */
	set_softirq_pending(0);
	local_irq_enable();

	h = softirq_vec;
	do {
		if (pending &amp; 1) {
			int prev_count = preempt_count();

			h-&gt;action(h);

			if (unlikely(prev_count != preempt_count())) {
				printk(KERN_ERR "huh, entered softirq %td %p"
				       "with preempt_count %08x,"
				       " exited with %08x?\n", h - softirq_vec,
				       h-&gt;action, prev_count, preempt_count());
				preempt_count() = prev_count;
			}

			rcu_bh_qsctr_inc(cpu);
		}
		h++;
		pending &gt;&gt;= 1;
	} while (pending);
</pre>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">&#19968;&#27425;&#24490;&#29615;&#22788;&#29702;&#32467;&#26463;&#20043;&#21518;&#65292;&#23558;&#31105;&#20013;&#26029;&#65292;&#24182;&#20877;&#27425;&#32479;&#35745;&#36719;&#20013;&#26029;&#30340;&#25513;&#30721;&#20301;&#65292;&#22914;&#26524;&#27809;&#26377;&#36229;&#36807;&#26816;&#26597;&#27425;&#25968;max_restart&#65292;&#21017;&#32487;&#32493;&#21040;restart&#26631;&#21495;&#25191;&#34892;&#12290;</li><li class="listitem">&#22914;&#26524;&#36229;&#36807;&#26368;&#22823;&#27425;&#25968;&#65292;&#24182;&#19988;&#26410;&#22788;&#29702;&#23436;&#36719;&#20013;&#26029;&#65292;&#21017;&#21796;&#37266;ksoftirqd&#12290;</li><li class="listitem">&#26368;&#21518;&#35843;&#29992;_local_bh_enable&#37325;&#26032;&#24320;&#21551;&#36719;&#20013;&#26029;&#12290;</li></ul></div>
<pre class="programlisting">
	local_irq_disable();

	pending = local_softirq_pending();
	if (pending &amp;&amp; --max_restart)
		goto restart;

	if (pending)
		wakeup_softirqd();

	trace_softirq_exit();

	account_system_vtime(current);
	_local_bh_enable();
}
</pre>

<pre class="programlisting">
void _local_bh_enable(void)
{
	WARN_ON_ONCE(in_irq());
	WARN_ON_ONCE(!irqs_disabled());

	if (softirq_count() == SOFTIRQ_OFFSET)
		trace_softirqs_on((unsigned long)__builtin_return_address(0));
	sub_preempt_count(SOFTIRQ_OFFSET);
}
</pre>
</div>
<div class="sect3" title="16.10.5. ksoftirqd&#20869;&#26680;&#32447;&#31243;"><div class="titlepage"><div><div><h4 class="title"><a name="idp81386684"></a>16.10.5. ksoftirqd&#20869;&#26680;&#32447;&#31243;</h4></div></div></div>
&#22312;&#26368;&#36817;&#30340;&#20869;&#26680;&#29256;&#26412;&#20013;&#65292;&#27599;&#20010;CPU&#37117;&#26377;&#33258;&#24049;&#30340;ksoftirqd/n&#20869;&#26680;&#32447;&#31243;(&#36825;&#37324;&#30340;n&#20195;&#34920;CPU&#30340;&#32534;&#21495;)&#12290;&#36890;&#36807;wakeup_softirqd&#21487;&#20197;&#21796;&#37266;&#35813;CPU&#19978;&#30340;ksoftirqd&#20869;&#26680;&#32447;&#31243;&#12290;
<pre class="programlisting">
static struct softirq_action softirq_vec[NR_SOFTIRQS] __cacheline_aligned_in_smp;
static DEFINE_PER_CPU(struct task_struct *, ksoftirqd);

static inline void wakeup_softirqd(void)
{
	/* Interrupts are disabled: no need to stop preemption */
	struct task_struct *tsk = __get_cpu_var(ksoftirqd);

	if (tsk &amp;&amp; tsk-&gt;state != TASK_RUNNING)
		wake_up_process(tsk);
}
</pre>
&#27599;&#20010;ksoftirqd&#20869;&#26680;&#32447;&#31243;&#37117;&#36816;&#24615;ksoftirqd&#20989;&#25968;&#65292;&#35813;&#20989;&#25968;&#23454;&#38469;&#19978;&#25191;&#34892;&#19979;&#21015;&#30340;&#24490;&#29615;&#12290;&#35813;&#24490;&#29615;&#26816;&#26597;&#36719;&#20013;&#26029;&#25513;&#30721;&#65292;&#24182;&#22312;&#24517;&#35201;&#26102;&#35843;&#29992;do_softirq&#12290;&#22914;&#26524;&#27809;&#26377;&#25346;&#36215;&#30340;&#36719;&#20013;&#26029;&#65292;&#20989;&#25968;&#25226;&#24403;&#21069;&#36827;&#31243;&#29366;&#24577;&#32622;&#20026;TASK_INTERRUPTIBLE&#65292;&#38543;&#21518;&#23558;&#22312;schedule&#25110;cond_resched&#20013;&#20135;&#29983;&#35843;&#24230;&#12290;
<pre class="programlisting">
	while(!kthread_should_stop())
	{
		preempt_disable();
		if (!local_softirq_pending()) {
			preempt_enable_no_resched();
			schedule();
			preempt_disable();
		}

		__set_current_state(TASK_RUNNING);

		while (local_softirq_pending()) {
			/* Preempt disable stops cpu going offline.
			   If already offline, we'll be on wrong CPU:
			   don't process */
			if (cpu_is_offline((long)__bind_cpu))
				goto wait_to_die;
			do_softirq();
			preempt_enable_no_resched();
			cond_resched();
			preempt_disable();
		}
		preempt_enable();
		set_current_state(TASK_INTERRUPTIBLE);
	}
</pre>
ksoftirqd&#35299;&#20915;&#20102;&#36719;&#20013;&#26029;&#38271;&#26399;&#25191;&#34892;&#32780;&#23548;&#33268;&#29992;&#25143;&#31354;&#38388;&#31243;&#24207;&#26080;&#27861;&#25191;&#34892;&#30340;&#29616;&#29366;&#65292;do_softirq&#20989;&#25968;&#30830;&#23450;&#21738;&#20123;&#36719;&#20013;&#26029;&#26159;&#25346;&#36215;&#30340;&#65292;&#24182;&#25191;&#34892;&#23427;&#20204;&#30340;&#20989;&#25968;&#12290;&#22914;&#26524;&#24050;&#32463;&#25191;&#34892;&#30340;&#36719;&#20013;&#26029;&#21448;&#34987;&#28608;&#27963;&#65292;do_softirq&#21017;&#21796;&#37266;&#20869;&#26680;&#32447;&#31243;&#24182;&#32456;&#27490;&#12290;&#20869;&#26680;&#32447;&#31243;&#26377;&#36739;&#20302;&#30340;&#20248;&#20808;&#32423;&#65292;&#22240;&#27492;&#29992;&#25143;&#31243;&#24207;&#23601;&#26377;&#26426;&#20250;&#36816;&#34892;&#65307;&#20294;&#26159;&#65292;&#22914;&#26524;&#26426;&#22120;&#31354;&#38386;&#65292;&#25346;&#36215;&#30340;&#36719;&#20013;&#26029;&#23601;&#24456;&#24555;&#34987;&#25191;&#34892;&#12290;
</div>
</div>
<div class="sect2" title="16.11. Tasklet"><div class="titlepage"><div><div><h3 class="title"><a name="idp81401364"></a>16.11. Tasklet</h3></div></div></div>
tasklet&#26159;I/O&#39537;&#21160;&#31243;&#24207;&#20013;&#23454;&#29616;&#21487;&#24310;&#36831;&#20989;&#25968;&#30340;&#39318;&#36873;&#26041;&#27861;&#12290;&#23427;&#24314;&#31435;&#22312;&#20004;&#20010;&#21483;&#20570;HI_SOFTIRQ&#21644;TASKLET_SOFTIRQ&#30340;&#36719;&#20013;&#26029;&#20043;&#19978;&#12290;&#20960;&#20010;tasklet&#21487;&#20197;&#19982;&#21516;&#19968;&#20010;&#36719;&#20013;&#26029;&#30456;&#20851;&#32852;&#65292;&#27599;&#20010;tasklet&#25191;&#34892;&#33258;&#24049;&#30340;&#20989;&#25968;&#12290;&#20004;&#20010;&#36719;&#20013;&#26029;&#20043;&#38388;&#27809;&#26377;&#30495;&#27491;&#30340;&#21306;&#21035;&#65292;&#21482;&#19981;&#36807;do_softirq&#20808;&#25191;&#34892;HI_SOFTIRQ&#30340;tasklet&#65292;&#21518;&#25191;&#34892;TASKLET_SOFTIRQ&#30340;tasklet&#12290;
<p>
tasklet&#21644;&#39640;&#20248;&#20808;&#32423;&#30340;tasklet&#20998;&#21035;&#23384;&#25918;&#22312;tasklet_vec&#21644;tasklet_hi_vec&#25968;&#32452;&#20013;&#12290;&#20108;&#32773;&#37117;&#21253;&#21547;&#31867;&#22411;&#20026;tasklet_head&#30340;NR_CPUS&#20010;&#20803;&#32032;&#65292;&#27599;&#20010;&#20803;&#32032;&#37117;&#30001;&#19968;&#20010;&#25191;&#34892;tasklet&#25551;&#36848;&#31526;&#38142;&#34920;&#30340;&#25351;&#38024;&#32452;&#25104;&#12290;tasklet&#25551;&#36848;&#31526;&#26159;&#19968;&#20010;tasklet_struct&#31867;&#22411;&#30340;&#25968;&#25454;&#32467;&#26500;&#65306;
</p><pre class="programlisting">
struct tasklet_head
{
	struct tasklet_struct *head;
	struct tasklet_struct **tail;
};

static DEFINE_PER_CPU(struct tasklet_head, tasklet_vec);
static DEFINE_PER_CPU(struct tasklet_head, tasklet_hi_vec);
</pre><p>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">next &#25351;&#21521;&#38142;&#34920;&#20013;&#19979;&#19968;&#20010;&#25551;&#36848;&#31526;&#30340;&#25351;&#38024;&#12290;</li><li class="listitem">state tasklet&#30340;&#29366;&#24577;&#12290;</li><li class="listitem">count &#38145;&#35745;&#25968;&#22120;&#12290;</li><li class="listitem">func &#25191;&#34892;tasklet&#20989;&#25968;&#30340;&#25351;&#38024;&#12290;</li><li class="listitem">data &#30001;tasklet&#20989;&#25968;&#20351;&#29992;&#30340;&#21442;&#25968;&#12290;</li></ul></div><p>
</p><pre class="programlisting">
struct tasklet_struct
{
	struct tasklet_struct *next;
	unsigned long state;
	atomic_t count;
	void (*func)(unsigned long);
	unsigned long data;
};
</pre><p>
state&#24403;&#21069;&#26377;&#20004;&#20010;&#26631;&#24535;&#65306;
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">TASKLET_STATE_SCHED &#35813;&#26631;&#24535;&#34987;&#35774;&#32622;&#26102;&#65292;&#34920;&#31034;tasklet&#26159;&#25346;&#36215;&#30340;&#65292;&#20063;&#24847;&#21619;&#30528;tasklet&#25551;&#36848;&#31526;&#34987;&#25554;&#20837;&#21040;tasklet_vec&#21644;tasklet_hi_vec&#25968;&#32452;&#30340;&#20854;&#20013;&#19968;&#20010;&#38142;&#34920;&#20013;&#12290;</li><li class="listitem">TASKLET_STATE_RUN &#34920;&#31034;tasklet&#27491;&#22312;&#34987;&#25191;&#34892;&#65307;&#22312;&#21333;&#22788;&#29702;&#22120;&#31995;&#32479;&#19978;&#19981;&#36866;&#29992;&#36825;&#20010;&#26631;&#24535;&#65292;&#22240;&#20026;&#27809;&#26377;&#24517;&#35201;&#26816;&#26597;&#29305;&#23450;&#30340;tasklet&#26159;&#21542;&#22312;&#36816;&#34892;&#12290;</li></ul></div><p>
&#22914;&#20309;&#20351;&#29992;tasklet&#21602;&#65311;&#39318;&#20808;&#65292;&#20998;&#37197;&#19968;&#20010;&#26032;&#30340;tasklet_struct&#25968;&#25454;&#32467;&#26500;&#65292;&#24182;&#35843;&#29992;tasklet_init&#21021;&#22987;&#21270;&#23427;&#65292;&#35813;&#20989;&#25968;&#21442;&#25968;&#20998;&#21035;&#20026;tasklet&#25551;&#36848;&#31526;&#22320;&#22336;&#65292;tasklet&#20989;&#25968;&#22320;&#22336;&#21644;&#23427;&#30340;&#21487;&#36873;&#25972;&#24418;&#21442;&#25968;&#12290;
</p><pre class="programlisting">
void tasklet_init(struct tasklet_struct *t,
		  void (*func)(unsigned long), unsigned long data)
{
	t-&gt;next = NULL;
	t-&gt;state = 0;
	atomic_set(&amp;t-&gt;count, 0);
	t-&gt;func = func;
	t-&gt;data = data;
}
</pre><p>
&#35843;&#29992;tasklet_disable_nosync&#25110;tasklet_disable&#21487;&#20197;&#36873;&#25321;&#24615;&#22320;&#31105;&#27490;tasklet&#12290;&#36825;&#20004;&#20010;&#20989;&#25968;&#37117;&#22686;&#21152;tasklet&#25551;&#36848;&#31526;&#30340;count&#23383;&#27573;&#65292;&#20294;&#26159;&#21518;&#19968;&#20010;&#20989;&#25968;&#21482;&#26377;&#22312;tasklet&#20989;&#25968;&#24050;&#32463;&#36816;&#34892;&#30340;&#31034;&#20363;&#32467;&#26463;&#21518;&#25165;&#36820;&#22238;&#12290;&#20026;&#20102;&#37325;&#26032;&#28608;&#27963;tasklet&#65292;&#35843;&#29992;tasklet_enable&#12290;
</p>
<p>
&#20026;&#20102;&#28608;&#27963;tasklet&#65292;&#24212;&#35813;&#26681;&#25454;tasklet&#38656;&#35201;&#30340;&#20248;&#20808;&#32423;&#65292;&#35843;&#29992;tasklet_schedule&#20989;&#25968;&#25110;tasklet_hi_schedule&#20989;&#25968;&#12290;&#36825;&#20004;&#20010;&#20989;&#25968;&#38750;&#24120;&#31867;&#20284;&#65292;&#20854;&#20013;&#27599;&#20010;&#37117;&#25191;&#34892;&#19979;&#21015;&#25805;&#20316;&#65306;
</p><pre class="programlisting">
static inline void tasklet_schedule(struct tasklet_struct *t)
{
	if (!test_and_set_bit(TASKLET_STATE_SCHED, &amp;t-&gt;state))
		__tasklet_schedule(t);
}
</pre><p>
tasklet_schedule&#26159;&#23545;__tasklet_schedule&#23553;&#35013;&#65292;&#24182;&#35774;&#32622;TASKLET_STATE_SCHED&#26631;&#24535;&#20301;&#12290;&#22914;&#26524;&#24050;&#32463;&#35774;&#32622;&#20102;&#35813;&#20301;&#65292;&#35828;&#26126;tasklet&#24050;&#34987;&#35843;&#24230;&#65292;&#21017;&#30452;&#25509;&#36820;&#22238;&#12290;
</p><pre class="programlisting">
void __tasklet_schedule(struct tasklet_struct *t)
{
	unsigned long flags;

	local_irq_save(flags);
	t-&gt;next = NULL;
	*__get_cpu_var(tasklet_vec).tail = t;
	__get_cpu_var(tasklet_vec).tail = &amp;(t-&gt;next);
	raise_softirq_irqoff(TASKLET_SOFTIRQ);
	local_irq_restore(flags);
}
</pre><p>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">local_irq_save&#20445;&#23384;IF&#26631;&#24535;&#30340;&#29366;&#24577;&#24182;&#31105;&#29992;&#26412;&#22320;&#20013;&#26029;&#12290;</li><li class="listitem">&#22312;tasklet_vec[n]&#25110;tasklet_hi_vec[n]&#25351;&#21521;&#30340;&#38142;&#34920;&#30340;&#36215;&#22987;&#22788;&#22686;&#21152;tasklet&#25551;&#36848;&#31526;(n&#34920;&#31034;CPU&#30340;&#32534;&#21495;)&#12290;</li><li class="listitem">&#35843;&#29992;raise_softirq_irqoff&#28608;&#27963;TASKLET_SOFTIRQ&#25110;HI_SOFTIRQ&#31867;&#22411;&#30340;&#36719;&#20013;&#26029;&#12290;(&#35813;&#20989;&#25968;&#19982;raise_softirq&#20989;&#25968;&#31867;&#20284;&#65292;&#21482;&#26159;&#23427;&#20551;&#35774;&#24050;&#32463;&#31105;&#29992;&#20102;&#26412;&#22320;&#20013;&#26029;&#12290;)</li><li class="listitem">local_irq_restore&#24674;&#22797;IF&#26631;&#24535;&#20301;&#30340;&#29366;&#24577;&#12290;</li></ul></div><p>
</p><pre class="programlisting">
inline void raise_softirq_irqoff(unsigned int nr)
{
	__raise_softirq_irqoff(nr);

	if (!in_interrupt())
		wakeup_softirqd();
}
</pre><p>
&#26368;&#21518;&#30475;&#19968;&#19979;tasklet&#22914;&#20309;&#34987;&#25191;&#34892;&#12290;&#36719;&#20013;&#26029;&#20989;&#25968;&#19968;&#26086;&#34987;&#28608;&#27963;&#23601;&#30001;do_softirq&#20989;&#25968;&#25191;&#34892;&#12290;&#19982;HI_SOFTIRQ&#36719;&#20013;&#26029;&#30456;&#20851;&#30340;&#36719;&#20013;&#26029;&#20989;&#25968;&#21483;&#20570;tasklet_hi_action&#65292;&#32780;&#19982;TASKLET_SOFTIRQ&#30456;&#20851;&#30340;&#20989;&#25968;&#21483;&#20570;tasklet_action&#12290;&#36825;&#20004;&#20010;&#20989;&#25968;&#38750;&#24120;&#31867;&#20284;&#65292;&#23427;&#20204;&#37117;&#25191;&#34892;&#19979;&#21015;&#25805;&#20316;&#65306;
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">&#31105;&#29992;&#26412;&#22320;&#20013;&#26029;&#12290;</li><li class="listitem">&#33719;&#21462;&#26412;&#22320;CPU&#30340;&#32534;&#21495;n&#12290;</li><li class="listitem">&#25226;tasklet_vec[n]&#25110;tasklet_hi_vec[n]&#25351;&#21521;&#30340;&#38142;&#34920;&#30340;&#22320;&#22336;&#23384;&#20837;&#23616;&#37096;&#21464;&#37327;list&#12290;</li><li class="listitem">&#25226;tasklet_vec[n]&#25110;tasklet_hi_vec[n]&#30340;&#20540;&#32622;&#20026;NULL&#65292;&#22240;&#27492;&#65292;&#24050;&#35843;&#24230;&#30340;tasklet&#25551;&#36848;&#31526;&#30340;&#38142;&#34920;&#34987;&#28165;&#31354;&#12290;</li><li class="listitem">&#25171;&#24320;&#26412;&#22320;&#20013;&#26029;&#12290;</li></ul></div><p>
&#25509;&#19979;&#26469;&#23545;list&#25351;&#21521;&#30340;&#38142;&#34920;&#20013;&#30340;&#27599;&#20010;tasklet&#25551;&#36848;&#31526;&#65306;
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">&#26597;&#30475;count&#23383;&#27573;&#65292;&#26816;&#26597;tasklet&#26159;&#21542;&#34987;&#31105;&#27490;&#65292;&#22914;&#26524;&#26159;&#65292;&#23601;&#28165;TASKLET_STATE_SCHED
&#12290;</li><li class="listitem"><li class="listitem"></ul></div><p>	
</p><pre class="programlisting">
static void tasklet_action(struct softirq_action *a)
{
	struct tasklet_struct *list;

	local_irq_disable();
	list = __get_cpu_var(tasklet_vec).head;
	__get_cpu_var(tasklet_vec).head = NULL;
	__get_cpu_var(tasklet_vec).tail = &amp;__get_cpu_var(tasklet_vec).head;
	local_irq_enable();

	while (list) {
		struct tasklet_struct *t = list;

		list = list-&gt;next;

		if (tasklet_trylock(t)) {
			if (!atomic_read(&amp;t-&gt;count)) {
				if (!test_and_clear_bit(TASKLET_STATE_SCHED, &amp;t-&gt;state))
					BUG();
				t-&gt;func(t-&gt;data);
				tasklet_unlock(t);
				continue;
			}
			tasklet_unlock(t);
		}

		local_irq_disable();
		t-&gt;next = NULL;
		*__get_cpu_var(tasklet_vec).tail = t;
		__get_cpu_var(tasklet_vec).tail = &amp;(t-&gt;next);
		__raise_softirq_irqoff(TASKLET_SOFTIRQ);
		local_irq_enable();
	}
}
</pre><p>
</p>
<p>
</p>
</div>
<div class="footnotes"><br><hr width="100" align="left"><div class="footnote"><p><sup>[<a name="ftn.idp81223284" href="#idp81223284" class="para">10</a>] </sup>&#23454;&#38469;&#19978;&#65292;&#26681;&#25454;&#20013;&#26029;&#31867;&#22411;&#19981;&#21516;&#65292;&#21487;&#33021;&#25351;&#21521;&#24341;&#21457;&#20013;&#26029;&#25351;&#20196;&#30340;&#21518;&#19968;&#26465;&#25110;&#32773;&#22810;&#26465;&#25351;&#20196;&#12290;</p></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ar01s15.html">&#19978;&#19968;&#39029;</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="ar01s17.html">&#19979;&#19968;&#39029;</a></td></tr><tr><td width="40%" align="left" valign="top">15. IO&#35774;&#22791;&#31649;&#29702; </td><td width="20%" align="center"><a accesskey="h" href="index.html">&#36215;&#22987;&#39029;</a></td><td width="40%" align="right" valign="top"> 17. &#20869;&#26680;&#21442;&#25968;&#35299;&#26512;</td></tr></table></div></body></html>
