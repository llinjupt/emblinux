<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>10. Bootmem&#26426;&#21046;</title><link rel="stylesheet" href="styles.css" type="text/css"><meta name="generator" content="DocBook XSL-NS Stylesheets V1.75.2"><link rel="home" href="index.html" title="Linux&#20869;&#26680;&#23398;&#20064;&#21644;&#30740;&#31350;&#21450;&#23884;&#20837;&#24335;(ARM)&#23398;&#20064;&#21644;&#30740;&#31350;&#30340;&#24320;&#25918;&#25991;&#26723;"><link rel="up" href="index.html" title="Linux&#20869;&#26680;&#23398;&#20064;&#21644;&#30740;&#31350;&#21450;&#23884;&#20837;&#24335;(ARM)&#23398;&#20064;&#21644;&#30740;&#31350;&#30340;&#24320;&#25918;&#25991;&#26723;"><link rel="prev" href="ar01s09.html" title="9. &#20869;&#26680;&#21021;&#22987;&#21270;"><link rel="next" href="ar01s11.html" title="11. &#20869;&#26680;&#21021;&#22987;&#21270;2"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">10. Bootmem&#26426;&#21046;</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ar01s09.html">&#19978;&#19968;&#39029;</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="ar01s11.html">&#19979;&#19968;&#39029;</a></td></tr></table><hr></div><div class="sect1" title="10. Bootmem&#26426;&#21046;"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp80601188"></a>10. Bootmem&#26426;&#21046;</h2></div></div></div>
<div class="sect2" title="10.1. &#31616;&#20171;"><div class="titlepage"><div><div><h3 class="title"><a name="idp80781068"></a>10.1. &#31616;&#20171;</h3></div></div></div>
	<p>
Bootmem&#26426;&#21046;&#26159;&#20869;&#26680;&#22312;&#21551;&#21160;&#26102;&#23545;&#20869;&#23384;&#30340;&#19968;&#31181;&#31616;&#21333;&#30340;&#39029;&#38754;&#31649;&#29702;&#26041;&#24335;&#12290;	&#23427;&#20026;&#24314;&#31435;&#39029;&#34920;&#31649;&#29702;&#20195;&#30721;&#20013;&#30340;&#25968;&#25454;&#32467;&#26500;&#25552;&#20379;&#21160;&#24577;&#20998;&#37197;&#20869;&#23384;&#30340;&#25903;&#25345;&#65292;&#20026;&#20102;&#23545;&#39029;&#38754;&#31649;&#29702;&#26426;&#21046;&#20316;&#20934;&#22791;&#65292;Linux&#20351;&#29992;&#20102;&#19968;&#31181;&#21483;bootmem&#20998;&#37197;&#22120;(bootmem allocator)&#30340;&#26426;&#21046;&#65292;&#36825;&#31181;&#26426;&#21046;&#20165;&#20165;&#29992;&#22312;&#31995;&#32479;&#24341;&#23548;&#26102;&#65292;&#23427;&#20026;&#25972;&#20010;&#29289;&#29702;&#20869;&#23384;&#24314;&#31435;&#36215;&#19968;&#20010;&#39029;&#38754;&#20301;&#22270;&#12290;&#36825;&#20010;&#20301;&#22270;&#24314;&#31435;&#22312;&#20869;&#26680;&#20195;&#30721;&#26144;&#35937;&#32456;&#28857;_end&#19978;&#26041;&#30340;&#22320;&#26041;&#12290;&#36825;&#20010;&#20301;&#22270;&#29992;&#26469;&#31649;&#29702;&#20302;&#21306;&#65288;&#21487;&#34987;&#30452;&#25509;&#19968;&#19968;&#26144;&#23556;&#30340;&#29289;&#29702;&#20869;&#23384;&#21306;&#65292;&#23567;&#20110;896Mb&#65289;&#12290;&#22240;&#20026;&#22312;0&#21040;896Mb&#30340;&#33539;&#22260;&#20869;&#65292;&#26377;&#20123;&#39029;&#38754;&#21487;&#33021;&#20445;&#30041;&#32473;&#20869;&#26680;&#20195;&#30721;&#65292;&#39029;&#30446;&#24405;&#65292;&#20197;&#21450;&#24403;&#21069;&#30340;&#20301;&#22270;&#20351;&#29992;&#65292;&#26377;&#20123;&#39029;&#38754;&#21487;&#33021;&#26377;&#31354;&#27934;&#65292;&#22240;&#27492;&#65292;&#24314;&#31435;&#36825;&#20010;&#20301;&#22270;&#30340;&#30446;&#30340;&#23601;&#26159;&#35201;&#29992;&#19968;&#20010;&#27604;&#29305;&#20301;&#30340;&#20004;&#31181;&#29366;&#24577;&#26631;&#35760;&#29289;&#29702;&#39029;&#38754;&#30340;&#29366;&#24577;&#65306;&#24050;&#34987;&#20445;&#30041;&#65307;&#21487;&#34987;&#21160;&#24577;&#20998;&#37197;&#12290;Bootmem&#26426;&#21046;&#30340;&#26680;&#24515;&#26159;&#23545;Bitmap&#30340;&#25805;&#20316;&#65292;&#30456;&#20851;&#20195;&#30721;&#20301;&#20110;mm/bootmem.c&#21644;include/linux/bootmem.h&#20013;&#12290;
</p><div class="figure"><a name="idp80782460"></a><p class="title"><b>&#22270; 54. ARM&#19978;&#30340;Linux&#22320;&#22336;&#31354;&#38388;&#20998;&#24067;</b></p><div class="figure-contents"><div><img src="images/ram_map.gif" alt="ARM&#19978;&#30340;Linux&#22320;&#22336;&#31354;&#38388;&#20998;&#24067;"></div></div></div><p><br class="figure-break">
	</p>	
	<p>
&#22312;&#20171;&#32461;Bootmem&#26426;&#21046;&#20043;&#21069;&#38656;&#35201;&#23545;&#20869;&#26680;&#30340;&#22320;&#22336;&#31354;&#38388;&#20998;&#24067;&#20570;&#19968;&#20010;&#28145;&#20837;&#30340;&#20102;&#35299;&#65306;
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">32&#20301;&#25805;&#20316;&#31995;&#32479;&#21482;&#26377;4G&#30340;&#34394;&#25311;&#22320;&#22336;&#31354;&#38388;&#65292;&#36890;&#24120;Linux&#23558;&#26368;&#19978;&#30340;1G&#29992;&#20110;&#20869;&#26680;&#34394;&#25311;&#22320;&#22336;&#12290;ARM&#19978;&#23558;&#29992;&#25143;&#31354;&#38388;&#30340;3G&#26368;&#39640;&#22788;&#30340;16M&#29992;&#26469;&#32473;&#20869;&#26680;&#30340;&#27169;&#22359;&#20351;&#29992;&#12290;</li><li class="listitem">Linux&#23558;&#29289;&#29702;&#20869;&#23384;&#23436;&#20840;&#19968;&#19968;&#26144;&#23556;&#21040;&#20869;&#26680;&#31354;&#38388;&#65292;&#36825;&#26679;&#24456;&#26041;&#20415;&#31649;&#29702;&#20869;&#23384;&#65292;&#20219;&#20309;&#39029;&#38754;&#30340;&#34394;&#25311;&#22320;&#22336;&#20943;&#21435;&#19968;&#20010;PAGE_OFFSET(0xc0000000)&#30340;&#20559;&#31227;r&#28982;&#21518;&#21152;&#19978;&#29289;&#29702;&#22320;&#22336;&#30340;&#20559;&#31227;PHYS_OFFSET&#23601;&#21487;&#20197;&#24471;&#21040;&#29289;&#29702;&#22320;&#22336;&#12290;</li><li class="listitem">&#20869;&#26680;&#36824;&#38656;&#35201;&#21160;&#24577;&#31649;&#29702;&#19968;&#20123;&#20869;&#23384;&#29992;&#20110;vmalloc&#25110;&#32773;&#35774;&#22791;&#20020;&#26102;&#26144;&#23556;&#31561;&#65292;&#22240;&#27492;&#19981;&#33021;&#23558;1G&#30340;&#34394;&#25311;&#31354;&#38388;&#23436;&#20840;&#19968;&#19968;&#26144;&#23556;&#29289;&#29702;&#20869;&#23384;&#65292;&#22240;&#27492;&#26435;&#34913;&#20102;&#19968;&#20010;896M&#30340;&#22823;&#23567;&#65292;0xc0000000&#21040;0xc0000000 + 896M&#30340;&#34394;&#25311;&#22320;&#22336;&#31354;&#38388;&#19968;&#19968;&#26144;&#23556;&#29289;&#29702;&#20869;&#23384;&#65292;&#20174;0xc0000000+896M&#21040;0xffffffff&#30340;&#22320;&#22336;&#31354;&#38388;&#20316;&#20026;&#21160;&#24577;&#26144;&#23556;&#30340;&#38656;&#35201;&#12290;</li></ul></div><p>
&#23545;&#20110;&#22823;&#20110;896M&#30340;&#29289;&#29702;&#20869;&#23384;&#65292;&#26159;&#26080;&#27861;&#36890;&#36807;&#19968;&#19968;&#26144;&#23556;&#26469;&#35775;&#38382;&#30340;&#65292;&#36890;&#36807;vmalloc&#21487;&#20197;&#35775;&#38382;&#23427;&#20204;&#65292;&#20294;&#26159;&#23545;&#20110;&#22823;&#20110;4G&#30340;&#20869;&#23384;&#38656;&#35201;PAE&#30340;&#25903;&#25345;&#65292;&#21542;&#21017;&#26080;&#27861;&#35775;&#38382;&#12290;
	</p>
</div>
<div class="sect2" title="10.2. bootmem_data"><div class="titlepage"><div><div><h3 class="title"><a name="idp80785476"></a>10.2. bootmem_data</h3></div></div></div>
&#29992;&#26469;&#23384;&#25918;&#20301;&#22270;&#30340;&#25968;&#25454;&#32467;&#26500;&#20026;bootmem_data&#12290;
<pre class="programlisting">
include/linux/bootmem.h

typedef struct bootmem_data {
        unsigned long node_min_pfn;
        unsigned long node_low_pfn;
        void *node_bootmem_map;
        unsigned long last_end_off;
        unsigned long hint_idx;
        struct list_head list;
} bootmem_data_t;
</pre>

<div class="itemizedlist"><pre class="programlisting">
&#22312;RAM&#20026;256M&#30340;ARM&#26495;&#19978;&#30340;&#27979;&#35797;&#32467;&#26524;&#36755;&#20986;&#22914;&#19979;
.node_min_pfn:0x50000, node_low_pfn:0x60000
.node_bootmem_map:      c053c000
.last_end_off:  0x0
.hint_idx:      0x0
</pre><ul class="itemizedlist" type="disc"><li class="listitem">node_min_pfn/node_low_pfn&#34920;&#31034;&#26368;&#23567;&#21644;&#26368;&#22823;&#30340;&#29289;&#29702;&#20869;&#23384;&#39029;&#26694;&#65292;node_low_pfn-node_min_pfn&#20195;&#34920;&#29289;&#29702;&#20869;&#23384;&#30340;&#39029;&#26694;&#25968;&#65292;&#26368;&#22823;&#19981;&#33021;&#36229;&#36807;896Mb&#23545;&#24212;&#30340;&#39029;&#26694;&#25968;&#30446;0x38000&#12290;</li><li class="listitem">node_bootmem_map&#34920;&#31034;&#23384;&#25918;bootmem&#20301;&#22270;&#30340;&#22320;&#22336;&#65292;&#21363;&#20869;&#26680;&#26144;&#35937;&#32467;&#26463;&#22788;&#30340;&#31532;&#19968;&#20010;&#39029;&#38754;&#30340;&#25152;&#22312;&#22320;&#22336;&#12290;</li><li class="listitem">last_end_off&#35760;&#24405;&#30340;&#26159;&#19978;&#27425;&#30003;&#35831;&#30340;&#31354;&#38388;&#21518;&#30340;&#31532;&#19968;&#20010;&#30456;&#23545;&#20110;0&#20559;&#31227;&#30340;&#29289;&#29702;&#22320;&#22336;&#12290;</li><li class="listitem">hint_idx&#35760;&#24405;&#20102;&#26368;&#21518;&#19968;&#27425;&#30003;&#35831;&#30340;&#31354;&#38388;&#21518;&#30340;&#19968;&#20010;&#29289;&#29702;&#39029;&#26694;&#30340;&#22320;&#22336;&#12290;&#23427;&#26041;&#20415;&#19979;&#19968;&#27425;&#30003;&#35831;&#20869;&#23384;&#26159;&#20351;&#29992;&#12290;</li><li class="listitem">list&#34987;&#29992;&#26469;&#36830;&#25509;&#21040;bdata_list&#12290;</li></ul></div> 

</div>
<div class="sect2" title="10.3. UMA&#21644;NUMA"><div class="titlepage"><div><div><h3 class="title"><a name="idp80788844"></a>10.3. UMA&#21644;NUMA</h3></div></div></div>
<p>Linux&#23545;&#29289;&#29702;&#20869;&#23384;&#30340;&#25551;&#36848;&#26426;&#21046;&#26377;&#20004;&#31181;&#65306;UMA&#21644;NUMA&#12290;</p>
<p>&#22312;&#20256;&#32479;&#30340;&#35745;&#31639;&#26426;&#32467;&#26500;&#20013;&#65292;&#25972;&#20010;&#29289;&#29702;&#20869;&#23384;&#37117;&#26159;&#22343;&#21248;&#19968;&#33268;&#30340;&#65292;CPU&#35775;&#38382;&#36825;&#20010;&#31354;&#38388;&#20013;&#30340;&#20219;&#20309;&#19968;&#20010;&#22320;&#22336;&#25152;&#38656;&#35201;&#30340;&#26102;&#38388;&#37117;&#30456;&#21516;&#65292;&#25152;&#20197;&#25226;&#36825;&#31181;&#20869;&#23384;&#31216;&#20026;&#8220;&#19968;&#33268;&#23384;&#20648;&#32467;&#26500;&#65288;Uniform Memory Architecture&#65289;&#65292;&#31616;&#31216;UMA&#12290;&#21487;&#26159;&#65292;&#22312;&#19968;&#20123;&#26032;&#30340;&#31995;&#32479;&#32467;&#26500;&#20013;&#65292;&#29305;&#21035;&#26159;&#22810;CPU&#32467;&#26500;&#30340;&#31995;&#32479;&#20013;&#65292;&#29289;&#29702;&#23384;&#20648;&#31354;&#38388;&#22312;&#36825;&#26041;&#38754;&#30340;&#19968;&#33268;&#24615;&#21364;&#25104;&#20102;&#38382;&#39064;&#12290;&#36825;&#26159;&#22240;&#20026;&#65292;&#22312;&#22810;CPU&#32467;&#26500;&#20013;&#65292;&#31995;&#32479;&#20013;&#21482;&#26377;&#19968;&#26465;&#24635;&#32447;&#65288;&#20363;&#22914;&#65292;PCI&#24635;&#32447;&#65289;&#65292;&#26377;&#22810;&#20010;CPU&#27169;&#22359;&#36830;&#25509;&#22312;&#31995;&#32479;&#24635;&#32447;&#19978;&#65292;&#27599;&#20010;CPU&#27169;&#22359;&#37117;&#26377;&#26412;&#22320;&#30340;&#29289;&#29702;&#20869;&#23384;&#65292;&#20294;&#26159;&#20063;&#21487;&#20197;&#36890;&#36807;&#31995;&#32479;&#24635;&#32447;&#35775;&#38382;&#20854;&#23427;CPU&#27169;&#22359;&#19978;&#30340;&#20869;&#23384;&#12290;&#21478;&#22806;&#65292;&#31995;&#32479;&#24635;&#32447;&#19978;&#36824;&#36830;&#25509;&#30528;&#19968;&#20010;&#20844;&#29992;&#30340;&#23384;&#20648;&#27169;&#22359;&#65292;&#25152;&#26377;&#30340;CPU&#27169;&#22359;&#37117;&#21487;&#20197;&#36890;&#36807;&#31995;&#32479;&#24635;&#32447;&#26469;&#35775;&#38382;&#23427;&#12290;&#22240;&#27492;&#65292;&#25152;&#26377;&#36825;&#20123;&#29289;&#29702;&#20869;&#23384;&#30340;&#22320;&#22336;&#21487;&#20197;&#20114;&#30456;&#36830;&#32493;&#32780;&#24418;&#25104;&#19968;&#20010;&#36830;&#32493;&#30340;&#29289;&#29702;&#22320;&#22336;&#31354;&#38388;&#12290;</p>
<p>
&#26174;&#28982;&#65292;&#23601;&#26576;&#20010;&#29305;&#23450;&#30340;CPU&#32780;&#35328;&#65292;&#35775;&#38382;&#20854;&#26412;&#22320;&#30340;&#23384;&#20648;&#22120;&#36895;&#24230;&#26159;&#26368;&#24555;&#30340;&#65292;&#32780;&#31359;&#36807;&#31995;&#32479;&#24635;&#32447;&#35775;&#38382;&#20844;&#29992;&#23384;&#20648;&#27169;&#22359;&#25110;&#20854;&#23427;CPU&#27169;&#22359;&#19978;&#30340;&#23384;&#20648;&#22120;&#23601;&#27604;&#36739;&#24930;&#65292;&#32780;&#19988;&#36824;&#38754;&#20020;&#22240;&#21487;&#33021;&#30340;&#31454;&#20105;&#32780;&#24341;&#36215;&#30340;&#19981;&#30830;&#23450;&#24615;&#12290;&#20063;&#23601;&#26159;&#35828;&#65292;&#22312;&#36825;&#26679;&#30340;&#31995;&#32479;&#20013;&#65292;&#20854;&#29289;&#29702;&#23384;&#20648;&#31354;&#38388;&#34429;&#28982;&#22320;&#22336;&#36830;&#32493;&#65292;&#20294;&#22240;&#20026;&#25152;&#22788;&#8220;&#20301;&#32622;&#8221;&#19981;&#21516;&#32780;&#23548;&#33268;&#30340;&#23384;&#21462;&#36895;&#24230;&#19981;&#19968;&#33268;&#65292;&#25152;&#20197;&#31216;&#20026;&#8220;&#38750;&#19968;&#33268;&#23384;&#20648;&#32467;&#26500;&#65288;Non-Uniform Memory Architecture&#65289;&#65292;&#31616;&#31216;NUMA&#12290;</p>
<p>
&#20107;&#23454;&#19978;&#65292;&#20005;&#26684;&#24847;&#20041;&#19978;&#30340;UMA&#32467;&#26500;&#20960;&#20046;&#19981;&#23384;&#22312;&#12290;&#23601;&#25343;&#37197;&#32622;&#26368;&#31616;&#21333;&#30340;&#21333;CPU&#26469;&#35828;&#65292;&#20854;&#29289;&#29702;&#23384;&#20648;&#31354;&#38388;&#23601;&#21253;&#25324;&#20102;RAM&#12289;ROM&#65288;&#29992;&#20110;BIOS&#65289;&#65292;&#36824;&#26377;&#22270;&#24418;&#21345;&#19978;&#30340;&#38745;&#24577;RAM&#12290;&#20294;&#26159;&#65292;&#22312;UMA&#20013;&#65292;&#38500;&#20027;&#23384;RAM&#20043;&#22806;&#30340;&#23384;&#20648;&#22120;&#31354;&#38388;&#37117;&#24456;&#23567;&#65292;&#22240;&#27492;&#21487;&#20197;&#25226;&#23427;&#20204;&#25918;&#22312;&#29305;&#27530;&#30340;&#22320;&#22336;&#19978;&#65292;&#22312;&#32534;&#31243;&#26102;&#21152;&#20197;&#29305;&#21035;&#27880;&#24847;&#23601;&#34892;&#65292;&#37027;&#20040;&#65292;&#21487;&#20197;&#35748;&#20026;&#20197;RAM&#20026;&#20027;&#20307;&#30340;&#20027;&#23384;&#26159;UMA&#32467;&#26500;&#12290;</p>
<p>
&#30001;&#20110;NUMA&#30340;&#24341;&#20837;&#65292;&#23601;&#38656;&#35201;&#23384;&#20648;&#31649;&#29702;&#26426;&#21046;&#30340;&#25903;&#25345;&#65292;&#22240;&#27492;&#65292;Linux&#20869;&#26680;&#20174;2.4&#29256;&#26412;&#24320;&#22987;&#23601;&#25552;&#20379;&#20102;&#23545;NUMA&#30340;&#25903;&#25345;&#65288;&#20316;&#20026;&#19968;&#20010;&#32534;&#35793;&#21487;&#36873;&#39033;&#65289;&#12290;&#20026;&#20102;&#23545;NUMA&#36827;&#34892;&#25551;&#36848;&#65292;&#24341;&#20837;&#19968;&#20010;&#26032;&#30340;&#27010;&#24565;&#65293;&#8220;&#23384;&#20648;&#33410;&#28857;(&#25110;&#21483;&#33410;&#28857;)&#65292;&#25226;&#35775;&#38382;&#26102;&#38388;&#30456;&#21516;&#30340;&#23384;&#20648;&#31354;&#38388;&#23601;&#21483;&#20570;&#19968;&#20010;&#8220;&#23384;&#20648;&#33410;&#28857;&#8221;&#12290;&#19968;&#33324;&#26469;&#35828;&#65292;&#36830;&#32493;&#30340;&#29289;&#29702;&#39029;&#38754;&#24212;&#35813;&#20998;&#37197;&#22312;&#30456;&#21516;&#30340;&#23384;&#20648;&#33410;&#28857;&#19978;&#12290;&#20363;&#22914;&#65292;&#22914;&#26524;CPU&#27169;&#22359;1&#35201;&#27714;&#20998;&#37197;5&#20010;&#39029;&#38754;&#65292;&#20294;&#26159;&#30001;&#20110;&#26412;&#27169;&#22359;&#19978;&#30340;&#23384;&#20648;&#31354;&#38388;&#24050;&#32463;&#19981;&#22815;&#65292;&#21482;&#33021;&#20998;&#37197;3&#20010;&#39029;&#38754;&#65292;&#37027;&#20040;&#27492;&#26102;&#65292;&#26159;&#25226;&#21478;&#22806;&#20004;&#20010;&#39029;&#38754;&#20998;&#37197;&#22312;&#20854;&#23427;CPU&#27169;&#22359;&#19978;&#21602;&#65292;&#36824;&#26159;&#25226;5&#20010;&#39029;&#38754;&#24178;&#33030;&#20998;&#37197;&#22312;&#19968;&#20010;&#27169;&#22359;&#19978;&#65311;&#26174;&#28982;&#65292;&#21512;&#29702;&#30340;&#20998;&#37197;&#26041;&#24335;&#22240;&#35813;&#26159;&#23558;&#36825;5&#20010;&#39029;&#38754;&#37117;&#20998;&#37197;&#22312;&#20844;&#29992;&#27169;&#22359;&#19978;&#12290;
</p>
<pre class="programlisting">
mm/bootmem.c
bootmem_data_t bootmem_node_data[MAX_NUMNODES] __initdata;
</pre>
Linux&#23450;&#20041;&#20102;&#19968;&#20010;&#22823;&#23567;&#20026;MAX_NUMNODES&#31867;&#22411;&#20026;bootmem_data_t&#30340;bootmem_node_data&#25968;&#32452;&#65292;&#25968;&#32452;&#30340;&#22823;&#23567;&#26681;&#25454;CONFIG_NODES_SHIFT&#30340;&#37197;&#32622;&#20915;&#23450;&#12290;&#23545;&#20110;UMA&#26469;&#35828;&#65292;NODES_SHIFT&#20026;0&#65292;&#25152;&#20197;MAX_NUMNODES&#30340;&#20540;&#20026;1&#12290;
<p>Linux&#25226;&#29289;&#29702;&#20869;&#23384;&#21010;&#20998;&#20026;&#19977;&#20010;&#23618;&#27425;&#26469;&#31649;&#29702;&#65306;&#23384;&#20648;&#33410;&#28857;&#65288;Node&#65289;&#12289;&#31649;&#29702;&#21306;&#65288;Zone&#65289;&#21644;&#39029;&#38754;&#65288;Page&#65289;&#12290;&#20026;&#20102;&#25903;&#25345;NUMA&#27169;&#22411;&#65292;&#20063;&#21363;CPU&#23545;&#19981;&#21516;&#20869;&#23384;&#21333;&#20803;&#30340;&#35775;&#38382;&#26102;&#38388;&#21487;&#33021;&#19981;&#21516;&#65292;&#27492;&#26102;&#31995;&#32479;&#30340;&#29289;&#29702;&#20869;&#23384;&#34987;&#21010;&#20998;&#20026;&#20960;&#20010;&#33410;&#28857;(node)&#12290;&#22312;&#19968;&#20010;&#21333;&#29420;&#30340;&#33410;&#28857;&#20869;&#65292;&#20219;&#19968;&#32473;&#23450;CPU&#35775;&#38382;&#39029;&#38754;&#25152;&#38656;&#30340;&#26102;&#38388;&#37117;&#26159;&#30456;&#21516;&#30340;&#12290;&#28982;&#32780;&#65292;&#23545;&#19981;&#21516;&#30340;CPU&#65292;&#36825;&#20010;&#26102;&#38388;&#21487;&#33021;&#23601;&#19981;&#21516;&#12290;&#23545;&#27599;&#20010;CPU&#32780;&#35328;&#65292;&#20869;&#26680;&#37117;&#35797;&#22270;&#25226;&#32791;&#26102;&#33410;&#28857;&#30340;&#35775;&#38382;&#27425;&#25968;&#20943;&#21040;&#26368;&#23569;&#36825;&#23601;&#35201;&#23567;&#24515;&#22320;&#36873;&#25321;CPU&#26368;&#24120;&#24341;&#29992;&#30340;&#20869;&#26680;&#25968;&#25454;&#32467;&#26500;&#30340;&#23384;&#25918;&#20301;&#32622;&#12290;
</p><p>
&#21478;&#22806;&#65292;linux&#20869;&#26680;&#22312;&#19968;&#20123;&#29305;&#27530;&#30340;&#21333;&#22788;&#29702;&#22120;&#19978;&#20351;&#29992;NUMA&#65292;&#36825;&#20123;&#31995;&#32479;&#30340;&#29289;&#29702;&#22320;&#22336;&#31354;&#38388;&#20013;&#25317;&#26377;&#24040;&#22823;&#30340;"&#27934;"&#12290;&#20869;&#26680;&#36890;&#36807;&#23558;&#26377;&#25928;&#29289;&#29702;&#22320;&#22336;&#30340;&#36830;&#32493;&#38468;&#23646;&#21306;&#22495;&#20998;&#37197;&#32473;&#19981;&#21516;&#30340;&#20869;&#23384;&#20960;&#28857;&#26469;&#22788;&#29702;&#36825;&#20123;&#20307;&#31995;&#32467;&#26500;&#12290;
</p><p>
&#27599;&#20010;&#33410;&#28857;&#20013;&#30340;&#29289;&#29702;&#20869;&#23384;&#21448;&#21487;&#20197;&#20998;&#20026;&#20960;&#20010;&#31649;&#29702;&#21306;(Zone)&#12290;&#27599;&#20010;&#33410;&#28857;&#37117;&#26377;&#19968;&#20010;&#31867;&#22411;&#20026;pg_data_t&#30340;&#25551;&#36848;&#31526;&#12290;&#23545;&#20110;UMA&#27169;&#24335;&#26469;&#35828;&#65292;&#31995;&#32479;&#20013;&#21482;&#38656;&#35201;&#25551;&#36848;&#31526;&#26469;&#23450;&#20041;&#19968;&#20010;&#33410;&#28857;&#65292;&#23427;&#34987;&#23450;&#20041;&#22312;mm/page_allloc.c&#20013;&#65292;&#21517;&#20026;contig_page_data&#12290;
</p><pre class="programlisting">
#ifndef CONFIG_NEED_MULTIPLE_NODES
struct pglist_data __refdata contig_page_data = { .bdata = &amp;bootmem_node_data[0] };
EXPORT_SYMBOL(contig_page_data);
#endif
</pre><p>
&#23545;&#20110;NUMA&#26469;&#35828;&#65292;Linux&#22312;arch/arm/mm/discontig.c&#20013;&#23450;&#20041;&#20102;&#19968;&#20010;&#21517;&#20026;discontig_node_data&#30340;&#25968;&#32452;&#12290;contig_page_data&#21644;discontig_node_data&#22343;&#34987;EXPORT_SYMBOL&#20986;&#26469;&#65292;&#20316;&#20026;&#20840;&#23616;&#21464;&#37327;&#20351;&#29992;&#12290;&#21478;&#22806;&#27880;&#24847;&#21040;contig_page_data&#21644;discontig_node_data&#22312;&#34987;&#23450;&#20041;&#26102;&#37117;&#26159;&#25351;&#23450;&#20102;&#25104;&#21592;bdata&#30340;&#20540;&#12290;pg_data_t&#32467;&#26500;&#20307;&#20013;&#30340;struct bootmem_data&#31867;&#22411;&#25104;&#21592;bdata&#34987;&#29992;&#26469;&#22312;&#31995;&#32479;&#21551;&#21160;&#26102;&#36890;&#36807;bitmap&#31649;&#29702;&#35813;&#33410;&#28857;&#20195;&#34920;&#30340;&#20869;&#23384;&#12290;
</p><pre class="programlisting">
pg_data_t discontig_node_data[MAX_NUMNODES] = {
  { .bdata = &amp;bootmem_node_data[0] },
  { .bdata = &amp;bootmem_node_data[1] },
  { .bdata = &amp;bootmem_node_data[2] },
  { .bdata = &amp;bootmem_node_data[3] },
  ......
</pre><p>
</p>
</div>
<div class="sect2" title="10.4. Debug&#26426;&#21046;"><div class="titlepage"><div><div><h3 class="title"><a name="idp80796540"></a>10.4. Debug&#26426;&#21046;</h3></div></div></div>
bootmem.c&#20013;&#23450;&#20041;&#20102;bootmem_debug&#65292;&#23558;&#20854;&#32622;1&#65292;&#21017;&#21487;&#20197;&#26597;&#30475;Linux&#22312;&#20351;&#29992;bootmem&#26426;&#21046;&#26102;&#36755;&#20986;&#30340;&#20449;&#24687;&#12290;
<pre class="programlisting">
mm/bootmem.c

static int bootmem_debug = 1;
</pre>
bootmem.c&#20013;&#25552;&#20379;&#20102;&#19968;&#20010;&#21517;&#20026;bootmem_debug_setup&#30340;&#20989;&#25968;&#65292;&#23427;&#34987;&#29992;&#26469;&#22312;&#31995;&#32479;&#24341;&#23548;&#26399;&#38388;&#35299;&#26512;Bootloader&#20256;&#36882;&#26469;&#30340;&#21442;&#25968;&#34892;&#65292;&#22914;&#26524;&#25552;&#20379;&#20102;bootmem_debug=1&#65292;&#37027;&#20040;&#36825;&#37324;&#30340;bootmem_debug&#24320;&#20851;&#23558;&#34987;&#32622;&#20026;1&#12290;
<pre class="programlisting">
static int __init bootmem_debug_setup(char *buf)
{
	bootmem_debug = 1;
	return 0;
}
early_param("bootmem_debug", bootmem_debug_setup);
</pre>
&#22914;&#26524;&#24320;&#21551;bootmem_debug&#65292;Bootloader&#20013;&#30340;bootargs&#21442;&#25968;&#30475;&#36215;&#26469;&#24212;&#35813;&#22914;&#19979;&#25152;&#31034;&#65306;
<pre class="programlisting">
bootargs=mem=64M console=ttyS1,115200n8 root=/dev/ram0 rw initrd=0xc1180000,4M bootmem_debug=1
</pre>
</div>
<div class="sect2" title="10.5. &#21021;&#22987;&#21270;&#20989;&#25968;"><div class="titlepage"><div><div><h3 class="title"><a name="idp80798716"></a>10.5. &#21021;&#22987;&#21270;&#20989;&#25968;</h3></div></div></div>
init_bootmem_core&#26159;bootmem&#26426;&#21046;&#20013;&#30340;&#26680;&#24515;&#20989;&#25968;&#65292;&#22914;&#26524;&#38656;&#35201;&#20351;&#29992;bootmem&#26426;&#21046;&#26469;&#31649;&#29702;&#20869;&#23384;&#65292;&#37027;&#20040;&#39318;&#20808;&#38656;&#35201;&#20351;&#29992;&#35813;&#20989;&#25968;&#26469;&#24314;&#31435;Bootmem allocator&#65292;&#24182;&#21021;&#22987;&#21270;&#20301;&#22270;&#12290;&#24182;&#19988;&#35813;&#20989;&#25968;&#21482;&#22312;&#21021;&#22987;&#21270;&#26102;&#20351;&#29992;&#12290;
<pre class="programlisting">
static unsigned long __init init_bootmem_core(bootmem_data_t *bdata,
	unsigned long mapstart, unsigned long start, unsigned long end);
</pre>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">bdata&#23384;&#25918;&#21021;&#22987;&#21270;&#21518;&#30340;&#20301;&#22270;&#20449;&#24687;&#12290;</li><li class="listitem">mapstart&#25351;&#26126;&#20301;&#22270;&#25152;&#35201;&#23384;&#25918;&#30340;&#29289;&#29702;&#39029;&#26694;&#12290;</li><li class="listitem">start&#21644;end&#25351;&#26126;&#35813;&#20998;&#37197;&#22120;&#25152;&#35201;&#31649;&#29702;&#30340;&#29289;&#29702;&#20869;&#23384;&#30340;&#36215;&#27490;&#39029;&#26694;&#12290;</li></ul></div>
init_bootmem_core&#23436;&#25104;&#20102;&#20197;&#19979;&#24037;&#20316;&#65306;
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">&#26681;&#25454;mapstart&#25351;&#23450;&#30340;&#29289;&#29702;&#39029;&#26694;&#65292;&#35745;&#31639;bdata&#20013;&#30340;node_bootmem_map&#25152;&#24212;&#35813;&#23545;&#24212;&#30340;&#34394;&#25311;&#22320;&#22336;&#12290;&#39318;&#20808;&#23558;mapstart&#29289;&#29702;&#39029;&#26694;&#36890;&#36807;PFN_PHYS&#36716;&#25442;&#20026;&#23545;&#24212;&#30340;&#29289;&#29702;&#22320;&#22336;&#65292;&#28982;&#21518;&#36890;&#36807;phys_to_virt&#36716;&#25442;&#20026;&#34394;&#25311;&#22320;&#22336;&#12290;</li><li class="listitem">bdata&#20013;&#30340;node_min_pfn&#21644;node_low_pfn&#34987;&#20998;&#21035;&#36171;&#20540;&#20026;start&#21644;end&#12290;&#23427;&#20204;&#35760;&#24405;&#20102;&#24403;&#21069;bdata&#21487;&#20197;&#31649;&#29702;&#30340;&#29289;&#29702;&#20869;&#23384;&#33539;&#22260;&#30340;&#36215;&#27490;&#39029;&#26694;&#12290;</li><li class="listitem">&#20351;&#29992;link_bootmem&#20989;&#25968;&#23558;bdata&#25346;&#36733;&#21040;bdata_list&#20840;&#23616;&#21464;&#37327;&#20013;&#65292;Linux&#20013;&#25152;&#26377;&#30340;bdata&#37117;&#34987;&#38142;&#20837;bdata_list&#36827;&#34892;&#32479;&#19968;&#31649;&#29702;&#12290;&#38142;&#20837;&#26102;&#23558;&#26681;&#25454;node_min_pfn&#30340;&#20540;&#26469;&#30830;&#23450;&#25346;&#36733;&#28857;&#12290;&#25972;&#20010;&#38142;&#34920;&#20013;&#30340;bdata&#33410;&#28857;&#20869;node_min_pfn&#24635;&#26159;&#20174;&#23567;&#21040;&#22823;&#25490;&#21015;&#30340;&#12290;</li><li class="listitem">&#26368;&#21518;&#29289;&#29702;&#39029;&#26694;&#23545;&#24212;&#30340;bitmap&#65292;&#20063;&#21363;node_bootmem_map&#25351;&#21521;&#30340;&#22320;&#22336;&#65292;&#22823;&#23567;&#20026;bitmap&#22823;&#23567;&#30340;&#21306;&#22495;&#20840;&#37096;&#32622;&#20026;0xff&#65292;&#20063;&#21363;&#20840;&#37096;&#20445;&#30041;&#12290;bitmap&#22823;&#23567;&#30001;bootmap_bytes&#35745;&#31639;&#20986;&#65292;&#20854;&#20013;&#20250;&#32771;&#34385;&#21040;&#23383;&#33410;&#22278;&#25972;&#65292;&#36890;&#24120;&#30340;&#20844;&#24335;&#20026;(pages + 7) / 8&#65292;&#21478;&#22806;&#35201;&#20445;&#35777;&#23545;&#40784;&#21040;32&#12290;&#23545;&#20110;256M&#30340;&#20869;&#23384;&#26469;&#35828;&#65292;&#27491;&#22909;&#26159;0x2000&#12290;</li></ul></div>
&#23545;&#20110;&#19968;&#20010;&#20351;&#29992;UMA&#26426;&#21046;&#65292;&#29289;&#29702;&#20869;&#23384;&#20026;256Mb&#65292;&#19988;&#29289;&#29702;&#20869;&#23384;&#25152;&#22312;&#36215;&#22987;&#22320;&#22336;&#20026;0x50000000&#30340;&#31995;&#32479;&#65292;init_bootmem_core&#23558;&#25171;&#21360;&#20197;&#19979;&#20449;&#24687;&#65306;
<pre class="programlisting">
bootmem::init_bootmem_core nid=0 start=50000 map=5053c end=60000 mapsize=2000
</pre>
nid=0&#65292;&#25351;&#26126;&#24403;&#21069;&#25805;&#20316;&#30340;bdata&#23545;&#24212;&#21040;bootmem_node_data&#30340;&#25968;&#32452;&#32034;&#24341;&#65292;start=50000&#65292;&#21363;&#20026;0x50000000&#23545;&#24212;&#30340;&#29289;&#29702;&#39029;&#26694;&#12290;
<div class="figure"><a name="idp80803692"></a><p class="title"><b>&#22270; 55. &#21021;&#22987;&#21270;&#21518;&#30340;&#20301;&#22270;</b></p><div class="figure-contents"><div><img src="images/bitmap0.gif" alt="&#21021;&#22987;&#21270;&#21518;&#30340;&#20301;&#22270;"></div></div></div><br class="figure-break">
<p>
&#20026;&#20102;&#38024;&#23545;&#29305;&#23450;&#30340;&#20869;&#23384;&#33410;&#28857;&#24212;&#29992;Bootmem&#26426;&#21046;&#65292;bootmem.c&#20013;&#22312;init_bootmem_core&#30340;&#22522;&#30784;&#19978;&#23553;&#35013;&#20102;&#38024;&#23545;&#29305;&#23450;&#33410;&#28857;&#25805;&#20316;&#30340;init_bootmem_node&#20989;&#25968;&#12290;&#21478;&#22806;&#36824;&#26377;&#38024;&#23545;&#40664;&#35748;&#33410;&#28857;&#25805;&#20316;&#30340;init_bootmem&#20989;&#25968;&#65292;&#23427;&#20204;&#30340;&#35843;&#29992;&#20851;&#31995;&#22914;&#22270;&#25152;&#31034;&#65306;
</p><div class="figure"><a name="idp80804724"></a><p class="title"><b>&#22270; 56. &#21021;&#22987;&#21270;&#20989;&#25968;&#35843;&#29992;</b></p><div class="figure-contents"><div><img src="images/bootmem_init.gif" alt="&#21021;&#22987;&#21270;&#20989;&#25968;&#35843;&#29992;"></div></div></div><p><br class="figure-break">
</p><pre class="programlisting">
unsigned long __init init_bootmem_node(pg_data_t *pgdat, unsigned long freepfn,
				unsigned long startpfn, unsigned long endpfn)
{
	return init_bootmem_core(pgdat-&gt;bdata, freepfn, startpfn, endpfn);
}
</pre><p>
&#27880;&#24847;&#21040;init_bootmem_node&#30340;&#31532;&#19968;&#20010;&#21442;&#25968;&#20026;pg_data_t&#31867;&#22411;&#12290;init_bootmem&#21482;&#38656;&#35201;&#20004;&#20010;&#21442;&#25968;&#65292;bitmap&#30340;&#29289;&#29702;&#39029;&#26694;&#22320;&#22336;start&#21644;&#29289;&#29702;&#39029;&#38754;&#25968;pages&#12290;NODE_DATA&#30340;&#20316;&#29992;&#23601;&#26159;&#21462;contig_page_data&#33410;&#28857;&#65292;&#32780;&#36825;&#37324;&#30340;&#25152;&#22788;&#29702;&#30340;&#29289;&#29702;&#39029;&#26694;&#36215;&#22987;&#22320;&#22336;&#27704;&#36828;&#20026;0&#12290;
</p><pre class="programlisting">
include/linux/mmzone.h
#define NODE_DATA(nid)          (&amp;contig_page_data)

unsigned long __init init_bootmem(unsigned long start, unsigned long pages)
{
	max_low_pfn = pages;
	min_low_pfn = start;
	return init_bootmem_core(NODE_DATA(0)-&gt;bdata, start, 0, pages);
}
</pre><p>
&#36890;&#24120;&#22312;&#31995;&#32479;&#24341;&#23548;&#30340;&#26102;&#20505;&#35843;&#29992;init_bootmem_node&#26469;&#38024;&#23545;&#29305;&#23450;&#30340;&#33410;&#28857;&#21021;&#22987;&#21270;bootmem&#65292;&#32780;&#19981;&#26159;&#30452;&#25509;&#35843;&#29992;init_bootmem&#65292;&#36825;&#26159;&#22240;&#20026;&#24456;&#23569;&#26377;&#29289;&#29702;&#22320;&#22336;&#20174;0&#24320;&#22987;&#65292;&#23427;&#26159;&#30001;CPU&#30340;&#29289;&#29702;&#22320;&#22336;&#20998;&#37197;&#20915;&#23450;&#30340;&#65292;&#36890;&#24120;RAM&#21344;&#29992;&#30340;&#29289;&#29702;&#22320;&#22336;&#31354;&#38388;&#24635;&#26159;&#26377;&#19968;&#23450;&#30340;&#20559;&#31227;&#65292;&#27604;&#22914;0x50000000&#12290;
</p>
</div>
<div class="sect2" title="10.6. __reserve&#21644;__free"><div class="titlepage"><div><div><h3 class="title"><a name="idp80807204"></a>10.6. __reserve&#21644;__free</h3></div></div></div>
<p>
&#19981;&#31649;&#26159;&#20309;&#31181;&#20869;&#23384;&#31649;&#29702;&#26041;&#24335;&#65292;&#26368;&#22522;&#26412;&#30340;&#21151;&#33021;&#23601;&#26159;&#20869;&#23384;&#30340;&#20998;&#21457;&#21644;&#22238;&#25910;&#65292;&#27604;&#22914;malloc&#21644;free&#12290;&#22312;bootmem&#26426;&#21046;&#20013;&#34987;&#31216;&#20026;__reserve&#21644;__free&#65292;&#20998;&#21035;&#23545;&#24212;bitmap&#20013;&#30340;&#27604;&#29305;&#20301;&#30340;&#29366;&#24577;1&#21644;0&#12290;&#25152;&#20197;__reserve&#30340;&#20316;&#29992;&#23601;&#26159;&#23558;&#23545;&#24212;&#30340;&#29289;&#29702;&#39029;&#26694;&#30340;&#27604;&#29305;&#20301;&#32622;&#20026;1&#65292;&#30456;&#24403;&#20110;malloc&#12290;
</p><pre class="programlisting">
static int __init __reserve(bootmem_data_t *bdata, unsigned long sidx,
			unsigned long eidx, int flags);
</pre><p>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">bdata&#25351;&#26126;&#24403;&#21069;&#30340;&#20445;&#30041;&#25805;&#20316;&#20316;&#29992;&#22312;&#21738;&#20010;bootmem_data&#21306;&#12290;</li><li class="listitem">sidx&#21644;eidx&#20195;&#34920;&#30340;&#26159;&#38656;&#35201;&#39044;&#30041;&#30340;&#29289;&#29702;&#39029;&#26694;&#23545;&#24212;&#30340;bit&#20301;&#22312;bdata&#20013;&#30340;node_min_pfn&#30340;&#32034;&#24341;&#20540;&#12290;</li><li class="listitem">flags&#26631;&#24535;&#65292;&#24403;&#21069;&#21482;&#25903;&#25345;BOOTMEM_DEFAULT&#21644;BOOTMEM_EXCLUSIVE&#12290;BOOTMEM_EXCLUSIVE&#21487;&#20197;&#20445;&#35777;&#22312;&#23558;&#35201;&#20445;&#30041;&#30340;&#25972;&#20010;&#39029;&#26694;&#20013;&#37117;&#26159;&#21487;&#20197;&#20351;&#29992;&#30340;&#65292;&#20063;&#21363;&#36825;&#20123;&#39029;&#26694;&#23545;&#24212;&#30340;bitmap&#36830;&#32493;&#20026;0&#65292;&#21542;&#21017;&#36935;&#21040;&#24050;&#20445;&#30041;&#30340;&#39029;&#26694;&#65292;&#23558;&#37322;&#25918;&#24050;&#32463;&#33719;&#21462;&#30340;&#39029;&#26694;&#65292;&#24182;&#36820;&#22238;EBUSY&#12290;BOOTMEM_DEFAULT&#21017;&#19981;&#32771;&#34385;&#36825;&#19968;&#24773;&#20917;&#12290;</li></ul></div><p>
__reserve&#35843;&#29992;test_and_set_bit&#26469;&#35774;&#32622;&#36825;&#19968;&#21306;&#22495;&#20013;&#30340;&#27604;&#29305;&#20301;&#65292;&#27880;&#24847;&#21306;&#22495;&#33539;&#22260;&#20026;[sidx + bdata-&gt;node_min_pfn&#65292; eidx + bdata-&gt;node_min_pfn)&#12290;
</p>
<p>
</p><pre class="programlisting">
static void __init __free(bootmem_data_t *bdata,
			unsigned long sidx, unsigned long eidx);
</pre><p>
__free&#20989;&#25968;&#22312;bootmeme&#26426;&#21046;&#20013;&#30456;&#24403;&#20110;&#36890;&#24120;&#20351;&#29992;&#30340;free&#20989;&#25968;&#12290;&#19982;__reserve&#30456;&#20284;&#65292;&#20294;&#26159;&#23427;&#35843;&#29992;test_and_clear_bit&#23545;&#38656;&#35201;&#37322;&#25918;&#30340;&#39029;&#26694;&#21306;&#23545;&#24212;&#30340;&#20301;&#22270;&#36827;&#34892;&#28165;&#38646;&#65292;&#22914;&#26524;&#22312;&#28165;&#38646;&#36807;&#31243;&#20013;&#21457;&#29616;&#35813;&#20989;&#25968;&#36820;&#22238;0&#65292;&#35828;&#26126;&#35813;&#21306;&#22495;&#20013;&#30340;&#27604;&#29305;&#20301;&#26377;&#24322;&#24120;&#32763;&#36716;&#65292;&#35843;&#29992;BUG()&#25243;&#20986;&#24182;&#23558;&#31995;&#32479;&#25346;&#36215;&#12290;&#23427;&#30340;&#20316;&#29992;&#21306;&#22495;&#19982;__reserve&#19968;&#33268;&#12290;
</p>
<p>
&#27880;&#24847;&#65306;test_and_set_bit(0, start_addr)&#20013;&#65292;"0"&#19981;&#26159;&#35201;&#35774;&#32622;&#30340;&#20540;&#65292;&#32780;&#26159;&#34920;&#31034;start_addr&#20013;&#31532;0&#20301;&#38656;&#35201;&#34987;&#35774;&#32622;&#20026;"1"&#12290;&#27492;&#20989;&#25968;&#36820;&#22238;&#30456;&#24212;&#27604;&#29305;&#20301;&#19978;&#19968;&#27425;&#34987;&#35774;&#32622;&#30340;&#20540;&#12290;test_and_clear_bit&#19982;&#27492;&#30456;&#21516;&#12290;
</p>
</div>
<div class="sect2" title="10.7. alloc_bootmem_core"><div class="titlepage"><div><div><h3 class="title"><a name="idp80808276"></a>10.7. alloc_bootmem_core</h3></div></div></div>
<p>
alloc_bootmem_core&#26159;&#20351;&#29992;bitmap&#20998;&#37197;&#20869;&#23384;&#31354;&#38388;&#30340;&#26680;&#24515;&#25509;&#21475;&#12290;
</p><pre class="programlisting">
static void * __init alloc_bootmem_core(struct bootmem_data *bdata,
				unsigned long size, unsigned long align,
				unsigned long goal, unsigned long limit);
</pre><p>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">bdata&#25351;&#26126;&#24403;&#21069;&#30340;&#20869;&#23384;&#30003;&#35831;&#25805;&#20316;&#20316;&#29992;&#22312;&#21738;&#20010;bootmem_data&#21306;&#12290;</li><li class="listitem">size&#25351;&#26126;&#25152;&#35201;&#30003;&#35831;&#30340;&#20869;&#23384;&#31354;&#38388;&#22823;&#23567;&#65292;&#23427;&#30340;&#21333;&#20301;&#26159;bytes&#12290;</li><li class="listitem">align&#25351;&#26126;&#30003;&#35831;&#30340;&#20869;&#23384;&#31354;&#38388;&#30340;&#36793;&#30028;&#22823;&#23567;&#65292;&#36890;&#24120;&#20026;32&#65292;PAGE_SIZE(4K)&#31561;&#12290;</li><li class="listitem">goal&#20195;&#34920;&#20174;bdata&#20013;node_min_pfn&#25628;&#32034;&#31354;&#38386;&#20869;&#23384;&#30340;&#24320;&#22987;&#22320;&#22336;&#65292;&#22914;&#26524;&#20026;0&#65292;&#21017;&#40664;&#35748;&#20174;node_min_pfn&#24320;&#22987;&#12290;goal&#24212;&#35813;&#20301;&#20110;node_min_pfn&#21644;node_low_pfn&#25152;&#23545;&#24212;&#30340;&#39029;&#26694;&#25152;&#20195;&#34920;&#30340;&#22320;&#22336;&#20043;&#38388;&#65292;&#21542;&#21017;&#25353;0&#22788;&#29702;&#12290;</li><li class="listitem">limit&#20195;&#34920;&#20174;bdata&#20013;node_min_pfn&#25628;&#32034;&#31354;&#38386;&#20869;&#23384;&#30340;&#32456;&#28857;&#22320;&#22336;&#65292;&#22914;&#26524;&#20026;0&#65292;&#21017;&#25628;&#32034;&#21040;node_low_pfn&#32467;&#26463;&#12290;</li></ul></div><p>	
alloc_bootmem_core&#23581;&#35797;&#22312;goal&#21644;limit&#25351;&#23450;&#30340;&#34394;&#25311;&#22320;&#22336;&#33539;&#22260;[goal/node_min_pfn&#65292;limit/node_low_pfn]&#20013;&#20998;&#37197;size&#23383;&#33410;&#30340;&#20869;&#23384;&#65292;&#24182;&#19988;&#33719;&#21462;&#30340;&#20869;&#23384;&#19982;align&#23545;&#40784;&#65306;
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">&#39318;&#20808;&#26816;&#26597;&#21442;&#25968;&#30340;&#21512;&#27861;&#24615;&#12290;size&#19981;&#21487;&#20026;0&#65307;align&#24517;&#39035;&#20026;2&#30340;&#25972;&#25968;&#20493;&#65307;&#22914;&#26524;limit&#19981;&#20026;0&#65292;&#37027;&#20040;&#38656;&#28385;&#36275;goal + size &lt; limit&#12290;</li><li class="listitem">&#26681;&#25454;bdata&#20013;&#25552;&#20379;&#30340;node_min_pfn&#21644;node_low_pfn&#65292;&#20197;&#21450;goal&#21644;limit&#30340;&#20540;&#30830;&#23450;&#38656;&#35201;&#25628;&#32034;&#30340;&#29289;&#29702;&#39029;&#26694;&#33539;&#22260;&#12290;&#26368;&#22823;&#39029;&#26694;max&#30001;node_low_pfn&#21644;limit&#20849;&#21516;&#30830;&#23450;&#65292;&#22914;&#26524;limit&#19981;&#20026;0&#65292;&#21017;&#21462;&#26368;&#23567;&#32773;&#12290;&#26368;&#23567;&#39029;&#26694;min&#21462;node_min_pfn&#21644;goal&#20013;&#26368;&#22823;&#20540;&#65292;&#24182;&#19988;&#23545;&#40784;&#21040;align&#21442;&#25968;&#20915;&#23450;&#30340;step&#12290;</li><li class="listitem">&#26681;&#25454;&#20844;&#24335;step = max(align &gt;&gt; PAGE_SHIFT, 1UL)&#24471;&#21040;&#27493;&#36827;&#22823;&#23567;&#12290;&#21491;&#31227;PAGE_SHIFT&#29992;&#26469;&#35745;&#31639;align&#30456;&#23545;&#20110;PAGE_SIZE&#30340;&#20493;&#25968;&#12290;step&#21442;&#25968;&#29992;&#26469;&#22312;&#25628;&#32034;&#22833;&#36133;&#30340;&#24773;&#20917;&#19979;&#65292;&#25628;&#32034;&#19979;&#19968;&#39029;&#26694;&#26102;&#22686;&#21152;&#30340;&#39029;&#26694;&#25968;&#30446;&#65306;&#27493;&#36827;&#22823;&#23567;&#20026;1&#65292;&#21017;&#24403;bitmap&#20013;bit i&#20026;&#21344;&#29992;&#29366;&#24577;&#26102;&#25628;&#32034;bit i + 1&#30340;&#29366;&#24577;&#65292;&#27493;&#36827;&#22823;&#23567;&#20026;2&#21017;&#24403;bitmap&#20013;&#19968;&#20010;bit i&#20026;&#21344;&#29992;&#29366;&#24577;&#26102;&#25628;&#32034;bit i + 2&#30340;&#29366;&#24577;&#12290;</li><li class="listitem">&#27604;&#36739;&#36215;&#28857;&#21644;&#19978;&#19968;&#27425;&#25628;&#32034;&#32467;&#26463;&#30340;&#20301;&#32622;,&#20174;&#36739;&#23567;&#30340;&#20301;&#32622;&#24320;&#22987;&#25628;&#32034;,&#22914;&#20174;&#19978;&#19968;&#27425;&#25628;&#32034;&#32467;&#26463;&#30340;&#20301;&#32622;&#24320;&#22987;&#25628;&#32034;,&#21017;&#35774;&#32622;&#22238;&#28378;&#26631;&#35782;,&#22914;&#21040;&#32456;&#28857;&#36824;&#25214;&#19981;&#21040;&#21512;&#36866;&#30340;&#31354;&#38388;&#21017;&#20174;&#20043;&#21069;&#30340;&#36215;&#28857;&#24320;&#22987;&#36827;&#34892;&#25628;&#32034;&#12290;</li><li class="listitem">&#26681;&#25454;&#25628;&#32034;&#30340;&#21306;&#22495;&#21644;&#30003;&#35831;&#30340;&#20869;&#23384;&#22823;&#23567;&#65292;&#36890;&#36807;find_next_zero_bit&#20989;&#25968;&#26469;&#26597;&#25214;&#19968;&#20010;&#36830;&#32493;&#30340;&#24182;&#28385;&#36275;size&#35201;&#27714;&#30340;&#31354;&#38386;&#20869;&#23384;&#22359;&#12290;&#22914;&#26524;&#26377;&#36275;&#22815;&#30340;&#31354;&#38386;bit&#21017;&#23558;&#36825;&#20123;bit&#35774;&#20026;&#21344;&#29992;&#29366;&#24577;&#65292;&#24182;&#28165;&#31354;bit&#25152;&#23545;&#24212;&#30340;&#31354;&#38388;&#30340;&#25968;&#25454;&#65292;&#36820;&#22238;&#31354;&#38386;&#31354;&#38388;&#30340;&#36215;&#22987;&#22320;&#22336;&#12290;</li><li class="listitem">&#26356;&#26032;last_end_off&#21644;hint_idx&#65292;&#20197;&#22791;&#19979;&#27425;&#30003;&#35831;&#20869;&#23384;&#26102;&#24555;&#36895;&#23450;&#20301;&#31354;&#38386;&#30340;&#20869;&#23384;&#21306;&#12290;&#20854;&#20013;last_end_off&#35760;&#24405;&#20102;&#19978;&#27425;&#30003;&#35831;&#30340;&#31354;&#38388;&#21518;&#30340;&#31532;&#19968;&#20010;&#30456;&#23545;&#20110;0&#20559;&#31227;&#30340;&#29289;&#29702;&#22320;&#22336;&#65292;&#25152;&#20197;&#26412;&#27425;&#30003;&#35831;&#30340;&#20869;&#23384;&#24635;&#26159;&#32039;&#37051;&#27492;&#21518;&#30340;&#24182;&#28385;&#36275;goal&#21644;align&#35201;&#27714;&#30340;&#20869;&#23384;&#12290;</li><li class="listitem">&#20989;&#25968;&#25191;&#34892;&#25104;&#21151;&#21017;&#36890;&#36807;__reserve&#21450;BOOTMEM_EXCLUSIVE&#26631;&#24535;&#39044;&#30041;&#23545;&#24212;&#30340;bitmap&#65292;memset&#32622;&#35813;&#21306;&#22495;&#20026;0&#65292;&#24182;&#36820;&#22238;&#30003;&#35831;&#21040;&#30340;&#20869;&#23384;&#30340;&#34394;&#25311;&#22320;&#22336;&#65292;&#21542;&#21017;&#36820;&#22238;NULL&#12290;</li></ul></div><p>
bootmem.c&#20013;&#23545;alloc_bootmem_core&#36827;&#34892;&#20102;&#19968;&#31995;&#21015;&#30340;&#25193;&#23637;&#20197;&#23436;&#25104;&#20016;&#23500;&#30340;&#21151;&#33021;&#12290;
</p><div class="figure"><a name="idp80818364"></a><p class="title"><b>&#22270; 57. alloc_bootmem_core&#35843;&#29992;</b></p><div class="figure-contents"><div><img src="images/bootmem_calls.gif" alt="alloc_bootmem_core&#35843;&#29992;"></div></div></div><p><br class="figure-break">
</p><p>bootmem&#26426;&#21046;&#20013;&#25552;&#20379;&#30340;__alloc_bootmem_node&#21644;__alloc_bootmem_low_node&#20989;&#25968;&#34987;&#29992;&#26469;&#38024;&#23545;&#29305;&#23450;&#30340;&#33410;&#28857;&#36827;&#34892;&#20869;&#23384;&#31649;&#29702;&#12290;&#23427;&#20204;&#22343;&#36890;&#36807;&#35843;&#29992;___alloc_bootmem_node&#26469;&#23454;&#29616;&#12290;&#23427;&#20204;&#30340;&#31532;&#19968;&#20010;&#21442;&#25968;&#22343;&#20026;pg_data_t&#31867;&#22411;&#12290;
</p><pre class="programlisting">
void * __init __alloc_bootmem_node(pg_data_t *pgdat, unsigned long size,
				   unsigned long align, unsigned long goal)
{
	return ___alloc_bootmem_node(pgdat-&gt;bdata, size, align, goal, 0);
}
</pre><p>
__alloc_bootmem_low_node&#21644;__alloc_bootmem_node&#31867;&#20284;&#65292;&#21807;&#19968;&#21306;&#21035;&#22312;&#20110;limit&#21442;&#25968;&#12290;ARCH_LOW_ADDRESS_LIMIT&#21482;&#22312;&#29305;&#23450;&#30340;&#20307;&#31995;&#26550;&#26500;&#19978;&#36215;&#20316;&#29992;&#65292;&#20063;&#21363;&#30003;&#35831;&#30340;&#20869;&#23384;&#34987;&#38480;&#21046;&#22312;ARCH_LOW_ADDRESS_LIMIT&#20043;&#19979;&#30340;&#20869;&#23384;&#20013;&#12290;&#36890;&#24120;&#23427;&#34987;&#23450;&#20041;&#20026;0xffffffffUL&#65292;&#20063;&#21363;&#26159;32&#20301;&#31995;&#32479;&#21487;&#20197;&#25903;&#25345;&#30340;&#26368;&#22823;&#34394;&#25311;&#22320;&#22336;&#65292;&#27492;&#26102;&#23427;&#30340;&#20316;&#29992;&#19982;0&#21442;&#25968;&#30456;&#21516;&#12290;
</p><pre class="programlisting">
void * __init __alloc_bootmem_low_node(pg_data_t *pgdat, unsigned long size,
				       unsigned long align, unsigned long goal)
{
	return ___alloc_bootmem_node(pgdat-&gt;bdata, size, align,
				goal, ARCH_LOW_ADDRESS_LIMIT);
}
</pre><p>
___alloc_bootmem_node&#22312;&#33410;&#28857;&#20869;&#23384;&#20998;&#37197;&#20013;&#26159;&#19968;&#20010;&#20851;&#38190;&#30340;&#20989;&#25968;&#12290;
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">&#39318;&#20808;&#36890;&#36807;alloc_bootmem_core&#22312;&#32473;&#23450;&#30340;&#33410;&#28857;&#20013;&#36827;&#34892;&#20869;&#23384;&#20998;&#37197;&#12290;</li><li class="listitem">&#22914;&#26524;&#20998;&#37197;&#22833;&#36133;&#65292;&#21017;&#35843;&#29992;___alloc_bootmem&#23581;&#35797;&#22312;bdata_list&#38142;&#34920;&#20013;&#30340;&#25152;&#26377;bdata&#20013;&#20998;&#37197;&#20869;&#23384;&#12290;</li></ul></div><p>
___alloc_bootmem_nopanic&#26159;&#19968;&#20010;&#36890;&#29992;&#30340;&#65292;&#19968;&#20010;&#29992;&#26469;&#23613;&#21147;&#32780;&#20026;&#20998;&#37197;&#20869;&#23384;&#30340;&#20989;&#25968;&#65292;&#23427;&#36890;&#36807;list_for_each_entry&#22312;&#20840;&#23616;&#38142;&#34920;bdata_list&#20013;&#20998;&#37197;&#20869;&#23384;&#12290;___alloc_bootmem&#21644;___alloc_bootmem_nopanic&#31867;&#20284;&#65292;&#23427;&#39318;&#20808;&#36890;&#36807;___alloc_bootmem_nopanic&#20989;&#25968;&#20998;&#37197;&#20869;&#23384;&#65292;&#20294;&#26159;&#19968;&#26086;&#20869;&#23384;&#20998;&#37197;&#22833;&#36133;&#65292;&#31995;&#32479;&#23558;&#36890;&#36807;panic("Out of memory")&#25243;&#20986;&#20449;&#24687;&#65292;&#24182;&#20572;&#27490;&#36816;&#34892;&#12290;
</p><p>
___alloc_bootmem_nopanic&#23613;&#31649;&#36890;&#36807;alloc_bootmem_core&#26469;&#23454;&#29616;&#65292;&#23427;&#21644;alloc_bootmem_core&#21487;&#20197;&#30475;&#20316;&#24037;&#20316;&#22312;&#21516;&#19968;&#23618;&#27425;&#19978;&#12290;alloc_bootmem_core&#24037;&#20316;&#20110;&#29305;&#23450;&#30340;bdata&#12290;&#32780;___alloc_bootmem_nopanic&#21017;&#26159;&#24037;&#20316;&#22312;bdata_list&#38142;&#34920;&#20013;&#30340;&#25152;&#26377;bdata&#12290;
</p>
</div>
<div class="sect2" title="10.8. Bootmem alloc&#23439;"><div class="titlepage"><div><div><h3 class="title"><a name="idp80822636"></a>10.8. Bootmem alloc&#23439;</h3></div></div></div>
<p>&#23613;&#31649;bootmem.c&#20013;&#25552;&#20379;&#20102;&#19968;&#20123;&#20102;&#30340;&#20869;&#23384;&#20998;&#37197;&#20989;&#25968;&#65292;&#20294;&#26159;&#29305;&#23450;&#20110;&#26576;&#20010;&#20307;&#31995;&#26550;&#26500;&#30340;&#20195;&#30721;&#24182;&#27809;&#26377;&#30452;&#25509;&#35843;&#29992;&#23427;&#20204;&#65292;&#32780;&#26159;&#36890;&#36807;Linux&#25552;&#20379;&#30340;&#19968;&#31995;&#21015;&#30340;&#23439;&#12290;</p>
<p>
</p><pre class="programlisting">
include/linux/bootmem.h

#define alloc_bootmem(x) \
        __alloc_bootmem(x, SMP_CACHE_BYTES, __pa(MAX_DMA_ADDRESS))
#define alloc_bootmem_nopanic(x) \
        __alloc_bootmem_nopanic(x, SMP_CACHE_BYTES, __pa(MAX_DMA_ADDRESS))
#define alloc_bootmem_low(x) \
        __alloc_bootmem_low(x, SMP_CACHE_BYTES, 0)
#define alloc_bootmem_pages(x) \
        __alloc_bootmem(x, PAGE_SIZE, __pa(MAX_DMA_ADDRESS))
#define alloc_bootmem_pages_nopanic(x) \
        __alloc_bootmem_nopanic(x, PAGE_SIZE, __pa(MAX_DMA_ADDRESS))
#define alloc_bootmem_low_pages(x) \
        __alloc_bootmem_low(x, PAGE_SIZE, 0)
#define alloc_bootmem_node(pgdat, x) \
        __alloc_bootmem_node(pgdat, x, SMP_CACHE_BYTES, __pa(MAX_DMA_ADDRESS))
#define alloc_bootmem_pages_node(pgdat, x) \
        __alloc_bootmem_node(pgdat, x, PAGE_SIZE, __pa(MAX_DMA_ADDRESS))
#define alloc_bootmem_low_pages_node(pgdat, x) \
        __alloc_bootmem_low_node(pgdat, x, PAGE_SIZE, 0)
</pre><p>
&#19968;&#20123;&#31995;&#32479;&#24341;&#23548;&#26102;&#20351;&#29992;&#30340;&#20020;&#26102;&#32467;&#26500;&#20307;&#36890;&#24120;&#36890;&#36807;alloc_bootmem_low&#26469;&#20998;&#37197;&#20869;&#23384;&#65292;&#33719;&#21462;&#30340;&#20869;&#23384;&#30456;&#23545;&#20110;SMP_CACHE_BYTES&#23545;&#40784;&#65292;&#36890;&#24120;&#20026;32&#12290;&#22312;&#21019;&#24314;&#31995;&#32479;&#39029;&#38754;&#26426;&#21046;&#26102;&#65292;&#23558;&#20250;&#29992;&#21040;alloc_bootmem_pages&#21644;alloc_bootmem_low_pages&#65292;&#23427;&#20204;&#20998;&#37197;&#30340;&#20869;&#23384;&#30456;&#23545;&#20110;PAGE_SIZE&#23545;&#40784;&#12290;&#38024;&#23545;&#29305;&#23450;&#33410;&#28857;&#30340;&#20869;&#23384;&#20998;&#37197;&#20351;&#29992;alloc_bootmem_pages_node&#21644;alloc_bootmem_low_pages_node&#36827;&#34892;&#12290;
 </p>
</div>
<div class="sect2" title="10.9. &#26631;&#35760;&#20989;&#25968;"><div class="titlepage"><div><div><h3 class="title"><a name="idp80823788"></a>10.9. &#26631;&#35760;&#20989;&#25968;</h3></div></div></div>
<p>&#20026;&#20102;&#26041;&#20415;&#23545;bitmap&#30340;&#25805;&#20316;&#65292;bootmeme.c&#20013;&#23545;__reserve&#21644;__free&#20989;&#25968;&#21448;&#36827;&#34892;&#20102;&#36827;&#19968;&#27493;&#30340;&#23553;&#35013;&#12290;</p>
<div class="figure"><a name="idp80825916"></a><p class="title"><b>&#22270; 58. bootmem&#26631;&#35760;&#20989;&#25968;</b></p><div class="figure-contents"><div><img src="images/bootmem_mark.gif" alt="bootmem&#26631;&#35760;&#20989;&#25968;"></div></div></div><p><br class="figure-break">
&#20174;&#20989;&#25968;&#30340;&#35843;&#29992;&#20851;&#31995;&#30475;&#65292;mark_bootmem_node&#22788;&#20110;&#26631;&#35760;&#20989;&#25968;&#30340;&#26680;&#24515;&#65292;&#25152;&#26377;&#30340;&#39044;&#30041;&#21644;&#37322;&#25918;&#22343;&#26159;&#36890;&#36807;&#23427;&#26469;&#23454;&#29616;&#12290;&#23427;&#30340;&#22768;&#26126;&#22914;&#19979;&#25152;&#31034;&#65306;
</p><pre class="programlisting">
static int __init mark_bootmem_node(bootmem_data_t *bdata,
				unsigned long start, unsigned long end,
				int reserve, int flags);
</pre><p>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">bdata&#25351;&#26126;&#24403;&#21069;&#26631;&#35760;&#25805;&#20316;&#20316;&#29992;&#22312;&#21738;&#20010;bootmem_data&#21306;&#12290;</li><li class="listitem">start&#21644;end&#25351;&#26126;&#20102;&#38656;&#35201;&#26631;&#35760;&#30340;&#21306;&#22495;&#30340;&#36215;&#27490;&#29289;&#29702;&#39029;&#26694;&#12290;</li><li class="listitem">reserve&#30340;&#20540;&#21487;&#20197;&#21462;1&#21644;0&#65292;&#20998;&#21035;&#23545;&#24212;&#21040;__reserve&#21644;__free&#25805;&#20316;&#12290;</li><li class="listitem">flags&#24403;&#21069;&#21482;&#25903;&#25345;BOOTMEM_DEFAULT&#21644;BOOTMEM_EXCLUSIVE&#65292;&#21442;&#32771;&#23545;__reserve&#21644;__free&#20989;&#25968;&#30340;&#20998;&#26512;&#12290;</li></ul></div><p>
mark_bootmem_node&#23436;&#25104;&#20102;&#20197;&#19979;&#24037;&#20316;&#65306;
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">&#21028;&#26029;start&#21644;end&#30340;&#21512;&#27861;&#24615;&#65292;&#23427;&#20204;&#24212;&#35813;&#20301;&#20110;&#21442;&#25968;bdata&#25104;&#21592;node_min_pfn&#21644;node_low_pfn&#20043;&#38388;&#12290;</li><li class="listitem">&#26681;&#25454;start&#21644;end&#35745;&#31639;bitmap&#30340;&#20013;&#30340;&#36215;&#27490;&#32034;&#24341;&#12290;</li><li class="listitem">&#26681;&#25454;reserve&#21644;&#32034;&#24341;&#20540;&#35843;&#29992;__reserve&#25110;__free&#20989;&#25968;&#36827;&#34892;&#26631;&#35760;&#25805;&#20316;&#12290;</li><li class="listitem">&#25805;&#20316;&#25104;&#21151;&#36820;&#22238;0&#65292;&#21542;&#21017;&#36820;&#22238;&#38169;&#35823;&#21495;&#12290;</li></ul></div><p>
mark_bootmem&#19982;mark_bootmem_node&#30340;&#20851;&#31995;&#65292;&#31867;&#20284;&#20110;___alloc_bootmem_nopanic&#21644;alloc_bootmem_core&#30340;&#20851;&#31995;&#12290;&#23427;&#36890;&#36807;list_for_each_entry&#36941;&#21382;bdata_list&#65292;&#26681;&#25454;start&#21644;end&#26597;&#25214;&#25152;&#22312;&#30340;bdata&#65292;&#28982;&#21518;&#35843;&#29992;mark_bootmem_node&#22312;&#29305;&#23450;&#30340;bdata&#19978;&#23436;&#25104;&#26631;&#35760;&#25805;&#20316;&#12290;&#22914;&#26524;start&#21644;end&#25351;&#26126;&#30340;&#21306;&#22495;&#36328;&#36234;&#22810;&#20010;bdata&#65292;&#37027;&#20040;&#36890;&#36807;mark_bootmem&#25805;&#20316;&#26159;&#38750;&#24120;&#26041;&#20415;&#30340;&#12290;
</p>
<p>reserve_bootmem&#21644;free_bootmem&#19982;reserve_bootmem_node&#21644;free_bootmem_node&#30340;&#20851;&#31995;&#19982;mark_bootmem&#21644;mark_bootmem_node&#30340;&#20851;&#31995;&#31867;&#20284;&#12290;reserve_bootmem&#21644;free_bootmem&#35843;&#29992;mark_bootmem&#65292;&#21482;&#26159;reserve&#21442;&#25968;&#20998;&#21035;&#20026;1&#21644;0&#12290;reserve_bootmem_node&#21644;free_bootmem_node&#35843;&#29992;mark_bootmem_node&#65292;&#21516;&#26679;reserve&#21442;&#25968;&#20998;&#21035;&#20026;1&#21644;0&#12290;</p>
<p></p>
</div>
<div class="sect2" title="10.10. Bootmem&#26426;&#21046;&#30340;&#24212;&#29992;"><div class="titlepage"><div><div><h3 class="title"><a name="idp80831340"></a>10.10. Bootmem&#26426;&#21046;&#30340;&#24212;&#29992;</h3></div></div></div>
<p>&#36825;&#37324;&#20197;ARM&#20307;&#31995;&#20026;&#20363;&#20171;&#32461;Bootmem&#26426;&#21046;&#22312;&#31995;&#32479;&#24341;&#23548;&#26102;&#30340;&#24212;&#29992;&#12290;&#22312;&#31995;&#32479;&#21021;&#22987;&#21270;&#20869;&#23384;&#39029;&#31649;&#29702;&#21151;&#33021;&#20043;&#21069;&#20250;&#39318;&#20808;&#21551;&#29992;Bootmem&#65292;&#30456;&#20851;&#20195;&#30721;&#20301;&#20110;&#29305;&#23450;&#26550;&#26500;&#30340;kernel/setup.c&#20013;&#30340;setup_arch&#35843;&#29992;&#30340;paging_init&#20043;&#20013;&#12290;&#23427;&#34987;&#23450;&#20041;&#22312;&#29305;&#23450;&#20110;&#31995;&#32479;&#26550;&#26500;&#30340;&#20195;&#30721;&#20013;&#12290;</p>
<pre class="programlisting">
arch/arm/mm/mmu.c
void __init paging_init(struct meminfo *mi, struct machine_desc *mdesc)
{
	void *zero_page;

	build_mem_type_table();
	sanity_check_meminfo(mi);
	prepare_page_table(mi);
	
	bootmem_init(mi);
	devicemaps_init(mdesc);

	top_pmd = pmd_off_k(0xffff0000);

	zero_page = alloc_bootmem_low_pages(PAGE_SIZE);
	memzero(zero_page, PAGE_SIZE);
	empty_zero_page = virt_to_page(zero_page);
	flush_dcache_page(empty_zero_page);
}
</pre>
&#27880;&#24847;&#21040;bootmem_init&#20989;&#25968;&#65292;&#23427;&#29992;&#26469;&#21021;&#22987;&#21270;bootmem&#65292;&#21442;&#25968;&#20026;struct meminfo&#31867;&#22411;&#12290;
<pre class="programlisting">
arch/arm/mm/init.c

void __init bootmem_init(struct meminfo *mi);
</pre>
struct meminfo&#36825;&#20010;&#32467;&#26500;&#20307;&#23450;&#20041;&#22312;&#29305;&#23450;&#26550;&#26500;&#20013;&#30340;include/asm/setup.h&#20013;&#65292;&#36825;&#26159;&#19968;&#20010;&#23545;&#29289;&#29702;&#20869;&#23384;&#21306;&#38388;&#25551;&#36848;&#30340;&#32467;&#26500;&#20307;&#65292;&#23427;&#23558;&#25972;&#20010;&#22320;&#22336;&#31354;&#38388;&#20998;&#20026;NR_BANKS(&#36890;&#24120;&#20026;8)&#20010;&#21306;&#38388;&#65292;&#36890;&#24120;&#19968;&#20010;&#21306;&#24517;&#39035;&#26159;&#36830;&#32493;&#30340;&#22320;&#22336;&#24182;&#19988;&#26159;&#21516;&#19968;&#31867;&#22411;&#30340;&#35774;&#22791;&#65292;&#32780;&#29992;&#20110;&#29305;&#27530;&#30446;&#30340;&#30340;&#22320;&#22336;&#23558;&#21010;&#20998;&#20026;&#19968;&#20010;&#29420;&#31435;&#30340;&#21306;&#12290;&#39318;&#20808;&#23450;&#20041;nr_banks&#65292;&#23427;&#35760;&#24405;&#20102;&#24403;&#21069;&#31995;&#32479;&#30340;&#20869;&#23384;&#22359;&#30340;&#20010;&#25968;&#65292;&#28982;&#21518;&#26159;&#32467;&#26500;&#20307;bank[NR_BANKS]&#12290;struct membank&#32467;&#26500;&#20013;&#30340;start&#25351;&#26126;&#20102;RAM&#30340;&#36215;&#22987;&#29289;&#29702;&#22320;&#22336;&#65292;size&#25351;&#26126;&#20102;&#22823;&#23567;&#65292;node&#21017;&#25351;&#26126;&#20102;&#20869;&#23384;&#22359;&#21495;&#65292;&#23545;&#20110;UMA&#27169;&#24335;(&#26410;&#37197;&#32622;CONFIG_DISCONTIGMEM)&#26469;&#35828;&#65292;&#23427;&#27704;&#36828;&#34987;&#32622;&#20026;0&#12290;
<pre class="programlisting">
arch/arm/include/asm/setup.h

struct membank {
        unsigned long start;
        unsigned long size;
        int           node;
};

struct meminfo {
        int nr_banks;
        struct membank bank[NR_BANKS];
};
</pre>
<div class="sect3" title="10.10.1. mem&#21442;&#25968;&#30340;&#20256;&#36882;"><div class="titlepage"><div><div><h4 class="title"><a name="idp80834596"></a>10.10.1. mem&#21442;&#25968;&#30340;&#20256;&#36882;</h4></div></div></div>
&#20869;&#26680;&#22312;&#21551;&#21160;&#36807;&#31243;&#20013;&#36890;&#36807;&#19968;&#20010;&#20840;&#23616;&#21464;&#37327;"meminfo"&#26469;&#37197;&#32622;&#20869;&#23384;&#12290;&#23427;&#34987;&#23450;&#20041;&#20026;static&#65292;&#25152;&#20197;&#26159;&#19968;&#20010;&#23616;&#37096;&#30340;&#20840;&#23616;&#21464;&#37327;&#65292;&#20165;&#38480;&#21046;&#20110;setup.c&#20869;&#37096;&#20351;&#29992;&#12290;__initdata&#38480;&#23450;meminfo&#34987;&#32534;&#35793;&#21040;data&#25968;&#25454;&#27573;&#12290;
<pre class="programlisting">
arch/arm/kernel/setup.c

static struct meminfo meminfo __initdata = { 0, };
</pre>
meminfo&#34987;&#21021;&#22987;&#21270;&#20026;0&#65292;&#37027;&#20040;&#20854;&#20013;&#30340;&#25968;&#25454;&#26159;&#21512;&#36866;&#22635;&#20805;&#30340;&#21602;&#65311;Bootloader&#22312;&#24341;&#23548;&#26102;&#36890;&#36807;&#20004;&#31181;&#26041;&#24335;&#20687;&#20869;&#26680;&#25552;&#20379;&#21442;&#25968;&#30340;&#20256;&#36882;&#65306;
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">&#36890;&#36807;tags&#25968;&#32452;&#26469;&#20256;&#36882;&#20869;&#23384;&#20449;&#24687;&#65292;&#22312;Bootloader&#20013;&#36890;&#36807;setup_memory_tags&#20989;&#25968;&#22635;&#20805;&#20869;&#23384;&#30456;&#20851;&#30340;&#20449;&#24687;&#65292;&#36825;&#20123;&#20449;&#24687;&#36890;&#36807;&#23439;&#23450;&#20041;&#20445;&#23384;&#21040;&#31867;&#22411;&#20026;ATAG_MEM&#30340;tags&#20013;&#65292;&#28982;&#21518;&#36890;&#36807;&#23492;&#23384;&#22120;&#20256;&#36882;&#32473;&#20869;&#26680;&#36825;&#20123;&#21442;&#25968;&#30340;&#22320;&#22336;&#12290;&#22312;&#20869;&#26680;&#30340;setup_arch&#20013;&#30340;parse_tags&#20013;&#19981;&#21516;&#31867;&#22411;&#30340;tags&#30001;&#19981;&#21516;&#30340;&#20989;&#25968;&#35299;&#26512;&#12290;&#20854;&#20013;ATAG_MEM&#31867;&#22411;&#30340;tags&#34987;parse_tag_mem32&#35299;&#26512;&#12290;</li><li class="listitem">&#36890;&#36807;&#20869;&#26680;&#37197;&#32622;&#20013;&#30340;CONFIG_CMDLINE&#25351;&#23450;mem&#21442;&#25968;&#65292;&#21487;&#20197;&#36890;&#36807;mem=size@addr(ex. mem=128M@0xb0000000)&#30340;&#26041;&#24335;&#21516;&#26102;&#25351;&#23450;&#22823;&#23567;&#21644;&#29289;&#29702;RAM&#30340;&#22320;&#22336;&#65292;&#22914;&#26524;&#21482;&#25351;&#23450;&#20102;&#22823;&#23567;&#65292;&#29289;&#29702;RAM&#30340;&#22320;&#22336;&#22312;&#20869;&#26680;&#20013;&#20351;&#29992;PHYS_OFFSET&#23450;&#20041;&#30340;&#20540;&#12290;CONFIG_CMDLINE&#22312;setup.c&#20013;&#39318;&#20808;&#34987;&#36171;&#20540;&#32473;default_command_line&#65292;&#25509;&#30528;&#22312;setup_arch&#20013;&#30340;parse_cmdline&#20013;&#34987;&#35299;&#26512;&#12290;pase_cmdline&#35843;&#29992;&#19968;&#31995;&#21015;&#21517;&#20026;early_&#24320;&#22987;&#30340;&#20989;&#25968;&#35299;&#26512;&#23545;&#24212;&#30340;&#21442;&#25968;&#12290;mem&#21442;&#25968;&#30001;early_mem&#35299;&#26512;&#12290;</li></ul></div>
&#36890;&#24120;setup_arch&#20250;&#39318;&#20808;&#35299;&#26512;tags&#20013;&#30340;&#21442;&#25968;&#65292;&#28982;&#21518;&#35299;&#26512;CONFIG_CMDLIN&#20013;&#30001;eraly_&#24320;&#22836;&#30340;&#35299;&#26512;&#20989;&#25968;&#26469;&#35299;&#26512;&#30340;&#21442;&#25968;&#12290;&#26080;&#35770;&#26159;&#36890;&#36807;&#20309;&#31181;&#26041;&#24335;&#65292;&#26368;&#32456;&#37117;&#23558;&#35843;&#29992;&#32479;&#19968;&#30340;arm_add_memory&#20989;&#25968;&#23558;&#20869;&#23384;&#20449;&#24687;&#36716;&#25442;&#20026;struct membank&#31867;&#22411;&#24182;&#23384;&#25918;&#21040;meminfo&#20013;&#12290;
<pre class="programlisting">
static void __init arm_add_memory(unsigned long start, unsigned long size)
{
	struct membank *bank;

	/*
	 * Ensure that start/size are aligned to a page boundary.
	 * Size is appropriately rounded down, start is rounded up.
	 */
	size -= start &amp; ~PAGE_MASK;

	bank = &amp;meminfo.bank[meminfo.nr_banks++];

	bank-&gt;start = PAGE_ALIGN(start);
	bank-&gt;size  = size &amp; PAGE_MASK;
	
	/* if not define CONFIG_DISCONTIGMEM then #define PHYS_TO_NID(addr) (0) */
	bank-&gt;node  = PHYS_TO_NID(start);
}
</pre>
&#27880;&#24847;&#24403;&#36890;&#36807;CONFIG_CMDLINE&#20256;&#36882;mem&#21442;&#25968;&#26102;&#65292;early_mem&#22312;&#19968;&#27425;&#22788;&#29702;mem&#21442;&#25968;&#26102;&#20250;&#23558;meminfo.nr_banks&#32622;&#20026;0&#65292;&#30001;&#20110;&#20004;&#31181;&#26041;&#24335;&#30340;&#35299;&#26512;&#20808;&#21518;&#39034;&#24207;&#65292;&#23548;&#33268;CONFIG_CMDLINE&#20256;&#36882;mem&#21442;&#25968;&#26102;&#65292;&#30001;Bootloader&#36890;&#36807;tags&#26041;&#24335;&#20256;&#36882;&#30340;&#20869;&#23384;&#21442;&#25968;&#23558;&#22833;&#25928;&#12290;&#25152;&#20197;&#22914;&#26524;&#38656;&#35201;&#25351;&#26126;&#22810;&#20010;mem&#21442;&#25968;&#20449;&#24687;&#65292;&#37027;&#20040;&#36890;&#36807;CONFIG_CMDLINE&#20256;&#36882;&#26159;&#26041;&#20415;&#30340;&#12290;&#22914;&#26524;&#36890;&#36807;CONFIG_CMDLINE&#25351;&#23450;&#20102;mem=256M&#65292;PHYS_OFFSET&#34987;&#23450;&#20041;&#20026;0x50000000&#30340;&#31995;&#32479;&#65292;&#23558;&#24471;&#21040;&#22914;&#19979;&#30340;meminfo&#20449;&#24687;&#12290;
<pre class="programlisting">
struct meminfo {
  .nr_banks = 1;
  bank[8] = 
  {
    {
      .start = 0x50000000;
      .size = 0x10000000;
      .node = 0;
    };
   ...
  }
};
</pre>
</div>
<div class="sect3" title="10.10.2. bootmem_init"><div class="titlepage"><div><div><h4 class="title"><a name="idp80839436"></a>10.10.2. bootmem_init</h4></div></div></div>
<p>
bootmem_init&#26159;&#19968;&#20010;&#20030;&#36275;&#36731;&#37325;&#30340;&#20989;&#25968;&#65292;&#23427;&#26159;&#29305;&#23450;&#20307;&#31995;&#26550;&#26500;&#23454;&#29616;Bootmem&#26426;&#21046;&#30340;&#20837;&#21475;&#12290;&#21442;&#25968;mi&#20256;&#36882;&#31995;&#32479;&#20013;&#25152;&#26377;&#30340;RAM&#20449;&#24687;&#32473;&#35813;&#20989;&#25968;&#65292;&#20989;&#25968;&#20013;&#23558;&#38024;&#23545;&#25152;&#26377;&#30340;&#20869;&#23384;node(&#36825;&#37324;&#29992;bank&#26469;&#34920;&#31034;)&#20570;&#22788;&#29702;&#65292;&#24182;&#22312;&#27599;&#19968;&#20010;node&#20013;&#24314;&#31435;&#20301;&#22270;&#26144;&#23556;&#12290;
</p><p>
bootmem_init&#23436;&#25104;&#20102;&#20197;&#19979;&#21151;&#33021;&#65292;&#20294;&#19981;&#36820;&#22238;&#20219;&#20309;&#20449;&#24687;:
</p><p>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">&#39318;&#20808;&#36890;&#36807;check_initrd&#26597;&#25214;&#21253;&#21547;ramdisk&#30340;&#20869;&#23384;node&#65292;&#20197;&#22791;&#22312;bitmap&#20013;&#20445;&#30041;&#35813;node&#20013;&#30340;&#20869;&#23384;&#12290;</li><li class="listitem">&#36890;&#36807;for_each_node&#36941;&#21382;&#24403;&#21069;&#31995;&#32479;&#20013;&#30340;MAX_NUMNODES&#20010;&#20869;&#23384;node&#65292;&#28982;&#21518;&#36890;&#36807;bootmem_init_node&#20989;&#25968;&#23545;&#27599;&#19968;&#20010;node&#36827;&#34892;&#21021;&#22987;&#21270;&#21644;&#39044;&#30041;&#30340;&#22788;&#29702;&#12290;</li><li class="listitem">&#36890;&#36807;for_each_node&#35843;&#29992;bootmem_free_node&#20026;&#27599;&#19968;&#20010;node&#36890;&#36807;Bootmem&#26426;&#21046;&#30003;&#35831;strcut page&#25968;&#25454;&#21306;&#65292;&#27599;&#19968;&#20010;&#29289;&#29702;&#39029;&#26694;&#37117;&#30001;&#19968;&#20010;&#23545;&#24212;&#30340;struct page&#32467;&#26500;&#31649;&#29702;&#12290;&#26174;&#28982;&#20174;&#27492;&#21151;&#33021;&#21487;&#20197;&#30475;&#21040;Bootmem&#22312;&#31995;&#32479;&#24341;&#23548;&#36807;&#31243;&#20013;&#26159;&#20026;&#20102;&#39029;&#38754;&#31649;&#29702;&#36215;&#21040;&#30340;&#20934;&#22791;&#20316;&#29992;&#12290;</li><li class="listitem">&#32479;&#35745;&#26368;&#22823;&#29289;&#29702;&#39029;&#24103;memend_pfn&#65292;&#24182;&#25454;&#20844;&#24335;high_memory = __va(memend_pfn &lt;&lt; PAGE_SHIFT)&#35745;&#31639;high_memory&#20197;&#21450;&#20844;&#24335;max_pfn = max_low_pfn = memend_pfn - PHYS_PFN_OFFSET&#35745;&#31639;&#24403;&#21069;&#31995;&#32479;&#20013;&#25152;&#26377;node&#30340;&#29289;&#29702;&#39029;&#26694;&#24635;&#25968;&#12290;</li></ul></div><p>
&#19968;&#20010;&#29289;&#29702;RAM&#20026;256Mb(0x10000000)&#65292;&#36215;&#22987;&#29289;&#29702;&#22320;&#22336;&#20026;0x50000000&#30340;&#31995;&#32479;&#65292;&#23558;&#24471;&#21040;&#20197;&#19979;&#20540;&#65292;memend_pfn&#35760;&#24405;&#20102;&#26368;&#22823;&#30340;&#29289;&#29702;&#39029;&#26694;&#65292;PHYS_PFN_OFFSET&#21017;&#30001;PHYS_OFFSET&#21462;&#39029;&#26694;&#22320;&#22336;&#24471;&#21040;&#12290;
</p><pre class="programlisting">
high_memory = 0xd0000000, max_pfn = 0x10000, memend_pfn = 0x60000 PHYS_PFN_OFFSET = 0x50000
</pre><p>
</p><p>
&#23545;&#20110;Bootmem&#26426;&#21046;&#26159;&#22914;&#20309;&#36890;&#36807;bootmem_init&#23454;&#29616;&#65292;&#24182;&#22312;&#27492;&#22522;&#30784;&#19978;&#23454;&#29616;&#20102;&#20869;&#23384;&#39029;&#34920;&#31649;&#29702;&#65292;&#23558;&#22312;&#39029;&#34920;&#26426;&#21046;&#20013;&#35814;&#32454;&#35828;&#26126;&#12290;
</p>
</div>
<div class="sect3" title="10.10.3. bootmem_init_node"><div class="titlepage"><div><div><h4 class="title"><a name="idp80843572"></a>10.10.3. bootmem_init_node</h4></div></div></div>
<p>
bootmem_init_node&#26681;&#25454;&#21442;&#25968;mi&#20013;&#30340;bank&#25968;&#25454;&#32467;&#26500;&#65292;&#20026;&#27599;&#19968;&#20010;node&#20869;&#23384;&#33410;&#28857;&#20998;&#37197;&#20301;&#22270;&#31354;&#38388;&#65292;&#24182;&#21021;&#22987;&#21270;&#30456;&#20851;&#20449;&#24687;&#12290;
</p><pre class="programlisting">
arch/arm/mm/init.c

static unsigned long __init bootmem_init_node(int node, struct meminfo *mi);
</pre><p>
</p></div>
</div>
</div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ar01s09.html">&#19978;&#19968;&#39029;</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="ar01s11.html">&#19979;&#19968;&#39029;</a></td></tr><tr><td width="40%" align="left" valign="top">9. &#20869;&#26680;&#21021;&#22987;&#21270; </td><td width="20%" align="center"><a accesskey="h" href="index.html">&#36215;&#22987;&#39029;</a></td><td width="40%" align="right" valign="top"> 11. &#20869;&#26680;&#21021;&#22987;&#21270;2</td></tr></table></div></body></html>
