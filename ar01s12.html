<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>12. &#39029;&#34920;&#26426;&#21046;</title><link rel="stylesheet" href="styles.css" type="text/css"><meta name="generator" content="DocBook XSL-NS Stylesheets V1.75.2"><link rel="home" href="index.html" title="Linux&#20869;&#26680;&#23398;&#20064;&#21644;&#30740;&#31350;&#21450;&#23884;&#20837;&#24335;(ARM)&#23398;&#20064;&#21644;&#30740;&#31350;&#30340;&#24320;&#25918;&#25991;&#26723;"><link rel="up" href="index.html" title="Linux&#20869;&#26680;&#23398;&#20064;&#21644;&#30740;&#31350;&#21450;&#23884;&#20837;&#24335;(ARM)&#23398;&#20064;&#21644;&#30740;&#31350;&#30340;&#24320;&#25918;&#25991;&#26723;"><link rel="prev" href="ar01s11.html" title="11. &#20869;&#26680;&#21021;&#22987;&#21270;2"><link rel="next" href="ar01s13.html" title="13. &#20869;&#23384;&#31649;&#29702;"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">12. &#39029;&#34920;&#26426;&#21046;</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ar01s11.html">&#19978;&#19968;&#39029;</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="ar01s13.html">&#19979;&#19968;&#39029;</a></td></tr></table><hr></div><div class="sect1" title="12. &#39029;&#34920;&#26426;&#21046;"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp80844636"></a>12. &#39029;&#34920;&#26426;&#21046;</h2></div></div></div>
<div class="sect2" title="12.1. &#24341;&#35328;"><div class="titlepage"><div><div><h3 class="title"><a name="idp80916636"></a>12.1. &#24341;&#35328;</h3></div></div></div>
	<p>
&#22312;Linux&#31995;&#32479;&#20013;&#65292;&#23384;&#22312;&#20197;&#19979;&#19977;&#31181;&#22320;&#22336;&#65306;
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">&#36923;&#36753;&#22320;&#22336;&#65306;&#23427;&#34987;&#21253;&#21547;&#22312;&#26426;&#22120;&#25351;&#20196;&#20013;&#29992;&#26469;&#25351;&#23450;&#19968;&#20010;&#25805;&#20316;&#25968;&#25110;&#19968;&#26465;&#25351;&#20196;&#30340;&#22320;&#22336;&#12290;&#27599;&#19968;&#20010;&#36923;&#36753;&#22320;&#22336;&#37117;&#30001;&#19968;&#20010;&#27573;(Segment)&#21644;&#20559;&#31227;&#37327;(Offset)&#32452;&#25104;&#65292;&#20559;&#31227;&#37327;&#25351;&#26126;&#20102;&#20174;&#27573;&#24320;&#22987;&#30340;&#22320;&#26041;&#21040;&#23454;&#38469;&#22320;&#22336;&#20043;&#38388;&#30340;&#36317;&#31163;&#12290;</li><li class="listitem">&#32447;&#24615;&#22320;&#22336;(&#34394;&#25311;&#22320;&#22336;)&#65306;&#19968;&#20010;32&#20301;&#26080;&#31526;&#21495;&#25972;&#25968;&#65292;&#21487;&#20197;&#29992;&#26469;&#34920;&#31034;&#39640;&#36798;4GB&#30340;&#22320;&#22336;&#12290;&#32447;&#24615;&#22320;&#22336;&#36890;&#24120;&#29992;&#21313;&#20845;&#36827;&#21046;&#25968;&#23383;&#34920;&#31034;&#65292;&#20540;&#30340;&#33539;&#22260;&#20026;[0x00000000, 0xffffffff)&#12290;</li><li class="listitem">&#29289;&#29702;&#22320;&#22336;&#65306;&#29992;&#20110;&#20869;&#23384;&#33455;&#29255;&#32423;&#20869;&#23384;&#21333;&#20803;&#23547;&#22336;&#12290;&#23427;&#20204;&#19982;&#20174;CPU&#30340;&#22320;&#22336;&#24341;&#33050;&#21457;&#36865;&#21040;&#20869;&#23384;&#24635;&#32447;&#19978;&#30340;&#30005;&#20449;&#21495;&#30456;&#23545;&#24212;&#12290;&#29289;&#29702;&#22320;&#22336;&#30001;32&#20301;&#25110;36&#20301;&#26080;&#31526;&#21495;&#25972;&#25968;&#34920;&#31034;&#12290;</li></ul></div><p>
&#20869;&#23384;&#25511;&#21046;&#21333;&#20803;(MMU)&#36890;&#36807;&#19968;&#31181;&#31216;&#20026;&#20998;&#27573;&#21333;&#20803;&#30340;&#30828;&#20214;&#30005;&#36335;&#25226;&#19968;&#20010;&#36923;&#36753;&#22320;&#22336;&#36716;&#25442;&#25104;&#32447;&#24615;&#22320;&#22336;&#65307;&#31216;&#20026;&#20998;&#39029;&#21333;&#20803;&#30340;&#30828;&#20214;&#30005;&#36335;&#25226;&#32447;&#24615;&#22320;&#22336;&#36716;&#25442;&#25104;&#19968;&#20010;&#29289;&#29702;&#22320;&#22336;&#12290;&#26377;&#20123;MMU&#27809;&#26377;&#20998;&#39029;&#21333;&#20803;&#65292;&#25110;&#32773;&#31105;&#27490;&#20351;&#33021;&#20998;&#39029;&#21333;&#20803;&#65292;&#27604;&#22914;x86&#30340;&#23454;&#27169;&#24335;&#65292;&#37027;&#20040;&#23601;&#21482;&#26377;&#20998;&#27573;&#21333;&#20803;&#65292;&#37027;&#20040;&#32463;&#36807;&#20998;&#27573;&#21333;&#20803;&#36716;&#25442;&#21518;&#30340;&#22320;&#22336;&#23601;&#26159;&#29289;&#29702;&#22320;&#22336;&#12290;&#26377;&#20123;MMU&#27809;&#26377;&#20998;&#27573;&#21333;&#20803;&#65292;&#22823;&#22810;&#25968;RISC&#26550;&#26500;&#30340;CPU&#23601;&#26159;&#22914;&#27492;&#65292;&#27492;&#26102;&#27573;&#22522;&#22336;&#30456;&#24403;&#20110;0&#65292;&#32780;&#20195;&#30721;&#20013;&#30340;&#20559;&#31227;&#22320;&#22336;&#23601;&#26159;&#32447;&#24615;&#22320;&#22336;&#65292;&#25152;&#26377;Linux&#19979;&#36923;&#36753;&#22320;&#22336;&#21644;&#32447;&#24615;&#22320;&#22336;&#26159;&#19968;&#33268;&#30340;&#12290;&#22914;&#19979;&#22270;&#25152;&#31034;&#65306;
</p><div class="figure"><a name="idp80918188"></a><p class="title"><b>&#22270; 61. &#22320;&#22336;&#36716;&#25442;</b></p><div class="figure-contents"><div><img src="images/addr_conv.gif" alt="&#22320;&#22336;&#36716;&#25442;"></div></div></div><p><br class="figure-break">
Linux&#20013;&#20197;&#38750;&#24120;&#26377;&#38480;&#30340;&#26041;&#24335;&#20351;&#29992;&#20998;&#27573;&#12290;&#36816;&#34892;&#22312;&#29992;&#25143;&#24577;&#30340;&#25152;&#26377;Linux&#36827;&#31243;&#37117;&#20351;&#29992;&#19968;&#23545;&#30456;&#21516;&#30340;&#27573;&#26469;&#23545;&#25351;&#20196;&#21644;&#25968;&#25454;&#23547;&#22336;&#65292;&#23427;&#20204;&#30340;&#27573;&#22522;&#22336;&#20998;&#21035;&#26159;__USER_CS&#21644;__USER_DS&#12290;&#19982;&#27492;&#21516;&#26102;&#65292;&#36816;&#34892;&#22312;&#20869;&#26680;&#24577;&#30340;&#25152;&#26377;Linux&#36827;&#31243;(&#20869;&#26680;&#32447;&#31243;)&#37117;&#20351;&#29992;&#19968;&#23545;&#30456;&#21516;&#30340;&#27573;&#23545;&#25351;&#20196;&#21644;&#25968;&#25454;&#23547;&#22336;&#65292;&#23427;&#20204;&#30340;&#27573;&#22522;&#22336;&#20998;&#21035;__KERNEL_CS&#21644;__KERNEL_DS&#12290;
	</p>	
	<p>
&#20998;&#27573;&#21487;&#20197;&#32473;&#27599;&#20010;&#36827;&#31243;&#20998;&#37197;&#19981;&#21516;&#30340;&#32447;&#24615;&#22320;&#22336;&#31354;&#38388;&#65292;&#20998;&#39029;&#21487;&#20197;&#25226;&#21516;&#19968;&#32447;&#24615;&#22320;&#22336;&#31354;&#38388;&#26144;&#23556;&#21040;&#19981;&#21516;&#30340;&#29289;&#29702;&#31354;&#38388;&#12290;&#19982;&#20998;&#27573;&#30456;&#27604;&#65292;Linux&#26356;&#21916;&#27426;&#20998;&#39029;&#26041;&#24335;&#65292;&#22240;&#20026;&#65306;
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">&#24403;&#25152;&#26377;&#36827;&#31243;&#20351;&#29992;&#30456;&#21516;&#30340;&#27573;&#23492;&#23384;&#22120;&#20540;&#26102;&#65292;&#20869;&#23384;&#31649;&#29702;&#21464;&#24471;&#26356;&#31616;&#21333;&#65292;&#20063;&#23601;&#26159;&#35828;&#23427;&#20204;&#33021;&#20849;&#20139;&#21516;&#26679;&#30340;&#19968;&#31751;&#32447;&#24615;&#22320;&#22336;&#12290;</li><li class="listitem">&#20026;&#20102;&#20860;&#23481;&#32477;&#22823;&#22810;&#25968;&#30340;CPU&#65292;RISC&#20307;&#31995;&#26550;&#26500;&#23545;&#20998;&#27573;&#30340;&#25903;&#25345;&#24456;&#26377;&#38480;&#65292;&#27604;&#22914;ARM&#26550;&#26500;&#30340;CPU&#20013;&#30340;MMU&#21333;&#20803;&#36890;&#24120;&#21482;&#25903;&#25345;&#20998;&#39029;&#65292;&#32780;&#19981;&#25903;&#25345;&#20998;&#27573;&#12290;</li></ul></div><p>
	</p>
<p>&#20998;&#39029;&#20351;&#24471;&#19981;&#21516;&#30340;&#34394;&#25311;&#20869;&#23384;&#39029;&#21487;&#20197;&#36716;&#20837;&#21516;&#19968;&#29289;&#29702;&#39029;&#26694;&#12290;&#20110;&#27492;&#21516;&#26102;&#20998;&#39029;&#26426;&#21046;&#21487;&#20197;&#23454;&#29616;&#23545;&#27599;&#20010;&#39029;&#38754;&#30340;&#35775;&#38382;&#25511;&#21046;&#65292;&#36825;&#26159;&#22312;&#24179;&#34913;&#20869;&#23384;&#20351;&#29992;&#25928;&#29575;&#21644;&#22320;&#22336;&#36716;&#25442;&#25928;&#29575;&#20043;&#38388;&#20570;&#20986;&#30340;&#36873;&#25321;&#12290;&#22914;&#26524;4G&#30340;&#34394;&#25311;&#31354;&#38388;&#65292;&#27599;&#19968;&#20010;&#23383;&#33410;&#37117;&#35201;&#20351;&#29992;&#19968;&#20010;&#25968;&#25454;&#32467;&#26500;&#26469;&#35760;&#24405;&#23427;&#30340;&#35775;&#38382;&#25511;&#21046;&#20449;&#24687;&#65292;&#37027;&#20040;&#26174;&#28982;&#26159;&#19981;&#21487;&#33021;&#30340;&#12290;&#22914;&#26524;&#25226;4G&#30340;&#34394;&#25311;&#31354;&#38388;&#20197;4K(&#20026;&#20160;&#20040;&#26159;4K&#22823;&#23567;&#65311;&#36825;&#26159;&#30001;&#20110;Linux&#20013;&#30340;&#21487;&#25191;&#34892;&#25991;&#20214;&#20013;&#30340;&#20195;&#30721;&#27573;&#21644;&#25968;&#25454;&#27573;&#31561;&#37117;&#26159;&#30456;&#23545;&#20110;4K&#23545;&#40784;&#30340;)&#22823;&#23567;&#20998;&#21106;&#25104;&#33509;&#24178;&#20010;&#19981;&#21516;&#30340;&#39029;&#38754;&#65292;&#37027;&#20040;&#27599;&#20010;&#39029;&#38754;&#38656;&#35201;&#19968;&#20010;&#25968;&#25454;&#32467;&#26500;&#36827;&#34892;&#25511;&#21046;&#65292;&#21482;&#38656;&#35201;1M&#30340;&#20869;&#23384;&#26469;&#23384;&#20648;&#12290;&#20294;&#26159;&#30001;&#20110;&#27599;&#19968;&#20010;&#29992;&#25143;&#36827;&#31243;&#37117;&#26377;&#33258;&#24049;&#30340;&#29420;&#31435;&#31354;&#38388;&#65292;&#25152;&#20197;&#27599;&#19968;&#20010;&#36827;&#31243;&#37117;&#38656;&#35201;&#19968;&#20010;1M&#30340;&#20869;&#23384;&#26469;&#23384;&#20648;&#39029;&#34920;&#20449;&#24687;&#65292;&#36825;&#20381;&#28982;&#26159;&#23545;&#31995;&#32479;&#20869;&#23384;&#30340;&#28010;&#36153;&#65292;&#37319;&#29992;&#20004;&#32423;&#29978;&#33267;&#22810;&#32423;&#20998;&#39029;&#26159;&#19968;&#31181;&#19981;&#38169;&#30340;&#35299;&#20915;&#26041;&#26696;&#12290;&#21478;&#22806;&#26377;&#20123;&#22788;&#29702;&#22120;&#37319;&#29992;64&#20301;&#20307;&#31995;&#26550;&#26500;&#65292;&#27492;&#26102;&#20004;&#32423;&#20063;&#19981;&#21512;&#36866;&#20102;&#65292;&#25152;&#20197;Linux&#20351;&#29992;&#19977;&#32423;&#39029;&#34920;&#12290;
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">&#39029;&#20840;&#23616;&#30446;&#24405;(Page Global Directory)&#65292;&#21363; pgd&#65292;&#26159;&#22810;&#32423;&#39029;&#34920;&#30340;&#25277;&#35937;&#26368;&#39640;&#23618;&#12290;&#27599;&#19968;&#32423;&#30340;&#39029;&#34920;&#37117;&#22788;&#29702;&#19981;&#21516;&#22823;&#23567;&#30340;&#20869;&#23384;&#12290;&#27599;&#39033;&#37117;&#25351;&#21521;&#19968;&#20010;&#26356;&#23567;&#30446;&#24405;&#30340;&#20302;&#32423;&#34920;&#65292;&#22240;&#27492;pgd&#23601;&#26159;&#19968;&#20010;&#39029;&#34920;&#30446;&#24405;&#12290;&#24403;&#20195;&#30721;&#36941;&#21382;&#36825;&#20010;&#32467;&#26500;&#26102;&#65288;&#26377;&#20123;&#39537;&#21160;&#31243;&#24207;&#23601;&#35201;&#36825;&#26679;&#20570;&#65289;&#65292;&#23601;&#31216;&#20026;&#26159;&#22312;&#36941;&#21382;&#39029;&#34920;&#12290;</li><li class="listitem">&#39029;&#20013;&#38388;&#30446;&#24405; (Page Middle Directory),&#21363;pmd&#65292;&#26159;&#39029;&#34920;&#30340;&#20013;&#38388;&#23618;&#12290;&#22312; x86 &#26550;&#26500;&#19978;&#65292;pmd &#22312;&#30828;&#20214;&#20013;&#24182;&#19981;&#23384;&#22312;&#65292;&#20294;&#26159;&#22312;&#20869;&#26680;&#20195;&#30721;&#20013;&#23427;&#26159;&#19982;pgd&#21512;&#24182;&#22312;&#19968;&#36215;&#30340;&#12290;</li><li class="listitem">&#39029;&#34920;&#26465;&#30446; (Page Table Entry)&#65292;&#21363;pte&#65292;&#26159;&#39029;&#34920;&#30340;&#26368;&#20302;&#23618;&#65292;&#23427;&#30452;&#25509;&#22788;&#29702;&#39029;&#65292;&#35813;&#20540;&#21253;&#21547;&#26576;&#39029;&#30340;&#29289;&#29702;&#22320;&#22336;&#65292;&#36824;&#21253;&#21547;&#20102;&#35828;&#26126;&#35813;&#26465;&#30446;&#26159;&#21542;&#26377;&#25928;&#21450;&#30456;&#20851;&#39029;&#26159;&#21542;&#22312;&#29289;&#29702;&#20869;&#23384;&#20013;&#30340;&#20301;&#12290;</li></ul></div><p>
</p>
</div>
<div class="sect2" title="12.2. &#19968;&#32423;&#39029;&#34920;"><div class="titlepage"><div><div><h3 class="title"><a name="idp80924636"></a>12.2. &#19968;&#32423;&#39029;&#34920;</h3></div></div></div>
<p>
&#19977;&#32423;&#39029;&#34920;&#30001;&#19981;&#21516;&#30340;&#30340;&#25968;&#25454;&#32467;&#26500;&#34920;&#31034;&#65292;&#23427;&#20204;&#20998;&#21035;&#26159;pgd_t&#65292;pmd_t&#21644;pte_t&#12290;&#27880;&#24847;&#21040;&#23427;&#20204;&#22343;&#34987;&#23450;&#20041;&#20026;unsigned long&#31867;&#22411;&#65292;&#20063;&#21363;&#22823;&#23567;&#20026;4bytes&#65292;32bits&#12290;
</p><pre class="programlisting">
arch/arm/include/asm/page.h

typedef unsigned long pte_t;
typedef unsigned long pmd_t;
typedef unsigned long pgd_t[2];
typedef unsigned long pgprot_t;
</pre><p>
&#20197;&#19979;&#26159;&#39029;&#34920;&#25805;&#20316;&#30456;&#20851;&#30340;&#23439;&#23450;&#20041;&#12290;
</p><pre class="programlisting">
#define pte_val(x)      (x)
#define pmd_val(x)      (x)
#define pgd_val(x)      ((x)[0])
#define pgprot_val(x)   (x)

#define __pte(x)        (x)
#define __pmd(x)        (x)
#define __pgprot(x)     (x)
</pre><p>
</p>	
<p>
&#20219;&#20309;&#19968;&#20010;&#29992;&#25143;&#36827;&#31243;&#37117;&#26377;&#33258;&#24049;&#30340;&#39029;&#34920;&#65292;&#19982;&#27492;&#21516;&#26102;&#65292;&#20869;&#26680;&#26412;&#36523;&#23601;&#26159;&#19968;&#20010;&#21517;&#20026;init_task&#30340;0&#21495;&#36827;&#31243;&#65292;&#27599;&#19968;&#20010;&#36827;&#31243;&#37117;&#26377;&#19968;&#20010;mm_struct&#32467;&#26500;&#31649;&#29702;&#36827;&#31243;&#30340;&#20869;&#23384;&#31354;&#38388;&#65292;init_mm&#26159;&#20869;&#26680;&#30340;mm_struct&#12290;&#22312;&#31995;&#32479;&#24341;&#23548;&#38454;&#27573;&#65292;&#39318;&#20808;&#36890;&#36807;__create_page_tables&#22312;&#20869;&#26680;&#20195;&#30721;&#30340;&#36215;&#22987;&#22788;_stext&#21521;&#20302;&#22320;&#22336;&#26041;&#21521;&#39044;&#30041;16K&#65292;&#29992;&#20110;&#19968;&#32423;&#39029;&#34920;(&#20027;&#20869;&#23384;&#39029;&#34920;)&#30340;&#23384;&#25918;&#65292;&#27599;&#20010;&#36827;&#31243;&#30340;&#39029;&#34920;&#37117;&#36890;&#36807;mm_struct&#20013;&#30340;pgd&#25551;&#36848;&#31526;&#36827;&#34892;&#24341;&#29992;&#12290;&#20869;&#26680;&#39029;&#34920;&#34987;&#23450;&#20041;&#22312;swapper_pg_dir&#12290;
</p><pre class="programlisting">
arch/arm/kernel/init_task.c

#define INIT_MM(name) \
{                                                               \
        .mm_rb          = RB_ROOT,                              \
        .pgd            = swapper_pg_dir,                       \
        .mm_users       = ATOMIC_INIT(2),                       \
        .mm_count       = ATOMIC_INIT(1),                       \
        .mmap_sem       = __RWSEM_INITIALIZER(name.mmap_sem),   \
        .page_table_lock =  __SPIN_LOCK_UNLOCKED(name.page_table_lock), \
        .mmlist         = LIST_HEAD_INIT(name.mmlist),          \
        .cpu_vm_mask    = CPU_MASK_ALL,                         \
}

struct mm_struct init_mm = INIT_MM(init_mm); 
</pre><p>
swapper_pg_dir&#22312;head.S&#20013;&#34987;&#23450;&#20041;&#20026;PAGE_OFFSET&#21521;&#19978;&#20559;&#31227;TEXT_OFFSET&#12290;TEXT_OFFSET&#20195;&#34920;&#20869;&#26680;&#20195;&#30721;&#27573;&#30340;&#30456;&#23545;&#20110;PAGE_OFFSET&#30340;&#20559;&#31227;&#12290;KERNEL_RAM_VADDR&#30340;&#20540;&#19982;_stext&#30340;&#20540;&#30456;&#21516;&#65292;&#20195;&#34920;&#20102;&#20869;&#26680;&#20195;&#30721;&#30340;&#36215;&#22987;&#22320;&#22336;&#12290;swapper_pg_dir&#20026;KERNEL_RAM_VADDR - 0x4000&#65292;&#20063;&#21363;&#21521;&#20302;&#22320;&#22336;&#26041;&#21521;&#20559;&#31227;&#20102;16K&#12290;
</p><pre class="programlisting">
arch/arm/Makefile

textofs-y       := 0x00008000
......
TEXT_OFFSET := $(textofs-y)
</pre><p>
&#29305;&#23450;&#31995;&#32479;&#26550;&#26500;&#30340;Makefile&#20013;&#36890;&#36807;textofs-y&#23450;&#20041;&#20102;&#20869;&#26680;&#36215;&#22987;&#20195;&#30721;&#30456;&#23545;&#20110;PAGE_OFFSET&#30340;&#20559;&#31227;&#12290;
</p><pre class="programlisting">
arch/arm/kernel/head.S
#define KERNEL_RAM_VADDR	(PAGE_OFFSET + TEXT_OFFSET)
......
.globl  swapper_pg_dir
.equ    swapper_pg_dir, KERNEL_RAM_VADDR - 0x4000
</pre><p>
ARM Linux&#20013;&#30340;&#20027;&#20869;&#23384;&#39029;&#34920;&#65292;&#20351;&#29992;&#27573;&#34920;&#12290;&#27599;&#20010;&#39029;&#34920;&#26144;&#23556;1M&#30340;&#20869;&#23384;&#22823;&#23567;&#65292;&#30001;&#20110;16K / 4 * 1M = 4G&#65292;&#36825;16K&#30340;&#20027;&#39029;&#34920;&#31354;&#38388;&#27491;&#22909;&#26144;&#23556;4G&#30340;&#34394;&#25311;&#31354;&#38388;&#12290;&#20869;&#26680;&#39029;&#34920;&#26426;&#21046;&#22312;&#31995;&#32479;&#21551;&#21160;&#36807;&#31243;&#20013;&#30340;paging_init&#20989;&#25968;&#20013;&#20351;&#33021;&#65292;&#20854;&#20013;&#23545;&#20869;&#26680;&#20027;&#39029;&#34920;&#30340;&#21021;&#22987;&#21270;&#31561;&#25805;&#20316;&#22343;&#26159;&#36890;&#36807;init_mm.pgd&#30340;&#24341;&#29992;&#26469;&#36827;&#34892;&#30340;&#12290;&#22312;&#31995;&#32479;&#25191;&#34892;paging_init&#20043;&#21069;&#65292;&#31995;&#32479;&#30340;&#22320;&#22336;&#31354;&#38388;&#22914;&#19979;&#22270;&#25152;&#31034;&#65306;
</p><div class="figure"><a name="idp80929900"></a><p class="title"><b>&#22270; 62. &#20869;&#26680;RAM&#24067;&#23616;</b></p><div class="figure-contents"><div><img src="images/pg_ram.gif" alt="&#20869;&#26680;RAM&#24067;&#23616;"></div></div></div><p><br class="figure-break">
&#22270;&#20013;&#30340;&#40644;&#33394;&#37096;&#20998;&#23601;&#26159;&#20869;&#26680;0&#21495;&#36827;&#31243;&#30340;&#20027;&#39029;&#34920;&#12290;
</p><pre class="programlisting">
arch/arm/mm/mmu.c

void __init paging_init(struct meminfo *mi, struct machine_desc *mdesc)
{
	void *zero_page;

	build_mem_type_table();
	sanity_check_meminfo(mi);
	prepare_page_table(mi);
	
	bootmem_init(mi);
	devicemaps_init(mdesc);

	top_pmd = pmd_off_k(0xffff0000);

	zero_page = alloc_bootmem_low_pages(PAGE_SIZE);
	memzero(zero_page, PAGE_SIZE);
	empty_zero_page = virt_to_page(zero_page);
	flush_dcache_page(empty_zero_page);
}
</pre><p>
</p>
<div class="figure"><a name="idp80930916"></a><p class="title"><b>&#22270; 63. ARM&#20869;&#23384;&#20027;&#39029;&#34920;&#21021;&#22987;&#21270;</b></p><div class="figure-contents"><div><img src="images/pg_map1.gif" alt="ARM&#20869;&#23384;&#20027;&#39029;&#34920;&#21021;&#22987;&#21270;"></div></div></div><br class="figure-break">
paging_init&#20381;&#27425;&#23436;&#25104;&#20102;&#20197;&#19979;&#24037;&#20316;&#65306;
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">&#35843;&#29992;prepare_page_table&#21021;&#22987;&#21270;&#34394;&#25311;&#22320;&#22336;[0, PAGE_OFFSET]&#21644;[mi-&gt;bank[0].start + mi-&gt;bank[0].size, VMALLOC_END]&#25152;&#23545;&#24212;&#30340;&#20027;&#39029;&#34920;&#39033;&#65292;&#25152;&#26377;&#34920;&#39033;&#22343;&#21021;&#22987;&#21270;&#20026;0&#12290;&#36825;&#37324;&#20445;&#30041;&#20102;&#20869;&#26680;&#20195;&#30721;&#21306;&#65292;&#20027;&#39029;&#34920;&#21306;&#20197;&#21450;Bootmem&#26426;&#21046;&#20013;&#30340;&#20301;&#22270;&#26144;&#23556;&#21306;&#23545;&#24212;&#30340;&#20027;&#39029;&#34920;&#12290;&#36825;&#26159;&#20026;&#20102;&#20445;&#35777;&#20869;&#26680;&#20195;&#30721;&#30340;&#25191;&#34892;&#20197;&#21450;&#23545;&#20027;&#39029;&#34920;&#21306;&#21644;&#20301;&#22270;&#21306;&#30340;&#35775;&#38382;&#12290;&#22914;&#26524;&#21482;&#26377;&#19968;&#20010;&#20869;&#23384;bank&#65292;&#37027;&#20040;mi-&gt;bank[0].start + mi-&gt;bank[0].size&#30340;&#20540;&#21644;high_memory&#20445;&#25345;&#19968;&#33268;&#65292;&#23427;&#26159;&#24403;&#21069;bank&#36827;&#34892;&#29289;&#29702;&#20869;&#23384;&#19968;&#19968;&#26144;&#23556;&#21518;&#30340;&#34394;&#25311;&#22320;&#22336;&#12290;&#23545;&#20110;&#19968;&#20010;&#20869;&#23384;&#20026;256M&#30340;&#31995;&#32479;&#26469;&#35828;&#65292;&#23427;&#21482;&#26377;&#19968;&#20010;bank&#65292;&#32463;&#36807;prepare_page_table&#22788;&#29702;&#21518;&#30340;&#20869;&#23384;&#22914;&#19978;&#22270;&#25152;&#31034;&#12290;</li><li class="listitem">&#25509;&#30528;&#22312;bootmem_init&#20989;&#25968;&#23558;&#36890;&#36807;bootmem_init_node&#23545;&#27599;&#19968;&#20010;&#20869;&#23384;bank&#30340;&#39029;&#34920;&#36827;&#34892;&#20540;&#30340;&#22635;&#20805;&#12290;bootmem_init_node&#23558;&#36890;&#36807;map_memory_bank&#38388;&#25509;&#35843;&#29992;create_mapping&#65292;&#26368;&#32456;&#30001;&#35813;&#20989;&#25968;&#21019;&#24314;&#39029;&#34920;&#12290;</li><li class="listitem">&#36890;&#36807;devicemaps_init&#21021;&#22987;&#21270;&#35774;&#22791;I/O&#23545;&#24212;&#30340;&#30456;&#20851;&#39029;&#34920;&#12290;</li><li class="listitem">&#26368;&#21518;&#21019;&#24314;0&#39029;&#34920;&#65292;&#24182;&#22312;Dcache&#20013;&#28165;&#31354;0&#39029;&#34920;&#30340;&#32531;&#23384;&#20449;&#24687;&#12290;</li></ul></div>
<div class="figure"><a name="idp80934212"></a><p class="title"><b>&#22270; 64. &#39029;&#34920;&#21019;&#24314;&#20989;&#25968;&#35843;&#29992;</b></p><div class="figure-contents"><div><img src="images/pg_call.gif" alt="&#39029;&#34920;&#21019;&#24314;&#20989;&#25968;&#35843;&#29992;"></div></div></div><br class="figure-break">
</div>
<div class="sect2" title="12.3. ARM &#20869;&#23384;&#35775;&#38382;"><div class="titlepage"><div><div><h3 class="title"><a name="idp80934804"></a>12.3. ARM &#20869;&#23384;&#35775;&#38382;</h3></div></div></div>
<p>
&#24403;ARM&#35201;&#35775;&#38382;&#20869;&#23384;RAM&#26102;&#65292;MMU&#39318;&#20808;&#26597;&#25214;TLB&#20013;&#30340;&#34394;&#25311;&#22320;&#22336;&#34920;&#65292;&#22914;&#26524;ARM&#30340;&#32467;&#26500;&#25903;&#25345;&#20998;&#24320;&#30340;&#22320;&#22336;TLB&#21644;&#25351;&#20196;TLB&#65292;&#37027;&#20040;&#23427;&#29992;&#65306;
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">&#21462;&#25351;&#20196;&#20351;&#29992;&#25351;&#20196;TLB</li><li class="listitem">&#20854;&#23427;&#30340;&#25152;&#26377;&#35775;&#38382;&#31867;&#21035;&#29992;&#25968;&#25454;TLB</li></ul></div><p>
&#25351;&#20196;TLB&#21644;&#25968;&#25454;TLB&#22312;ARMv6&#26550;&#26500;&#30340;MMU&#20013;&#34987;&#20998;&#21035;&#31216;&#20026;&#25351;&#20196;MicroTLB&#21644;&#25968;&#25454;MicroTLB&#12290;&#22914;&#26524;&#27809;&#26377;&#21629;&#20013;MicroTLB&#65292;&#37027;&#20040;&#23558;&#26597;&#35810;&#20027;TLB&#65292;&#27492;&#26102;&#19981;&#21306;&#20998;&#25351;&#20196;&#21644;&#25968;&#25454;TLB&#12290;
</p>
<p>
&#22914;&#26524;TLB&#20013;&#27809;&#26377;&#34394;&#25311;&#22320;&#22336;&#30340;&#20837;&#21475;&#65292;&#21017;&#36716;&#25442;&#34920;&#36941;&#21382;&#30828;&#20214;&#20174;&#23384;&#22312;&#20027;&#23384;&#20648;&#22120;&#20013;&#30340;&#36716;&#25442;&#34920;&#20013;&#33719;&#21462;&#36716;&#25442;&#39029;&#34920;&#39033;&#65292;&#23427;&#21253;&#21547;&#20102;&#29289;&#29702;&#22320;&#22336;&#25110;&#32773;&#20108;&#32423;&#39029;&#34920;&#22320;&#22336;&#21644;&#35775;&#38382;&#26435;&#38480;&#65292;&#19968;&#26086;&#21462;&#21040;&#65292;&#36825;&#20123;&#20449;&#24687;&#23558;&#34987;&#25918;&#22312;TLB&#20013;&#65292;&#23427;&#20250;&#25918;&#22312;&#19968;&#20010;&#27809;&#26377;&#20351;&#29992;&#30340;&#20837;&#21475;&#22788;&#25110;&#35206;&#30422;&#19968;&#20010;&#24050;&#26377;&#30340;&#20837;&#21475;&#12290;&#19968;&#26086;&#20026;&#23384;&#20648;&#22120;&#35775;&#38382;&#30340;TLB &#30340;&#20837;&#21475;&#34987;&#25343;&#21040;,&#36825;&#20123;&#20449;&#24687;&#23558;&#34987;&#29992;&#20110;&#65306;
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">C&#65288;&#39640;&#36895;&#32531;&#23384;&#65289;&#21644;B&#65288;&#32531;&#20914;&#65289;&#20301;&#34987;&#29992;&#26469;&#25511;&#21046;&#39640;&#36895;&#32531;&#23384;&#21644;&#20889;&#32531;&#20914;&#65292;&#24182;&#20915;&#23450;&#26159;&#21542;&#39640;&#36895;&#32531;&#23384;&#12290;</li><li class="listitem">&#39318;&#20808;&#26816;&#26597;&#22495;&#20301;&#65292;&#28982;&#21518;&#26816;&#26597;&#35775;&#38382;&#26435;&#38480;&#20301;&#29992;&#26469;&#25511;&#21046;&#35775;&#38382;&#26159;&#21542;&#34987;&#20801;&#35768;&#12290;&#22914;&#26524;&#19981;&#20801;&#35768;&#65292;&#21017;MMU &#23558;&#21521;ARM&#22788;&#29702;&#22120;&#21457;&#36865;&#19968;&#20010;&#23384;&#20648;&#22120;&#24322;&#24120;&#65307;&#21542;&#21017;&#35775;&#38382;&#23558;&#34987;&#20801;&#35768;&#36827;&#34892;&#12290;</li><li class="listitem">&#23545;&#27809;&#26377;&#25110;&#32773;&#31105;&#27490;&#39640;&#36895;&#32531;&#23384;&#30340;&#31995;&#32479;&#65288;&#21253;&#25324;&#22312;&#27809;&#26377;&#39640;&#36895;&#32531;&#23384;&#31995;&#32479;&#20013;&#30340;&#25152;&#26377;&#23384;&#20648;&#22120;&#35775;&#38382;&#65289;&#65292;&#29289;&#29702;&#22320;&#22336;&#23558;&#34987;&#29992;&#20316;&#20027;&#23384;&#20648;&#22120;&#35775;&#38382;&#30340;&#22320;&#22336;&#12290;</li></ul></div><p>
</p><div class="figure"><a name="idp80938420"></a><p class="title"><b>&#22270; 65. &#39640;&#36895;&#32531;&#23384;&#30340;MMU&#23384;&#20648;&#22120;&#31995;&#32479;</b></p><div class="figure-contents"><div><img src="images/pg_mmu_system.jpg" alt="&#39640;&#36895;&#32531;&#23384;&#30340;MMU&#23384;&#20648;&#22120;&#31995;&#32479;"></div></div></div><p><br class="figure-break">
</p>
<p>
</p>
<p>
</p>
</div>
<div class="sect2" title="12.4. ARM MMU&#39029;&#34920;"><div class="titlepage"><div><div><h3 class="title"><a name="idp80939596"></a>12.4. ARM MMU&#39029;&#34920;</h3></div></div></div>
&#22312;ARMv6&#30340;MMU&#26426;&#21046;&#20013;&#65292;&#25552;&#20379;&#20102;&#20004;&#31181;&#26684;&#24335;&#30340;&#39029;&#34920;&#25551;&#36848;&#31526;&#65306;
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">&#20860;&#23481;ARMv4&#21644;ARMv5 MMU&#26426;&#21046;&#30340;&#39029;&#34920;&#25551;&#36848;&#31526;&#12290;&#36825;&#31181;&#25551;&#36848;&#31526;&#21487;&#20197;&#23545;64K&#22823;&#39029;&#38754;&#21644;4K&#23567;&#39029;&#38754;&#20877;&#36827;&#19968;&#27493;&#32454;&#20998;&#20026;&#23376;&#39029;&#38754;&#12290;</li><li class="listitem">ARMv6&#29305;&#26377;&#30340;MMU&#39029;&#34920;&#25551;&#36848;&#31526;&#65292;&#36825;&#31181;&#39029;&#34920;&#25551;&#36848;&#31526;&#20869;&#22686;&#21152;&#20102;&#39069;&#22806;&#30340;&#29305;&#23450;&#27604;&#29305;&#20301;&#65306;Not-Global(nG)&#65292;Shared (S)&#65292;Execute-Never (XN)&#21644;&#25193;&#23637;&#30340;&#35775;&#38382;&#25511;&#21046;&#20301;APX&#12290;</li></ul></div>
<div class="figure"><a name="idp80941052"></a><p class="title"><b>&#22270; 66. &#21521;&#21069;&#20860;&#23481;&#30340;&#19968;&#32423;&#39029;&#34920;&#25551;&#36848;&#31526;&#26684;&#24335;</b></p><div class="figure-contents"><div><img src="images/pg_armv45_l1.jpg" alt="&#21521;&#21069;&#20860;&#23481;&#30340;&#19968;&#32423;&#39029;&#34920;&#25551;&#36848;&#31526;&#26684;&#24335;"></div></div></div><br class="figure-break">
<div class="figure"><a name="idp80941428"></a><p class="title"><b>&#22270; 67. &#21521;&#21069;&#20860;&#23481;&#30340;&#20108;&#32423;&#39029;&#34920;&#25551;&#36848;&#31526;&#26684;&#24335;</b></p><div class="figure-contents"><div><img src="images/pg_armv45_l2.jpg" alt="&#21521;&#21069;&#20860;&#23481;&#30340;&#20108;&#32423;&#39029;&#34920;&#25551;&#36848;&#31526;&#26684;&#24335;"></div></div></div><br class="figure-break">
Linux&#20351;&#29992;ARMv6&#29305;&#26377;&#30340;MMU&#39029;&#34920;&#25551;&#36848;&#31526;&#26684;&#24335;&#65292;&#23427;&#20204;&#30340;&#26631;&#24535;&#20301;&#25551;&#36848;&#22914;&#19979;&#65306;
<div class="figure"><a name="idp80942100"></a><p class="title"><b>&#22270; 68. ARMv6&#19968;&#32423;&#39029;&#34920;&#25551;&#36848;&#31526;&#26684;&#24335;</b></p><div class="figure-contents"><div><img src="images/pg_armv6_l1.jpg" alt="ARMv6&#19968;&#32423;&#39029;&#34920;&#25551;&#36848;&#31526;&#26684;&#24335;"></div></div></div><br class="figure-break">
	<div class="table"><a name="idp80943140"></a><p class="title"><b>&#34920; 14. ARMv6&#19968;&#32423;&#39029;&#34920;&#25551;&#36848;&#31526;&#27604;&#29305;&#20301;&#21547;&#20041;</b></p><div class="table-contents">
	<table summary="ARMv6&#19968;&#32423;&#39029;&#34920;&#25551;&#36848;&#31526;&#27604;&#29305;&#20301;&#21547;&#20041;" border="1"><colgroup><col><col><col></colgroup><thead><tr><th>&#20301;</th><th>&#26631;&#24535;</th><th>&#21547;&#20041;</th></tr></thead><tbody><tr><td>b[1:0]</td><td>&#31867;&#22411;</td><td>&#25351;&#31034;&#39029;&#34920;&#31867;&#22411;:b00 &#38169;&#35823;&#39033;&#65307;b11 &#20445;&#30041;&#65307;b01&#31895;&#39029;&#34920;&#65292;&#23427;&#25351;&#21521;&#20108;&#32423;&#39029;&#34920;&#22522;&#22336;&#12290;<br>b10:1MB&#22823;&#23567;&#27573;&#39029;&#34920;(b[18]&#32622;0)&#25110;16M&#22823;&#23567;&#36229;&#32423;&#27573;&#39029;&#34920;(b[18]&#32622;1)</td></tr><tr><td>b[2]</td><td>B<sup>[<a name="idp80946084" href="#ftn.idp80946084" class="footnote">a</a>]</sup></td><td>&#20889;&#32531;&#20914;&#20351;&#33021;<sup>[<a name="idp80946948" href="#ftn.idp80946948" class="footnote">b</a>]</sup></td></tr><tr><td>b[4]</td><td>Execute-Never(XN)</td><td>&#31105;&#27490;&#25191;&#34892;&#26631;&#24535;:1&#65292;&#31105;&#27490;&#25191;&#34892;&#65307;0&#65306;&#21487;&#25191;&#34892;</td></tr><tr><td>b[5:8]</td><td>&#22495;(domain)</td><td>&#25351;&#26126;&#25152;&#23646;16&#20010;&#22495;&#30340;&#21738;&#20010;&#22495;&#65292;&#35775;&#38382;&#26435;&#38480;&#30001;CP15&#30340;c3&#23492;&#23384;&#22120;&#25454;&#23450;</td></tr><tr><td>b[9]</td><td>P(ECC Enable)</td><td>ECC&#20351;&#33021;&#26631;&#24535;&#65292;1&#65306;&#35813;&#39029;&#34920;&#26144;&#23556;&#21306;&#20351;&#33021;ECC&#26657;&#39564;<sup>[<a name="idp80948996" href="#ftn.idp80948996" class="footnote">c</a>]</sup></td></tr><tr><td>b[10:11]</td><td>AP(Access Permissions)</td><td>&#35775;&#38382;&#26435;&#38480;&#20301;&#65292;&#20855;&#20307;&#35265;&#35775;&#38382;&#26435;&#38480;&#21015;&#34920;</td></tr><tr><td>b[12:14]</td><td>TEX(Type Extension Field)</td><td>&#25193;&#23637;&#31867;&#22411;&#65292;&#19982;B&#65292;C&#26631;&#24535;&#21327;&#21516;&#25511;&#21046;&#20869;&#23384;&#35775;&#38382;&#31867;&#22411;</td></tr><tr><td>bit[15]</td><td>APX(Access Permissions Extension Bit)</td><td>&#25193;&#23637;&#35775;&#38382;&#26435;&#38480;&#20301;</td></tr><tr><td>bit[16]</td><td>S(Shared)</td><td>&#20849;&#20139;&#35775;&#38382;</td></tr><tr><td>bit[17]</td><td>nG(Not-Global)</td><td>&#20840;&#23616;&#35775;&#38382;</td></tr><tr><td>bit[18]</td><td>0/1</td><td>&#27573;&#39029;&#34920;&#21644;&#36229;&#32423;&#27573;&#39029;&#34920;&#24320;&#20851;</td></tr><tr><td>bit[19]</td><td>NS</td><td> </td></tr></tbody><tbody class="footnotes"><tr><td colspan="3"><div class="footnote"><p><sup>[<a name="ftn.idp80946084" href="#idp80946084" class="para">a</a>] </sup>&#39640;&#36895;&#32531;&#23384;&#21644;&#20889;&#32531;&#23384;&#30340;&#24341;&#20837;&#26159;&#22522;&#20110;&#22914;&#19979;&#20107;&#23454;&#65292;&#21363;&#22788;&#29702;&#22120;&#36895;&#24230;&#36828;&#36828;&#39640;&#20110;&#23384;&#20648;&#22120;&#35775;&#38382;&#36895;&#24230;&#65307;&#22914;&#26524;&#23384;&#20648;&#22120;&#35775;&#38382;&#25104;&#20026;&#31995;&#32479;&#24615;&#33021;&#30340;&#29942;&#39048;&#65292;&#21017;&#22788;&#29702;&#22120;&#20877;&#24555;&#20063;&#26159;&#28010;&#36153;&#65292;&#22240;&#20026;&#22788;&#29702;&#22120;&#38656;&#35201;&#32791;&#36153;&#22823;&#37327;&#30340;&#26102;&#38388;&#22312;&#31561;&#24453;&#23384;&#20648;&#22120;&#19978;&#38754;&#12290;&#39640;&#36895;&#32531;&#23384;&#27491;&#26159;&#29992;&#26469;&#35299;&#20915;&#36825;&#20010;&#38382;&#39064;&#65292;&#23427;&#21487;&#20197;&#23384;&#20648;&#26368;&#36817;&#24120;&#29992;&#30340;&#20195;&#30721;&#21644;&#25968;&#25454;&#65292;&#20197;&#26368;&#24555;&#30340;&#36895;&#24230;&#25552;&#20379;&#32473;CPU&#22788;&#29702;(CPU&#35775;&#38382;Cache&#19981;&#38656;&#35201;&#31561;&#24453;)&#12290;
</p></div><div class="footnote"><p><sup>[<a name="ftn.idp80946948" href="#idp80946948" class="para">b</a>] </sup>SBZ&#24847;&#21619;&#32622;0&#65292;&#35813;&#20301;&#22312;&#31895;&#39029;&#34920;&#20013;&#32622;0&#12290;</p></div><div class="footnote"><p><sup>[<a name="ftn.idp80948996" href="#idp80948996" class="para">c</a>] </sup>ARM1176JZF-S&#22788;&#29702;&#22120;&#19981;&#25903;&#25345;&#35813;&#26631;&#24535;&#20301;&#12290;</p></div></td></tr></tbody></table>
	</div></div><br class="table-break">
Linux &#22312;ARM&#20307;&#31995;&#26550;&#26500;&#30340;Hardware page table&#22836;&#25991;&#20214;&#20013;&#36890;&#36807;&#23439;&#23450;&#20041;&#20102;&#36825;&#20123;&#20301;&#12290;
<pre class="programlisting">
arch/arm/include/asm/pgtable-hwdef.h

/*
 * Hardware page table definitions.
 *
 * + Level 1 descriptor (PMD)
 *   - common
 */
#define PMD_TYPE_MASK           (3 &lt;&lt; 0) // &#33719;&#21462;&#19968;&#32423;&#39029;&#34920;&#31867;&#22411;&#30340;&#25513;&#30721;&#65292;&#23427;&#21462;bit[0:1]
#define PMD_TYPE_FAULT          (0 &lt;&lt; 0) // &#32622;bit[0:1]&#20026;b00&#65292;&#38169;&#35823;&#39033;
#define PMD_TYPE_TABLE          (1 &lt;&lt; 0) // &#32622;bit[0:1]&#20026;b01&#65292;&#31895;&#39029;&#34920;
#define PMD_TYPE_SECT           (2 &lt;&lt; 0) // &#32622;bit[0:1]&#20026;b10&#65292;&#27573;&#39029;&#34920;
#define PMD_BIT4                (1 &lt;&lt; 4) // &#23450;&#20041;bit[4]&#65292;&#31105;&#27490;&#25191;&#34892;&#26631;&#24535;&#20301;
#define PMD_DOMAIN(x)           ((x) &lt;&lt; 5) // &#33719;&#21462;&#22495;&#26631;&#24535;&#20301;b[5:8]
#define PMD_PROTECTION          (1 &lt;&lt; 9)   // b[9]ECC&#20351;&#33021;&#26631;&#24535;
</pre>
&#20197;&#19978;&#23450;&#20041;&#20102;&#19968;&#32423;&#39029;&#34920;&#30340;&#30456;&#20851;&#26631;&#24535;&#20301;&#12290;Linux&#20351;&#29992;&#27573;&#39029;&#34920;&#20316;&#20026;&#19968;&#32423;&#39029;&#34920;&#65292;&#31895;&#39029;&#34920;&#20316;&#20026;&#20108;&#32423;&#39029;&#34920;&#30340;&#22522;&#22336;&#39029;&#34920;&#12290;&#27573;&#39029;&#34920;&#30340;&#26631;&#24535;&#20301;&#23450;&#20041;&#22914;&#19979;&#65306;
<pre class="programlisting">
#define PMD_SECT_BUFFERABLE     (1 &lt;&lt; 2)	
#define PMD_SECT_CACHEABLE      (1 &lt;&lt; 3)
#define PMD_SECT_XN             (1 &lt;&lt; 4)        /* v6 */
#define PMD_SECT_AP_WRITE       (1 &lt;&lt; 10)
#define PMD_SECT_AP_READ        (1 &lt;&lt; 11)
#define PMD_SECT_TEX(x)         ((x) &lt;&lt; 12)     /* v5 */
#define PMD_SECT_APX            (1 &lt;&lt; 15)       /* v6 */
#define PMD_SECT_S              (1 &lt;&lt; 16)       /* v6 */
#define PMD_SECT_nG             (1 &lt;&lt; 17)       /* v6 */
#define PMD_SECT_SUPER          (1 &lt;&lt; 18)       /* v6 */
</pre>
<div class="figure"><a name="idp80955588"></a><p class="title"><b>&#22270; 69. ARMv6&#20108;&#32423;&#39029;&#34920;&#22522;&#22336;&#26684;&#24335;</b></p><div class="figure-contents"><div><img src="images/pg_armv6_l2.jpg" alt="ARMv6&#20108;&#32423;&#39029;&#34920;&#22522;&#22336;&#26684;&#24335;"></div></div></div><br class="figure-break">
&#20108;&#32423;&#39029;&#34920;&#30456;&#21516;&#26631;&#24535;&#20301;&#30340;&#21547;&#20041;&#19982;&#19968;&#32423;&#39029;&#34920;&#30456;&#21516;&#65292;&#36825;&#37324;&#19981;&#20877;&#21333;&#29420;&#21015;&#20986;&#12290;&#27880;&#24847;&#23427;&#30340;b[1]&#20026;1&#26102;&#65292;b[0]&#34920;&#31034;&#31105;&#27490;&#25191;&#34892;&#26631;&#24535;&#12290;Linux&#23545;&#20108;&#32423;&#39029;&#34920;&#20013;&#30340;&#26631;&#24535;&#20301;&#23450;&#20041;&#22914;&#19979;&#65306;
<pre class="programlisting">
/*
 * + Level 2 descriptor (PTE)
 *   - common
 */
#define PTE_TYPE_MASK           (3 &lt;&lt; 0) // &#33719;&#21462;&#20108;&#32423;&#39029;&#34920;&#31867;&#22411;&#30340;&#25513;&#30721;&#65292;&#23427;&#21462;bit[0:1]
#define PTE_TYPE_FAULT          (0 &lt;&lt; 0) // &#32622;bit[0:1]&#20026;b00&#65292;&#38169;&#35823;&#39033;
#define PTE_TYPE_LARGE          (1 &lt;&lt; 0) // &#32622;bit[0:1]&#20026;b01&#65292;&#22823;&#39029;&#34920;(64K)
#define PTE_TYPE_SMALL          (2 &lt;&lt; 0) // &#32622;bit[0:1]&#20026;b10&#65292;&#25193;&#23637;&#23567;&#39029;&#34920;(4K)
#define PTE_TYPE_EXT            (3 &lt;&lt; 0) // &#20351;&#33021;&#31105;&#27490;&#25191;&#34892;&#26631;&#24535;&#30340;&#25193;&#23637;&#23567;&#39029;&#34920;(4K)
#define PTE_BUFFERABLE          (1 &lt;&lt; 2) // B&#26631;&#24535;
#define PTE_CACHEABLE           (1 &lt;&lt; 3) // C&#26631;&#24535;
</pre>
Linux&#20108;&#32423;&#39029;&#34920;&#20351;&#29992;&#25193;&#23637;&#23567;&#39029;&#34920;&#65292;&#36825;&#26679;&#27599;&#20010;&#20108;&#32423;&#39029;&#34920;&#21487;&#20197;&#34920;&#31034;&#36890;&#24120;&#30340;1&#20010;&#39029;&#38754;&#22823;&#23567;(4K)&#12290;Linux&#23545;&#20108;&#32423;&#39029;&#34920;&#26631;&#24535;&#20301;&#30340;&#23450;&#20041;&#22914;&#19979;&#65306;
<pre class="programlisting">
/*
 *   - extended small page/tiny page
 */
#define PTE_EXT_XN              (1 &lt;&lt; 0)        /* v6 */
#define PTE_EXT_AP_MASK         (3 &lt;&lt; 4)
#define PTE_EXT_AP0             (1 &lt;&lt; 4)
#define PTE_EXT_AP1             (2 &lt;&lt; 4)
#define PTE_EXT_AP_UNO_SRO      (0 &lt;&lt; 4)
#define PTE_EXT_AP_UNO_SRW      (PTE_EXT_AP0)
#define PTE_EXT_AP_URO_SRW      (PTE_EXT_AP1)
#define PTE_EXT_AP_URW_SRW      (PTE_EXT_AP1|PTE_EXT_AP0)
#define PTE_EXT_TEX(x)          ((x) &lt;&lt; 6)      /* v5 */
#define PTE_EXT_APX             (1 &lt;&lt; 9)        /* v6 */
#define PTE_EXT_COHERENT        (1 &lt;&lt; 9)        /* XScale3 */
#define PTE_EXT_SHARED          (1 &lt;&lt; 10)       /* v6 */
#define PTE_EXT_NG              (1 &lt;&lt; 11)       /* v6 */
</pre>
&#20197;&#19978;&#20004;&#31181;&#39029;&#34920;&#36716;&#25442;&#26426;&#21046;&#30001;CP15&#21327;&#22788;&#29702;&#22120;&#30340;&#25511;&#21046;&#23492;&#23384;&#22120;c1&#20013;&#30340;bit23&#26469;&#36873;&#25321;&#12290;bit23&#20026;0&#26102;&#20026;&#31532;&#19968;&#31181;&#26426;&#21046;&#65292;&#21542;&#21017;&#20026;&#31532;&#20108;&#31181;&#12290;&#22312;CPU&#21021;&#22987;&#21270;&#21518;&#35813;&#20301;&#30340;&#40664;&#35748;&#20540;&#20026;0&#12290;Linux&#22312;&#31995;&#32479;&#24341;&#23548;&#26102;&#20250;&#35774;&#32622;MMU&#30340;&#25511;&#21046;&#23492;&#23384;&#22120;&#30340;&#30456;&#20851;&#20301;&#65292;&#20854;&#20013;&#25226;bit23&#35774;&#32622;&#20026;1&#65292;&#25152;&#20197;Linux&#22312;ARMv6&#20307;&#31995;&#26550;&#26500;&#19978;&#37319;&#29992;&#30340;&#26159;ARMv6 MMU&#39029;&#34920;&#36716;&#25442;&#26426;&#21046;&#12290;
<pre class="programlisting">
arch/arm/mm/proc-v6.S

__v6_setup:
......
        adr     r5, v6_crval
        ldmia   r5, {r5, r6}
        mrc     p15, 0, r0, c1, c0, 0           @ read control register
        bic     r0, r0, r5                      @ clear bits them
        orr     r0, r0, r6                      @ set them
        mov     pc, lr                          @ return to head.S:__ret

        /*
         *         V X F   I D LR
         * .... ...E PUI. .T.T 4RVI ZFRS BLDP WCAM
         * rrrr rrrx xxx0 0101 xxxx xxxx x111 xxxx &lt; forced
         *         0 110       0011 1.00 .111 1101 &lt; we want
         */
        .type   v6_crval, #object
v6_crval:
        crval   clear=0x01e0fb7f, mmuset=0x00c0387d, ucset=0x00c0187c
</pre>
&#27880;&#24847;&#21040;v6_crval&#23450;&#20041;&#20102;&#19977;&#20010;&#24120;&#37327;&#65292;&#39318;&#20808;mrc&#25351;&#20196;&#35835;&#21462;c1&#21040;r0&#65292;&#28982;&#21518;&#28165;&#38500;clear&#24120;&#37327;&#25351;&#23450;&#30340;&#27604;&#29305;&#20301;&#65292;&#28982;&#21518;&#35774;&#32622;mmuset&#25351;&#23450;&#30340;&#27604;&#29305;&#20301;&#65292;&#20854;&#20013;bit23&#20026;1&#12290;
&#22312;mov pc, lr&#36339;&#36716;&#21518;&#23558;&#25191;&#34892;&#23450;&#20041;&#22312;head.S&#20013;&#30340;__enable_mmu&#20989;&#25968;&#65292;&#22312;&#36827;&#19968;&#27493;&#35843;&#33410;&#20854;&#23427;&#30340;&#27604;&#29305;&#20301;&#21518;&#26368;&#32456;&#23558;&#25226;r0&#20013;&#30340;&#20540;&#20889;&#22238;c1&#23492;&#23384;&#22120;&#12290;
</div>
<div class="sect2" title="12.5. &#39029;&#38754;&#35775;&#38382;&#25511;&#21046;"><div class="titlepage"><div><div><h3 class="title"><a name="idp80960292"></a>12.5. &#39029;&#38754;&#35775;&#38382;&#25511;&#21046;</h3></div></div></div>
&#22312;&#35848;&#21040;create_mapping&#20043;&#21069;&#65292;&#24517;&#39035;&#35828;&#26126;&#19968;&#19979;Linux&#26159;&#22914;&#20309;&#23454;&#29616;&#23545;&#39029;&#38754;&#30340;&#35775;&#38382;&#25511;&#21046;&#30340;&#12290;&#23427;&#23450;&#20041;&#20102;&#19968;&#20010;&#31867;&#22411;&#20026;struct mem_type&#30340;&#23616;&#37096;&#38745;&#24577;&#25968;&#32452;&#12290;&#26681;&#25454;&#19981;&#21516;&#30340;&#26144;&#23556;&#31867;&#22411;&#65292;&#23427;&#23450;&#20041;&#20102;&#19981;&#21516;&#30340;&#35775;&#38382;&#26435;&#38480;&#65292;&#23427;&#36890;&#36807;md&#21442;&#25968;&#20013;&#30340;type&#25104;&#21592;&#20256;&#36882;&#32473;create_mapping&#12290;
<pre class="programlisting">
arch/arm/include/asm/io.h
/*
 * Architecture ioremap implementation.
 */
#define MT_DEVICE               0
#define MT_DEVICE_NONSHARED     1
#define MT_DEVICE_CACHED        2
#define MT_DEVICE_WC            3

arch/arm/include/asm/mach/map.h
/* types 0-3 are defined in asm/io.h */
#define MT_UNCACHED             4
#define MT_CACHECLEAN           5
#define MT_MINICLEAN            6
#define MT_LOW_VECTORS          7
#define MT_HIGH_VECTORS         8
#define MT_MEMORY               9
#define MT_ROM                  10
</pre>
&#31995;&#32479;&#20013;&#23450;&#20041;&#20102;&#22810;&#20010;&#26144;&#23556;&#31867;&#22411;&#65292;&#26368;&#24120;&#29992;&#30340;&#26159;MT_MEMORY&#65292;&#23427;&#23545;&#24212;RAM;MT_DEVICE&#21017;&#23545;&#24212;&#20102;&#20854;&#20182;I/O&#35774;&#22791;&#65292;&#24212;&#29992;&#20110;ioremap;MT_ROM&#23545;&#24212;&#20110;ROM;MT_LOW_VECTORS&#23545;&#24212;0&#22320;&#22336;&#24320;&#22987;&#30340;&#21521;&#37327;;MT_HIGH_VECTORS&#23545;&#24212;&#39640;&#22320;&#22336;&#24320;&#22987;&#30340;&#21521;&#37327;&#65292;&#23427;&#26377;vector_base&#23439;&#20915;&#23450;&#12290;
<pre class="programlisting">
arch/arm/mm/mm.h

struct mem_type {
        unsigned int prot_pte;
        unsigned int prot_l1;
        unsigned int prot_sect;
        unsigned int domain;
};
</pre>
&#23613;&#31649;Linux&#22312;&#22810;&#25968;&#31995;&#32479;&#19978;&#23454;&#29616;&#25110;&#32773;&#27169;&#25311;&#20102;3&#32423;&#39029;&#34920;&#65292;&#20294;&#26159;&#22312;ARM Linux&#19978;&#23427;&#21482;&#23454;&#29616;&#20102;&#20027;&#39029;&#34920;&#21644;&#20004;&#32423;&#39029;&#34920;&#12290;&#20027;&#39029;&#34920;&#36890;&#36807;ARM CPU&#30340;&#27573;&#34920;&#23454;&#29616;&#65292;&#27573;&#34920;&#20013;&#30340;&#27599;&#20010;&#39029;&#34920;&#39033;&#31649;&#29702;1M&#30340;&#20869;&#23384;&#65292;&#34394;&#25311;&#22320;&#22336;&#21482;&#38656;&#35201;&#19968;&#27425;&#36716;&#25442;&#26082;&#21487;&#20197;&#24471;&#21040;&#29289;&#29702;&#22320;&#22336;&#65292;&#23427;&#36890;&#24120;&#23384;&#25918;&#22312;swapper_pg_dir&#24320;&#22987;&#30340;16K&#21306;&#22495;&#20869;&#12290;&#20004;&#32423;&#39029;&#34920;&#21482;&#26377;&#22312;&#34987;&#26144;&#23556;&#30340;&#29289;&#29702;&#20869;&#23384;&#22359;&#19981;&#28385;&#36275;1M&#30340;&#24773;&#20917;&#19979;&#25165;&#34987;&#20351;&#29992;&#65292;&#27492;&#26102;&#23427;&#30001;L1&#21644;L2&#32452;&#25104;&#12290;
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">prot_pte&#21644;prot_l1&#20998;&#21035;&#23545;&#24212;&#20004;&#32423;&#39029;&#34920;&#20013;&#30340;L2&#21644;L1&#65292;&#20998;&#21035;&#20195;&#34920;&#20102;&#39029;&#34920;&#39033;&#30340;&#35775;&#38382;&#25511;&#21046;&#20301;&#65292;&#20854;&#20013;prot_l1&#20013;&#36824;&#21253;&#21547;&#20869;&#23384;&#22495;</li><li class="listitem">prot_sect&#20195;&#34920;&#20027;&#39029;&#34920;&#30340;&#35775;&#38382;&#25511;&#21046;&#20301;&#21644;&#20869;&#23384;&#22495;&#12290;</li><li class="listitem">domain&#20195;&#34920;&#20102;&#20869;&#23384;&#22495;&#12290;&#22312;ARM&#22788;&#29702;&#22120;&#20013;&#65292;MMU&#23558;&#25972;&#20010;&#23384;&#20648;&#31354;&#38388;&#20998;&#25104;&#26368;&#22810;16&#20010;&#22495;&#65292;&#35760;&#20316;D0~D15&#65292;&#27599;&#20010;&#22495;&#23545;&#24212;&#19968;&#23450;&#30340;&#23384;&#20648;&#21306;&#22495;&#65292;&#35813;&#21306;&#22495;&#20855;&#26377;&#30456;&#21516;&#30340;&#35775;&#38382;&#25511;&#21046;&#23646;&#24615;&#12290;</li></ul></div>
<pre class="programlisting">
arch/arm/include/asm/domain.h

#define DOMAIN_KERNEL   0
#define DOMAIN_TABLE    0
#define DOMAIN_USER     1
#define DOMAIN_IO       2
</pre>
ARM Linux &#20013;&#21482;&#26159;&#29992;&#20102;16&#20010;&#22495;&#20013;&#30340;&#19977;&#20010;&#22495;D0-D2&#12290;&#23427;&#20204;&#30001;&#19978;&#38754;&#30340;&#23439;&#26469;&#23450;&#20041;&#65292;&#22312;&#31995;&#32479;&#24341;&#23548;&#26102;&#21021;&#22987;&#21270;MMU&#30340;&#36807;&#31243;&#20013;&#23558;&#23545;&#36825;&#19977;&#20010;&#22495;&#35774;&#32622;&#22495;&#35775;&#38382;&#26435;&#38480;&#12290;&#20197;&#19979;&#26159;&#20869;&#23384;&#31354;&#38388;&#21644;&#22495;&#30340;&#23545;&#24212;&#34920;&#65306;
	<div class="table"><a name="idp80965060"></a><p class="title"><b>&#34920; 15. &#20869;&#23384;&#31354;&#38388;&#21644;&#22495;&#30340;&#23545;&#24212;&#34920;</b></p><div class="table-contents">
	<table summary="&#20869;&#23384;&#31354;&#38388;&#21644;&#22495;&#30340;&#23545;&#24212;&#34920;" border="1"><colgroup><col><col></colgroup><thead><tr><th>&#20869;&#23384;&#31354;&#38388;</th><th>&#22495;</th></tr></thead><tbody><tr><td>&#35774;&#22791;&#31354;&#38388;</td><td>DOMAIN_IO</td></tr><tr><td>&#20869;&#37096;&#39640;&#36895;SRAM&#31354;&#38388;/&#20869;&#37096;MINI Cache&#31354;&#38388;</td><td>DOMAIN_KERNEL</td></tr><tr><td>RAM&#20869;&#23384;&#31354;&#38388;/ROM&#20869;&#23384;&#31354;&#38388;</td><td>DOMAIN_KERNEL</td></tr><tr><td>&#39640;&#20302;&#31471;&#20013;&#26029;&#21521;&#37327;&#31354;&#38388;</td><td>DOMAIN_USER</td></tr></tbody></table>
	</div></div><br class="table-break">
&#22312;ARM&#22788;&#29702;&#22120;&#20013;&#65292;MMU&#20013;&#30340;&#27599;&#20010;&#22495;&#30340;&#35775;&#38382;&#26435;&#38480;&#20998;&#21035;&#30001;CP15&#30340;C3&#23492;&#23384;&#22120;&#20013;&#30340;&#20004;&#20301;&#26469;&#35774;&#23450;&#65292;c3&#23492;&#23384;&#22120;&#30340;&#23567;&#20026;32bits&#65292;&#21018;&#22909;&#21487;&#20197;&#35774;&#32622;16&#20010;&#22495;&#30340;&#35775;&#38382;&#26435;&#38480;&#12290;&#19979;&#34920;&#21015;&#20986;&#20102;&#22495;&#30340;&#35775;&#38382;&#25511;&#21046;&#23383;&#27573;&#19981;&#21516;&#21462;&#20540;&#21450;&#21547;&#20041;&#65306;
	<div class="table"><a name="idp80968796"></a><p class="title"><b>&#34920; 16. ARM&#20869;&#23384;&#35775;&#38382;&#25511;&#21046;&#23383;</b></p><div class="table-contents">
	<table summary="ARM&#20869;&#23384;&#35775;&#38382;&#25511;&#21046;&#23383;" border="1"><colgroup><col><col><col></colgroup><thead><tr><th>&#20540;</th><th>&#35775;&#38382;&#31867;&#22411;</th><th>&#21547;&#20041;</th></tr></thead><tbody><tr><td>0b00</td><td>&#26080;&#35775;&#38382;&#26435;&#38480;
</td><td>&#27492;&#26102;&#35775;&#38382;&#35813;&#22495;&#23558;&#20135;&#29983;&#35775;&#38382;&#22833;&#25928;
</td></tr><tr><td>0b01</td><td>&#29992;&#25143;(client)</td><td>&#26681;&#25454;CP15&#30340;C1&#25511;&#21046;&#23492;&#23384;&#22120;&#20013;&#30340;R&#21644;S&#20301;&#20197;&#21450;&#39029;&#34920;&#20013;&#22320;&#22336;&#21464;&#25442;&#26465;&#30446;&#20013;&#30340;&#35775;&#38382;&#26435;&#38480;&#25511;&#21046;&#20301;AP&#26469;&#30830;&#23450;&#26159;&#21542;&#20801;&#35768;&#21508;&#31181;&#31995;&#32479;&#24037;&#20316;&#27169;&#24335;&#30340;&#23384;&#20648;&#35775;&#38382;
</td></tr><tr><td>0b10</td><td>&#20445;&#30041;</td><td>&#20351;&#29992;&#35813;&#20540;&#20250;&#20135;&#29983;&#19981;&#21487;&#39044;&#30693;&#30340;&#32467;&#26524;</td></tr><tr><td>0b11</td><td>&#31649;&#29702;&#32773;(Manager)</td><td>&#19981;&#32771;&#34385;CP15&#30340;C1&#25511;&#21046;&#23492;&#23384;&#22120;&#20013;&#30340;R&#21644;S&#20301;&#20197;&#21450;&#39029;&#34920;&#20013;&#22320;&#22336;&#21464;&#25442;&#26465;&#30446;&#20013;&#30340;&#35775;&#38382;&#26435;&#38480;&#25511;&#21046;&#20301;AP&#65292;&#22312;&#36825;&#31181;&#24773;&#20917;&#19979;&#19981;&#31649;&#31995;&#32479;&#24037;&#20316;&#22312;&#29305;&#26435;&#27169;&#24335;&#36824;&#26159;&#29992;&#25143;&#27169;&#24335;&#37117;&#19981;&#20250;&#20135;&#29983;&#35775;&#38382;&#22833;&#25928;</td></tr></tbody></table>
	</div></div><br class="table-break">
Linux&#23450;&#20041;&#20102;&#20854;&#20013;&#21487;&#20197;&#20351;&#29992;&#30340;&#19977;&#31181;&#22495;&#25511;&#21046;&#65306;
<pre class="programlisting">
arch/arm/include/asm/domain.h

#define DOMAIN_NOACCESS 0
#define DOMAIN_CLIENT   1
#define DOMAIN_MANAGER  3
</pre>
Linux&#22312;&#31995;&#32479;&#24341;&#23548;&#35774;&#32622;MMU&#26102;&#21021;&#22987;&#21270;c3&#23492;&#23384;&#22120;&#26469;&#23454;&#29616;&#23545;&#20869;&#23384;&#22495;&#30340;&#35775;&#38382;&#25511;&#21046;&#12290;&#20854;&#20013;&#23545;DOMAIN_USER&#65292;DOMAIN_KERNEL&#21644;DOMAIN_TABLE&#22343;&#35774;&#32622;DOMAIN_MANAGER&#26435;&#38480;;&#23545;DOMAIN_IO&#35774;&#32622;DOMAIN_CLIENT&#26435;&#38480;&#12290;&#22914;&#26524;&#27492;&#26102;&#35835;&#21462;c3&#23492;&#23384;&#22120;&#65292;&#23427;&#30340;&#20540;&#24212;&#35813;&#26159;0x1f&#12290;
<pre class="programlisting">
arch/arm/include/asm/domain.h
#define domain_val(dom,type)    ((type) &lt;&lt; (2*(dom)))

arch/arm/kernel/head.S
    ......	
    mov     r5, #(domain_val(DOMAIN_USER, DOMAIN_MANAGER) | \
                  domain_val(DOMAIN_KERNEL, DOMAIN_MANAGER) | \
                  domain_val(DOMAIN_TABLE, DOMAIN_MANAGER) | \
                  domain_val(DOMAIN_IO, DOMAIN_CLIENT))
    mcr     p15, 0, r5, c3, c0, 0           @ load domain access register
    mcr     p15, 0, r4, c2, c0, 0           @ load page table pointer
    b       __turn_mmu_on
ENDPROC(__enable_mmu)
</pre>
&#22312;&#31995;&#32479;&#30340;&#24341;&#23548;&#36807;&#31243;&#20013;&#23545;&#36825;3&#20010;&#22495;&#30340;&#35775;&#38382;&#25511;&#21046;&#20301;&#24182;&#19981;&#26159;&#19968;&#25104;&#19981;&#21464;&#30340;&#65292;&#23427;&#25552;&#20379;&#20102;&#19968;&#20010;&#21517;&#20026;modify_domain&#30340;&#23439;&#26469;&#20462;&#25913;&#22495;&#35775;&#38382;&#25511;&#21046;&#20301;&#12290;&#31995;&#32479;&#22312;setup_arch&#20013;&#35843;&#29992;early_trap_init&#21518;&#65292;DOMAIN_USER&#30340;&#26435;&#38480;&#20301;&#23558;&#34987;&#35774;&#32622;&#25104;DOMAIN_CLIENT&#65292;&#27492;&#26102;&#23427;&#30340;&#20540;&#24212;&#35813;&#26159;0x17&#12290;
<pre class="programlisting">
arch/arm/include/asm/domain.h

#define set_domain(x)                                   \
        do {                                            \
        __asm__ __volatile__(                           \
        "mcr    p15, 0, %0, c3, c0      @ set domain"   \
          : : "r" (x));                                 \
        isb();                                          \
        } while (0)

#define modify_domain(dom,type)                                 \
        do {                                                    \
        struct thread_info *thread = current_thread_info();     \
        unsigned int domain = thread-&gt;cpu_domain;               \
        domain &amp;= ~domain_val(dom, DOMAIN_MANAGER);             \
        thread-&gt;cpu_domain = domain | domain_val(dom, type);    \
        set_domain(thread-&gt;cpu_domain);                         \
        } while (0)
</pre>
&#35775;&#38382;&#26435;&#38480;&#30001;CP15&#30340;c1&#25511;&#21046;&#23492;&#23384;&#22120;&#20013;&#30340;R&#21644;S&#20301;&#20197;&#21450;&#39029;&#34920;&#39033;&#20013;&#30340;&#35775;&#38382;&#26435;&#38480;&#25511;&#21046;&#20301;AP[0:1]&#20197;&#21450;&#35775;&#38382;&#26435;&#38480;&#25193;&#23637;&#20301;APX&#26469;&#30830;&#23450;&#65292;&#36890;&#36807;R&#21644;S&#30340;&#32452;&#21512;&#25511;&#21046;&#26041;&#24335;&#22312;&#31532;&#19968;&#39033;&#20013;&#35828;&#26126;&#65292;&#24182;&#19988;&#24050;&#19981;&#34987;&#25512;&#33616;&#20351;&#29992;&#12290;&#20855;&#20307;&#35828;&#26126;&#22914;&#19979;&#34920;&#25152;&#31034;&#12290;
	<div class="table"><a name="access_tab"></a><p class="title"><b>&#34920; 17. MMU&#20013;&#23384;&#20648;&#35775;&#38382;&#26435;&#38480;&#25511;&#21046;<sup>[<a name="idp80976924" href="#ftn.idp80976924" class="footnote">7</a>]</sup></b></p><div class="table-contents">
	<table summary="MMU&#20013;&#23384;&#20648;&#35775;&#38382;&#26435;&#38480;&#25511;&#21046;&#21442;&#32771;ARM1176JZF-S Revision: r0p7-&gt;6.5.2 Access permissions" border="1"><colgroup><col><col><col><col></colgroup><thead><tr><th>APX</th><th>AP[1:0]
</th><th>&#29305;&#26435;&#27169;&#24335;&#35775;&#38382;&#26435;&#38480;
</th><th>&#29992;&#25143;&#27169;&#24335;&#35775;&#38382;&#26435;&#38480;
</th></tr></thead><tbody><tr><td>0</td><td>b00</td><td>&#31105;&#27490;&#35775;&#38382;;S=1,R=0&#25110;S=0,R=1&#26102;&#21482;&#35835;</td><td>&#31105;&#27490;&#35775;&#38382;;S=1,R=0&#26102;&#21482;&#35835;</td></tr><tr><td>0</td><td>b01</td><td>&#35835;&#20889;</td><td>&#31105;&#27490;&#35775;&#38382;</td></tr><tr><td>0</td><td>b10</td><td>&#35835;&#20889;</td><td>&#21482;&#35835;</td></tr><tr><td>0</td><td>b11</td><td>&#35835;&#20889;</td><td>&#35835;&#20889;</td></tr><tr><td>1</td><td>b00</td><td>&#20445;&#30041;</td><td>&#20445;&#30041;</td></tr><tr><td>1</td><td>b01</td><td>&#21482;&#35835;</td><td>&#31105;&#27490;&#35775;&#38382;</td></tr><tr><td>1</td><td>b10</td><td>&#21482;&#35835;</td><td>&#21482;&#35835;</td></tr><tr><td>1</td><td>b11</td><td>&#21482;&#35835;</td><td>&#21482;&#35835;</td></tr></tbody><tbody class="footnotes"><tr><td colspan="4"><div class="footnote"><p><sup>[<a name="ftn.idp80976924" href="#idp80976924" class="para">7</a>] </sup>&#21442;&#32771;ARM1176JZF-S Revision: r0p7-&gt;6.5.2 Access permissions</p></div></td></tr></tbody></table>
	</div></div><br class="table-break">
<pre class="programlisting">
static struct mem_type mem_types[] = {
	......
	[MT_MEMORY] = {
		.prot_sect = PMD_TYPE_SECT | PMD_SECT_AP_WRITE,
		.domain    = DOMAIN_KERNEL,
	},
	......
};
</pre>
&#23545;&#20110;MT_MEMORY&#30340;&#20869;&#23384;&#26144;&#23556;&#31867;&#22411;&#65292;&#20381;&#25454;&#27573;&#39029;&#34920;&#30340;&#21508;&#20301;&#21151;&#33021;&#65292;&#23450;&#20041;&#20102;&#22914;&#19979;&#30340;&#23439;&#65292;&#26174;&#28982;PMD_TYPE_SECT&#23450;&#20041;&#20102;&#27573;&#39029;&#34920;&#31867;&#22411;0b10&#65292;PMD_SECT_AP_WRITE&#21644;PMD_SECT_AP_READ&#21017;&#23545;&#24212;AP[0]&#21644;AP[1]&#35775;&#38382;&#26435;&#38480;&#25511;&#21046;&#20301;&#12290;&#26681;&#25454;<a class="xref" href="ar01s12.html#access_tab" title="&#34920; 17. MMU&#20013;&#23384;&#20648;&#35775;&#38382;&#26435;&#38480;&#25511;&#21046;">&#34920; 17 &#8220;MMU&#20013;&#23384;&#20648;&#35775;&#38382;&#26435;&#38480;&#25511;&#21046;&#8221;</a>&#65292;&#22312;&#20351;&#29992;AP[0:1]&#36827;&#34892;&#26435;&#38480;&#25511;&#21046;&#26102;&#65292;CP15&#20013;&#30340;C1&#23492;&#23384;&#22120;&#20013;&#30340;S&#21644;R&#26631;&#24535;&#20301;&#19981;&#24433;&#21709;&#26435;&#38480;&#65292;&#26681;&#25454;AP&#26435;&#38480;&#20301;&#30340;&#24847;&#20041;&#65292;&#24182;&#19981;&#33021;&#30452;&#25509;&#26681;&#25454;&#23439;&#30340;&#21518;&#32512;&#21517;&#24471;&#20986;&#26159;&#23545;&#35835;&#36824;&#26159;&#20889;&#30340;&#25511;&#21046;&#12290;
<pre class="programlisting">
arch/arm/include/asm/pgtable-hwdef.h

#define PMD_TYPE_TABLE          (1 &lt;&lt; 0)
#define PMD_TYPE_SECT           (2 &lt;&lt; 0)
#define PMD_BIT4                (1 &lt;&lt; 4)
#define PMD_DOMAIN(x)           ((x) &lt;&lt; 5)
......
#define PMD_SECT_AP_WRITE       (1 &lt;&lt; 10)
#define PMD_SECT_AP_READ        (1 &lt;&lt; 11)
</pre>
&#19968;&#20010;&#25551;&#36848;&#20102;&#24403;&#21069;&#31995;&#32479;mem_types&#25551;&#36848;&#30340;&#25152;&#26377;&#20869;&#23384;&#26144;&#23556;&#31867;&#22411;&#26435;&#38480;&#25511;&#21046;&#30340;&#21015;&#34920;&#22914;&#19979;&#25152;&#31034;&#65306;
	<div class="table"><a name="idp80986572"></a><p class="title"><b>&#34920; 18. ARM Linux&#20869;&#23384;&#26144;&#23556;&#26435;&#38480;&#25511;&#21046;<sup>[<a name="idp80986764" href="#ftn.idp80986764" class="footnote">8</a>]</sup></b></p><div class="table-contents">
	<table summary="ARM Linux&#20869;&#23384;&#26144;&#23556;&#26435;&#38480;&#25511;&#21046;&#35813;&#34920;&#25551;&#36848;&#20102;Linux2.6.28 ARM&#20307;&#31995;&#26550;&#26500;&#30340;mem_types&#20869;&#23384;&#26144;&#23556;&#26435;&#38480;&#25511;&#21046;" border="1"><colgroup><col><col><col><col><col></colgroup><thead><tr><th>&#20869;&#23384;&#26144;&#23556;&#31867;&#22411;</th><th>&#22495;&#23450;&#20041;</th><th>&#27573;&#39029;&#34920;&#39033;&#26435;&#38480;&#23450;&#20041;</th><th>L1&#39029;&#34920;&#39033;&#26435;&#38480;&#23450;&#20041;</th><th>PTE&#39033;&#26435;&#38480;&#23450;&#20041;</th></tr></thead><tbody><tr><td>MT_DEVICE</td><td>DOMAIN_IO</td><td>PROT_SECT_DEVICE<sup>[<a name="idp80989348" href="#ftn.idp80989348" class="footnote">a</a>]</sup> <br> PMD_SECT_S</td><td>PMD_TYPE_TABLE</td><td>PROT_PTE_DEVICE<sup>[<a name="idp80989436" href="#ftn.idp80989436" class="footnote">b</a>]</sup> <br> L_PTE_MT_DEV_SHARED <br> L_PTE_SHARED</td></tr><tr><td>MT_DEVICE_NONSHARED</td><td>DOMAIN_IO</td><td>PROT_SECT_DEVICE </td><td>PMD_TYPE_TABLE</td><td>PROT_PTE_DEVICE  <br> L_PTE_MT_DEV_NONSHARED</td></tr><tr><td>MT_DEVICE_CACHED</td><td>DOMAIN_IO</td><td>PROT_SECT_DEVICE<br> PMD_SECT_WB</td><td>PMD_TYPE_TABLE</td><td>PROT_PTE_DEVICE   <br>  L_PTE_MT_DEV_CACHED</td></tr><tr><td>MT_DEVICE_WC</td><td>DOMAIN_IO</td><td>PROT_SECT_DEVICE</td><td>PMD_TYPE_TABLE</td><td>ROT_PTE_DEVICE <br> L_PTE_MT_DEV_WC</td></tr><tr><td>MT_UNCACHED</td><td>DOMAIN_IO</td><td>PMD_TYPE_SECT <br> PMD_SECT_XN</td><td>PMD_TYPE_TABLE</td><td>PROT_PTE_DEVICE</td></tr><tr><td>MT_CACHECLEAN</td><td>DOMAIN_KERNEL</td><td>PMD_TYPE_SECT <br> PMD_SECT_XN</td><td> </td><td> </td></tr><tr><td>MT_MINICLEAN</td><td>DOMAIN_KERNEL</td><td>PMD_TYPE_SECT <br> PMD_SECT_XN <br> PMD_SECT_MINICACHE,</td><td> </td><td> </td></tr><tr><td>MT_LOW_VECTORS</td><td>DOMAIN_USER</td><td> </td><td>PMD_TYPE_TABLE</td><td>L_PTE_PRESENT <br> L_PTE_YOUNG <br> L_PTE_DIRTY <br>L_PTE_EXEC</td></tr><tr><td>MT_HIGH_VECTORS</td><td>DOMAIN_USER</td><td> </td><td>PMD_TYPE_TABLE</td><td>L_PTE_PRESENT <br> L_PTE_YOUNG <br> L_PTE_DIRTY <br>	L_PTE_USER <br> L_PTE_EXEC</td></tr><tr><td>MT_MEMORY</td><td>DOMAIN_KERNEL</td><td>PMD_TYPE_SECT <br> PMD_SECT_AP_WRITE</td><td> </td><td> </td></tr><tr><td>MT_ROM</td><td>DOMAIN_KERNEL</td><td>PMD_TYPE_SECT</td><td> </td><td> </td></tr></tbody><tbody class="footnotes"><tr><td colspan="5"><div class="footnote"><p><sup>[<a name="ftn.idp80986764" href="#idp80986764" class="para">8</a>] </sup>&#35813;&#34920;&#25551;&#36848;&#20102;Linux2.6.28 ARM&#20307;&#31995;&#26550;&#26500;&#30340;mem_types&#20869;&#23384;&#26144;&#23556;&#26435;&#38480;&#25511;&#21046;</p></div><div class="footnote"><p><sup>[<a name="ftn.idp80989348" href="#idp80989348" class="para">a</a>] </sup>&#22312;mmu.c&#20013;&#23427;&#34987;&#23450;&#20041;&#20026; PMD_TYPE_SECT|PMD_SECT_AP_WRITE</p></div><div class="footnote"><p><sup>[<a name="ftn.idp80989436" href="#idp80989436" class="para">b</a>] </sup>&#22312;mmu.c&#20013;&#23427;&#34987;&#23450;&#20041;&#20026; L_PTE_PRESENT|L_PTE_YOUNG|L_PTE_DIRTY|L_PTE_WRITE</p></div></td></tr></tbody></table>
	</div></div><br class="table-break">
build_mem_type_table&#20989;&#25968;&#22312;paging_init&#25191;&#34892;&#30340;&#24320;&#22987;&#34987;&#35843;&#29992;&#65292;&#23427;&#23558;&#26681;&#25454;&#24403;&#21069;CPU&#30340;&#29305;&#24615;&#36827;&#19968;&#27493;&#35843;&#25972;&#36825;&#20123;&#35775;&#38382;&#26435;&#38480;&#20301;&#12290;
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">MT_MEMORY&#34987;&#29992;&#26469;&#26144;&#23556;&#20027;&#23384;RAM&#12290;&#23427;&#21482;&#26377;&#27573;&#39029;&#34920;&#65292;&#23545;&#24212;&#35775;&#38382;&#26435;&#38480;&#20013;&#30340;&#31532;&#20108;&#26465;:&#29305;&#26435;&#27169;&#24335;&#21487;&#20197;&#35835;&#20889;&#65292;&#29992;&#25143;&#27169;&#24335;&#31105;&#27490;&#35775;&#38382;&#12290;</li><li class="listitem"></ul></div>
</div>
<div class="sect2" title="12.6. create_mapping"><div class="titlepage"><div><div><h3 class="title"><a name="idp80960420"></a>12.6. create_mapping</h3></div></div></div>
create_mapping&#26159;&#23436;&#25104;&#39029;&#34920;&#21019;&#30340;&#26680;&#24515;&#20989;&#25968;&#12290;&#23427;&#30340;&#22768;&#26126;&#22914;&#19979;&#65306;
<p>
</p><pre class="programlisting">
arch/arm/mm/mmu.c

void __init create_mapping(struct map_desc *md);
</pre><p>
create_mapping&#21482;&#26377;&#19968;&#20010;&#31867;&#22411;&#20026;struct map_desc&#30340;&#21442;&#25968;&#12290;&#36825;&#26159;&#19968;&#20010;&#38750;&#24120;&#31616;&#21333;&#30340;&#21442;&#25968;&#65292;&#20294;&#26159;&#21253;&#21547;&#20102;&#21019;&#24314;&#39029;&#34920;&#30456;&#20851;&#30340;&#25152;&#26377;&#20449;&#24687;&#12290;
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">virtual&#35760;&#24405;&#20102;&#26144;&#23556;&#21040;&#30340;&#34394;&#25311;&#22320;&#22336;&#30340;&#24320;&#22987;&#12290;</li><li class="listitem">pfn&#25351;&#26126;&#20102;&#34987;&#26144;&#23556;&#30340;&#29289;&#29702;&#20869;&#23384;&#30340;&#36215;&#22987;&#39029;&#26694;&#12290;</li><li class="listitem">length&#25351;&#26126;&#20102;&#34987;&#26144;&#23556;&#30340;&#29289;&#29702;&#20869;&#23384;&#30340;&#22823;&#23567;&#65292;&#27880;&#24847;&#36825;&#37324;&#19981;&#26159;&#39029;&#26694;&#22823;&#23567;&#12290;&#23545;&#20110;256M&#30340;&#29289;&#29702;&#20869;&#23384;&#65292;&#36825;&#37324;&#30340;&#20540;&#20026;0x10000000&#12290;</li><li class="listitem">type&#25351;&#26126;&#26144;&#23556;&#31867;&#22411;&#65292;MT_xxx&#65292;&#20915;&#23450;&#20102;&#30456;&#24212;&#26144;&#23556;&#39029;&#38754;&#30340;&#35775;&#38382;&#26435;&#38480;&#12290;</li></ul></div><p>
</p><pre class="programlisting">
arch/arm/include/asm/mach/map.h

struct map_desc {
        unsigned long virtual;
        unsigned long pfn;
        unsigned long length;
        unsigned int type;
};
</pre><p>
&#22312;Bootmem&#26426;&#21046;&#24212;&#29992;&#20013;&#26377;&#25552;&#21040;&#65292;&#31995;&#32479;&#20013;&#25152;&#26377;&#30340;&#20869;&#23384;&#22359;&#37117;&#22312;&#21551;&#21160;&#26102;&#34987;&#27880;&#20876;&#21040;meminfo&#20013;&#20197;struct membank&#31867;&#22411;&#30340;&#25968;&#32452;&#24418;&#24335;&#23384;&#22312;&#12290;map_memory_bank&#30340;&#20316;&#29992;&#23601;&#26159;&#23558;&#20197;struct membank&#31867;&#22411;&#30340;&#20869;&#23384;&#33410;&#28857;&#36716;&#25442;&#20026;struct map_desc&#31867;&#22411;&#28982;&#21518;&#20256;&#36882;&#32473;create_mapping&#12290;
</p><pre class="programlisting">
struct meminfo {
  .nr_banks = 1;
  bank[8] = 
  {
    {
      .start = 0x50000000;
      .size = 0x10000000;
      .node = 0;
    };
   ...
  }
};
</pre><p>
&#23545;&#20110;&#21482;&#26377;&#19968;&#20010;&#22823;&#23567;&#20026;256M&#29289;&#29702;RAM&#20869;&#23384;&#30340;&#31995;&#32479;&#26469;&#35828;&#65292;&#22914;&#26524;&#23427;&#20855;&#26377;&#20197;&#19978;&#30340;struct membank&#31867;&#22411;&#30340;&#20869;&#23384;&#20449;&#24687;&#65292;&#37027;&#20040;create_mapping&#24471;&#21040;&#30340;&#21442;&#25968;md&#22914;&#19979;&#25152;&#31034;&#65306;
</p><pre class="programlisting">
map_desc {
    .virtual = 0xc0000000;
    .pfn = 0x50000;
    .length = 0x10000000;
    .type = MT_MEMORY;
};

[MT_MEMORY] = {
	.prot_sect = PMD_TYPE_SECT | PMD_SECT_AP_WRITE,
	.domain    = DOMAIN_KERNEL,
}
</pre><p>
create_mapping&#20381;&#27425;&#23436;&#25104;&#20102;&#20197;&#19979;&#24037;&#20316;&#65306;
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">&#39318;&#20808;&#26681;&#25454;&#20256;&#20837;&#30340;virtual&#34394;&#25311;&#22320;&#22336;&#19982;&#20013;&#26029;&#21521;&#37327;&#36215;&#22987;&#22320;&#22336;&#27604;&#36739;&#65292;&#38500;&#29305;&#27530;&#30340;&#20013;&#26029;&#21521;&#37327;&#20351;&#29992;&#30340;&#34394;&#25311;&#22320;&#22336;&#21487;&#33021;&#33853;&#22312;0&#22320;&#22336;&#22806;&#65292;&#30830;&#20445;&#26144;&#23556;&#21040;&#30340;&#34394;&#25311;&#22320;&#22336;&#33853;&#22312;&#20869;&#26680;&#31354;&#38388;&#12290;&#36890;&#36807;vectors_base&#23439;&#65292;&#33719;&#21462;&#20013;&#26029;&#21521;&#37327;&#30340;&#36215;&#22987;&#22320;&#22336;&#65292;&#36825;&#26159;&#30001;&#20110;ARMv4&#20197;&#19979;&#30340;&#29256;&#26412;&#65292;&#35813;&#22320;&#22336;&#22266;&#23450;&#20026;0;ARMv4&#21450;&#20197;&#19978;&#29256;&#26412;&#65292;ARM&#20013;&#26029;&#21521;&#37327;&#34920;&#30340;&#22320;&#22336;&#30001;CP15&#21327;&#22788;&#29702;&#22120;c1&#23492;&#23384;&#22120;&#20013;&#30340;V&#20301;(bit[13])&#25511;&#21046;&#65292;&#22914;&#26524;V&#20301;&#20026;1&#65292;&#37027;&#20040;&#35813;&#22320;&#22336;&#20026;0xffff0000&#12290;&#32771;&#34385;&#21040;&#38500;&#20102;ARMv4&#20197;&#19979;&#30340;&#29256;&#26412;&#30340;&#20013;&#26029;&#21521;&#37327;&#25152;&#22312;&#30340;&#34394;&#25311;&#22320;&#22336;&#20026;0&#65292;&#20854;&#20182;&#25152;&#26377;&#26144;&#23556;&#21040;&#30340;&#34394;&#25311;&#22320;&#22336;&#24212;&#35813;&#37117;&#22312;&#22320;&#22336;0xc0000000&#20043;&#19978;&#30340;&#20869;&#26680;&#31354;&#38388;&#65292;&#32780;&#19981;&#21487;&#33021;&#34987;&#26144;&#23556;&#21040;&#29992;&#25143;&#31354;&#38388;&#12290;</li><li class="listitem">&#25509;&#30528;&#26681;&#25454;type&#31867;&#22411;&#21028;&#26029;&#26159;&#21542;&#20026;&#26222;&#36890;&#35774;&#22791;&#25110;&#32773;ROM&#65292;&#36825;&#20123;&#35774;&#22791;&#20013;&#30340;&#20869;&#23384;&#19981;&#33021;&#34987;&#26144;&#23556;&#21040;RAM&#26144;&#23556;&#30340;&#21306;&#22495;[PAGE_OFFSET&#65292;high_memory)&#65292;&#20063;&#19981;&#33021;&#34987;&#26144;&#23556;&#21040;VMALLOC&#25152;&#22312;&#30340;&#21306;&#22495;[high_memory&#65292;VMALLOC_END)&#65292;&#30001;&#20110;&#36825;&#20004;&#20010;&#21306;&#22495;&#26159;&#36830;&#32493;&#30340;&#65292;&#20013;&#38388;&#38548;&#20102;8M&#30340;VMALLOC_OFFSET&#38548;&#31163;&#21306;&#65292;&#20934;&#30830;&#26469;&#35828;&#26159;&#19981;&#33021;&#26144;&#23556;&#21040;[VMALLOC_START&#65292;VMALLOC_END)&#65292;&#20294;&#26159;&#36825;&#19968;&#38548;&#31163;&#21306;&#20026;&#20102;&#20351;&#33021;&#38548;&#31163;&#20043;&#29992;&#20063;&#26159;&#19981;&#33021;&#34987;&#26144;&#23556;&#30340;&#12290;</li><li class="listitem">&#26681;&#25454;pfn&#19982;1G&#20869;&#23384;&#23545;&#24212;&#30340;&#26368;&#22823;&#29289;&#29702;&#39029;&#26694;0x100000&#27604;&#36739;&#65292;&#22914;&#26524;&#29289;&#29702;&#20869;&#23384;&#30340;&#36215;&#22987;&#22320;&#22336;&#20301;&#20110;32bits&#30340;&#29289;&#29702;&#22320;&#22336;&#20043;&#22806;&#65292;&#37027;&#20040;&#36890;&#36807;create_36bit_mapping&#21019;&#24314;36bits&#38271;&#24230;&#30340;&#39029;&#34920;&#65292;&#23545;&#20110;&#23884;&#20837;&#24335;&#31995;&#32479;&#26469;&#35828;&#24456;&#23569;&#26377;&#36825;&#31181;&#24212;&#29992;&#12290;</li><li class="listitem">&#35843;&#25972;&#20256;&#20837;&#30340;md&#20013;&#30340;&#21508;&#25104;&#21592;&#20449;&#24687;&#65306;virtual&#21521;&#20302;&#22320;&#22336;&#23545;&#40784;&#21040;&#39029;&#38754;&#22823;&#23567;;&#26681;&#25454;length&#21442;&#25968;&#21462;&#23545;&#40784;&#21040;&#39029;&#38754;&#30340;&#22823;&#23567;&#30340;&#38271;&#24230;&#65292;&#24182;&#20197;&#27492;&#35745;&#31639;&#26144;&#23556;&#32467;&#26463;&#30340;&#34394;&#25311;&#22320;&#22336;&#12290;&#26681;&#25454;pfn&#21442;&#25968;&#35745;&#31639;&#36215;&#22987;&#29289;&#29702;&#22320;&#22336;&#12290;</li><li class="listitem">&#26681;&#25454;&#34394;&#25311;&#22320;&#22336;&#21644;&#20844;&#24335;pgd = pgd_offset_k(addr)&#35745;&#31639;&#39029;&#34920;&#22320;&#22336;&#12290;</li><li class="listitem">&#26681;&#25454;&#34394;&#25311;&#22320;&#22336;&#30340;&#36215;&#22987;&#22320;&#22336;&#21442;&#25968;&#20197;&#21450;&#36215;&#22987;&#29289;&#29702;&#22320;&#22336;&#35843;&#29992;alloc_init_section&#26469;&#29983;&#25104;&#39029;&#34920;&#12290;</li></ul></div><p>
pgd_offset_k&#23439;&#23558;&#19968;&#20010;0-4G&#33539;&#22260;&#20869;&#30340;&#34394;&#25311;&#22320;&#22336;&#36716;&#25442;&#20026;&#20869;&#26680;&#36827;&#31243;&#20027;&#39029;&#34920;&#20013;&#30340;&#23545;&#24212;&#39029;&#34920;&#39033;&#25152;&#22312;&#30340;&#22320;&#22336;&#12290;&#23427;&#39318;&#20808;&#26681;&#25454;pgd_index&#35745;&#31639;&#35813;&#34394;&#25311;&#22320;&#22336;&#23545;&#24212;&#30340;&#39029;&#34920;&#39033;&#22312;&#20027;&#39029;&#34920;&#20013;&#30340;&#32034;&#24341;&#20540;&#36825;&#37324;&#38656;&#35201;&#27880;&#24847;PGDIR_SHIFT&#30340;&#20540;&#20026;21&#65292;&#32780;&#38750;20&#65292;&#25152;&#20197;&#23427;&#30340;&#20559;&#31227;&#26159;&#21462;2M&#22823;&#23567;&#21306;&#22359;&#30340;&#32034;&#24341;&#65292;&#36825;&#26159;&#30001;&#20110;pgd_t&#30340;&#31867;&#22411;&#20026;&#20004;&#20010;&#38271;&#25972;&#24418;&#30340;&#20803;&#32032;&#12290;&#28982;&#21518;&#26681;&#25454;&#32034;&#24341;&#20540;&#21644;&#20869;&#26680;&#36827;&#31243;&#20013;&#30340;init_mm.pgd&#21462;&#24471;&#39029;&#34920;&#39033;&#22320;&#22336;&#12290;
</p><pre class="programlisting">
arch/arm/include/asm/pgtable.h

/* to find an entry in a page-table-directory */
#define pgd_index(addr)         ((addr) &gt;&gt; PGDIR_SHIFT)
#define pgd_offset(mm, addr)    ((mm)-&gt;pgd+pgd_index(addr))
/* to find an entry in a kernel page-table-directory */
#define pgd_offset_k(addr)      pgd_offset(&amp;init_mm, addr)
</pre><p>
create_mapping&#22312;&#26412;&#36136;&#19978;&#26159;&#23545;&#20256;&#20837;&#21442;&#25968;&#30340;&#26816;&#26597;&#65292;&#24182;&#20026;&#35843;&#29992;alloc_init_section&#20934;&#22791;&#22235;&#35201;&#32032;&#65306;&#39029;&#34920;&#22320;&#22336;&#65292;&#34394;&#25311;&#22320;&#22336;&#30340;&#36215;&#27490;&#22320;&#22336;&#21644;&#29289;&#29702;&#22320;&#22336;&#30340;&#36215;&#22987;&#22320;&#22336;&#12290;Linux&#23545;create_mapping&#30340;&#35843;&#29992;&#38500;&#20102;&#22312;arch/arm/mm/init.c&#20013;&#36890;&#36807;map_memory_bank&#21021;&#22987;&#21270;&#20027;&#20869;&#23384;&#39029;&#38754;&#26144;&#23556;&#22806;&#65292;&#23545;&#20854;&#30340;&#35843;&#29992;&#22343;&#38598;&#20013;&#22312;arch/arm/mm/mmu.c&#20013;&#65292;&#20854;&#20013;iotable_init&#23553;&#35013;create_mapping&#29992;&#20110;&#29305;&#23450;&#26426;&#22120;&#26550;&#26500;&#30340;&#35774;&#22791;I/O&#26144;&#23556;&#12290;
</p>
</div>
<div class="sect2" title="12.7. alloc_init_section"><div class="titlepage"><div><div><h3 class="title"><a name="idp81011692"></a>12.7. alloc_init_section</h3></div></div></div>
<p>
&#39029;&#34920;&#21019;&#24314;&#20989;&#25968;&#35843;&#29992;&#22270;&#20013;&#32473;&#20986;&#20102;alloc_init_section&#22312;&#39029;&#34920;&#21019;&#24314;&#20013;&#25152;&#22788;&#30340;&#23454;&#29616;&#20301;&#32622;&#65292;&#26412;&#36136;&#19978;&#23427;&#26159;&#19982;alloc_init_pte&#24182;&#34892;&#30340;&#20989;&#25968;&#65292;alloc_init_section&#34987;&#29992;&#26469;&#21019;&#24314;&#27573;&#39029;&#34920;(&#20027;&#39029;&#34920;)&#65292;alloc_init_pte&#21017;&#29992;&#26469;&#22312;&#34987;&#26144;&#23556;&#21306;&#38271;&#24230;&#23567;&#20110;1M&#26102;&#21019;&#24314;2&#32423;&#39029;&#34920;&#12290;
</p><pre class="programlisting">
static void __init alloc_init_section(pgd_t *pgd, unsigned long addr,
				      unsigned long end, unsigned long phys,
				      const struct mem_type *type);
</pre><p>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">pgd&#21442;&#25968;&#25351;&#23450;&#29983;&#25104;&#30340;&#39029;&#34920;&#30340;&#36215;&#22987;&#22320;&#22336;&#65292;&#23427;&#26159;&#19968;&#20010;pgd_t&#31867;&#22411;&#65292;&#34987;&#23450;&#20041;&#20026;typedef unsigned long pgd_t[2]&#65292;&#25152;&#20197;&#23427;&#26159;&#19968;&#20010;2&#32500;&#25968;&#32452;
&#12290;</li><li class="listitem">addr&#21644;end&#20998;&#21035;&#25351;&#26126;&#34987;&#26144;&#23556;&#21040;&#30340;&#34394;&#25311;&#22320;&#22336;&#30340;&#36215;&#27490;&#22320;&#22336;&#12290;</li><li class="listitem">phys&#25351;&#26126;&#34987;&#26144;&#23556;&#30340;&#29289;&#29702;&#22320;&#22336;&#30340;&#36215;&#22987;&#22320;&#22336;&#12290;</li><li class="listitem">type&#21442;&#25968;&#25351;&#26126;&#26144;&#23556;&#31867;&#22411;&#65292;&#25152;&#26377;&#26144;&#23556;&#31867;&#22411;&#22312;struct mem_type mem_types[]&#25968;&#32452;&#20013;&#34987;&#32479;&#19968;&#23450;&#20041;&#12290;</li></ul></div><p>
alloc_init_section&#20381;&#27425;&#23436;&#25104;&#20102;&#20197;&#19979;&#24037;&#20316;&#65306;
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">&#39318;&#20808;&#26681;&#25454;&#20844;&#24335;(addr | end | phys) &amp; ~SECTION_MASK) == 0&#20381;&#25454;&#20256;&#20837;&#30340;&#30340;addr&#65292;end&#21644;phys&#21442;&#25968;&#21028;&#26029;&#26159;&#21542;&#28385;&#36275;&#22320;&#22336;&#23545;&#40784;&#21040;1M&#12290;</li><li class="listitem">&#22914;&#26524;&#28385;&#36275;&#21017;&#30452;&#25509;&#29983;&#25104;&#27573;&#39029;&#34920;(&#20027;&#39029;&#34920;)&#65292;&#24182;&#23384;&#20837;pgd&#25351;&#21521;&#30340;&#22320;&#22336;&#12290;&#30001;&#20110;pgd&#26159;&#19968;&#20010;2&#32500;&#25968;&#32452;&#65292;&#25152;&#20197;&#27599;&#27425;&#38656;&#35201;&#23545;2&#20010;&#20803;&#32032;&#36171;&#20540;&#65292;&#20063;&#21363;&#19968;&#27425;&#21487;&#20197;&#22788;&#29702;2M&#30340;&#20869;&#23384;&#26144;&#23556;&#65292;&#29983;&#25104;&#20004;&#20010;&#39029;&#34920;&#39033;&#12290;&#23427;&#22312;&#19968;&#20010;&#24490;&#29615;&#20013;&#20197;SECTION_SIZE&#20026;&#27493;&#36827;&#21333;&#20301;&#65292;&#36890;&#36807;phys | type-&gt;prot_sect&#26469;&#29983;&#25104;&#21644;&#22635;&#20805;&#39029;&#34920;&#12290;&#20027;RAM&#20869;&#23384;&#23601;&#26159;&#36890;&#36807;&#36825;&#31181;&#26041;&#27861;&#29983;&#25104;&#12290;&#19968;&#20010;256M&#20869;&#23384;RAM&#30340;&#29983;&#25104;&#39029;&#34920;&#22914;&#19979;&#22270;&#20013;&#30340;&#26837;&#33394;&#37096;&#20998;&#25152;&#31034;&#12290;</li><li class="listitem">&#35843;&#29992;flush_pmd_entry&#28165;&#31354;TLB&#20013;&#30340;&#39029;&#38754;Cache&#65292;&#20197;&#20351;&#24471;&#26032;&#39029;&#34920;&#36215;&#20316;&#29992;&#12290;</li><li class="listitem">&#22914;&#19981;&#28385;&#36275;&#30452;&#25509;&#29983;&#25104;&#20027;&#39029;&#34920;&#65292;&#37027;&#20040;&#35843;&#29992;alloc_init_pte&#29983;&#25104;&#20108;&#32423;&#39029;&#34920;&#12290;</li></ul></div><p>
</p><div class="figure"><a name="idp81016428"></a><p class="title"><b>&#22270; 70. &#20869;&#26680;RAM&#26144;&#23556;&#21518;&#30340;&#39029;&#34920;&#24067;&#23616;</b></p><div class="figure-contents"><div><img src="images/pg_map2.gif" alt="&#20869;&#26680;RAM&#26144;&#23556;&#21518;&#30340;&#39029;&#34920;&#24067;&#23616;"></div></div></div><p><br class="figure-break">
</p>
</div>
<div class="sect2" title="12.8. alloc_init_pte"><div class="titlepage"><div><div><h3 class="title"><a name="idp81017156"></a>12.8. alloc_init_pte</h3></div></div></div>
alloc_init_pte&#22312;&#21021;&#22987;&#21270;&#38750;&#20027;RAM&#20013;&#36215;&#21040;&#37325;&#35201;&#30340;&#20316;&#29992;&#65292;&#23427;&#23581;&#35797;&#21019;&#24314;&#20108;&#32423;&#39029;&#34920;&#12290;&#20108;&#32423;&#39029;&#34920;&#30340;L1&#23454;&#38469;&#19978;&#36824;&#26159;&#23384;&#22312;&#20110;&#20027;&#39029;&#34920;&#20013;&#65292;&#21482;&#19981;&#36807;&#27492;&#26102;&#30340;&#20027;&#39029;&#34920;&#39033;&#19981;&#20877;&#26159;&#29289;&#29702;&#22320;&#22336;&#65292;&#32780;&#26159;&#20108;&#32423;&#39029;&#34920;&#65292;&#25110;&#32773;&#31216;&#20026;&#20013;&#38388;&#39029;&#34920;(PMD)&#12290;
<p>
</p><pre class="programlisting">
static void __init alloc_init_pte(pmd_t *pmd, unsigned long addr,
				  unsigned long end, unsigned long pfn,
				  const struct mem_type *type);
</pre><p>	
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">pmd&#21442;&#25968;&#20256;&#36882;L1&#39029;&#34920;&#22320;&#22336;&#12290;</li><li class="listitem">addr&#21644;end&#20998;&#21035;&#25351;&#26126;&#34987;&#26144;&#23556;&#21040;&#30340;&#34394;&#25311;&#22320;&#22336;&#30340;&#36215;&#27490;&#22320;&#22336;&#12290;</li><li class="listitem">pfn&#26159;&#23558;&#34987;&#26144;&#23556;&#30340;&#29289;&#29702;&#22320;&#22336;&#30340;&#39029;&#26694;&#12290;</li><li class="listitem">type&#21442;&#25968;&#25351;&#26126;&#26144;&#23556;&#31867;&#22411;&#12290;</li></ul></div><p>
alloc_init_pte&#20381;&#27425;&#23436;&#25104;&#20197;&#19979;&#24037;&#20316;&#65306;
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">&#39318;&#20808;&#21028;&#26029;pmd&#25351;&#21521;&#30340;L1&#39029;&#34920;&#20013;&#30340;&#39029;&#34920;&#39033;&#26159;&#21542;&#23384;&#22312;&#65292;&#22914;&#26524;&#19981;&#23384;&#22312;&#21017;&#39318;&#20808;&#20351;&#29992;Bootmem&#26426;&#21046;&#20013;&#30340;alloc_bootmem_low_pages&#20989;&#25968;&#30003;&#35831;&#25152;&#38656;&#30340;&#20108;&#32423;&#39029;&#34920;&#31354;&#38388;&#65292;&#22823;&#23567;&#20026;4K&#65292;1&#20010;PAGE&#12290;</li><li class="listitem"></ul></div><p>
	</p><div class="table"><a name="idp81020492"></a><p class="title"><b>&#34920; 19. &#39029;&#34920;&#35745;&#31639;</b></p><div class="table-contents">
	<table summary="&#39029;&#34920;&#35745;&#31639;" border="1"><colgroup><col><col><col></colgroup><thead><tr><th>&#39029;&#34920;&#21517;&#31216;</th><th>&#35745;&#31639;&#20844;&#24335;</th><th>&#35828;&#26126;</th></tr></thead><tbody><tr><td>&#20027;&#39029;&#34920;&#39033;&#22320;&#22336;</td><td>pgd_offset_k(vir_addr)</td><td>
#define PGDIR_SHIFT             21<br>
#define pgd_index(addr)         ((addr) &gt;&gt; PGDIR_SHIFT)<br>
#define pgd_offset(mm, addr)    ((mm)-&gt;pgd+pgd_index(addr))<br>
#define pgd_offset_k(addr)    pgd_offset(&amp;init_mm, addr)
</td></tr><tr><td>&#20027;&#39029;&#34920;&#39033;</td><td>__pmd(phys | type-&gt;prot_sect)</td><td>#define __pmd(x)        (x)
</td></tr><tr><td>&#19968;&#32423;&#39029;&#34920;&#39033;&#22320;&#22336;</td><td>pmd = (pmd_t *)pgd_offset_k(vir_addr);</td><td>&#21516;"&#20027;&#39029;&#34920;&#39033;&#22320;&#22336;"</td></tr><tr><td>&#19968;&#32423;&#39029;&#34920;&#39033;</td><td>pte = alloc_bootmem_low_pages(1024 * sizeof(pte_t));<br>
		__pmd_populate(pmd, __pa(pte) | type-&gt;prot_l1);</td><td>
static inline void __pmd_populate(pmd_t *pmdp, <br>unsigned long pmdval)
{<br>
        pmdp[0] = __pmd(pmdval);<br>
        pmdp[1] = __pmd(pmdval + 256 * sizeof(pte_t));<br>
        flush_pmd_entry(pmdp);<br>
}<br>
		</td></tr><tr><td>&#20108;&#32423;&#39029;&#34920;&#39033;&#22320;&#22336;</td><td>pte = alloc_bootmem_low_pages(1024 * sizeof(pte_t));</td><td>&#36890;&#36807;Bootmem&#26426;&#21046;&#30003;&#35831;1&#20010;&#39029;&#38754;&#22823;&#23567;&#30340;&#20869;&#23384;&#12290;</td></tr><tr><td>&#20108;&#32423;&#39029;&#34920;&#39033;</td><td>pte = pte_offset_kernel(pmd, addr);	<br>
set_pte_ext(pte, pfn_pte(pfn, __pgprot(type-&gt;prot_pte)), 0);
</td><td>
#define __pte_index(addr)	(((addr) &gt;&gt; PAGE_SHIFT) &amp; (PTRS_PER_PTE - 1))<br>
#define pte_offset_kernel(dir,addr)     (pmd_page_vaddr(*(dir)) + __pte_index(addr))<br>
<br>
#define __pgprot(x)     (x)<br>
#define pgprot_val(x)   (x)<br>
#define __pte(x)        (x)<br>
#define pfn_pte(pfn,prot) (__pte(((pfn) &lt;&lt; PAGE_SHIFT) | pgprot_val(prot)))
</td></tr></tbody></table>
	</div></div><p><br class="table-break">
&#23545;&#20110;pgd_offset_k&#23439;&#30340;&#35828;&#26126;&#22914;&#19979;&#65306;
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">init_mm.pgd&#31867;&#22411;&#20026;pgd_t&#31867;&#22411;&#65292;&#25152;&#20197;&#20027;&#39029;&#34920;&#24635;&#26159;&#20197;2&#20010;&#39029;&#34920;&#39033;&#20026;&#19968;&#32452;&#65292;&#23427;&#30340;&#22823;&#23567;&#20026;2 * sizeof(unsigned long) = 8&#12290;</li><li class="listitem">&#34394;&#25311;&#22320;&#22336;&#39318;&#20808;&#21491;&#31227;21&#20301;&#65292;&#26159;&#20026;&#20102;&#21462;&#39640;11&#20301;&#20316;&#20026;2&#20010;&#39029;&#34920;&#39033;&#20026;&#19968;&#32452;&#36825;&#37324;&#25968;&#25454;&#31867;&#22411;&#30340;&#32034;&#24341;&#20540;&#65292;&#22312;&#35745;&#31639;(mm)-&gt;pgd+pgd_index(addr)&#26102;&#65292;&#26159;&#25351;&#38024;&#30340;&#30456;&#21152;&#65292;&#31561;&#20215;&#20110;(pgd_t *)((unsigned long)init_mm.pgd + 8 * ((addr) &gt;&gt; 21))&#12290;</li><li class="listitem">&#30001;&#20110;&#27599;&#20010;&#39029;&#34920;&#39033;&#30340;&#22823;&#23567;&#20026;4&#65292;&#25152;&#20197;&#23545;&#24212;&#20110;&#21333;&#20010;&#39029;&#34920;&#39033;&#30340;&#22823;&#23567;&#65292;&#20854;&#32034;&#24341;&#20540;&#20026;8 * ((addr) &gt;&gt; 21) / 4 = 2 * ((addr)&#65292;&#22320;&#22336;&#21017;&#20026;8 * ((addr) &gt;&gt; 21)&#12290;&#21491;&#31227;21&#28982;&#21518;&#20056;&#20197;2&#65292;&#30456;&#24403;&#20110;&#21462;&#39640;12&#20301;&#65292;&#24182;&#23558;&#26368;&#21518;&#20301;&#32622;0&#65292;&#20877;&#20056;&#20197;4&#21017;&#21040;&#36798;&#20102;&#22320;&#22336;&#12290;&#30456;&#24403;&#20110;&#20056;&#20197;8&#12290;&#36825;&#37324;&#21462;&#30340;&#24635;&#26159;&#20598;&#25968;&#32034;&#24341;&#65292;&#20063;&#21363;create_mapping&#20256;&#36882;&#32473;alloc_init_section&#30340;pgd&#21442;&#25968;&#27704;&#36828;&#25351;&#21521;&#20598;&#25968;&#32034;&#24341;&#12290;</li><li class="listitem">&#22914;&#26524;&#38656;&#35201;&#21462;&#22855;&#25968;&#32034;&#24341;&#30340;&#39029;&#34920;&#39033;&#24590;&#20040;&#21150;&#21602;&#65311;&#35813;&#20540;&#23558;&#22312;alloc_init_section&#20013;&#36890;&#36807;(addr &amp; SECTION_SIZE)&#23545;&#23427;&#36827;&#34892;&#20462;&#27491;&#12290;</li><li class="listitem">&#20027;&#39029;&#34920;&#39033;&#30340;&#22522;&#22320;&#22336;init_mm.pgd&#21152;&#19978;&#32034;&#24341;&#20540;&#23601;&#26159;&#20027;&#39029;&#34920;&#39033;&#30340;&#22320;&#22336;&#12290;</li></ul></div><p>
&#23545;__pmd_populate&#20869;&#32852;&#20989;&#25968;&#30340;&#35828;&#26126;&#22914;&#19979;&#65306;
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">&#23427;&#21516;&#26102;&#22788;&#29702;&#20004;&#20010;&#19968;&#32423;&#39029;&#34920;&#39033;pmd[0]&#21644;pmd[1]&#12290;</li><li class="listitem">pmd[0]&#30340;&#20540;&#21363;&#20026;&#20256;&#20837;&#30340;pmdval&#65292;&#20063;&#21363;&#36890;&#36807;Bootmem&#26426;&#21046;&#33719;&#21462;&#30340;&#22320;&#22336;pte&#36716;&#21270;&#20026;&#29289;&#29702;&#22320;&#22336;&#21518;&#21152;&#19978;&#20445;&#25252;&#26631;&#24535;&#12290;</li><li class="listitem">pmd[1]&#30340;&#20540;&#26159;pmd[0]&#30340;&#20540;&#30340;&#20559;&#31227;&#65292;&#23427;&#20559;&#31227;&#20102;256&#20010;PTE&#39029;&#34920;&#39033;&#65292;&#30001;&#20110;&#27599;&#20010;PTE&#39029;&#34920;&#39033;&#20063;&#26159;4&#23383;&#33410;&#65292;&#25152;&#20197;&#20559;&#31227;&#30340;&#30340;&#29289;&#29702;&#22320;&#22336;&#20026;256 * sizeof(pte_t)&#12290;</li><li class="listitem">&#35843;&#29992;flush_pmd_entry&#28165;&#31354;TLB&#20013;&#30340;&#39029;&#38754;Cache&#65292;&#20197;&#20351;&#24471;&#26032;&#39029;&#34920;&#36215;&#20316;&#29992;&#12290;</li></ul></div><p>
</p><pre class="programlisting">
#define PTRS_PER_PTE		512
#define pmd_val(x)      (x)

static inline pte_t *pmd_page_vaddr(pmd_t pmd)
{
        unsigned long ptr;

        ptr = pmd_val(pmd) &amp; ~(PTRS_PER_PTE * sizeof(void *) - 1);
        ptr += PTRS_PER_PTE * sizeof(void *);

        return __va(ptr);
}
</pre><p>
</p>
</div>
<div class="sect2" title="12.9. set_pte_ext"><div class="titlepage"><div><div><h3 class="title"><a name="idp81033740"></a>12.9. set_pte_ext</h3></div></div></div>
<p>set_pte_ext&#29992;&#26469;&#22635;&#20805;&#30828;&#20214;PTE&#39029;&#34920;&#12290;&#22312;create_mapping&#20013;&#34987;&#35843;&#29992;&#65292;&#36890;&#36807;&#19968;&#20010;&#24490;&#29615;&#65292;&#34987;&#20256;&#20837;&#30340;&#29289;&#29702;&#39029;&#24103;&#21644;&#22823;&#23567;&#20197;PAGE_SIZE&#27493;&#36827;&#65292;&#36827;&#34892;&#20108;&#32423;&#39029;&#34920;&#30340;&#35745;&#31639;&#21644;&#22635;&#20805;&#12290;
</p><pre class="programlisting">
	do {		
		set_pte_ext(pte, pfn_pte(pfn, __pgprot(type-&gt;prot_pte)), 0);
		pfn++;
	} while (pte++, addr += PAGE_SIZE, addr != end);
</pre><p>
&#23427;&#36890;&#36807;&#35843;&#29992;&#29305;&#23450;&#31995;&#32479;&#30340;pte&#20989;&#25968;&#23436;&#25104;&#65292;&#23545;&#20110;ARMv6&#26469;&#35828;&#65292;&#23450;&#20041;&#22914;&#19979;&#65306;
</p><pre class="programlisting">
arch/arm/include/asm/pgtable.h
#define set_pte_ext(ptep,pte,ext) cpu_set_pte_ext(ptep,pte,ext)
#define set_pte_ext(ptep,pte,ext) cpu_set_pte_ext(ptep,pte,ext)

arch/arm/include/asm/cpu-single.h
#define cpu_set_pte_ext			__cpu_fn(CPU_NAME,_set_pte_ext)
</pre><p>

</p><pre class="programlisting">
arch/arm/mm/proc-v6.S

ENTRY(cpu_v6_set_pte_ext)
#ifdef CONFIG_MMU
        armv6_set_pte_ext cpu_v6
#endif
        mov     pc, lr
</pre><p>
cpu_v6_set_pte_ext&#20989;&#25968;&#20013;&#24341;&#29992;&#20102;armv6_set_pte_ext&#23439;&#65292;&#24182;&#20256;&#20837;cpu_v6&#21442;&#25968;&#12290;&#35813;&#23439;&#23450;&#20041;&#22914;&#19979;&#65306;
</p><pre class="programlisting">
arch/arm/mm/proc-macros.S

.macro  armv6_set_pte_ext pfx
str     r1, [r0], #-2048                @ linux version
</pre><p>
&#26681;&#25454;ATPCS&#35268;&#21017;&#65292;C&#35821;&#35328;&#20989;&#25968;&#22312;&#35843;&#29992;&#27719;&#32534;&#35821;&#35328;&#26102;&#65292;&#20998;&#21035;&#36890;&#36807;r0-r2&#26469;&#20381;&#27425;&#20256;&#36882;&#21442;&#25968;&#12290;&#25152;&#20197;&#36825;&#37324;&#30340;r0&#20195;&#34920;&#30340;&#26159;pte&#21442;&#25968;&#65292;&#20063;&#21363;&#20108;&#32423;&#39029;&#34920;&#30340;&#22320;&#22336;&#65307;r1&#20026;&#36890;&#36807;pfn_pte&#35745;&#31639;&#20986;&#30340;&#20108;&#32423;&#39029;&#34920;&#39033;&#65307;r2&#20026;0&#12290;&#36825;&#37324;&#30340;str&#25351;&#20196;&#39318;&#20808;&#23558;&#20154;r1&#23384;&#20837;r0&#25152;&#25351;&#21521;&#30340;&#22320;&#22336;&#65292;&#20063;&#21363;&#22635;&#20805;&#20108;&#32423;&#39029;&#34920;&#39033;&#65292;&#28982;&#21518;&#23558;r0&#30340;&#20540;&#20943;&#21435;2048&#65292;&#30456;&#24403;&#20110;&#19979;&#31227;&#20102;2048 / 4 = 512&#39033;&#12290;&#36825;&#37324;&#32473;&#20986;&#19968;&#20010;&#19968;&#20108;&#32423;&#39029;&#34920;&#30340;&#20840;&#22270;&#65306;
</p><div class="figure"><a name="idp81037092"></a><p class="title"><b>&#22270; 71. &#20869;&#26680;&#39029;&#34920;&#24067;&#23616;&#20840;&#22270;</b></p><div class="figure-contents"><div><img src="images/pg_map.gif" alt="&#20869;&#26680;&#39029;&#34920;&#24067;&#23616;&#20840;&#22270;"></div></div></div><p><br class="figure-break">
&#27880;&#24847;&#22270;&#20013;&#20108;&#32423;&#39029;&#34920;&#26159;&#22312;&#27880;&#20876;&#20013;&#26029;&#21521;&#37327;&#26102;&#30340;&#19968;&#20010;&#23454;&#20363;&#12290;&#27880;&#20876;&#30340;&#34394;&#25311;&#22320;&#22336;&#20026;0xffff0000&#65292;&#29289;&#29702;&#22320;&#22336;&#20026;0x50740000&#65292;&#22823;&#23567;&#20026;0x1000&#12290;&#20256;&#36882;&#32473;r0&#30340;&#20540;&#21363;&#20026;0xc0741fc0&#65292;r1&#30340;&#20540;&#20026;0x5074034b&#12290;&#22312;&#32463;&#36807;str&#25805;&#20316;&#20043;&#21518;&#65292;r0&#30340;&#20540;&#20026;0xc07417c0&#65292;&#30456;&#24403;&#20110;&#19979;&#31227;&#20102;512&#20010;&#39029;&#34920;&#39033;&#12290;
</p><pre class="programlisting">
arch/arm/include/asm/pgtable-hwdef.h
#define PTE_TYPE_MASK		(3 &lt;&lt; 0)
#define PTE_EXT_AP0     (1 &lt;&lt; 4)

bic     r3, r1, #0x000003fc
bic     r3, r3, #PTE_TYPE_MASK
orr     r3, r3, r2
orr     r3, r3, #PTE_EXT_AP0 | 2
</pre><p>
bic&#20301;&#28165;&#38500;&#25351;&#20196;&#39318;&#20808;&#23558;r1&#20013;0x3fc&#23545;&#24212;&#30340;&#20301;&#28165;0&#65292;&#28982;&#21518;&#23545;PTE_TYPE_MASK&#25351;&#23450;&#30340;&#26368;&#21518;&#20004;&#20301;&#28165;0&#65292;&#20063;&#21363;&#23545;0x3ff&#25351;&#23450;&#30340;&#26368;&#21518;11&#20301;&#28165;&#38646;&#65292;&#23545;&#20110;&#20540;&#20026;0x5074034b&#30340;r1&#26469;&#35828;&#65292;&#23384;&#20837;r3&#30340;&#20540;&#20026;0x50740000&#12290;orr&#25353;&#20301;&#36923;&#36753;&#25110;&#25351;&#20196;&#36890;&#36807;&#23558;r3&#20013;&#30340;&#20540;&#19982;r2&#20301;&#25110;&#25805;&#20316;&#25918;&#20837;r3&#65292;&#30001;&#20110;r2&#30340;&#20540;&#20026;0&#65292;&#25152;&#20197;r3&#30340;&#20540;&#27492;&#26102;&#20445;&#25345;&#19981;&#21464;&#12290;&#26368;&#21518;&#30340;orr&#23558;r3&#30340;&#20540;&#21152;&#19978;PTE_EXT_AP0&#26435;&#38480;&#20301;&#65292;&#25110;&#19978;2&#26159;&#20026;&#20102;&#25351;&#23450;&#24403;&#21069;&#26159;&#23567;&#39029;&#34920;(4K)&#65292;&#27492;&#26102;r3&#30340;&#20540;&#20026;0x50740012&#12290;
</p><pre class="programlisting">
arch/arm/include/asm/pgtable.h
#define L_PTE_MT_MASK           (0x0f &lt;&lt; 2)

adr     ip, \pfx\()_mt_table
and     r2, r1, #L_PTE_MT_MASK
ldr     r2, [ip, r2]
</pre><p>
adr&#20266;&#25351;&#20196;&#23558;cpu_v6_mt_table&#30340;&#22320;&#22336;&#35013;&#20837;ip&#23492;&#23384;&#22120;&#65292;&#28982;&#21518;&#21462;r1&#20013;0x5074034b&#30340;L_PTE_MT_MASK&#20301;&#20316;&#20026;&#32034;&#24341;&#20540;&#65292;&#36825;&#37324;&#20026;8&#12290;&#30001;&#20110;&#34920;&#20013;&#27599;&#19968;&#39033;&#30340;&#22823;&#23567;&#20026;4&#23383;&#33410;&#65292;&#25152;&#20197;[ip, 8]&#23545;&#24212;&#34920;&#20013;&#30340;&#31532;3&#39033;&#65292;&#20063;&#21363;L_PTE_MT_WRITETHROUGH&#12290;
</p><pre class="programlisting">
arch/arm/include/asm/pgtable.h
#define L_PTE_MT_WRITETHROUGH	(0x02 &lt;&lt; 2)	/* 0010 */

/*
 * The ARMv6 and ARMv7 set_pte_ext translation function.
 *
 * Permission translation:
 *  YUWD  APX AP1 AP0	SVC	User
 *  0xxx   0   0   0	no acc	no acc
 *  100x   1   0   1	r/o	no acc
 *  10x0   1   0   1	r/o	no acc
 *  1011   0   0   1	r/w	no acc
 *  110x   0   1   0	r/w	r/o
 *  11x0   0   1   0	r/w	r/o
 *  1111   0   1   1	r/w	r/w
 */
	.macro	armv6_mt_table pfx
\pfx\()_mt_table:
	.long	0x00						@ L_PTE_MT_UNCACHED
	.long	PTE_EXT_TEX(1)					@ L_PTE_MT_BUFFERABLE
	.long	PTE_CACHEABLE					@ L_PTE_MT_WRITETHROUGH
	.long	PTE_CACHEABLE | PTE_BUFFERABLE			@ L_PTE_MT_WRITEBACK
	.long	PTE_BUFFERABLE					@ L_PTE_MT_DEV_SHARED
	.long	0x00						@ unused
	.long	0x00						@ L_PTE_MT_MINICACHE (not present)
	.long	PTE_EXT_TEX(1) | PTE_CACHEABLE | PTE_BUFFERABLE	@ L_PTE_MT_WRITEALLOC
	.long	0x00						@ unused
	.long	PTE_EXT_TEX(1)					@ L_PTE_MT_DEV_WC
	.long	0x00						@ unused
	.long	PTE_CACHEABLE | PTE_BUFFERABLE			@ L_PTE_MT_DEV_CACHED
	.long	PTE_EXT_TEX(2)					@ L_PTE_MT_DEV_NONSHARED
	.long	0x00						@ unused
	.long	0x00						@ unused
	.long	0x00						@ unused
	.endm
</pre><p>
&#39318;&#20808;&#27979;&#35797;&#20108;&#32423;&#39029;&#34920;&#39033;0x5074034b&#20013;&#30340;L_PTE_WRITE&#21644;L_PTE_DIRTY&#26631;&#24535;&#20301;&#65292;&#22914;&#26524;&#35774;&#32622;&#20102;L_PTE_WRITE&#65292;&#20294;&#27809;&#26377;L_PTE_DIRTY&#65292;&#37027;&#20040;&#35774;&#32622;&#37027;&#20040;&#35774;&#32622;PTE_EXT_APX&#21040;r3&#20195;&#34920;&#30340;&#30828;&#20214;&#20108;&#32423;&#39029;&#34920;&#39033;0x50740021&#20013;&#12290;&#26174;&#28982;&#36825;&#37324;&#19981;&#20250;&#35774;&#32622;&#35813;&#20301;&#12290;
</p><pre class="programlisting">
arch/arm/include/asm/pgtable.h
#define L_PTE_DIRTY             (1 &lt;&lt; 6)
#define L_PTE_WRITE             (1 &lt;&lt; 7)

arch/arm/include/asm/pgtable-hwdef.h
#define PTE_EXT_APX		(1 &lt;&lt; 9)	/* v6 */

tst     r1, #L_PTE_WRITE
tstne   r1, #L_PTE_DIRTY
orreq   r3, r3, #PTE_EXT_APX
</pre><p>
&#22914;&#26524;Linux&#29256;&#26412;&#30340;&#20108;&#32423;&#39029;&#34920;&#39033;&#35774;&#32622;&#20102;L_PTE_USER&#26631;&#24535;&#65292;r3&#34987;&#32622;PTE_EXT_AP1&#12290;&#22914;&#26524;r3&#21253;&#21547;PTE_EXT_APX&#26631;&#24535;&#65292;&#37027;&#20040;&#21516;&#26102;&#28165;&#38500;PTE_EXT_APX&#21644; PTE_EXT_AP0&#12290;
</p><pre class="programlisting">
#define L_PTE_USER              (1 &lt;&lt; 8)

tst     r1, #L_PTE_USER
orrne   r3, r3, #PTE_EXT_AP1
tstne   r3, #PTE_EXT_APX
bicne   r3, r3, #PTE_EXT_APX | PTE_EXT_AP0
</pre><p>
&#22914;&#26524;r1&#27809;&#26377;L_PTE_EXEC&#26631;&#24535;&#65292;&#21017;&#35774;&#32622;PTE_EXT_XN&#12290;
</p><pre class="programlisting">
tst     r1, #L_PTE_EXEC
orreq   r3, r3, #PTE_EXT_XN

orr     r3, r3, r2
</pre><p>
&#28982;&#21518;&#20877;&#21152;&#19978;L_PTE_MT_WRITETHROUGH&#26631;&#24535;&#12290;&#28982;&#21518;&#26681;&#25454;L_PTE_YOUNG&#26631;&#24535;&#65292;&#30830;&#23450;&#26159;&#21542;&#21152;&#19978;L_PTE_PRESENT&#26631;&#24535;&#12290;
</p><pre class="programlisting">
tst     r1, #L_PTE_YOUNG
tstne   r1, #L_PTE_PRESENT
moveq   r3, #0

str     r3, [r0]
mcr     p15, 0, r0, c7, c10, 1          @ flush_pte
.endm
</pre><p>
str&#25351;&#20196;&#23558;&#26368;&#32456;&#30340;&#30828;&#20214;PTE&#39029;&#34920;&#20540;&#23384;&#25918;&#21040;&#20302;&#22320;&#22336;&#30340;&#20108;&#32423;&#39029;&#34920;&#20013;&#12290;&#25152;&#20197;&#30828;&#20214;&#20351;&#29992;&#30340;&#20108;&#32423;&#39029;&#34920;&#24635;&#26159;&#20301;&#20110;&#20302;&#22320;&#22336;&#22788;&#65292;&#32780;&#39640;&#22320;&#22336;&#22788;&#30340;512&#39033;PTE&#26159;&#30041;&#32473;Linux&#33258;&#24049;&#20351;&#29992;&#30340;&#12290;
</p>
<p></p>
</div>
</div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ar01s11.html">&#19978;&#19968;&#39029;</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="ar01s13.html">&#19979;&#19968;&#39029;</a></td></tr><tr><td width="40%" align="left" valign="top">11. &#20869;&#26680;&#21021;&#22987;&#21270;2 </td><td width="20%" align="center"><a accesskey="h" href="index.html">&#36215;&#22987;&#39029;</a></td><td width="40%" align="right" valign="top"> 13. &#20869;&#23384;&#31649;&#29702;</td></tr></table></div></body></html>
