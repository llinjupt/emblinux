<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>7. zImage&#30340;&#29983;&#25104;&#21644;&#21152;&#36733;</title><link rel="stylesheet" href="styles.css" type="text/css"><meta name="generator" content="DocBook XSL-NS Stylesheets V1.75.2"><link rel="home" href="index.html" title="Linux&#20869;&#26680;&#23398;&#20064;&#21644;&#30740;&#31350;&#21450;&#23884;&#20837;&#24335;(ARM)&#23398;&#20064;&#21644;&#30740;&#31350;&#30340;&#24320;&#25918;&#25991;&#26723;"><link rel="up" href="index.html" title="Linux&#20869;&#26680;&#23398;&#20064;&#21644;&#30740;&#31350;&#21450;&#23884;&#20837;&#24335;(ARM)&#23398;&#20064;&#21644;&#30740;&#31350;&#30340;&#24320;&#25918;&#25991;&#26723;"><link rel="prev" href="ar01s06.html" title="6. Uboot&#21551;&#21160;&#20998;&#26512;"><link rel="next" href="ar01s08.html" title="8. &#20869;&#26680;&#21152;&#36733;"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">7. zImage&#30340;&#29983;&#25104;&#21644;&#21152;&#36733;</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ar01s06.html">&#19978;&#19968;&#39029;</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="ar01s08.html">&#19979;&#19968;&#39029;</a></td></tr></table><hr></div><div class="sect1" title="7. zImage&#30340;&#29983;&#25104;&#21644;&#21152;&#36733;"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp80412980"></a>7. zImage&#30340;&#29983;&#25104;&#21644;&#21152;&#36733;</h2></div></div></div>
<div class="sect2" title="7.1. &#30456;&#20851;&#30340;Makefile"><div class="titlepage"><div><div><h3 class="title"><a name="idp80413404"></a>7.1. &#30456;&#20851;&#30340;Makefile</h3></div></div></div>
zImage&#30340;&#29983;&#25104;&#36807;&#31243;&#21487;&#20197;&#30001;&#19979;&#22270;&#27010;&#25324;&#65292;&#35813;&#22270;&#26469;&#33258;http://freeelectrons.com/docs/kernelinit&#12290;
<div class="figure"><a name="idp80413772"></a><p class="title"><b>&#22270; 35. zImage&#29983;&#25104;&#36807;&#31243;</b></p><div class="figure-contents"><div><img src="images/zimg.gif" alt="zImage&#29983;&#25104;&#36807;&#31243;"></div></div></div><br class="figure-break">
&#29983;&#25104;zImage&#25991;&#20214;&#30340;Makefile&#20301;&#20110;arch/arm&#19979;&#65292;&#23427;&#36890;&#36807;include $(srctree)/arch/$(SRCARCH)/Makefile&#34987;&#21253;&#21547;&#36827;&#20027;&#30446;&#24405;&#19979;&#30340;Makefie&#20013;&#12290;&#21478;&#22806;&#36890;&#36807;include $(srctree)/scripts/Kbuild.include&#19968;&#31995;&#21015;&#30340;&#36890;&#29992;&#32534;&#35793;&#22120;&#22788;&#29702;&#20989;&#25968;&#21644;&#21464;&#37327;&#34987;&#21253;&#21547;&#21040;&#20027;&#30446;&#24405;&#19979;&#30340;Makefile&#20013;&#12290;&#26681;&#30446;&#24405;&#19979;&#30340;Makefile&#65306;
<pre class="programlisting">
Makefile
include $(srctree)/arch/$(SRCARCH)/Makefile
......
# We need some generic definitions (do not try to remake the file).
$(srctree)/scripts/Kbuild.include: ;
include $(srctree)/scripts/Kbuild.include
</pre>
&#29992;&#20110;&#29983;&#25104;zImage&#30340;Makefile&#20013;&#30340;&#20381;&#36182;&#23450;&#20041;&#22914;&#19979;&#65306;
<pre class="programlisting">
arch/arm/Makefile
# Default target when executing plain make
ifeq ($(CONFIG_XIP_KERNEL),y)
KBUILD_IMAGE := xipImage
else
KBUILD_IMAGE := zImage
endif

all:    $(KBUILD_IMAGE)
......
zImage Image xipImage bootpImage uImage: vmlinux
        $(Q)$(MAKE) $(build)=$(boot) MACHINE=$(MACHINE) $(boot)/$@
</pre>
&#30001;&#27492;&#21487;&#20197;&#30475;&#20986;zImage&#20381;&#36182;&#20110;vmlinux&#25991;&#20214;&#12290;&#24403;&#28982;&#20854;&#20182;&#26684;&#24335;&#30340;Image&#25991;&#20214;&#20063;&#26080;&#29420;&#26377;&#20598;&#30340;&#28304;&#20110;vmlinux&#12290;
</div>
<div class="sect2" title="7.2. vmlinux&#30340;&#26684;&#24335;"><div class="titlepage"><div><div><h3 class="title"><a name="idp80416212"></a>7.2. vmlinux&#30340;&#26684;&#24335;</h3></div></div></div>
<pre class="programlisting">
#file vmlinux
vmlinux: ELF 32-bit LSB executable, ARM, version 1 (SYSV), statically linked, not stripped
</pre>
vmlinux&#26159;&#26631;&#20934;&#30340;Linux&#19979;&#30340;elf&#21487;&#25191;&#34892;&#25991;&#20214;&#12290;&#23427;&#19982;&#20854;&#20182;&#30340;&#21487;&#25191;&#34892;&#25991;&#20214;&#26684;&#24335;&#27809;&#26377;&#20219;&#20309;&#26412;&#36136;&#21306;&#21035;&#12290;&#38543;&#20415;&#20889;&#19968;&#20010;.c&#25991;&#20214;&#65292;&#28982;&#21518;&#20351;&#29992;&#38745;&#24577;&#26041;&#24335;&#32534;&#35793;&#23427;&#65306;
<pre class="programlisting">
#arm-linux-gcc -static test.c
#file a.out           
a.out: ELF 32-bit LSB executable, ARM, version 1 (SYSV), statically linked, for GNU/Linux 2.6.14, not stripped
</pre>
&#27880;&#24847;&#21040;&#26222;&#36890;&#24212;&#29992;&#31243;&#24207;&#26377;for GNU/Linux 2.6.14&#30340;&#25552;&#31034;&#65292;&#25152;&#20197;&#24819;&#22312;Linux&#19978;&#30452;&#25509;&#36816;&#34892;vmlinux&#26159;&#19981;&#34892;&#30340;&#65292;&#22240;&#20026;&#23427;&#38656;&#35201;&#36816;&#34892;&#22312;&#29305;&#26435;&#27169;&#24335;&#65292;ELF&#21152;&#36733;&#22120;&#26080;&#27861;&#21152;&#36733;&#23427;&#12290;&#20351;&#29992;arm-linux-readelf&#21487;&#20197;&#28165;&#26224;&#30340;&#30475;&#21040;&#23427;&#30340;&#20195;&#30721;&#27573;&#36215;&#22987;&#22320;&#22336;&#20301;&#20110;&#20869;&#26680;&#31354;&#38388;&#65306;
<pre class="programlisting">
Entry point address:               0xc0008000
</pre>
&#32780;&#26222;&#36890;&#30340;&#21487;&#25191;&#34892;&#25991;&#20214;&#20026;&#65306;  
<pre class="programlisting">
Entry point address:               0x8110
</pre>
</div>
<div class="sect2" title="7.3. &#38745;&#40664;&#32534;&#35793;&#21644;V=1"><div class="titlepage"><div><div><h3 class="title"><a name="idp80418772"></a>7.3. &#38745;&#40664;&#32534;&#35793;&#21644;V=1</h3></div></div></div>
&#27880;&#24847;&#21040;arch/arm/Makefile&#20013;&#23450;&#20041;&#30340;zImage&#30340;&#29983;&#25104;&#35268;&#21017;&#65306;
<pre class="programlisting">
$(Q)$(MAKE) $(build)=$(boot) MACHINE=$(MACHINE) $(boot)/$@
</pre>
&#32454;&#24515;&#30340;&#20154;&#20250;&#38382;&#24590;&#20040;&#20250;&#22810;&#20102;&#19968;&#20010;$(Q)&#21464;&#37327;&#12290;&#20301;&#20110;&#20027;&#30446;&#24405;&#19979;&#30340;Makefile&#23545;Q&#21464;&#37327;&#36827;&#34892;&#20102;&#23450;&#20041;&#65292;&#23427;&#20301;&#20110;&#21517;&#20026;Beautify output&#30340;&#23567;&#33410;&#20013;&#65292;&#24182;&#35828;&#26126;&#20102;Q&#30340;&#21382;&#21490;&#26469;&#28304;&#12290;
<pre class="programlisting">
ifeq ($(KBUILD_VERBOSE),1)
  quiet =
  Q =
else
  quiet=quiet_
  Q = @
endif
</pre>
Q&#30340;&#21629;&#36816;&#30001;KBUILD_VERBOSE&#30340;&#20540;&#26469;&#20915;&#23450;&#65292;&#32780;&#34739;&#34690;&#25429;&#34633;&#65292;&#40644;&#38592;&#22312;&#21518;&#12290;V&#26368;&#32456;&#20915;&#23450;&#20102;Q&#30340;&#21629;&#36816;&#65292;&#36890;&#36807;&#22312;make&#21629;&#20196;&#21442;&#25968;&#20013;&#25552;&#20379;V=1&#21487;&#20197;&#24320;&#21551;V&#65292;V&#26159;Verbose&#30340;&#32553;&#20889;&#65292;&#25171;&#24320;&#20102;V&#65292;&#25152;&#26377;&#30340;&#32534;&#35793;&#20449;&#24687;&#37117;&#23558;&#25171;&#21360;&#20986;&#26469;&#65292;&#20851;&#38381;V&#65292;&#23558;&#33719;&#24471;Beautify output&#12290;V&#36873;&#39033;&#23545;&#20110;&#20998;&#26512;&#20869;&#26680;&#30340;&#32534;&#35793;&#24456;&#26377;&#24110;&#21161;&#12290;
<pre class="programlisting">
ifdef V
  ifeq ("$(origin V)", "command line")
    KBUILD_VERBOSE = $(V)
  endif
endif
ifndef KBUILD_VERBOSE
  KBUILD_VERBOSE = 0
endif
</pre>
</div>
<div class="sect2" title="7.4. &#29983;&#25104;zImage&#30340;&#21629;&#20196;&#34892;"><div class="titlepage"><div><div><h3 class="title"><a name="idp80421148"></a>7.4. &#29983;&#25104;zImage&#30340;&#21629;&#20196;&#34892;</h3></div></div></div>
&#20026;&#20102;&#22312;&#32534;&#35793;&#26399;&#21482;&#36755;&#20986;&#20851;&#24515;&#30340;&#21629;&#20196;&#65292;&#31227;&#38500;&#29983;&#25104;zImage&#21629;&#20196;&#21069;&#30340;Q&#21464;&#37327;&#65292;&#24182;&#22312;&#20027;&#30446;&#24405;&#19979;&#25191;&#34892;make zImage&#12290;
<pre class="programlisting">
 $(MAKE) $(build)=$(boot) MACHINE=$(MACHINE) $(boot)/$@
</pre>
&#19968;&#20010;&#23436;&#25972;&#30340;&#29983;&#25104;zImage&#30340;&#21629;&#20196;&#34892;&#22914;&#19979;&#65306;
<pre class="programlisting">
make -f scripts/Makefile.build obj=arch/arm/boot MACHINE=arch/arm/mach-s3c6400/ arch/arm/boot/zImage
</pre>
&#26597;&#30475;make&#23545;&#20110;-f&#36873;&#39033;&#30340;&#35299;&#37322;&#22914;&#19979;&#65306;
<pre class="programlisting">
#man makefile
       +-f file, --file=file, --makefile=FILE
            Use file as a makefile.
</pre>
-f&#25351;&#23450;&#20102;&#23454;&#38469;&#20351;&#29992;&#30340;Makefile&#25991;&#20214;&#65292;obj&#21644;MACHINE&#21017;&#26159;&#20256;&#36882;&#32473;Makefile.build&#30340;&#21442;&#25968;&#65292;&#23427;&#20204;&#20998;&#21035;&#30001;&#21464;&#37327;$(boot)&#21644;$(MACHINE)&#20915;&#23450;&#12290;$@&#25351;&#21442;&#25968;zImage&#65292;&#23427;&#22312;Makefile&#35821;&#27861;&#20013;&#25351;&#20195;&#29983;&#25104;&#30340;&#30446;&#26631;&#12290;
<p>
$(build)=$(boot)&#34987;&#25193;&#23637;&#20026;&#20102;scripts/Makefile.build obj=arch/arm/boot&#65292;&#36825;&#30475;&#36215;&#26469;&#26377;&#28857;&#19981;&#22826;&#19987;&#19994;&#12290;build&#26159;scripts/Kbuild.include&#20013;&#23450;&#20041;&#30340;&#21464;&#37327;&#65306;
</p>
<pre class="programlisting">
# Shorthand for $(Q)$(MAKE) -f scripts/Makefile.build obj=
# Usage:
# $(Q)$(MAKE) $(build)=dir
build := -f $(if $(KBUILD_SRC),$(srctree)/)scripts/Makefile.build obj
</pre>
boot := arch/arm/boot &#30452;&#25509;&#25351;&#26126;&#35813;&#26550;&#26500;&#30340;boot&#25991;&#20214;&#29983;&#25104;&#36335;&#24452;&#65292;&#32780;MACHINE&#21017;&#26159;&#30001;&#29992;&#25143;&#37197;&#32622;&#26469;&#20915;&#23450;&#65292;&#27605;&#31455;&#19968;&#20010;ARM CPU&#21487;&#20197;&#21644;&#21508;&#31867;&#22806;&#35774;&#32452;&#25104;&#19981;&#21516;&#30340;&#26426;&#22120;&#26550;&#26500;&#12290;
<pre class="programlisting">
ifneq ($(machine-y),)
MACHINE  := arch/arm/mach-$(word 1,$(machine-y))/
else
MACHINE  :=
endif

machine-$(CONFIG_ARCH_S3C64XX)    := s3c6400 s3c6410
</pre>
&#22312;&#20869;&#26680;&#37197;&#32622;&#25991;&#20214;.config&#21487;&#20197;&#25214;&#21040;CONFIG_ARCH_S3C64XX=y&#12290;
</div>
<div class="sect2" title="7.5. Makefile.build&#21644;vmlinux&#21387;&#32553;"><div class="titlepage"><div><div><h3 class="title"><a name="idp80424932"></a>7.5. Makefile.build&#21644;vmlinux&#21387;&#32553;</h3></div></div></div>
scripts/Makefile.build&#25991;&#20214;&#65292;&#23427;&#21253;&#21547;arch/arm/boot/Makefile&#25991;&#20214;&#30340;&#26041;&#24335;&#26377;&#20123;&#29305;&#27530;&#23427;&#26159;&#20174;&#21629;&#20196;&#34892;&#24471;&#21040;obj&#28982;&#21518;&#25214;&#21040;&#23545;&#24212;&#25991;&#20214;&#22841;&#19979;&#30340;Makefile&#24182;&#25191;&#34892;&#12290;scripts/Makefile.build&#30340;&#24320;&#22836;&#65292;&#25152;&#20197;src&#30340;&#20540;&#20026;arch/arm/boot&#12290;
<pre class="programlisting">
src := $(obj)

kbuild-dir := $(if $(filter /%,$(src)),$(src),$(srctree)/$(src))
kbuild-file := $(if $(wildcard $(kbuild-dir)/Kbuild),$(kbuild-dir)/Kbuild,$(kbuild-dir)/Makefile)
include $(kbuild-file)
</pre>
kbuild-file&#26082;&#26159;src&#25351;&#23450;&#36335;&#24452;&#19979;&#30340;Makefile&#25991;&#20214;&#65292;&#27492;&#26102;&#23601;&#26159;arch/arm/boot/Makefile&#65292;&#23427;&#21253;&#21547;&#20102;&#26500;&#24314;arch/arm/boot/zImage&#30340;&#35268;&#21017;&#12290;
<pre class="programlisting">
PHONY := __build
&#8230;&#8230;
__build: $(if $(KBUILD_BUILTIN),$(builtin-target) $(lib-target) $(extra-y)) \
         $(if $(KBUILD_MODULES),$(obj-m) $(modorder-target)) \
         $(subdir-ym) $(always)
        @:
</pre>
KBUILD_BUILTIN &#22312;&#39030;&#23618;Makefile &#20013;&#34987;&#21021;&#22987;&#21270;&#20026;1&#65292;&#25152;&#20197;&#36825;&#20010;&#35268;&#21017;&#30340;&#20381;&#36182;&#38656;&#35201;&#19968;&#20010;builtin-target &#21464;&#37327;&#12290;&#36825;&#20010;&#21464;&#37327;&#22312;scripts/Makefile.build&#20013;&#23450;&#20041;&#12290;
<pre class="programlisting">
ifneq ($(strip $(obj-y) $(obj-m) $(obj-n) $(obj-) $(lib-target)),)
builtin-target := $(obj)/built-in.o
endif
</pre>
&#21464;&#37327;obj &#23601;&#26159;vmlinux-dirs &#21464;&#37327;&#25351;&#23450;&#30340;&#30446;&#24405;&#12290;&#25152;&#20197;&#36825;&#37324;&#20250;&#26500;&#24314;$(vmlinux-dirs)/built-in.o &#30446;&#26631;&#65292;&#22312;scripts/Makefile.build &#25991;&#20214;&#20013;&#26377;&#36825;&#20010;&#30446;&#26631;&#30340;&#35268;&#21017;&#21450;&#21629;&#20196;&#30340;&#23450;&#20041;&#65306;
<pre class="programlisting">
ifdef builtin-target
quiet_cmd_link_o_target = LD      $@
# If the list of objects to link is empty, just create an empty built-in.o
cmd_link_o_target = $(if $(strip $(obj-y)),\
                      $(LD) $(ld_flags) -r -o $@ $(filter $(obj-y), $^) \
                      $(cmd_secanalysis),\
                      rm -f $@; $(AR) rcs $@)

$(builtin-target): $(obj-y) FORCE
        $(call if_changed,link_o_target)

targets += $(builtin-target)
endif # builtin-target
</pre>
vmlinux-dirs&#23558;&#22312;&#21518;&#38754;&#35299;&#37322;&#65292;&#23427;&#21253;&#21547;&#20102;&#25152;&#26377;&#30001;&#21464;&#37327;$(xx)&#20195;&#34920;&#30340;&#38656;&#35201;&#32534;&#35793;&#22788;&#29702;&#30340;&#25991;&#20214;&#22841;&#12290;&#25152;&#26377;&#30340;&#30446;&#26631;&#25991;&#20214;&#29983;&#25104;&#35268;&#21017;&#22312;scripts/Makefile.build&#20013;&#23450;&#20041;&#22914;&#19979;&#65306;
<pre class="programlisting">
# Built-in and composite module parts
$(obj)/%.o: $(src)/%.c FORCE
        $(call cmd,force_checksrc)
        $(call if_changed_rule,cc_o_c)
</pre>
vmlinux&#22312;&#29983;&#25104;&#23436;&#27605;&#21518;&#65292;&#25509;&#30528;&#20250;&#25191;&#34892;make -f scripts/Makefile.build obj=arch/arm/boot MACHINE=arch/arm/mach-s3c6400/ arch/arm/boot/zImage&#12290;arch/arm/boot/Makefile&#20013;&#23450;&#20041;&#20102;&#22914;&#19979;&#35268;&#21017;&#65306;
<pre class="programlisting">
$(obj)/zImage:  $(obj)/compressed/vmlinux FORCE
        $(call if_changed,objcopy)
        @echo '  Kernel: $@ is ready'
</pre>
&#21464;&#37327;obj&#30340;&#20540;&#21363;&#26159;arch/arm/boot&#12290;&#26174;&#28982;zImage&#27492;&#26102;&#21448;&#20381;&#36182;&#20110;$(obj)/compressed/vmlinux&#12290;
<pre class="programlisting">
$(obj)/compressed/vmlinux: $(obj)/Image FORCE
        $(Q)$(MAKE) $(build)=$(obj)/compressed $@
</pre>
&#25193;&#23637;&#24320;&#30340;&#21629;&#20196;&#22914;&#19979;&#65306;
<pre class="programlisting">
make -f scripts/Makefile.build obj=arch/arm/boot/compressed 
arch/arm/boot/compressed/vmlinux
</pre>
&#32487;&#32493;&#22238;&#21040;&#21387;&#32553;vmlinux&#29983;&#25104;&#21629;&#20196;&#65292;make -f scripts/Makefile.build obj=arch/arm/boot/compressed 
arch/arm/boot/compressed/vmlinux
&#27492;&#26102;obj=arch/arm/boot/compressed&#65292;&#25152;&#20197;scripts/Makefile.build&#20250;&#33258;&#21160;&#21253;&#21547;arch/arm/boot/compressed /Makefile&#65292;&#35813;&#25991;&#20214;&#25351;&#26126;&#20102;arch/arm/boot/compressed/vmlinux&#30340;&#29983;&#25104;&#35268;&#21017;&#65306;
<pre class="programlisting">
$(obj)/vmlinux: $(obj)/vmlinux.lds $(obj)/$(HEAD) $(obj)/piggy.o \
                $(addprefix $(obj)/, $(OBJS)) FORCE
        $(call if_changed,ld)
        @:

$(obj)/piggy.gz: $(obj)/../Image FORCE
        $(call if_changed,gzip) 

$(obj)/piggy.o:  $(obj)/piggy.gz FORCE
</pre>
&#36825;&#20004;&#20010;&#35268;&#21017;&#30340;&#31532;&#19968;&#20010;&#23601;&#26159;&#25226;&#30001;vmlinux &#36827;&#34892;objcopy&#29983;&#25104;&#30340;Image &#36827;&#34892;&#21387;&#32553;&#29983;&#25104;piggy.gz&#65292;&#28982;&#21518;&#29983;&#25104;piggy.o&#12290;cmd_ld &#21629;&#20196;&#22312;scripts/Makefile.lib &#25991;&#20214;&#23450;&#20041;&#65306;
<pre class="programlisting">
quiet_cmd_ld = LD $@
cmd_ld = $(LD) $(LDFLAGS) $(EXTRA_LDFLAGS) $(LDFLAGS_$(@F)) \
			$(filter-out FORCE,$^) -o $@
</pre>
&#36825;&#37324;&#26681;&#25454;&#38142;&#25509;&#33050;&#26412;arch/arm/boot/compressed/vmlinux.lds &#38142;&#25509;&#29983;&#25104;&#20102;arch/arm/boot/compressed/vmlinux &#25991;&#20214;&#12290;&#28982;&#21518;&#22312;arch/arm/boot/Makefile&#35268;&#21017;&#20013;&#65306;
<pre class="programlisting">
$(obj)/zImage: $(obj)/compressed/vmlinux FORCE
$(call if_changed,objcopy)
@echo ' Kernel: $@ is ready'
</pre>
&#32463;&#36807;objcopy&#22788;&#29702;&#21518;&#20415;&#29983;&#25104;&#20102;&#26368;&#32456;&#30340;zImage&#12290;
<pre class="programlisting">
vmlinux-&gt;objcopy-&gt;Image-&gt;piggy.gz-&gt;piggy.o-&gt;compreassed/vmlinux-&gt;objcopy-&gt;zImage
piggy.gz := gzip -f -9 &lt; arch/arm/boot/compressed/../Image &gt; arch/arm/boot/compressed/piggy.gz
</pre>
</div>
<div class="sect2" title="7.6. .cmd&#25991;&#20214;"><div class="titlepage"><div><div><h3 class="title"><a name="idp80425060"></a>7.6. .cmd&#25991;&#20214;</h3></div></div></div>
&#25628;&#32034;&#32534;&#35793;&#36807;&#30340;&#20869;&#26680;&#21487;&#20197;&#21457;&#29616;&#26377;&#24456;&#22810;.cmd&#25991;&#20214;&#65292;&#23427;&#20204;&#19982;&#30446;&#26631;&#25991;&#20214;&#30456;&#20276;&#32780;&#29983;&#12290;&#27604;&#22914;&#30446;&#26631;&#25991;&#20214;&#21517;&#20026;xxx&#65292;&#37027;&#20040;&#30456;&#21516;&#30446;&#24405;&#19979;&#23558;&#21487;&#20197;&#25214;&#21040;&#23545;&#24212;&#30340;.xxx.cmd&#25991;&#20214;&#12290;&#27604;&#22914;init/main.o&#23545;&#24212;.main.o.cmd&#65307;arch/arm/boot/compressed/piggy.gz &#23545;&#24212;.piggy.gz.cmd&#65307;arch/arm/boot/zImage &#23545;&#24212;.zImage.cmd&#12290;.cmd&#25991;&#20214;&#26159;&#30001;&#21517;&#20026;make-cmd&#30340;&#23376;&#21629;&#20196;&#29983;&#25104;&#30340;&#65292;&#23427;&#23450;&#20041;&#22312;scripts/Kbuild.include&#65306;
<pre class="programlisting">
# &gt;'&lt; substitution is for echo to work,
# &gt;$&lt; substitution to preserve $ when reloading .cmd file
# note: when using inline perl scripts [perl -e '...$$t=1;...']
# in $(cmd_xxx) double $$ your perl vars
make-cmd = $(subst \#,\\\#,$(subst $$,$$$$,$(call escsq,$(cmd_$(1)))))
</pre>
escsq&#23376;&#21629;&#20196;&#23450;&#20041;&#22914;&#19979;&#65306;
<pre class="programlisting">
squote  := '
# Escape single quote for use in echo statements
escsq = $(subst $(squote),'\$(squote)',$1)
</pre>
&#25509;&#19979;&#26469;&#30475;&#19968;&#20010;&#23454;&#38469;&#30340;&#24212;&#29992;&#65292;&#36825;&#20010;&#24212;&#29992;&#26159;&#26368;&#32456;&#29983;&#25104;&#20027;&#30446;&#24405;&#19979;vmlinux&#30340;&#21629;&#20196;&#65306;
<pre class="programlisting">
vmlinux: $(vmlinux-lds) $(vmlinux-init) $(vmlinux-main) vmlinux.o $(kallsyms.o) FORCE
	......
	$(call if_changed_rule,vmlinux__)
</pre>
Makefile&#20013;&#30340;call&#20989;&#25968;&#26159;&#21807;&#19968;&#19968;&#20010;&#21487;&#20197;&#29992;&#26469;&#21019;&#24314;&#26032;&#30340;&#21442;&#25968;&#21270;&#30340;&#20989;&#25968;&#12290;&#23427;&#30340;&#35821;&#27861;&#20026;&#65306;
<pre class="programlisting">
$(call &lt;expression&gt;;,&lt;parm1&gt;;,&lt;parm2&gt;;,&lt;parm3&gt;;...)
</pre>
&#24403;make&#25191;&#34892;&#36825;&#20010;&#20989;&#25968;&#26102;&#65292;expression&#34920;&#36798;&#24335;&#20013;&#30340;&#21464;&#37327;&#65292;&#22914;$(1)&#65292;$(2)&#65292;$(3)&#31561;&#65292;&#20250;&#34987;&#21442;&#25968;parm1&#65292;parm2&#65292; parm3&#31561;&#20381;&#27425;&#26367;&#20195;&#12290;&#32780;expression&#34920;&#36798;&#24335;&#30340;&#36820;&#22238;&#20540;&#23601;&#26159;call&#20989;&#25968;&#30340;&#36820;&#22238;&#20540;&#12290;&#25152;&#20197;&#36825;&#37324;&#20250;&#25191;&#34892;if_changed_rule&#34920;&#36798;&#24335;&#65292;&#24182;&#19988;vmlinux_&#23558;&#34987;&#20256;&#24471;&#32473;&#23427;&#12290;if_changed_rule&#23376;&#21629;&#20196;&#23450;&#20041;&#22312;scripts/Kbuild.include&#20013;&#65292;&#31867;&#20284;&#30340;&#36824;&#26377;if_changed&#21644;if_changed_dep.
<pre class="programlisting">
# Usage: $(call if_changed_rule,foo)
# Will check if $(cmd_foo) or any of the prerequisites changed,
# and if so will execute $(rule_foo).
if_changed_rule = $(if $(strip $(any-prereq) $(arg-check) ),                 \
        @set -e;                                                             \
        $(rule_$(1)))
</pre>
if_changed_rule&#25193;&#23637;&#21442;&#25968;&#21518;&#30340;&#34920;&#36798;&#24335;&#22914;&#19979;&#65306;
<pre class="programlisting">
$(if $(strip $(any-prereq) $(arg-check) ),@set -e;$(rule_vmlinux_))

# Find any prerequisites that is newer than target or that does not exist.
# PHONY targets skipped in both cases.
any-prereq = $(filter-out $(PHONY),$?) $(filter-out $(PHONY) $(wildcard $^),$^)
</pre>
any-prereq&#29992;&#26469;&#25910;&#38598;&#30446;&#26631;&#25991;&#20214;&#30340;&#20381;&#36182;&#25991;&#20214;&#65292;&#25214;&#20986;&#26356;&#26032;&#30340;&#20381;&#36182;&#25991;&#20214;&#25110;&#32773;&#23577;&#19981;&#23384;&#22312;&#38656;&#35201;&#32534;&#35793;&#26102;&#29983;&#25104;&#30340;&#20381;&#36182;&#65292;
&#33258;&#21160;&#21270;&#21464;&#37327;$?&#20195;&#34920;&#25152;&#26377;&#27604;&#30446;&#26631;&#36824;&#35201;&#26032;&#30340;&#20381;&#36182;&#25991;&#20214;&#65307;$^ &#21017;&#34920;&#31034;&#25152;&#26377;&#30340;&#20381;&#36182;&#25991;&#20214;&#12290;filter-out&#21453;&#36807;&#28388;&#20989;&#25968;&#23558;$?&#20013;&#30340;&#25152;&#26377;&#20266;&#30446;&#26631;&#36807;&#28388;&#25481;&#12290;&#31532;&#20108;&#20010;&#21453;&#36807;&#28388;&#20989;&#25968;&#36807;&#28388;&#20986;&#25152;&#26377;&#20381;&#36182;&#25991;&#20214;&#20013;&#24050;&#32463;&#23384;&#22312;&#30340;&#25991;&#20214;&#20197;&#21450;&#20266;&#30446;&#26631;&#65292;&#26377;&#20123;&#20381;&#36182;&#38656;&#35201;&#22312;&#32534;&#35793;&#26102;&#33258;&#21160;&#21019;&#24314;&#65292;&#27604;&#22914;vmlinux&#20381;&#36182;&#30340;arch/arm/kernel/vmlinux.lds&#25991;&#20214;&#12290;
<pre class="programlisting">
ifneq ($(KBUILD_NOCMDDEP),1)
# Check if both arguments has same arguments. Result is empty string if equal.
# User may override this check using make KBUILD_NOCMDDEP=1
arg-check = $(strip $(filter-out $(cmd_$(1)), $(cmd_$@)) \
                    $(filter-out $(cmd_$@),   $(cmd_$(1))) )
endif
</pre>
arg-check&#29992;&#26469;&#26816;&#27979;&#27492;&#27425;&#32534;&#35793;&#26102;&#25152;&#29992;&#21629;&#20196;&#21450;&#21442;&#25968;&#26159;&#21542;&#21644;&#19978;&#27425;&#25152;&#29992;&#21442;&#25968;&#19968;&#33268;&#12290;$@ &#34920;&#31034;&#30446;&#26631;&#25991;&#20214;&#65292;&#20063;&#21363;vmlinux&#65292;&#25152;&#20197;cmd_$@&#21363;&#20026;cmd_vmlinux&#12290;&#20877;&#27604;&#22914;&#32534;&#35793;xxx.o&#65292;&#37027;&#20040; $(cmd_$@) &#23601;&#26159;&#34920;&#31034; $(cmd_xxx.o)&#12290;&#22312;.vmlinux.cmd &#25991;&#20214;&#20013;&#21487;&#20197;&#30475;&#21040;cmd_vmlinux&#29992;&#26469;&#20445;&#23384;&#30528;&#19978;&#27425;&#32534;&#35793;&#30340;&#21442;&#25968;&#12290;
<pre class="programlisting">
# cat  .vmlinux.cmd 
cmd_vmlinux := /usr/local/arm/4.2.2-eabi/usr/bin/arm-linux-ld -EL  -p --no-undefined -X -o 
vmlinux -T arch/arm/kernel/vmlinux.lds arch/arm/kernel/head.o arch/arm/kernel/init_task.o  
init/built-in.o --start-group  usr/built-in.o  arch/arm/kernel/built-in.o  arch/arm/mm/built-in.o  
arch/arm/common/built-in.o  arch/arm/mach-s3c6400/built-in.o  
arch/arm/mach-s3c6410/built-in.o  arch/arm/plat-s3c64xx/built-in.o  
arch/arm/plat-s3c/built-in.o  arch/arm/nwfpe/built-in.o  arch/arm/vfp/built-in.o  
kernel/built-in.o  mm/built-in.o  fs/built-in.o  ipc/built-in.o  security/built-in.o  crypto/built-in.o  
block/built-in.o  arch/arm/lib/lib.a  lib/lib.a  arch/arm/lib/built-in.o  lib/built-in.o  
drivers/built-in.o  sound/built-in.o  firmware/built-in.o  net/built-in.o 
--end-group .tmp_kallsyms2.o
</pre>
&#22312; arg-check &#20013;&#65292;&#39318;&#20808;&#20351;&#29992; $(filter-out $(cmd_$(1)), $(cmd_$@)) &#20174;&#19978;&#19968;&#27425;&#30340;&#32534;&#35793;&#21629;&#20196;&#21644;&#21442;&#25968;&#20013;&#28388;&#38500;&#25481;&#27492;&#27425;&#32534;&#35793;&#20351;&#29992;&#30340;&#21629;&#20196;&#21644;&#21442;&#25968;&#65292;&#20877;&#36827;&#34892;&#19968;&#27425;&#21453;&#36807;&#28388;&#12290;&#27491;&#21453;&#36807;&#28388;&#30340;&#21407;&#22240;&#26159;&#65292;filter-out &#20989;&#25968;&#22312;&#36807;&#28388;&#26102;&#65292;&#22914;&#26524;&#31532; 2 &#20010;&#21629;&#20196;&#21644;&#21442;&#25968;&#26159;&#31532;1&#20010;&#21629;&#20196;&#21644;&#21442;&#25968;&#30340;&#23376;&#38598;&#25110;&#32773;&#26159;&#30456;&#21516;&#65292;&#37027;&#20040;&#36820;&#22238;&#31354;&#65307;&#25152;&#20197;&#65292;&#22312;&#31532;1&#27425;&#36807;&#28388;&#26102;&#22914;&#26524;&#36820;&#22238;&#20026;&#31354;&#65292;&#37027;&#20040;cmd_$@ &#21487;&#33021;&#26159;&#31561;&#20110; cmd_$(1) &#30340;&#65292;&#20063;&#21487;&#33021;&#26159;&#23427;&#30340;&#23376;&#38598;&#65292;&#25152;&#20197;&#21482;&#26377;&#24403;&#20877;&#27425;&#21453;&#36807;&#26469;&#20570;&#36807;&#28388;&#26102;&#21457;&#29616;&#36820;&#22238;&#20026;&#31354;&#65292;&#37027;&#20040;&#25165;&#33021;&#21028;&#26029;&#20004;&#27425;&#32534;&#35793;&#30340;&#21442;&#25968;&#26159;&#30456;&#31561;&#30340;&#65292;&#21542;&#21017;&#26159;&#19981;&#31561;&#30340;&#12290;&#22914;&#26524;&#36820;&#22238;&#32467;&#26524;&#19981;&#20026;&#31354;&#65292;&#35828;&#26126;&#32534;&#35793;&#21442;&#25968;&#21457;&#29983;&#20102;&#21464;&#21270;&#65306;1.&#21442;&#25968;&#22686;&#21152;&#65292;&#37027;&#20040;&#31532;&#20108;&#27425;&#36807;&#28388;&#19981;&#20026;&#31354;&#65307;2.&#21442;&#25968;&#20943;&#23569;&#65292;&#37027;&#20040;&#31532;&#19968;&#27425;&#36807;&#28388;&#19981;&#20026;&#31354;&#65307;3.&#21442;&#25968;&#39034;&#24207;&#21464;&#21270;&#65292;&#31532;&#19968;&#27425;&#21644;&#31532;&#20108;&#27425;&#37117;&#19981;&#20026;&#31354;&#12290;
<p>
&#36825;&#37324;&#19981;&#24471;&#19981;&#25552;&#21450;&#27599;&#20010;&#25991;&#20214;&#22841;&#19979;&#30340;.cmd&#25991;&#20214;&#26159;&#24590;&#26679;&#34987;&#21253;&#21547;&#36827;Makefile&#30340;&#12290;&#23427;&#20204;&#22312;scripts/Makefile.build&#20013;&#34987;&#21253;&#21547;&#20102;&#36827;&#26469;&#65292;&#25152;&#26377;&#20351;&#29992;&#27492;Makefile.build&#32534;&#35793;&#20026;&#30446;&#26631;&#65292;&#23427;&#20204;&#30340;.cmd&#25991;&#20214;&#22343;&#34987;&#21253;&#21547;&#36827;&#26469;&#65306;
</p>
<pre class="programlisting">
targets := $(wildcard $(sort $(targets)))
cmd_files := $(wildcard $(foreach f,$(targets),$(dir $(f)).$(notdir $(f)).cmd))

ifneq ($(cmd_files),)
  include $(cmd_files)
endif
</pre>
&#20540;&#24471;&#19968;&#25552;&#30340;&#26159;&#24182;&#19981;&#26159;&#25152;&#26377;&#30340;.cmd&#25991;&#20214;&#37117;&#26377;&#23427;&#21253;&#21547;&#36827;&#26469;&#65292;&#32780;&#26159;&#30001;&#20351;&#29992;&#27492;Makefile.build&#32534;&#35793;&#30340;&#30446;&#26631;&#25991;&#20214;&#30340;.cmd&#25991;&#20214;&#65292;&#37027;&#20040;&#20854;&#20182;&#30340;&#27604;&#22914;vmlinux&#23601;&#26159;&#20351;&#29992;&#20027;&#25991;&#20214;&#22841;&#19979;&#30340;Makefile&#65292;&#25152;&#20197;&#23427;&#37324;&#38754;&#20063;&#26377;&#19982;scripts/Makefile.build&#30456;&#21516;&#30340;include $(cmd_files)&#23450;&#20041;&#12290;&#20877;&#22238;&#21040;if_changed_rule&#25193;&#23637;&#21442;&#25968;&#21518;&#30340;&#34920;&#36798;&#24335;&#65306;
<pre class="programlisting">
$(if $(strip $(any-prereq) $(arg-check) ),@set -e;$(rule_vmlinux_))
</pre>
any-prereq&#23436;&#25104;&#20102;&#20381;&#36182;&#30340;&#26816;&#26597;&#65292;arg-check&#23436;&#25104;&#20102;&#21629;&#20196;&#21644;&#21442;&#25968;&#30340;&#26816;&#26597;&#65292;&#21482;&#35201;&#26377;&#19968;&#31181;&#24773;&#20917;&#21457;&#29983;&#65292;&#37027;&#20040;if&#35821;&#21477;
&#23601;&#36820;&#22238;&#30495;&#65292;@set -e;$(rule_vmlinux_)&#23601;&#24471;&#21040;&#25191;&#34892;&#12290;set &#8211;e&#36843;&#20351;$(rule_vmlinux_)&#22312;&#36820;&#22238;&#38750;0&#20540;&#26102;&#31435;&#21051;&#36820;&#22238;&#12290;rule_vmlinux_&#23450;&#20041;&#22312;&#20027;Makefile&#20013;&#65292;&#23427;&#36890;&#36807;&#35843;&#29992;cmd_ vmlinux__&#26368;&#32456;&#29983;&#25104;&#20102;vmlinux&#12290;
<pre class="programlisting">
define rule_vmlinux__
        :
        $(if $(CONFIG_KALLSYMS),,+$(call cmd,vmlinux_version))

        $(call cmd,vmlinux__)
        $(Q)echo 'cmd_$@ := $(cmd_vmlinux__)' &gt; $(@D)/.$(@F).cmd

        $(Q)$(if $($(quiet)cmd_sysmap),                                      \
          echo '  $($(quiet)cmd_sysmap)  System.map' &amp;&amp;)                     \
        $(cmd_sysmap) $@ System.map;                                         \
        if [ $$? -ne 0 ]; then                                               \
                rm -f $@;                                                    \
                /bin/false;                                                  \
        fi;
        $(verify_kallsyms)
endef
</pre>
&#27880;&#24847;&#21040;  $(Q)echo 'cmd_$@ := $(cmd_vmlinux__)' &gt; $(@D)/.$(@F).cmd&#36825;&#21477;&#35805;&#65292;&#23427;&#29983;&#25104;&#20102;&#30446;&#26631;vmlinux&#23545;&#24212;&#30340;.vmlinux.cmd&#25991;&#20214;&#12290;
<p>
$(@D)&#34920;&#31034;"$@"&#30340;&#30446;&#24405;&#37096;&#20998;&#65288;&#19981;&#20197;&#26012;&#26464;&#20316;&#20026;&#32467;&#23614;&#65289;&#65292;&#22914;&#26524;"$@"&#20540;&#26159;"dir/foo.o"&#65292;&#37027;&#20040;"$(@D)"&#23601;&#26159;"dir"&#65292;&#32780;&#22914;&#26524;"$@"&#20013;&#27809;&#26377;&#21253;&#21547;&#26012;&#26464;&#30340;&#35805;&#65292;&#20854;&#20540;&#23601;&#26159;"."&#65292;&#20063;&#21363;&#24403;&#21069;&#30446;&#24405;&#12290;</p>
<p>
&#21487;&#20197;&#30475;&#21040;.cmd&#26159;&#26377;&#35268;&#21017;rule_vmlinux__&#26469;&#29983;&#25104;&#30340;&#65292;&#24182;&#19981;&#26159;&#25152;&#26377;&#30340;.cmd&#37117;&#26159;&#30001;&#23427;&#29983;&#25104;&#30340;&#65292;&#22823;&#22810;&#25968;&#30340;.cmd&#26159;&#30001;if_changed&#30340;&#35843;&#29992;&#20135;&#29983;&#65306;</p>
<pre class="programlisting">
if_changed = $(if $(strip $(any-prereq) $(arg-check)),                       \
        @set -e;                                                             \
        $(echo-cmd) $(cmd_$(1));                                             \
        echo 'cmd_$@ := $(make-cmd)' &gt; $(dot-target).cmd)
</pre>
&#35832;&#22810;cmd_xxx&#24418;&#24335;&#30340;&#21629;&#20196;&#37117;&#35843;&#29992;&#20102;if_changed&#12290;if_changed_dep&#26159;&#21478;&#19968;&#20010;&#21487;&#33021;&#20135;&#29983;.cmd&#30340;&#35843;&#29992;&#65292;&#23427;&#35843;&#29992;&#20102;scripts/basic/fixdep&#26469;&#22788;&#29702;&#37197;&#32622;&#31526;&#21495;&#30340;&#20381;&#36182;&#20851;&#31995;&#12290;.cmd&#23545;&#20110;&#20998;&#26512;&#20869;&#26680;&#30340;&#32534;&#35793;&#36807;&#31243;&#65292;&#33267;&#20851;&#37325;&#35201;&#65292;&#23427;&#25552;&#20379;&#20102;&#30446;&#26631;&#29983;&#25104;&#30340;&#21629;&#20196;&#21644;&#21442;&#25968;&#65292;&#20197;&#21450;&#30456;&#20851;&#30340;&#20381;&#36182;&#25991;&#20214;&#12290;
</div>
<div class="sect2" title="7.7. V=2"><div class="titlepage"><div><div><h3 class="title"><a name="idp80433836"></a>7.7. V=2</h3></div></div></div>
&#21069;&#38754;&#25552;&#21040;V=1&#65292;&#36825;&#37324;&#20877;&#32493;&#21069;&#32536;: V=2&#12290;V=1&#20687;&#19968;&#20010;&#38271;&#33292;&#22919;&#19968;&#26679;&#21521;&#20320;&#21792;&#21480;&#20010;&#27809;&#23436;&#65292;&#23558;&#25152;&#26377;&#20320;&#20851;&#24515;&#19981;&#20851;&#24515;&#30340;&#32534;&#35793;&#20449;&#24687;&#37117;&#20002;&#20986;&#26469;&#12290;&#32780;V=2&#21017;&#26159;&#19968;&#20010;&#35757;&#32451;&#26377;&#32032;&#30340;&#25506;&#21592;&#65292;&#23427;&#21482;&#21578;&#35785;&#20320;&#21457;&#29983;&#20102;&#20160;&#20040;&#20877;&#21152;&#20026;&#20160;&#20040;&#65311;&#38500;&#20102;What&#21644;Why&#65311;&#20320;&#36824;&#38656;&#35201;&#30693;&#36947;&#20160;&#20040;&#21602;&#65311; &#26080;&#38750;&#26159;How! &#22312;&#32534;&#35793;&#36807;&#30340;&#28304;&#30721;init/main.c&#20013;&#28155;&#21152;&#19968;&#20010;&#31354;&#26684;&#65292;&#28982;&#21518;&#37325;&#26032;&#32534;&#35793;&#65306;
<pre class="programlisting">
#make V=2 |grep "due to"
</pre>
&#23383;&#31526;&#20018;"due to"&#26159;V=2&#26102;&#29305;&#26377;&#30340;&#20449;&#24687;&#65292;&#25105;&#20204;&#21482;&#20851;&#24515;&#36825;&#20123;&#20449;&#24687;&#65292;&#36890;&#36807;&#23427;&#20204;&#25152;&#26377;&#30340;&#25991;&#20214;&#21464;&#21160;&#21644;&#20381;&#36182;&#20851;&#31995;&#37117;&#19968;&#30446;&#20102;&#28982;&#12290;
<pre class="programlisting">
  CALL    scripts/checksyscalls.sh - due to target is PHONY
  CC      init/main.o - due to: init/main.c
  LD      init/built-in.o - due to: init/main.o
  GEN     .version - due to: init/built-in.o
  CC      init/version.o - due to: include/linux/compile.h
......
  OBJCOPY arch/arm/boot/Image - due to: vmlinux
  GZIP    arch/arm/boot/compressed/piggy.gz - due to: arch/arm/boot/compressed/../Image
  AS      arch/arm/boot/compressed/piggy.o - due to: arch/arm/boot/compressed/piggy.gz
  LD      arch/arm/boot/compressed/vmlinux - due to: arch/arm/boot/compressed/piggy.o
  OBJCOPY arch/arm/boot/zImage - due to: arch/arm/boot/compressed/vmlinux
  MODPOST 4 modules - due to target is PHONY
</pre>
scripts/Kbuild.include&#25991;&#20214;&#30340;&#26411;&#23614;&#23450;&#20041;&#20102;V=2&#30340;&#23454;&#29616;&#65292;&#24182;&#32473;&#20986;&#20102;&#35814;&#32454;&#30340;&#23545;&#20110;&#36755;&#20986;&#20449;&#24687;&#30340;&#35299;&#37322;&#65306;
<pre class="programlisting">
###
# &#20026;&#20160;&#20040;&#65311;&#21578;&#35785;&#25105;&#19968;&#20010;&#30446;&#26631;&#26159;&#22240;&#20026;&#20160;&#20040;&#32780;&#34987;(&#37325;&#26032;)&#21019;&#24314;&#65292;&#37027;&#23601;&#36890;&#36807;V=2&#21442;&#25968;&#21543;&#65281;&#36755;&#20986;&#32467;&#26524;&#26681;&#25454;&#20197;&#19979;&#26816;&#26597;&#39034;
#&#24207;&#26469;&#36755;&#20986;&#65306;
#          (1) &#8211;&#30446;&#26631;&#26159;PHONY&#30340;&#65292;&#20063;&#21363;&#20266;&#30446;&#26631;&#65292;&#20266;&#30446;&#26631;&#22312;&#20219;&#20309;&#26102;&#20505;&#37117;&#38656;&#35201;&#34987;&#26356;&#26032;
#          (2) &#8211;&#30446;&#26631;&#25991;&#20214;&#19981;&#23384;&#22312;&#65292;&#21487;&#33021;&#34987;&#21024;&#38500;&#20102;&#65292;&#25110;&#32773;&#27809;&#26377;&#34987;&#32534;&#35793;&#36807;&#65292;&#21453;&#27491;&#23427;&#19981;&#22312;&#20102;
#          (3) &#8211;&#30446;&#26631;&#25991;&#20214;&#20381;&#36182;&#30340;&#22836;&#25991;&#20214;&#26356;&#26032;&#20102;   
#          (4) &#8211;&#29983;&#25104;&#30446;&#26631;&#25991;&#20214;&#30340;&#21629;&#20196;&#25110;&#21442;&#25968;&#25913;&#21464;&#20102;
#          (5) &#8211;&#35760;&#24405;&#19978;&#19968;&#27425;&#29983;&#25104;&#30446;&#26631;&#25991;&#20214;&#30340;.cmd&#25991;&#20214;&#19981;&#35265;&#20102;
#          (6) &#8211;&#30446;&#26631;&#25991;&#20214;&#27809;&#26377;&#22312; $(targets)&#21442;&#25968;&#20013;&#25552;&#20379;&#65292;&#30475;&#26469;&#23427;&#26159;&#40664;&#35748;&#35201;&#29983;&#25104;&#30340;&#20102;
#    &#23545;&#20110;&#19968;&#20010;&#38169;&#35823;&#23450;&#20041;&#30340;kbuild file&#65292; &#36825;&#26159;&#19968;&#20010;&#22909;&#30340;&#25552;&#31034;&#65292; &#23427;&#20250;&#24110;&#21161;&#20320;&#25214;&#21040;&#38169;&#35823;&#30340;&#21407;&#22240;&#12290;
ifeq ($(KBUILD_VERBOSE),2)
why =                                                                        \
    $(if $(filter $@, $(PHONY)),- due to target is PHONY,                    \
        $(if $(wildcard $@),                                                 \
            $(if $(strip $(any-prereq)),- due to: $(any-prereq),             \
                $(if $(arg-check),                                           \
                    $(if $(cmd_$@),- due to command line change,             \
                        $(if $(filter $@, $(targets)),                       \
                            - due to missing .cmd file,                      \
                            - due to $(notdir $@) not in $$(targets)         \
                         )                                                   \
                     )                                                       \
                 )                                                           \
             ),                                                              \
             - due to target missing                                         \
         )                                                                   \
     )
echo-why = $(call escsq, $(strip $(why)))
endif
</pre>
echo-why&#34987;echo-cmd&#35843;&#29992;&#65292;&#32780;echo-cmd&#21448;&#34987;if_changed&#21644;if_changed_dep&#35843;&#29992;&#12290;&#21478;&#22806;rule_cc_o_c&#20063;&#35843;&#29992;&#20102;echo-cmd&#12290;&#21478;&#19968;&#20123;&#21629;&#20196;&#21487;&#33021;&#24341;&#29992;cmd&#65292;&#24182;&#38388;&#25509;&#35843;&#29992;&#21040;&#20102;echo-cmd&#12290;&#36825;&#20123;&#24341;&#29992;&#22914;&#22825;&#32599;&#22320;&#32593;&#33324;&#30340;&#21736;&#20853;&#65292;&#26368;&#32456;&#34987;V=2&#25506;&#21592;&#36827;&#34892;&#35843;&#24230;&#12290;
</div>
<div class="sect2" title="7.8. piggy.gz"><div class="titlepage"><div><div><h3 class="title"><a name="idp80452052"></a>7.8. piggy.gz</h3></div></div></div>
&#19981;&#30693;&#26159;Russell King&#36824;&#26159;Linus Torvalds&#26356;&#21916;&#27426;&#23567;&#29482;&#65292;&#21453;&#27491;piggy&#34987;&#24341;&#20837;&#21040;&#20102;ARM&#30340;&#24341;&#23548;&#20195;&#30721;&#20013;&#12290;&#25454;&#32771;piggy&#26159;&#20174;piggyback&#32553;&#20889;&#32780;&#26469;&#30340;&#65292;&#20013;&#25991;&#24847;&#20026;&#8220;&#39569;&#22312;&#32937;&#19978;&#8221;&#65292;&#26174;&#28982;&#26159;&#25351;Linux&#30340;&#21551;&#21160;&#38656;&#35201;&#8220;&#39569;&#22312;&#8221;piggy.gz&#30340;&#32937;&#19978;&#20102;&#12290;&#22909;&#20102;&#65292;&#36825;&#37324;&#19981;&#20877;&#37027;&#20040;&#36153;&#20107;&#30340;&#20998;&#26512;arch/arm/boot/compressed/Makefile&#20102;&#65292; &#26082;&#28982;&#35828;&#36807;&#20102;.cmd&#65292;&#37027;&#23601;&#30452;&#25509;&#30475;&#30475;.piggy.gz.cmd
<pre class="programlisting">
cmd_arch/arm/boot/compressed/piggy.gz := gzip -f -9 &lt; 
arch/arm/boot/compressed/../Image &gt; arch/arm/boot/compressed/piggy.gz
</pre>
-f&#25110;--force &#12288;&#24378;&#34892;&#21387;&#32553;&#25991;&#20214;&#12290;&#19981;&#29702;&#20250;&#25991;&#20214;&#21517;&#31216;&#25110;&#30828;&#36830;&#25509;&#26159;&#21542;&#23384;&#22312;&#20197;&#21450;&#35813;&#25991;&#20214;&#26159;&#21542;&#20026;&#31526;&#21495;&#36830;&#25509;&#12290;
-1&#25110;--fast&#34920;&#31034;&#26368;&#24555;&#21387;&#32553;&#26041;&#27861;&#65288;&#20302;&#21387;&#32553;&#27604;&#65289;&#65292;-9&#25110;--best&#34920;&#31034;&#26368;&#24930;&#21387;&#32553;&#26041;&#27861;&#65288;&#39640;&#21387;&#32553;&#27604;&#65289;&#12290;&#20351;&#29992;&#26368;&#39640;&#21387;&#32553;&#27604;&#23558;arch/arm/boot/compressed/../Image&#21387;&#32553;&#20026;
arch/arm/boot/compressed/piggy.gz&#65292;&#23567;&#29482;&#35806;&#29983;&#20102;&#12290;&#26597;&#30475;.piggy.o.cmd&#65292;&#21457;&#29616;&#36825;&#20010;&#21629;&#20196;&#34892;&#38271;&#22823;&#20102;&#65292;&#24681;&#65292;&#23567;&#29482;&#38271;&#22823;&#20102;&#65281;
<pre class="programlisting">
cmd_arch/arm/boot/compressed/piggy.o := /usr/local/arm/4.2.2-eabi/usr/bin/arm-linux-gcc 
-Wp,-MD,arch/arm/boot/compressed/.piggy.o.d  -nostdinc &#8211;isystem
 /usr/local/arm/4.2.2-eabi/usr/bin-ccache/../lib/gcc/arm-unknown-linux-gnueabi/4.2.2/include 
-D__KERNEL__ -Iinclude  -I/home/red/forlinux/linux2.6.28/arch/arm/include -include 
include/linux/autoconf.h -mlittle-endian -Iarch/arm/mach-s3c6400/include 
-Iarch/arm/mach-s3c6410/include -Iarch/arm/plat-s3c64xx/include -Iarch/arm/plat-s3c/include 
-D__ASSEMBLY__ -mabi=aapcs-linux -mno-thumb-interwork -D__LINUX_ARM_ARCH__=6 
-march=armv6k -mtune=arm1136j-s -msoft-float -gdwarf-2  -Wa,-march=all   -c -o 
arch/arm/boot/compressed/piggy.o arch/arm/boot/compressed/piggy.S
</pre>
&#21629;&#20196;&#34892;&#20013;&#27809;&#26377;&#25552;&#21040;&#20219;&#20309;piggy.gz&#30340;&#20449;&#24687;&#65292;&#20294;&#26159;&#29983;&#25104;&#30340;.o&#25991;&#20214;&#30340;&#22823;&#23567;&#20960;&#20046;&#21644;.gz&#25991;&#20214;&#19968;&#33268;&#65292;&#32780;piggy.S
&#21017;&#24456;&#23567;&#65292;&#38382;&#39064;&#20986;&#22312;&#21738;&#21602;&#65311;piggy.S&#30340;&#20869;&#23481;&#34920;&#26126;&#20102;&#19968;&#20999;&#65306;
<pre class="programlisting">
        .section .piggydata,#alloc
        .globl  input_data
input_data:
        .incbin "arch/arm/boot/compressed/piggy.gz"
        .globl  input_data_end
input_data_end:
</pre>
&#23450;&#20041;&#20102;&#19968;&#20010;&#21517;&#20026;.piggydata&#30340;&#27573;&#65292;&#35813;&#27573;&#20013;&#30340;&#25968;&#25454;&#23601;&#26159;piggy.gz&#12290;input_data&#31526;&#21495;&#35201;&#34987;&#38142;&#25509;&#22120;&#29992;&#21040;&#65292;&#25152;&#20197;&#35201;&#26631;&#35760;&#23427;&#26159;&#19968;&#20010;.globl&#20840;&#23616;&#31526;&#21495;&#12290;.incbin&#25351;&#20196;&#22312;&#34987;&#27719;&#32534;&#30340;&#25991;&#20214;&#20869;&#21253;&#21547;&#19968;&#20010;&#25991;&#20214;&#65292;&#35813;&#25991;&#20214;&#25353;&#21407;&#26679;&#21253;&#21547;&#65292;&#27809;&#26377;&#36827;&#34892;&#27719;&#32534;&#12290;input_data_end&#31526;&#21495;&#20063;&#35201;&#34987;&#22806;&#37096;&#24341;&#29992;&#12290;input_data&#34987;&#22806;&#37096;&#24341;&#29992;&#26102;&#30340;&#20540;&#20026;piggy.gz&#25991;&#20214;&#22312;piggy.o&#30340;&#36215;&#22987;&#22320;&#22336;&#65292;input_data_end&#21017;&#26159;&#32467;&#26463;&#22320;&#22336;&#12290;&#36825;&#37324;&#32473;&#20986;&#35777;&#26126;&#65288;&#23454;&#35777;&#27861;^;^&#65289;&#65306;
<pre class="programlisting">
## ls -l piggy.gz 
-rw-rw-rw- 1 root root 2469926 2011-08-19 17:52 piggy.gz
#readelf piggy.o -S
There are 9 section headers, starting at offset 0x25b0bc:

Section Headers:
[Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al
[ 0]                   NULL            00000000 000000 000000 00      0   0  0
[ 1] .text             PROGBITS        00000000 000034 000000 00  AX  0   0  1
[ 2] .data             PROGBITS        00000000 000034 000000 00  WA  0   0  1
[ 3] .bss              NOBITS          00000000 000034 000000 00  WA  0   0  1
[ 4] .piggydata        PROGBITS        00000000 000034 25b026 00   A  0   0  1
[ 5] .ARM.attributes   ARM_ATTRIBUTES  00000000 25b05a 000019 00      0   0  1
[ 6] .shstrtab         STRTAB          00000000 25b073 000047 00      0   0  1
[ 7] .symtab           SYMTAB          00000000 25b224 000080 10      8   6  4
[ 8] .strtab           STRTAB          00000000 25b2a4 00001b 00      0   0  1
Key to Flags:
  W (write), A (alloc), X (execute), M (merge), S (strings)
  I (info), L (link order), G (group), T (TLS), E (exclude), x (unknown)
  O (extra OS processing required) o (OS specific), p (processor specific)
</pre>
&#27880;&#24847;&#21040;piggydata&#20013;&#30340;SIZE&#20026;25b026 00&#65292;&#36716;&#25442;&#20026;&#21313;&#36827;&#21046;&#23601;&#26159;2469926&#12290;&#24182;&#19988;input_data&#30340;&#20540;&#20026;0x34&#65292;
input_data_end&#30340;&#20540;&#20026;0x25b05a&#12290;&#20877;&#30475;compreassed/vmlinux-&gt;objcopy-&gt;zImage&#30340;&#26368;&#32456;&#36807;&#31243;
<pre class="programlisting">
/usr/local/arm/4.2.2-eabi/usr/bin/arm-linux-ld -EL    --defsym zreladdr=0x50008000 --defsym 
params_phys=0x50000100 -p --no-undefined &#8211;X
/usr/local/arm/4.2.2-eabi/usr/bin-ccache/../lib/gcc/arm-unknown-linux-gnueabi/4.2.2/libgcc.a 
-T arch/arm/boot/compressed/vmlinux.lds arch/arm/boot/compressed/head.o 
arch/arm/boot/compressed/piggy.o arch/arm/boot/compressed/misc.o -o 
arch/arm/boot/compressed/vmlinux
</pre>
<p>vmlinux&#20381;&#36182;&#20110;&#23567;&#29482;piggy.o&#65292;misc.o&#21644;head.o&#12290;misc.o&#21644;head.o&#23545;&#24212;misc.c&#21644;head.S&#25991;&#20214;&#12290;&#27880;&#24847;&#20869;&#26680;vmlinux&#29992;&#30340;&#26159;arch/arm/kernel/head.S&#12290;&#36825;&#37324;&#26159;arch/arm/boot/compressed/head.S&#12290;
</p><p>
&#20877;&#30475;&#30475;misc.c&#20013;decompress_kernel&#20989;&#25968;&#21543;&#65292;&#23427;&#23558;&#35843;&#29992;gunzip()&#35299;&#21387;&#20869;&#26680;&#12290;gunzip()&#22312;lib/inflate.c&#20013;&#23450;&#20041;&#65292;&#23427;&#23558;&#35843;&#29992;NEXTBYTE()&#65292;&#36827;&#32780;&#35843;&#29992;get_byte()&#26469;&#33719;&#21462;&#21387;&#32553;&#20869;&#26680;&#20195;&#30721;&#12290;</p>
<pre class="programlisting">
#define get_byte() (inptr &lt; insize ? inbuf[inptr++] : fill_inbuf())
</pre>
&#26597;&#30475;fill_inbuf&#20989;&#25968;:
<pre class="programlisting">
int fill_inbuf(void)
{
	if (insize != 0)
		error("ran out of input data");
	inbuf = input_data;
	insize = &amp;input_data_end[0] - &amp;input_data[0];
	inptr = 1;
	return inbuf[0];
}
</pre>
&#21457;&#29616;&#20160;&#20040;&#27809;&#65311;&#36825;&#37324;&#30340;input_data&#19981;&#27491;&#26159;piggy.S&#37324;&#30340;input_data&#21527;&#65311;&#36825;&#20010;&#26102;&#20505;&#24212;&#35813;&#26126;&#30333;&#20869;&#26680;&#26159;&#24590;&#26679;&#30830;&#23450;piggy.gz&#22312;zImage&#20013;&#30340;&#20301;&#32622;&#20102;&#21543;&#12290;
</div>
<div class="sect2" title="7.9. vmlinux&#30340;&#29983;&#25104;&#21629;&#20196;"><div class="titlepage"><div><div><h3 class="title"><a name="idp80459884"></a>7.9. vmlinux&#30340;&#29983;&#25104;&#21629;&#20196;</h3></div></div></div>
&#26080;&#35770;&#22914;&#20309;&#65292;&#26080;&#27861;&#24573;&#30053;vmlinux&#30340;&#23384;&#22312;&#12290;&#23427;&#26159;&#20027;&#30446;&#24405;Makefile&#30340;&#26368;&#32456;&#30446;&#26631;&#65292;&#20854;&#20182;&#38236;&#20687;&#25991;&#20214;&#30340;&#20381;&#36182;&#12290;
<pre class="programlisting">
# The all: target is the default when no target is given on the
# command line.
# This allow a user to issue only 'make' to build a kernel including modules
# Defaults vmlinux but it is usually overridden in the arch makefile
all: vmlinux
</pre>
<p>&#22312;Build vmlinux&#23567;&#33410;&#30340;&#27880;&#37322;&#20013;&#65292;&#23545;vmlinux&#29983;&#25104;&#21407;&#29702;&#20570;&#20102;&#35814;&#23613;&#30340;&#25551;&#36848;&#65306;vmlinux&#26159;&#30001;$(vmlinux-init) &#21644;
$(vmlinux-main)&#25351;&#23450;&#30340;&#30446;&#26631;&#25991;&#20214;&#26368;&#32456;&#38142;&#25509;&#29983;&#25104;&#30340;&#12290;&#36890;&#24120;&#23427;&#20204;&#26159;&#20301;&#20110;&#21508;&#20010;&#23376;&#30446;&#24405;&#19979;&#30340;built_int.o&#30446;&#26631;&#25991;&#20214;&#65292;&#19968;&#20123;&#29305;&#27530;&#21517;&#23383;&#30340;.o&#25991;&#20214;&#30001;arch/$(ARCH)/Makefile&#29983;&#25104;&#12290;</p>
<p>&#30446;&#26631;&#25991;&#20214;.o&#38142;&#25509;&#20026;vmlinux&#30340;&#39034;&#24207;&#26159;&#38750;&#24120;&#37325;&#35201;&#30340;&#65292;$(vmlinux-init)&#25351;&#23450;&#30340;&#30446;&#26631;&#25991;&#20214;&#20248;&#20808;&#32423;&#26368;&#39640;&#65292;&#25509;&#30528;&#26159;$(vmlinux-main)&#65292;&#26368;&#21518;&#26159;kallsyms.o&#12290;&#20110;&#27492;&#21516;&#26102;System.map&#21253;&#21547;&#20102;&#20869;&#26680;&#25152;&#26377;&#30340;&#23548;&#20986;&#31526;&#21495;&#34920;&#12290;</p>
<pre class="programlisting">
# vmlinux
#   ^
#   |
#   +-&lt; $(vmlinux-init)
#   |   +--&lt; init/version.o + more
#   |
#   +--&lt; $(vmlinux-main)
#   |    +--&lt; driver/built-in.o mm/built-in.o + more
#   |
#   +-&lt; kallsyms.o (see description in CONFIG_KALLSYMS section)
vmlinux-init := $(head-y) $(init-y)
vmlinux-main := $(core-y) $(libs-y) $(drivers-y) $(net-y)
vmlinux-all  := $(vmlinux-init) $(vmlinux-main)
vmlinux-lds  := arch/$(SRCARCH)/kernel/vmlinux.lds
export KBUILD_VMLINUX_OBJS := $(vmlinux-all)

# vmlinux image - including updated kernel symbols
vmlinux: $(vmlinux-lds) $(vmlinux-init) $(vmlinux-main) vmlinux.o $(kallsyms.o) FORCE
ifdef CONFIG_HEADERS_CHECK
        $(Q)$(MAKE) -f $(srctree)/Makefile headers_check
endif
ifdef CONFIG_SAMPLES
        $(Q)$(MAKE) $(build)=samples
endif
ifdef CONFIG_BUILD_DOCSRC
        $(Q)$(MAKE) $(build)=Documentation
endif
        $(call vmlinux-modpost)
        $(call if_changed_rule,vmlinux__)
        $(Q)rm -f .old_version
</pre>
&#22914;&#26524;&#20351;&#33021;CONFIG_HEADERS_CHECK&#23558;&#23581;&#35797;&#23545;&#25152;&#26377;&#23548;&#20986;&#30340;.h&#36827;&#34892;&#26377;&#25928;&#24615;&#26816;&#26597;&#12290;&#23427;&#36890;&#36807;$(srctree)/scripts/headers.sh&#33050;&#26412;&#23436;&#25104;&#12290;&#36890;&#36807;call&#35843;&#29992;&#20102;&#20004;&#20010;&#23376;&#20989;&#25968;vmlinux-modpost&#20197;&#21450;if_changed_rule,vmlinux__&#12290;scripts/ Kbuild.include&#20013;&#23450;&#20041;&#20102;if_changed_rule&#12290;
<pre class="programlisting">
# Usage: $(call if_changed_rule,foo)
# Will check if $(cmd_foo) or any of the prerequisites changed,
# and if so will execute $(rule_foo).
if_changed_rule = $(if $(strip $(any-prereq) $(arg-check) ),                 \
        @set -e;                                                             \
        $(rule_$(1)))
</pre>
&#26368;&#37325;&#35201;&#30340;&#23376;&#21629;&#20196;&#26159;vmlinux__&#65292;&#23427;&#30340;&#23450;&#20041;&#22914;&#19979;&#65292;&#36890;&#36807;&#23427;&#26368;&#32456;&#29983;&#25104;&#20102;vmlinux&#12290;
<pre class="programlisting">
# Rule to link vmlinux - also used during CONFIG_KALLSYMS
# May be overridden by arch/$(ARCH)/Makefile
quiet_cmd_vmlinux__ ?= LD      $@
      cmd_vmlinux__ ?= $(LD) $(LDFLAGS) $(LDFLAGS_vmlinux) -o $@ \
      -T $(vmlinux-lds) $(vmlinux-init)                          \
      --start-group $(vmlinux-main) --end-group                  \
      $(filter-out $(vmlinux-lds) $(vmlinux-init) $(vmlinux-main) vmlinux.o FORCE ,$^)
</pre>
&#19968;&#20010;&#23454;&#38469;&#30340;$( cmd_vmlinux__)&#21629;&#20196;&#34892;&#22914;&#19979;&#65306;
<pre class="programlisting">
/usr/local/arm/4.2.2-eabi/usr/bin/arm-linux-ld -EL  -p --no-undefined -X -o vmlinux -T 
arch/arm/kernel/vmlinux.lds arch/arm/kernel/head.o arch/arm/kernel/init_task.o  init/built-in.o 
--start-group  usr/built-in.o  arch/arm/kernel/built-in.o  arch/arm/mm/built-in.o  
arch/arm/common/built-in.o  arch/arm/mach-s3c6400/built-in.o  
arch/arm/mach-s3c6410/built-in.o  arch/arm/plat-s3c64xx/built-in.o  
arch/arm/plat-s3c/built-in.o  arch/arm/nwfpe/built-in.o  arch/arm/vfp/built-in.o  
kernel/built-in.o  mm/built-in.o  fs/built-in.o  ipc/built-in.o  security/built-in.o  crypto/built-in.o  
block/built-in.o  arch/arm/lib/lib.a  lib/lib.a  arch/arm/lib/built-in.o  lib/built-in.o  
drivers/built-in.o  sound/built-in.o  firmware/built-in.o  net/built-in.o 
--end-group .tmp_kallsyms2.o
</pre>
&#27880;&#24847;&#21040;&#20854;&#20013;&#30340;-T&#21442;&#25968;&#65292;&#23427;&#25351;&#23450;&#20102;&#38142;&#25509;&#20351;&#29992;&#30340;&#33050;&#26412;&#12290;
<pre class="programlisting">
#man ld
       -T scriptfile
       Use scriptfile as the linker script.  This script replaces ld's default linker script 
       (rather than adding to it), so commandfile must  specify everything necessary to describe
       the output file.    If scriptfile does not exist in the current directory, "ld" looks 
       for it in the directories specified by any preceding -L options.  Multiple -T options        
       accumulate.
</pre>
&#25152;&#26377;&#30340;&#38142;&#25509;&#37117;&#30001;&#38142;&#25509;&#33050;&#26412;&#26469;&#25511;&#21046;&#65292;ld&#20013;&#24050;&#32463;&#24050;&#32463;&#20869;&#23884;&#20102;&#19968;&#20010;&#40664;&#35748;&#33050;&#26412;&#65292;&#21487;&#20197;&#36890;&#36807;&#22914;&#19979;&#21629;&#20196;&#26597;&#30475;&#35813;&#33050;&#26412;&#65306;
<pre class="programlisting">
# ld  --verbose
</pre>
&#19968;&#20010;&#23454;&#38469;&#30340;$( vmlinux-modpost)&#21629;&#20196;&#34892;&#22914;&#19979;&#65306;
<pre class="programlisting">
/usr/local/arm/4.2.2-eabi/usr/bin/arm-linux-ld -EL -r -o vmlinux arch/arm/kernel/head.o arch/arm/kernel/init_task.o 
init/built-in.o --start-group usr/built-in.o arch/arm/kernel/built-in.o arch/arm/mm/built-in.o 
arch/arm/common/built-in.o arch/arm/mach-s3c6400/built-in.o arch/arm/mach-s3c6410/built-in.o 
arch/arm/plat-s3c64xx/built-in.o arch/arm/plat-s3c/built-in.o arch/arm/nwfpe/built-in.o arch/arm/vfp/built-in.o 
kernel/built-in.o mm/built-in.o fs/built-in.o ipc/built-in.o security/built-in.o crypto/built-in.o 
block/built-in.o arch/arm/lib/lib.a lib/lib.a arch/arm/lib/built-in.o lib/built-in.o drivers/built-in.o 
sound/built-in.o firmware/built-in.o net/built-in.o --end-group arch/arm/kernel/vmlinux.lds vmlinux.o 
.tmp_kallsyms2.o
</pre>
&#27880;&#24847;&#21040;--start-group&#21644;--end-group&#21442;&#25968;&#65292;&#23427;&#20204;&#26159;&#20026;&#20102;&#35299;&#20915;&#38745;&#24577;&#24211;&#20043;&#38388;&#30456;&#20114;&#24341;&#29992;&#65292;&#25152;&#26377;&#30340;&#38745;&#24577;&#24211;&#24212;&#35813;&#25918;&#21040;&#23427;&#20204;&#20043;&#38388;&#12290;
</div>
<div class="sect2" title="7.10. vmlinux-xxx"><div class="titlepage"><div><div><h3 class="title"><a name="idp80460468"></a>7.10. vmlinux-xxx</h3></div></div></div>
&#19968;&#20010;&#35752;&#24039;&#30340;&#36755;&#20986;&#36825;&#20123;&#21464;&#37327;&#30340;&#26041;&#27861;&#26159;&#65306;
<pre class="programlisting">
all: hoo vmlinux

hoo:
    echo $(vmlinux-init)
		echo $( vmlinux-main)
</pre>
vmlinux-init &#23450;&#20041;&#20026;$(head-y)&#21644;$(init-y)&#30340;&#21512;&#38598;&#12290;head-y&#23450;&#20041;&#20110;arch/arm/Makefile
<pre class="programlisting">
head-y          := arch/arm/kernel/head$(MMUEXT).o arch/arm/kernel/init_task.o
</pre>
init-y&#23450;&#20041;&#20110;&#20027;&#30446;&#24405;Makefile
<pre class="programlisting">
init-y          := init/
</pre>
&#19968;&#20010;&#23454;&#38469;&#30340;$(vmlinux-init)&#21442;&#25968;&#36755;&#20986;&#22914;&#19979;&#65306;
<pre class="programlisting">
arch/arm/kernel/head.o arch/arm/kernel/init_task.o  init/built-in.o
</pre>
vmlinux-main&#23450;&#20041;&#20026;$(core-y)&#65292;$(libs-y)&#65292; $(drivers-y) &#21644; $(net-y)&#30340;&#21512;&#38598;&#12290;&#23427;&#20204;&#23450;&#20041;&#20110;&#20027;&#30446;&#24405;Makefile&#65306;
<pre class="programlisting">
drivers-y       := drivers/ sound/ firmware/
net-y           := net/
libs-y          := lib/
core-y          := usr/
core-y          += kernel/ mm/ fs/ ipc/ security/ crypto/ block/

init-y          := $(patsubst %/, %/built-in.o, $(init-y))
core-y          := $(patsubst %/, %/built-in.o, $(core-y))
drivers-y       := $(patsubst %/, %/built-in.o, $(drivers-y))
net-y           := $(patsubst %/, %/built-in.o, $(net-y))
libs-y1         := $(patsubst %/, %/lib.a, $(libs-y))
libs-y2         := $(patsubst %/, %/built-in.o, $(libs-y))
libs-y          := $(libs-y1) $(libs-y2)
</pre>
&#19968;&#20010;&#23454;&#38469;&#30340;$(vmlinux-main)&#21442;&#25968;&#36755;&#20986;&#22914;&#19979;&#65306;
<pre class="programlisting">
usr/built-in.o arch/arm/kernel/built-in.o arch/arm/mm/built-in.o arch/arm/common/built-in.o 
arch/arm/mach-s3c6400/built-in.o arch/arm/mach-s3c6410/built-in.o 
arch/arm/plat-s3c64xx/built-in.o arch/arm/plat-s3c/built-in.o arch/arm/nwfpe/built-in.o 
arch/arm/vfp/built-in.o kernel/built-in.o mm/built-in.o fs/built-in.o ipc/built-in.o security/built-in.o 
crypto/built-in.o block/built-in.o arch/arm/lib/lib.a lib/lib.a arch/arm/lib/built-in.o lib/built-in.o 
drivers/built-in.o sound/built-in.o firmware/built-in.o net/built-in.o
</pre>
&#23427;&#21253;&#25324;&#20102;&#20960;&#20046;&#25152;&#26377;&#30340;&#20869;&#26680;&#23376;&#31995;&#32479;&#65292;&#20197;&#21450;&#39537;&#21160;&#31243;&#24207;&#12290;vmlinux-all  &#26159; $(vmlinux-init)&#21644; $(vmlinux-main)&#30340;&#21512;&#38598;&#12290;&#23427;&#26368;&#32456;&#20250;&#20986;&#29616;&#22312;&#29983;&#25104;vmlinux&#30340;&#21629;&#20196;&#34892;&#20013;&#12290;&#37325;&#26032;&#30475;&#19968;&#19979;&#19968;&#20010;&#23454;&#38469;&#30340;$( cmd_vmlinux__)&#21629;&#20196;&#34892;&#65306;
<pre class="programlisting">
/usr/local/arm/4.2.2-eabi/usr/bin/arm-linux-ld -EL  -p --no-undefined -X -o vmlinux -T 
arch/arm/kernel/vmlinux.lds arch/arm/kernel/head.o arch/arm/kernel/init_task.o  init/built-in.o 
--start-group  usr/built-in.o  arch/arm/kernel/built-in.o  arch/arm/mm/built-in.o  
arch/arm/common/built-in.o  arch/arm/mach-s3c6400/built-in.o  
arch/arm/mach-s3c6410/built-in.o  arch/arm/plat-s3c64xx/built-in.o  
arch/arm/plat-s3c/built-in.o  arch/arm/nwfpe/built-in.o  arch/arm/vfp/built-in.o  
kernel/built-in.o  mm/built-in.o  fs/built-in.o  ipc/built-in.o  security/built-in.o  crypto/built-in.o  
block/built-in.o  arch/arm/lib/lib.a  lib/lib.a  arch/arm/lib/built-in.o  lib/built-in.o  
drivers/built-in.o  sound/built-in.o  firmware/built-in.o  net/built-in.o 
--end-group .tmp_kallsyms2.o
</pre>

<pre class="programlisting">
vmlinux-lds  := arch/$(SRCARCH)/kernel/vmlinux.lds
</pre>
$(SRCARCH)&#23450;&#20041;&#20110;&#20027;&#30446;&#24405;&#30340;Makefile:
<pre class="programlisting">
ARCH            := arm
SRCARCH         := $(ARCH)
</pre>
&#25152;&#20197;&#23427;&#20301;&#20110;arch/arm/kernel/vmlinux.lds&#65292;&#23427;&#26082;&#26159;&#29983;&#25104;vmlinux&#26102;&#20351;&#29992;&#30340;&#38142;&#25509;&#33050;&#26412;&#12290;
<pre class="programlisting">
vmlinux-dirs    := $(patsubst %/,%,$(filter %/, $(init-y) $(init-m) \
                     $(core-y) $(core-m) $(drivers-y) $(drivers-m) \
                     $(net-y) $(net-m) $(libs-y) $(libs-m)))
</pre>
&#37325;&#37327;&#32423;&#20154;&#29289;vmlinux-dirs&#21253;&#21547;&#20102;&#25152;&#26377;&#30001;&#21464;&#37327;$(xx)&#20195;&#34920;&#30340;&#38656;&#35201;&#32534;&#35793;&#22788;&#29702;&#30340;&#25991;&#20214;&#22841;&#65292;&#23427;&#30340;&#19968;&#20010;&#23454;&#38469;&#36755;&#20986;&#20026;&#65306;
<pre class="programlisting">
init usr arch/arm/kernel arch/arm/mm arch/arm/common arch/arm/mach-s3c6400 arch/arm/mach-s3c6410
 arch/arm/plat-s3c64xx arch/arm/plat-s3c arch/arm/nwfpe arch/arm/vfp kernel mm fs ipc security 
 crypto block drivers sound firmware net arch/arm/lib lib
</pre>
</div>
<div class="sect2" title="7.11. vmlinux.lds&#21644;vmlinux.lds.S"><div class="titlepage"><div><div><h3 class="title"><a name="idp80469452"></a>7.11. vmlinux.lds&#21644;vmlinux.lds.S</h3></div></div></div>
arch/arm/kernel/vmlinux.lds &#26159;&#30001;arch/arm/kernel/vmlinux.lds.S &#29983;&#25104;&#30340;&#65292;&#20854;&#29983;&#25104;&#35268;&#21017;&#22312;scripts/Makefile.build&#36827;&#34892;&#23450;&#20041;&#65306;
<pre class="programlisting">
# Linker scripts preprocessor (.lds.S -&gt; .lds)
# ---------------------------------------------------------------------------
quiet_cmd_cpp_lds_S = LDS     $@
      cmd_cpp_lds_S = $(CPP) $(cpp_flags) -D__ASSEMBLY__ -o $@ $&lt;

$(obj)/%.lds: $(src)/%.lds.S FORCE
        $(call if_changed_dep,cpp_lds_S)
</pre>
&#25193;&#23637;&#21518;&#30340;app_lds_S&#21629;&#20196;&#22914;&#19979;&#65306;
<pre class="programlisting">
/usr/local/arm/4.2.2-eabi/usr/bin/arm-linux-gcc -E -Wp,-MD,arch/arm/kernel/.vmlinux.lds.d 
-nostdinc -isystem 
/usr/local/arm/4.2.2-eabi/usr/bin-ccache/../lib/gcc/arm-unknown-linux-gnueabi/4.2.2/include 
-D__KERNEL__ -Iinclude -I/home/red/forlinux/linux2.6.28/arch/arm/include -include 
include/linux/autoconf.h -mlittle-endian -Iarch/arm/mach-s3c6400/include 
-Iarch/arm/mach-s3c6410/include -Iarch/arm/plat-s3c64xx/include -Iarch/arm/plat-s3c/include 
-DTEXT_OFFSET=0x00008000 -P -C -Uarm -D__ASSEMBLY__ -o arch/arm/kernel/vmlinux.lds 
arch/arm/kernel/vmlinux.lds.S
</pre>
&#27880;&#24847;&#21040;&#29983;&#25104;&#21629;&#20196;&#20013;&#30340;&#21442;&#25968;-E&#65292;&#23427;&#24182;&#19981;&#32534;&#35793;&#65292;&#32780;&#21482;&#26159;&#36827;&#34892;&#39044;&#22788;&#29702;&#12290;&#23427;&#30340;&#26684;&#24335;&#19982;&#28304;&#25991;&#20214;&#26684;&#24335;&#26159;&#19968;&#33268;&#30340;&#12290;&#21478;&#22806;-DTEXT_OFFSET=0x00008000&#25351;&#23450;&#20102;&#33050;&#26412;&#29983;&#25104;&#26102;TEXT_OFFSET&#21442;&#25968;&#12290;
<pre class="programlisting">
#man gcc
       -E  Stop after the preprocessing stage; do not run the compiler proper.  The output is 
       in the form of preprocessed source code, which is sent to the standard output.
</pre>
vmlinux.lds.S&#23450;&#20041;&#20102;&#20195;&#30721;&#27573;&#30340;&#24320;&#22987;&#65306;
<pre class="programlisting">
.......
SECTIONS
{
#ifdef CONFIG_XIP_KERNEL
        . = XIP_VIRT_ADDR(CONFIG_XIP_PHYS_ADDR);
#else
        . = PAGE_OFFSET + TEXT_OFFSET;
#endif
        .text.head : {
......
</pre>
&#27880;&#24847;&#21040;&#23427;&#21253;&#21547;&#30340;&#22836;&#25991;&#20214;memory.h&#23545;PAGE_OFFSET&#20570;&#20102;&#22914;&#19979;&#23450;&#20041;&#65306;        
<pre class="programlisting">
arch/arm/include/asm/memory.h
/*
 * PAGE_OFFSET - the virtual address of the start of the kernel image
 * TASK_SIZE - the maximum size of a user space task.
 * TASK_UNMAPPED_BASE - the lower boundary of the mmap VM area
 */
#define PAGE_OFFSET             UL(CONFIG_PAGE_OFFSET)
</pre>
arch/arm/Makefile&#20013;&#23450;&#20041;&#20102;TEXT_OFFSET&#20197;&#21450;&#21442;&#25968;&#20351;&#29992;&#21629;&#20196;&#34892;&#30340;&#20256;&#36882;&#26041;&#24335;&#65306;
<pre class="programlisting">
# The byte offset of the kernel image in RAM from the start of RAM.
TEXT_OFFSET := $(textofs-y)
CPPFLAGS_vmlinux.lds = -DTEXT_OFFSET=$(TEXT_OFFSET)
textofs-y       := 0x00008000
</pre>
&#21487;&#20197;&#30475;&#21040;&#26368;&#32456;TEXT_OFFSET&#30340;&#20540;&#20026;0x00008000&#65292;&#36825;&#19982;app_lds_S&#21629;&#20196;&#34892;&#20013;&#30340;&#21442;&#25968;&#26159;&#19968;&#33268;&#30340;&#12290;&#26368;&#32456;&#20869;&#26680;&#30340;&#20195;&#30721;&#27573;&#30340;&#24320;&#22987;&#22320;&#22336;&#22914;&#19979;&#65306;
<pre class="programlisting">
. = 0xC0000000 + 0x00008000;
</pre>
</div>
<div class="sect2" title="7.12. head.S"><div class="titlepage"><div><div><h3 class="title"><a name="idp80479900"></a>7.12. head.S</h3></div></div></div>
<p>
&#36825;&#37324;&#30340;head.S&#24182;&#38750;kernel&#19979;&#30340;head.S&#65292;&#32780;&#26159;&#29992;&#26469;&#35299;&#21387;&#20869;&#26680;&#38236;&#20687;zImage&#30340;head.S&#65292;&#23427;&#36890;&#24120;&#20301;&#20110;arch/arm/boot/compressed&#19979;&#12290;Uboot&#22312;&#36890;&#36807;&#21629;&#20196;bootm addr&#21518;&#65292;&#25152;&#25191;&#34892;&#30340;theKernel&#20989;&#25968;&#23454;&#38469;&#19978;&#23601;&#26159;&#25351;&#21521;&#35813;head.S&#31532;&#19968;&#26465;&#25351;&#20196;&#30340;&#25351;&#38024;&#12290;
</p><pre class="programlisting">
 theKernel(0, bd-&gt;bi_arch_number, bd-&gt;bi_boot_params);
</pre><p>
head.S&#30340;&#22836;&#37096;&#23450;&#20041;&#20102;&#19968;&#20123;&#35843;&#35797;&#29992;&#30340;&#23439;&#25351;&#20196;&#12290;&#39318;&#20808;&#20174;&#31532;&#19968;&#26465;&#30495;&#27491;&#30340;&#27719;&#32534;&#25351;&#20196;&#24320;&#22987;&#20998;&#26512;&#65306;
</p><pre class="programlisting">
.section ".start", #alloc, #execinstr

                .align
start:
                .type   start,#function
                .rept   8
                mov     r0, r0
                .endr

                b       1f
                .word   0x016f2818              @ Magic numbers to help the loader
                .word   start                   @ absolute load/run zImage address
                .word   _edata                  @ zImage end address
1:              mov     r7, r1                  @ save architecture ID
                mov     r8, r2                  @ save atags pointer
</pre><p>	
align&#20266;&#25351;&#20196;&#30830;&#20445;&#25351;&#20196;4&#23383;&#33410;&#23545;&#40784;&#12290;&#25191;&#34892;8&#27425;&#37325;&#22797;&#30340;nop&#65288;mov r0, r0&#65289;&#25351;&#20196;&#26159;&#20026;&#20102;&#21644;Uboot&#20013;&#30340;zImage&#39764;&#26415;0x016f2818&#39564;&#35777;&#20445;&#35777;9&#20010;&#25351;&#20196;&#22823;&#23567;&#30340;&#20559;&#31227;&#12290;&#23454;&#38469;&#19978;align&#20266;&#25351;&#20196;&#22312;&#36825;&#37324;&#24182;&#27809;&#26377;&#24847;&#20041;&#65292;&#26681;&#25454;vmlinux.lds&#38142;&#25509;&#33050;&#26412;&#65292;head.o&#30340;.start&#27573;&#24635;&#26159;&#34987;&#23433;&#25490;&#22312;&#24320;&#22987;&#30340;0&#22320;&#22336;&#22788;&#65292;&#25152;&#20197;.word start&#20063;&#23558;&#34987;&#22635;&#20805;&#20026;0&#12290;&#22914;&#26524;&#35201;&#30830;&#23450;_edata&#30340;&#20540;&#65292;&#23601;&#35201;&#30475;&#19968;&#19979;&#38142;&#25509;&#33050;&#26412;&#20102;:
</p><pre class="programlisting">
OUTPUT_ARCH(arm)
ENTRY(_start)
SECTIONS
{
  . = 0;					// &#20174;0&#22320;&#22336;&#24320;&#22987;&#23433;&#25490;&#25968;&#25454;
  _text = .;

  .text : {
    _start = .;
    *(.start)			// &#24635;&#26159;&#23558;.head&#20013;&#30340;.start&#27573;&#23433;&#25490;&#22312;0&#22320;&#22336;&#22788;
    *(.text)
    *(.text.*)
    *(.fixup)
    *(.gnu.warning)
    *(.rodata)
    *(.rodata.*)
    *(.glue_7)
    *(.glue_7t)
    *(.piggydata)
    . = ALIGN(4);
  }

  _etext = .;

  _got_start = .;
  .got                  : { *(.got) }
  _got_end = .;
  .got.plt              : { *(.got.plt) }
  .data                 : { *(.data) }
  _edata = .;   //.&#20195;&#34920;&#20102;&#24403;&#21069;&#22320;&#22336;&#65292;&#30001;&#20110;&#22320;&#22336;&#20174;0&#24320;&#22987;&#65292;&#25152;&#20197;&#23427;&#23601;&#26159;&#20197;&#19978;&#25152;&#26377;&#27573;&#30340;&#22823;&#23567;

  . = ALIGN(4);
  __bss_start = .;
  .bss                  : { *(.bss) }
  _end = .;

  .stack (NOLOAD)       : { *(.stack) }

  .stab 0               : { *(.stab) }
  .stabstr 0            : { *(.stabstr) }
  .stab.excl 0          : { *(.stab.excl) }
  .stab.exclstr 0       : { *(.stab.exclstr) }
  .stab.index 0         : { *(.stab.index) }
  .stab.indexstr 0      : { *(.stab.indexstr) }
  .comment 0            : { *(.comment) }
}
</pre><p>
_edata&#23454;&#38469;&#19978;&#23601;&#26159;zImage&#25991;&#20214;&#30340;&#22823;&#23567;&#12290;&#23427;&#21253;&#21547;&#20869;&#26680;&#38236;&#20687;&#25152;&#38656;&#30340;&#25152;&#26377;&#20195;&#30721;&#27573;&#21644;&#25968;&#25454;&#27573;&#20197;&#21450;&#21387;&#32553;&#21518;&#30340;vmlinux&#20869;&#26680;&#25991;&#20214;.piggydata&#25968;&#25454;&#27573;&#12290;&#19979;&#38754;&#30340;&#21629;&#20196;
&#23558;&#35777;&#23454;&#36825;&#19968;&#28857;&#65292;&#20026;&#20102;&#26597;&#30475;_edata&#30340;&#20540;&#65292;&#37027;&#20040;&#21453;&#27719;&#32534;arch/arm/boot/compressed&#19979;&#30340;vmlinux<sup>[<a name="idp80486020" href="#ftn.idp80486020" class="footnote">4</a>]</sup>&#65292;&#26597;&#30475;0&#22320;&#22336;&#24320;&#22987;&#22788;&#30340;&#20195;&#30721;&#65306;
</p><pre class="programlisting">
00000000 &lt;start&gt;:
       0:       e1a00000        nop     (mov r0,r0)
			......
      20:       ea000002        b       30 &lt;_text+0x30&gt;
      24:       016f2818        .word   0x016f2818
      28:       00000000        .word   0x00000000
      2c:       0025e50c        .word   0x0025e50c
      30:       e1a07001        mov     r7, r1
      34:       e1a08002        mov     r8, r2
      38:       e10f2000        mrs     r2, CPSR
      3c:       e3120003        tst     r2, #3  ; 0x3
      40:       1a000001        bne     4c &lt;not_angel&gt;
      44:       e3a00017        mov     r0, #23 ; 0x17
      48:       ef123456        svc     0x00123456
      ......
</pre><p>
&#31532;&#19968;&#20010;&#23383;&#25968;&#25454;&#26159;zImage&#30340;&#39764;&#25968;&#65292;&#31532;&#20108;&#20010;&#21017;&#23545;&#24212;start&#65292;&#26174;&#28982;_edata&#30340;&#20540;&#20026;0x0025e50c&#12290;&#28982;&#21518;&#30452;&#25509;&#26597;&#30475;zImage&#30340;&#22823;&#23567;&#65292;2483468&#23545;&#24212;&#21040;&#21313;&#20845;&#36827;&#21046;&#23601;&#26159;0x0025e50c&#12290;
</p><pre class="programlisting">
# wc -c zImage 
2483468 zImage
</pre><p>
mov r7, r1&#21644;mov r8, r2&#23558;Uboot&#20256;&#36882;&#26469;&#30340;arch ID&#21644;&#21442;&#25968;&#25351;&#38024;&#36716;&#31227;&#21040;r7h&#21644;r8&#22791;&#29992;&#65292;&#23427;&#20204;&#20998;&#21035;&#23545;&#24212;Uboot&#20013;&#30340;&#21464;&#37327;bi_arch_number&#21644;bi_boot_params&#12290;
</p><pre class="programlisting">
#ifndef __ARM_ARCH_2__
                /*
                 * Booting from Angel - need to enter SVC mode and disable
                 * FIQs/IRQs (numeric definitions from angel arm.h source).
                 * We only do this if we were in user mode on entry.
                 */
                mrs     r2, cpsr                @ get current mode
                tst     r2, #3                  @ not user?
                bne     not_angel
                mov     r0, #0x17               @ angel_SWIreason_EnterSVC
                swi     0x123456                @ angel_SWI_ARM
not_angel:
                mrs     r2, cpsr                @ turn off interrupts to
                orr     r2, r2, #0xc0           @ prevent angel from running
                msr     cpsr_c, r2
#else
                teqp    pc, #0x0c000003         @ turn off interrupts
#endif
</pre><p>
&#24403;&#21069;&#30340;ARM&#26550;&#26500;&#20026;ARM11&#65292;&#25152;&#20197;&#19981;&#20250;&#23450;&#20041;__ARM_ARCH_2__&#65292;&#21478;&#22806;&#25105;&#20204;&#26159;&#20174;Uboot&#21551;&#21160;&#65292;&#32780;&#38750;
Angel&#65292;Angel&#21487;&#20197;&#20174;&#29992;&#25143;&#27169;&#24335;&#21551;&#21160;&#20869;&#26680;&#65292;&#26159;ARM &#30340;&#35843;&#35797;&#21327;&#35758;&#12290;&#36890;&#24120;&#30340;Bootloader&#37117;&#24037;&#20316;&#20110;SVC&#27169;&#24335;&#65292;&#36825;&#26679;&#21487;&#20197;&#30452;&#25509;&#35843;&#29992;&#20869;&#26680;&#38236;&#20687;&#20013;&#30340;&#25351;&#20196;&#12290;&#21487;&#20197;&#21442;&#32771;&#25991;&#26723;Documentation/arm/Booting&#65306;
</p><pre class="programlisting">
......
- CPU mode
  All forms of interrupts must be disabled (IRQs and FIQs)
  The CPU must be in SVC mode.  (A special exception exists for Angel)
......
</pre><p>
not_angel&#26631;&#31614;&#20013;&#30340;&#25351;&#20196;&#23558;CPSR&#23492;&#23384;&#22120;&#30340;I&#21644;F&#20301;&#20026;&#32622;&#20026;1&#65292;&#20063;&#21363;&#20851;&#20013;&#26029;&#21644;&#24555;&#36895;&#20013;&#26029;&#12290;
</p><pre class="programlisting">
      /*
       * some architecture specific code can be inserted
       * by the linker here, but it should preserve r7, r8, and r9.
       */
</pre><p>
&#36825;&#37324;&#30340;&#27880;&#37322;&#35828;&#26126;&#38142;&#25509;&#22120;&#21487;&#33021;&#20250;&#25226;&#19968;&#20123;&#22788;&#29702;&#22120;&#30456;&#20851;&#30340;&#20195;&#30721;&#38142;&#25509;&#21040;&#36825;&#20010;&#20301;&#32622;&#65292;&#20063;&#23601;&#26159;arch/arm/boot/compressed/head-xxx.S&#25991;&#20214;&#20013;&#30340;&#20195;&#30721;&#12290;&#25554;&#20837;&#30340;&#25991;&#20214;&#26681;&#25454;CONFIG_ARCH_XXX&#26469;&#30830;&#23450;&#65292;&#36825;&#37324;&#30340;.config&#37197;&#32622;&#30340;&#26159;CONFIG_ARCH_S3C64XX&#65292;&#23427;&#27809;&#26377;&#23545;&#24212;&#30340;&#39069;&#22806;head&#20195;&#30721;&#12290;
&#22914;&#26524;&#38656;&#35201;&#22312;&#36825;&#37324;&#25554;&#20837;&#20195;&#30721;&#65292;&#37027;&#20040;&#38656;&#35201;&#20445;&#35777;r7&#65292;r8&#21644;r9&#23492;&#23384;&#22120;&#22312;&#35843;&#29992;&#21069;&#21518;&#20445;&#25345;&#19981;&#21464;&#12290;
</p><pre class="programlisting">
              .text
              adr     r0, LC0
              ldmia   r0, {r1, r2, r3, r4, r5, r6, ip, sp}
              subs    r0, r0, r1              @ calculate the delta offset

                                              @ if delta is zero, we are
              beq     not_relocated           @ running at the address we
                                              @ were linked at.
</pre><p>
&#36825;&#37324;&#24320;&#22987;&#36827;&#20837;&#30495;&#27491;&#30340;&#20195;&#30721;&#27573;&#12290;adr&#20266;&#25351;&#20196;&#23558;&#35745;&#31639;LC0&#26631;&#31614;&#25152;&#20195;&#34920;&#30340;&#22320;&#22336;&#30456;&#23545;&#20110;pc&#30340;&#20559;&#31227;&#65292;&#24182;&#35843;&#33410;r0&#30340;&#20540;&#25351;&#21521;pc&#20559;&#31227;&#21518;&#30340;&#20540;&#12290;ldmia&#25209;&#25968;&#25454;&#35013;&#36733;&#25351;&#20196;&#20998;&#21035;&#23558;r0&#65292;r0+4...&#31561;&#30340;&#20540;&#35013;&#36733;&#21040;r1, r2...&#12290;&#22914;&#26524;&#35201;&#24443;&#24213;&#20102;&#35299;&#23427;&#20204;&#30340;&#20316;&#29992;&#65292;&#21017;&#35201;&#30475;&#30475;LC0&#21040;&#24213;&#20195;&#34920;&#20102;&#20160;&#20040;&#65306;
</p><pre class="programlisting">
                .type   LC0, #object
LC0:            .word   LC0                     @ r1
                .word   __bss_start             @ r2
                .word   _end                    @ r3
                .word   zreladdr                @ r4
                .word   _start                  @ r5
                .word   _got_start              @ r6
                .word   _got_end                @ ip
                .word   user_stack+4096         @ sp
LC1:            .word   reloc_end - reloc_start
                .size   LC0, . - LC0
</pre><p>
&#36890;&#36807;&#21453;&#27719;&#32534;vmlinux&#21487;&#20197;&#30475;&#21040;&#23427;&#20204;&#23454;&#38469;&#20195;&#34920;&#30340;&#22320;&#22336;&#65306;
</p><pre class="programlisting">
00000138 &lt;LC0&gt;:
     138:       00000138        .word   0x00000138 // LC0 				@ r1
     13c:       0025e970        .word   0x0025e970 // __bss_start @ r2
     140:       00266db8        .word   0x00266db8 // _end        @ r3
     144:       50008000        .word   0x50008000 // zreladdr    @ r4
     148:       00000000        .word   0x00000000 // _start      @ r5
     14c:       0025e8f4        .word   0x0025e8f4 // _got_start  @ r6
     150:       0025e964        .word   0x0025e964 // _got_end    @ ip
     154:       00267db8        .word   0x00267db8 // user_stack + 4096 @ sp
</pre><p>
LC0&#25351;&#21521;&#20102;&#19968;&#20010;&#32467;&#26500;&#20307;&#65292;&#32467;&#26500;&#20307;&#30340;&#25104;&#21592;&#26377;__bss_start&#65292;_end&#31561;&#65292;&#24182;&#19988;&#32467;&#26500;&#20307;&#20013;&#30340;&#25104;&#21592;&#22343;&#21344;&#19968;&#20010;&#23383;&#65292;&#25152;&#20197;&#36890;&#36807;ldmia&#25351;&#20196;&#21487;&#20197;&#23558;&#23427;&#20204;&#20998;&#21035;&#23545;&#24212;&#21040;&#21508;&#23492;&#23384;&#22120;&#12290;user_stack&#26159;&#19968;&#20010;&#26631;&#31614;&#65292;&#23427;&#20301;&#20110;head.S&#30340;&#26368;&#21518;&#65306;user_stack: .space  4096&#12290;.space&#20266;&#25351;&#20196;&#20998;&#37197;&#36830;&#32493;4k&#23383;&#33410;&#30340;&#23384;&#20648;&#21333;&#20803;&#24182;&#21021;&#22987;&#21270;&#20026;0&#65292;&#26174;&#28982;&#36825;&#37324;&#30340;sp&#25351;&#21521;&#26632;&#39030;&#65292;&#26632;&#30340;&#22823;&#23567;&#20026;4k&#12290;&#21478;&#22806;&#19968;&#20010;&#20196;&#20154;&#36855;&#24785;&#30340;&#22320;&#26041;&#26159;subs&#21644;beq&#30340;&#29992;&#24847;&#65292;adr&#24635;&#26159;&#20351;&#29992;&#30456;&#23545;&#20110;&#24403;&#21069;pc&#30340;&#20559;&#31227;&#26469;&#35745;&#31639;&#22320;&#22336;&#65292;&#35745;&#31639;&#30340;&#36807;&#31243;&#21457;&#29983;&#22312;&#32534;&#35793;&#21518;&#30340;&#38142;&#25509;&#20013;&#65292;.word   LC0&#20063;&#26159;&#22312;&#38142;&#25509;&#20013;&#35745;&#31639;&#22909;&#30340;&#65292;&#20160;&#20040;&#26102;&#20505;&#25165;&#20250;&#20986;&#29616;subs&#19981;&#31561;0&#30340;&#24773;&#20917;&#21602;&#65311;&#31572;&#26696;&#23601;&#26159;zImage&#30340;&#38236;&#20687;&#24320;&#22987;&#20110;&#38750;0&#22320;&#22336;&#26102;&#65292;adr&#25351;&#20196;&#20013;&#30001;&#20110;&#20351;&#29992;&#30340;&#26159;&#30456;&#23545;&#22320;&#22336;&#65292;&#23427;&#24635;&#26159;&#21487;&#20197;&#20445;&#35777;&#22320;&#22336;&#25351;&#21521;pc + offset&#65292;&#27492;&#26102;&#30340;pc&#20540;&#20026;0x00000138 + 0x50008000&#65292;&#20294;&#26159;.word LC0&#26159;&#25454;&#23545;&#22320;&#22336;&#65292;&#23427;&#22312;&#38142;&#25509;&#26102;&#30830;&#23450;&#30340;&#26159;&#30456;&#23545;&#20110;0&#30340;&#20540;0x00000138&#65292;&#20195;&#30721;&#34987;&#25335;&#36125;&#21040;0x50008000&#21518;&#65292;&#23427;&#36824;&#26159;0x00000138&#12290;&#25152;&#20197;subs r0, r0, r1&#21518;&#65292;r0&#30340;&#20540;&#23601;&#26159;&#38236;&#20687;&#34987;&#25335;&#36125;&#30340;RAM&#20013;&#30340;&#29289;&#29702;&#22320;&#22336;0x50008000&#12290;&#37027;&#20040;&#36825;&#37324;&#30340;&#37325;&#23450;&#20301;&#26159;&#22312;&#20309;&#22788;&#21457;&#29983;&#30340;&#21602;&#65311;&#22238;&#24518;&#22914;&#19979;&#30340;Uboot&#21629;&#20196;&#65306;
</p><pre class="programlisting">
bootcmd=nand read 0xc0008000 0x100000 0x300000;bootm 0xc0008000
</pre><p>
&#21487;&#20197;&#30475;&#21040;3M&#22823;&#23567;&#30340;zImage&#34987;&#35835;&#21462;&#21040;&#20102;&#34394;&#25311;&#22320;&#22336;0xc0008000&#65292;&#35813;&#22320;&#22336;&#22312;Uboot&#20013;&#26681;&#25454;virt_to_phys&#34987;&#36716;&#21270;&#20026;&#20102;&#29289;&#29702;&#23454;&#22320;&#22336;0x50008000&#12290;&#20854;&#23454;&#36825;&#26465;&#21629;&#20196;&#19982;nand read 0x50008000 0x100000 0x300000;bootm 0x50008000&#25928;&#26524;&#26159;&#19968;&#33268;&#30340;&#12290;&#30001;&#20110;&#27492;&#26102;&#24037;&#20316;&#22312;&#23454;&#27169;&#24335;&#65292;pc&#20013;&#23384;&#20648;&#30340;&#37117;&#26159;&#25351;&#20196;&#30340;&#29289;&#29702;&#22320;&#22336;&#65292;&#30001;&#20110;Uboot&#36890;&#24120;&#37117;&#26159;&#22312;&#21152;&#36733;RAM&#30340;&#26368;&#20302;&#31471;&#65292;&#22312;&#25191;&#34892;Uboot&#20013;&#30340;&#25351;&#20196;&#26102;&#65292;pc&#20013;&#30340;&#20540;&#26159;Uboot&#25351;&#20196;&#25152;&#22312;&#30340;&#22320;&#22336;&#65292;&#25152;&#20197;&#23427;&#30475;&#36215;&#26469;&#24635;&#26159;&#20174;0x57e00000&#24320;&#22987;&#30340;&#22320;&#22336;&#65292;&#23427;&#22312;Uboot&#20013;&#36890;&#36807;CFG_PHY_UBOOT_BASE&#23439;&#23450;&#20041;&#22312;include/configs/smdk6410.h&#20013;&#65306;
</p><pre class="programlisting">
#define MEMORY_BASE_ADDRESS     0x50000000
#define CFG_PHY_UBOOT_BASE      MEMORY_BASE_ADDRESS + 0x7e00000
</pre><p>
pc&#20540;&#22312;Uboot&#35843;&#29992;theKernel&#26102;&#21457;&#29983;&#20102;&#21464;&#21270;&#65292;&#30001;&#20110;theKernel&#25351;&#21521;&#30340;&#22320;&#22336;&#23601;&#26159;zImage&#21152;&#36733;&#30340;&#22320;&#22336;0x50008000&#65292;&#25152;&#20197;&#27492;&#26102;pc&#30340;&#20540;&#30475;&#36215;&#26469;&#24635;&#26159;&#22823;&#20110;0x50008000&#38468;&#36817;&#30340;&#22320;&#22336;&#65292;&#19979;&#22270;&#35299;&#37322;&#20102;&#21457;&#29983;&#30340;&#19968;&#20999;&#65306;
</p><div class="figure"><a name="idp80498684"></a><p class="title"><b>&#22270; 36. zImage&#21152;&#36733;&#26102;&#22320;&#22336;&#21464;&#21270;</b></p><div class="figure-contents"><div><img src="images/boot_addr.gif" alt="zImage&#21152;&#36733;&#26102;&#22320;&#22336;&#21464;&#21270;"></div></div></div><p><br class="figure-break">
&#30001;&#20110;&#27492;MMU&#21151;&#33021;&#26410;&#25171;&#24320;&#65292;&#25152;&#20197;&#19979;&#38754;&#36890;&#36807;&#27719;&#32534;&#25351;&#20196;&#30452;&#25509;&#36827;&#34892;&#37325;&#23450;&#20301;&#12290;
</p><pre class="programlisting">
		  /*
		   * We're running at a different address.  We need to fix
		   * up various pointers:
		   *   r5 - zImage base address
		   *   r6 - GOT start
		   *   ip - GOT end
		   */
		  add     r5, r5, r0
		  add     r6, r6, r0
		  add     ip, ip, r0
</pre><p>
&#19978;&#38754;&#36827;&#34892;&#37325;&#23450;&#20301;&#30340;&#20195;&#30721;&#24456;&#31616;&#21333;&#65292;&#30001;&#20110;r5&#65292;r6&#21644;ip&#23545;&#24212;&#30340;_start&#65292;_got_start&#21644;_got_end&#22343;&#26159;&#32477;&#23545;&#22320;&#22336;&#65288;&#30456;&#23545;&#20110;&#22320;&#22336;0&#30340;&#22320;&#22336;&#65289;&#65292;&#25152;&#20197;&#38656;&#35201;&#35843;&#33410;&#23427;&#20204;&#12290;&#22914;&#26524;&#27809;&#26377;&#23450;&#20041;CONFIG_ZBOOT_ROM&#20174;ROM&#21551;&#21160;&#65292;&#37027;&#20040;&#24403;&#21069;&#36816;&#34892;&#30340;&#23601;&#26159;&#20301;&#32622;&#26080;&#20851;&#20195;&#30721;&#65288;PIC&#65292; Position Indepedence Code&#65289;&#12290;&#20301;&#32622;&#26080;&#20851;&#20195;&#30721;&#20013;&#26159;&#19981;&#33021;&#26377;&#20219;&#20309;&#32477;&#23545;&#22320;&#22336;&#30340;&#65292;&#23427;&#20204;&#25972;&#20307;&#34987;&#25335;&#36125;&#21040;&#20219;&#20309;&#20301;&#32622;&#26080;&#38656;&#37325;&#23450;&#20301;&#21363;&#21487;&#36816;&#34892;&#12290;&#20026;&#20102;&#20445;&#25345;&#30456;&#23545;&#22320;&#22336;&#27491;&#30830;&#65292;
&#38656;&#35201;&#23558;bss&#27573;&#20197;&#21450;&#22534;&#26632;&#30340;&#22320;&#22336;&#37117;&#36827;&#34892;&#35843;&#25972;&#12290;
</p><pre class="programlisting">
#ifndef CONFIG_ZBOOT_ROM
                /*
                 * If we're running fully PIC === CONFIG_ZBOOT_ROM = n,
                 * we need to fix up pointers into the BSS region.
                 *   r2 - BSS start
                 *   r3 - BSS end
                 *   sp - stack pointer
                 */
                add     r2, r2, r0
                add     r3, r3, r0
                add     sp, sp, r0
</pre><p>
r3&#25351;&#21521;bss&#21306;&#30340;&#24320;&#22987;__bss_start&#65292;&#32780;r3&#25351;&#21521;bss&#21306;&#30340;&#32467;&#26463;_end&#12290;&#23427;&#20204;&#22343;&#22312;vmlinx.lds&#33050;&#26412;&#20013;&#23450;&#20041;&#12290;zreladdr&#25351;&#30340;&#26159;&#20869;&#26680;&#23558;&#35201;&#35299;&#21387;&#30340;&#20869;&#23384;&#29289;&#29702;&#22320;&#22336;&#65292;&#23427;&#26159;&#22312;&#32534;&#35793;&#26102;&#36890;&#36807;Makefile&#20013;&#30340;$(ZRELADDR)&#20256;&#36882;&#32780;&#26469;&#65292;&#23427;&#21448;&#26159;&#20174;arch/arm/boot&#19979;&#30340;Makefile&#23450;&#20041;ZRELADDR    := $(zreladdr-y)
&#32780;&#26469;&#65292;&#26368;&#32456;zreladdr-y := 0x50008000&#23450;&#20041;&#22312;/arch/arm/mach-s3c6400/Makefile.boot&#20013;&#12290;&#22312;&#35299;&#21387;&#21069;&#23558;&#20250;&#26816;&#27979;&#35813;&#22320;&#22336;&#26159;&#21542;&#21644;&#24403;&#21069;&#30340;zImage&#38236;&#20687;&#25152;&#22312;&#30340;&#22320;&#22336;&#21457;&#29983;&#20914;&#31361;&#65292;&#22914;&#26524;&#20914;&#31361;&#23558;&#20250;&#35843;&#33410;&#12290;

&#26681;&#25454;vmlinux&#21453;&#27719;&#32534;&#30340;&#22320;&#22336;&#20540;&#32467;&#21512;&#19979;&#38754;&#21508;&#21306;&#22320;&#22336;&#30340;&#20998;&#37197;&#24773;&#20917;&#21487;&#20197;&#22914;&#19979;&#22320;&#22336;&#20998;&#37197;&#22270;&#65306;
</p><div class="figure"><a name="idp80500812"></a><p class="title"><b>&#22270; 37. &#32477;&#23545;&#22320;&#22336;&#20998;&#37197;&#22270;</b></p><div class="figure-contents"><div><img src="images/boot_file.gif" alt="&#32477;&#23545;&#22320;&#22336;&#20998;&#37197;&#22270;"></div></div></div><p><br class="figure-break">
&#20840;&#23616;&#20559;&#31227;&#34920;GOT&#30340;&#22320;&#22336;&#20063;&#38656;&#35201;&#26356;&#25913;&#65292;GOT&#34920;&#20013;&#21253;&#21547;&#20102;&#24341;&#29992;&#22806;&#37096;&#20840;&#23616;&#31526;&#21495;&#30340;&#32477;&#23545;&#22320;&#22336;&#65292;&#27599;&#19968;&#34920;&#39033;&#21344;&#29992;1&#20010;&#23383;&#12290;&#31243;&#24207;&#20351;&#29992;&#19982;&#20301;&#32622;&#26080;&#20851;&#30340;&#22320;&#22336;&#26469;&#24341;&#29992;GOT &#24182;&#36716;&#25442;&#20026;&#32477;&#23545;&#22320;&#22336;&#12290;&#27492;&#26041;&#27861;&#21487;&#23558;&#19982;&#20301;&#32622;&#26080;&#20851;&#30340;&#35843;&#29992;&#37325;&#23450;&#21521;&#21040;&#32477;&#23545;&#22320;&#22336;&#12290;
</p><pre class="programlisting">
                /*
                 * Relocate all entries in the GOT table.
                 */
1:              ldr     r1, [r6, #0]            @ relocate entries in the GOT
                add     r1, r1, r0              @ table.  This fixes up the
                str     r1, [r6], #4            @ C references.
                cmp     r6, ip
                blo     1b
#else
                /*
                 * Relocate entries in the GOT table.  We only relocate
                 * the entries that are outside the (relocated) BSS region.
                 */
1:              ldr     r1, [r6, #0]            @ relocate entries in the GOT
                cmp     r1, r2                  @ entry &lt; bss_start ||
                cmphs   r3, r1                  @ _end &lt; entry
                addlo   r1, r1, r0              @ table.  This fixes up the
                str     r1, [r6], #4            @ C references.
                cmp     r6, ip
                blo     1b
#endif
</pre><p>
&#33509;&#23450;&#20041;&#20102;CONFIG_ZBOOT_ROM&#65292;&#21482;&#23545;got&#34920;&#20013;&#22312;bss&#27573;&#20197;&#22806;&#30340;&#31526;&#21495;&#36827;&#34892;&#37325;&#23450;&#20301;&#12290;&#19979;&#38754;&#30340;&#20195;&#30721;&#23558;bss&#21306;&#28165;&#38646;&#12290;
</p><pre class="programlisting">
not_relocated:  mov     r0, #0
1:              str     r0, [r2], #4            @ clear bss
                str     r0, [r2], #4
                str     r0, [r2], #4
                str     r0, [r2], #4
                cmp     r2, r3								// &#26410;&#21040;r3(_end)&#21017;&#32487;&#32493;
                blo     1b
</pre><p>
&#25509;&#19979;&#26469;&#23558;&#20026;&#36816;&#34892;c&#20195;&#30721;&#20934;&#22791;&#29615;&#22659;&#65292;&#39318;&#20808;&#25171;&#24320;I/D&#32531;&#23384;&#65292;&#28982;&#21518;&#20934;&#22791;malloc&#20351;&#29992;&#30340;&#32531;&#20914;&#21306;&#65292;&#23427;&#20301;&#20110;&#26632;&#21306;&#20043;&#19978;&#65292;&#21344;&#25454;64k&#31354;&#38388;&#12290;&#32463;&#36807;&#37325;&#23450;&#20301;&#21518;&#20869;&#23384;&#22320;&#22336;&#20998;&#37197;&#22914;&#19979;&#22270;&#25152;&#31034;&#65306;
</p><div class="figure"><a name="idp80504548"></a><p class="title"><b>&#22270; 38. &#37325;&#23450;&#20301;&#21069;&#21518;&#22320;&#22336;&#23545;&#29031;</b></p><div class="figure-contents"><div><img src="images/boot_map.gif" alt="&#37325;&#23450;&#20301;&#21069;&#21518;&#22320;&#22336;&#23545;&#29031;"></div></div></div><p><br class="figure-break">
</p><pre class="programlisting">
                /*
                 * The C runtime environment should now be setup
                 * sufficiently.  Turn the cache on, set up some
                 * pointers, and start decompressing.
                 */
                bl      cache_on

                mov     r1, sp                  @ malloc space above stack
                add     r2, sp, #0x10000        @ 64k max
</pre><p>
S3C6410&#37319;&#29992;ARM1176JZF&#26550;&#26500;&#65292;ARM1176&#31995;&#21015;CPU&#26550;&#26500;&#30340;&#20869;&#37096;&#25351;&#20196;&#24635;&#32447;&#21644;&#25968;&#25454;&#24635;&#32447;&#20998;&#24320;&#65292;&#20063;&#21363;&#20856;&#22411;&#30340;&#21704;&#20315;&#26550;&#26500;&#12290;Cache&#36890;&#36807;&#26576;&#31181;&#31574;&#30053;&#39044;&#27979;CPU&#21363;&#23558;&#35201;&#35775;&#38382;&#30340;&#20869;&#23384;&#22320;&#22336;&#65292;&#39044;&#20808;&#35835;&#21462;&#22823;&#22359;&#20869;&#23384;&#20379;CPU&#35775;&#38382;&#65292;&#26469;&#23478;&#23569;&#21518;&#32493;&#30340;&#32834;&#23384;&#24635;&#32447;&#19978;&#30340;&#35835;&#20889;&#25805;&#20316;&#65292;&#20197;&#25552;&#39640;&#36895;&#24230;&#12290;&#25351;&#20196;&#24635;&#32447;&#21644;&#25968;&#25454;&#24635;&#32447;&#34987;&#20998;&#21035;&#36830;&#25509;&#21040;ICache&#21644;DCache&#65292;&#20877;&#36890;&#36807;AMBA&#24635;&#32447;&#25509;&#21475;&#36830;&#25509;&#21040;ASB&#24635;&#32447;&#19978;&#21435;&#35775;&#38382;&#20869;&#23384;&#12290;Cache&#30001;Line&#32452;&#25104;&#65292;Line&#26159;Cache&#36827;&#34892;&#22359;&#35835;&#21462;&#21644;&#26367;&#25442;&#30340;&#21333;&#20301;&#12290;Write Buffer&#26159;&#19982;DCache&#20316;&#29992;&#30456;&#21453;&#30340;&#32531;&#20914;&#21306;&#65292;&#36890;&#36807;&#20943;&#23569;Memeory Bus&#30340;&#35775;&#38382;&#26469;&#25552;&#39640;&#24615;&#33021;&#12290;MMU(Memory Managenment Unit)&#20869;&#23384;&#31649;&#29702;&#21333;&#20803;&#34987;&#29992;&#26469;&#31649;&#29702;Cache&#24182;&#25511;&#21046;&#34394;&#25311;&#22320;&#22336;&#21644;&#29289;&#29702;&#22320;&#22336;&#30340;&#36716;&#25442;&#12290;&#21327;&#22788;&#29702;&#22120;CP15&#26159;&#22806;&#37096;&#25511;&#21046;MMU/Cache&#30340;&#21807;&#19968;&#36884;&#24452;&#12290;&#20869;&#26680;&#22312;&#20869;&#23384;&#20013;&#32500;&#25252;&#19968;&#24352;&#25110;&#20960;&#24352;&#39029;&#34920;&#65292;&#28982;&#21518;&#36890;&#36807;CP15&#25351;&#23450;&#35813;&#34920;&#30340;&#20301;&#32622;&#65292;&#30828;&#20214;&#20250;&#33258;&#21160;&#23558;&#35813;&#34920;&#30340;&#37096;&#20998;&#34920;&#39033;&#35835;&#21462;&#21040;TLB&#65288;Translation Lookaside Buffer&#65289;&#20013;&#12290;TLB&#26159;MMU&#30340;&#19968;&#37096;&#20998;&#65292;&#23427;&#34987;&#29992;&#26469;&#32531;&#23384;&#21018;&#21018;&#20351;&#29992;&#36807;&#30340;&#39029;&#34920;&#65292;&#20197;&#25552;&#39640;&#22320;&#22336;&#36716;&#25442;&#36895;&#24230;&#12290;
</p><pre class="programlisting">
                .align  5
cache_on:       mov     r3, #8                  @ cache_on function
                b       call_cache_fn
</pre><p>
8&#34987;&#25918;&#20837;r3&#65292;&#23558;&#22312;call_cache_fn&#35843;&#29992;&#20013;&#20316;&#20026;&#21442;&#25968;&#20351;&#29992;&#12290;&#36825;&#20010;&#20989;&#25968;&#23450;&#20041;&#22914;&#19979;&#65306;
</p><pre class="programlisting">
call_cache_fn:  adr     r12, proc_types
#ifdef CONFIG_CPU_CP15
                mrc     p15, 0, r6, c0, c0      @ get processor ID
#else
                ldr     r6, =CONFIG_PROCESSOR_ID
#endif
1:              ldr     r1, [r12, #0]           @ get value
                ldr     r2, [r12, #4]           @ get mask
                eor     r1, r1, r6              @ (real ^ match)
                tst     r1, r2                  @       &amp; mask
                addeq   pc, r12, r3             @ call cache function
                add     r12, r12, #4*5
                b       1b
</pre><p>
CONFIG_CPU_CP15&#22312;&#20869;&#26680;&#30340;&#37197;&#32622;&#25991;&#20214;.config&#20013;&#23450;&#20041;&#12290;proc_types&#26159;&#19968;&#20010;&#26631;&#31614;&#65292;&#23427;&#25351;&#21521;&#20102;&#19968;&#24352;&#25918;&#26377;Processor Types&#30340;&#34920;&#65292;&#36825;&#24352;&#34920;&#30340;&#27599;&#19968;&#39033;&#30001;CPU ID&#65292;ID&#25513;&#30721;&#65292;&#24320;/&#20851;Cache&#21644;&#28165;Cache&#25351;&#20196;&#32452;&#25104;&#12290;call_cache_fn&#30340;&#20316;&#29992;&#23601;&#26159;&#20351;&#29992;&#21327;&#22788;&#29702;&#22120;&#20013;&#33719;&#21462;&#30340;&#22788;&#29702;&#22120;ID&#19982;&#34920;&#20013;&#30340;ID&#30456;&#21305;&#37197;&#65292;&#28982;&#21518;&#35843;&#29992;&#30456;&#24212;&#30340;Cache&#25805;&#20316;&#25351;&#20196;&#12290;addeq pc, r12, r3&#25351;&#20196;&#23558;&#24403;&#21069;pc&#25351;&#21521;&#20102;&#21305;&#37197;&#21518;&#30340;&#34920;&#39033;&#30340;&#25805;&#20316;&#25351;&#20196;&#22320;&#22336;&#65292;r3&#30340;&#20540;&#20026;8&#65292;&#25152;&#20197;pc&#19982;r12&#65288;&#25351;&#21521;&#24403;&#21069;&#22788;&#29702;&#22120;ID&#34920;&#39033;&#30340;&#24320;&#22836;&#65289;&#30340;&#20559;&#31227;&#20026;8&#23383;&#33410;&#12290;
</p><pre class="programlisting">
/*
 * Table for cache operations.  This is basically:
 *   - CPU ID match
 *   - CPU ID mask
 *   - 'cache on' method instruction
 *   - 'cache off' method instruction
 *   - 'cache flush' method instruction
 *
 * We match an entry using: ((real_id ^ match) &amp; mask) == 0
 *
 */
                .type   proc_types,#object
proc_types:
                .word   0x41560600              @ ARM6/610  // CPU ID
                .word   0xffffffe0                          // &#25513;&#30721;
                b       __arm6_mmu_cache_off    @ works, but slow //Off &#25351;&#20196;
                b       __arm6_mmu_cache_off
                mov     pc, lr
......
                .word   0x000f0000              @ new CPU Id
                .word   0x000f0000
                b       __armv7_mmu_cache_on
                b       __armv7_mmu_cache_off
                b       __armv7_mmu_cache_flush
......                
__armv7_mmu_cache_on:
                mov     r12, lr
                mrc     p15, 0, r11, c0, c1, 4  @ read ID_MMFR0
                tst     r11, #0xf               @ VMSA
                blne    __setup_mmu
                mov     r0, #0
                mcr     p15, 0, r0, c7, c10, 4  @ drain write buffer
                tst     r11, #0xf               @ VMSA
                mcrne   p15, 0, r0, c8, c7, 0   @ flush I,D TLBs
                mrc     p15, 0, r0, c1, c0, 0   @ read control reg
                orr     r0, r0, #0x5000         @ I-cache enable, RR cache replacement
                orr     r0, r0, #0x003c         @ write buffer
                orrne   r0, r0, #1              @ MMU enabled
                movne   r1, #-1
                mcrne   p15, 0, r3, c2, c0, 0   @ load page table pointer
                mcrne   p15, 0, r1, c3, c0, 0   @ load domain access control
                mcr     p15, 0, r0, c1, c0, 0   @ load control register
                mrc     p15, 0, r0, c1, c0, 0   @ and read it back
                mov     r0, #0
                mcr     p15, 0, r0, c7, c5, 4   @ ISB
                mov     pc, r12
......                
</pre><p>
&#23613;&#31649;ARM1176&#37319;&#29992;ARM11&#26550;&#26500;&#65292;&#20294;&#26159;CPU ID&#26159;ARMv7&#30340;&#20462;&#35746;&#29256;&#26412;&#65292;&#25152;&#20197;&#36825;&#37324;&#20250;&#21305;&#37197;__armv7_mmu_cache_on&#65292;r12&#20559;&#31227;8&#30340;&#22320;&#22336;&#20063;&#21363;&#26159;&#27492;&#35843;&#29992;&#12290;
&#39318;&#20808;&#20445;&#23384;&#36820;&#22238;&#22320;&#22336;&#65292;&#25509;&#19979;&#26469;&#30340;bl&#25351;&#20196;&#20250;&#35206;&#30422;&#21407;&#26469;&#30340;lr&#65292;&#20026;&#20445;&#35777;&#31243;&#24207;&#27491;&#30830;&#36820;&#22238;&#65292;&#38656;&#35201;&#20445;&#23384;&#24403;&#21069;lr&#30340;&#20540;&#12290;&#27492;&#20989;&#25968;&#39318;&#20808;&#25191;&#34892;__setup_mmu&#65292;&#28982;&#21518;&#28165;&#31354;Write Buffer&#12289;I/Dcache&#12289;TLB&#25509;&#30528;&#25171;&#24320;ICache&#65292;&#35774;&#32622;&#20026;&#24490;&#29615;&#26367;&#25442;&#27169;&#24335;(Round-Robin Replacement)&#12290;&#25509;&#30528;&#25171;&#24320;
Write Buffer&#21644;MMU&#12290;&#25226;&#39029;&#34920;&#22522;&#22320;&#22336;&#21644;&#22495;&#35775;&#38382;&#25511;&#21046;&#20889;&#20837;&#21327;&#22788;&#29702;&#22120;&#23492;&#23384;&#22120;c2&#12289;c3&#12290;c2&#26159;&#36716;&#25442;&#34920;&#22522;&#22320;&#22336;(TTB)&#23492;&#23384;&#22120;&#65288;Translation Table Base Register&#65289;&#65292;c3&#21017;&#26159;&#22495;&#35775;&#38382;&#25511;&#21046;&#23492;&#23384;&#22120;&#65288;Domain Access Control Register&#65289;&#65292;&#23427;&#29992;&#26469;&#25511;&#21046;&#35775;&#38382;&#26435;&#38480;&#12290; mov pc, r12&#36820;&#22238;&#21040;&#24320;&#22987;&#20445;&#23384;&#30340;lr&#22788;&#12290;&#37325;&#28857;&#26469;&#30475;&#19968;&#19979;__setup_mmu&#36825;&#20010;&#20989;&#25968;&#65306;
</p><pre class="programlisting">
__setup_mmu:    sub     r3, r4, #16384          @ Page directory size
                bic     r3, r3, #0xff           @ Align the pointer
                bic     r3, r3, #0x3f00
</pre><p>
r4&#20013;&#23384;&#25918;&#30528;&#22320;&#22336;zreladdr&#65292;&#23427;&#26159;zImage&#25152;&#22312;&#30340;RAM&#20013;&#30340;&#29289;&#29702;&#22320;&#22336;&#12290;&#23558;16K&#30340;&#19968;&#32423;&#39029;&#34920;&#25918;&#22312;&#27492;&#22320;&#22336;&#19979;&#38754;&#30340;16K&#65288;16384&#65289;&#31354;&#38388;&#37324;&#65292;&#39318;&#20808;&#36890;&#36807;
sub r3, r4, #16384 &#33719;&#24471;16K&#31354;&#38388;&#21518;&#65292;&#21448;&#23558;&#39029;&#34920;&#30340;&#36215;&#22987;&#22320;&#22336;&#36827;&#34892;16K&#23545;&#40784;&#25918;&#22312;r3&#20013;&#12290;&#21363;TTB&#30340;&#20302;14&#20301;&#28165;&#38646;&#12290;
</p><pre class="programlisting">
                mov     r0, r3
                mov     r9, r0, lsr #18
                mov     r9, r9, lsl #18         @ start of RAM
                add     r10, r9, #0x10000000    @ a reasonable RAM size
</pre><p>	
&#21021;&#22987;&#21270;&#39029;&#34920;&#65292;&#24182;&#22312;RAM&#31354;&#38388;&#37324;&#25171;&#24320;&#39640;&#36895;&#32531;&#23384;(cacheable)&#21644;&#32531;&#20914;&#20301;(bufferable)&#20301;&#12290;&#25226;&#19968;&#32423;&#39029;&#34920;&#30340;&#36215;&#22987;&#22320;&#22336;&#20445;&#23384;&#22312;r0&#20013;&#65292;&#24182;&#36890;&#36807;r0&#33719;&#24471;&#19968;&#20010;ram&#36215;&#22987;&#22320;&#22336;&#65288;&#27599;&#20010;&#39029;&#38754;&#22823;&#23567;&#20026;1M&#65289;&#28982;&#21518;&#26144;&#23556;256M ram&#31354;&#38388;&#65292;&#24182;&#25226;&#23545;&#24212;&#30340;&#25551;&#36848;&#31526;&#30340;C&#21644;B&#20301;&#22343;&#32622;1&#12290;
&#35201;&#23436;&#20840;&#29702;&#35299;&#19979;&#38754;&#30340;&#39029;&#38754;&#26144;&#23556;&#36807;&#31243;&#65292;&#38656;&#35201;&#20102;&#35299;ARM MMU&#30340;&#24037;&#20316;&#26426;&#21046;&#65292;&#20197;&#21450;&#27492;&#26102;zImage&#25991;&#20214;&#22312;&#20869;&#23384;&#20013;&#30340;&#26144;&#20687;&#22320;&#22336;&#20998;&#37197;&#24773;&#20917;&#65306;
</p><div class="figure"><a name="idp80514708"></a><p class="title"><b>&#22270; 39. &#21547;&#39029;&#34920;&#37325;&#23450;&#20301;&#21069;&#21518;&#22320;&#22336;&#23545;&#29031;</b></p><div class="figure-contents"><div><img src="images/boot_pmap.gif" alt="&#21547;&#39029;&#34920;&#37325;&#23450;&#20301;&#21069;&#21518;&#22320;&#22336;&#23545;&#29031;"></div></div></div><p><br class="figure-break">
&#27880;&#24847;&#22270;&#20013;r0,r3,r9&#21644;r10&#30340;&#20540;&#22343;&#26159;&#29289;&#29702;&#22320;&#22336;&#12290;MMU&#25903;&#25345;&#22522;&#20110;&#33410;&#25110;&#39029;&#30340;&#22320;&#22336;&#36716;&#25442;&#65306;
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">&#27573;&#39029;&#65288;Section&#65289; &#26500;&#25104;1MB &#30340;&#23384;&#20648;&#22120;&#22359;</li><li class="listitem">&#25903;&#25345;3 &#20013;&#19981;&#21516;&#30340;&#39029;&#23610;&#23544;&#65306;<br>
		&#24494;&#39029;&#65288;Tiny page&#65289; &#26500;&#25104;1KB &#30340;&#23384;&#20648;&#22120;&#22359;<br>
		&#23567;&#39029;&#65288;Small page&#65289; &#26500;&#25104;4KB &#30340;&#23384;&#20648;&#22120;&#22359;<br>
		&#22823;&#39029;&#65288;Large page&#65289; &#26500;&#25104;64KB &#30340;&#23384;&#20648;&#22120;&#22359;<br>
	</li></ul></div><p>
&#27573;&#39029;&#21644;&#22823;&#39029;&#26159;&#25903;&#25345;&#20801;&#35768;&#21482;&#29992;&#19968;&#20010;TLB &#20837;&#21475;&#21435;&#26144;&#23556;&#22823;&#30340;&#23384;&#20648;&#22120;&#21306;&#38388;&#12290;&#23567;&#39029;&#21644;&#22823;&#39029;&#26377;&#38468;&#21152;&#30340;&#35775;&#38382;&#25511;&#21046;&#65306;&#23567;&#39029;&#20998;&#25104;1KB &#30340;&#23376;&#39029;&#65292;&#21644;&#22823;&#39029;&#20998;&#25104;16KB &#30340;&#23376;&#39029;&#12290;&#24494;&#39029;&#27809;&#26377;&#23376;&#39029;&#65292;&#23545;&#24494;&#39029;&#30340;&#35775;&#38382;&#25511;&#21046;&#26159;&#23545;&#25972;&#20010;&#39029;&#12290;
</p><div class="figure"><a name="idp80517132"></a><p class="title"><b>&#22270; 40. ARM &#27573;&#39029;&#22320;&#22336;&#39029;&#34920;&#39033;</b></p><div class="figure-contents"><div><img src="images/boot_table.gif" alt="ARM &#27573;&#39029;&#22320;&#22336;&#39029;&#34920;&#39033;"></div></div></div><p><br class="figure-break">
</p><pre class="programlisting">                 
                mov     r1, #0x12
                orr     r1, r1, #3 &lt;&lt; 10
                add     r2, r3, #16384
1:              cmp     r1, r9                  @ if virt &gt; start of RAM
                orrhs   r1, r1, #0x0c           @ set cacheable, bufferable
                cmp     r1, r10                 @ if virt &gt; end of RAM
                bichs   r1, r1, #0x0c           @ clear cacheable, bufferable
                str     r1, [r0], #4            @ 1:1 mapping
                add     r1, r1, #1048576        @ 0x100000
                teq     r0, r2
                bne     1b
</pre><p>
&#19968;&#32423;&#39029;&#34920;&#39033;&#30340;bit[1:0]&#20026;10&#65292;&#21442;&#32771;&#19978;&#22270;&#65292;&#34920;&#31034;&#36825;&#26159;&#19968;&#20010;section&#25551;&#36848;&#31526;&#65292;&#20063;&#21363;&#20998;&#39029;&#26041;&#24335;&#20026;&#27573;&#24335;&#20998;&#39029;&#65292;&#25152;&#20197;&#36825;&#37324;&#21482;&#38656;&#35201;&#19968;&#32423;&#39029;&#34920;&#12290;&#20854;&#20013;&#35775;&#38382;&#26435;&#38480;AP&#65288;Access Permission&#65289;bit[11:10]&#20026;11&#65292;P&#20026;0&#65292;&#21363;&#26159;&#21482;&#35835;&#30340;&#12290;&#19968;&#32423;&#39029;&#34920;&#30340;&#32467;&#26463;&#22320;&#22336;&#23384;&#25918;&#22312;r2&#20013;&#65292;&#20063;&#21363;r3 + 16384&#65292;&#31034;&#20363;&#20013;&#23427;&#30340;&#20540;&#20026;0x50004000 + 0x4000 = 0x50008000&#12290;r1&#30340;&#20540;&#23601;&#26159;&#24403;&#21069;&#22788;&#29702;&#30340;&#39029;&#34920;&#39033;&#65292;&#23427;&#30340;&#20869;&#23481;&#38656;&#35201;&#19982;&#19978;&#22270;&#30456;&#21305;&#37197;&#65292;&#27573;&#39029;&#34920;&#39033;&#22522;&#22336;&#65288;Section Base Address&#65289;&#20174;0&#24320;&#22987;&#65292;&#25152;&#20197;&#23427;&#30340;&#21021;&#22987;&#20540;&#20026;0x0612&#12290;&#32487;&#32780;&#36827;&#20837;&#24490;&#29615;&#22788;&#29702;&#65292;&#30452;&#21040;r1&#19982;r2&#30456;&#31561;&#12290;&#22240;&#20026;&#25171;&#24320;Cache&#21069;&#24517;&#39035;&#25171;&#24320;MMU&#65292;&#25152;&#20197;&#36825;&#37324;&#20808;&#23545;&#39029;&#34920;&#36827;&#34892;&#21021;&#22987;&#21270;&#12290;&#39318;&#20808;&#27604;&#36739;&#36825;&#20010;&#39029;&#34920;&#39033;&#25152;&#25551;&#36848;&#30340;&#22320;&#22336;&#26159;&#21542;&#22312;&#24403;&#21069;&#30340;256M&#30340;&#29289;&#29702;&#31354;&#38388;&#20013;&#65292;&#22914;&#26524;&#22312;&#21017;&#36825;&#20010;&#25551;&#36848;&#31526;&#23545;&#24212;&#30340;&#20869;&#23384;&#21306;&#22495;&#26159;Cacheable&#21644;Bufferable&#12290;&#22914;&#26524;&#19981;&#22312;&#21017;Noncacheable&#21644;Nonbufferable&#12290;&#28982;&#21518;&#23558;&#25551;&#36848;&#31526;&#20889;&#20837;&#19968;&#20010;&#19968;&#32423;&#39029;&#34920;&#39033;&#65292;&#24182;&#23558;&#32034;&#24341;&#22320;&#22336;&#21152;4&#65292;&#25351;&#21521;&#19979;&#19968;&#20010;1M &#27573;&#39029;&#30340;&#22522;&#22320;&#22336;&#12290;&#26368;&#32456;&#30340;&#39029;&#34920;&#22320;&#22336;&#22914;&#19979;&#22270;&#25152;&#31034;&#65306;
</p><div class="figure"><a name="idp80519812"></a><p class="title"><b>&#22270; 41. ARM &#27573;&#39029;&#22320;&#22336;&#39029;&#34920;&#39033;</b></p><div class="figure-contents"><div><img src="images/boot_pagetable.gif" alt="ARM &#27573;&#39029;&#22320;&#22336;&#39029;&#34920;&#39033;"></div></div></div><p><br class="figure-break">
&#39029;&#34920;&#22823;&#23567;&#20026;16K&#65292;&#27599;&#20010;&#25551;&#36848;&#31526;4&#23383;&#33410;&#65292;&#21018;&#22909;&#21487;&#20197;&#23481;&#32435;4096&#20010;&#25551;&#36848;&#31526;&#65292;&#27599;&#20010;&#25551;&#36848;&#31526;&#26144;&#23556;1M&#65292;&#37027;&#20040;&#23601;&#26144;&#23556;&#20102;4096*1M = 4G&#30340;&#31354;&#38388;&#65292;&#22240;&#27492;16K&#30340;&#39029;&#22823;&#23567;&#23436;&#20840;&#21487;&#20197;&#25226;256M&#22320;&#22336;&#31354;&#38388;&#20840;&#37096;&#26144;&#23556;&#12290;&#27880;&#24847;&#21040;&#22270;&#20013;&#20197;e&#32467;&#23614;&#30340;&#39029;&#34920;&#39033;&#65292;&#23427;&#20204;&#20351;&#33021;&#20102;Cacheable&#21644;Bufferable&#12290;
</p><div class="figure"><a name="idp80520316"></a><p class="title"><b>&#22270; 42. &#34394;&#25311;&#22320;&#22336;&#36716;&#29289;&#29702;&#22320;&#22336;</b></p><div class="figure-contents"><div><img src="images/boot_tlb.gif" alt="&#34394;&#25311;&#22320;&#22336;&#36716;&#29289;&#29702;&#22320;&#22336;"></div></div></div><p><br class="figure-break">
&#36825;&#37324;&#30340;&#34394;&#25311;&#22320;&#22336;&#36716;&#25442;&#29289;&#29702;&#22320;&#22336;&#30340;&#36807;&#31243;&#23436;&#20840;&#30001;MMU&#30828;&#20214;&#21333;&#20301;&#23436;&#25104;&#65292;&#21487;&#20197;&#30475;&#21040;&#27492;&#26102;&#30340;&#34394;&#25311;&#22320;&#22336;&#21644;&#29289;&#29702;&#22320;&#22336;&#36824;&#26159;&#23436;&#20840;&#30456;&#21516;&#30340;&#65292;&#26159;&#19968;&#31181;&#24179;&#22374;&#22320;&#22336;&#36716;&#25442;&#65292;&#36825;&#37324;&#24320;&#21551;MMU&#30340;&#20316;&#29992;&#20027;&#35201;&#26159;&#29992;&#21040;&#23427;&#30340;Cache&#21151;&#33021;&#65292;&#21542;&#21017;&#27599;&#27425;&#37117;&#35201;&#21040;&#20869;&#23384;&#20013;&#21462;&#25351;&#20196;&#21644;&#25968;&#25454;&#65292;&#25928;&#29575;&#24456;&#20302;&#65292;&#36825;&#19968;&#28857;&#21487;&#20197;&#23558;&#25351;&#20196;bl cache_on&#21024;&#38500;&#26469;&#39564;&#35777;&#12290;
</p><pre class="programlisting">
/*
 * If ever we are running from Flash, then we surely want the cache
 * to be enabled also for our execution instance...  We map 2MB of it
 * so there is no map overlap problem for up to 1 MB compressed kernel.
 * If the execution is in RAM then we would only be duplicating the above.
 */
                mov     r1, #0x1e
                orr     r1, r1, #3 &lt;&lt; 10
                mov     r2, pc, lsr #20
                orr     r1, r1, r2, lsl #20
                add     r0, r3, r2, lsl #2
                str     r1, [r0], #4
                add     r1, r1, #1048576
                str     r1, [r0]
                mov     pc, lr
ENDPROC(__setup_mmu)
</pre><p>
&#19978;&#36848;&#25351;&#20196;&#39318;&#20808;&#32622;r1&#20026;0x61e&#65292;&#28982;&#21518;&#23558;&#24403;&#21069;pc&#22320;&#22336;&#19982;1M&#23545;&#40784;&#65292;&#24182;&#19982;r1&#20013;&#30340;&#20869;&#23481;&#32467;&#21512;&#24418;&#25104;&#19968;&#20010;&#25551;&#36848;&#24403;&#21069;&#25351;&#20196;&#25152;&#22312;section&#30340;&#25551;&#36848;&#31526;&#12290;r3&#20026;&#21018;&#25165;&#24314;&#31435;&#30340;&#19968;&#32423;&#39029;&#34920;&#30340;&#36215;&#22987;&#22320;&#22336;&#12290;&#36890;&#36807;&#23558;&#24403;&#21069;pc&#22320;&#22336;&#30340;&#39640;12&#20301;&#24038;&#31227;&#20004;&#20301;(&#24418;&#25104;14&#20301;&#32034;&#24341;)&#19982;r3&#20013;&#30340;&#22320;&#22336;(&#20302;14&#20301;&#20026;0)&#30456;&#21152;&#24418;&#25104;&#19968;&#20010;4&#23383;&#33410;&#23545;&#40784;&#30340;&#22320;&#22336;&#65292;&#36825;&#20010;&#22320;&#22336;&#20063;&#22312;16K&#30340;&#19968;&#32423;&#39029;&#34920;&#20869;&#12290;str&#23558;&#19978;&#38754;&#24418;&#25104;&#30340;&#25551;&#36848;&#31526;&#21450;&#20854;&#36830;&#32493;&#30340;&#19979;&#19968;&#20010;section&#25551;&#36848;&#20889;&#20837;&#19978;&#38754;4&#23383;&#33410;&#23545;&#40784;&#22320;&#22336;&#22788;&#65288;&#19968;&#32423;&#39029;&#34920;&#20013;&#32034;&#24341;&#20026;r2&#24038;&#31227;2&#20301;&#65289;&#65292;&#23427;&#30340;&#30446;&#30340;&#26159;&#23558;&#24403;&#21069;&#21644;&#26410;&#26469;&#21487;&#33021;&#36816;&#34892;&#30340;&#20195;&#30721;&#25152;&#22312;&#30340;&#39029;&#34920;&#22320;&#22336;&#20013;Cacheable&#21644;Bufferable&#20351;&#33021;&#12290;mov pc, lr&#36820;&#22238;&#21040;__armv7_mmu_cache_on&#24182;&#32487;&#32493;&#25191;&#34892;&#12290;__armv7_mmu_cache_on&#26368;&#21518;&#35843;&#29992;mov pc, r12&#36820;&#22238;&#21040;bl cache_on&#30340;&#19979;&#19968;&#26465;&#25351;&#20196;&#65306;
</p><pre class="programlisting">
                mov     r1, sp                  @ malloc space above stack
                add     r2, sp, #0x10000        @ 64k max
</pre><p>
&#19978;&#38754;&#30340;&#25351;&#20196;&#23558;r1&#25351;&#21521;&#32531;&#20914;&#21306;&#30340;&#36215;&#22987;&#22320;&#22336;&#65292;r2&#25351;&#21521;&#32531;&#20914;&#21306;&#30340;&#32467;&#26463;&#22320;&#22336;&#65292;&#22823;&#23567;&#20026;64K&#65288;0x10000&#65289;&#65292;&#36825;&#20010;&#32531;&#20914;&#21306;&#26159;&#20026;&#20869;&#26680;&#35299;&#21387;&#20989;&#25968;gnuzip&#20316;&#20026;&#32531;&#20914;&#20043;&#29992;&#12290;&#25509;&#19979;&#26469;&#21028;&#26029;&#24403;&#21069;zImage&#38236;&#20687;&#21644;&#32531;&#20914;&#21306;&#26159;&#21542;&#21644;&#23558;&#35201;&#35299;&#21387;&#30340;&#20869;&#26680;&#22320;&#22336;&#30456;&#20914;&#31361;&#65292;&#20063;&#21363;&#20195;&#30721;&#31354;&#38388;&#37325;&#21472;&#65292;&#22914;&#26524;&#37325;&#21472;&#21017;&#38656;&#35843;&#25972;&#12290;r4&#20445;&#23384;&#26377;&#32534;&#35793;&#26102;&#25351;&#23450;&#30340;&#20869;&#26680;&#35299;&#21387;&#22320;&#22336;zreladdr&#65306;0x50008000&#65307;r5&#21017;&#26159;zImage&#38236;&#20687;&#22320;&#22336;&#30340;&#36215;&#22987;&#22320;&#22336;&#65292;r2&#26159;&#32531;&#20914;&#21306;&#30340;&#32467;&#26463;&#22320;&#22336;&#65292;&#23427;&#20204;&#24050;&#32463;&#32463;&#36807;&#20102;&#37325;&#23450;&#20301;&#65292;&#20998;&#21035;&#20026;0x50008000&#21644;0x50287db8&#12290;
</p><pre class="programlisting">
/*
 * Check to see if we will overwrite ourselves.
 *   r4 = final kernel address
 *   r5 = start of this image
 *   r2 = end of malloc space (and therefore this image)
 * We basically want:
 *   r4 &gt;= r2 -&gt; OK
 *   r4 + image length &lt;= r5 -&gt; OK
 */
                cmp     r4, r2
                bhs     wont_overwrite
                sub     r3, sp, r5              @ &gt; compressed kernel size
                add     r0, r4, r3, lsl #2      @ allow for 4x expansion
                cmp     r0, r5
                bls     wont_overwrite
</pre><p>
cmp r4, r2&#27604;&#36739;&#25351;&#23450;&#30340;&#35299;&#21387;&#22320;&#22336;&#21644;&#32531;&#20914;&#21306;&#30340;&#32467;&#26463;&#22320;&#22336;&#65292;&#22914;&#26524;&#22823;&#20110;&#65292;&#21017;&#35828;&#26126;&#35299;&#21387;&#36807;&#31243;&#20013;&#19981;&#20250;&#21644;&#24403;&#21069;zImage&#38236;&#20687;&#21644;&#32531;&#20914;&#21306;&#21457;&#29983;&#20914;&#31361;&#65292;&#21487;&#20197;&#30452;&#25509;&#35299;&#21387;&#65292;&#22914;&#26524;&#22823;&#20110;&#23601;&#36339;&#21040;wont_overwrite&#25191;&#34892;&#12290;&#21542;&#21017;&#26816;&#26597;&#35299;&#21387;&#21518;&#20869;&#26680;&#30340;&#32467;&#26463;&#22320;&#22336;&#65292;&#26159;&#21542;&#23567;&#20110;&#29616;&#22312;&#26410;&#35299;&#21387;&#20869;&#26680;&#26144;&#20687;&#30340;&#36215;&#22987;&#22320;&#22336;&#65292;&#36825;&#37324;&#30340;sub r3, sp, r5&#29992;&#26469;&#24403;&#21069;&#30340;&#20869;&#26680;&#26144;&#20687;&#21644;&#26632;&#21306;&#30340;&#22823;&#23567;&#20043;&#21644;&#65292;add r0, r4, r3, lsl #2&#20013;&#30340;lsl&#36816;&#31639;&#21482;&#26159;&#29992;&#24403;&#21069;&#30340;&#26144;&#20687;&#21644;&#26632;&#21306;&#30340;&#22823;&#23567;&#30340;4&#20493;&#22823;&#23567;&#26469;&#20272;&#35745;&#35299;&#21387;&#24320;&#21518;&#20869;&#26680;&#30340;&#22823;&#23567;&#65292;&#28982;&#21518;&#21152;&#19978;r4&#23601;&#25104;&#20102;&#20272;&#35745;&#30340;&#35299;&#21387;&#21518;&#20869;&#26680;&#30340;&#32467;&#26463;&#22320;&#22336;&#65292;&#25509;&#30528;&#19982;&#24403;&#21069;zImage&#38236;&#20687;&#30340;&#36215;&#22987;&#22320;&#22336;&#27604;&#36739;&#12290;&#23567;&#20110;&#21017;&#35828;&#26126;&#19981;&#20250;&#37325;&#21472;&#65292;&#20250;&#36339;&#21040;wont_owerwrite&#25191;&#34892;&#12290;&#22914;&#20004;&#36825;&#20004;&#20010;&#26465;&#20214;&#37117;&#19981;&#28385;&#36275;&#65292;&#21017;&#32487;&#32493;&#24448;&#19979;&#25191;&#34892;&#12290;
</p><pre class="programlisting">
                mov     r5, r2                  @ decompress after malloc space
                mov     r0, r5
                mov     r3, r7
                bl      decompress_kernel
</pre><p>
</p><div class="figure"><a name="idp80526716"></a><p class="title"><b>&#22270; 43. &#35299;&#21387;&#20869;&#26680;&#30340;&#22320;&#22336;&#20998;&#37197;</b></p><div class="figure-contents"><div><img src="images/boot_decomp.gif" alt="&#35299;&#21387;&#20869;&#26680;&#30340;&#22320;&#22336;&#20998;&#37197;"></div></div></div><p><br class="figure-break">
r2-&gt;r5-&gt;r0,&#25152;&#20197;r0&#20026;&#32531;&#20914;&#21306;&#32467;&#26463;&#22320;&#22336;&#12290;r1&#20381;&#28982;&#20026;&#32531;&#20914;&#21306;&#24320;&#22987;&#22320;&#22336;&#65292;&#22788;&#29702;&#22120;ID&#65288;&#24320;&#22987;&#26102;&#20445;&#23384;&#22312;r7&#20013;&#65289;&#20445;&#23384;&#21040;r3&#20013;&#65292;&#23427;&#20204;&#23601;&#26159;&#20256;&#36882;&#32473;decompress_kernel&#20989;&#25968;&#30340;&#25152;&#26377;&#21442;&#25968;&#65292;&#28982;&#21518;&#24320;&#22987;&#35299;&#21387;&#20869;&#26680;&#12290;&#23427;&#22312;arch/arm/boot/compressed/misc.c&#20013;&#23450;&#20041;&#12290;&#35299;&#21387;&#30340;&#36807;&#31243;&#20026;&#20808;&#25226;&#35299;&#21387;&#20195;&#30721;&#25918;&#21040;&#32531;&#20914;&#21306;&#65292;&#28982;&#21518;&#20174;&#32531;&#20914;&#21306;&#20877;&#25335;&#36125;&#21040;&#26368;&#32456;&#25191;&#34892;&#31354;&#38388;&#12290;
</p><pre class="programlisting">
ulg
decompress_kernel(ulg output_start, ulg free_mem_ptr_p, ulg free_mem_ptr_end_p,
		  int arch_id)
{
	output_data		= (uch *)output_start;	/* Points to kernel start */
	free_mem_ptr		= free_mem_ptr_p;
	free_mem_end_ptr	= free_mem_ptr_end_p;
	__machine_arch_type	= arch_id;

	arch_decomp_setup();

	makecrc();
	putstr("Uncompressing Linux...");
	gunzip();
	putstr(" done, booting the kernel.\n");
	
	return output_ptr;
}
</pre><p>
output_start&#26159;&#35299;&#21387;&#21518;&#30340;&#20869;&#26680;&#30340;&#36215;&#22987;&#22320;&#22336;&#65292;&#23427;&#20174;r0&#20256;&#36882;&#32780;&#26469;&#65292;&#25152;&#20197;&#26159;&#32531;&#20914;&#21306;&#32467;&#26463;&#22320;&#22336;&#65292;&#32487;&#32780;&#34987;&#20256;&#36882;&#32473;&#20102;output_data&#65307;free_mem_ptr_p&#21644;free_mem_ptr_end_p&#21017;&#26159;&#20174;r1&#21644;r2&#20256;&#36882;&#32780;&#26469;&#65292;&#25152;&#20197;&#20998;&#21035;&#25351;&#21521;&#32531;&#20914;&#21306;&#30340;&#24320;&#22987;&#21644;&#32467;&#26463;&#65292;&#32487;&#32780;&#21448;&#34987;&#20256;&#36882;&#32473;&#20102;free_mem_ptr&#21644;free_mem_end_ptr&#12290;&#20197;&#19978;&#20004;&#20010;&#21442;&#25968;&#34987;gunzip&#20351;&#29992;&#32531;&#20914;&#21306;&#26102;&#35843;&#29992;&#12290;__machine_arch_type&#21017;&#22312;arm/kernel/setup.c&#20013;&#23450;&#20041;&#65292;&#32780;&#22312;arm/kernel/head-common.S&#20013;&#34987;&#20351;&#29992;&#12290;gunzip&#20989;&#25968;&#36890;&#36807;&#22312;misc.c&#20013;&#30452;&#25509;&#21253;&#21547;inflate.c&#32780;&#26469;&#12290;
</p><pre class="programlisting">
#include "../../../../lib/inflate.c"
</pre><p>	
gzip&#21387;&#32553;&#25991;&#20214;&#26102;&#24635;&#26159;&#22312;&#21069;32K&#23383;&#33410;&#30340;&#33539;&#22260;&#20869;&#23547;&#25214;&#37325;&#22797;&#30340;&#23383;&#31526;&#20018;&#36827;&#34892;&#32534;&#30721;&#65292;&#22312;&#35299;&#21387;&#26102;&#38656;&#35201;&#19968;&#20010;&#33267;&#23569;&#20026;32K&#23383;&#33410;&#30340;&#35299;&#21387;&#32531;&#20914;&#21306;&#65292;&#23427;&#23450;&#20041;&#20026;window[WSIZE]&#12290;inflate.c&#20351;&#29992;get_byte()&#35835;&#21462;&#36755;&#20837;&#25991;&#20214;&#65292;&#23427;&#34987;&#23450;&#20041;&#25104;&#23439;&#26469;&#25552;&#39640;&#25928;&#29575;&#12290;&#36755;&#20837;&#32531;&#20914;&#21306;&#25351;&#38024;&#24517;&#39035;&#23450;&#20041;&#20026;inptr&#65292;inflate.c&#20013;&#23545;&#20043;&#26377;&#20943;&#37327;&#25805;&#20316;&#12290;inflate.c&#35843;&#29992;flush_window()&#26469;&#36755;&#20986;window&#32531;&#20914;&#21306;&#20013;&#30340;&#35299;&#21387;&#20986;&#30340;&#23383;&#33410;&#20018;&#65292;&#27599;&#27425;&#36755;&#20986;&#38271;&#24230;&#29992;outcnt&#21464;&#37327;&#34920;&#31034;&#12290;&#22312;flush_window()&#20013;&#65292;&#36824;&#24517;&#39035;&#23545;&#36755;&#20986;&#23383;&#33410;&#20018;&#35745;&#31639;CRC&#24182;&#19988;&#21047;&#26032;crc&#21464;&#37327;&#65292;&#24182;&#19988;&#36890;&#36807;output_data&#21442;&#25968;&#36755;&#20986;&#21040;&#23454;&#38469;&#30340;RAM&#20013;&#65292;&#23427;&#20204;&#22343;&#34987;&#23450;&#20041;&#22312;misc.c&#20013;&#12290;&#22312;&#35843;&#29992;gunzip()&#24320;&#22987;&#35299;&#21387;&#20043;&#21069;&#65292;&#35843;&#29992;makecrc()&#21021;&#22987;&#21270;CRC&#35745;&#31639;&#34920;&#12290;&#26368;&#21518;gunzip()&#36820;&#22238;0&#34920;&#31034;&#35299;&#21387;&#25104;&#21151;&#12290;
</p><pre class="programlisting">
#define WSIZE 0x8000            /* Window size must be at least 32k, */
                                /* and a power of two */

static uch *inbuf;              /* input buffer */
static uch window[WSIZE];       /* Sliding window buffer */

static unsigned insize;         /* valid bytes in inbuf */
static unsigned inptr;          /* index of next byte to be processed in inbuf */
static unsigned outcnt;         /* bytes in output buffer */
......
</pre><p>
&#19968;&#20010;&#26377;&#24847;&#24605;&#30340;&#20989;&#25968;&#26159;inflate.c&#30340;malloc&#21644;free&#20989;&#25968;&#65292;&#23427;&#32473;&#20986;&#20102;&#19968;&#31181;&#26368;&#31616;&#21333;&#30340;&#22534;&#21306;&#30340;&#20351;&#29992;&#26041;&#24335;&#65306;&#36830;&#32493;&#23545;&#40784;&#20998;&#37197;&#12290;
</p><pre class="programlisting">
static void *malloc(int size)
{
       void *p;

       if (size &lt; 0)
                error("Malloc error");
       if (!malloc_ptr)
                malloc_ptr = free_mem_ptr;

       malloc_ptr = (malloc_ptr + 3) &amp; ~3;     /* Align */

       p = (void *)malloc_ptr;
       malloc_ptr += size;

       if (free_mem_end_ptr &amp;&amp; malloc_ptr &gt;= free_mem_end_ptr)
                error("Out of memory");

       malloc_count++;
       return p;
}

static void free(void *where)
{
       malloc_count--;
       if (!malloc_count)
                malloc_ptr = free_mem_ptr;
}
</pre><p>
	</p>	
</div>
<div class="sect2" title="7.13. &#37325;&#23450;&#20301;&#20869;&#26680;"><div class="titlepage"><div><div><h3 class="title"><a name="idp80483444"></a>7.13. &#37325;&#23450;&#20301;&#20869;&#26680;</h3></div></div></div>
&#34429;&#28982;&#20869;&#26680;&#24050;&#32463;&#34987;&#35299;&#21387;&#21040;&#20102;&#20869;&#23384;&#20013;&#65292;&#20294;&#26159;&#36824;&#38656;&#35201;&#36827;&#34892;&#37325;&#23450;&#20301;&#25165;&#33021;&#36816;&#34892;&#12290;
<p>
</p><pre class="programlisting">
                add     r0, r0, #127 + 128      @ alignment + stack
                bic     r0, r0, #127            @ align the kernel length 
</pre><p>	
r0&#26159;decompress_kernel&#30340;&#36820;&#22238;&#20540;&#65292;&#27880;&#24847;&#21040;&#23427;&#30340;&#26368;&#21518;&#19968;&#34892;&#20195;&#30721;return output_ptr&#65292;&#32780;output_ptr&#36820;&#22238;&#30340;&#27491;&#26159;&#35299;&#21387;&#21518;&#20869;&#26680;&#30340;&#38271;&#24230;&#12290;&#20197;&#19978;&#20004;&#34892;&#20195;&#30721;&#22312;&#20869;&#26680;&#26411;&#23614;&#31354;&#20986;128&#23383;&#33410;&#30340;&#26632;&#31354;&#38388;&#65292;&#24182;&#19988;&#20351;&#20854;&#38271;&#24230;128&#23383;&#33410;&#23545;&#40784;&#12290;
</p><pre class="programlisting">
/*
 * r0     = decompressed kernel length
 * r1-r3  = unused
 * r4     = kernel execution address
 * r5     = decompressed kernel start
 * r6     = processor ID
 * r7     = architecture ID
 * r8     = atags pointer
 * r9-r14 = corrupted
 */
		add	r1, r5, r0		@ end of decompressed kernel
		adr	r2, reloc_start
		ldr	r3, LC1
		add	r3, r2, r3
1:		ldmia	r2!, {r9 - r14}		@ copy relocation code
		stmia	r1!, {r9 - r14}
		ldmia	r2!, {r9 - r14}
		stmia	r1!, {r9 - r14}
		cmp	r2, r3
		blo	1b
		add	sp, r1, #128		@ relocate the stack
</pre><p>
&#35745;&#31639;&#20869;&#26680;&#26411;&#23614;&#22320;&#22336;&#24182;&#23384;&#25918;&#20110;r1&#23492;&#23384;&#22120;&#65292;&#38656;&#35201;&#25644;&#31227;&#20195;&#30721;&#21407;&#26469;&#22320;&#22336;&#25918;&#22312;r2&#65292;&#38656;&#35201;&#25644;&#31227;&#30340;&#38271;&#24230;&#25918;&#22312;r3&#12290;&#28982;&#21518;&#25191;&#34892;&#25644;&#31227;&#65292;&#24182;&#35774;&#32622;&#22909;sp&#25351;&#38024;&#25351;&#21521;&#26032;&#30340;&#26632;&#65292;&#27492;&#26102;&#21407;&#26469;&#30340;&#26632;&#20250;&#34987;&#20869;&#26680;&#35206;&#30422;&#25481;&#12290;&#27492;&#26102;&#30340;&#20869;&#26680;&#22320;&#22336;&#20998;&#37197;&#22914;&#19979;&#22270;&#65306;
</p><div class="figure"><a name="idp80534028"></a><p class="title"><b>&#22270; 44. &#20869;&#26680;&#22320;&#22336;&#20998;&#37197;</b></p><div class="figure-contents"><div><img src="images/boot_kernel.gif" alt="&#20869;&#26680;&#22320;&#22336;&#20998;&#37197;"></div></div></div><p><br class="figure-break">
</p><pre class="programlisting">
call_kernel:	bl	cache_clean_flush
		bl	cache_off
		mov	r0, #0			@ must be zero
		mov	r1, r7			@ restore architecture number
		mov	r2, r8			@ restore atags pointer
		mov	pc, r4			@ call kernel
</pre><p>
&#25644;&#31227;&#23436;&#25104;&#21518;&#21047;&#26032;cache&#65292;&#22240;&#20026;&#20195;&#30721;&#22320;&#22336;&#21464;&#21270;&#20102;&#19981;&#33021;&#35753;cache&#20877;&#21629;&#20013;&#34987;&#20869;&#26680;&#35206;&#30422;&#30340;&#32769;&#22320;&#22336;&#12290;&#28982;&#21518;&#36339;&#36716;&#21040;&#26032;&#30340;&#22320;&#22336;&#32487;&#32493;&#25191;&#34892;&#12290;&#20256;&#36882;&#32473;&#31532;&#19968;&#20010;&#20869;&#26680;&#20989;&#25968;&#30340;&#21442;&#25968;&#20026;r0&#20026;0&#65292;r1&#20026;&#26550;&#26500;&#32534;&#21495;&#65292;r2&#20197;&#21450;Uboot&#20256;&#36882;&#32473;&#20869;&#26680;&#21442;&#25968;&#38142;&#34920;&#30340;&#39318;&#22320;&#22336;&#12290;&#33267;&#27492;&#65292;&#24320;&#22987;&#27491;&#24335;&#36339;&#21040;&#20869;&#26680;&#20195;&#30721;&#25191;&#34892;&#65281;

&#38382;&#39064;3&#65306;&#35299;&#21387;&#20989;&#25968;&#26159;&#22914;&#20309;&#30830;&#23450;&#20195;&#30721;&#20013;&#21387;&#32553;&#20869;&#26680;&#20301;&#32622;&#30340;&#65311;&#39318;&#20808;&#30475;&#30475;piggy.o&#26159;&#22914;&#20309;&#29983;&#25104;&#30340;&#65292;&#22312;arch/arm/boot/compressed/Makefie&#20013;
</p><pre class="programlisting">
$(obj)/piggy.$(suffix_y): $(obj)/../Image FORCE
Piggy.gzip.o&#26159;&#30001;piggy.gzip.S&#29983;&#25104;&#30340;&#65292;&#21681;&#20204;&#30475;&#30475;piggy.gzip.S&#30340;&#20869;&#23481;&#65306;
.section .piggydata,#alloc
.globl input_data
input_data:
.incbin "arch/arm/boot/compressed/piggy.gzip"
.globl input_data_end
input_data_end:
&#20877;&#30475;&#30475;misc.c&#20013;decompress_kernel&#20989;&#25968;&#21543;&#65292;&#23427;&#23558;&#35843;&#29992;gunzip()&#35299;&#21387;&#20869;&#26680;&#12290;
gunzip()&#22312;lib/inflate.c&#20013;&#23450;&#20041;&#65292;&#23427;&#23558;&#35843;&#29992;NEXTBYTE()&#65292;&#36827;&#32780;&#35843;&#29992;get_byte()&#26469;&#33719;&#21462;&#21387;&#32553;&#20869;&#26680;&#20195;&#30721;&#12290;

&#22312;misc.c&#20013;
#define get_byte() (inptr &lt; insize ? inbuf[inptr++] : fill_inbuf())

&#26597;&#30475;fill_inbuf&#20989;&#25968;
int fill_inbuf(void)
{
if (insize != 0)
error("ran out of input data");
inbuf = input_data;
insize = &amp;input_data_end[0] - &amp;input_data[0];
inptr = 1;
return inbuf[0];
}
</pre><p>	
&#21457;&#29616;&#20160;&#20040;&#27809;&#65311;&#36825;&#37324;&#30340;input_data&#19981;&#27491;&#26159;piggy.gzip.S&#37324;&#30340;input_data&#21527;&#65311;&#36825;&#20010;&#26102;&#20505;&#24212;&#35813;
&#26126;&#30333;&#20869;&#26680;&#26159;&#24590;&#26679;&#30830;&#23450;piggy.gz&#22312;zImage&#20013;&#30340;&#20301;&#32622;&#20102;&#21543;&#12290;

</p>

</div>
<div class="footnotes"><br><hr width="100" align="left"><div class="footnote"><p><sup>[<a name="ftn.idp80486020" href="#idp80486020" class="para">4</a>] </sup></p>&#36825;&#37324;&#20043;&#25152;&#20197;&#19981;&#30452;&#25509;&#21453;&#27719;&#32534;zImage&#65292;&#26159;&#22240;&#20026;zImage&#26159;&#26681;&#25454;vmlinux&#29983;&#25104;&#30340;&#21407;&#22987;&#20108;&#36827;&#21046;&#25991;&#20214;&#65292;&#32780;&#19981;&#20877;&#26159;&#26631;&#20934;&#30340;ELF&#25991;&#20214;&#65292;&#27492;&#26102;objdump&#21629;&#20196;&#26080;&#27861;&#35782;&#21035;&#23427;&#12290;</div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ar01s06.html">&#19978;&#19968;&#39029;</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="ar01s08.html">&#19979;&#19968;&#39029;</a></td></tr><tr><td width="40%" align="left" valign="top">6. Uboot&#21551;&#21160;&#20998;&#26512; </td><td width="20%" align="center"><a accesskey="h" href="index.html">&#36215;&#22987;&#39029;</a></td><td width="40%" align="right" valign="top"> 8. &#20869;&#26680;&#21152;&#36733;</td></tr></table></div></body></html>
