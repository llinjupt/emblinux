<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>13. &#20869;&#23384;&#31649;&#29702;</title><link rel="stylesheet" href="styles.css" type="text/css"><meta name="generator" content="DocBook XSL-NS Stylesheets V1.75.2"><link rel="home" href="index.html" title="Linux&#20869;&#26680;&#23398;&#20064;&#21644;&#30740;&#31350;&#21450;&#23884;&#20837;&#24335;(ARM)&#23398;&#20064;&#21644;&#30740;&#31350;&#30340;&#24320;&#25918;&#25991;&#26723;"><link rel="up" href="index.html" title="Linux&#20869;&#26680;&#23398;&#20064;&#21644;&#30740;&#31350;&#21450;&#23884;&#20837;&#24335;(ARM)&#23398;&#20064;&#21644;&#30740;&#31350;&#30340;&#24320;&#25918;&#25991;&#26723;"><link rel="prev" href="ar01s12.html" title="12. &#39029;&#34920;&#26426;&#21046;"><link rel="next" href="ar01s14.html" title="14. &#20249;&#20276;&#31995;&#32479;"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">13. &#20869;&#23384;&#31649;&#29702;</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ar01s12.html">&#19978;&#19968;&#39029;</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="ar01s14.html">&#19979;&#19968;&#39029;</a></td></tr></table><hr></div><div class="sect1" title="13. &#20869;&#23384;&#31649;&#29702;"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp81044412"></a>13. &#20869;&#23384;&#31649;&#29702;</h2></div></div></div>
<div class="sect2" title="13.1. &#24341;&#35328;"><div class="titlepage"><div><div><h3 class="title"><a name="idp81044836"></a>13.1. &#24341;&#35328;</h3></div></div></div>
	<p>
Linux&#23545;&#29289;&#29702;&#20869;&#23384;&#30340;&#25551;&#36848;&#26426;&#21046;&#26377;&#20004;&#31181;&#65306;UMA&#21644;NUMA&#12290;Linux&#25226;&#29289;&#29702;&#20869;&#23384;&#21010;&#20998;&#20026;&#19977;&#20010;&#23618;&#27425;&#26469;&#31649;&#29702;&#65306;&#23384;&#20648;&#33410;&#28857;&#65288;Node&#65289;&#12289;&#31649;&#29702;&#21306;&#65288;Zone&#65289;&#21644;&#39029;&#38754;&#65288;Page&#65289;&#12290;UMA&#23545;&#24212;&#19968;&#33268;&#23384;&#20648;&#32467;&#26500;&#65292;&#23427;&#21482;&#38656;&#35201;&#19968;&#20010;Node&#23601;&#21487;&#20197;&#25551;&#36848;&#24403;&#21069;&#31995;&#32479;&#20013;&#30340;&#29289;&#29702;&#20869;&#23384;&#65292;&#20294;&#26159;NUMA&#30340;&#20986;&#29616;&#25171;&#30772;&#20102;&#36825;&#31181;&#24179;&#38745;&#65292;&#27492;&#26102;&#38656;&#35201;&#22810;&#20010;Node&#65292;&#23427;&#20204;&#34987;&#32479;&#19968;&#23450;&#20041;&#20026;&#19968;&#20010;&#21517;&#20026;discontig_node_data&#30340;&#25968;&#32452;&#12290;&#20026;&#20102;&#21644;UMA&#20860;&#23481;&#65292;&#23601;&#23558;&#25551;&#36848;UMA&#23384;&#20648;&#32467;&#26500;&#30340;&#25551;&#36848;&#31526;contig_page_data&#25918;&#21040;&#35813;&#25968;&#32452;&#30340;&#31532;&#19968;&#20010;&#20803;&#32032;&#20013;&#12290;&#20869;&#26680;&#37197;&#32622;&#36873;&#39033;CONFIG_NUMA&#20915;&#23450;&#20102;&#24403;&#21069;&#31995;&#32479;&#26159;&#21542;&#25903;&#25345;NUMA&#26426;&#21046;&#12290;&#27492;&#26102;&#26080;&#35770;UMA&#36824;&#26159;NUMA&#65292;&#23427;&#20204;&#37117;&#26159;&#23545;&#24212;&#21040;&#19968;&#20010;&#31867;&#22411;&#20026;pg_data_t&#30340;&#25968;&#32452;&#20013;&#65292;&#20415;&#20110;&#32479;&#19968;&#31649;&#29702;&#12290;</p>
<div class="figure"><a name="idp81046092"></a><p class="title"><b>&#22270; 72. Node Zone&#21644;Page&#30340;&#20851;&#31995;</b></p><div class="figure-contents"><div><img src="images/mem_topo.gif" alt="Node Zone&#21644;Page&#30340;&#20851;&#31995;"></div></div></div><br class="figure-break">
<p>
&#19978;&#22270;&#25551;&#36848;Linux&#31649;&#29702;&#29289;&#29702;&#20869;&#23384;&#30340;&#19977;&#20010;&#23618;&#27425;&#20043;&#38388;&#30340;&#25299;&#25169;&#20851;&#31995;&#12290;&#20174;&#22270;&#20013;&#21487;&#20197;&#30475;&#20986;&#19968;&#20010;&#23384;&#20648;&#33410;&#28857;&#30001;pg_data_t&#25551;&#36848;&#65292;&#19968;&#20010;UMA&#31995;&#32479;&#20013;&#21482;&#26377;&#19968;&#20010;Node&#65292;&#32780;&#22312;NUMA&#20013;&#21017;&#21487;&#20197;&#23384;&#22312;&#22810;&#20010;Node&#12290;&#23427;&#30001;CONFIG_NODES_SHIFT&#37197;&#32622;&#36873;&#39033;&#20915;&#23450;&#65292;&#23427;&#26159;CONFIG_NUMA&#30340;&#23376;&#36873;&#39033;&#65292;&#25152;&#20197;&#21482;&#26377;&#37197;&#32622;&#20102;CONFIG_NUMA&#65292;&#35813;&#36873;&#39033;&#25165;&#36215;&#20316;&#29992;&#12290;UMA&#24773;&#20917;&#19979;&#65292;NODES_SHIFT&#34987;&#23450;&#20041;&#20026;0&#65292;MAX_NUMNODES&#20063;&#21363;&#20026;1&#12290;
</p><pre class="programlisting">
include/linux/numa.h

#ifdef CONFIG_NODES_SHIFT
#define NODES_SHIFT     CONFIG_NODES_SHIFT
#else
#define NODES_SHIFT     0
#endif

#define MAX_NUMNODES    (1 &lt;&lt; NODES_SHIFT)
</pre><p>
&#36825;&#37324;&#20027;&#35201;&#20171;&#32461;UMA&#26426;&#21046;&#12290;contig_page_data&#34987;&#23450;&#20041;&#22914;&#19979;&#65306;
</p><pre class="programlisting">
mm/page_alloc.c
struct pglist_data __refdata contig_page_data = { .bdata = &amp;bootmem_node_data[0] };
EXPORT_SYMBOL(contig_page_data);
</pre><p>
struct pglist_data&#21363;&#26159;pg_data_t&#30340;&#21407;&#22411;&#12290;&#20102;&#35299;pg_data_t&#20013;&#30340;&#32467;&#26500;&#25104;&#21592;&#23545;&#20110;&#20102;&#35299;&#20869;&#23384;&#31649;&#29702;&#26159;&#24517;&#32463;&#20043;&#36335;&#65306;
</p><pre class="programlisting">
enum zone_type {
ZONE_DMA,
ZONE_NORMAL,
ZONE_MOVABLE,
......
__MAX_NR_ZONES
};

typedef struct pglist_data {
        struct zone node_zones[MAX_NR_ZONES];
        struct zonelist node_zonelists[MAX_ZONELISTS];
        int nr_zones;
#ifdef CONFIG_FLAT_NODE_MEM_MAP /* means !SPARSEMEM */
        struct page *node_mem_map;
#ifdef CONFIG_CGROUP_MEM_RES_CTLR
        struct page_cgroup *node_page_cgroup;
#endif
#endif
        struct bootmem_data *bdata;

...... /* for CONFIG_MEMORY_HOTPLUG */

        unsigned long node_start_pfn;
        unsigned long node_present_pages; /* total number of physical pages */
        unsigned long node_spanned_pages; /* total size of physical page
                                             range, including holes */
        int node_id;
        wait_queue_head_t kswapd_wait;
        struct task_struct *kswapd;
        int kswapd_max_order;
} pg_data_t;
</pre><p>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">node_zones&#65306;&#24403;&#21069;&#33410;&#28857;&#20013;&#21253;&#21547;&#30340;&#26368;&#22823;&#31649;&#29702;&#21306;&#25968;&#12290;MAX_NR_ZONES&#22312;include/linux/bounds.h&#23450;&#20041;&#65292;&#35813;&#25991;&#20214;&#26159;&#22312;&#32534;&#35793;&#36807;&#31243;&#20013;&#26681;&#25454;&#31649;&#29702;&#21306;&#31867;&#22411;&#23450;&#20041;&#20013;&#30340;__MAX_NR_ZONES&#21464;&#37327;&#33258;&#21160;&#29983;&#25104;&#30340;&#12290;</li><li class="listitem">node_zonelists&#65306;&#20869;&#23384;&#20998;&#37197;&#22120;&#25152;&#20351;&#29992;&#30340;&#31649;&#29702;&#21306;&#38142;&#34920;&#25968;&#32452;&#65292;MAX_ZONELISTS&#30340;&#20540;&#22312;&#37197;&#32622;CONFIG_NUMA&#26102;&#20026;2&#65292;&#21542;&#21017;&#20026;1&#12290;&#32034;&#24341;&#20026;0&#30340;&#38142;&#34920;&#34920;&#31034;&#21518;&#25588;(Fallback)&#38142;&#34920;&#65292;&#20063;&#21363;&#24403;&#35813;&#38142;&#34920;&#20013;&#30340;&#31532;&#19968;&#20010;&#19981;&#28385;&#36275;&#20998;&#37197;&#20869;&#23384;&#26102;&#65292;&#20381;&#27425;&#23581;&#35797;&#38142;&#34920;&#30340;&#20854;&#20182;&#31649;&#29702;&#21306;&#12290;&#32034;&#24341;&#20026;1,&#30340;&#38142;&#34920;&#21017;&#29992;&#26469;&#38024;&#23545;GFP_THISNODE&#30340;&#20869;&#23384;&#30003;&#35831;&#65292;&#27492;&#26102;&#21482;&#33021;&#30003;&#35831;&#25351;&#23450;&#30340;&#35813;&#38142;&#34920;&#20013;&#30340;&#31649;&#29702;&#21306;&#12290;
</li><li class="listitem">nr_zones&#65306;&#25351;&#23450;&#24403;&#21069;&#33410;&#28857;&#20013;&#30340;&#31649;&#29702;&#21306;&#25968;&#65292;&#20063;&#21363;node_zones&#20013;&#23454;&#38469;&#29992;&#21040;&#30340;&#31649;&#29702;&#21306;&#25968;&#12290;&#23427;&#30340;&#21462;&#20540;&#33539;&#22260;&#20026;[1, MAX_NR_ZONES]&#12290;&#23545;&#20110;UMA&#26469;&#35828;&#65292;&#23427;&#30340;&#20540;&#20026;1&#12290;</li><li class="listitem">node_mem_map&#65306;&#33410;&#28857;&#20013;&#39029;&#25551;&#36848;&#31526;&#25968;&#32452;&#39318;&#22320;&#22336;&#12290;</li><li class="listitem">node_page_cgroup&#65306;</li><li class="listitem">bdata&#65306;&#31995;&#32479;&#24341;&#23548;&#26102;&#29992;&#30340;Bootmem&#20998;&#37197;&#22120;&#12290;</li><li class="listitem">node_start_pfn&#65306;&#33410;&#28857;&#20013;&#31532;&#19968;&#20010;&#39029;&#26694;&#30340;&#19979;&#26631;&#12290;</li><li class="listitem">node_present_pages&#65306;&#33410;&#28857;&#20013;&#30340;&#39029;&#38754;&#25968;&#65292;&#19981;&#21253;&#21547;&#23380;&#27934;&#12290;</li><li class="listitem">node_spanned_pages&#65306;&#33410;&#28857;&#20013;&#30340;&#39029;&#38754;&#24635;&#25968;&#65292;&#21253;&#21547;&#23380;&#27934;&#12290;</li><li class="listitem">node_id&#65306;&#33410;&#28857;&#26631;&#35782;&#31526;&#65292;&#22312;&#33410;&#28857;&#25968;&#32452;&#20013;&#21807;&#19968;&#23384;&#22312;&#12290;</li><li class="listitem">kswapd_wait&#65306;kswapd&#39029;&#25442;&#20986;&#23432;&#25252;&#36827;&#31243;&#20351;&#29992;&#30340;&#31561;&#24453;&#38431;&#21015;&#12290;</li><li class="listitem">kswapd: &#25351;&#38024;&#25351;&#21521;kswaps&#20869;&#26680;&#32447;&#31243;&#30340;&#36827;&#31243;&#25551;&#36848;&#31526;&#12290;</li><li class="listitem">kswapd_max_order&#65306;kswapd&#23558;&#35201;&#21019;&#24314;&#30340;&#31354;&#38386;&#22359;&#22823;&#23567;&#21462;&#23545;&#25968;&#30340;&#20540;&#12290;</li></ul></div><p>
&#27880;&#24847;&#21040;zonelist&#20013;&#30340;_zonerefs&#20803;&#32032;&#65292;&#23427;&#29992;&#26469;&#23454;&#29616;&#20998;&#37197;&#22120;&#20998;&#37197;&#20869;&#23384;&#26102;&#20505;&#30340;&#31649;&#29702;&#21306;&#21518;&#25588;&#21151;&#33021;&#12290;MAX_ZONES_PER_ZONELIST&#34987;&#23450;&#20041;&#20026;&#25152;&#26377;&#33410;&#28857;&#20013;&#21253;&#21547;&#30340;&#26368;&#22810;&#31649;&#29702;&#21306;&#30340;&#21644;&#24182;&#21152;&#19978;1&#65292;&#21152;1&#30340;&#30446;&#30340;&#26159;&#22312;&#21518;&#25588;&#38142;&#34920;&#20013;&#65292;&#21487;&#20197;&#26816;&#27979;&#26159;&#21542;&#36941;&#21382;&#21040;&#26368;&#21518;&#19968;&#20010;&#33410;&#28857;&#20102;&#65292;&#22914;&#26524;&#26159;&#35828;&#26126;&#30003;&#35831;&#22833;&#36133;&#12290;
</p><pre class="programlisting">
/* Maximum number of zones on a zonelist */
#define MAX_ZONES_PER_ZONELIST (MAX_NUMNODES * MAX_NR_ZONES)

struct zonelist {
        struct zonelist_cache *zlcache_ptr;                  // NULL or &amp;zlcache
        struct zoneref _zonerefs[MAX_ZONES_PER_ZONELIST + 1];
#ifdef CONFIG_NUMA
        struct zonelist_cache zlcache;                       // optional ...
#endif
};
</pre><p>
&#33410;&#28857;&#20013;&#30340;&#31649;&#29702;&#21306;&#37117;&#22312;free_area_init_core&#20989;&#25968;&#20013;&#21021;&#22987;&#21270;&#12290;&#35843;&#29992;&#20851;&#31995;&#22914;&#19979;&#25152;&#31034;&#65306;
</p><pre class="programlisting">
start_kernel-&gt;setup_arch-&gt;paging_init-&gt;bootmem_init-&gt;bootmem_free_node-&gt;free_area_init_node-&gt;free_area_init_core
</pre><p>
	</p>
<p>
&#22312;&#29702;&#24819;&#30340;&#35745;&#31639;&#26426;&#20307;&#31995;&#32467;&#26500;&#20013;&#65292;&#19968;&#20010;&#29289;&#29702;&#39029;&#26694;&#23601;&#26159;&#19968;&#20010;&#20869;&#23384;&#23384;&#20648;&#21333;&#20803;&#65292;&#21487;&#29992;&#20110;&#20219;&#20309;&#20107;&#24773;&#65306;&#23384;&#25918;&#20869;&#26680;&#25968;&#25454;&#21644;&#29992;&#25143;&#25968;&#25454;&#65292;&#30913;&#30424;&#32531;&#20914;&#25968;&#25454;&#31561;&#12290;&#28909;&#27827;&#20013;&#30922;&#30340;&#25968;&#25454;&#39029;&#37117;&#21487;&#20197;&#23384;&#25918;&#22312;&#20219;&#20309;&#39029;&#26694;&#20013;&#65292;&#27809;&#26377;&#20160;&#20040;&#38480;&#21046;&#12290;&#20294;&#26159;&#65292;&#23454;&#38469;&#30340;&#35745;&#31639;&#26426;&#20307;&#31995;&#32467;&#26500;&#26377;&#30828;&#20214;&#30340;&#21046;&#32422;&#65292;&#36825;&#21046;&#32422;&#39029;&#26694;&#21487;&#20197;&#20351;&#29992;&#30340;&#26041;&#24335;&#12290;&#23588;&#20854;&#26159;Linux&#20869;&#26680;&#24517;&#39035;&#22788;&#29702;80x86&#20307;&#31995;&#32467;&#26500;&#30340;&#20004;&#31181;&#30828;&#20214;&#32422;&#26463;&#65306;
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">ISA&#24635;&#32447;&#30340;&#30452;&#25509;&#20869;&#23384;&#23384;&#21462;DMA&#35775;&#38382;&#25511;&#21046;&#22120;&#21482;&#33021;&#23545;RAM&#30340;&#20302;16MB&#23547;&#22336;&#12290;</li><li class="listitem">&#22312;&#20855;&#26377;&#22823;&#23481;&#37327;RAM&#30340;&#29616;&#20195;32&#20301;&#35745;&#31639;&#26426;&#20013;&#65292;&#30001;&#20110;&#32447;&#24615;&#22320;&#22336;&#31354;&#38388;&#30340;&#38480;&#21046;&#65292;CPU&#19981;&#33021;&#30452;&#25509;&#35775;&#38382;&#25152;&#26377;&#30340;&#29289;&#29702;&#20869;&#23384;&#12290;</li></ul></div><p>	
&#26368;&#21518;&#19968;&#31181;&#38480;&#21046;&#19981;&#20165;&#23384;&#22312;&#20110;80x86&#65292;&#32780;&#23384;&#22312;&#20110;&#25152;&#26377;&#30340;&#20307;&#31995;&#32467;&#26500;&#20013;&#12290;&#20026;&#20102;&#24212;&#23545;&#36825;&#20004;&#31181;&#38480;&#21046;&#65292;Linux&#25226;&#27599;&#20010;&#20869;&#23384;&#33410;&#28857;&#30340;&#29289;&#29702;&#20869;&#23384;&#21010;&#20998;&#20026;&#22810;&#20010;&#65288;&#36890;&#24120;&#20026;3&#20010;&#65289;&#31649;&#29702;&#21306;&#65288;zone&#65289;&#12290;&#22312;80x86 UMA&#20307;&#31995;&#32467;&#26500;&#20013;&#30340;&#31649;&#29702;&#21306;&#20026;&#65306;
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">ZONE_DMA&#65292;&#21253;&#21547;&#20302;&#20110;16MB&#30340;&#20869;&#23384;&#39029;&#26694;&#12290;</li><li class="listitem">ZONE_NORMAL&#65292;&#21253;&#21547;&#39640;&#20110;16MB&#19988;&#20302;&#20110;896MB&#30340;&#20869;&#23384;&#39029;&#26694;&#12290;</li><li class="listitem">ZONE_HIGHMEM&#65292;&#21253;&#21547;&#20174;896MB&#24320;&#22987;&#30340;&#20869;&#23384;&#39029;&#26694;&#12290;</li></ul></div><p>
&#23545;&#20110;ARM&#26469;&#35828;&#65292;ZONE_HIGHMEM&#34987;&#21517;&#20026;ZONE_MOVABLE&#30340;&#23439;&#21462;&#20195;&#65292;&#32780;ZONE_DMA&#20063;&#19981;&#20250;&#20165;&#38480;&#20110;&#26368;&#20302;&#30340;16MB&#65292;&#32780;&#21487;&#33021;&#23545;&#24212;&#25152;&#26377;&#30340;&#20869;&#23384;&#21306;&#22495;&#65292;&#27492;&#26102;&#21482;&#26377;&#20869;&#23384;&#33410;&#28857;ZONE_DMA&#26377;&#25928;&#65292;&#25152;&#20197;ZONE_DMA&#24182;&#19981;&#19968;&#23450;&#21517;&#21103;&#20854;&#23454;&#30340;&#29992;&#26469;&#20316;&#20026;DMA&#35775;&#38382;&#20043;&#29992;&#12290;
</p>
<p>
ZONE_DMA&#21644;ZONE_NORMAL&#21306;&#21253;&#21547;&#20869;&#23384;&#30340;"&#24120;&#35268;"&#39029;&#26694;&#65292;&#36890;&#36807;&#25226;&#23427;&#20204;&#32447;&#24615;&#30340;&#26144;&#23556;&#21040;&#32447;&#24615;&#22320;&#22336;&#30340;&#31532;4&#20010;GB&#65288;0xc0000000-0xcfffffff&#65289;&#65292;&#20869;&#26680;&#23601;&#21487;&#20197;&#30452;&#25509;&#35775;&#38382;&#12290;&#30456;&#21453;ZONE_HIGHMEM&#25110;&#32773;ZONE_MOVABLE&#21306;&#21253;&#21547;&#30340;&#20869;&#23384;&#39029;&#19981;&#33021;&#30001;&#20869;&#26680;&#30452;&#25509;&#35775;&#38382;&#65292;&#23613;&#31649;&#23427;&#20204;&#20063;&#32447;&#24615;&#22320;&#26144;&#23556;&#21040;&#20102;&#32447;&#24615;&#22320;&#22336;&#31354;&#38388;&#30340;&#31532;4&#20010;GB&#12290;&#27599;&#20010;&#20869;&#23384;&#31649;&#29702;&#21306;&#37117;&#26377;&#33258;&#24049;&#30340;&#25551;&#36848;&#31526;struct zone&#12290;&#23427;&#29992;&#26469;&#20445;&#23384;&#31649;&#29702;&#21306;&#30340;&#36319;&#36394;&#20449;&#24687;&#65306;&#20869;&#23384;&#20351;&#29992;&#32479;&#35745;&#65292;&#31354;&#38386;&#21306;&#65292;&#38145;&#23450;&#21306;&#31561;&#12290;
</p><pre class="programlisting">
include/linux/mmzone.h
struct zone {
        /* Fields commonly accessed by the page allocator */
        unsigned long           pages_min, pages_low, pages_high;

        unsigned long           lowmem_reserve[MAX_NR_ZONES];
        struct per_cpu_pageset  pageset[NR_CPUS];
        
        struct free_area        free_area[MAX_ORDER];

        ZONE_PADDING(_pad1_)

        /* Fields commonly accessed by the page reclaim scanner */
        spinlock_t              lru_lock;
        struct {
                struct list_head list;
                unsigned long nr_scan;
        } lru[NR_LRU_LISTS];
        
        unsigned long           recent_rotated[2];
        unsigned long           recent_scanned[2];

        unsigned long           pages_scanned;     /* since last reclaim */
        unsigned long           flags;             /* zone flags, see below */

        /* Zone statistics */
        atomic_long_t           vm_stat[NR_VM_ZONE_STAT_ITEMS];
};
</pre><p>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">pages_min&#65292;&#35760;&#24405;&#31649;&#29702;&#21306;&#20013;&#31354;&#38386;&#39029;&#30340;&#25968;&#30446;&#12290;</li><li class="listitem">pages_low&#65292;&#22238;&#25910;&#39029;&#26694;&#20351;&#29992;&#30340;&#19979;&#23626;&#65292;&#21516;&#26102;&#20063;&#34987;&#31649;&#29702;&#21306;&#20998;&#37197;&#22120;&#20316;&#20026;&#38408;&#20540;&#20351;&#29992;&#12290;</li><li class="listitem">pages_high&#65292;&#22238;&#25910;&#39029;&#26694;&#20351;&#29992;&#30340;&#19978;&#23626;&#65292;&#21516;&#26102;&#20063;&#34987;&#31649;&#29702;&#21306;&#20998;&#37197;&#22120;&#20316;&#20026;&#38408;&#20540;&#20351;&#29992;&#12290;</li><li class="listitem">lowmem_reserve&#65292;&#25351;&#26126;&#22312;&#22788;&#29702;&#20869;&#23384;&#19981;&#36275;&#30340;&#20020;&#30028;&#24773;&#20917;&#19979;&#27599;&#20010;&#31649;&#29702;&#21306;&#24517;&#39035;&#20445;&#30041;&#30340;&#39029;&#26694;&#25968;&#30446;&#12290;</li><li class="listitem">pageset&#65292;&#21333;&#19968;&#39029;&#26694;&#30340;&#29305;&#27530;&#21578;&#35785;&#32531;&#23384;&#12290;</li><li class="listitem"></ul></div><p>
&#22312;&#30003;&#35831;&#20869;&#23384;&#26102;&#65292;&#20250;&#36935;&#21040;&#20004;&#31181;&#24773;&#20917;&#65306;&#22914;&#26524;&#26377;&#36275;&#22815;&#30340;&#31354;&#38386;&#39029;&#21487;&#29992;&#65292;&#35831;&#27714;&#23601;&#20250;&#34987;&#31435;&#21051;&#28385;&#36275;;&#21542;&#21017;&#65292;&#24517;&#39035;&#22238;&#25910;&#19968;&#20123;&#20869;&#23384;&#65292;&#24182;&#19988;&#23558;&#21457;&#20986;&#35831;&#27714;&#30340;&#20869;&#26680;&#25511;&#21046;&#36335;&#24452;&#38459;&#22622;&#65292;&#30452;&#21040;&#26377;&#20869;&#23384;&#34987;&#37322;&#25918;&#12290;&#19981;&#36807;&#26377;&#20123;&#20869;&#23384;&#35831;&#27714;&#19981;&#33021;&#34987;&#38459;&#22622;&#12290;&#36825;&#31181;&#24773;&#20917;&#21457;&#29983;&#22312;&#22788;&#29702;&#20013;&#26029;&#25110;&#22312;&#25191;&#34892;&#20020;&#30028;&#21306;&#20869;&#30340;&#20195;&#30721;&#26102;&#12290;&#22312;&#36825;&#20123;&#24773;&#20917;&#19979;&#65292;&#19968;&#26465;&#20869;&#26680;&#25511;&#21046;&#36335;&#24452;&#24212;&#20351;&#29992;&#21407;&#23376;&#20869;&#23384;&#20998;&#37197;&#35831;&#27714;(GFP_ATOMIC)&#12290;&#21407;&#23376;&#35831;&#27714;&#20174;&#19981;&#34987;&#38459;&#22622;&#65307;&#22914;&#26524;&#27809;&#26377;&#36275;&#22815;&#30340;&#31354;&#38386;&#39029;&#65292;&#21017;&#20165;&#20165;&#26159;&#20998;&#37197;&#22833;&#36133;&#32780;&#24050;&#12290;</p>
<p>
&#20869;&#26680;&#20026;&#20102;&#23613;&#21487;&#33021;&#20445;&#35777;&#19968;&#20010;&#21407;&#23376;&#20869;&#23384;&#20998;&#37197;&#35831;&#27714;&#25104;&#21151;&#65292;&#23427;&#20026;&#21407;&#23376;&#20869;&#23384;&#20998;&#37197;&#35831;&#27714;&#20445;&#30041;&#20102;&#19968;&#20010;&#39029;&#26694;&#27744;&#65292;&#21482;&#26377;&#22312;&#20869;&#23384;&#19981;&#36275;&#26102;&#25165;&#20351;&#29992;&#12290;&#20445;&#30041;&#20869;&#23384;&#30340;&#25968;&#37327;&#23384;&#25918;&#22312;min_free_kbytes&#21464;&#37327;&#20013;&#65292;&#21333;&#20301;&#20026;KB&#12290;
</p><pre class="programlisting">
mm/page_alloc.c

int min_free_kbytes = 1024;
.....

/* min_free_kbytes = sqrt(lowmem_kbytes * 16); */
lowmem_kbytes = nr_free_buffer_pages() * (PAGE_SIZE &gt;&gt; 10);
min_free_kbytes = int_sqrt(lowmem_kbytes * 16);
</pre><p>	
min_free_kbytes&#30001;&#24403;&#21069;&#30452;&#25509;&#26144;&#23556;&#21306;&#30340;&#29289;&#29702;&#20869;&#23384;&#25968;&#37327;&#20915;&#23450;&#12290;&#20063;&#21363;ZONE_DMA&#21644;ZONE_NORMAL&#20869;&#23384;&#31649;&#29702;&#21306;&#30340;&#21487;&#29992;&#39029;&#26694;&#25968;&#20915;&#23450;&#65292;&#36825;&#21487;&#20197;&#36890;&#36807;nr_free_buffer_pages&#33719;&#21462;&#12290;&#23613;&#31649;&#21487;&#20197;&#36890;&#36807;/proc/sys/vm/min_free_kbytes&#26469;&#20462;&#25913;&#35813;&#23427;&#30340;&#22823;&#23567;&#65292;&#20294;&#26159;min_free_kbytes&#30340;&#21021;&#22987;&#20540;&#33539;&#22260;&#24517;&#39035;&#26159;[128K, 64M]&#12290;&#31649;&#29702;&#21306;&#25551;&#36848;&#31526;&#20013;&#30340;pages_min&#25104;&#21592;&#23384;&#20648;&#20102;&#31649;&#29702;&#21306;&#20869;&#20445;&#30041;&#39029;&#26694;&#30340;&#25968;&#30446;&#12290;&#36825;&#20010;&#23383;&#27573;&#19982;pages_low&#21644;pages_high&#23383;&#27573;&#19968;&#36215;&#34987;&#29992;&#22312;&#20869;&#23384;&#20998;&#37197;&#21644;&#22238;&#25910;&#31639;&#27861;&#20013;&#12290;pages_low&#23383;&#27573;&#24635;&#26159;&#34987;&#35774;&#20026;pages_min&#30340;&#20540;&#30340;5/4&#65292;&#32780;pages_high&#21017;&#24635;&#26159;&#34987;&#35774;&#20026;pages_min&#30340;&#20540;&#30340;3/2&#12290;&#36825;&#20123;&#20540;&#22312;&#27169;&#22359;&#24555;&#21021;&#22987;&#21270;module_init&#35843;&#29992;&#30340;init_per_zone_pages_min&#20013;&#34987;&#35774;&#32622;&#12290;
</p><div class="table"><a name="idp81064940"></a><p class="title"><b>&#34920; 20. &#39029;&#38754;&#20998;&#37197;&#25511;&#21046;</b></p><div class="table-contents">
<table summary="&#39029;&#38754;&#20998;&#37197;&#25511;&#21046;" border="1"><colgroup><col><col></colgroup><thead><tr><th>&#21517;&#31216;</th><th>&#22823;&#23567;</th></tr></thead><tbody><tr><td>pages_min</td><td>min_free_kbytes &gt;&gt; (PAGE_SHIFT - 10)</td></tr><tr><td>pages_low</td><td>pages_min * 5 / 4</td></tr><tr><td>pages_high</td><td>pages_min * 3 / 2</td></tr></tbody></table>
</div></div><p><br class="table-break">
</p>	
	<p>
free_area_init_core&#20013;&#23545;&#31649;&#29702;&#21306;&#21021;&#22987;&#21270;&#30340;&#20195;&#30721;&#37096;&#20998;&#22914;&#19979;&#65292;&#21518;&#32493;&#31456;&#33410;&#23558;&#23545;&#35813;&#20989;&#25968;&#36827;&#19968;&#27493;&#20998;&#26512;&#12290;
</p><pre class="programlisting">
		zone-&gt;spanned_pages = size;
		zone-&gt;present_pages = realsize;

		zone-&gt;name = zone_names[j];
		spin_lock_init(&amp;zone-&gt;lock);
		spin_lock_init(&amp;zone-&gt;lru_lock);
		zone_seqlock_init(zone);
		zone-&gt;zone_pgdat = pgdat;

		zone-&gt;prev_priority = DEF_PRIORITY;

		zone_pcp_init(zone);
		for_each_lru(l) {
			INIT_LIST_HEAD(&amp;zone-&gt;lru[l].list);
			zone-&gt;lru[l].nr_scan = 0;
		}
		zone-&gt;recent_rotated[0] = 0;
		zone-&gt;recent_rotated[1] = 0;
		zone-&gt;recent_scanned[0] = 0;
		zone-&gt;recent_scanned[1] = 0;
		zap_zone_vm_stats(zone);
		zone-&gt;flags = 0;
</pre><p>	
	</p>
</div>
<div class="sect2" title="13.2. page&#31649;&#29702;&#39033;"><div class="titlepage"><div><div><h3 class="title"><a name="idp81069156"></a>13.2. page&#31649;&#29702;&#39033;</h3></div></div></div>
<pre class="programlisting">
struct page {
	unsigned long flags;		/* Atomic flags, some possibly
					 * updated asynchronously */
	atomic_t _count;		/* Usage count, see below. */
	union {
		atomic_t _mapcount;	/* Count of ptes mapped in mms,
					 * to show when page is mapped
					 * &amp; limit reverse map searches.
					 */
		struct {		/* SLUB */
			u16 inuse;
			u16 objects;
		};
	};
</pre>
&#27599;&#19968;&#20010;&#29289;&#29702;&#39029;&#26694;&#37117;&#38656;&#35201;&#19968;&#20010;&#23545;&#24212;&#30340;page&#32467;&#26500;&#26469;&#36827;&#34892;&#31649;&#29702;&#65306;&#35760;&#24405;&#20998;&#37197;&#29366;&#24577;&#65292;&#20998;&#37197;&#21644;&#22238;&#25910;&#65292;&#20114;&#26021;&#20197;&#21450;&#21516;&#27493;&#25805;&#20316;&#12290;&#23545;&#35813;&#32467;&#26500;&#25104;&#21592;&#30340;&#35299;&#37322;&#22914;&#19979;&#65306;
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">flag&#22495;&#23384;&#25918;&#24403;&#21069;&#39029;&#26694;&#30340;&#39029;&#26631;&#24535;&#65292;&#23427;&#23384;&#20648;&#20102;&#20307;&#31995;&#32467;&#26500;&#26080;&#20851;&#30340;&#29366;&#24577;&#65292;&#19987;&#38376;&#20379;Linux&#20869;&#26680;&#33258;&#36523;&#20351;&#29992;&#12290;&#35813;&#26631;&#24535;&#21487;&#33021;&#30340;&#20540;&#23450;&#20041;&#22312;include/linux/page-flags.h&#20013;&#12290;</li><li class="listitem">&#21407;&#23376;&#35745;&#25968;&#25104;&#21592;_count&#21017;&#25351;&#26126;&#20102;&#24403;&#21069;&#39029;&#26694;&#30340;&#24341;&#29992;&#35745;&#25968;&#65292;&#24403;&#35813;&#20540;&#20026;0&#26102;&#65292;&#23601;&#35828;&#26126;&#23427;&#27809;&#26377;&#34987;&#20351;&#29992;&#65292;&#27492;&#26102;&#22312;&#26032;&#20998;&#37197;&#20869;&#23384;&#26102;&#23427;&#23601;&#21487;&#20197;&#34987;&#20351;&#29992;&#12290;&#20869;&#26680;&#20195;&#30721;&#24212;&#35813;&#36890;&#36807;page_count&#26469;&#35775;&#38382;&#23427;&#65292;&#32780;&#38750;&#30452;&#25509;&#35775;&#38382;&#12290;</li><li class="listitem">&#21407;&#23376;&#35745;&#25968;&#25104;&#21592;_mapcount&#34920;&#31034;&#22312;&#39029;&#34920;&#20013;&#26377;&#22810;&#23569;&#39029;&#25351;&#21521;&#35813;&#39029;&#26694;&#12290;&#22312;SLUB&#20013;&#23427;&#34987;inuse&#21644;objects&#20195;&#26367;&#12290;</li></ul></div>
<pre class="programlisting">
include/linux/page-flags.h
enum pageflags {
        PG_locked,              /* Page is locked. Don't touch. */
        PG_error,
        PG_referenced,
        PG_uptodate,
        PG_dirty,
        PG_lru,
        PG_active,
        ......
        __NR_PAGEFLAGS,
        ......
}
</pre>
&#20197;&#19978;&#26159;&#39029;&#26631;&#24535;&#20301;&#30340;&#21487;&#33021;&#21462;&#20540;&#65292;&#36890;&#24120;&#19981;&#24212;&#35813;&#30452;&#25509;&#20351;&#29992;&#36825;&#20123;&#26631;&#24535;&#20301;&#65292;&#32780;&#24212;&#35813;&#20869;&#26680;&#39044;&#23450;&#20041;&#22909;&#30340;&#23439;&#65292;&#23427;&#20204;&#22312;&#30456;&#21516;&#30340;&#22836;&#25991;&#20214;&#20013;&#34987;&#23450;&#20041;&#65292;&#20294;&#26159;&#23427;&#20204;&#26159;&#34987;&#38388;&#25509;&#23450;&#20041;&#30340;&#65292;&#20063;&#21363;&#36890;&#36807;##&#36830;&#23383;&#31526;&#26469;&#32479;&#19968;&#23545;&#23427;&#20204;&#36827;&#34892;&#23450;&#20041;&#12290;
<pre class="programlisting">
#define TESTPAGEFLAG(uname, lname)					\
static inline int Page##uname(struct page *page) 			\
			{ return test_bit(PG_##lname, &amp;page-&gt;flags); }
......
TESTPAGEFLAG(Locked, locked)
PAGEFLAG(Error, error)
PAGEFLAG(Referenced, referenced) TESTCLEARFLAG(Referenced, referenced)
</pre>
<div class="table"><a name="idp81073276"></a><p class="title"><b>&#34920; 21. &#39029;&#26631;&#24535;&#23439;&#20989;&#25968;</b></p><div class="table-contents">
<table summary="&#39029;&#26631;&#24535;&#23439;&#20989;&#25968;" border="1"><colgroup><col><col></colgroup><thead><tr><th>&#23439;</th><th>&#25193;&#23637;&#20989;&#25968;/&#23439;</th><th>&#29992;&#36884;</th></tr></thead><tbody><tr><td>TESTPAGEFLAG(uname, lname)</td><td>Page##uname</td><td>&#27979;&#35797;PG_##lname&#20301;</td></tr><tr><td>SETPAGEFLAG(uname, lname)</td><td>SetPage##uname</td><td>&#35774;&#32622;PG_##lname&#20301;</td></tr><tr><td>CLEARPAGEFLAG(uname, lname)<sup>[<a name="idp81076444" href="#ftn.idp81076444" class="footnote">a</a>]</sup></td><td>ClearPage##uname</td><td>&#28165;&#38500;PG_##lname&#20301;</td></tr><tr><td>TESTSETFLAG(uname, lname)</td><td>TestSetPage##uname</td><td>&#27979;&#35797;&#24182;&#35774;&#32622;PG_##lname</td></tr><tr><td>TESTCLEARFLAG(uname, lname)</td><td>TestClearPage##uname</td><td>&#27979;&#35797;&#24182;&#28165;&#38500;PG_##lname</td></tr><tr><td>PAGEFLAG(uname, lname)<sup>[<a name="idp81078892" href="#ftn.idp81078892" class="footnote">b</a>]</sup></td><td> TESTPAGEFLAG<br>SETPAGEFLAG<br>CLEARPAGEFLAG</td><td>&#24403;&#20110;&#21516;&#26102;&#25193;&#23637;&#20102;&#19977;&#20010;&#23439;&#65292;&#20063;&#21363;&#19977;&#20010;&#20989;&#25968;</td></tr><tr><td>PAGEFLAG_FALSE(uname)</td><td>Page##uname</td><td>&#27704;&#36828;&#36820;&#22238;0</td></tr><tr><td>TESTSCFLAG(uname, lname)</td><td>TESTSETFLAG<br>TESTCLEARFLAG</td><td>&#24403;&#20110;&#21516;&#26102;&#25193;&#23637;&#20102;&#20004;&#20010;&#23439;&#65292;&#20063;&#21363;&#20004;&#20010;&#20989;&#25968;</td></tr><tr><td>SETPAGEFLAG_NOOP(uname)</td><td>SetPage##uname</td><td>&#31354;&#25805;&#20316;</td></tr><tr><td>CLEARPAGEFLAG_NOOP(uname)</td><td>ClearPage##unam</td><td>&#31354;&#25805;&#20316;</td></tr><tr><td>__CLEARPAGEFLAG_NOOP(uname)</td><td>__ClearPage##uname</td><td>&#31354;&#25805;&#20316;</td></tr><tr><td>TESTCLEARFLAG_FALSE(uname)</td><td>TestClearPage##uname</td><td>&#27704;&#36828;&#36820;&#22238;0</td></tr></tbody><tbody class="footnotes"><tr><td colspan="2"><div class="footnote"><p><sup>[<a name="ftn.idp81076444" href="#idp81076444" class="para">a</a>] </sup>&#20197;&#19978;&#19977;&#20010;&#23439;&#20998;&#21035;&#23545;&#24212;test_bit&#65292;set_bit&#21644;clear_bit&#65292;&#26159;&#21407;&#23376;&#25805;&#20316;&#65292;&#19982;&#23427;&#20204;&#23545;&#24212;&#30340;&#26159;&#26377;&#19977;&#20010;&#24320;&#22836;<br>&#20026;&#19979;&#21010;&#32447;&#30340;&#21516;&#21517;&#20989;&#25968;__SETPAGEFLAG&#31561;&#19982;&#23427;&#20204;&#30456;&#23545;&#24212;&#65292;&#20294;&#19981;&#26159;&#21407;&#23376;&#25805;&#20316;&#65292;&#36825;&#37324;&#19981;&#20877;&#21015;&#20986;&#12290;</p></div><div class="footnote"><p><sup>[<a name="ftn.idp81078892" href="#idp81078892" class="para">b</a>] </sup>&#19982;&#27492;&#23545;&#24212;&#20063;&#26377;__PAGEFLAG&#30340;&#23439;&#23384;&#22312;&#12290;</p></div></td></tr></tbody></table>
</div></div><br class="table-break">
flags&#23454;&#38469;&#19978;&#20026;&#20004;&#37096;&#20998;&#65306;&#26631;&#24535;&#21306;(Flags Area)&#20174;&#26368;&#20302;&#22788;&#21521;&#19978;&#25193;&#23637;&#21040;&#31532;__NR_PAGEFLAGS&#20301;;&#23383;&#27573;&#21306;(Fields Area)&#21017;&#20174;&#26368;&#39640;&#20301;&#21521;&#20302;&#20301;&#25193;&#23637;&#12290;&#23383;&#27573;&#21306;&#29992;&#26469;&#23454;&#29616;&#31649;&#29702;&#21306;&#65292;&#20869;&#23384;&#33410;&#28857;&#21644;&#31232;&#30095;&#20869;&#23384;&#30340;&#26144;&#23556;&#12290;
<pre class="programlisting">
   | FIELD | ... | FLAGS |
   N-1           ^       0
                (__NR_PAGEFLAGS)
</pre>
_count&#24341;&#29992;&#35745;&#25968;&#19981;&#24212;&#34987;&#30452;&#25509;&#24341;&#29992;&#65292;&#20869;&#26680;&#25552;&#20379;&#20102;&#19968;&#31995;&#21015;&#30340;&#20869;&#32852;&#20989;&#25968;&#26469;&#25805;&#20316;&#23427;&#65292;&#36890;&#24120;&#23427;&#20204;&#34987;&#23450;&#20041;&#22312;include/linux/mm.h&#20013;&#12290;
	<div class="table"><a name="idp81084436"></a><p class="title"><b>&#34920; 22. &#39029;&#24341;&#29992;&#35745;&#25968;&#20989;&#25968;</b></p><div class="table-contents">
	<table summary="&#39029;&#24341;&#29992;&#35745;&#25968;&#20989;&#25968;" border="1"><colgroup><col><col></colgroup><thead><tr><th>&#20989;&#25968;&#21517;</th><th>&#29992;&#36884;</th></tr></thead><tbody><tr><td>page_count</td><td>&#35835;&#21462;&#24341;&#29992;&#35745;&#25968;</td></tr><tr><td>get_page</td><td>&#24341;&#29992;&#35745;&#25968;&#21152;1</td></tr><tr><td>init_page_count</td><td>&#21021;&#22987;&#21270;&#24341;&#29992;&#35745;&#25968;&#20026;1</td></tr></tbody></table>
	</div></div><br class="table-break">
_mapcount&#19982;_count&#24341;&#29992;&#35745;&#25968;&#31867;&#20284;&#65292;&#19981;&#24212;&#34987;&#30452;&#25509;&#24341;&#29992;&#65292;&#20869;&#26680;&#25552;&#20379;&#20102;&#19968;&#31995;&#21015;&#30340;&#20869;&#32852;&#20989;&#25968;&#26469;&#25805;&#20316;&#23427;&#65292;&#23427;&#20204;&#20063;&#34987;&#23450;&#20041;&#22312;include/linux/mm.h&#20013;&#12290;
	<div class="table"><a name="idp81087436"></a><p class="title"><b>&#34920; 23. &#39029;&#24341;&#29992;&#35745;&#25968;&#20989;&#25968;</b></p><div class="table-contents">
	<table summary="&#39029;&#24341;&#29992;&#35745;&#25968;&#20989;&#25968;" border="1"><colgroup><col><col></colgroup><thead><tr><th>&#20989;&#25968;&#21517;</th><th>&#29992;&#36884;</th></tr></thead><tbody><tr><td>reset_page_mapcount</td><td>&#21021;&#22987;&#21270;&#24341;&#29992;&#35745;&#25968;&#20026;-1<sup>[<a name="idp81089092" href="#ftn.idp81089092" class="footnote">a</a>]</sup></td></tr><tr><td>page_mapcount</td><td>&#35835;&#21462;&#24341;&#29992;&#35745;&#25968;&#24182;&#21152;1&#30340;&#20540;</td></tr><tr><td>page_mapped</td><td>&#35813;&#20989;&#25968;&#26681;&#25454;&#24341;&#29992;&#35745;&#25968;&#20540;&#26159;&#21542;&#22823;&#20110;&#31561;&#20110;0&#65292;&#21028;&#26029;&#35813;&#39029;&#26694;&#26159;&#21542;&#34987;&#26144;&#23556;&#12290;</td></tr></tbody><tbody class="footnotes"><tr><td colspan="2"><div class="footnote"><p><sup>[<a name="ftn.idp81089092" href="#idp81089092" class="para">a</a>] </sup>
	&#27809;&#26377;&#21021;&#22987;&#21270;&#20026;0&#26159;&#22240;&#20026;atomic_inc_and_test&#21644;atomic_add_negative&#30340;&#25805;&#20316;&#65292;&#23545;&#35813;&#24341;&#29992;&#35745;&#25968;&#30340;&#21152;&#20943;&#26159;&#30001;&#36825;&#20004;&#20010;&#20989;&#25968;&#23436;&#25104;&#30340;&#12290;</p></div></td></tr></tbody></table>
	</div></div><br class="table-break">
<pre class="programlisting">
	union {
	    struct {
		unsigned long private;		/* Mapping-private opaque data:
					 	 * usually used for buffer_heads
						 * if PagePrivate set; used for
						 * swp_entry_t if PageSwapCache;
						 * indicates order in the buddy
						 * system if PG_buddy is set.
						 */
		struct address_space *mapping;	/* If low bit clear, points to
						 * inode address_space, or NULL.
						 * If page mapped as anonymous
						 * memory, low bit is set, and
						 * it points to anon_vma object:
						 * see PAGE_MAPPING_ANON below.
						 */
	    };
#if USE_SPLIT_PTLOCKS
	    spinlock_t ptl;
#endif
	    struct kmem_cache *slab;	/* SLUB: Pointer to slab */
	    struct page *first_page;	/* Compound tail pages */
	};
	union {
		pgoff_t index;		/* Our offset within mapping. */
		void *freelist;		/* SLUB: freelist req. slab lock */
	};
	struct list_head lru;		/* Pageout list, eg. active_list
</pre>
<p>
&#30001;&#20110;&#20869;&#26680;&#24341;&#20837;&#20102;&#24456;&#22810;&#30340;&#20998;&#37197;&#26426;&#21046;&#65292;&#20197;&#24448;&#38388;&#31616;&#21333;&#30340;page&#32467;&#26500;&#21464;&#24471;&#36234;&#26469;&#36234;&#22797;&#26434;&#12290;&#20026;&#20102;&#26080;&#32541;&#24341;&#20837;slub&#20998;&#37197;&#22120;&#26469;&#20998;&#37197;&#23567;&#20110;1&#20010;&#39029;&#38754;&#30340;&#20869;&#23384;&#65292;&#36825;&#37324;&#20351;&#29992;&#20849;&#29992;&#20307;&#23558;slab&#25351;&#38024;&#21644;&#22797;&#21512;&#39029;&#30340;&#39318;&#39029;&#25351;&#38024;&#19982;private&#21644;mapping&#20844;&#29992;&#23384;&#20648;&#31354;&#38388;&#12290;private&#30340;&#29992;&#36884;&#19982;flags&#26631;&#24535;&#20301;&#24687;&#24687;&#30456;&#20851;&#12290;&#22914;&#26524;&#35774;&#32622;&#20102;PG_private&#65292;&#37027;&#20040;&#23427;&#34987;&#29992;&#20110;buffer_heads;&#22914;&#26524;&#35774;&#32622;&#20102;PG_swapcache&#65292;&#37027;&#20040;&#29992;&#20110;swp_entry_t;&#22914;&#26524;&#35774;&#32622;&#20102;PG_buddy&#65292;&#21017;&#29992;&#20110;&#20249;&#20276;&#31995;&#32479;&#20013;&#30340;&#38454;(Order)&#12290;
</p>
<p>
&#20869;&#26680;&#21487;&#20197;&#23558;&#22810;&#20010;&#30456;&#37051;&#30340;&#39029;&#26694;&#21512;&#24182;&#20026;&#22797;&#21512;&#39029;(Compound Page)&#12290;&#20998;&#32452;&#20013;&#30340;&#31532;&#19968;&#20010;&#20063;&#25104;&#20026;&#39318;&#39029;(Head Page)&#65292;&#32780;&#25152;&#26377;&#20854;&#20313;&#21508;&#39029;&#21483;&#20570;&#23614;&#39029;(Tail Page)&#12290;&#25152;&#26377;&#23614;&#39029;&#23545;&#24212;&#30340;&#31649;&#29702;page&#25968;&#25454;&#32467;&#26500;&#37117;&#23558;first_page&#25351;&#21521;&#39318;&#39029;&#12290;
</p>
<p>
mapping&#25351;&#23450;&#20102;&#39029;&#26694;&#25152;&#22312;&#30340;&#22320;&#22336;&#31354;&#38388;&#12290;index&#26159;&#39029;&#26694;&#22312;mapping&#26144;&#23556;&#20869;&#37096;&#30340;&#20559;&#31227;&#37327;&#12290;mapping&#25351;&#38024;&#36890;&#24120;&#26159;&#23545;&#40784;&#21040;sizeof(long)&#30340;&#65292;&#36825;&#20445;&#35777;&#23427;&#30340;&#26368;&#20302;&#20301;&#20026;0&#65292;&#20294;&#26159;&#23427;&#24182;&#24635;&#26159;&#22914;&#27492;&#12290;&#21487;&#20197;&#26377;&#20197;&#19979;&#20004;&#31181;&#21487;&#33021;&#65306;
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">address_space&#30340;&#23454;&#20363;</li><li class="listitem">&#24403;&#26368;&#20302;&#20301;&#20026;1&#26102;&#65292;&#25351;&#21521;anon_vma&#30340;&#23454;&#20363;&#65292;&#27492;&#26102;&#23436;&#25104;&#21311;&#21517;&#39029;&#30340;&#36870;&#21521;&#26144;&#23556;&#12290;</li></ul></div><p>
lru&#26159;&#19968;&#20010;&#34920;&#22836;&#65292;&#29992;&#20110;&#22312;&#21508;&#31181;&#37327;&#34920;&#19978;&#32500;&#25252;&#35813;&#39029;&#26694;&#65292;&#20197;&#20415;&#23558;&#23427;&#25353;&#19981;&#21516;&#31867;&#21035;&#20998;&#32452;&#65292;&#26368;&#37325;&#35201;&#30340;&#23601;&#26159;zone-&gt;lru_lock&#20445;&#25252;&#30340;&#27963;&#21160;&#39029;&#26694;(active_list)&#21644;&#19981;&#27963;&#21160;&#39029;&#26694;&#12290;
</p>
<pre class="programlisting">
#if defined(WANT_PAGE_VIRTUAL)
	void *virtual;			/* Kernel virtual address (NULL if
					   not kmapped, ie. highmem) */
#endif /* WANT_PAGE_VIRTUAL */
};
</pre>
WANT_PAGE_VIRTUAL&#26159;&#30001;&#26159;&#21542;&#38656;&#35201;&#39640;&#31471;&#20869;&#23384;&#20915;&#23450;&#30340;&#65292;virtual&#29992;&#20110;&#23547;&#22336;&#39640;&#31471;&#20869;&#23384;&#21306;&#22495;&#20013;&#30340;&#39029;&#26694;&#65292;&#23384;&#20648;&#35813;&#39029;&#30340;&#34394;&#25311;&#22320;&#22336;&#12290;&#26377;&#20123;&#26102;&#20505;&#39640;&#31471;&#20869;&#23384;&#24182;&#19981;&#26144;&#23556;&#21040;&#20219;&#20309;&#23454;&#38469;&#30340;&#29289;&#29702;&#22320;&#22336;&#39029;&#26694;&#19978;&#65292;&#27492;&#26102;&#23427;&#30340;&#20540;&#20026;NULL&#12290;
</div>
<div class="sect2" title="13.3. bootmem_free_node"><div class="titlepage"><div><div><h3 class="title"><a name="idp81069284"></a>13.3. bootmem_free_node</h3></div></div></div>
&#22312;bootmem_init_node&#20989;&#25968;&#20013;&#65292;&#26681;&#25454;struct meminfo&#21442;&#25968;&#26469;&#21021;&#22987;&#21270;&#20869;&#23384;&#33410;&#28857;&#23545;&#24212;&#30340;pg_data_t&#25968;&#25454;&#32467;&#26500;contig_page_data&#65292;&#24182;&#19988;&#30003;&#35831;Bootmem&#26426;&#21046;&#20351;&#29992;&#30340;bitmap&#12290;&#20174;&#35813;&#20989;&#25968;&#20351;&#29992;&#30340;&#21442;&#25968;&#26469;&#30475;&#65292;&#19968;&#20010;&#20869;&#23384;&#33410;&#28857;&#23545;&#24212;&#19968;&#20010;struct meminfo&#30340;&#20869;&#23384;&#22359;&#20449;&#24687;&#12290;&#25152;&#20197;&#19968;&#20010;&#20869;&#23384;&#33410;&#28857;&#26377;&#21487;&#33021;&#23545;&#24212;&#22810;&#20010;membank&#65292;&#32780;&#36825;&#20123;membank&#30340;&#29289;&#29702;&#22320;&#22336;&#21487;&#33021;&#26159;&#19981;&#36830;&#32493;&#30340;&#65292;&#36825;&#23601;&#26159;&#20869;&#23384;&#23380;&#27934;&#30340;&#23384;&#22312;&#30340;&#21407;&#22240;&#12290;contig_page_data&#25104;&#21592;&#20013;&#30340;bdata-&gt;node_min_pfn&#21644;bdata-&gt;node_low_pfn&#21442;&#25968;&#20998;&#21035;&#35760;&#24405;&#20102;&#25152;&#26377;&#20869;&#23384;&#22359;&#20013;&#30340;&#26368;&#20302;&#29289;&#29702;&#39029;&#26694;&#22320;&#22336;&#21644;&#26368;&#39640;&#29289;&#29702;&#39029;&#26694;&#22320;&#22336;&#12290;
<pre class="programlisting">
arch/arm/include/asm/setup.h
struct membank {
        unsigned long start;
        unsigned long size;
        int           node;
};

struct meminfo {
        int nr_banks;
        struct membank bank[NR_BANKS];
};

static unsigned long __init bootmem_init_node(int node, struct meminfo *mi);
</pre>
bootmem_free_node&#19982;bootmem_init_node&#21442;&#25968;&#31867;&#20284;&#65292;&#23427;&#29992;&#26469;&#21021;&#22987;&#21270;&#29305;&#23450;&#20869;&#23384;&#33410;&#28857;&#30340;&#31649;&#29702;&#21306;&#20449;&#24687;&#12290;
<pre class="programlisting">
arch/arm/mm/init.c
static void __init bootmem_free_node(int node, struct meminfo *mi);
</pre>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">&#23613;&#31649;&#23616;&#37096;zone_size&#21644;zhole_size&#22768;&#26126;&#20026;&#22823;&#23567;&#20026;MAX_NR_ZONES&#30340;&#25968;&#32452;&#65292;&#20294;&#26159;&#21482;&#29992;&#21040;&#20102;&#20854;&#20013;&#30340;&#31532;&#19968;&#20010;&#20803;&#32032;&#12290;&#36825;&#26159;&#30001;&#20110;ARM Linux&#37319;&#29992;&#20102;UMA&#26041;&#24335;&#30340;&#20869;&#23384;&#31649;&#29702;&#26426;&#21046;&#12290;</li><li class="listitem">zone_size[0]&#34987;&#36171;&#20540;&#20026;end_pfn - start_pfn&#65292;&#28982;&#21518;&#26681;&#25454;zone_size&#20943;&#21435;meminfo&#20013;&#27599;&#20010;membank&#20013;&#30495;&#27491;&#30340;size&#24471;&#21040;&#20869;&#23384;&#23380;&#27934;&#30340;&#22823;&#23567;zhole_size[0]&#12290;</li><li class="listitem">&#36890;&#36807;arch_adjust_zones&#20026;&#29305;&#23450;&#26550;&#26500;&#30340;&#31995;&#32479;&#39044;&#30041;&#20869;&#23384;&#12290;&#36890;&#24120;&#29992;&#23427;&#26469;&#20026;&#29305;&#23450;&#30340;&#38480;&#21046;&#30340;DMA&#23547;&#22336;&#39044;&#30041;&#20869;&#23384;&#65292;&#23558;&#36825;&#20123;DMA&#26080;&#27861;&#35775;&#38382;&#30340;&#20869;&#23384;&#25918;&#20837;zone[1]&#65292;&#32780;DMA&#23545;&#24212;zone[0]&#65292;&#36890;&#24120;DMA&#21487;&#20197;&#23547;&#22336;&#25152;&#26377;&#20869;&#23384;&#12290;</li><li class="listitem">&#26368;&#21518;&#35843;&#29992;free_area_init_node&#21021;&#22987;&#21270;&#33410;&#28857;&#23545;&#24212;&#30340;pg_data_t&#25551;&#36848;&#31526;&#20449;&#24687;&#65292;&#24182;&#19988;&#20026;&#27599;&#20010;&#39029;&#34920;&#20998;&#37197;struct page&#32467;&#26500;&#12290;</li></ul></div>
<pre class="programlisting">
#define arch_adjust_zones(node,size,holes) do { } while (0)
</pre>
<div class="figure"><a name="idp81099444"></a><p class="title"><b>&#22270; 73. bootmem_free_node&#35843;&#29992;&#27969;&#31243;</b></p><div class="figure-contents"><div><img src="images/pg_call1.gif" alt="bootmem_free_node&#35843;&#29992;&#27969;&#31243;"></div></div></div><br class="figure-break">
</div>
<div class="sect2" title="13.4. free_area_init_node"><div class="titlepage"><div><div><h3 class="title"><a name="idp81100092"></a>13.4. free_area_init_node</h3></div></div></div>
<pre class="programlisting">
mm/page_alloc.c
void __paginginit free_area_init_node(int nid, unsigned long *zones_size,
                unsigned long node_start_pfn, unsigned long *zholes_size)
</pre>
free_area_init_node&#30340;&#20989;&#25968;&#21442;&#25968;&#35299;&#37322;&#22914;&#19979;&#65306;
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">nid&#65292;&#33410;&#28857;ID&#21495;&#12290;</li><li class="listitem">zones_size&#65292;&#22823;&#23567;&#20026;MAX_NR_ZONES&#30340;&#25968;&#32452;&#65292;&#29992;&#26469;&#35760;&#24405;&#24403;&#21069;&#20869;&#23384;&#33410;&#28857;&#20013;&#30340;&#20869;&#23384;&#39029;&#26694;&#25968;&#65292;&#21253;&#21547;&#23380;&#27934;&#12290;</li><li class="listitem">node_start_pfn&#65292;&#24403;&#21069;&#20869;&#23384;&#33410;&#28857;&#20013;&#30340;&#36215;&#22987;&#20869;&#23384;&#39029;&#26694;&#12290;</li><li class="listitem">zholes_size&#65292;&#22823;&#23567;&#20026;MAX_NR_ZONES&#30340;&#25968;&#32452;&#65292;&#29992;&#26469;&#35760;&#24405;&#24403;&#21069;&#20869;&#23384;&#33410;&#28857;&#20013;&#30340;&#20869;&#23384;&#23380;&#27934;&#39029;&#26694;&#25968;&#12290;</li></ul></div>
free_area_init_node&#23436;&#25104;&#20197;&#19979;&#21151;&#33021;&#65306;
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">&#26681;&#25454;&#21442;&#25968;nid&#65292;&#30830;&#23450;&#35813;&#33410;&#28857;&#23545;&#24212;&#30340;pgdat&#65292;&#24182;&#21021;&#22987;&#21270;&#25104;&#21592;node_id = nid&#12290;</li><li class="listitem">pgdat-&gt;node_start_pfn = node_start_pfn&#12290;</li><li class="listitem">&#36890;&#36807;calculate_node_totalpages&#20989;&#25968;&#65292;&#35745;&#31639;pgdat-&gt;node_spanned_pages(&#21253;&#21547;&#23380;&#27934;)&#21644;pgdat-&gt;node_present_pages(&#19981;&#21547;&#23380;&#27934;)&#12290;</li><li class="listitem">&#27599;&#19968;&#20010;&#29289;&#29702;&#39029;&#26694;&#23545;&#24212;&#19968;&#20010;struct page&#32467;&#26500;&#65292;&#36890;&#36807;alloc_node_mem_map&#20026;&#25152;&#26377;&#30340;&#29289;&#29702;&#39029;&#38754;&#20998;&#37197;&#35813;&#32467;&#26500;&#20307;&#31354;&#38388;&#65292;&#24182;&#23558;&#36215;&#22987;&#39029;&#26694;&#22320;&#22336;&#20445;&#23384;&#22312;pgdat-&gt;node_mem_map&#20013;&#12290;</li><li class="listitem">&#35843;&#29992;free_area_init_core&#65292;&#29992;&#26469;&#21021;&#22987;&#21270;&#20869;&#23384;&#31649;&#29702;&#21306;zone&#12290;</li></ul></div>
</div>
<div class="sect2" title="13.5. free_area_init_core"><div class="titlepage"><div><div><h3 class="title"><a name="idp81104308"></a>13.5. free_area_init_core</h3></div></div></div>
<pre class="programlisting">
mm/page_alloc.c
/*
 * Set up the zone data structures:
 *   - mark all pages reserved
 *   - mark all memory queues empty
 *   - clear the memory bitmaps
 */
static void __paginginit free_area_init_core(struct pglist_data *pgdat,
		unsigned long *zones_size, unsigned long *zholes_size);
</pre>
free_area_init_core&#30340;&#20989;&#25968;&#21442;&#25968;&#35299;&#37322;&#22914;&#19979;&#65306;
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">pgdat&#65292;&#20869;&#23384;&#33410;&#28857;&#23545;&#24212;&#30340;pgdat_t&#31867;&#22411;&#25551;&#36848;&#31526;&#12290;</li><li class="listitem">zones_size&#65292;&#22823;&#23567;&#20026;MAX_NR_ZONES&#30340;&#25968;&#32452;&#65292;&#29992;&#26469;&#35760;&#24405;&#24403;&#21069;&#20869;&#23384;&#33410;&#28857;&#20013;&#30340;&#20869;&#23384;&#39029;&#26694;&#25968;&#65292;&#21253;&#21547;&#23380;&#27934;&#12290;</li><li class="listitem">zholes_size&#65292;&#22823;&#23567;&#20026;MAX_NR_ZONES&#30340;&#25968;&#32452;&#65292;&#29992;&#26469;&#35760;&#24405;&#24403;&#21069;&#20869;&#23384;&#33410;&#28857;&#20013;&#30340;&#20869;&#23384;&#23380;&#27934;&#39029;&#26694;&#25968;&#12290;</li></ul></div>
free_area_init_core&#38024;&#23545;&#21333;&#20010;&#20869;&#23384;&#33410;&#28857;&#20869;&#30340;&#25152;&#26377;&#31649;&#29702;&#21306;&#36827;&#34892;&#21021;&#22987;&#21270;&#65292;&#24182;&#35745;&#31639;&#31649;&#29702;&#20869;&#23384;&#39029;&#25152;&#29992;&#30340;struct page&#25968;&#32452;&#21344;&#29992;&#30340;memmap_pages&#12290;
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">&#36890;&#36807;pgdat_resize_init&#20989;&#25968;&#21021;&#22987;&#21270;pgdat&#33258;&#26059;&#38145;&#25104;&#21592;node_size_lock&#65292;&#23427;&#19982;CONFIG_MEMORY_HOTPLUG(&#20869;&#23384;&#28909;&#25554;&#25300;)&#26377;&#20851;&#12290;</li><li class="listitem">&#21021;&#22987;&#21270;pgdat-&gt;nr_zones&#20026;0&#12290;</li><li class="listitem">&#36890;&#36807;init_waitqueue_head&#20989;&#25968;&#21021;&#22987;&#21270;pgdat-&gt;kswapd_wait&#65292;&#23427;&#26159;kswapd&#39029;&#25442;&#20986;&#23432;&#25252;&#36827;&#31243;&#20351;&#29992;&#30340;&#31561;&#24453;&#38431;&#21015;&#12290;</li><li class="listitem">&#21021;&#22987;&#21270;pgdat-&gt;kswapd_max_order&#20026;0&#12290;</li><li class="listitem">&#36890;&#36807;pgdat_page_cgroup_init&#20989;&#25968;&#21021;&#22987;&#21270;pgdat-&gt;node_page_cgroup&#20026;NULL&#65292;&#22914;&#26524;&#27809;&#26377;&#25171;&#24320;CONFIG_CGROUP_MEM_RES_CTLR&#36873;&#39033;&#65292;&#21017;&#20026;&#31354;&#20989;&#25968;&#12290;</li></ul></div>
&#25509;&#19979;&#26469;&#36941;&#21382;&#20869;&#23384;&#33410;&#28857;&#20013;&#30340;&#25152;&#26377;&#31649;&#29702;&#21306;&#65292;&#23436;&#25104;&#20197;&#19979;&#24037;&#20316;&#65306;
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">&#35745;&#31639;&#21547;&#26377;&#23380;&#27934;&#30340;&#39029;&#38754;&#24635;&#25968;&#23384;&#20837;size&#65292;&#21516;&#26102;zone-&gt;spanned_pages&#35760;&#24405;&#35813;&#20540;&#12290;</li><li class="listitem">&#35745;&#31639;&#19981;&#21547;&#23380;&#27934;&#30340;&#39029;&#38754;&#24635;&#25968;&#23384;&#20837;realsize&#12290;</li><li class="listitem">&#26681;&#25454;size&#21464;&#37327;&#35745;&#31639;&#39029;&#38754;&#25968;&#32452;&#25152;&#21344;&#29992;&#30340;&#39029;&#38754;&#25968;&#65292;&#23384;&#20837;memmap_pages&#12290;&#20043;&#25152;&#20197;&#19981;&#20351;&#29992;realsize&#65292;&#26159;&#22240;&#20026;&#22312;&#36890;&#36807;alloc_node_mem_map&#20989;&#25968;&#26469;&#20998;&#37197;&#39029;&#38754;&#31649;&#29702;&#25968;&#32452;&#26102;&#37319;&#29992;&#30340;&#21547;&#26377;&#23380;&#27934;&#30340;&#39029;&#38754;&#25968;&#65292;&#36825;&#26159;&#20026;&#20102;&#31649;&#29702;&#26041;&#20415;&#65292;&#20294;&#26159;&#22312;&#26377;&#22823;&#37327;&#23380;&#27934;&#30340;&#20869;&#23384;&#33410;&#28857;&#20013;&#65292;&#36825;&#26679;&#20250;&#28010;&#36153;&#22823;&#37327;struct page&#39029;&#38754;&#31649;&#29702;&#32467;&#26500;&#65292;&#25152;&#20197;&#36890;&#24120;&#20250;&#20351;&#33021;&#20869;&#23384;&#30340;CONFIG_DISCONTIGMEM&#36873;&#39033;&#12290;</li><li class="listitem">&#22914;&#26524;&#22788;&#29702;&#31649;&#29702;&#21306;&#26159;DMA&#21306;&#65292;&#37027;&#20040;&#23558;&#22312;realsize&#20013;&#20877;&#27425;&#20026;DMA&#39044;&#30041;&#20869;&#23384;&#12290;&#20063;&#21363;realsize&#20877;&#27425;&#20943;&#21435;dma_reserve&#12290;</li><li class="listitem">&#23558;realsize&#20943;&#21435;&#39029;&#38754;&#26144;&#23556;&#20351;&#29992;&#30340;&#39029;&#38754;&#22823;&#23567;memmap_pages&#24182;&#23384;&#20837;zone-&gt;present_pages&#12290;</li><li class="listitem">&#36890;&#36807;is_highmem_idx&#21028;&#26029;&#24403;&#21069;&#20869;&#23384;&#21306;&#26159;&#21542;&#20026;&#39640;&#31471;&#20869;&#23384;&#65292;&#22914;&#26524;&#19981;&#26159;&#65292;&#37027;&#20040;&#23558;realsize&#35745;&#20837;&#20869;&#26680;&#20840;&#23616;&#32479;&#35745;&#20449;&#24687;nr_kernel_pages&#65292;&#23427;&#25551;&#36848;&#20102;&#20869;&#26680;&#25152;&#26377;&#21487;&#20197;&#19968;&#19968;&#26144;&#23556;&#30340;&#39029;&#12290;</li><li class="listitem">&#23558;realsize&#35745;&#20837;nr_all_pages&#65292;&#19982;nr_kernel_pages&#31867;&#20284;&#65292;&#23427;&#36824;&#35760;&#24405;&#20102;&#39640;&#31471;&#20869;&#23384;&#39029;&#12290;</li><li class="listitem">&#22914;&#26524;&#23450;&#20041;&#20102;CONFIG_NUMA&#65292;&#21017;&#21021;&#22987;&#21270;&#31649;&#29702;&#21306;&#20013;&#30340;node&#65292;min_unmapped_pages&#21644;min_slab_pages&#25104;&#21592;&#12290;</li><li class="listitem">&#20026;zone-&gt;name&#36171;&#20540;&#65292;&#23427;&#25351;&#21521;zone_names&#25968;&#32452;&#20013;&#23545;&#24212;&#30340;&#24403;&#21069;&#31649;&#29702;&#21306;&#30340;&#20540;</li><li class="listitem">&#20351;&#29992;spin_lock_init&#21021;&#22987;&#21270;&#31649;&#29702;&#21306;&#20013;&#30340;lock&#21644;lru_lock&#33258;&#26059;&#38145;&#12290;</li><li class="listitem">&#22914;&#26524;&#37197;&#32622;&#20102;CONFIG_MEMORY_HOTPLUG&#65292;&#37027;&#20040;&#21021;&#22987;&#21270;&#33258;&#26059;&#38145;span_seqlock&#12290;&#19982;lock&#21644;lru_lock&#19981;&#21516;&#65292;&#23427;&#36890;&#36807;seqlock_init&#20989;&#25968;&#23436;&#25104;&#21021;&#22987;&#21270;&#12290;</li><li class="listitem">&#35774;&#32622;prev_priority&#20026;DEF_PRIORITY&#12290;</li><li class="listitem">&#21021;&#22987;&#21270;&#31649;&#29702;&#21306;&#20013;&#30340;&#22238;&#35843;&#25351;&#38024;zone_pgdat&#65292;&#26174;&#28982;&#23427;&#25351;&#21521;&#35813;&#21306;&#25152;&#23646;&#30340;&#20869;&#23384;&#33410;&#28857;&#31867;&#22411;pgdat&#25351;&#38024;&#12290;</li><li class="listitem">zone_pcp_init&#21021;&#22987;&#21270;&#31649;&#29702;&#21306;&#30340;per-CPU&#32531;&#23384;&#12290;</li><li class="listitem">&#21021;&#22987;&#21270;lru&#25104;&#21592;&#12290;</li><li class="listitem">&#21021;&#22987;&#21270;recent_rotated&#21644;recent_scanned&#25104;0&#12290;</li><li class="listitem">&#36890;&#36807;&#20989;&#25968;zap_zone_vm_stats&#21021;&#22987;&#21270;vm_stat&#25104;&#21592;&#20026;0&#12290;</li><li class="listitem">&#21021;&#22987;&#21270;flags&#25104;&#21592;&#20026;0&#12290; </li><li class="listitem">&#22914;&#26524;&#25171;&#24320;&#20102;CONFIG_HUGETLB_PAGE_SIZE_VARIABLE&#36873;&#39033;&#65292;&#21017;&#36890;&#36807;pageblock_default_order&#20989;&#25968;&#33719;&#21462;&#40664;&#35748;&#20540;&#24182;&#35774;&#32622;&#32473;&#20840;&#23616;&#21464;&#37327;pageblock_order&#65292;&#21542;&#21017;&#40664;&#35748;&#20540;&#20026;MAX_ORDER-1&#12290;&#23427;&#34987;&#29992;&#22312;&#20249;&#20276;&#31995;&#32479;&#20013;&#12290;</li><li class="listitem">setup_usemap&#35774;&#32622;pageblock_flags&#20026;NULL&#12290;&#22914;&#26524;&#35813;&#21306;&#21253;&#21547;&#30340;&#39029;&#26694;&#25968;&#28385;&#36275;&#35201;&#27714;&#65292;&#37027;&#20040;&#20026;pageblock_flags&#20998;&#37197;&#20869;&#23384;&#24182;&#21021;&#22987;&#21270;&#20026;0&#12290;pageblock_flags&#19982;&#20249;&#20276;&#31995;&#32479;&#30340;&#30862;&#29255;&#36801;&#31227;&#31639;&#27861;&#26377;&#20851;&#12290;</li><li class="listitem">init_currently_empty_zone&#21021;&#22987;&#21270;&#20249;&#20276;&#31995;&#32479;&#30340;free_area&#21015;&#34920;&#12290;</li><li class="listitem">&#26368;&#21518;&#36890;&#36807;memmap_init&#23439;&#38388;&#25509;&#24341;&#29992;&#20989;&#25968;memmap_init_zone&#23558;&#23646;&#20110;&#35813;&#31649;&#29702;&#21306;&#30340;&#25152;&#26377;page&#25968;&#32452;&#37117;&#35774;&#32622;&#20026;&#21021;&#22987;&#40664;&#35748;&#20540;&#12290;</li><li class="listitem">zone_start_pfn&#35760;&#24405;&#19979;&#19968;&#24490;&#29615;&#22788;&#29702;&#30340;&#31649;&#29702;&#21306;&#30340;&#24320;&#22987;&#39029;&#26694;&#22320;&#22336;&#12290;</li></ul></div>
</div>
<div class="sect2" title="13.6. memmap_init_zone"><div class="titlepage"><div><div><h3 class="title"><a name="idp81108444"></a>13.6. memmap_init_zone</h3></div></div></div>
<p>
memmap_init_zone&#20989;&#25968;&#21021;&#22987;&#21270;&#27599;&#20010;&#31649;&#29702;&#21306;&#20013;&#30340;&#39029;&#24103;&#23545;&#24212;&#30340;page&#25968;&#32452;&#12290;
</p><pre class="programlisting">
mm/page_alloc.c
#ifndef __HAVE_ARCH_MEMMAP_INIT
#define memmap_init(size, nid, zone, start_pfn) \
	memmap_init_zone((size), (nid), (zone), (start_pfn), MEMMAP_EARLY)
#endif

void __meminit memmap_init_zone(unsigned long size, int nid, unsigned long zone,
		unsigned long start_pfn, enum memmap_context context);
</pre><p>
mem_init_zone&#36890;&#36807;memmap_init&#23439;&#23454;&#29616;&#35843;&#29992;&#65292;&#30001;&#20110;&#19968;&#20123;&#29305;&#23450;&#30340;&#26550;&#26500;&#65292;&#31995;&#32479;&#20844;&#20849;&#30340;memmap&#21021;&#22987;&#21270;&#20989;&#25968;&#26080;&#27861;&#28385;&#36275;&#38656;&#27714;&#65292;&#27604;&#22914;IA64&#12290;&#27492;&#26102;&#22312;&#29305;&#23450;&#26550;&#26500;&#30340;&#20195;&#30721;&#20013;&#20250;&#23450;&#20041;memmap_init&#12290;memmap_init_zone&#39038;&#21517;&#24605;&#20041;&#65292;&#23427;&#26159;&#38024;&#23545;&#21333;&#20010;&#31649;&#29702;&#21306;&#23545;&#24212;&#30340;page&#25968;&#32452;&#26469;&#21021;&#22987;&#21270;&#30340;&#12290;
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">size&#25351;&#26126;&#20102;&#31649;&#29702;&#21306;&#30340;&#39029;&#24103;&#25968;&#65292;&#23427;&#21253;&#21547;&#23380;&#27934;&#12290;</li><li class="listitem">nid&#26159;&#24403;&#21069;&#31649;&#29702;&#21306;&#25152;&#23646;&#30340;&#20869;&#23384;&#33410;&#28857;&#30340;&#32534;&#21495;&#12290;</li><li class="listitem">zone&#25351;&#26126;&#20102;&#24403;&#21069;&#31649;&#29702;&#21306;&#22312;&#20869;&#23384;&#33410;&#28857;&#20013;node_zones&#25968;&#32452;&#19979;&#26631;&#12290;</li><li class="listitem">zone_start_pfn&#21017;&#25552;&#20379;&#20102;&#24403;&#21069;&#31649;&#29702;&#21306;&#30340;&#31532;&#19968;&#20010;&#39029;&#24103;&#30340;&#32534;&#21495;&#12290;</li><li class="listitem">context&#26159;&#20026;&#20102;&#25351;&#26126;&#24403;&#21069;&#26159;&#22312;&#31995;&#32479;&#21021;&#22987;&#21270;&#38454;&#27573;&#65292;&#36824;&#26159;&#28909;&#25554;&#25300;&#38454;&#27573;&#23545;&#20869;&#23384;&#31649;&#29702;&#39029;&#30340;&#21021;&#22987;&#21270;&#12290;&#23427;&#21482;&#26377;&#20004;&#20010;&#20540;&#65306;MEMMAP_EARLY&#21644;MEMMAP_HOTPLUG&#12290;</li></ul></div><p>
memmap_init_zone&#20381;&#27425;&#23436;&#25104;&#20102;&#20197;&#19979;&#21151;&#33021;&#65306;
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">&#36890;&#36807;end_pfn = start_pfn + size&#24471;&#21040;&#32456;&#27490;&#39029;&#24103;&#65292;&#28982;&#21518;&#20174;start_pfn&#21040;end_pfn&#36890;&#36807;&#24490;&#29615;&#19968;&#27425;&#22788;&#29702;&#23427;&#20204;&#23545;&#24212;&#30340;struct page&#12290;</li><li class="listitem">&#22914;&#26524;context&#25351;&#23450;&#30340;&#31995;&#32479;&#29366;&#24577;&#26159;MEMMAP_EARLY&#65292;&#21017;&#38656;&#35201;&#21028;&#26029;&#24403;&#21069;&#39029;&#24103;&#26159;&#21542;&#23384;&#22312;&#65292;&#36825;&#26159;&#22240;&#20026;&#20869;&#23384;&#23380;&#27934;&#30340;&#23384;&#22312;&#12290;<sup>[<a name="idp81120556" href="#ftn.idp81120556" class="footnote">9</a>]</sup>
	</li><li class="listitem">&#26681;&#25454;&#20844;&#24335;page = pfn_to_page(pfn)&#65292;&#30001;&#39029;&#24103;&#24471;&#21040;&#23427;&#23545;&#24212;&#30340;struct page&#31649;&#29702;&#39033;&#12290;</li><li class="listitem">&#35774;&#32622;page&#20013;flags&#25104;&#21592;&#30340;Field Area&#65292;&#23427;&#30001;&#27573;&#21306;&#65292;&#31649;&#29702;&#21306;&#21644;&#33410;&#28857;&#21306;&#19977;&#37096;&#20998;&#32452;&#25104;&#65292;&#20998;&#21035;&#21344;&#29992;&#30340;&#20301;&#25968;&#30001;SECTIONS_WIDTH&#65292;ZONES_WIDTH&#21644;NODES_WIDTH&#20998;&#21035;&#34920;&#31034;&#12290;set_page_links&#20989;&#25968;&#30340;&#20316;&#29992;&#23601;&#26159;&#20998;&#21035;&#36890;&#36807;set_page_zone&#65292;set_page_node&#21644;set_page_section&#20989;&#25968;&#26469;&#35774;&#32622;&#36825;&#20123;&#23383;&#27573;&#21306;&#12290;&#20197;&#21518;&#23601;&#21487;&#20197;&#26681;&#25454;&#36825;&#20123;&#21306;&#22495;&#33719;&#21462;&#24403;&#21069;&#39029;&#24103;&#30340;&#20301;&#32622;&#20449;&#24687;&#12290;</li><li class="listitem">mminit_verify_page_links&#29992;&#26469;&#39564;&#35777;set_page_links&#35774;&#32622;&#30340;&#20449;&#24687;&#26159;&#21542;&#27491;&#30830;&#12290;</li><li class="listitem">&#36890;&#36807;init_page_count&#23558;page-&gt;_count&#25104;&#21592;&#21021;&#22987;&#21270;&#20026;1&#12290;</li><li class="listitem">&#36890;&#36807;reset_page_mapcount&#23558;page-&gt;_mapcount&#25104;&#21592;&#21021;&#22987;&#21270;&#20026;-1&#12290;</li><li class="listitem">&#36890;&#36807;&#30001;&#23439;&#23450;&#20041;&#23637;&#24320;&#21518;&#30340;&#20989;&#25968;SetPageReserved&#35774;&#32622;PG_reserved&#26631;&#35760;&#21040;page-&gt;flags&#20013;&#12290;</li><li class="listitem">&#35774;&#32622;&#25152;&#26377;&#39029;&#38754;&#22343;&#20026;MIGRATE_MOVABLE&#30340;&#12290;</li><li class="listitem">&#21021;&#22987;&#21270;page-&gt;lru&#12290;</li><li class="listitem">&#22914;&#26524;&#37197;&#32622;&#20102;WANT_PAGE_VIRTUAL&#65292;&#19988;&#19981;&#20026;&#39640;&#31471;&#20869;&#23384;&#21017;&#21021;&#22987;&#21270;virtual&#25104;&#21592;&#12290;&#27604;&#22914;SPARC&#31995;&#32479;&#12290;</li></ul></div><p>
</p><pre class="programlisting">
include/asm-generic/memory_model.h
#if defined(CONFIG_FLATMEM)
#ifndef ARCH_PFN_OFFSET
#define ARCH_PFN_OFFSET         (0UL)
#endif
......
#define __pfn_to_page(pfn)      (mem_map + ((pfn) - ARCH_PFN_OFFSET))
#define __page_to_pfn(page)     ((unsigned long)((page) - mem_map) + \
                                 ARCH_PFN_OFFSET)
......
#ifdef CONFIG_OUT_OF_LINE_PFN_TO_PAGE
struct page;
/* this is useful when inlined pfn_to_page is too big */
extern struct page *pfn_to_page(unsigned long pfn);
extern unsigned long page_to_pfn(struct page *page);
#else
#define page_to_pfn __page_to_pfn
#define pfn_to_page __pfn_to_page
#endif /* CONFIG_OUT_OF_LINE_PFN_TO_PAGE */
</pre><p>
&#22312;struct page&#31649;&#29702;&#25968;&#32452;&#26159;&#32447;&#24615;&#20998;&#24067;&#30340;&#26102;&#20505;&#65292;pfn_to_page&#34987;&#32479;&#19968;&#23450;&#20041;&#20026;__pfn_to_page&#12290;&#24179;&#22374;&#20869;&#23384;&#20013;&#30340;ARCH_PFN_OFFSET&#34987;&#23450;&#20041;&#20026;0&#65292;&#32780;mem_map&#22312;alloc_node_mem_map&#20013;&#34987;&#36171;&#20540;&#20026;node_mem_map&#65292;&#20063;&#21363;&#31649;&#29702;&#25968;&#32452;&#30340;&#39318;&#22320;&#22336;&#12290;
</p>
page&#20013;flags&#25104;&#21592;&#30340;Field Area&#30001;&#19977;&#37096;&#20998;&#32452;&#25104;&#65292;&#23427;&#20204;&#20174;&#39640;&#22320;&#22336;&#20301;&#35813;&#26159;&#20381;&#27425;&#20998;&#24067;&#12290;&#27573;&#21306;&#21482;&#26377;&#22312;&#37197;&#32622;&#20102;CONFIG_SPARSEMEM&#26102;&#25165;&#26377;&#21487;&#33021;&#23384;&#22312;&#12290;
<pre class="programlisting">
/* .....
 *
 * No sparsemem or sparsemem vmemmap: |       NODE     | ZONE | ... | FLAGS |
 * classic sparse with space for node:| SECTION | NODE | ZONE | ... | FLAGS |
 * classic sparse no space for node:  | SECTION |     ZONE    | ... | FLAGS |
 */
</pre>
<p></p>
<p></p>
</div>
<div class="sect2" title="13.7. build_all_zonelists"><div class="titlepage"><div><div><h3 class="title"><a name="idp81126700"></a>13.7. build_all_zonelists</h3></div></div></div>
<p>
build_all_zonelists&#22312;init/main.c&#20013;&#30340;start_kernel&#20013;&#34987;&#35843;&#29992;&#65292;&#23427;&#29992;&#26469;&#21021;&#22987;&#21270;&#20869;&#23384;&#20998;&#37197;&#22120;&#20351;&#29992;&#30340;&#23384;&#20648;&#33410;&#28857;&#20013;&#30340;&#31649;&#29702;&#21306;&#38142;&#34920;&#12290;
</p><pre class="programlisting">
include/linux/kernel.h
extern enum system_states {
        SYSTEM_BOOTING,
        SYSTEM_RUNNING,
        SYSTEM_HALT,
        SYSTEM_POWER_OFF,
        SYSTEM_RESTART,
        SYSTEM_SUSPEND_DISK,
} system_state;

mm/page_alloc.c

void build_all_zonelists(void)
{
	set_zonelist_order();

	if (system_state == SYSTEM_BOOTING) {
		__build_all_zonelists(NULL);
		mminit_verify_zonelist();
		cpuset_init_current_mems_allowed();
	} else {
		/* we have to stop all cpus to guarantee there is no user
		   of zonelist */
		stop_machine(__build_all_zonelists, NULL, NULL);
		/* cpuset refresh routine should be here */
	}
	vm_total_pages = nr_free_pagecache_pages();

	if (vm_total_pages &lt; (pageblock_nr_pages * MIGRATE_TYPES))
		page_group_by_mobility_disabled = 1;
	else
		page_group_by_mobility_disabled = 0;

	printk("Built %i zonelists in %s order, mobility grouping %s.  "
		"Total pages: %ld\n",
			num_online_nodes(),
			zonelist_order_name[current_zonelist_order],
			page_group_by_mobility_disabled ? "off" : "on",
			vm_total_pages);
}
</pre><p>
build_all_zonelists&#20381;&#27425;&#23436;&#25104;&#20197;&#19979;&#21151;&#33021;&#65306;
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">&#26681;&#25454;system_state&#26597;&#30475;&#31995;&#32479;&#30340;&#36816;&#34892;&#29366;&#24577;&#65292;&#22312;&#20869;&#26680;&#21551;&#21160;&#38454;&#27573;&#65292;&#23427;&#30340;&#20540;&#20445;&#25345;&#20026;0&#65292;&#20063;&#21363;SYSTEM_BOOTING&#65292;&#21482;&#26377;&#22312;start_kernel&#25191;&#34892;&#21040;&#26368;&#21518;&#19968;&#20010;&#20989;&#25968;rest_init&#21518;&#65292;&#25165;&#20250;&#36827;&#20837;SYSTEM_RUNNING&#38454;&#27573;&#12290;&#22914;&#26524;&#20026;&#20869;&#26680;&#21551;&#21160;&#38454;&#27573;&#65292;&#37027;&#20040;&#35843;&#29992;__build_all_zonelists&#21021;&#22987;&#21270;&#20998;&#37197;&#22120;&#31649;&#29702;&#21306;&#38142;&#34920;&#65292;&#21542;&#21017;&#25346;&#36215;&#31995;&#32479;&#65292;&#26174;&#28982;&#20869;&#23384;&#31649;&#29702;&#21151;&#33021;&#21021;&#22987;&#21270;&#20986;&#29616;&#24322;&#24120;&#20026;&#33268;&#21629;&#38169;&#35823;&#12290;</li><li class="listitem">nr_free_pagecache_pages&#30452;&#25509;&#35843;&#29992;nr_free_zone_pages&#26469;&#32479;&#35745;&#31995;&#32479;&#20013;&#25152;&#26377;&#20869;&#23384;&#33410;&#28857;&#20013;&#21487;&#29992;&#30340;&#20869;&#23384;&#39029;&#26694;&#25968;&#65292;&#36890;&#24120;&#23601;&#26159;&#23545;present_pages&#25104;&#21592;&#30340;&#21472;&#21152;&#12290;</li><li class="listitem">&#26681;&#25454;&#24403;&#21069;&#31995;&#32479;&#20013;&#30340;&#20869;&#23384;&#39029;&#26694;&#25968;&#30446;&#65292;&#20915;&#23450;&#26159;&#21542;&#21551;&#29992;&#27969;&#21160;&#20998;&#32452;(Mobility Grouping)&#26426;&#21046;&#65292;&#36825;&#31181;&#26426;&#21046;&#21487;&#20197;&#22312;&#20998;&#37197;&#22823;&#20869;&#23384;&#22359;&#26102;&#20943;&#23569;&#20869;&#23384;&#30862;&#29255;&#12290;&#26174;&#28982;&#21482;&#26377;&#20869;&#23384;&#36275;&#22815;&#22823;&#26102;&#25165;&#20250;&#21551;&#29992;&#35813;&#21151;&#33021;&#65292;&#21542;&#21017;&#23558;&#24471;&#19981;&#20607;&#22833;&#12290;pageblock_nr_pages&#23454;&#38469;&#19978;&#26159;&#19968;&#20010;&#23439;&#65292;&#23427;&#34920;&#31034;&#20249;&#20276;&#31995;&#32479;&#20013;&#30340;&#26368;&#39640;&#38454;&#39029;&#22359;&#25152;&#33021;&#21253;&#21547;&#30340;&#39029;&#38754;&#25968;&#12290;</li></ul></div><p>
pageblock_order&#22312;free_area_init_core&#20013;&#34987;&#21021;&#22987;&#21270;&#20026;&#20249;&#20276;&#31995;&#32479;&#20013;&#30340;&#26368;&#39640;&#38454;&#65292;pageblock_nr_pages * MIGRATE_TYPES&#30340;&#29992;&#20110;&#22312;&#20110;&#21487;&#20197;&#30830;&#20445;&#24403;&#21069;&#20869;&#23384;&#21487;&#20197;&#28385;&#36275;&#26368;&#39640;&#38454;&#38142;&#34920;&#20013;&#33267;&#23569;&#26377;&#19968;&#20010;&#21487;&#20998;&#37197;&#33410;&#28857;&#30340;&#23384;&#22312;&#12290;
</p><pre class="programlisting">
include/linux/pageblock-flags.h
#define pageblock_nr_pages      (1UL &lt;&lt; pageblock_order)
</pre><p>
&#19968;&#20010;&#25317;&#26377;256MB&#30340;&#20869;&#23384;&#24320;&#21457;&#26495;&#19978;&#30340;&#31649;&#29702;&#21306;&#21442;&#32771;&#38142;&#34920;&#20449;&#24687;&#22914;&#19979;&#65306;
</p><pre class="programlisting">
Built 1 zonelists in Zone order, mobility grouping on.  Total pages: 65024
</pre><p>
build_all_zonelists&#35843;&#29992;&#20102;&#19968;&#20123;&#21015;&#20989;&#25968;&#65292;&#35843;&#29992;&#27969;&#31243;&#22914;&#19979;&#25152;&#31034;&#65306;
</p><div class="figure"><a name="idp81131724"></a><p class="title"><b>&#22270; 74. &#20869;&#23384;&#31649;&#29702;&#21306;&#21021;&#22987;&#21270;&#27969;&#31243;&#22270;</b></p><div class="figure-contents"><div><img src="images/mem_flow.gif" alt="&#20869;&#23384;&#31649;&#29702;&#21306;&#21021;&#22987;&#21270;&#27969;&#31243;&#22270;"></div></div></div><p><br class="figure-break">
</p>
</div>
<div class="sect2" title="13.8. __build_all_zonelists"><div class="titlepage"><div><div><h3 class="title"><a name="idp81132476"></a>13.8. __build_all_zonelists</h3></div></div></div>
<pre class="programlisting">
/* return values int ....just for stop_machine() */
static int __build_all_zonelists(void *dummy)
{
	int nid;

	for_each_online_node(nid) {
		pg_data_t *pgdat = NODE_DATA(nid);

		build_zonelists(pgdat);
		build_zonelist_cache(pgdat);
	}
	return 0;
}
</pre>
__build_all_zonelists&#30340;dummy&#21442;&#25968;&#27809;&#26377;&#20219;&#20309;&#24847;&#20041;&#65292;&#24182;&#19988;&#36820;&#22238;&#20540;&#27704;&#36828;&#20026;0&#65292;&#36825;&#26159;&#20026;&#20102;&#26041;&#20415;stop_machine&#23545;&#20854;&#32467;&#26524;&#20316;&#20026;&#21442;&#25968;&#24341;&#29992;&#12290;build_zonelist_cache&#19982;CONFIG_NUMA&#30456;&#20851;&#65292;&#23427;&#29992;&#26469;&#35774;&#32622;zlcache&#30456;&#20851;&#30340;&#25104;&#21592;&#12290;
<pre class="programlisting">
static void build_zonelist_cache(pg_data_t *pgdat)
{
	pgdat-&gt;node_zonelists[0].zlcache_ptr = NULL;
}
</pre>
</div>
<div class="sect2" title="13.9. build_zonelists"><div class="titlepage"><div><div><h3 class="title"><a name="idp81134156"></a>13.9. build_zonelists</h3></div></div></div>
<pre class="programlisting">
static void build_zonelists(pg_data_t *pgdat)
{
	int node, local_node;
	enum zone_type j;
	struct zonelist *zonelist;

	local_node = pgdat-&gt;node_id;

	zonelist = &amp;pgdat-&gt;node_zonelists[0];	
	j = build_zonelists_node(pgdat, zonelist, 0, MAX_NR_ZONES - 1);

	for (node = local_node + 1; node &lt; MAX_NUMNODES; node++) {
		if (!node_online(node))
			continue;
		j = build_zonelists_node(NODE_DATA(node), zonelist, j,
							MAX_NR_ZONES - 1);
	}
	for (node = 0; node &lt; local_node; node++) {
		if (!node_online(node))
			continue;
		j = build_zonelists_node(NODE_DATA(node), zonelist, j,
							MAX_NR_ZONES - 1);
	}

	zonelist-&gt;_zonerefs[j].zone = NULL;
	zonelist-&gt;_zonerefs[j].zone_idx = 0;
}
</pre>
&#27880;&#24847;&#21040;&#26368;&#21518;&#19968;&#20010;_zonerefs&#20803;&#32032;&#30340;zone&#34987;&#35774;&#32622;&#20026;NULL&#65292;zone_idx&#20026;0&#65292;&#36825;&#26159;&#29992;&#26469;&#36941;&#21382;&#26102;&#21028;&#26029;&#32467;&#23614;&#12290;
</div>
<div class="sect2" title="13.10. build_zonelists_node"><div class="titlepage"><div><div><h3 class="title"><a name="idp81135604"></a>13.10. build_zonelists_node</h3></div></div></div>
<pre class="programlisting">
static int build_zonelists_node(pg_data_t *pgdat, struct zonelist *zonelist,
				int nr_zones, enum zone_type zone_type)
{
	struct zone *zone;

	BUG_ON(zone_type &gt;= MAX_NR_ZONES);
	zone_type++;

	do {
		zone_type--;
		zone = pgdat-&gt;node_zones + zone_type;
		if (populated_zone(zone)) {
			zoneref_set_zone(zone,
				&amp;zonelist-&gt;_zonerefs[nr_zones++]);
			check_highest_zone(zone_type);
		}

	} while (zone_type);
	return nr_zones;
}
</pre>
build_zonelists_node&#38024;&#23545;&#21333;&#20010;&#23384;&#20648;&#33410;&#28857;&#21021;&#22987;&#21270;&#20998;&#37197;&#22120;&#30340;&#31649;&#29702;&#21306;&#21015;&#34920;&#12290;zone_type&#29992;&#26469;&#25351;&#26126;&#24403;&#21069;&#22788;&#29702;&#30340;&#31649;&#29702;&#21306;&#30340;&#20010;&#25968;&#65292;&#36890;&#24120;&#23427;&#23601;&#26159;MAX_NR_ZONES - 1&#12290;nr_zones&#21017;&#25351;&#26126;&#20102;&#23558;&#34987;&#22635;&#20805;&#30340;_zonerefs&#31649;&#29702;&#21306;&#22791;&#29992;&#38142;&#34920;&#30340;&#32034;&#24341;&#65292;&#36890;&#24120;&#35813;&#32034;&#24341;&#20043;&#21069;&#30340;&#25104;&#21592;&#24050;&#32463;&#25353;&#20869;&#23384;&#20248;&#20808;&#32423;&#36827;&#34892;&#20102;&#36171;&#20540;&#12290;&#24490;&#29615;&#20013;zone_type&#19968;&#30452;&#36882;&#20943;&#65292;&#32780;nr_zones&#32034;&#24341;&#19968;&#30452;&#36882;&#20943;&#65292;&#25152;&#20197;&#22312;UMA&#31995;&#32479;&#20013;&#65292;&#32534;&#21495;&#36234;&#22823;&#30340;&#31649;&#29702;&#21306;&#31867;&#22411;&#20248;&#20808;&#32423;&#36234;&#39640;&#65292;&#23558;&#34987;&#26368;&#20808;&#25346;&#36733;&#21040;&#22791;&#29992;&#38142;&#34920;&#12290;&#36890;&#24120;ZONE_HIGHMEM&#30340;&#20248;&#20808;&#32423;&#26368;&#39640;&#65292;&#32780;ZONE_DMA&#30340;&#20248;&#20808;&#32423;&#26368;&#20302;&#12290;&#25152;&#20197;&#20998;&#37197;&#22120;&#22312;&#20998;&#37197;&#20869;&#23384;&#30340;&#26102;&#20505;&#36890;&#24120;&#22312;ZONE_HIGHMEM&#20013;&#20998;&#37197;&#12290;populated_zone&#20989;&#25968;&#29992;&#26469;&#30830;&#20445;&#35813;&#21306;&#30340;&#21487;&#29992;&#20869;&#23384;&#39029;(present_pages)&#26377;&#25928;&#65292;&#20063;&#21363;&#22823;&#20110;0&#12290;&#22312;&#20869;&#23384;&#23569;&#20110;896MB&#30340;&#31995;&#32479;&#19978;&#65292;ZONE_HIGHMEM&#30340;&#26377;&#25928;&#20869;&#23384;&#39029;&#23601;&#20026;0&#65292;&#27492;&#26102;&#21482;&#26377;&#21040;ZONE_NORMAL&#25110;&#32773;ZONE_DMA&#21306;&#20998;&#37197;&#20869;&#23384;&#12290;
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">pgdat&#65306;&#24403;&#21069;&#23384;&#20648;&#33410;&#28857;&#23545;&#24212;&#30340;pg_data_t&#31867;&#22411;&#25551;&#36848;&#31526;&#12290;</li><li class="listitem">zonelist&#65306;&#24403;&#21069;&#23384;&#20648;&#33410;&#28857;&#23545;&#24212;&#30340;&#31649;&#29702;&#21306;&#21015;&#34920;&#65292;&#36890;&#24120;&#23427;&#36890;&#36807;&#23601;&#26159;pgdat-&gt;node_zonelists + 0&#12290;</li><li class="listitem">nr_zones&#65306;&#24403;&#21069;&#24320;&#22987;&#22788;&#29702;&#30340;&#31649;&#29702;&#21306;&#22312;&#23384;&#20648;&#33410;&#28857;&#20013;&#30340;&#32534;&#21495;&#65292;&#27599;&#22788;&#29702;&#19968;&#20010;&#31649;&#29702;&#21306;&#37027;&#20040;&#35813;&#20540;&#21152;1&#12290;</li><li class="listitem">zone_type&#65306;&#25351;&#23450;&#22788;&#29702;&#20960;&#20010;&#31649;&#29702;&#21306;&#12290;&#36890;&#24120;&#20026;MAX_NR_ZONES - 1&#12290;</li><li class="listitem">&#36820;&#22238;&#19979;&#19968;&#20010;&#26410;&#22788;&#29702;&#30340;&#31649;&#29702;&#21306;&#30340;&#32034;&#24341;&#20540;&#12290;</li></ul></div>
build_zonelists_node&#23436;&#25104;&#20102;&#20197;&#19979;&#21151;&#33021;&#65292;&#24403;&#26410;&#24320;&#21551;CONFIG_NUMA&#26102;&#65292;&#20381;&#27425;&#26144;&#23556;&#31649;&#29702;&#21306;&#21040;&#21442;&#32771;&#38142;&#34920;&#20013;&#12290;
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">&#21028;&#23450;&#25552;&#20379;&#30340;zone_type&#21442;&#25968;&#26159;&#21542;&#27491;&#30830;&#65292;&#23427;&#19981;&#24212;&#35813;&#36229;&#36807;&#19968;&#20010;&#31649;&#29702;&#33410;&#28857;&#25152;&#33021;&#21253;&#21547;&#30340;&#26368;&#22823;&#31649;&#29702;&#21306;&#30340;&#20010;&#25968;&#12290;</li><li class="listitem">populated_zone&#26159;&#19968;&#20010;&#31616;&#21333;&#30340;&#23439;&#65306;!!zone-&gt;present_pages&#65292;&#30001;&#20110;present_pages&#21442;&#25968;&#22312;free_area_init_core
&#34987;&#21021;&#22987;&#21270;&#20026;&#35813;&#33410;&#28857;&#20013;&#21487;&#29992;&#30340;&#20869;&#23384;&#39029;&#25968;realsize&#65292;&#25152;&#20197;&#36825;&#37324;&#30340;&#24847;&#22270;&#23601;&#26159;&#20445;&#35777;&#24403;&#22825;&#33410;&#28857;&#26159;&#21542;&#24050;&#32463;&#34987;&#21021;&#22987;&#21270;&#12290;</li><li class="listitem">zoneref_set_zone&#35774;&#32622;&#31649;&#29702;&#33410;&#28857;&#20013;&#30340;&#25104;&#21592;zoneref&#65292;&#23427;&#35760;&#24405;&#24403;&#21069;&#31649;&#29702;&#21306;&#30340;&#22320;&#22336;&#21644;&#22312;&#31649;&#29702;&#21306;&#25968;&#32452;node_zones&#20013;&#30340;&#32034;&#24341;&#12290;&#26174;&#28982;&#22312;&#24490;&#29615;&#20013;&#65292;&#25152;&#26377;&#30340;&#21021;&#22987;&#21270;&#36807;&#30340;zone&#37117;&#26159;&#20381;&#27425;&#20174;node_zones&#20986;&#26469;&#65292;&#25918;&#20837;_zonerefs&#30340;&#65292;&#36825;&#20010;&#39034;&#24207;&#26159;&#20498;&#24207;&#30340;&#12290;build_zonelists_node&#20989;&#25968;&#36319;&#26159;&#21542;&#37197;&#32622;CONFIG_NUMA&#30456;&#20851;&#65292;&#21551;&#29992;&#35813;&#21151;&#33021;&#23558;&#20351;&#29992;&#21478;&#19968;&#20010;&#21516;&#21517;&#20989;&#25968;&#65292;&#27492;&#20989;&#25968;&#23558;&#26681;&#25454;Node&#30340;&#21508;&#20010;&#35201;&#32032;&#26435;&#34913;&#23427;&#20204;&#22312;&#38142;&#34920;&#20013;&#30340;&#39034;&#24207;&#12290;</li><li class="listitem">check_highest_zone&#20989;&#25968;&#21482;&#22312;CONFIG_NUMA&#20013;&#26377;&#25928;&#12290;</li></ul></div>
<pre class="programlisting">
static void zoneref_set_zone(struct zone *zone, struct zoneref *zoneref)
{
	zoneref-&gt;zone = zone;
	zoneref-&gt;zone_idx = zone_idx(zone);
}
</pre>
&#27880;&#24847;&#65306;zoneref&#21516;&#26102;&#23450;&#20041;zone&#30340;&#22320;&#22336;&#21644;&#32034;&#24341;&#65292;&#30475;&#36215;&#26469;&#22810;&#27492;&#19968;&#20030;&#65292;&#36825;&#26159;&#22240;&#20026;&#22312;NUMA&#20013;&#65292;&#21487;&#33021;&#23558;&#21478;&#19968;&#20010;Node&#20013;&#30340;zone&#21152;&#20837;&#26412;Node&#20013;&#30340;&#21442;&#32771;&#38142;&#34920;&#20013;&#12290;
</div>
<div class="footnotes"><br><hr width="100" align="left"><div class="footnote">
	<p><sup>[<a name="ftn.idp81120556" href="#idp81120556" class="para">9</a>] </sup>&#23613;&#31649;&#20869;&#26680;&#27880;&#37322;&#20013;&#25552;&#21040;&#36825;&#26159;&#22240;&#20026;&#20869;&#23384;&#23380;&#27934;&#30340;&#23384;&#22312;&#65292;&#20294;&#26159;&#31508;&#32773;&#35748;&#20026;&#24182;&#38750;&#22914;&#27492;&#65292;early_pfn_valid&#23439;&#21482;&#26159;&#26816;&#26597;&#35813;&#39029;&#26694;&#32534;&#21495;&#23427;&#26159;&#21542;&#33021;&#22815;&#23545;&#24212;&#21040;&#31649;&#29702;&#21306;&#20013;&#30340;&#39029;&#26694;&#20013;&#65292;&#24182;&#19988;&#36825;&#20010;&#39029;&#26694;&#33539;&#22260;&#21253;&#21547;&#20102;&#23380;&#27934;&#65292;&#36825;&#20123;&#20195;&#30721;&#22312;ARM&#19978;&#33267;&#23569;&#30475;&#26469;&#22914;&#27492;&#12290;</p>&#21478;&#22806;early_pfn_in_nid&#23558;&#21516;&#26102;&#26816;&#26597;&#23427;&#25152;&#23646;&#30340;&#31649;&#29702;&#21306;&#26159;&#21542;&#22312;&#24403;&#21069;&#33410;&#28857;&#20869;&#12290;
	</div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ar01s12.html">&#19978;&#19968;&#39029;</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="ar01s14.html">&#19979;&#19968;&#39029;</a></td></tr><tr><td width="40%" align="left" valign="top">12. &#39029;&#34920;&#26426;&#21046; </td><td width="20%" align="center"><a accesskey="h" href="index.html">&#36215;&#22987;&#39029;</a></td><td width="40%" align="right" valign="top"> 14. &#20249;&#20276;&#31995;&#32479;</td></tr></table></div></body></html>
